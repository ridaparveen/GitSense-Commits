# Activity Summary for 12/16/2025

## 9:34:20 AM
The code changes primarily focus on refining and extending the analytics and reporting capabilities within the T360_Api backend. The updates are spread across three main files responsible for building queries for analytics views, generating queries for data exports, and providing general utility functions for analytics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps:** Multiple entries from 12/15/2025, 10:20:53 AM to 12/15/2025, 3:46:50 PM.
    *   **Updates:** No functional code changes were introduced or maintained across these timestamps. All logged versions of the file content are identical, suggesting either no actual changes were made, or changes were purely superficial (e.g., whitespace) or reverted between saves. This file defines the `bookingQueryBuilder` function, which constructs complex SQL queries for various booking-related analytics, including calculations of date differences, MBL-wise reports, and stacked bar chart data categorization.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps:** Significant changes occurred between 12/15/2025, 12:01:30 PM and 12/15/2025, 3:50:13 PM.
    *   **Updates:**
        *   **12/15/2025, 12:19:23 PM:** The `Average Transit time By lane` query was substantially refined to include more robust checks for `m.rail_ata IS NOT NULL` and to use `COALESCE` for various rail-related date columns, making the conditions more comprehensive for inland rail moves.
        *   **12/15/2025, 2:14:07 PM:** Further restructuring of the `Average Transit time By lane` query's `WHERE` clause. It now explicitly categorizes conditions for SEA, RAIL, and TRUCK legs using `OR` logic to ensure data presence for at least one segment, and added comments for clarity.
        *   **12/15/2025, 2:23:42 PM:** The `Average Transit time By lane` query was slightly adjusted by wrapping the multi-part `OR` condition for different transportation legs in parentheses and explicitly adding `m.inland_rail_move = 'Yes'` to the rail segment's criteria.
        *   **12/15/2025, 3:16:55 PM:** The `Custom Booking` query was modified to use `LOWER(account_name) = '${CompanyName}'` instead of `LOWER(a.customer) = '${CompanyName.toLowerCase()}'` and added checks for `m.mblno` not being null or empty. Additionally, a new report type, "Booking Date to Actual Departure (MBL Wise)", was added to the `bookingQuery` object.
        *   **12/15/2025, 3:40:23 PM:** The `Custom Booking` query was reverted to use `a.bookingdate IS NOT NULL` instead of `a.created_at IS NOT NULL`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamps:** Key changes between 12/15/2025, 12:10:06 PM and 12/15/2025, 1:57:33 PM, with subsequent identical entries until 12/15/2025, 2:51:02 PM.
    *   **Updates:**
        *   **12/15/2025, 12:12:54 PM:** The `dateFilterOnExport` function's `dateKeys` array was expanded to include additional date fields related to rail and vessel actual arrival/departure, and `inland_rail_move`, `rail_destination`, `rail_departed_pod`, and `booking_status`.
        *   **12/15/2025, 12:24:57 PM:** The `getExcelSelectedColumns` function had `m.rail_ata` added to the `otherColumns` string for more comprehensive data selection.
        *   **12/15/2025, 1:57:33 PM:** The `booking_status` key was removed from the `dateKeys` array in the `dateFilterOnExport` function.
        *   Subsequent entries for this file show no further functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps:** Minor adjustments between 12/15/2025, 2:02:29 PM and 12/15/2025, 2:09:40 PM.
    *   **Updates:**
        *   **12/15/2025, 2:08:57 PM:** A `console.log` statement was added to output `excelExportData` for debugging purposes within the booking export logic.
        *   **12/15/2025, 2:09:40 PM:** The `console.log` statement was refined to specifically output `excelExportData.rows`.

**Patterns and Recurring Elements:**

*   **Analytics and Reporting Focus:** The changes consistently enhance and modify SQL query generation for various analytics reports, particularly those concerning booking and transit times.
*   **Detailed Date Handling:** There's a strong emphasis on precise date calculations (`EXTRACT(DAY FROM ...)`, `DATE_TRUNC`) and validation (`isValidDate`) across the codebase, crucial for time-sensitive logistics data. Date-related columns are frequently added or modified in selection and filtering.
*   **Dynamic Query Construction:** Functions like `bookingQueryBuilder` and `bookingQuery` dynamically build SQL queries based on report types, user preferences (`displayBy`), and date ranges.
*   **Data Standardization:** The `replaceColumnHandler` function in `core.export.controller.ts` consistently maps "LONG BEACH" to "LOS ANGELES" for port-of-discharge (pod) and place-of-delivery fields, indicating a data cleansing or standardization requirement.
*   **Company-Specific Filtering:** SQL queries frequently incorporate `LOWER(account_name) = '${CompanyName}'` or similar conditions to filter data relevant to a specific company, supporting a multi-tenant application architecture.
*   **Debugging via Console Logs:** The addition of `console.log` statements in `core.export.controller.ts` indicates active debugging or monitoring of query results during development.
*   **Redundant Log Entries:** Multiple identical log entries for `booking.query.ts` and `analytics.ts` (especially towards the end of the log) suggest either frequent saving without functional changes or a version control/logging system that captures minor, non-semantic modifications.

## 1:56:31 PM
The provided logs detail changes across three core files within an analytics and customer management backend system.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps:** Multiple entries on 12/15/2025 (10:20 AM - 11:52 AM) and 12/16/2025 (9:45 AM - 3:46 PM).
    *   **Updates:** This file, containing the `bookingQueryBuilder` function, consistently defines how various booking and departure-related analytical queries are constructed. It includes logic for calculating day differences between dates (e.g., 'Booking Date to Actual Departure'), generating aggregated results (e.g., average day difference), and categorizing time differences into predefined ranges (e.g., 'Less than 1 week', '1 - 2 weeks') for stacked bar charts. The code appears highly stable across all logged timestamps for this file, indicating no functional changes in the provided snippets. The `customizer` object is dynamically populated with chart-specific configurations like `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, and `calColumnConfig`.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps:** Significant changes on 12/15/2025 at 12:19:23 PM and on 12/16/2025 at 1:02:21 PM, 1:37:56 PM, and 1:47:57 PM.
    *   **Updates:** This file manages SQL query fragments for various reports designated for export.
        *   **12/15/2025, 12:19:23 PM:** The SQL query for `"Average Transit time By lane"` was significantly enhanced. It now includes more robust `WHERE` clauses to ensure the existence of necessary data for SEA, RAIL, and TRUCK legs, conditionally checking `m.inland_rail_move` and specific date/location columns.
        *   **12/16/2025, 1:02:21 PM:** A new report type, `"Average Transit time By mode"`, was introduced. This new query specifically calculates transit times for OCEAN (sea) and AIR modes by checking for valid departure and arrival dates, joining with `mtr_air_data` for air freight.
        *   **12/16/2025, 1:37:56 PM & 1:47:57 PM:** The `"Average Transit Time By Mode"` query was further refined. For the OCEAN leg, a `m.departure_date IS NOT NULL` condition was added. For the AIR leg, the `EXISTS` subquery was modified to `air.customer_name IS NOT NULL` as a condition for air data presence, alongside the `COALESCE` date checks.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamps:** Significant changes on 12/15/2025 at 12:12:54 PM and 12:24:57 PM, and on 12/16/2025 at 1:25:51 PM.
    *   **Updates:** This utility file provides common functions for analytics processing.
        *   **12/15/2025, 12:12:54 PM:** The `dateFilterOnExport` function's `dateKeys` array was expanded to include several new date-related fields like `rail_ata`, `rail_etd`, `t49_raildeparted_date`, `vessel_actualarrived_date`, `vessel_actualdeparted_date`, `inland_rail_move`, `rail_destination`, and `rail_departed_pod`. This indicates an effort to standardize date handling and filtering for a broader set of tracking data.
        *   **12/15/2025, 12:24:57 PM:** The `getExcelSelectedColumns` function had `m.rail_ata` added to its `otherColumns` string, suggesting this field is now considered for general Excel exports.
        *   **12/16/2025, 1:25:51 PM:** The `bookingColumns` constant within `getExcelSelectedColumns` was commented out, potentially a temporary change or an oversight, as it is still referenced in the `else if (isBooking)` block.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts`**
    *   **Timestamp:** 12/15/2025, 3:48:49 PM.
    *   **Updates:** This file introduces comprehensive customer master data management. It defines `getAllCustomer` for fetching customer details along with associated shipper maps, uploaded documents, and customer mappings. The `createCustomer` function handles creating or updating customer records, including managing database transactions, generating unique codes (`acode`, `asubcode`), and mapping shipper and customer data. It also includes a `replaceColumnHandler` to normalize port names like 'LONG BEACH' to 'LOS ANGELES'.

5.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps:** Multiple entries on 12/15/2025 (2:02 PM - 2:09 PM).
    *   **Updates:** This controller function, `getExportData`, orchestrates the generation and export of analytics reports. It parses numerous query parameters, retrieves company and user information, and conditionally calls `bookingQuery` or `nonBookingQuery` to construct the main SQL query. It applies post-processing steps such as custom deduplication for "TEU MBLwise" reports, date filtering via `dateFilterOnExport`, and port name standardization using `replaceColumnHandler`. Debugging `logger.info` and `console.log` statements are present throughout the logic.

### Patterns and Recurring Elements:

*   **Date-Centric Operations:** A strong pattern across `booking.query.ts` and `analytics.ts` is the heavy reliance on date calculations, comparisons, formatting, and validation. Dates represented as `'0001-01-01 00:00:00 BC'` are consistently treated as invalid placeholders in SQL queries.
*   **Dynamic SQL Generation:** SQL queries are dynamically built using template literals and conditional logic (`if-else if` blocks, ternary operators). This allows for flexible report generation based on request parameters like `type`, `displayBy`, `stackedExport`, etc.
*   **Company-Specific Filtering:** Almost all database queries include a `WHERE LOWER(account_name) = '${CompanyName}'` clause, indicating a robust multi-tenant architecture where data is filtered by the requesting company.
*   **Data Normalization/Transformation:** The `replaceColumnHandler` in `core.export.controller.ts` and `replaceValueInQuery` in `analytics.ts` demonstrate a consistent need to standardize or merge certain data values (e.g., 'LONG BEACH' to 'LOS ANGELES').
*   **Modularity and Utility Functions:** The codebase is structured with clear separation of concerns, utilizing utility functions (`getColumnsByCategory`, `getFilterQueryByDisplayValue`, `getUserObject`, `dateFilterOnExport`) to encapsulate common logic and keep controllers and query builders focused.
*   **Frequent Minor Commits/Saves:** Multiple timestamps for `booking.query.ts` and `analytics.ts` show very close time intervals with identical code, suggesting frequent saves or very minor, non-functional changes like whitespace adjustments that don't alter the core logic in the provided snippets.

## 1:56:42 PM
The log entries detail changes across three distinct areas of a frontend application: analytics configuration, analytics utility functions, and customer management components.

**File-Specific Updates and Timestamps:**

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
- **12/15/2025, 12:03:26 PM:** This initial version established core analytics configurations. It defined `DEFAULT_ANALYTICS_ENDPOINTS` for various CBM and TEU reports (grouped by carrier, port, supplier, country of origin), `EXCEL_EXPORT_COLUMNS` for a comprehensive list of data points (e.g., file number, account, shipper, various dates related to vessel movement and container status), `CargoReadyToETD10Days` for a specific report's columns, and `ANALYTICS_REPORT_HEADER` which maps report names to their display headers, covering container-wise and MBL-wise CBM, TEU, KGS, Transit Time, and Chassis metrics.
- **12/15/2025, 1:59:05 PM:** The `EXCEL_EXPORT_COLUMNS` array was updated to include a new column: `"Rail ATA"`.
- **12/16/2025, 1:53:04 PM:** The `EXCEL_EXPORT_COLUMNS` array was modified again, specifically by commenting out (or removing) the `"Delivery Customer Date"` column. Other timestamps for this file (12/15, 3:31 PM; 12/15, 3:32 PM; 12/15, 3:34 PM; 12/16, 12:57 PM) show no significant functional changes from the previous entry.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
- **12/15/2025, 3:29:59 PM:** This entry introduced a suite of utility functions for analytics. Key functions include `TruncateText`, `metricsPackageHandler` (which processes raw analytics data, determines chart types, calculates aggregates like total/average, and prepares data for display), `reportFormula` (for generating date difference calculations), `weekDateFormater`, and a substantial `downloadReportSpreadsheet` function. The `downloadReportSpreadsheet` handles generating Excel files, with complex logic to structure data based on report name, chart type (especially "StackedBar" reports like "Cargo-Ready Date to ETD", "Containers Shipped", "Total Spend", "Average Transit Time", "Custom Booking"), and period filters (month, week, quarter). It leverages `moment` for date formatting and `ExcelJS` for spreadsheet creation.
- **12/15/2025, 3:31:15 PM:** A minor change occurred within `downloadReportSpreadsheet`: for the "Custom Booking" report when `chartType` is "StackedBar", the data key for the count was changed from `"Booking Count"` to `"confirmed_count"`.
- **12/15/2025, 3:32:47 PM:** The previous change for "Custom Booking" was reverted, changing the data key back to `"Booking Count"`. Additionally, new specific logic was added to `downloadReportSpreadsheet` to handle a new "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)" report, defining how its data (e.g., "Less than 10 days", "10") should be mapped for Excel export based on period filters.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
- **12/15/2025, 3:52:43 PM:** This new React component was added. It provides a user interface for dynamically adding and deleting customer mapping rows. Each row allows selecting a customer using an `AppAutocomplete` component, with options fetched asynchronously via `ApiManager`. It integrates with `formik` for form state management and uses Material-UI components for its layout and interactive elements.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\code\CustomerFormScreen.jsx`**
- **12/15/2025, 3:53:29 PM:** This new React screen component was introduced. Its primary role is to host the `CustomerForm`, manage initial form values (retrieved from route state and an API query using Redux Toolkit Query's `useFetchCustomerQuery`), and initialize customer-related mapping arrays. It also sets up the screen's toolbar and breadcrumbs.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\DragableGridItem.jsx`**
- **12/16/2025, 9:38:04 AM:** This new React component was added to implement drag-and-drop functionality for grid items within the analytics section. It uses the `react-dnd` library's `useDrag` and `useDrop` hooks to enable reordering by hovering and provides visual cues during the drag operation.

**Patterns and Recurring Elements:**

1.  **Analytics Focus:** A dominant theme is the extensive development and refinement of analytics and reporting features. This includes defining report structures, processing data for different chart types, and generating detailed Excel exports.
2.  **Configuration-Driven Design:** The `analytics.js` file heavily uses arrays of objects and key-value maps to configure various aspects of the analytics system, such as API endpoints, Excel column definitions, and report headers. This allows for flexible and easily maintainable report structures.
3.  **Data Transformation and Visualization:** The `analytics\methods.js` file demonstrates complex logic for transforming raw data into formats suitable for charts and spreadsheets, including handling different chart types (bar, pie, line, stack, gauge) and calculating aggregates.
4.  **UI Component Modularity:** The code adheres to a modular component architecture, with distinct React components (`CustomerMapping`, `CustomerFormScreen`, `DragableGridItem`) handling specific UI or feature responsibilities.
5.  **External Library Usage:** Consistent use of popular frontend libraries:
    *   `moment` for date handling and formatting.
    *   `ExcelJS` and `file-saver` for robust Excel report generation.
    *   `formik` for streamlined form management.
    *   `react-dnd` for interactive drag-and-drop functionality.
    *   Material-UI (`@mui/icons-material`, `Grid`, `IconButton`, etc.) for consistent UI styling and components.
    *   Redux Toolkit Query for efficient data fetching and caching.
6.  **Descriptive Naming Conventions:** Report names and keys often include distinctions like "Container Wise" vs. "MBL Wise" and specify the metric (CBM, TEU, KGS), indicating a structured approach to data categorization.
7.  **Future Timestamps:** All changes are timestamped in December 2025, which might indicate placeholder dates or a development plan set for a future release.