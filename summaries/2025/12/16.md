# Activity Summary for 12/16/2025

## 9:34:20 AM
The code changes primarily focus on refining and extending the analytics and reporting capabilities within the T360_Api backend. The updates are spread across three main files responsible for building queries for analytics views, generating queries for data exports, and providing general utility functions for analytics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps:** Multiple entries from 12/15/2025, 10:20:53 AM to 12/15/2025, 3:46:50 PM.
    *   **Updates:** No functional code changes were introduced or maintained across these timestamps. All logged versions of the file content are identical, suggesting either no actual changes were made, or changes were purely superficial (e.g., whitespace) or reverted between saves. This file defines the `bookingQueryBuilder` function, which constructs complex SQL queries for various booking-related analytics, including calculations of date differences, MBL-wise reports, and stacked bar chart data categorization.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps:** Significant changes occurred between 12/15/2025, 12:01:30 PM and 12/15/2025, 3:50:13 PM.
    *   **Updates:**
        *   **12/15/2025, 12:19:23 PM:** The `Average Transit time By lane` query was substantially refined to include more robust checks for `m.rail_ata IS NOT NULL` and to use `COALESCE` for various rail-related date columns, making the conditions more comprehensive for inland rail moves.
        *   **12/15/2025, 2:14:07 PM:** Further restructuring of the `Average Transit time By lane` query's `WHERE` clause. It now explicitly categorizes conditions for SEA, RAIL, and TRUCK legs using `OR` logic to ensure data presence for at least one segment, and added comments for clarity.
        *   **12/15/2025, 2:23:42 PM:** The `Average Transit time By lane` query was slightly adjusted by wrapping the multi-part `OR` condition for different transportation legs in parentheses and explicitly adding `m.inland_rail_move = 'Yes'` to the rail segment's criteria.
        *   **12/15/2025, 3:16:55 PM:** The `Custom Booking` query was modified to use `LOWER(account_name) = '${CompanyName}'` instead of `LOWER(a.customer) = '${CompanyName.toLowerCase()}'` and added checks for `m.mblno` not being null or empty. Additionally, a new report type, "Booking Date to Actual Departure (MBL Wise)", was added to the `bookingQuery` object.
        *   **12/15/2025, 3:40:23 PM:** The `Custom Booking` query was reverted to use `a.bookingdate IS NOT NULL` instead of `a.created_at IS NOT NULL`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamps:** Key changes between 12/15/2025, 12:10:06 PM and 12/15/2025, 1:57:33 PM, with subsequent identical entries until 12/15/2025, 2:51:02 PM.
    *   **Updates:**
        *   **12/15/2025, 12:12:54 PM:** The `dateFilterOnExport` function's `dateKeys` array was expanded to include additional date fields related to rail and vessel actual arrival/departure, and `inland_rail_move`, `rail_destination`, `rail_departed_pod`, and `booking_status`.
        *   **12/15/2025, 12:24:57 PM:** The `getExcelSelectedColumns` function had `m.rail_ata` added to the `otherColumns` string for more comprehensive data selection.
        *   **12/15/2025, 1:57:33 PM:** The `booking_status` key was removed from the `dateKeys` array in the `dateFilterOnExport` function.
        *   Subsequent entries for this file show no further functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps:** Minor adjustments between 12/15/2025, 2:02:29 PM and 12/15/2025, 2:09:40 PM.
    *   **Updates:**
        *   **12/15/2025, 2:08:57 PM:** A `console.log` statement was added to output `excelExportData` for debugging purposes within the booking export logic.
        *   **12/15/2025, 2:09:40 PM:** The `console.log` statement was refined to specifically output `excelExportData.rows`.

**Patterns and Recurring Elements:**

*   **Analytics and Reporting Focus:** The changes consistently enhance and modify SQL query generation for various analytics reports, particularly those concerning booking and transit times.
*   **Detailed Date Handling:** There's a strong emphasis on precise date calculations (`EXTRACT(DAY FROM ...)`, `DATE_TRUNC`) and validation (`isValidDate`) across the codebase, crucial for time-sensitive logistics data. Date-related columns are frequently added or modified in selection and filtering.
*   **Dynamic Query Construction:** Functions like `bookingQueryBuilder` and `bookingQuery` dynamically build SQL queries based on report types, user preferences (`displayBy`), and date ranges.
*   **Data Standardization:** The `replaceColumnHandler` function in `core.export.controller.ts` consistently maps "LONG BEACH" to "LOS ANGELES" for port-of-discharge (pod) and place-of-delivery fields, indicating a data cleansing or standardization requirement.
*   **Company-Specific Filtering:** SQL queries frequently incorporate `LOWER(account_name) = '${CompanyName}'` or similar conditions to filter data relevant to a specific company, supporting a multi-tenant application architecture.
*   **Debugging via Console Logs:** The addition of `console.log` statements in `core.export.controller.ts` indicates active debugging or monitoring of query results during development.
*   **Redundant Log Entries:** Multiple identical log entries for `booking.query.ts` and `analytics.ts` (especially towards the end of the log) suggest either frequent saving without functional changes or a version control/logging system that captures minor, non-semantic modifications.

## 1:56:31 PM
The provided logs detail changes across three core files within an analytics and customer management backend system.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps:** Multiple entries on 12/15/2025 (10:20 AM - 11:52 AM) and 12/16/2025 (9:45 AM - 3:46 PM).
    *   **Updates:** This file, containing the `bookingQueryBuilder` function, consistently defines how various booking and departure-related analytical queries are constructed. It includes logic for calculating day differences between dates (e.g., 'Booking Date to Actual Departure'), generating aggregated results (e.g., average day difference), and categorizing time differences into predefined ranges (e.g., 'Less than 1 week', '1 - 2 weeks') for stacked bar charts. The code appears highly stable across all logged timestamps for this file, indicating no functional changes in the provided snippets. The `customizer` object is dynamically populated with chart-specific configurations like `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, and `calColumnConfig`.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps:** Significant changes on 12/15/2025 at 12:19:23 PM and on 12/16/2025 at 1:02:21 PM, 1:37:56 PM, and 1:47:57 PM.
    *   **Updates:** This file manages SQL query fragments for various reports designated for export.
        *   **12/15/2025, 12:19:23 PM:** The SQL query for `"Average Transit time By lane"` was significantly enhanced. It now includes more robust `WHERE` clauses to ensure the existence of necessary data for SEA, RAIL, and TRUCK legs, conditionally checking `m.inland_rail_move` and specific date/location columns.
        *   **12/16/2025, 1:02:21 PM:** A new report type, `"Average Transit time By mode"`, was introduced. This new query specifically calculates transit times for OCEAN (sea) and AIR modes by checking for valid departure and arrival dates, joining with `mtr_air_data` for air freight.
        *   **12/16/2025, 1:37:56 PM & 1:47:57 PM:** The `"Average Transit Time By Mode"` query was further refined. For the OCEAN leg, a `m.departure_date IS NOT NULL` condition was added. For the AIR leg, the `EXISTS` subquery was modified to `air.customer_name IS NOT NULL` as a condition for air data presence, alongside the `COALESCE` date checks.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamps:** Significant changes on 12/15/2025 at 12:12:54 PM and 12:24:57 PM, and on 12/16/2025 at 1:25:51 PM.
    *   **Updates:** This utility file provides common functions for analytics processing.
        *   **12/15/2025, 12:12:54 PM:** The `dateFilterOnExport` function's `dateKeys` array was expanded to include several new date-related fields like `rail_ata`, `rail_etd`, `t49_raildeparted_date`, `vessel_actualarrived_date`, `vessel_actualdeparted_date`, `inland_rail_move`, `rail_destination`, and `rail_departed_pod`. This indicates an effort to standardize date handling and filtering for a broader set of tracking data.
        *   **12/15/2025, 12:24:57 PM:** The `getExcelSelectedColumns` function had `m.rail_ata` added to its `otherColumns` string, suggesting this field is now considered for general Excel exports.
        *   **12/16/2025, 1:25:51 PM:** The `bookingColumns` constant within `getExcelSelectedColumns` was commented out, potentially a temporary change or an oversight, as it is still referenced in the `else if (isBooking)` block.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts`**
    *   **Timestamp:** 12/15/2025, 3:48:49 PM.
    *   **Updates:** This file introduces comprehensive customer master data management. It defines `getAllCustomer` for fetching customer details along with associated shipper maps, uploaded documents, and customer mappings. The `createCustomer` function handles creating or updating customer records, including managing database transactions, generating unique codes (`acode`, `asubcode`), and mapping shipper and customer data. It also includes a `replaceColumnHandler` to normalize port names like 'LONG BEACH' to 'LOS ANGELES'.

5.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps:** Multiple entries on 12/15/2025 (2:02 PM - 2:09 PM).
    *   **Updates:** This controller function, `getExportData`, orchestrates the generation and export of analytics reports. It parses numerous query parameters, retrieves company and user information, and conditionally calls `bookingQuery` or `nonBookingQuery` to construct the main SQL query. It applies post-processing steps such as custom deduplication for "TEU MBLwise" reports, date filtering via `dateFilterOnExport`, and port name standardization using `replaceColumnHandler`. Debugging `logger.info` and `console.log` statements are present throughout the logic.

### Patterns and Recurring Elements:

*   **Date-Centric Operations:** A strong pattern across `booking.query.ts` and `analytics.ts` is the heavy reliance on date calculations, comparisons, formatting, and validation. Dates represented as `'0001-01-01 00:00:00 BC'` are consistently treated as invalid placeholders in SQL queries.
*   **Dynamic SQL Generation:** SQL queries are dynamically built using template literals and conditional logic (`if-else if` blocks, ternary operators). This allows for flexible report generation based on request parameters like `type`, `displayBy`, `stackedExport`, etc.
*   **Company-Specific Filtering:** Almost all database queries include a `WHERE LOWER(account_name) = '${CompanyName}'` clause, indicating a robust multi-tenant architecture where data is filtered by the requesting company.
*   **Data Normalization/Transformation:** The `replaceColumnHandler` in `core.export.controller.ts` and `replaceValueInQuery` in `analytics.ts` demonstrate a consistent need to standardize or merge certain data values (e.g., 'LONG BEACH' to 'LOS ANGELES').
*   **Modularity and Utility Functions:** The codebase is structured with clear separation of concerns, utilizing utility functions (`getColumnsByCategory`, `getFilterQueryByDisplayValue`, `getUserObject`, `dateFilterOnExport`) to encapsulate common logic and keep controllers and query builders focused.
*   **Frequent Minor Commits/Saves:** Multiple timestamps for `booking.query.ts` and `analytics.ts` show very close time intervals with identical code, suggesting frequent saves or very minor, non-functional changes like whitespace adjustments that don't alter the core logic in the provided snippets.

## 1:56:42 PM
The log entries detail changes across three distinct areas of a frontend application: analytics configuration, analytics utility functions, and customer management components.

**File-Specific Updates and Timestamps:**

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
- **12/15/2025, 12:03:26 PM:** This initial version established core analytics configurations. It defined `DEFAULT_ANALYTICS_ENDPOINTS` for various CBM and TEU reports (grouped by carrier, port, supplier, country of origin), `EXCEL_EXPORT_COLUMNS` for a comprehensive list of data points (e.g., file number, account, shipper, various dates related to vessel movement and container status), `CargoReadyToETD10Days` for a specific report's columns, and `ANALYTICS_REPORT_HEADER` which maps report names to their display headers, covering container-wise and MBL-wise CBM, TEU, KGS, Transit Time, and Chassis metrics.
- **12/15/2025, 1:59:05 PM:** The `EXCEL_EXPORT_COLUMNS` array was updated to include a new column: `"Rail ATA"`.
- **12/16/2025, 1:53:04 PM:** The `EXCEL_EXPORT_COLUMNS` array was modified again, specifically by commenting out (or removing) the `"Delivery Customer Date"` column. Other timestamps for this file (12/15, 3:31 PM; 12/15, 3:32 PM; 12/15, 3:34 PM; 12/16, 12:57 PM) show no significant functional changes from the previous entry.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
- **12/15/2025, 3:29:59 PM:** This entry introduced a suite of utility functions for analytics. Key functions include `TruncateText`, `metricsPackageHandler` (which processes raw analytics data, determines chart types, calculates aggregates like total/average, and prepares data for display), `reportFormula` (for generating date difference calculations), `weekDateFormater`, and a substantial `downloadReportSpreadsheet` function. The `downloadReportSpreadsheet` handles generating Excel files, with complex logic to structure data based on report name, chart type (especially "StackedBar" reports like "Cargo-Ready Date to ETD", "Containers Shipped", "Total Spend", "Average Transit Time", "Custom Booking"), and period filters (month, week, quarter). It leverages `moment` for date formatting and `ExcelJS` for spreadsheet creation.
- **12/15/2025, 3:31:15 PM:** A minor change occurred within `downloadReportSpreadsheet`: for the "Custom Booking" report when `chartType` is "StackedBar", the data key for the count was changed from `"Booking Count"` to `"confirmed_count"`.
- **12/15/2025, 3:32:47 PM:** The previous change for "Custom Booking" was reverted, changing the data key back to `"Booking Count"`. Additionally, new specific logic was added to `downloadReportSpreadsheet` to handle a new "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)" report, defining how its data (e.g., "Less than 10 days", "10") should be mapped for Excel export based on period filters.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
- **12/15/2025, 3:52:43 PM:** This new React component was added. It provides a user interface for dynamically adding and deleting customer mapping rows. Each row allows selecting a customer using an `AppAutocomplete` component, with options fetched asynchronously via `ApiManager`. It integrates with `formik` for form state management and uses Material-UI components for its layout and interactive elements.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\code\CustomerFormScreen.jsx`**
- **12/15/2025, 3:53:29 PM:** This new React screen component was introduced. Its primary role is to host the `CustomerForm`, manage initial form values (retrieved from route state and an API query using Redux Toolkit Query's `useFetchCustomerQuery`), and initialize customer-related mapping arrays. It also sets up the screen's toolbar and breadcrumbs.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\DragableGridItem.jsx`**
- **12/16/2025, 9:38:04 AM:** This new React component was added to implement drag-and-drop functionality for grid items within the analytics section. It uses the `react-dnd` library's `useDrag` and `useDrop` hooks to enable reordering by hovering and provides visual cues during the drag operation.

**Patterns and Recurring Elements:**

1.  **Analytics Focus:** A dominant theme is the extensive development and refinement of analytics and reporting features. This includes defining report structures, processing data for different chart types, and generating detailed Excel exports.
2.  **Configuration-Driven Design:** The `analytics.js` file heavily uses arrays of objects and key-value maps to configure various aspects of the analytics system, such as API endpoints, Excel column definitions, and report headers. This allows for flexible and easily maintainable report structures.
3.  **Data Transformation and Visualization:** The `analytics\methods.js` file demonstrates complex logic for transforming raw data into formats suitable for charts and spreadsheets, including handling different chart types (bar, pie, line, stack, gauge) and calculating aggregates.
4.  **UI Component Modularity:** The code adheres to a modular component architecture, with distinct React components (`CustomerMapping`, `CustomerFormScreen`, `DragableGridItem`) handling specific UI or feature responsibilities.
5.  **External Library Usage:** Consistent use of popular frontend libraries:
    *   `moment` for date handling and formatting.
    *   `ExcelJS` and `file-saver` for robust Excel report generation.
    *   `formik` for streamlined form management.
    *   `react-dnd` for interactive drag-and-drop functionality.
    *   Material-UI (`@mui/icons-material`, `Grid`, `IconButton`, etc.) for consistent UI styling and components.
    *   Redux Toolkit Query for efficient data fetching and caching.
6.  **Descriptive Naming Conventions:** Report names and keys often include distinctions like "Container Wise" vs. "MBL Wise" and specify the metric (CBM, TEU, KGS), indicating a structured approach to data categorization.
7.  **Future Timestamps:** All changes are timestamped in December 2025, which might indicate placeholder dates or a development plan set for a future release.

## 2:56:22 PM
The provided log details changes across three files in the `t360-backend` analytics module: `booking.query.ts`, `export.query.ts`, and `analytics.ts`.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamp Range:** 12/15/2025, 10:20:53 AM to 12/16/2025, 2:37:20 PM
    *   **Key Changes:**
        *   The file `booking.query.ts` primarily defines the `bookingQueryBuilder` function, which constructs SQL queries based on the `type` of booking analytics requested.
        *   The content remains largely stable across all logged entries for this file. It consistently handles various booking-related report types (`BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`).
        *   Each query type involves joining `mtr_tracking_data` and `agent_booking_entry` tables and calculating day differences between booking and actual departure dates.
        *   The `StackedBar` queries categorize these day differences into 'Less than 1 week', '1 - 2 weeks', '2 - 3 weeks', '3 - 5 weeks', and 'Above 5 weeks' for grouped aggregation.
        *   Minor, isolated changes occurred on `12/16/2025` around 2:11 PM to 2:17 PM, where `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, and `departure_date` were moved from the `must` array to the `ignore` array within the `getColumnsByCategory` function call. This implies a change in which columns are always required versus those that might be omitted for specific reports, potentially for performance or customization reasons. However, `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, and `departure_date` were also present in the `must` array in the same diffs, suggesting a potential redundant inclusion or an incomplete change, as removing them from `must` means they are no longer strictly required, but they are still listed in `must`. This specific change needs further clarification. In the last update (2:37 PM), `departure_date` was moved back from `ignore` to `must`.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamp Range:** 12/15/2025, 12:01:30 PM to 12/16/2025, 2:34:58 PM
    *   **Key Changes:**
        *   This file defines the `bookingQuery` function, which provides SQL query snippets for different report names specifically for export functionality.
        *   A `getMonthValue` helper function is consistently present for parsing month values for stacked charts.
        *   **Significant changes on 12/15/2025 at 12:19:23 PM**: The `Average Transit time By lane` query's `WHERE` clause was significantly refactored to include more robust checks for the existence of SEA, RAIL (conditional on `inland_rail_move`), and TRUCK (conditional on `delivery_customer_date`) legs. This update added `COALESCE` functions for date fields and `IS NOT NULL` checks for various related columns, making the transit time calculation more precise and resilient.
        *   **Significant changes on 12/16/2025 at 1:12:26 PM**: A new report type, "Average Transit Time By Mode", was added. This new query specifically considers both "OCEAN" and "AIR" modes. The "AIR" segment involves a `LEFT JOIN` to `mtr_air_data` and checks for `actual_departure_date`, `live_date_of_dep`, `ata`, and `live_date_of_rcf` in the `mtr_air_data` table.
        *   **Further refinement on 12/16/2025 at 1:43:19 PM**: The "Average Transit Time By Mode" query's `WHERE` clause was updated. The previous OR condition for OCEAN and AIR modes was changed to an AND, and the air data join conditions were moved directly into the `LEFT JOIN` clause for `mtr_air_data`.
        *   **Further refinement on 12/16/2025 at 1:47:57 PM**: The `WHERE` clause for "Average Transit Time By Mode" was further adjusted, specifically modifying the air condition from `COALESCE(...) IS NOT NULL AND COALESCE(...) IS NOT NULL` to simply `air.customer_name IS NOT NULL` after the `LEFT JOIN`. This indicates a simplification or change in logic for identifying air-related records.
        *   **Further refinement on 12/16/2025 at 2:28:04 PM**: The "Average Transit Time By Mode" query's `WHERE` clause changed the logical operator between OCEAN and AIR conditions back from `AND` to `OR`. Also, a specific date range filter (`AND m.departure_date >= '2025-01-01'::timestamp AND m.departure_date < '2025-12-16'::timestamp + INTERVAL '1 day' ORDER BY m.departure_date ASC`) was explicitly added to this query, indicating a requirement for a fixed historical range for this report.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamp Range:** 12/15/2025, 12:10:06 PM to 12/16/2025, 2:49:27 PM
    *   **Key Changes:**
        *   This utility file provides helper functions for analytics queries, such as `defaultDateRange`, `replaceValueInQuery`, `getUserObject`, `getFilterQueryByDisplayValue`, `getExcelSelectedColumns`, and `dateFilterOnExport`.
        *   **12/15/2025, 12:12:54 PM**: The `dateFilterOnExport` function saw an expansion in the `dateKeys` array, adding several new date-related column names (`rail_ata`, `rail_etd`, `t49_raildeparted_date`, `vessel_actualarrived_date`, `vessel_actualdeparted_date`, `inland_rail_move`, `rail_destination`, `rail_departed_pod`, `booking_status`). This indicates an effort to standardize date handling and filtering for a broader set of tracking data points during export.
        *   **12/15/2025, 12:24:57 PM**: `m.rail_ata` was added to `otherColumns` in `getExcelSelectedColumns`, suggesting that `rail_ata` might now be a standard column included in general exports.
        *   **12/15/2025, 1:57:33 PM**: `rail_destination` was removed from the `dateKeys` array in `dateFilterOnExport`.
        *   **12/16/2025, 1:25:51 PM**: The `bookingColumns` variable was commented out in `getExcelSelectedColumns`, implying that these booking-specific columns might no longer be dynamically included in the general `isBooking` logic or that the method of selecting these columns has changed. However, the subsequent `if(isBooking)` block still includes `bookingColumns`, which creates a discrepancy.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamp Range:** 12/15/2025, 2:02:29 PM to 12/15/2025, 2:09:40 PM
    *   **Key Changes:**
        *   This controller handles the logic for exporting analytics data.
        *   The `getExportData` function retrieves query parameters, sets default date ranges, determines company name and user ID, and constructs the main SQL query based on whether it's a booking or non-booking report.
        *   A `replaceColumnHandler` function is present to transform specific column values (e.g., 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery`).
        *   **12/15/2025, 2:08:57 PM**: A `console.log("excelExportData",excelExportData)` statement was added, likely for debugging purposes, to inspect the raw query results before further processing.
        *   **12/15/2025, 2:09:40 PM**: This was updated to `console.log("excelExportData",excelExportData.rows)`, focusing the logging on the actual data rows.

### Patterns and Recurring Elements:

*   **Date Filtering and Formatting:** There's a consistent pattern of handling `fromDate` and `toDate` parameters, defaulting to a one-year range if not provided. Date-related columns are frequently checked for validity and formatted to 'MM/DD/YYYY' for export.
*   **Company-Specific Data:** All queries heavily rely on filtering data by `CompanyName`, often converting it to lowercase for case-insensitive matching. This suggests a multi-tenant or company-specific analytics setup.
*   **Report-Specific Logic:** The application uses `if/else if` constructs based on a `type` or `reportName` string to generate highly specific SQL queries and customization settings for analytics. This indicates a modular approach to defining different reports.
*   **Dynamic Column Selection:** The `getColumnsByCategory` and `getExcelSelectedColumns` functions are used to dynamically select which columns are relevant for a given report, promoting flexibility and reusability.
*   **SQL Query Structure:** Many queries follow a similar PostgreSQL-like structure, utilizing `EXTRACT(DAY FROM ...)` for date differences, `DISTINCT ON` for unique records, `ROUND(AVG(...))` for averages, and `DATE_TRUNC` for grouping by time periods (month, week, quarter).
*   **Stacked Bar Chart Logic:** A common pattern exists for generating stacked bar chart data, where day differences are categorized into fixed time ranges (e.g., "Less than 1 week", "1 - 2 weeks") and then summed.
*   **Debugging Statements:** The presence of `console.log` and `logger.info` statements, particularly in `core.export.controller.ts`, indicates active development and debugging.
*   **Port Name Standardization:** The `replaceColumnHandler` function consistently maps 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery`, suggesting a business rule for standardizing port names.
*   **Data Validation:** The `isValidDate` utility function and its application in `dateFilterOnExport` highlight an emphasis on data quality and handling potentially invalid date entries by setting them to `null`.
*   **Evolution of "Average Transit Time By Mode" Query:** This specific report query in `export.query.ts` shows active development with multiple refinements to its `WHERE` clause, attempting to accurately capture transit times across different transportation modes (Ocean, Rail, Air). This indicates a complex requirement that is being iteratively improved.

## 3:56:40 PM
The provided log details several changes across three key areas within the T360 API backend related to analytics and customer management. The timestamps indicate continuous development and debugging activity from December 15th to December 16th, 2025.

**File-Specific Updates:**

*   **`src\controllers\analytics\query\booking.query.ts`**: This file, responsible for building booking-related analytics queries, saw numerous commits throughout the period. The core functionality remains consistent, defining various `BookingDatetoActualDeparture` and `BookingDatetoActualDepartureStackedBar` query types (both container and MBL-wise). The queries calculate average day differences between booking and actual departure dates, often presented as percentages or categorized into time bins (e.g., "Less than 1 week", "1 - 2 weeks"). A notable pattern in changes around December 16, 2:11 PM to 3:38 PM involved repeated modifications to the `ignore` and `must` column lists within the `getColumnsByCategory` utility call, specifically toggling `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, and `departure_date` between the `ignore` list and the `must` list, suggesting an iterative refinement of column selection logic for reports.

*   **`src\controllers\analytics\query\export.query.ts`**: This file manages SQL query strings for various report exports. Significant updates occurred in this file:
    *   Around December 15, 12:19 PM, the `Average Transit time By lane` query was substantially enhanced with more robust `WHERE` clauses, including checks for `account_name` and conditional logic for `RAIL` and `TRUCK` legs based on the `inland_rail_move` flag. This was further refined on December 15, 2:14 PM, with explicit comments for SEA, RAIL, and TRUCK legs.
    *   On December 15, 2:23 PM, the logic for `Average Transit time By lane` shifted from implicit sequential requirements to explicit `OR` conditions across different transportation legs (SEA, RAIL, TRUCK).
    *   On December 15, 3:16 PM, the `Custom Booking` query's filtering mechanism was altered from `LOWER(a.customer)` to `LOWER(account_name)`, and null/empty checks for `m.mblno` were added to several queries.
    *   A new report type, `"Average Transit Time By Mode"`, was introduced around December 16, 1:02 PM, with complex `WHERE` clause logic covering both `OCEAN` and `AIR` legs, including a `LEFT JOIN` to `mtr_air_data`. This new query's logic for combining OCEAN and AIR conditions evolved, initially using `AND` (December 16, 1:41 PM) and then correctly switching to an `OR` condition combined with `air.customer_name IS NOT NULL` check (December 16, 1:47 PM).
    *   A temporary or debugging-related fixed date range `AND m.departure_date >= '2025-01-01'::timestamp AND m.departure_date < '2025-12-16'::timestamp + INTERVAL '1 day' ORDER BY m.departure_date ASC` was added to the `"Average Transit Time By Mode"` query on December 16, 2:28 PM.
    *   On December 16, 3:26 PM, the `Custom Booking` query was fundamentally changed to query only the `agent_booking_entry` table, removing the join to `mtr_tracking_data` and filtering by `a.customer`. Shortly after (December 16, 3:27 PM), this query was commented out, indicating it might be under review or temporarily disabled.

*   **`src\utils\analytics.ts`**: This utility file saw updates primarily focused on data processing and column management for analytics.
    *   On December 15, 12:12 PM, the `dateFilterOnExport` function's `dateKeys` array was expanded to include a wider range of date-related fields (e.g., `rail_ata`, `rail_etd`, `vessel_actualarrived_date`), ensuring more comprehensive date validation and formatting for exports. `rail_destination` was later removed from this list as it's not a date field (December 15, 1:57 PM).
    *   On December 15, 12:24 PM, `m.rail_ata` was added to the `otherColumns` string in `getExcelSelectedColumns`.
    *   Around December 16, 1:25 PM, the `bookingColumns` variable in `getExcelSelectedColumns` was commented out; however, the columns it originally defined were still being conditionally appended, suggesting a potential refactoring or oversight.

*   **`src\controllers\analytics\core.export.controller.ts`**: This controller handles the overall export data flow. On December 15, 2:02 PM, a new utility function `replaceColumnHandler` was introduced, which standardizes port names by replacing "LONG BEACH" with "LOS ANGELES" (case-insensitive) in both `pod` and `place_of_delivery` fields of the exported data. Subsequent minor changes involved debugging `console.log` statements (December 15, 2:08 PM and 2:09 PM).

*   **`src\controllers\code.controller.ts`**: This file contains customer-related API endpoints. The single log entry for this file (December 15, 3:48 PM) shows existing functionality for `getAllCustomer` (fetching customer details, shipper maps, and document uploads) and `createCustomer` (handling customer creation/modification with transaction management, type assignments, and shipper/customer mapping). No discernible changes are observed within this single entry.

*   **`src\controllers\analytics\others.controller.ts`**: This file contains the `getTableDataReports` function, which acts as a central dispatcher for various analytics reports. The single log entry (December 16, 12:56 PM) shows an extensive `if/else if` structure that directs requests to specific query builders (`chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) based on the `type` parameter in the request. It also sets up common customization options (`dateRange`, `calType`) and retrieves user/company information before dispatching.

**Patterns and Recurring Elements:**

*   **Date-centric Analytics:** A strong emphasis on date range filtering, date comparisons (e.g., `EXTRACT(DAY FROM date1 - date2)`), and date formatting for various reports and exports is a dominant theme.
*   **Conditional Query Building:** The use of helper functions (`getColumnsByCategory`, `getFilterQueryByDisplayValue`, `bookingQuery`, `nonBookingQuery`, and the dispatch logic in `others.controller.ts`) to dynamically construct SQL queries based on report type and user-defined parameters.
*   **Company-Specific Data:** Queries consistently include `LOWER(account_name) = '${CompanyName}'` for data scoping.
*   **Data Standardization/Transformation:** The introduction of `replaceColumnHandler` in `core.export.controller.ts` for standardizing port names ("LONG BEACH" to "LOS ANGELES") highlights efforts to clean or unify data presentation.
*   **Report Granularity:** Many report types offer both general and "MBL Wise" versions, indicating support for different levels of detail in analytics.
*   **Debugging:** Frequent additions and modifications of `console.log` and `logger.info` statements suggest active development and debugging during this period.
*   **Iterative Refinement:** Especially seen in `booking.query.ts` and `export.query.ts`, where query logic, column selection, and conditional clauses are repeatedly adjusted and optimized.