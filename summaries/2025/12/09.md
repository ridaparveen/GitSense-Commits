# Activity Summary for 12/9/2025

## 2:18:31 PM
The changes log primarily details updates across two files: `analytics.route.ts` and `code.controller.ts`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\analytics.route.ts`**
*   **Timestamp:** 12/8/2025, 10:12:54 AM
*   **Key Update:** This file defines the API routes for analytics functionalities. It imports various specialized controllers (e.g., `core.view.controller`, `core.metric.controller`, `cbm.controller`, `kgs.controller`, `teu.controller`, `container.controller`, `transit.controller`, `others.controller`, `core.export.controller`) and maps them to specific HTTP endpoints.
    *   It includes comprehensive CRUD operations (GET, POST, PUT, DELETE) for `/dashboards`.
    *   GET endpoints are established for `/dashboardEndPoints`, `/metricsList`, `/excelExport`, and various types of reports like `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`.
    *   POST endpoints are added for user preferences, specifically `/save_sequence` and `/save_size`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts`**
This file, responsible for customer-related operations, underwent iterative changes across 12/8/2025 and 12/9/2025.
*   **Initial State (12/8/2025, 2:03:37 PM):**
    *   It contains `getAllCustomer` function, which retrieves paginated and sortable customer master data, including associated shipper mappings and document upload details. It dynamically constructs search conditions based on query parameters.
    *   The `createCustomer` function is present, handling both new customer creation and modification. It supports file uploads, sanitizes customer names, manages database transactions, and inserts/updates customer details along with their associated types and shipper mappings. For existing customers, it performs a delete-then-insert strategy for related records.
*   **Minor Logging Additions (12/9/2025, 10:07:30 AM - 11:24:10 AM):**
    *   Added `console.log` statements for debugging purposes, specifically to log inserted shipper map details and the request body in `createCustomer`.
    *   A block of code related to `insertCustomerMapQuery` was temporarily commented out, indicating ongoing development or temporary deactivation of a feature.
*   **Introduction of Customer Mapping (12/9/2025, 11:31:37 AM):**
    *   The `createCustomer` function was significantly updated to process a new `customer_mapping` field from the request body. It now includes logic to parse this `customer_mapping` (expected as JSON) and insert the data into the `Account_Master_Customer_MAP` table.
*   **Refinement and Robustness for Customer Mapping (12/9/2025, 11:39:18 AM):**
    *   The parsing logic for `customer_mapping` in `createCustomer` was enhanced. It now checks if `customer_mapping` is an array and uses `flatMap` with a `try-catch` block to robustly parse each entry as JSON, logging errors for invalid entries.
*   **Integration of Customer Mapping Retrieval (12/9/2025, 11:53:20 AM):**
    *   The `getAllCustomer` function was updated to now also fetch `customer_map` data from the `Account_Master_Customer_MAP` table based on the customer's `acode`. This newly retrieved `customerMapData` is then included in the response for each customer.

**Patterns and Recurring Elements:**
*   **Database-Centric Operations:** Both files extensively interact with a PostgreSQL database, utilizing `query` functions and specific SQL constructs (e.g., `$1`, `ilike`, `LIMIT`, `OFFSET`).
*   **Transactional Integrity:** The `createCustomer` function in `code.controller.ts` explicitly uses `BEGIN`, `COMMIT`, and `ROLLBACK` for database transactions, ensuring data consistency during complex multi-table insertions and updates.
*   **Error Handling and Logging:** Robust error handling with `try-catch` blocks and `res.status(500).json({ response: "ERROR" })` is consistently applied. Extensive logging (`logger.info`, `console.log`) is used throughout for debugging and tracing data flow, especially within the customer controller.
*   **Data Validation and Sanitization:** Utility functions like `chkStr` are frequently used to validate and sanitize string data before processing or returning it. Customer names (`cname`) undergo explicit sanitization.
*   **Modular Architecture:** The `analytics.route.ts` demonstrates a modular approach by importing specific controllers for different analytical report types, suggesting a clear separation of concerns in the backend.

## 2:18:39 PM
The code changes primarily focus on enhancing the customer form and its associated mapping functionalities within a React frontend application.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\code\CustomerFormScreen.jsx`**

*   **12/8/2025, 2:08:25 PM - 2:09:15 PM**: The `CustomerFormScreen` component initializes a `CustomerForm` with various `initialValues` derived from the `useLocation` state. It fetches customer mapping data using `useFetchCustomerQuery` and populates a `mapping` array in the component's state, defaulting to `[{ country: "", shipper: "", agent: "" }]` if no mapping data is found.
*   **12/9/2025, 11:47:17 AM - 11:58:27 AM**: A new state property `customer_mapping: []` was introduced to `initialValues`. The `useEffect` hook was subsequently updated to also fetch and initialize `customer_mapping` from `mappingData.data[0]?.customer_mapping`, providing a default structure of `[{ customer: "" }]` if the fetched data is empty or unavailable.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerForm.jsx`**

*   **12/8/2025, 2:10:07 PM**: The `CustomerForm` component uses Formik for form management, including input fields, autocomplete selections (Sales Rep, Descartes Customer Mapping, ISF Party Mapping, City), and a submission handler that converts form values into `FormData` for API calls, stringifying `files` and `mapping` arrays.
*   **12/8/2025, 2:11:08 PM**: The `CustomerMapping` component was imported, signifying its integration into the customer form.
*   **12/9/2025, 11:26:49 AM**: The form's `onSubmit` logic was modified to include the new `customer_mapping` array, stringifying it and appending it to the `FormData` for submission to the backend.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**

*   **12/8/2025, 2:10:45 PM**: This component was introduced to manage dynamic rows of customer mappings. Initially, each mapping row included `country`, `shipper`, and `agent` fields, with `AppAutocomplete` components for each. It provided functions to `addRow`, `deleteRow`, and `updateRow` within the `formik` state and used a generic `handleOptionChange` to fetch dynamic options.
*   **12/8/2025, 2:12:23 PM - 2:17:28 PM**: The UI was iteratively simplified. The `AppAutocomplete` components for `Country` and `Shipper` were removed from the rendering, leaving only "Agent" visible. An "Add" icon was introduced alongside the "Delete" icon within each row, replacing a global "Add Mapping" button, and its `disabled` state was later corrected to always allow adding new rows. The label for the visible autocomplete was changed from "Agent" to "Customer."
*   **12/8/2025, 2:25:25 PM**: The internal structure of a mapping row was significantly refactored from `{ country: "", shipper: "", agent: "" }` to `{ country: "", shipper: "", customer: "" }`. Corresponding state variables were renamed (`optionsAgent` to `optionsCustomer`), and `AppAutocomplete` props were updated to reflect the "customer" field.
*   **12/8/2025, 2:29:06 PM - 2:39:07 PM**: The `handleOptionChange` function was refined to specifically fetch "customer" options from `ApiManager.getCommonOptions`. Debugging logs were added, and the parsing of the API response for customer options evolved, first from `response?.data` to `response?.customers`, and then mapping `item.cname` to `label` and `value` properties to `item.label` and `item.value` respectively, indicating a change in the expected API data shape. A recurring typo (`erFror`) was introduced in console error messages during this period.
*   **12/9/2025, 11:27:34 AM - 11:45:27 AM**: The component underwent a major refactor to exclusively manage `formik.values.customer_mapping` instead of the more generic `mapping`. The structure of each `customer_mapping` entry was simplified to only contain `{ customer: "" }`, removing `country` and `shipper` fields entirely from the component's internal state and UI logic.

**Patterns and Recurring Elements:**

*   **Customer-centric development:** All changes revolve around managing customer information and associated mappings.
*   **Formik for state management:** `useFormik` is consistently used for handling form state, validation, and submission.
*   **Material-UI for UI components:** The project heavily utilizes Material-UI components (Grid, Box, Card, IconButton, Autocomplete, InputBox, etc.) for building the user interface.
*   **Dynamic autocomplete fields:** `AppAutocomplete` is used across components to provide dynamic search and selection of various entities (sales reps, cities, customers, etc.) by interacting with `ApiManager`.
*   **Incremental feature development:** The addition of `customer_mapping` shows a pattern of introducing a new data point, integrating it into the main form, and then developing a dedicated UI component for its management, with iterative refinements to its data structure and API interaction.
*   **API interaction for options and submission:** `ApiManager` is consistently used for fetching dynamic data for autocompletes, and RTK Query (`useAddCustomerMutation`, `useFetchCustomerQuery`) is used for primary data operations.
*   **Debugging via `console.log`:** Several `console.log` statements are present, indicating active debugging during development.

## 3:18:31 PM
The changes log details updates across two primary files: an analytics route definition and a customer management controller.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\analytics.route.ts`**
    *   **Timestamp: 12/8/2025, 10:12:54 AM**
    *   This file received a significant update, likely its initial definition or a major overhaul. It establishes a comprehensive set of API endpoints for analytics. These include:
        *   CRUD operations for dashboards (`/dashboards`).
        *   Retrieval of dashboard endpoints (`/dashboardEndPoints`) and metric lists (`/metricsList`).
        *   An endpoint for exporting data to Excel (`/excelExport`).
        *   Endpoints for saving user preferences related to analytics, such as sequence (`/save_sequence`) and size (`/save_size`).
        *   Specific report endpoints for CBM, KGS, TEU, containers, transit, and generic table data.
    *   The route file imports numerous specialized controllers, indicating a modular structure for analytics functionalities.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts`**
    *   This file, primarily dealing with customer data, underwent a series of iterative updates.
    *   **Initial Major Update (12/8/2025, 2:03:37 PM):**
        *   **`getAllCustomer` function:** Implemented to fetch paginated and sortable customer data from `PO_AccountMaster_Customer_Master`. It also retrieves associated shipper information from `account_master_shipper_MAP` and document details from `document_upload_details`, combining them into a single response.
        *   **`createCustomer` function:** Introduced for creating or modifying customer records. It handles file uploads, sanitizes customer names, and manages a database transaction (`BEGIN`, `COMMIT`, `ROLLBACK`) for data consistency. For existing customers, it first deletes related entries from several tables (`PO_AccountMaster_Customer_Master`, `agent_po_account_master_type`, `Account_Master_Shipper_MAP`, `account_master_pic`) before inserting new data. It also processes customer types and shipper mappings, resolving codes for ports, shippers, and agents from other master tables.
    *   **Debugging and Logging Enhancements (12/9/2025, 10:07:30 AM - 11:24:10 AM):**
        *   Several minor revisions were made, primarily adding `console.log` statements for debugging purposes, such as logging `shippername` and the entire `req.body` to inspect incoming data during the `createCustomer` process.
        *   A previously commented-out section related to `Account_Master_Customer_MAP` was present but not activated.
    *   **Implementation of Customer-to-Customer Mapping (12/9/2025, 11:31:37 AM):**
        *   The `createCustomer` function was updated to accept a new `customer_mapping` field. A new loop was added to parse this data and insert it into the `Account_Master_Customer_MAP` table, signifying the activation of a new customer relationship mapping feature.
    *   **Further Debugging and Robustness (12/9/2025, 11:36:32 AM - 11:39:18 AM):**
        *   Additional `console.log` statements were added to inspect the `parsedCustomerMappingData`.
        *   The parsing logic for `customer_mapping` was made more robust by adding checks for array type and incorporating `try-catch` blocks around `JSON.parse` to handle potentially invalid JSON entries gracefully.
    *   **Customer Mapping Retrieval (12/9/2025, 11:53:20 AM):**
        *   The `getAllCustomer` function was enhanced to also query and return `customer_map` data from the `Account_Master_Customer_MAP` table, making the customer mapping data accessible when retrieving customer details.

**Patterns and Recurring Elements:**

*   **Database Transaction Management:** The `createCustomer` function consistently employs `BEGIN`, `COMMIT`, and `ROLLBACK` for SQL operations, highlighting a focus on atomicity and data integrity, especially during complex inserts and updates involving multiple tables.
*   **Extensive Logging for Debugging:** Numerous `logger.info` and `console.log` statements are present throughout the `code.controller.ts` file, particularly during the iterative development cycle, indicating active debugging and verification of data flow and processing.
*   **Data Sanitization:** The `chkStr` utility and `cname.replace` operations are used repeatedly to ensure data cleanliness and prevent issues with special characters or excessive whitespace before database interactions or presentation.
*   **Modular Architecture:** The `analytics.route.ts` demonstrates a modular approach by delegating specific functionalities to different controllers, improving code organization and maintainability.
*   **Customer Master Data Focus:** The `code.controller.ts` file is entirely dedicated to the lifecycle of customer master data, including detailed retrieval with associated entities and a comprehensive creation/modification process.
*   **Iterative Feature Development:** The log entries for `code.controller.ts` clearly illustrate an iterative development pattern, starting with core functionalities, then adding debugging, implementing new features (like customer mapping), and subsequently enhancing their robustness and retrieval.