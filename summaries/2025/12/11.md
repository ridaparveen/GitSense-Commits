# Activity Summary for 12/11/2025

## 2:18:32 PM
The provided log details changes across several controller files within a `t360-backend` project, all occurring on **12/11/2025**. The changes primarily focus on data retrieval, manipulation, and auditing related to customer, booking, DSO order, and ISF (Importer Security Filing) functionalities.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts` (12/11/2025, 10:21:51 AM)**
    *   This file, despite its name "code.controller.ts", appears to handle customer-related operations.
    *   **`getAllCustomer` function:** Implements comprehensive customer data retrieval with pagination, sorting (`orderBy`), and dynamic search capabilities based on query parameters. It fetches primary customer data (`PO_AccountMaster_Customer_Master`), related shipper mappings (`account_master_shipper_MAP`), customer document uploads (`document_upload_details`), and customer-to-customer mappings (`Account_Master_Customer_MAP`).
    *   **`createCustomer` function:** Handles creation and modification of customer records.
        *   It uses `fileUpload` utility.
        *   Sanitizes `cname` by replacing multiple spaces and single quotes.
        *   Initiates a database transaction (`BEGIN`).
        *   Checks for existing customers by `acode` to determine if it's an `UPDATE` or `NEW` operation. If updating, it deletes existing related records before re-inserting.
        *   Generates a new `acode` using `getAccountCode` if it's a new customer.
        *   Inserts or updates data into `PO_AccountMaster_Customer_Master`.
        *   Handles customer types (specifically 'CUSTOMER' type) by generating a `subcode` and inserting into `agent_po_account_master_type`.
        *   Processes `mapping` data (likely shipper mappings), retrieving `polcode`, `shippercode`, and `agentcode` from other master tables (`portmaster`, `agent_po_account_master`) and inserting into `Account_Master_Shipper_MAP`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts` (12/11/2025, 10:48:24 AM and 11:05:25 AM)**
    *   These two entries show identical code, suggesting a re-save or minor, non-substantive change.
    *   Focuses on robust auditing for booking-related operations.
    *   **`auditDoUpdates` function:** Audits updates to Delivery Order (DO) related fields (`do_number`, `do_date`, `bookingdate`, `bookingno`) within the `agent_booking_entry` table, only logging changes when values differ from old data. Sets `booking_status` to `CONFIRMED` on update.
    *   **`auditBookingChanges` function:** A comprehensive audit function for various booking-related tables:
        *   `agent_booking_entry` (main booking details).
        *   `agent_booking_linked_po`: Tracks additions and removals of linked POs, logging detailed summaries for each.
        *   `agent_booking_vessel`: Tracks additions and removals of vessel information, including details like vessel, voyage, line, ETD, ETA, and CY Cutoff.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\dso_order.controller.ts` (12/11/2025, 11:08:54 AM, 11:11:03 AM, and 11:12:08 AM)**
    *   These three entries also show identical code, indicating minor or non-substantive changes, or re-saves.
    *   **`getAll` function:** Retrieves DSO (Direct Ship Order) records with pagination, sorting, date range filtering, and dynamic search.
        *   Supports searching by `supplier` name, translating it to `party_id`.
        *   Includes an `isExport` flag to fetch all data without pagination.
        *   Fetches and formats `fob_point` options, including country names.
        *   Enriches `supplier` data by looking up the supplier name from `spr_vendor_master`.
        *   Constructs a complex SQL query that joins `dso_order` with `dso_order_details` and `spr_destination_master`, aggregating order details into a JSON object.
    *   **`columnSearch` function:** A helper to build `WHERE` clauses for search conditions, handling `serial_id` for single or multiple values and other fields with `ilike` for partial matches.
    *   **`getSqlQuery` function:** Generates the main SQL query for fetching DSO orders, including joins and aggregated `orderDetails`.
    *   **`countTotalRecordQuery` function:** Generates a SQL query to count total records based on search criteria.
    *   **`getAllForBooking` function:** A similar function to `getAll` but tailored for booking context, potentially to fetch specific DSO orders linked to a booking via `serial_id`. The code provided is incomplete for this function.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\isf_v2.controller.ts` (12/11/2025, 12:09:38 PM, 12:21:59 PM, and 1:39:49 PM)**
    *   These three entries show minor differences, mainly in commented-out lines and the `generateUniqId` call, indicating iterative development.
    *   **`fields` array:** A comprehensive list of fields for `isf_master` table, covering various party details (shipper, shipto, notify, consolidator, importer, broker, buyer, seller, manufacturer), location details, and shipment information.
    *   **`fetchEdiPayload` function:** Retrieves ISF (Importer Security Filing) master data and associated commodity list (`isf_commodity_list`) based on `isf_ref_number`.
    *   **`createEdit` function:** Handles creation or updating of ISF records.
        *   Determines `EntryMode` (UPDATE/ADD) based on `isf_ref_number` presence.
        *   Sets `locationByRole` based on the user's role.
        *   Starts a database transaction.
        *   **For UPDATE:** Performs an audit using `insertAudit`, checks `cng_xml_batchlog` for previous XML creation status, updates `isf_master` with `payload`, `location`, `status`, `updated_by`, and `updated_at`, then deletes existing `isf_commodity_list` entries for re-insertion.
        *   **For ADD:** (Changes between timestamps: The line `isf_ref_number = await generateUniqId(...)` was present in earlier versions but commented out or removed in the 1:39:49 PM entry, suggesting the `isf_ref_number` might be generated differently or assumed to be provided in `payload` even for new entries, though the `EntryMode.ADD` logic seems to imply it would be generated). Inserts into `isf_master` and performs a `simpleAudit`.
        *   Inserts or re-inserts `htsList` (commodity list) into `isf_commodity_list`.
        *   Commits or rolls back the transaction.
    *   **`changeIsfStatus` function:** Updates the `status` and `reject_reason` for an ISF record.
    *   **`createDescXml` function:** Generates an ISF XML document using `isfXmlGenerator`. Checks if an XML was already sent or created.
    *   **`uploadDescXml` function:** Uploads the generated ISF XML document using `isfDescXmlUpload`. Checks if an XML was already sent.
    *   **`getAllIsfDashboard` function:** Initiates a dashboard data retrieval, but the provided code snippet is incomplete.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (12/11/2025, 2:11:05 PM and 2:12:46 PM)**
    *   These two entries are identical, suggesting a re-save or no functional change.
    *   Defines `QueryBuilderI` interface for analytics query parameters.
    *   **`bookingQueryBuilder` function:** Constructs complex SQL queries for various booking-related analytics reports.
    *   **Common elements:**
        *   Retrieves `selectedColumns` based on category and user/report name.
        *   Sets `customizer` properties like `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, and `calColumnConfig`.
        *   Uses `getFilterQueryByDisplayValue` for dynamic filtering.
    *   **Specific report types implemented:**
        *   `BookingDatetoActualDeparture`: Calculates average days between booking date and actual departure per file/container.
        *   `BookingDatetoActualDepartureMblWise`: Similar to above, but per file/MBL.
        *   `BookingDatetoActualDepartureStackedBar`: Generates data for a stacked bar chart, categorizing the `day_diff` into 'Less than 1 week', '1 - 2 weeks', etc., grouped by a `dateTrunc` value.
        *   `BookingDatetoActualDepartureMblWiseStackedBar`: Same as above, but MBL-wise.
    *   All these queries involve complex `SELECT DISTINCT ON`, `JOIN` between `mtr_tracking_data` and `agent_booking_entry`, `WHERE` clauses for date ranges and company name, and date extraction (`EXTRACT(DAY FROM ...)`) for calculating differences.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (12/11/2025, 2:13:29 PM)**
    *   **`getTableDataReports` function:** Main entry point for various analytics reports.
    *   Handles `fromDate`, `toDate`, `mblwise`, `viewBy`, `type`, and `displayBy` from query parameters, setting default date ranges if not provided.
    *   Determines `CompanyName` and `user_id` from the authenticated user and query.
    *   Uses a large `if-else if` block to dispatch to different query builders (`chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) based on the `type` parameter.
    *   Logs the generated SQL query before executing it.
    *   Returns `analysticsData` and `customizer` to the client.

### Patterns and Recurring Elements:

1.  **Date-based Filtering and Formatting:** Many controllers (DSO, Analytics) utilize `fromDate` and `toDate` for filtering data, often converting strings to `MM/DD/YYYY` or `YYYY-MM-DD` for database interaction. The `AppDateFormate` utility is common in `booking.controller.ts`.
2.  **Pagination and Sorting:** `page`, `perPage`, and `orderBy` are recurring query parameters for data retrieval across `code.controller.ts` and `dso_order.controller.ts`, indicating a standardized approach to listing data.
3.  **Dynamic Search/Filtering:** Functions like `columnSearch` (in `dso_order.controller.ts`) and iterating through `req.query` (`code.controller.ts`, `dso_order.controller.ts`) to build `WHERE` clauses based on column names are common for flexible data searching.
4.  **Database Transactions:** `await query('BEGIN')`, `await query('COMMIT')`, and `await query('ROLLBACK')` are used consistently in `createCustomer` (code.controller.ts) and `createEdit` (isf_v2.controller.ts) to ensure data integrity during multi-step operations.
5.  **Auditing:** The `AuditModule` (specifically `insertAudit` and `simpleAudit`) is heavily used in `booking.controller.ts` and `isf_v2.controller.ts` to log changes, additions, and removals for traceability.
6.  **`AuthenticatedRequest`:** All controllers use `AuthenticatedRequest`, implying a common authentication middleware is in place, and user information (`req.user.userid`, `req.user.role`, `req.user.location`, `req.user.companyname`) is readily available.
7.  **Error Handling:** `try-catch` blocks are consistently used, often throwing `HttpError` for specific issues and logging errors, then returning a 500 status on internal server errors.
8.  **Helper/Utility Functions:** Several utility functions (`chkStr`, `getAccountCode`, `getAccountSubCode`, `removeLastWord`, `generateUniqId`, `AppDateFormate`, `getColumnsByCategory`, `getFilterQueryByDisplayValue`) are imported and used across different files, promoting code reusability.
9.  **Data Enrichment:** Controllers often fetch basic data and then perform additional queries to enrich it (e.g., getting shipper/agent names in `code.controller.ts`, supplier names in `dso_order.controller.ts`, HTS list in `isf_v2.controller.ts`).
10. **XML Generation and Upload:** `isf_v2.controller.ts` specifically uses `isfXmlGenerator` and `isfDescXmlUpload` for generating and uploading XML documents related to ISF filings, checking batch logs (`cng_xml_batchlog`) for previous states.
11. **Logger Usage:** `logger.info` and `logger.error` calls are pervasive for debugging and operational monitoring throughout all changed files.