# Activity Summary for 12/17/2025

## 1:46:52 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` (timestamp 12/17/2025, 11:41:23 AM) introduces a `bookingQueryBuilder` function responsible for constructing dynamic SQL queries for various booking-related analytics reports. It defines interfaces for `CalColumn`, `CalColumnConfig`, `Customizer`, and `QueryBuilderI` to manage column selection, date ranges, chart types, and other report customizations. The builder handles several report types, including "BookingDatetoActualDeparture", "BookingDatetoActualDepartureMblWise", and "BookingDatetoActualDepartureStackedBar", generating SQL to calculate average day differences between booking and actual departure dates, sometimes grouped by `fileno`, `contno`, or `mblno`, and categorizing time differences into weekly ranges for stacked bar charts. All generated queries consistently join `mtr_tracking_data` with `agent_booking_entry` tables and apply common filters for company name, valid dates, and date ranges.

The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts` saw two significant updates on 12/17/2025.
The first entry (timestamp 11:47:02 AM) details several utility functions:
- `defaultDateRange`: Provides a default date range (current date to 365 days prior).
- `replaceValueInQuery`: A helper to replace specific column values, particularly for `pod` or `place_of_delivery`.
- `getUserObject`: Fetches user information, especially for administrative access, to set `usercode` and `companyname`.
- `getFilterQueryByDisplayValue`: Generates SQL `groupBy`, `orderBy`, `dateTrunc`, and `select` clauses based on how data should be displayed (e.g., by month, week, or quarter).
- `getExcelSelectedColumns`: Dynamically builds the `SELECT` clause for SQL queries based on the `reportName` and whether it's a booking report, specifying common, booking, and other detailed columns.
- `dateFilterOnExport`: A crucial function for data processing, it iterates through a predefined list of `dateKeys`, validates date strings (checking for `0000-01-01T00:00:00.000Z` or dates before 1973), sets invalid dates to `null`, and optionally formats valid dates to "MM/DD/YYYY" using `moment`.
- `EXCEL_EXPORT_COLUMNS`: A comprehensive array defining the key-name mappings for columns to be exported to Excel.

The subsequent update to `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts` (timestamp 12/17/2025, 11:47:27 AM, and a third entry at 11:48:09 AM which is identical) primarily extends the `dateKeys` array within the `dateFilterOnExport` function. This update adds several new date-related fields such as `"rail_ata"`, `"rail_etd"`, `"t49_raildeparted_date"`, `"vessel_actualarrived_date"`, `"vessel_actualdeparted_date"`, `"inland_rail_move"`, `"rail_departed_pod"`, `"live_date_of_rcf"`, `"live_date_of_dep"`, `"ata"`, and `"actual_departure_date"`, ensuring that these additional date columns are also subjected to the same validation and formatting logic during data export.

The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\tableService.ts` (timestamp 12/17/2025, 12:03:30 PM) defines `getTableDataReports`, an asynchronous function that acts as a central dispatcher for various analytics reports. It retrieves report parameters from the request, defaults date ranges if not provided, and uses `getUserObject` to establish context. It then employs a large conditional structure to call the appropriate query builder (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) based on the `type` of report requested. The `bookingQueryBuilder` branch is particularly extensive, covering a wide array of booking, cargo-ready, and confirmation date reports, including "MBL Wise" and "Stacked Bar" variations, as well as several transit time and spend reports. The function executes the generated SQL query and returns the results along with customizer settings, incorporating error handling and logging.

Finally, `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts` (timestamp 12/17/2025, 12:08:20 PM) introduces a `getMonthValue` helper for converting month formats and the `bookingQuery` function. This function is designed to generate specific SQL query fragments for data export, particularly for reports that feature stacked bar charts. It uses the `reportName` along with other parameters like `CompanyName`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, and `displayBy` to construct detailed `WHERE` clauses, including date filters (by month, week, or quarter) and categorization of day differences for stacked bar segments. This file focuses on generating the specific conditional filtering required for exporting data from aggregated stacked bar chart views, ensuring data integrity with checks for non-null and valid dates, and filtering by `account_name` and `mblno` where applicable.

**Patterns and Recurring Elements:**
- **Consistent Timestamp:** All changes occurred on the same day, 12/17/2025, within a short timeframe, indicating a focused development effort.
- **"Booking Date to Actual Departure" variations:** This specific metric is a recurring theme, implemented in various forms (simple, MBL-wise, stacked bar) across `booking.query.ts` and `export.query.ts`.
- **Date Handling and Validation:** Extensive date-related logic is present across the codebase. This includes defaulting date ranges, validating date strings (e.g., against `0001-01-01 00:00:00 BC` and a minimum year of 1973), formatting dates for export, and using `DATE_TRUNC`, `EXTRACT`, and timestamp intervals within SQL queries.
- **SQL Query Structure:** Many SQL queries consistently involve joining `mtr_tracking_data` and `agent_booking_entry` on `mblno`, filtering by `account_name`, and performing explicit checks for non-null and valid date fields to ensure data quality.
- **Customizer Object:** The `customizer` object is used consistently to configure report parameters such as date ranges, calculation types, and chart types.
- **Display Options:** The ability to display data grouped by month, week, or quarter (`displayBy` parameter) is supported and handled by `analytics.ts` and utilized in `export.query.ts`.
- **"MBL Wise" and "Stacked Bar" Reports:** There's a strong pattern of implementing reports with "MBL Wise" variations (indicating grouping or filtering by master bill of lading) and "Stacked Bar" visualizations (categorizing time differences into predefined ranges like "Less than 1 week").
- **Centralized Query Dispatch:** `tableService.ts` serves as a central point for routing analytics report requests to specialized query builder functions, promoting modularity.