# Activity Summary for 12/5/2025

## 10:00:06 AM
The log details recent development primarily focused on booking, HBL (House Bill of Lading) entry, and analytics reporting functionalities within the `t360-backend` project. All significant updates occurred on December 3rd and 4th, 2025. A recurring pattern is the presence of multiple, identical log entries for the same file within short periods, suggesting frequent saving or auto-saving during active development, rather than distinct functional changes in every entry.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts`**
    *   **Timestamp of significant change:** 12/3/2025, 12:06:34 PM.
    *   This file introduced and defined the `saveBooking` and `saveMaster` functions.
        *   `saveBooking` manages the creation and updating of booking entries. It includes logic to retrieve existing booking data, construct a payload from the request, and determine if the operation is an add or update. For updates, it performs a series of `DELETE` operations on associated tables (`agent_booking_entry`, `agent_booking_cargolist`, `agent_booking_container_pre`, `agent_booking_vessel`, `agent_booking_po`, `agent_booking_linked_po`) before re-inserting data. For new bookings, it generates a unique `agent_booking_id`. It handles multiple sub-lists (cargo, vessel, inventory, basic PO, linked PO) and updates related `dso_order` table entries. Input sanitization (`sanitizeString`, `sanitizeIntString`, `AppDateFormate`) is extensively used. Database transaction commands (`BEGIN`, `COMMIT`, `ROLLBACK`) are commented out in the provided snippet, indicating they might be handled elsewhere or were experimental.
        *   `saveMaster` is a simpler function for saving master account data, including validation of `account_type` against a predefined enum.
    *   Subsequent entries for this file between 12:09:31 PM and 12:13:10 PM on 12/3/2025 show no discernible code changes, implying minor, non-functional saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **Timestamp of significant changes:** 12/3/2025, 2:04:59 PM (initial implementation), and 12/3/2025, 3:44:53 PM (last recorded identical save).
    *   This file was introduced to handle HBL (House Bill of Lading) operations.
        *   `createHblMasterBooking`: This function is responsible for creating new HBL entries. It involves fetching a `bookingSerialId` from `agent_booking_entry`, inserting the main HBL data into `hbl_master`, and then inserting associated vessel, HBL details, routing information, container lists, and basic PO lists into their respective tables. It uses explicit database transactions and includes `simpleAudit` for logging the creation event.
        *   `updateHblMasterBooking`: This function handles modifications to existing HBL entries. It requires an `hbl_master_id` and performs large SQL `UPDATE` statements across `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. It integrates a more structured audit mechanism (`insertAudit`) that filters the payload based on a configuration object (`auditConfigObj`) to log specific changes.
    *   Many identical saves occurred for this file between 2:05:48 PM and 3:44:53 PM on 12/3/2025.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **Timestamp of significant change:** 12/3/2025, 2:36:19 PM.
    *   This file defines the API endpoints for HBL operations, mapping them to the controller functions in `hblEntry.controller.ts`. Routes include GET for fetching details and a specific HBL, POST for creating and updating, and a DELETE route (`/delete`) which is protected by `authMiddleware`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamp of significant change:** 12/4/2025, 11:59:53 AM (initial implementation).
    *   This file contains the `bookingQueryBuilder` function, which dynamically generates PostgreSQL queries for various booking-related analytics reports. It supports different report types such as "Booking Date to Actual Departure" (both container-wise and MBL-wise), and stacked bar chart versions of these reports, categorizing time differences into "Less than 1 week", "1 - 2 weeks", etc. All queries involve joining `mtr_tracking_data` and `agent_booking_entry`, filtering by `account_name` (company) and date ranges. It also configures chart properties via a `customizer` object.
    *   Numerous identical saves for this file were recorded between 12:10:31 PM and 3:35:27 PM on 12/4/2025.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **Timestamp of significant change:** 12/4/2025, 12:02:39 PM.
    *   This file provides the `getTableDataReports` function, acting as a central entry point for all analytics reports. It parses query parameters to determine the report type, date ranges, and company details. It then dispatches the request to the appropriate query builder function (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`). The generated SQL query is executed, and the results are returned along with customizer settings.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamp of significant changes:** 12/4/2025, 3:39:54 PM (initial implementation), 12/4/2025, 5:34:46 PM (added new query), and 12/4/2025, 5:44:45 PM (modified existing query).
    *   This file defines SQL query snippets for exporting analytics data. It includes a `getMonthValue` helper function for date conversions. The `bookingQuery` function returns a map of report names to their corresponding SQL query fragments.
    *   **3:39:54 PM:** Initial set of queries for reports like "Booking Date to Actual Departure", "Containers Shipped (Mbl Wise)", "Average Transit Time per Month (Days)", "Booking Date to Estimated Departure", and "Booking Date to POD Arrival" were added. These queries involve joins between `mtr_tracking_data` and `agent_booking_entry` and apply filters based on company name and valid dates. Conditional logic for stacked bar chart exports is also present.
    *   **5:34:46 PM:** A new report query, "Carrier On-time delivery By carrier," was added. This query calculates on-time and total shipment counts grouped by carrier SCAC code, comparing actual arrival dates against estimated arrival dates.
    *   **5:44:45 PM:** The "Carrier On-time delivery By carrier" query was refined by aliasing columns for consistency (`scac_code` as `entity`, `on_time_count` as `ata_on_time_count`), adding `TRIM()` checks for date fields, and *removing* a `WHERE` clause that enforced `mblno` to be not null, potentially allowing more data to be included in this specific report.
    *   Other entries for this file (e.g., 3:40:05 PM, 5:35:25 PM, 5:48:08 PM, 5:52:20 PM) are identical to the preceding entry, indicating non-functional saves.

### Patterns and Recurring Elements:

*   **Date Formatting and Sanitization:** The utility functions `sanitizeString`, `sanitizeIntString`, and `AppDateFormate` are widely used across controller files, demonstrating a consistent effort to clean and format incoming data before database operations.
*   **Database Transaction Management:** Explicit `BEGIN`, `COMMIT`, and `ROLLBACK` statements are used in `hblEntry.controller.ts`, indicating transactional integrity is important for multi-step data operations. While commented out in `booking.controller.ts`, the intention for transactions is clear.
*   **Role-Based Data Handling:** The `locationByRole` variable, determined by the user's role (`AGENT` or `ADMIN`), is a recurring element, suggesting dynamic data access or processing based on user permissions.
*   **Audit Logging:** Both `simpleAudit` and `insertAudit` functions are used, highlighting a system requirement for tracking changes and maintaining an audit trail for critical data.
*   **Modular Analytics Design:** The analytics functionality is separated into controller and query builder files, promoting reusability and maintainability of SQL query logic.
*   **Complex SQL Queries for Analytics:** A significant focus is on generating intricate PostgreSQL queries for various business intelligence reports. These queries frequently involve `JOIN` operations (especially between `mtr_tracking_data` and `agent_booking_entry`), date difference calculations (`EXTRACT(DAY FROM ...)`, `DATE_PART('day', ...)`), and conditional aggregations (`SUM(CASE WHEN ... THEN ... ELSE 0 END)` for stacked bar charts).
*   **Consistent Data Filtering:** Analytics queries consistently filter results by `LOWER(account_name) = '${CompanyName}'` and check for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` for critical date fields, ensuring data quality and relevance.