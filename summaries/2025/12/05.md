# Activity Summary for 12/5/2025

## 10:00:06 AM
The log details recent development primarily focused on booking, HBL (House Bill of Lading) entry, and analytics reporting functionalities within the `t360-backend` project. All significant updates occurred on December 3rd and 4th, 2025. A recurring pattern is the presence of multiple, identical log entries for the same file within short periods, suggesting frequent saving or auto-saving during active development, rather than distinct functional changes in every entry.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts`**
    *   **Timestamp of significant change:** 12/3/2025, 12:06:34 PM.
    *   This file introduced and defined the `saveBooking` and `saveMaster` functions.
        *   `saveBooking` manages the creation and updating of booking entries. It includes logic to retrieve existing booking data, construct a payload from the request, and determine if the operation is an add or update. For updates, it performs a series of `DELETE` operations on associated tables (`agent_booking_entry`, `agent_booking_cargolist`, `agent_booking_container_pre`, `agent_booking_vessel`, `agent_booking_po`, `agent_booking_linked_po`) before re-inserting data. For new bookings, it generates a unique `agent_booking_id`. It handles multiple sub-lists (cargo, vessel, inventory, basic PO, linked PO) and updates related `dso_order` table entries. Input sanitization (`sanitizeString`, `sanitizeIntString`, `AppDateFormate`) is extensively used. Database transaction commands (`BEGIN`, `COMMIT`, `ROLLBACK`) are commented out in the provided snippet, indicating they might be handled elsewhere or were experimental.
        *   `saveMaster` is a simpler function for saving master account data, including validation of `account_type` against a predefined enum.
    *   Subsequent entries for this file between 12:09:31 PM and 12:13:10 PM on 12/3/2025 show no discernible code changes, implying minor, non-functional saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **Timestamp of significant changes:** 12/3/2025, 2:04:59 PM (initial implementation), and 12/3/2025, 3:44:53 PM (last recorded identical save).
    *   This file was introduced to handle HBL (House Bill of Lading) operations.
        *   `createHblMasterBooking`: This function is responsible for creating new HBL entries. It involves fetching a `bookingSerialId` from `agent_booking_entry`, inserting the main HBL data into `hbl_master`, and then inserting associated vessel, HBL details, routing information, container lists, and basic PO lists into their respective tables. It uses explicit database transactions and includes `simpleAudit` for logging the creation event.
        *   `updateHblMasterBooking`: This function handles modifications to existing HBL entries. It requires an `hbl_master_id` and performs large SQL `UPDATE` statements across `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. It integrates a more structured audit mechanism (`insertAudit`) that filters the payload based on a configuration object (`auditConfigObj`) to log specific changes.
    *   Many identical saves occurred for this file between 2:05:48 PM and 3:44:53 PM on 12/3/2025.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **Timestamp of significant change:** 12/3/2025, 2:36:19 PM.
    *   This file defines the API endpoints for HBL operations, mapping them to the controller functions in `hblEntry.controller.ts`. Routes include GET for fetching details and a specific HBL, POST for creating and updating, and a DELETE route (`/delete`) which is protected by `authMiddleware`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamp of significant change:** 12/4/2025, 11:59:53 AM (initial implementation).
    *   This file contains the `bookingQueryBuilder` function, which dynamically generates PostgreSQL queries for various booking-related analytics reports. It supports different report types such as "Booking Date to Actual Departure" (both container-wise and MBL-wise), and stacked bar chart versions of these reports, categorizing time differences into "Less than 1 week", "1 - 2 weeks", etc. All queries involve joining `mtr_tracking_data` and `agent_booking_entry`, filtering by `account_name` (company) and date ranges. It also configures chart properties via a `customizer` object.
    *   Numerous identical saves for this file were recorded between 12:10:31 PM and 3:35:27 PM on 12/4/2025.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **Timestamp of significant change:** 12/4/2025, 12:02:39 PM.
    *   This file provides the `getTableDataReports` function, acting as a central entry point for all analytics reports. It parses query parameters to determine the report type, date ranges, and company details. It then dispatches the request to the appropriate query builder function (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`). The generated SQL query is executed, and the results are returned along with customizer settings.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamp of significant changes:** 12/4/2025, 3:39:54 PM (initial implementation), 12/4/2025, 5:34:46 PM (added new query), and 12/4/2025, 5:44:45 PM (modified existing query).
    *   This file defines SQL query snippets for exporting analytics data. It includes a `getMonthValue` helper function for date conversions. The `bookingQuery` function returns a map of report names to their corresponding SQL query fragments.
    *   **3:39:54 PM:** Initial set of queries for reports like "Booking Date to Actual Departure", "Containers Shipped (Mbl Wise)", "Average Transit Time per Month (Days)", "Booking Date to Estimated Departure", and "Booking Date to POD Arrival" were added. These queries involve joins between `mtr_tracking_data` and `agent_booking_entry` and apply filters based on company name and valid dates. Conditional logic for stacked bar chart exports is also present.
    *   **5:34:46 PM:** A new report query, "Carrier On-time delivery By carrier," was added. This query calculates on-time and total shipment counts grouped by carrier SCAC code, comparing actual arrival dates against estimated arrival dates.
    *   **5:44:45 PM:** The "Carrier On-time delivery By carrier" query was refined by aliasing columns for consistency (`scac_code` as `entity`, `on_time_count` as `ata_on_time_count`), adding `TRIM()` checks for date fields, and *removing* a `WHERE` clause that enforced `mblno` to be not null, potentially allowing more data to be included in this specific report.
    *   Other entries for this file (e.g., 3:40:05 PM, 5:35:25 PM, 5:48:08 PM, 5:52:20 PM) are identical to the preceding entry, indicating non-functional saves.

### Patterns and Recurring Elements:

*   **Date Formatting and Sanitization:** The utility functions `sanitizeString`, `sanitizeIntString`, and `AppDateFormate` are widely used across controller files, demonstrating a consistent effort to clean and format incoming data before database operations.
*   **Database Transaction Management:** Explicit `BEGIN`, `COMMIT`, and `ROLLBACK` statements are used in `hblEntry.controller.ts`, indicating transactional integrity is important for multi-step data operations. While commented out in `booking.controller.ts`, the intention for transactions is clear.
*   **Role-Based Data Handling:** The `locationByRole` variable, determined by the user's role (`AGENT` or `ADMIN`), is a recurring element, suggesting dynamic data access or processing based on user permissions.
*   **Audit Logging:** Both `simpleAudit` and `insertAudit` functions are used, highlighting a system requirement for tracking changes and maintaining an audit trail for critical data.
*   **Modular Analytics Design:** The analytics functionality is separated into controller and query builder files, promoting reusability and maintainability of SQL query logic.
*   **Complex SQL Queries for Analytics:** A significant focus is on generating intricate PostgreSQL queries for various business intelligence reports. These queries frequently involve `JOIN` operations (especially between `mtr_tracking_data` and `agent_booking_entry`), date difference calculations (`EXTRACT(DAY FROM ...)`, `DATE_PART('day', ...)`), and conditional aggregations (`SUM(CASE WHEN ... THEN ... ELSE 0 END)` for stacked bar charts).
*   **Consistent Data Filtering:** Analytics queries consistently filter results by `LOWER(account_name) = '${CompanyName}'` and check for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` for critical date fields, ensuring data quality and relevance.

## 10:59:33 AM
The provided log details changes across several JavaScript files within a React frontend application, primarily focusing on `HBLform.jsx`, `HblPoForm.jsx`, `BasicPoExtend.jsx`, and `agentBookingApi.js`. The changes largely revolve around refactoring components, improving data handling for Purchase Order (PO) details in House Bill of Lading (HBL) forms, and minor adjustments to API calls and initial state management.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblPoForm.jsx`**
    *   **Timestamp Range:** 12/3/2025, 12:25:57 PM to 12/3/2025, 3:49:19 PM
    *   **Key Changes:**
        *   Initial change (12:25:57 PM) introduces a `PODetailsExtend` component with basic and linked PO tabs, conditionally setting the tab based on `formik.values.client_name`.
        *   Renamed the default export function from `PODetailsExtend` to `HblPODetails` (12:26:15 PM).
        *   Modified the prop name from `formik` to `values` (12:27:09 PM) for `HblPODetails` and subsequently passed `values` as `formik` prop to `BasicPoExtend` and `LinkPoExtend`.
        *   Added a `console.log` statement for debugging `values` (1:01:38 PM).
        *   **Significant Refactoring (3:25:22 PM):** Changed the component `BasicPoExtend` to `BasicPoForHbl` within `TabPanel` value "1", indicating a specialized component for HBL basic POs.
        *   **Logic Update (3:49:19 PM):** The `useEffect` dependency changed from `values.client_name` to `values.basicPoList` and the condition for setting `tabValue` was updated to check `values.basicPoList?.[0]?.customer === 'SP RICHARDS COMPANY'`, implying PO details now determine the default tab.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
    *   **Timestamp Range:** 12/3/2025, 12:26:33 PM to 12/3/2025, 2:53:46 PM
    *   **Key Changes:**
        *   Throughout the timestamps, this file shows minor, iterative refinements, mostly around `initialValues` logic and `console.log` statements.
        *   **Initial `initialValues` (12:26:33 PM):** `agent_booking_id` was conditionally set based on `formAction === "copy"`.
        *   **Refined `agent_booking_id` logic (1:39:29 PM, 1:41:10 PM, 1:41:58 PM):** The logic for `agent_booking_id` in `initialValues` became more complex, handling `formAction === "copy" || formAction === "add"` and fallback to `location.state.agent_booking_id`. This was further refined to explicitly use `location.state?.agent_booking_id` in various conditions for clarity.
        *   **API Integration (2:37:43 PM):** Introduction of `useFetchHblBookingFormDetailsQuery` (later corrected to `useFetchPoFormDetailsQuery`) to fetch `poDetails`, which is then used to initialize `basicPoList` and `linkedPoList` in the `Formik` `initialValues`. This marks a shift towards dynamic data loading for POs.
        *   **`basicPoList` Initialization Logic (2:42:38 PM, 2:47:05 PM, 2:47:49 PM, 2:49:21 PM, 2:52:22 PM, 2:53:46 PM):** The `initialValues.basicPoList` underwent several iterations to prioritize `poDetails?.data?.basicPoList` if available, otherwise falling back to `initialValues?.basicPoList`. A final adjustment (4:56:44 PM) also added `linkedPoList: poDetails?.data?.linkedPoList || []` to initial values, indicating fetching of both basic and linked PO data.
        *   Removal of `BasicPoForm` import and addition of `skipToken` import (2:40:01 PM) for conditional query execution.
        *   Changes in `booking_no` initialization (1:54:00 PM onwards) to handle `formAction === "copy"` more robustly and use `location.state?.agent_booking_id`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form\sub-components\BasicPoExtend.jsx`**
    *   **Timestamp Range:** 12/3/2025, 12:33:44 PM to 12/3/2025, 3:24:24 PM
    *   **Key Changes:**
        *   This component manages a list of basic PO items, allowing addition, deletion, and updates. It uses `react-redux` for state management (`addList`, `removeList`, `updateList`).
        *   **Refactoring (3:24:24 PM):** The `values` prop was changed back to `formik`, indicating a rollback or a different strategy for this component.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
    *   **Timestamp:** 12/3/2025, 2:38:52 PM
    *   **Key Changes:**
        *   Added new API endpoints related to HBL (House Bill of Lading):
            *   `saveHblBooking`: Mutation for creating HBL entries.
            *   `fetchHblBookingFormDetails`: Query to fetch HBL booking details for a form.
            *   `fetchPoFormDetails`: Query to fetch Purchase Order (PO) details for a form, distinct from general HBL details.
            *   `getHblDashboard`: Query to retrieve HBL dashboard data.
            *   `updateHblBooking`: Mutation for updating HBL entries.
            *   `deleteHblBooking`: Mutation for deleting HBL entries.
        *   Updated `tagTypes` to include `"hbl"`.
        *   The `updateHblBooking` mutation includes a `console.log("==params", params);` for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
    *   **Timestamp Range:** 12/3/2025, 1:43:57 PM to 12/3/2025, 1:54:42 PM
    *   **Key Changes:**
        *   The `Add HBL` button's `onClick` handler was updated to set `formAction: "add"` in the navigation state (1:54:42 PM), previously it was `formAction: "copy"`. This changes the default action when adding a new HBL from the list screen.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblHeaderForms.jsx`**
    *   **Timestamp Range:** 12/3/2025, 1:42:46 PM to 12/3/2025, 1:51:28 PM
    *   **Key Changes:**
        *   Minor console log added (`values, "valuespppp00000"`).
        *   The `onChange` handler for `booking_no` was corrected from `onChange` to `handleChange` (1:51:28 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\BasicPoForHbl.jsx`**
    *   **Timestamp Range:** 12/3/2025, 3:25:02 PM to 12/3/2025, 3:37:58 PM
    *   **Key Changes:**
        *   **New Component (3:25:02 PM):** This file was created as `BasicPoForHbl.jsx`. It appears to be a specialized version of `BasicPoExtend` for HBLs.
        *   **Removed Redux Operations (3:27:29 PM):** All `onChange` handlers for input fields and `onClick` handlers for add/delete buttons were commented out or removed, suggesting this component primarily displays data from `formik.basicPoList` rather than directly managing it via Redux actions, implying formik now holds the source of truth for these lists.
        *   **Data Source Change (3:29:13 PM):** The mapping of PO rows now directly uses `formik?.basicPoList` instead of `selector` (Redux state).
        *   **Styling Adjustment (3:37:22 PM):** Grid item `lg` width for 'PO No' was changed from `1` to `1` (no effective change, but a recorded modification), hinting at minor layout adjustments.
        *   Removal of `IconButton` for Add/Delete actions (3:37:58 PM), confirming its role as a display-only component for the list.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form_extend\CargoFormExtend.jsx`**
    *   **Timestamp Range:** 12/3/2025, 4:58:45 PM to 12/4/2025, 3:21:14 PM
    *   **Key Changes:**
        *   Multiple save operations (often identical) over two days suggest continuous work or frequent saving without major functional changes being committed in each step. No substantive code changes were observed across these timestamps, indicating minor formatting, whitespace, or non-functional modifications.

### Patterns and Recurring Elements:

*   **Refactoring of PO Components:** There's a clear pattern of refining how Purchase Order (PO) details are handled. Initially, `HblPoForm.jsx` used `BasicPoExtend`, then changed to `BasicPoForHbl.jsx`, indicating a move towards specialized components for HBL-specific PO management. The data source for these PO lists also shifted from `useSelector` (Redux) to `formik.basicPoList`, suggesting a more localized management within the form's `Formik` state, possibly fetched once via an API.
*   **Data Fetching Strategy:** The introduction of `useFetchPoFormDetailsQuery` with `skipToken` in `HBLForm.jsx` indicates a dynamic, on-demand data fetching strategy for PO details based on the `agent_booking_id` from the URL state.
*   **Redux Toolkit Query (RTK Query):** The `agentBookingApi.js` file demonstrates heavy use of RTK Query for data fetching and mutations, with `providesTags` and `invalidatesTags` for efficient cache management (`"hbl"`, `"booking"`).
*   **Initial Values Logic:** The `initialValues` object in `HBLForm.jsx` for the `Formik` component is complex and frequently adjusted, especially for `agent_booking_id` and `basicPoList`/`linkedPoList`, reflecting the need for robust handling of different form actions (add, edit, copy) and data hydration from API calls.
*   **Debugging Statements:** Frequent `console.log` statements (e.g., `values===890`, `locatioppppp`, `hkkllll90000`, `poDetails===890`) suggest active development and debugging efforts across multiple files.
*   **Keyboard Shortcuts:** The `useKeyboardShortcut` hook is consistently used in `HBLForm.jsx` to enable quick actions (Edit Party, View Parties, Add New Parties, Save, Focus Party Input), indicating a focus on user efficiency.
*   **MUI Component Usage:** Consistent use of Material-UI (MUI) components like `Grid`, `Stack`, `Box`, `TabContext`, `TabList`, `TabPanel`, `Card`, `CardHeader`, `CardContent`, `InputBox`, `SelectBox`, `AppDatePicker`, `AppAutocomplete`, `IconButton`, `ThemedModal`, and `AppTable`.
*   **Component Naming Conventions:** The presence of `Extend` in component names like `InputBoxExtend`, `AppDatePickerExtend`, `AppAutocompleteExtend`, `SelectBoxExtend`, `LinkPoExtend`, `BasicPoExtend`, `AddCargoFormExtend`, `ThemedModalExtend` suggests a pattern of creating specialized or enhanced versions of common UI components.

## 10:59:36 AM
The code changes primarily focus on two areas: booking and HBL (House Bill of Lading) entry management, and analytics with data export.

**File-Specific Updates and Timestamps:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts` (12/3/2025, 12:06:34 PM - 12:15:30 PM)**:
    *   This file contains the `saveBooking` and `saveMaster` functions.
    *   `saveBooking` handles the creation and update of booking entries, including associated cargo, vessel, inventory, basic PO, and linked PO lists, using PostgreSQL transactions. It determines the entry mode (ADD or UPDATE) and either generates a new booking ID or reuses an existing one. It also updates `dso_order` for linked POs.
    *   `saveMaster` validates the `account_type` against a predefined enumeration.
    *   While there are multiple log entries for this file within a short period, the provided code content is identical across these timestamps, suggesting minor non-functional saves or formatting.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts` (12/3/2025, 2:04:59 PM - 3:44:53 PM)**:
    *   This file defines `createHblMasterBooking` and `updateHblMasterBooking` functions.
    *   `createHblMasterBooking` inserts new HBL master data, including vessel, HBL details, routing, container, and basic PO lists, into various tables (`hbl_master`, `agent_booking_vessel`, etc.). It utilizes transactions and a simple audit log.
    *   `updateHblMasterBooking` updates existing HBL master records and their associated details, also within a transaction and with detailed auditing using `insertAudit`.
    *   Similar to the `booking.controller.ts` file, the provided code content for this file is identical across its numerous logged timestamps, indicating minor saves or formatting changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts` (12/3/2025, 2:36:19 PM)**:
    *   This file sets up API routes for HBL entry, supporting fetching, creation, updating, and deletion of HBL forms, and fetching PO details. The delete route is protected by `authMiddleware`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (12/4/2025, 11:59:53 AM - 3:35:27 PM)**:
    *   This file contains the `bookingQueryBuilder` function, which dynamically constructs SQL queries for analytics reports related to booking data.
    *   It supports various report types, such as "Booking Date to Actual Departure" (including MBL-wise and stacked bar chart variations), calculating day differences between key dates.
    *   Like the previous controllers, the provided code content is identical across multiple timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (12/4/2025, 12:02:39 PM)**:
    *   This controller provides a central `getTableDataReports` function that dispatches to specific query builders (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`) based on the requested report type. It handles date range defaults and user-specific company access.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**:
    *   **12/4/2025, 3:39:54 PM**: Introduces `getMonthValue` for date extraction and the `bookingQuery` object, which stores specific SQL query fragments for various reports, including "Booking Date to Actual Departure" and "Containers Shipped (Mbl Wise)".
    *   **12/4/2025, 5:34:46 PM**: Adds a new query for "Carrier On-time delivery By carrier" to the `bookingQuery` object. This query calculates on-time and total shipment counts for carriers.
    *   **12/4/2025, 5:48:08 PM**: Refines the "Carrier On-time delivery By carrier" query by aliasing `scac_code` as `entity` and improving `TRIM` usage in the `WHERE` clause.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (12/5/2025, 10:52:08 AM)**:
    *   This file introduces the `getExportData` function, which orchestrates the data export process for analytics reports. It uses query fragments from `export.query.ts`, applies date filters, and performs column replacements (e.g., changing 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery` fields).

**Patterns and Recurring Elements:**

*   **Database Interactions:** All listed controllers heavily utilize database operations (`query`, `insertQuery`, `insertMany`, `updateQuery`) and manage data integrity through explicit PostgreSQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`).
*   **Input Sanitization and Date Formatting:** `sanitizeString`, `sanitizeIntString`, and `AppDateFormate` are consistently applied across controllers to process and validate incoming request data and dates, ensuring data quality and security.
*   **Dynamic SQL Query Generation:** For analytics, SQL queries are dynamically constructed based on report types and parameters, often involving date calculations (`EXTRACT(DAY FROM ...)`, `DATE_TRUNC`) and conditional aggregations for stacked bar charts.
*   **Audit Trail:** The HBL entry controller explicitly includes `simpleAudit` and `insertAudit` functions, indicating a requirement for logging data changes.
*   **Role-Based Logic:** User roles (`req.user.role`) influence data processing, such as determining `locationByRole` for various operations.
*   **Repetitive Saves:** Several files exhibit multiple consecutive log entries with identical code content, which might be due to frequent saves or a verbose version control system rather than actual functional changes between those specific timestamps.
*   **Data Transformation:** A `replaceColumnHandler` function is introduced in the export controller to standardize certain data values for consistency (e.g., geographical names).

## 11:59:32 AM
The provided log details code changes across several TypeScript files within a `t360-backend` project, primarily focusing on booking management and analytics export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts` (Timestamps: 12/3/2025, 12:06:34 PM - 12:15:30 PM):**
    *   Multiple log entries for this file show identical code. The file contains `saveBooking` and `saveMaster` functions.
    *   The `saveBooking` function handles both creating and updating agent bookings. It fetches old data, constructs a payload with sanitized input, generates a new `booking_id` for additions, or uses the existing one for updates. It performs multiple `DELETE` queries before `INSERT` operations for associated data (cargo lists, containers, vessels, basic POs, linked POs) to ensure data consistency during updates. It then inserts the main booking entry and related lists, calculating total CBM and weight from cargo items. Linked POs are updated to reflect `remain_packs`.
    *   The `saveMaster` function is partially shown, handling master data saving for various account types (Shipper, Consolidator, Customer, Seller, etc.). It validates the `account_type` against a predefined enum.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts` (Timestamps: 12/3/2025, 2:04:59 PM - 3:44:53 PM):**
    *   Similar to `booking.controller.ts`, several identical log entries are present. This file contains `createHblMasterBooking` and `updateHblMasterBooking` functions.
    *   `createHblMasterBooking`: Creates new House Bill of Lading (HBL) master entries. It sanitizes input, starts a database transaction, finds the `booking_serial_id` from `agent_booking_entry`, inserts data into `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables. It includes audit logging for new HBL creations.
    *   `updateHblMasterBooking`: Updates an existing HBL master record using a provided `serial_id`. It updates `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl` tables with new payload data and incorporates audit logging by filtering payload data against `hbl_master` configuration columns.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts` (Timestamp: 12/3/2025, 2:36:19 PM):**
    *   This file defines API routes for HBL operations, including fetching details (`/`), retrieving specific HBLs (`/get-hbl`), creating (`/create`), updating (`/update`), and deleting (`/delete`). It also includes a route to fetch PO details (`/get-po-details`). The delete route uses `authMiddleware`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Timestamps: 12/4/2025, 11:59:53 AM - 3:35:27 PM):**
    *   This file provides the `bookingQueryBuilder` function, which dynamically constructs SQL queries for various booking-related analytics reports (e.g., "Booking Date to Actual Departure", "Booking Date to Actual Departure Mbl Wise", "Booking Date to Actual Departure Stacked Bar").
    *   It uses parameters like `type`, `CompanyName`, `fromDate`, `toDate`, `displayBy`, `user_id`, and `reportName` to tailor the query.
    *   The queries often involve calculating day differences between dates (e.g., `t49_vessel_actualdeparted_date - bookingdate`) and grouping/filtering results for charts (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   All entries for this file are identical, indicating consistent implementation of these query builders.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 12/4/2025, 12:02:39 PM):**
    *   This file defines `getTableDataReports`, a central controller for fetching analytics reports.
    *   It determines the appropriate query builder (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) based on the `type` parameter.
    *   It handles default date ranges, retrieves user-specific company information, and executes the generated SQL queries, returning raw data and customizer settings.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 12/4/2025, 3:39:54 PM - 12/5/2025, 11:58:36 AM):**
    *   This file contains utility functions and SQL query fragments specifically for exporting analytics data.
    *   `getMonthValue`: A helper function to convert abbreviated month names (e.g., "Jan") to their numerical representation.
    *   `bookingQuery`: A function that returns a SQL query string (or fragment) based on the `reportName`. This includes queries for various booking-related metrics, transit times, and carrier on-time delivery. It supports conditional filtering based on month, week, or quarter for stacked bar chart exports.
    *   Multiple identical entries indicate the content remained constant throughout this period.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Timestamps: 12/5/2025, 10:52:08 AM - 11:55:28 AM):**
    *   This file implements `getExportData`, which handles the overall logic for exporting analytics reports.
    *   **Initial version (12/5/2025, 10:52:08 AM)**: It parses query parameters for date ranges, report type, company, and selected columns. It uses `bookingQuery` or `nonBookingQuery` to build the main SQL. It applies `dateFilterOnExport` and `replaceColumnHandler` for post-processing the data. A specific logic for "TEU MBLwise" reports is included to filter unique containers. The `replaceColumnHandler` function explicitly converts 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery` fields.
    *   **Subsequent updates (12/5/2025, 11:53:48 AM)**: A notable enhancement was added. Within the `if (isBooking)` block, if the `bookingQuery` function returns an empty or whitespace-only string for the `customQuery`, the system now falls back to using `nonBookingQuery` to construct the query. This prevents potential issues where a booking-related report might not have a dedicated custom query fragment, ensuring a valid query is always built. Minor `console.log` statements were also added for debugging purposes.

**Timestamps of Significant Changes:**

*   **December 3, 2025, 12:06 PM - 12:15 PM**: Initial implementation and minor revisions to booking-related CRUD operations in `booking.controller.ts`.
*   **December 3, 2025, 2:04 PM - 3:44 PM**: Initial implementation and minor revisions to HBL master booking CRUD operations in `hblEntry.controller.ts`.
*   **December 3, 2025, 2:36 PM**: Definition of API routes for HBL entry in `hblEntry.route.ts`.
*   **December 4, 2025, 11:59 AM**: Introduction of `bookingQueryBuilder` in `booking.query.ts` for analytics.
*   **December 4, 2025, 12:02 PM**: Introduction of `getTableDataReports` in `others.controller.ts` for orchestrating analytics.
*   **December 4, 2025, 3:39 PM**: Introduction of `export.query.ts` containing SQL query fragments for analytics exports.
*   **December 5, 2025, 10:52 AM**: Initial implementation of `getExportData` for analytics export in `core.export.controller.ts`, including data transformation for port names.
*   **December 5, 2025, 11:53 AM**: Key logic enhancement in `getExportData` (in `core.export.controller.ts`) to handle cases where `bookingQuery` might return an empty query, falling back to `nonBookingQuery`.

**Patterns and Recurring Elements:**

*   **Database Operations**: A strong emphasis on database interaction is evident across all controller files, with frequent use of `insertMany`, `insertQuery`, `query`, and `updateQuery`. Transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) are used for multi-step operations.
*   **Input Sanitization**: Functions like `sanitizeString` and `sanitizeIntString`, along with `AppDateFormate`, are consistently applied to request body data before database insertion or query construction, indicating a focus on security and data type enforcement.
*   **Audit Logging**: The `insertAudit` and `simpleAudit` modules are used to track changes, especially in `hblEntry.controller.ts`, highlighting an auditing requirement for critical data modifications.
*   **Role-Based Access/Configuration**: The `locationByRole` variable, derived from `req.user.role`, indicates role-based logic for determining company/location context.
*   **Analytics Report Generation**: A clear pattern emerges in the analytics controllers and query builders:
    *   Centralized dispatch based on report `type`.
    *   Dynamic SQL query construction (`bookingQueryBuilder`, `bookingQuery`, `nonBookingQuery`) using interpolated string literals with parameters like `CompanyName`, `fromDate`, `toDate`.
    *   Common date column references (`bookingdate`, `t49_vessel_actualdeparted_date`, `departure_date`).
    *   Categorization logic for charts (e.g., time differences grouped into "Less than 1 week", "1 - 2 weeks").
    *   Post-processing of exported data includes date filtering (`dateFilterOnExport`) and specific value replacements (e.g., "LONG BEACH" to "LOS ANGELES").
*   **Repetitive Log Entries**: Many log entries for `booking.controller.ts`, `hblEntry.controller.ts`, `booking.query.ts`, and `export.query.ts` show identical code, suggesting either no functional changes during those timestamps or minor non-substantive changes (like whitespace) not captured in the diff. This is a recurring pattern in the log.

## 12:00:00 PM
The changes primarily focus on refining and extending the House Bill of Lading (HBL) forms and their associated data management within a React application.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblPoForm.jsx`**
    *   **Early Changes (12/3/2025, 12:25 PM - 1:01 PM):** The component was initially named `PODetailsExtend`, then quickly renamed to `HblPODetails`. Its prop `formik` was changed to `values`, and subsequently, `formik={values}` was passed to its sub-components (`BasicPoExtend`, `LinkPoExtend`).
    *   **Later Changes (12/3/2025, 3:23 PM - 3:49 PM):** The component `BasicPoExtend` was replaced with `BasicPoForHbl`. A significant functional change occurred in the `useEffect` hook, where the logic for setting the `tabValue` (either "Basic PO" or "Linked PO") was altered. Instead of checking `values.client_name`, it now checks `values.basicPoList?.[0]?.customer` to determine if the client is 'SP RICHARDS COMPANY', suggesting a shift in data structure for determining default tab selection.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
    *   **Initial Development (12/3/2025, 12:26 PM):** This file introduced the main HBL form, utilizing `Formik` for form management, `Redux` for state, and `RTK Query` for API interactions (save/update). It incorporates various sub-forms like `HblContainerDetailsForm`, `HblRoutingForm`, `HblHeaderForms`, and `HblPODetails`. Keyboard shortcuts were implemented for common actions.
    *   **Form Initialization Logic (12/3/2025, 1:38 PM - 1:55 PM):** Multiple iterative changes were made to the `initialValues` prop of the `Formik` component, specifically for `agent_booking_id` and `booking_no`. These revisions aimed to refine how these fields are populated based on the `formAction` (e.g., "copy", "add", "edit") and available data from `initialValues` or `location.state`. There was a brief, quickly reverted change to `enableReinitialize` behavior.
    *   **Data Fetching and Integration (12/3/2025, 2:37 PM - 4:56 PM):** The component integrated `useFetchPoFormDetailsQuery` to retrieve Purchase Order (PO) details, which are then used to pre-populate the `basicPoList` in `initialValues`. The logic for initializing `basicPoList` evolved, prioritizing fetched `poDetails.data.basicPoList` over `initialValues.basicPoList` with careful handling for empty arrays. Later, `linkedPoList` was also added to `initialValues`, sourced from `poDetails.data.linkedPoList`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form\sub-components\BasicPoExtend.jsx`**
    *   **Change (12/3/2025, 3:24 PM):** The component's main prop was renamed from `values` to `formik` to align with the changes in `HblPoForm.jsx`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
    *   **Functional Change (12/3/2025, 1:54 PM):** The "Add HBL" button's functionality was updated to navigate to the `hbl_form` with a `formAction` of "add" instead of "copy". This means new HBLs will start with a blank form, rather than being pre-populated from an existing one.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblHeaderForms.jsx`**
    *   **Minor Fix (12/3/2025, 1:51 PM):** A minor correction was made to ensure the correct `onChange` handler was used for the "Agent Booking #" input box.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
    *   **New API Endpoint (12/3/2025, 2:38 PM):** A new RTK Query endpoint, `fetchPoFormDetails`, was added to fetch PO details specifically for HBL entries, demonstrating an expansion of the API to support the new HBL form requirements.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\BasicPoForHbl.jsx`**
    *   **New File & Refactor (12/3/2025, 3:25 PM - 3:37 PM):** This file was created, likely as a specialized version of `BasicPoExtend.jsx`. All Redux-based logic for `addRow`, `deleteRow`, and `updateRow` was removed, and corresponding UI elements (add/delete buttons) were also removed or commented out. The component was refactored to render its data directly from `formik?.basicPoList`, making it a read-only display component for Basic PO details within the HBL context. Layout adjustments for grid items were also applied.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form_extend\CargoFormExtend.jsx`**
    *   **Consistent State (12/3/2025, 4:58 PM - 12/5/2025, 11:47 AM):** This component was introduced to manage cargo lists, including adding, editing, and deleting items via a modal. While many timestamps appear for this file, the code content remains largely unchanged across these entries, suggesting frequent saves or minor, unrecorded adjustments.

**Timestamps of Significant Changes:**

*   **12/3/2025, 12:26 PM:** Initial setup of core HBL form components and renaming.
*   **12/3/2025, 2:38 PM:** Introduction of a new API endpoint (`fetchPoFormDetails`) to support HBL PO data.
*   **12/3/2025, 2:42 PM:** Integration of fetched PO data into the HBL form's initial values.
*   **12/3/2025, 3:25 PM - 3:37 PM:** Significant refactoring and specialization of the `BasicPoForHbl` component, transforming it into a read-only display.
*   **12/3/2025, 3:49 PM:** Update in `HblPoForm.jsx` to dynamically switch tabs based on a specific customer in the `basicPoList`.
*   **12/3/2025, 4:56 PM:** Addition of `linkedPoList` to the HBL form's initial values.

**Patterns and Recurring Elements:**

*   **Debugging with `console.log`:** Numerous `console.log` statements with varying string messages (e.g., "values===90", "locatioppppp", "values===890") are frequently added and modified across `HBLform.jsx` and `HblPoForm.jsx`, indicating active and ongoing debugging during development.
*   **Iterative Refinement of `initialValues`:** The `HBLform.jsx` file shows a strong pattern of repeatedly adjusting the logic for setting `initialValues` within the `Formik` component, especially for booking IDs and list data. This highlights a complex requirement for dynamic form pre-population based on context (e.g., 'copy' vs. 'add' forms, or fetched data).
*   **Component Specialization:** The creation of `BasicPoForHbl.jsx` from `BasicPoExtend.jsx` demonstrates a pattern of creating specialized components for specific contexts (HBL in this case), often involving the removal of generic functionality (like add/delete rows) to adapt to new requirements (e.g., read-only display).
*   **Redux Toolkit Query Integration:** The use of `createApi`, `builder.mutation`, and `builder.query` in `agentBookingApi.js` and their consumption via hooks like `useSaveHblBookingMutation`, `useUpdateHblBookingMutation`, `useFetchPoFormDetailsQuery` is a recurring pattern for data fetching and mutation.
*   **Timestamp Clustering:** The vast majority of changes occurred on "12/3/2025", suggesting a focused development effort on these HBL-related features within a single day. Minor follow-up changes for `CargoFormExtend.jsx` spilled into "12/4/2025" and "12/5/2025", but with no functional changes within that component.