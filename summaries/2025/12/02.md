# Activity Summary for 12/2/2025

## 10:16:13 AM
The provided log primarily details changes across three files in a `t360-backend` project: `hblEntry.controller.ts`, `auditConfig.ts`, and `audit.controller.ts`. The changes span from `12/1/2025, 11:50:49 AM` to `12/1/2025, 3:45:25 PM`.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`** (Numerous changes from 11:50:49 AM to 3:45:25 PM):
    *   **Initial State (11:50:49 AM - 11:56:46 AM):** The `updateHblMasterBooking` function was initially structured to use a `bookingInsertQuery` object with `updateQuery` for updating the `hbl_master` table. It also contained commented-out SQL query string for updating `hbl_master`, suggesting an alternative or older implementation.
    *   **Refactoring and Expansion (11:58:52 AM):** The `updateHblMasterBooking` function underwent significant refactoring.
        *   The `bookingInsertQuery` object was renamed to `hblMasterPayload` for clarity.
        *   The update logic for `hbl_master` was changed from using the generic `updateQuery` helper to a direct, parameterized SQL `UPDATE` statement (`updateMasterQuery`). This direct SQL statement updates a comprehensive list of 41 columns in the `hbl_master` table.
        *   New update logic was introduced for `agent_booking_vessel` and `agent_booking_hbl` tables using direct SQL `UPDATE` statements, specifying `hbl_master_id` as the condition.
        *   Crucially, a pattern of "DELETE & INSERT" was introduced for associated lists: `Routing List` (`agent_booking_routing`), `Container List` (`agent_booking_container`), and `Basic PO List` (`agent_booking_po`). This involves first deleting all entries related to the `hbl_master_id` from these tables, then re-inserting new data if provided in the `payload`. This indicates a strategy to fully replace associated child records on update rather than attempting individual updates.
    *   **Minor Adjustments (1:20:16 PM - 1:26:16 PM):** Small corrections in comments or minor code formatting (e.g., in `res.status(400).json(...)`) were observed, but no functional changes to the core update logic.
    *   **HBL Details Update Expansion (1:27:58 PM):** The `UPDATE agent_booking_hbl` query was extended to include `hbldate` as a parameter.
    *   **Audit Integration (2:30:17 PM - 3:45:25 PM):** This is a significant functional change across multiple commits.
        *   The `simpleAudit` function was imported from `../modules/AuditModule` and initially used in `createHblMasterBooking` for "HBL log created" events.
        *   Later, `insertAudit` was also imported.
        *   The `updateHblMasterBooking` function started integrating the `insertAudit` function to log changes. Initially, it used `payload.booking_id` as `primaryKey` for `hbl_master` audit but later corrected it to `payload.agent_booking_id` and then to `hbl_master_id`.
        *   A more refined audit logic was introduced at `3:25:19 PM` for `updateHblMasterBooking`:
            *   It imports `auditConfigObj` from `../config/auditConfig`.
            *   It dynamically filters the `payload` to include only keys defined in `auditConfigObj["hbl_master"].columns` before calling `insertAudit`. This ensures that only relevant `hbl_master` fields are audited, preventing extraneous data from being logged for the master record.
            *   The `primaryColumn` for `insertAudit` on `hbl_master` was consistently set to `agent_booking_id`.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\config\auditConfig.ts`** (Multiple changes from 2:28:04 PM to 3:27:34 PM):
    *   **New Audit Configuration for `hbl_master`:** A new entry was added to the `auditConfigObj` for a table named `hbl_master`.
    *   This configuration defines `relationColumn: "agent_booking_id"` and `auditTable: "hbl_audit_log"`.
    *   It lists 43 columns for `hbl_master` (including details for Shipper, Consignee, Notify Party, origin/destination points, etc.), specifying their `key` and `label` for auditing purposes. This suggests that `hbl_master` is a central table with extensive fields requiring detailed auditing.
    *   No structural changes to the `AuditCofigObjectType` or `AudityConfigType` interfaces.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\types\audit.types.ts`** (Single change at 2:28:34 PM):
    *   **Added `HBL` Audit Query Type:** The `AuditQueryType` enum was updated to include a new type `HBL`, indicating support for auditing HBL-related activities.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\audit.controller.ts`** (Single change at 2:28:47 PM):
    *   **Added `HBL` Case to `getAll` Audit Function:** A new `else if` condition was added to the `getAll` function to handle the `AuditQueryType.HBL`. When this type is requested, it sets `tableName` to `"hbl_audit_log"` and `refColumn` to `"agent_booking_id"`, allowing audit logs for HBLs to be retrieved.

### Patterns and Recurring Elements:

*   **Database Transaction Management:** Both `createHblMasterBooking` and `updateHblMasterBooking` consistently use `await query('BEGIN')` and `await query('COMMIT')` (or `await query('ROLLBACK')` in case of error), indicating robust transaction handling for multi-step database operations.
*   **Data Sanitization:** The `sanitizeString` utility is heavily used in `createHblMasterBooking` for almost all incoming `req.body` fields, suggesting a focus on preventing SQL injection or other data integrity issues.
*   **Date Formatting:** The `AppDateFormate` utility with `db_format` ('YYYY-MM-DD') is used for all date fields (`eta`, `hbldate`, `booking_date`, `etd`, `eta` in routing, `podate`), ensuring consistent date storage.
*   **Composite Updates/Inserts:** For nested data structures like `routingList`, `containerList`, and `basicPoList`, the strategy is to delete existing records associated with the `hbl_master_id` and then insert new ones using `insertMany`. This simplifies updates for one-to-many relationships.
*   **Error Handling:** Both `createHblMasterBooking` and `updateHblMasterBooking` include `try-catch` blocks, rolling back transactions on error and logging the error using `logger.error`. They also throw `HttpError` instances for specific failures.
*   **Audit Logging Implementation:** A clear pattern emerges for implementing audit logs:
    *   Defining audit configuration in `auditConfig.ts` with `relationColumn`, `auditTable`, and `columns` (key-label pairs).
    *   Adding new `AuditQueryType` in `audit.types.ts`.
    *   Extending the `audit.controller.ts` to handle the new audit type and retrieve logs from the specified `auditTable`.
    *   Integrating `simpleAudit` (for simple log messages) and `insertAudit` (for detailed old/new data comparison) into the controller functions (`createHblMasterBooking` and `updateHblMasterBooking`).
    *   For `update` operations, explicitly filtering the `newData` payload based on `auditConfigObj` to only log changes relevant to the main table, preventing accidental logging of child array data in the master table's audit log.

## 10:16:43 AM
No summary generated from AI

## 11:16:31 AM
The log primarily details changes within the backend's HBL (House Bill of Lading) entry and auditing functionalities.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial State & Refactor (12/1/2025, 11:50:49 AM - 11:58:52 AM)**: The `createHblMasterBooking` function remained stable, handling the insertion of HBL data and associated records (vessel, HBL details, routing, containers, POs) across multiple database tables within a transaction. The `updateHblMasterBooking` function underwent a major refactor. It initially used a generic `updateQuery` with commented-out direct SQL. By 11:58:52 AM, it evolved to use a structured payload for `hbl_master` updates and implemented a "delete then insert" strategy for updating associated lists like `agent_booking_routing` and `agent_booking_container`.
    *   **Regression & Incremental Fixes (12/1/2025, 1:20:16 PM - 2:12:58 PM)**: A temporary regression occurred at 1:20:16 PM, reverting parts of the `updateHblMasterBooking`'s structured update logic. Subsequent changes incrementally refined the direct SQL `UPDATE` statements to include more fields like `marks`, `bookingdate`, and `hbldate` for `hbl_master` and `agent_booking_hbl`. A notable regression related to mapping `agent_booking_id` in `routingList` was introduced around 2:12:15 PM, appearing after an earlier fix.
    *   **Auditing Integration (12/1/2025, 2:30:17 PM - 3:24:07 PM)**: This period saw a significant focus on integrating audit logging.
        *   `simpleAudit` was introduced in `createHblMasterBooking` to log new HBL entries.
        *   `insertAudit` was introduced in `updateHblMasterBooking` for recording updates. Its placement within the function and the parameters used for its `primaryKey` (`payload.booking_id`, `payload.agent_booking_id`, `hbl_master_id`) were iteratively adjusted.
        *   The final major change at 3:24:07 PM refined the `insertAudit` call by importing `auditConfigObj` and using it to filter the `payload`, ensuring that only fields explicitly configured for `hbl_master` in the audit configuration are logged during updates.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\types\audit.types.ts`**:
    *   **New Audit Type (12/1/2025, 2:28:34 PM)**: The `AuditQueryType` enum was updated to include a new value, `HBL = 'HBL'`, enabling specific audit logging for House Bill of Lading records.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\audit.controller.ts`**:
    *   **HBL Audit Retrieval (12/1/2025, 2:28:47 PM)**: Logic was added to the `getAll` function to handle requests for `AuditQueryType.HBL`. It now directs these requests to the `"hbl_audit_log"` table, using `"agent_booking_id"` as the primary reference column for retrieving audit records.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\config\auditConfig.ts`**:
    *   **Consistent Structure (12/1/2025, 2:28:04 PM - 3:26:40 PM)**: This file consistently defines audit configurations for various master tables (vendor, destination, expense code, terminal details, agent booking entry). Each configuration specifies the `relationColumn`, `auditTable`, and a list of `columns` to be tracked.
    *   **Noteworthy Absence**: Although the `hblEntry.controller.ts` file attempts to use `auditConfigObj["hbl_master"]` for filtering audit data, the provided log entries for `auditConfig.ts` do not explicitly show the definition of a `hbl_master` configuration within `auditConfigObj`.

**Timestamps of significant changes:**

*   **12/1/2025, 11:58:52 AM**: Refactor of `updateHblMasterBooking` to introduce a multi-table update strategy including "delete then insert" for related lists.
*   **12/1/2025, 1:20:16 PM**: A brief, likely unintended, reversion in the `updateHblMasterBooking`'s update method for `hbl_master`.
*   **12/1/2025, 2:28:34 PM**: Addition of `HBL` to `AuditQueryType` enum.
*   **12/1/2025, 2:28:47 PM**: Implementation of HBL audit log retrieval logic.
*   **12/1/2025, 2:30:17 PM**: Initial integration of `simpleAudit` for HBL creation.
*   **12/1/2025, 2:51:38 PM**: Introduction of `insertAudit` for HBL updates.
*   **12/1/2025, 3:24:07 PM**: Refinement of `insertAudit` in `updateHblMasterBooking` to use a configurable approach for filtering audit data based on `auditConfigObj`.

**Patterns or recurring elements:**

*   **Transactional Integrity**: Both create and update operations consistently wrap their database interactions within `BEGIN`, `COMMIT`, and `ROLLBACK` commands, ensuring data consistency.
*   **Data Validation and Formatting**: Input data is consistently sanitized using `sanitizeString()` and date fields are formatted using `AppDateFormate()` (to `YYYY-MM-DD`), indicating a focus on data quality and security.
*   **Modular Update Strategy**: Updates to complex entities often involve updating a primary master record and then managing associated child records (e.g., routing, containers) using a "delete all existing then insert new" pattern.
*   **Progressive Auditing**: Audit logging was implemented in an iterative fashion, starting with basic logging for creation, then expanding to updates, and finally refining the update audit to be configuration-driven and field-specific.
*   **Debugging Practices**: Frequent `console.log` statements are present throughout the code, indicating active debugging during development stages.

## 11:16:50 AM
The provided log details significant development work focused on enhancing House Bill of Lading (HBL) functionality within the T360 API frontend application.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js` (Timestamp: 12/1/2025, 11:47:38 AM):**
    *   Introduced a suite of new API endpoints for HBL management, including `saveHblBooking`, `fetchHblBookingFormDetails`, `updateHblBooking`, and `deleteHblBooking`.
    *   Added new `tagTypes` for `HBL` and `FormDetails` to facilitate caching and invalidation with Redux Toolkit Query.
    *   Expanded `export` statements to include new HBL-related mutations and queries.
    *   Also added `updateCarrierBooking`, `updateDo`, and `exportSprReport` endpoints, indicating broader booking management enhancements.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblRoutingForm.jsx` (First change: 12/1/2025, 1:32:15 PM):**
    *   This component was introduced to manage HBL routing details. It uses Material-UI Accordions, an `AppTable` for display, and `ThemedModal` with `AddRoutingDetailForm` for data entry.
    *   It integrates with a Redux slice (`hblEntryFormSlice`) to manage the `routingList` (add, update, remove items).
    *   Multiple small changes between 1:49 PM and 2:03 PM involved refining the `handleSubmitRouting` logic, particularly how data is merged and `slno` (serial number) is handled during updates, and adding/removing debug `console.log` statements.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form\sub-components\AddRoutingDetailForm.jsx` (First change: 12/1/2025, 1:44:41 PM):**
    *   This sub-component was introduced to handle the form for adding or editing individual HBL routing details.
    *   It utilizes `formik` for form state and validation, along with `SelectBox`, `AppAutocomplete` (for origin/destination), and `AppDatePicker` components.
    *   Throughout the log (between 1:44 PM and 2:03 PM), this file saw numerous iterative changes including:
        *   Temporarily commenting out and then re-enabling `AppAutocomplete` fields.
        *   Adding `enableReinitialize: true` to `formik` for better edit form behavior, then reverting it.
        *   Refactoring the `onSubmit` prop to `onSubmitData` and then reverting it back to `onSubmit`.
        *   Frequent additions and removals of debug `console.log` statements and minor style property adjustments (`Fsx`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblEntryFormScreen.jsx` (First change: 12/1/2025, 2:04:52 PM):**
    *   This is a core component for the HBL entry form, responsible for overall data flow.
    *   It fetches HBL details using `useFetchHblBookingFormDetailsQuery` and initializes Redux lists (`containers`, `routing`, `po`) based on the fetched data.
    *   Manages various modals for adding master forms and handling HBL party screens, including export/import functionalities.
    *   Changes between 2:06 PM and 2:09 PM involved briefly adding an "HBL Audit" button to the toolbar, then removing it. Later, an import for `HblListDetails` was removed (3:39:57 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js` (Timestamp: 12/1/2025, 2:08:41 PM):**
    *   Expanded column definitions to include `HBL_ROUTING_DETAILS_COULMN` and `HBL_COLUMNS`, crucial for displaying HBL data in tables across the application.
    *   Minor adjustments to existing booking and cargo column definitions.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx` (First change: 12/1/2025, 2:10:18 PM):**
    *   This component was introduced to display a list of HBLs, using `ThemedGrid` and `HBL_COLUMNS`.
    *   It integrates with `useGetHblDashboardQuery` for data fetching and `useDeleteHblBookingMutation` for deletion functionality.
    *   An "Add HBL" button navigates users to the HBL form.
    *   A significant update around 2:22 PM introduced a `ReusableRightDrawer` for an "HBL Audit" feature, passing `agent_booking_id` as data and configuring the drawer for "HBL" table data. Unused dummy data and imports were cleaned up later (3:40 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx` (First change: 12/1/2025, 3:07:07 PM):**
    *   This represents the main HBL form component, handling creation and updates.
    *   It uses `Formik` with `HBLvalidationSchema`, aggregates data from Redux state (routing, containers, POs), and makes API calls using `useSaveHblBookingMutation` or `useUpdateHblBookingMutation`.
    *   The form is structured with `ThemeTabs` to display various sub-forms like header details, parties (Shipper, Consignee, Notify), container details, routing, and basic POs.
    *   Includes keyboard shortcuts for common party-related actions (Edit, View, Add New).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js` (Timestamp: 12/1/2025, 3:38:43 PM):**
    *   Refactored `getBookingActions` to use more modular, reusable action definitions.
    *   Introduced a dedicated `getHblActions` function for HBL-specific actions (e.g., "Edit HBL").
    *   Updated `createHblAction` to navigate to `hbl_form_screen` for adding new HBLs.

**Timestamps of Significant Changes:**

*   **12/1/2025, 11:47:38 AM:** Major API endpoint additions for HBL management.
*   **12/1/2025, 1:32:15 PM:** Initial implementation of `HblRoutingForm`.
*   **12/1/2025, 1:44:41 PM:** Initial implementation of `AddRoutingDetailForm`.
*   **12/1/2025, 2:04:52 PM:** Initial implementation of `HblEntryFormScreen`, setting up the main HBL form flow.
*   **12/1/2025, 2:08:41 PM:** Introduction of HBL-specific column definitions.
*   **12/1/2025, 2:10:18 PM:** Initial implementation of `HBLListDetails` for HBL listing and management.
*   **12/1/2025, 2:22:47 PM:** Addition of the `ReusableRightDrawer` for HBL Audit in `HBLListDetails`.
*   **12/1/2025, 3:07:07 PM:** Initial implementation of `HBLForm`, the central component for HBL data entry.
*   **12/1/2025, 3:38:43 PM:** Refactoring of booking actions to support HBL.

**Patterns and Recurring Elements:**

*   **HBL Feature Focus:** The entire log reflects a dedicated effort to build out and integrate comprehensive House Bill of Lading (HBL) functionality within the booking system. This includes backend API updates, frontend forms, lists, and state management.
*   **Redux Toolkit Query (RTK Query):** This library is consistently used for handling all API interactions (fetching data and making changes) across multiple components. The `providesTags` and `invalidatesTags` mechanisms are actively utilized for efficient data caching.
*   **Formik for Form Handling:** `formik` is the chosen library for managing complex form states, initial values, validation schemas, and submission logic in both `AddRoutingDetailForm` and `HBLForm`.
*   **Material-UI for UI Components:** The project heavily relies on Material-UI components for its user interface, ensuring a consistent look and feel (e.g., `Grid`, `Accordion`, `Card`, `Stack`, `ThemedModal`, custom buttons).
*   **Redux for Global State Management:** Beyond RTK Query, Redux slices (`hblEntryFormSlice`, `agentBookingSlice`, `PartySlice`) are used to manage local component-specific states that need to be shared or persisted across different parts of the HBL form.
*   **Iterative Development and Debugging:** The frequent addition, removal, and correction of `console.log` statements, along with several instances of changes being reverted and then refined, indicate a rapid, iterative development and debugging process.
*   **Modular Component Design:** The HBL feature is broken down into several specialized components (`HblHeaderForms`, `ShipperForm`, `ConsigneeFormForHbl`, `NotifyPartyForm`, `HblContainerDetailsForm`, `HblRoutingForm`, `BasicPoForm`), which are then integrated into larger screens using tabs or modals.

## 12:16:57 PM
The log details a series of iterative changes focused on developing and refining the House Bill of Lading (HBL) functionality within the T360 booking system. These changes span API integration, HBL form components (specifically routing details), and the HBL list display.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js` (12/1/2025, 11:47:38 AM):**
    *   This file saw a significant expansion, integrating comprehensive HBL management into the Redux Toolkit Query API.
    *   New API endpoints were added for `saveHblBooking`, `fetchHblBookingFormDetails`, `updateHblBooking`, `deleteHblBooking`, and `getHblDashboard`.
    *   Additional endpoints for `updateCarrierBooking`, `updateDo`, and `exportSprReport` were also introduced.
    *   New `tagTypes` for `HBL` and `FormDetails` were added to manage cache invalidation and data refetching.
    *   Corresponding React hooks (`useSaveHblBookingMutation`, `useFetchHblBookingFormDetailsQuery`, etc.) were exported.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblRoutingForm.jsx` (Multiple timestamps from 12/1/2025, 1:32:15 PM to 12/2/2025, 11:57:28 AM):**
    *   This component, responsible for displaying and managing routing details within an HBL, underwent frequent refinements.
    *   Initial implementation included an Accordion to show routing details, an `AppTable` to list them, and a `ThemedModal` to house the `AddRoutingDetailForm`.
    *   Redux actions (`addList`, `updateList`, `removeList`) from `hblEntryFormSlice` are dispatched for adding, editing, and deleting routing entries.
    *   The logic for `handleSubmitRouting` (adding/updating items to the Redux store) was repeatedly adjusted, particularly concerning how `slno` (serial number) is handled during updates and additions. It toggled between explicitly merging `modal.data` for updates and relying on the reducer for `slno` generation for new entries, or manually assigning `slno` based on list length.
    *   Debugging `console.log` statements were added and removed at various points to inspect `routingList` and submission data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\form\sub-components\AddRoutingDetailForm.jsx` (Multiple timestamps from 12/1/2025, 1:44:41 PM to 12/2/2025, 11:58:43 AM):**
    *   This form, used within `HblRoutingForm`'s modal for adding/editing routing details, also saw many iterations.
    *   It uses Formik for state management and various Material-UI-based custom components (`SelectBox`, `AppAutocomplete`, `AppDatePicker`).
    *   Early changes involved commenting/uncommenting `AppAutocomplete` fields and minor styling adjustments.
    *   A key update (12/1/2025, 1:48:09 PM) introduced `enableReinitialize: true` to Formik, improving its behavior in "edit" mode.
    *   The `onSubmit` prop's name changed briefly to `onSubmitData` and then reverted (12/1/2025, 2:00:44 PM - 2:03:53 PM).
    *   Significant improvements to form validation were made (12/2/2025, 11:28:53 AM), introducing a specific `routingValidationSchema` using Yup and enhancing Formik's error display (`formik.touched`) and blur handling (`setFieldTouched`).
    *   Subsequent changes (12/2/2025, 11:34:06 AM) simplified the validation schema by commenting out `transport_mode`, `pol`, and `pod` as required fields.
    *   The method of form submission was repeatedly altered: toggling between using a native `<form onSubmit={formik.handleSubmit}>` with `type="submit"` buttons and handling submission purely via a button `onClick` event, ultimately settling on a `div` wrapper with a `ThemeButton` handling `onClick={handleFormSubmit}` (12/2/2025, 11:58:43 AM). This suggests complexities with form submission within modal or accordion structures.
    *   Event propagation stops were briefly added (12/2/2025, 11:56:51 AM) and then removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblEntryFormScreen.jsx` (Multiple timestamps from 12/1/2025, 2:04:52 PM to 12/2/2025, 12:10:27 PM):**
    *   This is the main screen for HBL form entry. It handles overall state, data loading, and modal interactions for HBL creation/editing.
    *   It fetches HBL details using `useFetchHblBookingFormDetailsQuery`, dispatching initial lists (containers, routing, PO) to Redux on success.
    *   Initial UI changes included adding and removing an "HBL Audit" button in the `ScreenToolbar`.
    *   The logic for conditionally fetching HBL details based on `isEdit` and `state?.serial_id` was refined, specifically alternating between `null` and `skipToken` for non-edit scenarios, and briefly containing a syntax error.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js` (Multiple timestamps from 12/1/2025, 2:08:41 PM to 12/2/2025, 11:49:59 AM):**
    *   This file defines column configurations for various data grids.
    *   It introduced `HBL_COLUMNS` for displaying HBL data.
    *   It also updated `BOOKING_CARGO_COLUMN` to include `displayFormat` utility calls for consistent number formatting (e.g., quantity, dimensions, weight, CBM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx` (Multiple timestamps from 12/1/2025, 2:10:18 PM to 12/2/2025, 11:47:57 AM):**
    *   This new component displays a list/dashboard of HBLs associated with a booking.
    *   It fetches data using `useGetHblDashboardQuery` and allows HBL deletion via `useDeleteHblBookingMutation`.
    *   Navigation to the HBL entry form for adding/editing is implemented.
    *   A new `ReusableRightDrawer` component was integrated (12/1/2025, 2:22:47 PM) for displaying "HBL Audit" details, with several adjustments to the data passed to the drawer (from `data.serial_id` to `location.state.agent_booking_id`) and the `table` prop (`"ISF"` to `"HBL"`).
    *   Pagination logic was integrated using Redux state from `PartySlice` (12/2/2025, 11:47:57 AM).
    *   Imports for `GridActions`, `getHblActions`, and `DirectionsBoatFilledOutlined` were removed, streamlining dependencies.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx` (Multiple timestamps from 12/1/2025, 3:07:07 PM to 12/2/2025, 11:56:27 AM):**
    *   This large component represents the core HBL creation/edit form.
    *   It leverages `useSaveHblBookingMutation` and `useUpdateHblBookingMutation` to interact with the API.
    *   Includes `ThemeTabs` to navigate between different sections (Parties, Container, Routing, PO).
    *   Integrates with Redux for managing sub-lists (`routingList`, `containerList`, `basicPoList`) and party selection state.
    *   Features extensive initial value mapping, data transformation (`recoverValue` for parsing `~` separated strings), and `HBLvalidationSchema`.
    *   Keyboard shortcuts (`ctrl+u`, `ctrl+d`, `ctrl+a`, `ctrl+s`, `ctrl+p`) were implemented for efficiency.
    *   The `handleSave` function constructs a complex payload, calls the appropriate API mutation, and handles success/error feedback via `toast` and `setAlertConfig`.
    *   The `agent_booking_id` assignment in the payload was refined to prioritize `values.booking_id`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js` (Multiple timestamps from 12/1/2025, 3:38:43 PM to 12/1/2025, 3:39:03 PM):**
    *   This file, defining actions for booking dashboards, underwent refactoring.
    *   `getBookingActions` was restructured to use reusable action arrays for better organization.
    *   A new `createHblAction` was added to navigate to the HBL form screen.
    *   A separate `getHblActions` was introduced specifically for HBL-related actions, initially including an "Edit HBL" option.
    *   The `hblAction` array within `getBookingActions` was later commented out, indicating a shift towards dedicated HBL action functions.

**Timestamps of Significant Changes:**

*   **12/1/2025, 11:47:38 AM:** Major API expansion for HBL functionality.
*   **12/1/2025, 1:32:15 PM:** Initial creation of `HblRoutingForm`.
*   **12/1/2025, 1:48:09 PM:** `AddRoutingDetailForm` gains `enableReinitialize: true` and refines `options` reducer.
*   **12/1/2025, 1:54:31 PM:** `HblRoutingForm` refines `handleSubmitRouting` logic for robust updates.
*   **12/1/2025, 2:04:52 PM:** Initial creation of `HblEntryFormScreen`.
*   **12/1/2025, 2:10:18 PM:** Initial creation of `HBLListDetails`.
*   **12/1/2025, 2:22:47 PM:** `HBLListDetails` integrates `ReusableRightDrawer` for HBL Audit.
*   **12/1/2025, 2:25:07 PM:** `HBLListDetails` corrects `ReusableRightDrawer`'s `table` prop to "HBL".
*   **12/1/2025, 3:07:07 PM:** Initial creation of `HBLform.jsx` (the main HBL form).
*   **12/1/2025, 3:38:43 PM:** `actions.js` refactors booking actions and introduces `getHblActions`.
*   **12/2/2025, 11:28:53 AM:** `AddRoutingDetailForm` significantly improves validation with Yup and Formik.
*   **12/2/2025, 11:47:57 AM:** `HBLListDetails` integrates pagination with Redux.
*   **12/2/2025, 11:48:40 AM:** `agent.booking.js` adds display formatting to cargo columns.
*   **12/2/2025, 11:58:43 AM:** `AddRoutingDetailForm` shifts from native form element to `div` with button `onClick` for submission.

**Patterns and Recurring Elements:**

*   **HBL Feature Development:** The overwhelming majority of changes revolve around the implementation and refinement of House Bill of Lading (HBL) functionality, including forms, lists, API endpoints, and associated UI/UX.
*   **Redux Integration:** Heavy reliance on Redux (specifically `hblEntryFormSlice` for local form lists and `agentBookingApi` for API calls) for state management across different HBL-related components. `useDispatch` and `useSelector` are frequently used.
*   **Formik and Yup:** Consistent use of Formik for form state management and Yup for validation, with iterative improvements to validation schemas and form submission handling in `AddRoutingDetailForm` and `HBLform`.
*   **Material-UI Components:** Regular use of Material-UI components (Accordion, Box, IconButton, Typography, Stack, Card, Grid) and custom common components (AppTable, ThemedModal, OutlinedButton, ThemeButton, AppDatePicker, SelectBox, AppAutocomplete, ScreenToolbar, ThemedBreadcrumb, ReusableRightDrawer).
*   **Iterative Refinement & Debugging:** Many files show multiple rapid changes, often within minutes, including adding/removing `console.log` statements, tweaking submission logic, and adjusting UI elements. This indicates an active development cycle with frequent testing and minor adjustments.
*   **"Add" vs. "Edit" Logic:** Components like `AddRoutingDetailForm` and `HBLform` consistently implement conditional logic based on a `modal.type` or `formAction` prop to handle "add" and "edit" scenarios (e.g., initial values, button text, API mutation used).
*   **Data Transformation:** The `recoverValue` utility in `HBLform` points to a pattern of combining display names with codes using a `~` separator, which needs parsing before API submission.
*   **Audit Trail/Drawer:** The introduction of `ReusableRightDrawer` for an "HBL Audit" suggests a pattern of providing detailed logging or historical views for critical data entities.
*   **Pagination:** Integration of pagination logic in `HBLListDetails` shows a pattern of managing data display for potentially large datasets.

## 12:20:07 PM
The code changes log details significant updates across three files, primarily focusing on booking and auditing functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **12/1/2025, 11:50:49 AM**: Initial versions of `createHblMasterBooking` (for creating new House Bill of Lading master bookings) and `updateHblMasterBooking` were introduced. Both functions handle extensive data from the request body, sanitize inputs, and perform multiple database insertions or updates across `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables within a database transaction.
    *   **12/1/2025, 11:58:52 AM**: The `updateHblMasterBooking` function was significantly refactored. The previous generic `updateQuery` for `hbl_master` was replaced with a more explicit `updateQuery` using a dedicated payload. Furthermore, direct SQL `UPDATE` statements were introduced for `agent_booking_vessel` and `agent_booking_hbl`. For nested lists like `agent_booking_routing` and `agent_booking_container`, a "delete all existing, then insert all new" strategy was implemented.
    *   **12/1/2025, 1:20:16 PM - 1:27:58 PM**: The `updateHblMasterBooking` function saw several minor corrections to its `UPDATE` SQL queries. Specifically, the `hbl_master` update was reverted to use a long SQL string with positional parameters, and fields such as `bookingdate`, `marks`, and `hbldate` were progressively added to the `UPDATE` statements for `hbl_master` and `agent_booking_hbl` respectively, addressing initial omissions.
    *   **12/1/2025, 1:38:52 PM**: A correction ensured that when updating routing lists, `agent_booking_id` and `booking_id` within the `insertMany` function correctly referenced `payload.booking_id`.
    *   **12/1/2025, 2:30:17 PM**: Audit logging was introduced for the `createHblMasterBooking` function using `simpleAudit` to record the creation of HBL entries.
    *   **12/1/2025, 2:51:38 PM - 3:24:07 PM**: The `updateHblMasterBooking` function underwent iterative changes to its auditing logic. `insertAudit` was added, initially with varying primary keys and positions. It was then refined to include `auditConfigObj` for filtering the payload, ensuring that only relevant `hbl_master` fields defined in the audit configuration are logged during updates.
    *   **12/2/2025, 11:31:21 AM**: The `UPDATE hbl_master` query was updated to explicitly include the `customer` field (mapped from `payload.client_name`) as part of the update parameters.
    *   **12/2/2025, 11:31:29 AM**: Enhanced error logging was added to the `createHblMasterBooking` function's `catch` block for better debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\types\audit.types.ts`**:
    *   **12/1/2025, 2:28:34 PM**: A new entry, `HBL = 'HBL'`, was added to the `AuditQueryType` enum. This indicates the system is being prepared to support auditing specifically for HBL entities.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\audit.controller.ts`**:
    *   **12/1/2025, 2:28:47 PM**: The `getAll` function was updated to recognize the new `HBL` audit type. It now sets the `tableName` to `hbl_audit_log` and `refColumn` to `agent_booking_id` when an HBL audit is requested, enabling retrieval of HBL-specific audit trails.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\config\auditConfig.ts`**:
    *   **12/1/2025, 2:28:04 PM - 3:27:34 PM**: This file defines audit configurations for various database tables (e.g., `spr_vendor_master`, `spr_destination_master`, `agent_booking_entry`). While logged multiple times, the provided content shows no functional changes to the configurations themselves within these timestamps. The usage of `auditConfigObj` in `hblEntry.controller.ts` implies that a configuration for `hbl_master` exists or was implicitly introduced for filtering purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts`**:
    *   **12/2/2025, 11:36:59 AM**: A new controller file was added containing `saveBooking` and an incomplete `saveMaster` function.
        *   `saveBooking` handles both creating and updating general booking information, including cargo lists, vessel details, inventory, basic Purchase Orders (POs), and linked POs. It employs a "delete-then-insert" strategy for many of the associated lists and updates `remain_packs` in the `dso_order` table for linked POs.
        *   `saveMaster` is an introductory function designed for saving master data for different account types, with initial validation for `account_type`.

**Patterns and Recurring Elements:**

*   **Auditing System Development:** A prominent pattern is the incremental integration and refinement of an audit logging system across multiple files. This includes defining new audit types (`audit.types.ts`), enabling the audit controller to fetch these logs (`audit.controller.ts`), and adding explicit audit calls (`simpleAudit` for creation, `insertAudit` for updates) within the `hblEntry.controller.ts`. The refinement of `insertAudit` to filter payload data based on `auditConfigObj` demonstrates a focus on structured and relevant logging.
*   **Transactional Database Operations:** Database operations are consistently wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` statements, indicating a strong emphasis on data integrity.
*   **Data Validation and Sanitization:** Input data from `req.body` is routinely sanitized (`sanitizeString`, `sanitizeIntString`) and date-formatted (`AppDateFormate`), highlighting a concern for security and data consistency.
*   **Modular Approach for Related Data:** Complex data structures involving master records and associated lists (e.g., HBL master with routing, containers, POs; Booking with cargo, vessels, POs) are handled by a pattern of clearing old related data and inserting new data in bulk during updates.
*   **Debugging and Logging:** Frequent use of `console.log` and `logger.info`/`logger.error` throughout the development process indicates an active debugging and monitoring strategy.

## 1:16:17 PM
The log details changes across three files, primarily focusing on `hblEntry.controller.ts` with related updates to `auditConfig.ts` and `audit.types.ts`. The changes span from December 1st to December 2nd, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts` (12/1/2025, 11:50:49 AM - 12/2/2025, 12:30:33 PM)**
    *   **Initial Structure:** The file begins with `createHblMasterBooking` and `updateHblMasterBooking` functions.
    *   **`createHblMasterBooking` function:** This function handles the creation of HBL (House Bill of Lading) master bookings. It involves inserting data into multiple tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`) within a database transaction. A key feature is the extensive sanitization of input data using `sanitizeString` and `AppDateFormate`.
    *   **`updateHblMasterBooking` function:** This function handles updates to existing HBL master bookings.
        *   **Early versions (until 12/1/2025, 11:56:46 AM):** It uses a generic `updateQuery` for `hbl_master` and has commented-out SQL for direct updates, indicating an initial development phase or refactoring.
        *   **Significant Refactoring (12/1/2025, 11:58:52 AM):** The `updateHblMasterBooking` function undergoes a major overhaul. Instead of a single generic `updateQuery`, it is broken down into specific SQL `UPDATE` statements for `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. It also introduces `DELETE` followed by `insertMany` for `agent_booking_routing` and `agent_booking_container` to handle list updates (e.g., routing list, container list) by clearing existing entries and re-inserting new ones. The update to `agent_booking_hbl` initially missed updating `marks` and `hbldate`.
        *   **Refinements (12/1/2025, 1:22:23 PM - 12/1/2025, 1:26:16 PM):** The `updateHblMasterBooking` function is updated to include `marks` and `hbldate` in the `agent_booking_hbl` update SQL. It also adds `bookingdate` to the `hbl_master` update.
        *   **Audit Logging Integration (starting 12/1/2025, 2:30:17 PM):**
            *   Introduced `simpleAudit` in `createHblMasterBooking` to log HBL creation.
            *   Introduced `insertAudit` (initially with incorrect `primaryKey`) in `updateHblMasterBooking` to log changes to `hbl_master`.
            *   Refined `insertAudit` in `updateHblMasterBooking` to correctly use `hbl_master_id` as `primaryKey` and filter `newData` based on `auditConfigObj['hbl_master']` columns, ensuring only relevant fields are audited for `hbl_master`.
            *   Corrected the `primaryColumn` from `booking_id` to `agent_booking_id` for `insertAudit` in `updateHblMasterBooking` (12/1/2025, 3:29:23 PM, and later 12/2/2025, 11:30:40 AM).
        *   **Error Logging:** Consistent `logger.error(error)` calls are present in `catch` blocks for both `create` and `update` functions.
        *   **Transaction Management:** Both functions utilize `await query('BEGIN')` and `await query('COMMIT')` for transaction integrity, with `await query('ROLLBACK')` in case of errors.
        *   **`payload.client_name` to `customer` mapping:** The `updateHblMasterBooking` function was updated to include `payload.client_name` as the `$43` parameter for the `customer` column in the `hbl_master` update statement (12/2/2025, 11:30:40 AM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\config\auditConfig.ts` (12/1/2025, 2:28:04 PM - 12/1/2025, 3:27:34 PM)**
    *   This file defines the audit configuration for various database tables.
    *   **New Entry:** A significant change is the addition of `hbl_master` as a key in `auditConfigObj`, with its `relationColumn` set to `"agent_booking_id"` and `auditTable` to `"hbl_audit_log"`. It specifies an extensive list of columns to be audited for HBL entries, covering details like booking IDs, vessel, addresses, contact persons, ports, dates, and descriptions. This indicates the implementation of a new audit trail for HBL operations.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\types\audit.types.ts` (12/1/2025, 2:28:34 PM)**
    *   **New Enum Member:** The `AuditQueryType` enum is updated to include `HBL = 'HBL'`, enabling audit log queries specifically for HBL-related activities.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\audit.controller.ts` (12/1/2025, 2:28:47 PM)**
    *   **New Audit Case:** The `getAll` function is updated to handle the new `AuditQueryType.HBL`. If the `type` query parameter is `HBL`, it sets `tableName` to `"hbl_audit_log"` and `refColumn` to `"agent_booking_id"`, allowing retrieval of HBL audit logs.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\booking.controller.ts` (12/2/2025, 11:36:59 AM)**
    *   **Initial Structure:** This file contains `saveBooking` and `saveMaster` functions.
    *   **`saveBooking` function:** Handles saving and updating booking information. It performs numerous inserts into multiple tables (`agent_booking_entry`, `agent_booking_Cargolist`, `agent_booking_vessel`, `agent_booking_container_pre`, `agent_booking_po`, `agent_booking_linked_po`) within a transaction. It includes logic for determining if it's an 'ADD' or 'UPDATE' based on `agent_booking_id`, handling the generation of new booking IDs for 'ADD'. Updates involve deleting existing child records and re-inserting them.
    *   **`saveMaster` function:** Handles saving master data, restricted by `poAccountMastertype`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts` (12/2/2025, 12:50:47 PM - 12/2/2025, 12:56:36 PM)**
    *   **Endpoint for HBL:** This file defines API routes for HBL entry.
    *   **Method Change:** The `/update` endpoint's HTTP method was changed from `PUT` to `POST` (12/2/2025, 12:56:36 PM). This suggests a potential API design change or correction in how updates are handled.

**Timestamps of Significant Changes:**

*   **12/1/2025, 11:58:52 AM:** Major refactoring of `updateHblMasterBooking` in `hblEntry.controller.ts` from a generic `updateQuery` to detailed SQL `UPDATE` and `DELETE/INSERT` for related tables.
*   **12/1/2025, 1:22:23 PM - 1:26:16 PM:** Refinements to the `updateHblMasterBooking` SQL, specifically adding `marks`, `hbldate`, and `bookingdate`.
*   **12/1/2025, 2:28:04 PM:** Addition of `hbl_master` configuration to `auditConfig.ts`.
*   **12/1/2025, 2:28:34 PM:** Addition of `HBL` to `AuditQueryType` enum in `audit.types.ts`.
*   **12/1/2025, 2:28:47 PM:** Update to `audit.controller.ts` to handle `HBL` audit type.
*   **12/1/2025, 2:30:17 PM:** Introduction of `simpleAudit` in `createHblMasterBooking`.
*   **12/1/2025, 2:51:38 PM:** Introduction of `insertAudit` in `updateHblMasterBooking` and import of `auditConfigObj`.
*   **12/1/2025, 3:25:19 PM:** Refinement of `insertAudit` in `updateHblMasterBooking` to filter payload data based on `auditConfigObj` for specific table columns.
*   **12/2/2025, 11:30:40 AM:** `updateHblMasterBooking` modified to correctly pass `payload.client_name` to the `customer` column in the `hbl_master` update.
*   **12/2/2025, 12:56:36 PM:** Change of `/update` route method from `PUT` to `POST` in `hblEntry.route.ts`.

**Patterns and Recurring Elements:**

*   **Database Transaction Usage:** Both `create` and `update` operations consistently use `BEGIN`, `COMMIT`, and `ROLLBACK` for ensuring data integrity during multi-table operations.
*   **Data Sanitization:** The `sanitizeString` and `AppDateFormate` utility functions are heavily used across multiple fields when creating payload objects for database operations, indicating a focus on data quality and security.
*   **Modular Audit Logging:** A pattern emerges with the introduction of `simpleAudit` for creation and `insertAudit` for updates. The `insertAudit` specifically uses `auditConfigObj` to determine which fields to audit, promoting configurable and granular auditing.
*   **List Handling in Updates:** For related lists (e.g., `routingList`, `containerList`, `basicPoList`), the update strategy involves a `DELETE` of existing entries followed by `insertMany` of the new list items. This simplifies updates for associated child records.
*   **Role-Based Location/Company Name:** `locationByRole` is calculated based on `req.user.role` (AGENT vs. ADMIN), which is then used for `location` fields in database inserts, ensuring correct data association based on user permissions.
*   **Error Handling:** `HttpError` is used for specific business logic errors, and a generic `logger.error` along with a 500 status response handles broader exceptions.
*   **Console Logging:** `console.log(req.body, 'reqbody=====:')` and `logger.info` statements are present for debugging and informational purposes.

## 2:53:21 PM
The script `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.sendNewUserNotification.js` was updated or created on 12/2/2025 at 1:55:24 PM.

This JavaScript file defines a batch process, primarily within an asynchronous `main` function. Key functionalities include:
*   **Logging and Timing**: It uses `moment` to track the start and end times of the batch, calculating and logging the total execution duration in milliseconds. It initializes a custom logger, specifically named "destination-cost-validate," despite the file name suggesting user notification.
*   **Core Action**: The primary operation performed is `await notifyAdmin.notifyAdmin()`, indicating that the batch's main purpose is to send a notification to an administrator.
*   **Execution Flow**: The batch logs its initiation ("Exception Date Validation Batch Started") and completion, wrapping its operations in a `try...catch` block for robust error handling. It ensures proper process exit codes (0 for success, 1 for failure).

A notable pattern is the consistent use of logging statements to mark the batch's lifecycle, including start, completion, and total execution time. There is an apparent inconsistency where the filename (`run.sendNewUserNotification.js`) suggests user notifications, but the logger name and initial log message ("Exception Date Validation Batch Started") point towards a validation process, while the actual invoked function (`notifyAdmin.notifyAdmin()`) is for administrative notifications.