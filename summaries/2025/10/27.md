# Activity Summary for 10/27/2025

## 11:49:02 AM
The changes log details significant updates across several core functionalities, primarily focusing on expanded analytics and settings management.

In `src\common\constants\Paths.ts` (10/27/2025, 10:56:34 AM), numerous new API endpoints were introduced. The `Analytics` module saw a substantial expansion with paths for dashboard management (`/dashboards`, `/create`, `/update`, `/delete-view`, `/dashboardEndPoints`), metrics (`/metricsList`), and various report exports and data points (`/excelExport`, `/save-sequence`, `/save_size`, `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, `/Tables/tableData`). The `Settings` module also gained new paths for managing formats (`/format` with GET, POST, PUT) and grid configurations (`/grid-config` with GET, POST). Other modules like `User`, `Booking`, `Reports`, `Shipment`, and `Autocom` also received new, more granular endpoints, indicating a broad feature enhancement.

The `src\routes\SettingRoutes.ts` file (10/27/2025, 10:58:29 AM) was updated to define routes for settings, including `Get`, `Post`, `Put` for format settings and `GetGrid`, `PostGrid` for grid configurations, based on the newly defined `Paths`. However, all these routes are currently incorrectly mapped to `getAll` from the `bookingService`, indicating an incomplete implementation or a placeholder error that needs correction.

The `src\services\setting-service.ts` file underwent several updates:
- The initial version (10/27/2025, 11:00:09 AM) introduced a new service with functions to `getFormat`, `addFormat`, `updateFormat` for managing `format_settings` in the database, and `updateGridSettings`, `getGridSettings` for managing user-specific grid configurations in `grid_settings`. The `updateGridSettings` function includes logic to either insert a new setting or update an existing one based on `userid` and `screen`.
- A subsequent entry (10/27/2025, 11:00:20 AM) shows no functional changes, likely a re-save.
- A final update (10/27/2025, 11:01:18 AM) refactored the `addFormat` function to consistently use `IAuthReq` for authenticated requests, aligning it with other functions in the service, and removed unused imports like `AuthenticatedRequest` and `HttpError`.

In `src\utils\analytics.ts` (10/27/2025, 11:47:35 AM), a comprehensive set of utility functions for analytics and reporting was added. These include:
- `defaultDateRange`: Provides a default 365-day date range.
- `replaceValueInQuery`: A function to dynamically modify SQL query clauses, specifically for normalizing location data (e.g., transforming 'LONG BEACH' to 'LOS ANGELES').
- `getUserObject`: Fetches extended user information based on company and access level.
- `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses for time-series aggregation by month, week, or quarter.
- `getExcelSelectedColumns`: Dynamically selects database columns for Excel reports based on report name and booking status, including specific logic for "Cargo-Ready Date to ETD" and "BL Release KPI" reports.
- `isValidDate`: A helper to validate date strings.
- `dateFilterOnExport`: Processes data rows to replace invalid date values with `null` and optionally formats valid dates to "MM/DD/YYYY".
- `EXCEL_EXPORT_COLUMNS`: A large array defining the display names and keys for columns intended for Excel exports, covering extensive shipment and booking details.

Finally, `src\services\analyticsExportService.ts` (10/27/2025, 11:48:28 AM) introduced a new service responsible for handling analytics data exports. Its `getExportData` function:
- Processes various query parameters (date ranges, report names, display types, columns).
- Utilizes `defaultDateRange`, `getUserObject`, and `dateFilterOnExport` from the `analytics` utilities.
- Dynamically constructs complex SQL queries using external `bookingQuery` and `nonBookingQuery` functions, including `DISTINCT ON` clauses for specific report types.
- Post-processes the fetched data with `dateFilterOnExport` and `replaceColumnHandler`.
- Implements specific logic for "TEU" and "MBL" reports to handle container uniqueness.
- The `replaceColumnHandler` function explicitly transforms `pod` and `place_of_delivery` values from 'LONG BEACH' to 'LOS ANGELES' in the final dataset, reinforcing the data normalization pattern seen in `analytics.ts`.

**Key patterns and recurring elements:**
- **Extensive Analytics and Reporting:** A major theme is the development of robust analytics features, including dynamic query building, date-based filtering, and highly customizable Excel exports.
- **Settings Management:** New capabilities for user-specific and general application settings.
- **Data Normalization:** A consistent pattern of transforming 'LONG BEACH' to 'LOS ANGELES' for location fields (`pod`, `place_of_delivery`) appears in both utility and service layers, suggesting a business requirement for unifying these locations.
- **Database Utilities:** Heavy reliance on common `query`, `insertQuery`, `updateQuery` database utilities across new services.
- **Error Handling and Logging:** Consistent use of `logger.info` and `logger.error` and standard `res.status(500).json({ error: "Internal server error" })` for error responses across services.
- **Modular API Design:** The expansion of `Paths.ts` into granular endpoints for various modules indicates a structured approach to API design.