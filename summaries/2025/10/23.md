# Activity Summary for 10/23/2025

## 10:31:45 AM
The provided log details changes to the `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\analytics.route.ts` file, with the last recorded update on **October 22, 2025, at 11:01:53 AM**.

**File-Specific Updates (`analytics.route.ts`):**

This file is responsible for defining the API routes for the analytics module within the `t360-backend` application. The changes indicate a comprehensive setup for analytics functionalities, including:

*   **Dashboard Management:** Full CRUD (Create, Read, Update, Delete) operations are exposed for dashboards via `POST`, `GET`, `PUT`, and `DELETE` requests to `/dashboards`. These operations are handled by the `core.view.controller`.
*   **Metric and Endpoint Listing:** Routes are provided to fetch lists of dashboard endpoints (`/dashboardEndPoints`) and available metrics (`/metricsList`), using `GET` requests and handled by `core.metric.controller`.
*   **Data Export:** An endpoint `/excelExport` is available for exporting data via a `GET` request, managed by `core.export.controller`.
*   **User Preferences:** Functionality to save user preferences, specifically `saveSequence` and `saveSize`, is exposed through `POST` requests to `/save_sequence` and `/save_size` respectively, also managed by `core.metric.controller`.
*   **Reporting:** A variety of specific data reports are exposed via `GET` requests, each handled by its dedicated controller:
    *   `/cbm` for CBM reports (`cbm.controller`)
    *   `/kgs` for KGS reports (`kgs.controller`)
    *   `/teu` for TEU reports (`teu.controller`)
    *   `/containers` for Container reports (`container.controller`)
    *   `/transit` for Transit reports (`transit.controller`)
    *   `/Tables/tableData` for general table data reports (`others.controller`)

**Patterns and Recurring Elements:**

A clear pattern observed is the modular organization of analytics functionalities. Different aspects of analytics (view management, metric management, CBM, KGS, TEU, container, transit reports, and export) are separated into distinct controller files. This `analytics.route.ts` file then acts as an aggregator, importing functions from these controllers and mapping them to specific API endpoints. The majority of the routes are `GET` requests for retrieving data and reports, while `POST`, `PUT`, and `DELETE` are used for managing dashboard resources and saving user preferences.

## 10:32:27 AM
A series of rapid updates occurred on October 22, 2025, primarily focused on developing and refining an "Analytics" feature within the T360-V2 backend.

**Key Information by File:**

*   **`src\common\constants\Paths.ts` (10/22/2025, 12:19:46 PM):** The core routing constants were significantly expanded to introduce a new `Analytics` module. This module defines numerous endpoints for dashboard management, metric retrieval, data export, and layout configuration, including `/dashboards`, `/create`, `/update`, `/delete-view`, `/dashboardEndPoints`, `/metricsList`, `/excelExport`, `/save-sequence`, `/save_size`, and various data-specific endpoints like `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`.

*   **`src\routes\analyticsRoutes.ts` (Multiple updates from 10/22/2025, 12:20:38 PM to 4:38:37 PM):**
    *   Initially (12:20:38 PM), the `AnalyticsRoutes` were created, but mistakenly mapped dashboard service functions (`getDashboardCardInfo`, `getDeliveryData`) to `Paths.Dashboard` endpoints.
    *   By 12:33:26 PM, these incorrect mappings were removed, and the routes began correctly referencing `getAll` from `coreViewService` for `Paths.Analytics.Get`.
    *   Further updates (12:34:42 PM) integrated the full CRUD functionality for dashboard views by mapping `create`, `update`, and `deleteView` from `coreViewService` to their respective `Paths.Analytics` endpoints.
    *   Later, `dashboardEndPointList` and `getMetricList` from the newly introduced `coreMetricService` were mapped to `Paths.Analytics.DashboardEndPoints` and `Paths.Analytics.MetricsList` respectively (4:13:43 PM, 4:22:31 PM).
    *   Finally (4:38:37 PM), `saveSequence` and `saveSize` from `coreMetricService` were correctly mapped to `Paths.Analytics.SaveSequence` and `Paths.Analytics.SaveSize` (both as POST requests), and `getExportData` from `analyticsExportService` was mapped to `Paths.Analytics.GetExcelReport` (4:40:33 PM).

*   **`src\routes\index.ts` (10/22/2025, 12:21:23 PM):** The main API router was updated to include the new `AnalyticsRoutes` under the `Paths.Analytics.Base` path, marking the integration of the analytics feature into the application's routing.

*   **`src\services\coreViewService.ts` (Multiple updates from 10/22/2025, 12:26:53 PM to 12:46:12 PM):** This new service was created to manage user-defined dashboard views.
    *   It defines `getAll`, `create`, `update`, and `deleteView` functions, which interact with a `dashboards` table to store and retrieve view configurations (menu titles and associated metrics). An `analytics_view_log` table is used for auditing these actions.
    *   Early changes improved type safety by switching request types to `IAuthReq` and `Response`.
    *   A significant change (12:46:12 PM) improved SQL query security for `CREATE` and `UPDATE` operations by implementing parameterized queries for `dashboard_metrics` and `user_id`, reducing SQL injection risks, though `DELETE` operations continued to use string interpolation for user-provided values.

*   **`src\models\common\types\analytics.ts` (Multiple updates from 10/22/2025, 12:27:34 PM to 4:36:01 PM):** This file saw a gradual evolution of interfaces to support the analytics feature's data structures:
    *   `CheckBoxDetails` was introduced (12:27:34 PM).
    *   `MenuRow` was added, initially with `menu_title`, then expanded to include `metricsId`, `dashboard_metrics`, and `size` (12:37:00 PM, 4:05:10 PM).
    *   `DashboardItem` was added to define dashboard report items, later gaining `dashboard_name` (4:11:25 PM, 4:19:45 PM).
    *   `MetricListDataI` and `MetricRow` were added to type metric list data and individual metric rows respectively (4:14:47 PM, 4:36:01 PM).

*   **`src\services\coreMetricService.ts` (Multiple updates from 10/22/2025, 4:11:45 PM to 4:38:20 PM):** This new service handles metric-specific operations:
    *   `dashboardEndPointList` (4:11:45 PM) retrieves metric endpoints and layout information (`rowSpan`, `columnSpan`) for a given dashboard view, sorting them by a stored sequence.
    *   `getMetricList` (4:17:27 PM) fetches all available metrics, categorizes them (Container_Wise, MBL_Wise), and supports preloading a dashboard's selected metrics. This function also contained string interpolation in SQL queries, which was partially addressed.
    *   `saveSequence` and `saveSize` (4:27:44 PM) were added to allow users to customize the order and size of metrics in their dashboards. These functions extensively use string interpolation for constructing SQL queries, which is a potential security concern. Type guards and nullish coalescing were introduced for safer handling of user data in `saveSequence` (4:32:09 PM).

*   **`src\services\analyticsExportService.ts` (Multiple updates from 10/22/2025, 4:40:11 PM to 6:08:54 PM):** This new service provides functionality for exporting analytics data.
    *   `getExportData` (4:40:11 PM) dynamically constructs SQL queries based on various report parameters (date ranges, report name, booking status, columns, display type). It uses helper functions like `columnsQuery`, `saveColumns`, `dateFilterOnExport`, and `replaceColumnHandler` to prepare the data for export.
    *   Imports were updated to use `@src` aliases (4:47:46 PM).
    *   A notable change (6:08:54 PM) was the removal of the explicit import for `nonBookingQuery`, while the function is still referenced in the code, suggesting a possible oversight or implicit dependency.

*   **`src\utils\analytics.ts` (Multiple updates from 10/22/2025, 4:43:56 PM to 5:11:25 PM):** A new utility file containing helper functions for analytics:
    *   `defaultDateRange`: Provides a default date range (last 365 days).
    *   `replaceValueInQuery`: Utility to dynamically replace values in SQL queries (e.g., 'LONG BEACH' with 'LOS ANGELES').
    *   `getUserObject`: Retrieves user and company information, handling 'ADMIN' access. This function was later refined with explicit TypeScript interfaces and parameterized queries for better type safety and security (5:09:52 PM).
    *   `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses based on display preferences (month, week, quarter).
    *   `getExcelSelectedColumns`: Selects specific columns for Excel exports based on report name and booking status.
    *   `dateFilterOnExport`: Filters out invalid dates and formats valid dates for export.
    *   `EXCEL_EXPORT_COLUMNS`: A constant array defining the structure for exported columns.

*   **`src\common\util\export.query.ts` (Multiple updates from 10/22/2025, 4:46:51 PM to 6:05:51 PM):** This new utility file contains complex, hardcoded SQL query fragments for various booking-related reports.
    *   `getMonthValue`: A helper to convert month names to numeric values.
    *   `bookingQuery`: Generates dynamic SQL `WHERE` clauses and additional `SELECT` columns based on report name, company name, and time-based filtering (month, week, quarter). This function heavily relies on string interpolation, making it a potential area for SQL injection if input parameters are not thoroughly sanitized.

**Patterns and Recurring Elements:**

*   **Analytics Feature Development:** The overwhelming majority of changes are dedicated to building a comprehensive analytics module, covering custom dashboard creation, metric selection, layout, and data export.
*   **Timestamp Concentration:** All recorded changes occurred on the same day (October 22, 2025), indicating a focused development effort or a single commit representing a large feature implementation.
*   **SQL Query Construction:** A recurring pattern is the dynamic construction of SQL queries using string interpolation in many service and utility files (`coreViewService`, `coreMetricService`, `analyticsExportService`, `export.query.ts`). While some efforts were made towards parameterized queries in `coreViewService` and `getUserObject`, several critical areas (like `DELETE` in `coreViewService`, `saveSequence`, `saveSize` in `coreMetricService`, and the entirety of `bookingQuery`) still rely on direct string concatenation with user-supplied values, presenting potential SQL injection vulnerabilities.
*   **Data Modeling Evolution:** New TypeScript interfaces (`CheckBoxDetails`, `MenuRow`, `DashboardItem`, `MetricListDataI`, `MetricRow`) were progressively introduced and refined, reflecting a growing and more defined data model for analytics entities.
*   **Route Centralization:** The `Paths.ts` constant serves as a central registry for all API endpoints, ensuring consistency and ease of management.
*   **Logging:** `logger.info` and `logger.error` calls are prevalent across new service files, suggesting an emphasis on monitoring and debugging.
*   **Date Handling:** Utility functions for date range defaults and formatting show a consistent approach to date-related data processing.
*   **Value Normalization:** Functions like `replaceColumnHandler` in `analyticsExportService` and `replaceValueInQuery` in `analytics.ts` indicate a need to standardize or adjust specific string values (e.g., location names like "LONG BEACH" to "LOS ANGELES").

## 11:31:43 AM
The file `src/routes/analytics.route.ts` was updated on October 22, 2025, at 11:01:53 AM. This update defines a comprehensive set of API routes for an analytics module within a backend application.

Key changes and functionalities include:

*   **Dashboard Management**: Full CRUD (Create, Read, Update, Delete) operations are exposed for `/dashboards`, handled by `core.view.controller`.
*   **Metric and Endpoint Listing**: Routes for `/dashboardEndPoints` and `/metricsList` provide access to available analytics configurations and metrics.
*   **Data Export**: An `/excelExport` endpoint is included for exporting analytical data, managed by `core.export.controller`.
*   **User Preferences**: Specific routes `/save_sequence` and `/save_size` are present, suggesting functionality for users to customize and save their dashboard or report layouts/preferences.
*   **Specific Reports**: A variety of distinct reporting endpoints are defined, including `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`. These indicate detailed reporting capabilities for different logistics or container metrics, handled by their respective controllers (`cbm.controller`, `kgs.controller`, `teu.controller`, etc.).

The overall pattern indicates a centralized analytics routing file that aggregates various data visualization, reporting, configuration, and user preference functionalities, drawing from multiple specialized analytics controllers.