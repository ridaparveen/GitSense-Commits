# Activity Summary for 10/23/2025

## 10:31:45 AM
The provided log details changes to the `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\analytics.route.ts` file, with the last recorded update on **October 22, 2025, at 11:01:53 AM**.

**File-Specific Updates (`analytics.route.ts`):**

This file is responsible for defining the API routes for the analytics module within the `t360-backend` application. The changes indicate a comprehensive setup for analytics functionalities, including:

*   **Dashboard Management:** Full CRUD (Create, Read, Update, Delete) operations are exposed for dashboards via `POST`, `GET`, `PUT`, and `DELETE` requests to `/dashboards`. These operations are handled by the `core.view.controller`.
*   **Metric and Endpoint Listing:** Routes are provided to fetch lists of dashboard endpoints (`/dashboardEndPoints`) and available metrics (`/metricsList`), using `GET` requests and handled by `core.metric.controller`.
*   **Data Export:** An endpoint `/excelExport` is available for exporting data via a `GET` request, managed by `core.export.controller`.
*   **User Preferences:** Functionality to save user preferences, specifically `saveSequence` and `saveSize`, is exposed through `POST` requests to `/save_sequence` and `/save_size` respectively, also managed by `core.metric.controller`.
*   **Reporting:** A variety of specific data reports are exposed via `GET` requests, each handled by its dedicated controller:
    *   `/cbm` for CBM reports (`cbm.controller`)
    *   `/kgs` for KGS reports (`kgs.controller`)
    *   `/teu` for TEU reports (`teu.controller`)
    *   `/containers` for Container reports (`container.controller`)
    *   `/transit` for Transit reports (`transit.controller`)
    *   `/Tables/tableData` for general table data reports (`others.controller`)

**Patterns and Recurring Elements:**

A clear pattern observed is the modular organization of analytics functionalities. Different aspects of analytics (view management, metric management, CBM, KGS, TEU, container, transit reports, and export) are separated into distinct controller files. This `analytics.route.ts` file then acts as an aggregator, importing functions from these controllers and mapping them to specific API endpoints. The majority of the routes are `GET` requests for retrieving data and reports, while `POST`, `PUT`, and `DELETE` are used for managing dashboard resources and saving user preferences.

## 10:32:27 AM
A series of rapid updates occurred on October 22, 2025, primarily focused on developing and refining an "Analytics" feature within the T360-V2 backend.

**Key Information by File:**

*   **`src\common\constants\Paths.ts` (10/22/2025, 12:19:46 PM):** The core routing constants were significantly expanded to introduce a new `Analytics` module. This module defines numerous endpoints for dashboard management, metric retrieval, data export, and layout configuration, including `/dashboards`, `/create`, `/update`, `/delete-view`, `/dashboardEndPoints`, `/metricsList`, `/excelExport`, `/save-sequence`, `/save_size`, and various data-specific endpoints like `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`.

*   **`src\routes\analyticsRoutes.ts` (Multiple updates from 10/22/2025, 12:20:38 PM to 4:38:37 PM):**
    *   Initially (12:20:38 PM), the `AnalyticsRoutes` were created, but mistakenly mapped dashboard service functions (`getDashboardCardInfo`, `getDeliveryData`) to `Paths.Dashboard` endpoints.
    *   By 12:33:26 PM, these incorrect mappings were removed, and the routes began correctly referencing `getAll` from `coreViewService` for `Paths.Analytics.Get`.
    *   Further updates (12:34:42 PM) integrated the full CRUD functionality for dashboard views by mapping `create`, `update`, and `deleteView` from `coreViewService` to their respective `Paths.Analytics` endpoints.
    *   Later, `dashboardEndPointList` and `getMetricList` from the newly introduced `coreMetricService` were mapped to `Paths.Analytics.DashboardEndPoints` and `Paths.Analytics.MetricsList` respectively (4:13:43 PM, 4:22:31 PM).
    *   Finally (4:38:37 PM), `saveSequence` and `saveSize` from `coreMetricService` were correctly mapped to `Paths.Analytics.SaveSequence` and `Paths.Analytics.SaveSize` (both as POST requests), and `getExportData` from `analyticsExportService` was mapped to `Paths.Analytics.GetExcelReport` (4:40:33 PM).

*   **`src\routes\index.ts` (10/22/2025, 12:21:23 PM):** The main API router was updated to include the new `AnalyticsRoutes` under the `Paths.Analytics.Base` path, marking the integration of the analytics feature into the application's routing.

*   **`src\services\coreViewService.ts` (Multiple updates from 10/22/2025, 12:26:53 PM to 12:46:12 PM):** This new service was created to manage user-defined dashboard views.
    *   It defines `getAll`, `create`, `update`, and `deleteView` functions, which interact with a `dashboards` table to store and retrieve view configurations (menu titles and associated metrics). An `analytics_view_log` table is used for auditing these actions.
    *   Early changes improved type safety by switching request types to `IAuthReq` and `Response`.
    *   A significant change (12:46:12 PM) improved SQL query security for `CREATE` and `UPDATE` operations by implementing parameterized queries for `dashboard_metrics` and `user_id`, reducing SQL injection risks, though `DELETE` operations continued to use string interpolation for user-provided values.

*   **`src\models\common\types\analytics.ts` (Multiple updates from 10/22/2025, 12:27:34 PM to 4:36:01 PM):** This file saw a gradual evolution of interfaces to support the analytics feature's data structures:
    *   `CheckBoxDetails` was introduced (12:27:34 PM).
    *   `MenuRow` was added, initially with `menu_title`, then expanded to include `metricsId`, `dashboard_metrics`, and `size` (12:37:00 PM, 4:05:10 PM).
    *   `DashboardItem` was added to define dashboard report items, later gaining `dashboard_name` (4:11:25 PM, 4:19:45 PM).
    *   `MetricListDataI` and `MetricRow` were added to type metric list data and individual metric rows respectively (4:14:47 PM, 4:36:01 PM).

*   **`src\services\coreMetricService.ts` (Multiple updates from 10/22/2025, 4:11:45 PM to 4:38:20 PM):** This new service handles metric-specific operations:
    *   `dashboardEndPointList` (4:11:45 PM) retrieves metric endpoints and layout information (`rowSpan`, `columnSpan`) for a given dashboard view, sorting them by a stored sequence.
    *   `getMetricList` (4:17:27 PM) fetches all available metrics, categorizes them (Container_Wise, MBL_Wise), and supports preloading a dashboard's selected metrics. This function also contained string interpolation in SQL queries, which was partially addressed.
    *   `saveSequence` and `saveSize` (4:27:44 PM) were added to allow users to customize the order and size of metrics in their dashboards. These functions extensively use string interpolation for constructing SQL queries, which is a potential security concern. Type guards and nullish coalescing were introduced for safer handling of user data in `saveSequence` (4:32:09 PM).

*   **`src\services\analyticsExportService.ts` (Multiple updates from 10/22/2025, 4:40:11 PM to 6:08:54 PM):** This new service provides functionality for exporting analytics data.
    *   `getExportData` (4:40:11 PM) dynamically constructs SQL queries based on various report parameters (date ranges, report name, booking status, columns, display type). It uses helper functions like `columnsQuery`, `saveColumns`, `dateFilterOnExport`, and `replaceColumnHandler` to prepare the data for export.
    *   Imports were updated to use `@src` aliases (4:47:46 PM).
    *   A notable change (6:08:54 PM) was the removal of the explicit import for `nonBookingQuery`, while the function is still referenced in the code, suggesting a possible oversight or implicit dependency.

*   **`src\utils\analytics.ts` (Multiple updates from 10/22/2025, 4:43:56 PM to 5:11:25 PM):** A new utility file containing helper functions for analytics:
    *   `defaultDateRange`: Provides a default date range (last 365 days).
    *   `replaceValueInQuery`: Utility to dynamically replace values in SQL queries (e.g., 'LONG BEACH' with 'LOS ANGELES').
    *   `getUserObject`: Retrieves user and company information, handling 'ADMIN' access. This function was later refined with explicit TypeScript interfaces and parameterized queries for better type safety and security (5:09:52 PM).
    *   `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses based on display preferences (month, week, quarter).
    *   `getExcelSelectedColumns`: Selects specific columns for Excel exports based on report name and booking status.
    *   `dateFilterOnExport`: Filters out invalid dates and formats valid dates for export.
    *   `EXCEL_EXPORT_COLUMNS`: A constant array defining the structure for exported columns.

*   **`src\common\util\export.query.ts` (Multiple updates from 10/22/2025, 4:46:51 PM to 6:05:51 PM):** This new utility file contains complex, hardcoded SQL query fragments for various booking-related reports.
    *   `getMonthValue`: A helper to convert month names to numeric values.
    *   `bookingQuery`: Generates dynamic SQL `WHERE` clauses and additional `SELECT` columns based on report name, company name, and time-based filtering (month, week, quarter). This function heavily relies on string interpolation, making it a potential area for SQL injection if input parameters are not thoroughly sanitized.

**Patterns and Recurring Elements:**

*   **Analytics Feature Development:** The overwhelming majority of changes are dedicated to building a comprehensive analytics module, covering custom dashboard creation, metric selection, layout, and data export.
*   **Timestamp Concentration:** All recorded changes occurred on the same day (October 22, 2025), indicating a focused development effort or a single commit representing a large feature implementation.
*   **SQL Query Construction:** A recurring pattern is the dynamic construction of SQL queries using string interpolation in many service and utility files (`coreViewService`, `coreMetricService`, `analyticsExportService`, `export.query.ts`). While some efforts were made towards parameterized queries in `coreViewService` and `getUserObject`, several critical areas (like `DELETE` in `coreViewService`, `saveSequence`, `saveSize` in `coreMetricService`, and the entirety of `bookingQuery`) still rely on direct string concatenation with user-supplied values, presenting potential SQL injection vulnerabilities.
*   **Data Modeling Evolution:** New TypeScript interfaces (`CheckBoxDetails`, `MenuRow`, `DashboardItem`, `MetricListDataI`, `MetricRow`) were progressively introduced and refined, reflecting a growing and more defined data model for analytics entities.
*   **Route Centralization:** The `Paths.ts` constant serves as a central registry for all API endpoints, ensuring consistency and ease of management.
*   **Logging:** `logger.info` and `logger.error` calls are prevalent across new service files, suggesting an emphasis on monitoring and debugging.
*   **Date Handling:** Utility functions for date range defaults and formatting show a consistent approach to date-related data processing.
*   **Value Normalization:** Functions like `replaceColumnHandler` in `analyticsExportService` and `replaceValueInQuery` in `analytics.ts` indicate a need to standardize or adjust specific string values (e.g., location names like "LONG BEACH" to "LOS ANGELES").

## 11:31:43 AM
The file `src/routes/analytics.route.ts` was updated on October 22, 2025, at 11:01:53 AM. This update defines a comprehensive set of API routes for an analytics module within a backend application.

Key changes and functionalities include:

*   **Dashboard Management**: Full CRUD (Create, Read, Update, Delete) operations are exposed for `/dashboards`, handled by `core.view.controller`.
*   **Metric and Endpoint Listing**: Routes for `/dashboardEndPoints` and `/metricsList` provide access to available analytics configurations and metrics.
*   **Data Export**: An `/excelExport` endpoint is included for exporting analytical data, managed by `core.export.controller`.
*   **User Preferences**: Specific routes `/save_sequence` and `/save_size` are present, suggesting functionality for users to customize and save their dashboard or report layouts/preferences.
*   **Specific Reports**: A variety of distinct reporting endpoints are defined, including `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`. These indicate detailed reporting capabilities for different logistics or container metrics, handled by their respective controllers (`cbm.controller`, `kgs.controller`, `teu.controller`, etc.).

The overall pattern indicates a centralized analytics routing file that aggregates various data visualization, reporting, configuration, and user preference functionalities, drawing from multiple specialized analytics controllers.

## 11:32:02 AM
The changes primarily revolve around the enhancement and expansion of the analytics and reporting functionalities within the `t360-backend-v2` project. A new `Analytics` module has been introduced, covering dashboard views, metrics, and data export.

**File-Specific Updates:**

*   **`src\common\constants\Paths.ts` (Timestamp: 10/22/2025, 12:19:46 PM):**
    *   Significant expansion of the `Analytics` base path with new endpoints.
    *   New analytics endpoints include `/dashboards` (Get), `/create`, `/update`, `/delete-view`, `/dashboardEndPoints`, `/metricsList`, `/excelExport`, `/save-sequence`, `/save_size`, `/cbm`, `/kgs`, `/teu`, `/containers`, and `/Tables/tableData`.
    *   Other modules like `Users`, `Auth`, `Dashboard`, `Shipment`, `Autocom`, `Booking`, `Reports`, `User`, and `Notification` also see minor additions or updates to their respective paths, indicating continued development across the application.

*   **`src\routes\analyticsRoutes.ts` (Multiple Timestamps: 10/22/2025, 12:20:38 PM to 4:38:37 PM):**
    *   **Initial setup (12:20:38 PM):** The `AnalyticsRoutes` were initially configured to use `getDashboardCardInfo` and `getDeliveryData` from `dashboardService`, suggesting an initial overlap or placeholder.
    *   **Refactoring and integration (12:33:16 PM - 12:34:42 PM):** The route definitions were progressively refined.
        *   `getDashboardCardInfo` was removed.
        *   `getAll` from `coreViewService` was integrated for `Paths.Analytics.Get`.
        *   Routes for creating, updating, and deleting analytics views (`create`, `update`, `deleteView` from `coreViewService`) were added.
    *   **Integration of CoreMetricService (4:13:43 PM - 4:38:37 PM):**
        *   `dashboardEndPointList` from `coreMetricService` was added to `Paths.Analytics.DashboardEndPoints`.
        *   `getMetricList` from `coreMetricService` was assigned to `Paths.Analytics.MetricsList`.
        *   `saveSequence` and `saveSize` from `coreMetricService` were added as POST routes for `Paths.Analytics.SaveSequence` and `Paths.Analytics.SaveSize`, respectively.
        *   `getExportData` from `analyticsExportService` was introduced for `Paths.Analytics.GetExcelReport`.
    *   **Pattern:** Multiple endpoints (`GetExcelReport`, `Get`, `Get`) were assigned the `getAll` handler, which might indicate temporary assignments or a design where `getAll` serves as a generic fallback or initial handler.

*   **`src\routes\index.ts` (Timestamp: 10/22/2025, 12:21:23 PM):**
    *   The main API router (`apiRouter`) was updated to include `AnalyticsRoutes` under `Paths.Analytics.Base`, formally integrating the new analytics module into the application's routing structure.

*   **`src\models\common\types\analytics.ts` (Multiple Timestamps: 10/22/2025, 12:27:34 PM to 4:36:01 PM):**
    *   Introduction and iterative expansion of analytics-related TypeScript interfaces.
    *   **`CheckBoxDetails`:** Defines `checked` and `metricsId`.
    *   **`MenuRow`:** Initially `menu_title`, then expanded to include `metricsId`, `dashboard_metrics`, and `size`. This suggests storing details about dashboard configuration and layout.
    *   **`DashboardItem`:** Added to define structure for dashboard elements with `id`, `name`, `end_point`, and `dashboard_name`.
    *   **`MetricListDataI`:** Added for metric list data, including `id`, `name`, `group`, `filter_by`, and an optional `checked` status.
    *   **`MetricRow`:** A simple interface for `id` and `name` of a metric.
    *   **Pattern:** Consistent evolution of types to support increasingly complex dashboard and metric management, including display properties and data filtering.

*   **`src\services\coreViewService.ts` (Multiple Timestamps: 10/22/2025, 12:26:53 PM to 12:46:12 PM):**
    *   **Initial implementation (12:26:53 PM):** Introduced `getAll`, `create`, `update`, `deleteView` functions for managing user dashboards (`dashboards` table). It also included a `logAudit` function to record changes to analytics views in `analytics_view_log`.
    *   **Type refinement and database parameterization (12:31:11 PM - 12:46:12 PM):**
        *   Improved type annotations, e.g., using `IAuthReq` for requests and `Response, NextFunction` for Express handlers.
        *   Added imports for `CheckBoxDetails` and `MenuRow`.
        *   Database queries for `create` and `update` were refactored to use parameterized queries (`$1, $2, $3::int[]`) instead of direct string interpolation for better security and type handling (e.g., `ARRAY[${metricsIdsArray}]` became `$3::int[]`).
        *   Nullish coalescing operator (`user?.usercode`) was consistently applied for user-related properties.

*   **`src\services\coreMetricService.ts` (Multiple Timestamps: 10/22/2025, 4:11:45 PM to 4:38:20 PM):**
    *   **Introduction of metric-related services:**
        *   **`dashboardEndPointList`:** Fetches dashboard metrics, their order, and size from the `dashboards` table for a given user and menu title, then queries `metrics` table to retrieve details. It also sorts the results based on `dashboard_metrics` order and formats them with `rowSpan` and `columnSpan`.
        *   **`getMetricList`:** Retrieves a list of all available metrics from the `metrics` table, categorizes them into `Container_Wise` and `MBL_Wise` groups, and optionally preloads checked states based on an existing dashboard's configuration.
        *   **`saveSequence`:** Saves the order of reports (metrics) for a specific user and dashboard (`menu_title`). Handles "Default" dashboard creation if it doesn't exist and updates `dashboard_metrics`.
        *   **`saveSize`:** Allows users to save `columnSpan` and `rowSpan` properties for individual metrics within a dashboard. It fetches existing size data, updates it for a specific metric, and persists it back to the `dashboards` table.
    *   **Pattern:** Heavy reliance on the `metrics` and `dashboards` database tables for configuration and retrieval of analytics data. Robust error handling and logging are consistently applied. Type definitions from `analytics.ts` are actively used for data structures.

*   **`src\services\analyticsExportService.ts` (Multiple Timestamps: 10/22/2025, 4:40:11 PM to 10/23/2025, 11:04:38 AM):**
    *   **Introduction of `getExportData`:** This function is responsible for generating data for Excel export.
    *   It takes various query parameters (`fromDate`, `toDate`, `reportName`, `columns`, `booking`, etc.) to construct dynamic SQL queries.
    *   It uses `getUserObject` to get company-specific user info.
    *   It dynamically selects columns using `columnsQuery` and attempts to save the selected columns using `saveColumns`.
    *   It distinguishes between `booking` and `nonBooking` reports, calling `bookingQuery` or `nonBookingQuery` accordingly.
    *   Includes specific logic for "TEU MBLwise" reports to handle duplicate container entries.
    *   **`replaceColumnHandler`:** A utility function introduced to replace specific values (e.g., "LONG BEACH" with "LOS ANGELES") in the exported data for `pod` and `place_of_delivery` columns.
    *   **Pattern:** Focus on dynamic SQL query construction for reporting, data transformation, and date handling. Error handling and logging are present.

*   **`src\common\util\export.query.ts` (Multiple Timestamps: 10/22/2025, 4:46:51 PM to 10/22/2025, 6:05:51 PM):**
    *   Introduced `getMonthValue` helper for converting month names/numbers.
    *   Defines `bookingQuery` function, which generates complex SQL query fragments based on `reportName`, `CompanyName`, and various filters (month, week, quarter, stacked group, display by). This function builds parts of the main query used by `analyticsExportService`.
    *   **Pattern:** Contains extensive, hardcoded SQL query strings for specific report types, indicating a report-driven database interaction model.

*   **`src\utils\analytics.ts` (Multiple Timestamps: 10/22/2025, 4:43:56 PM to 10/22/2025, 5:11:25 PM):**
    *   **`defaultDateRange`:** Utility to provide a default date range (current date to 365 days prior).
    *   **`replaceValueInQuery`:** Helper to generate SQL `CASE` statements for column value replacement (e.g., `pod` from 'LONG BEACH' to 'LOS ANGELES').
    *   **`getUserObject`:** Retrieves user information, potentially adjusting `usercode` and `companyname` based on `access` rights (e.g., for ADMINs).
    *   **`getFilterQueryByDisplayValue`:** Generates SQL `GROUP BY`, `ORDER BY`, `dateTrunc`, and `SELECT` clauses based on how data should be displayed (month, week, quarter).
    *   **`getExcelSelectedColumns`:** Selects appropriate columns for Excel export based on `reportName` and `isBooking` flag. It includes common, booking-specific, and other detailed columns.
    *   **`isValidDate` and `dateFilterOnExport`:** Utilities for validating date strings and formatting date fields within data objects for export.
    *   **`EXCEL_EXPORT_COLUMNS`:** A large array defining the columns and their display names for Excel exports.
    *   **Pattern:** Contains a collection of helper functions and constants crucial for analytics processing, data manipulation, date handling, and SQL query generation. There's a strong focus on ensuring data quality and appropriate formatting for reporting.

**Timestamps of Significant Changes:**

*   **10/22/2025, 12:19:46 PM:** Initial expansion of `Paths.ts` with comprehensive `Analytics` endpoints.
*   **10/22/2025, 12:26:53 PM:** First commit of `coreViewService.ts` establishing core CRUD operations for analytics views and audit logging.
*   **10/22/2025, 12:34:42 PM:** `analyticsRoutes.ts` fully integrates basic CRUD for analytics views from `coreViewService`.
*   **10/22/2025, 12:46:12 PM:** `coreViewService.ts` refines database queries with parameterized statements and improved type safety.
*   **10/22/2025, 4:11:25 PM:** `analytics.ts` types are significantly expanded to support dashboard items and metric lists.
*   **10/22/2025, 4:11:45 PM:** First commit of `coreMetricService.ts` introducing logic for dashboard endpoints, metric lists, and sorting.
*   **10/22/2025, 4:27:44 PM:** `coreMetricService.ts` adds `saveSequence` and `saveSize` functionalities, indicating user customization for dashboards.
*   **10/22/2025, 4:38:37 PM:** `analyticsRoutes.ts` integrates `saveSequence` and `saveSize` from `coreMetricService`.
*   **10/22/2025, 4:40:11 PM:** First commit of `analyticsExportService.ts` for handling Excel exports.
*   **10/22/2025, 4:46:51 PM:** First commit of `export.query.ts` containing complex, report-specific SQL query fragments.
*   **10/22/2025, 5:09:52 PM:** `analytics.ts` (utils) receives significant type and utility function improvements, including robust date handling and user object processing.

**Patterns and Recurring Elements:**

1.  **Analytics-Centric Development:** The overwhelming majority of changes are dedicated to building out a robust analytics system, including custom dashboards, metric management, and data export.
2.  **Modular Structure:** The use of `Paths.ts` for constants, dedicated route files, service layers (`coreViewService`, `coreMetricService`, `analyticsExportService`), and utility files (`analytics.ts`, `export.query.ts`) indicates a clear attempt at modular and organized code.
3.  **Database Interaction:** There's a strong pattern of direct database querying (using a `query` utility) for all analytics operations, including fetching, creating, updating, and deleting dashboards/metrics, and generating reports. SQL queries are often dynamic, constructed from multiple parameters.
4.  **Type Safety (TypeScript):** Progressive addition and refinement of TypeScript interfaces (`CheckBoxDetails`, `MenuRow`, `DashboardItem`, `MetricListDataI`, `MetricRow`, `User`, `UserRow`, `AnalyticsControllerQuery`, `saveSeqI`, `SizeData`, `DataItem`) throughout the changes, particularly in service files and models, highlight an effort to improve code maintainability and reduce runtime errors.
5.  **Logging and Error Handling:** `logger.info(error)` and `res.status(500).json({ message: "Internal Server Error" })` are consistently present in `try-catch` blocks across all service functions, indicating a focus on operational stability and debugging.
6.  **User-Specific Customization:** Features like saving dashboard view sequences, metric sizes, and fetching user-specific dashboard data indicate a strong emphasis on personalized analytics experiences.
7.  **Dynamic Query Generation:** Several utilities (`columnsQuery`, `bookingQuery`, `nonBookingQuery`, `getFilterQueryByDisplayValue`) are designed to construct SQL queries dynamically based on user input or report type.
8.  **Data Transformation:** Functions like `dateFilterOnExport` and `replaceColumnHandler` are used to clean, format, and transform data before it's sent to the client, especially for exports.
9.  **Auditing:** The `logAudit` function in `coreViewService` indicates that changes to user-defined dashboards are being tracked for accountability.

## 3:14:26 PM
The `analytics.route.ts` file, updated on 10/22/2025 at 11:01:53 AM, defines a comprehensive set of API routes for an analytics module.

**File-Specific Updates:**
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\analytics.route.ts`**: This file acts as a central router for analytics functionalities. It imports a wide array of controllers from the `analytics` directory, including `core.view.controller`, `core.metric.controller`, `cbm.controller`, `kgs.controller`, `teu.controller`, `container.controller`, `transit.controller`, `others.controller`, and `core.export.controller`.
*   The routes cover:
    *   **Dashboard Management**: Full CRUD operations (GET all, POST create, PUT update, DELETE) are exposed under `/dashboards`.
    *   **Metric and Endpoint Discovery**: Endpoints like `/dashboardEndPoints` and `/metricsList` are available to retrieve lists of available analytics endpoints and metrics.
    *   **Data Export**: A route `/excelExport` is defined for exporting data.
    *   **User Preferences**: Routes `/save_sequence` and `/save_size` allow users to save their preferences related to display sequence and size.
    *   **Specific Reports**: Dedicated GET routes are provided for various reports, including `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and a general `/Tables/tableData` endpoint, each handled by its respective controller.

**Patterns and Recurring Elements:**
*   The API design follows a RESTful pattern, using standard HTTP methods (GET, POST, PUT, DELETE) for different operations on resources like `dashboards`.
*   There's a clear modularity, with different analytics concerns (views, metrics, CBM, KGS, etc.) being handled by separate, dedicated controllers and then aggregated into this single router file.
*   Many routes are specifically for retrieving analytical reports (e.g., `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`), indicating a strong focus on data reporting.
*   The timestamps consistently show changes happening on 10/22/2025, suggesting a single session or a concentrated period of development activity for these changes.

## 3:15:30 PM
The core of these changes centers around the development and refinement of a new "Analytics" feature set within the T360-V2 backend, predominantly occurring on **October 22, 2025**.

**Key Information by File:**

*   **`src\common\constants\Paths.ts`**
    *   **Timestamp:** 10/22/2025, 12:19:46 PM
    *   A significant expansion of API endpoints was introduced under a new `Analytics` section. This includes paths for fetching, creating, updating, and deleting dashboards (`/dashboards`, `/create`, `/update`, `/delete-view`), retrieving dashboard endpoint lists (`/dashboardEndPoints`), metric lists (`/metricsList`), Excel reports (`/excelExport`), saving metric sequences (`/save-sequence`), saving metric sizes (`/save_size`), and specific metrics like `cbm`, `kgs`, `teu`, `containers`, `transit`, and `tableData`.

*   **`src\routes\analyticsRoutes.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 12:20:38 PM to 10/22/2025, 4:38:37 PM.
    *   Initially, this file integrated dashboard-related services (`getDashboardCardInfo`, `getDeliveryData`). It rapidly evolved to become the central router for the new `Analytics` feature. By the end of the day, it was configured with dedicated routes for:
        *   `GET /dashboards` (from `coreViewService.getAll`)
        *   `POST /create` (from `coreViewService.create`)
        *   `PUT /update` (from `coreViewService.update`)
        *   `DELETE /delete-view` (from `coreViewService.deleteView`)
        *   `GET /dashboardEndPoints` (from `coreMetricService.dashboardEndPointList`)
        *   `GET /metricsList` (from `coreMetricService.getMetricList`)
        *   `POST /save-sequence` (from `coreMetricService.saveSequence`)
        *   `POST /save_size` (from `coreMetricService.saveSize`)
        *   `GET /excelExport` (from `analyticsExportService.getExportData`)
    *   This shows a clear progression from initial integration to a fully specialized analytics routing setup.

*   **`src\routes\index.ts`**
    *   **Timestamp:** 10/22/2025, 12:21:23 PM
    *   The main API router was updated to include the new `AnalyticsRoutes` under the `Paths.Analytics.Base` path, making the analytics functionalities accessible.

*   **`src\services\coreViewService.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 12:26:53 PM to 10/22/2025, 12:46:12 PM.
    *   This service was introduced and subsequently refined to manage user-specific dashboard views. It includes functions for:
        *   `getAll`: Retrieve all menu titles (dashboard names) for a user.
        *   `create`: Create a new dashboard view, saving its `menu_title` and `dashboard_metrics`. Includes a check for existing views and audit logging.
        *   `update`: Modify an existing dashboard's `menu_title` and `dashboard_metrics`. Includes audit logging.
        *   `deleteView`: Remove a dashboard view. Includes audit logging.
        *   `logAudit`: A helper function to record CREATE, UPDATE, and DELETE actions on dashboards in an `analytics_view_log` table.
    *   Throughout the changes, there was a consistent effort to improve type safety (e.g., using `IAuthReq`, `Response`, `NextFunction`, and specific interfaces like `CheckBoxDetails`, `MenuRow`) and enhance SQL query parameterization.

*   **`src\services\coreMetricService.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 4:11:45 PM to 10/22/2025, 4:38:20 PM.
    *   This service was added to handle metric-related operations for dashboards:
        *   `dashboardEndPointList`: Fetches configured dashboard metrics for a given user and dashboard title, including their display names, API endpoints, and layout information (row/column spans), ensuring they are sorted as per user preference.
        *   `getMetricList`: Retrieves a categorized list of available metrics (Container-Wise, MBL-Wise) and supports a "preload" feature to mark metrics already selected for a specific dashboard.
        *   `saveSequence`: Updates the order of metrics (`dashboard_metrics`) within a user's dashboard based on a provided sequence of report names. It also handles the creation of a "_Default_" dashboard if one doesn't exist.
        *   `saveSize`: Stores `columnSpan` and `rowSpan` properties for individual metrics in a dashboard's `size` column (JSONB format) in the `dashboards` table.
    *   Type safety was consistently improved with interfaces like `DashboardItem` and `MetricRow` and explicit type assertions.

*   **`src\services\analyticsExportService.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 4:40:11 PM to 10/23/2025, 11:04:38 AM.
    *   This service provides functionality for exporting analytics data to Excel:
        *   `getExportData`: Constructs complex, dynamic SQL queries to fetch data for various reports (booking and non-booking) based on user-provided parameters (date ranges, report name, grouping, columns). It includes logic to handle specific report types (e.g., TEU MBLwise deduplication) and a `replaceColumnHandler` to standardize "LONG BEACH" to "LOS ANGELES" in `pod` and `place_of_delivery` fields.
    *   The service was updated to use shared utility functions and types, improving modularity.

*   **`src\utils\analytics.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 4:43:56 PM to 10/22/2025, 5:11:25 PM.
    *   A collection of utility functions supporting analytics operations:
        *   `defaultDateRange`: Provides a default 1-year date range.
        *   `replaceValueInQuery`: A SQL helper for conditional string replacement in queries.
        *   `getUserObject`: Fetches user and company-specific information, including handling admin access.
        *   `getFilterQueryByDisplayValue`: Generates SQL clauses for grouping and ordering data by month, week, or quarter.
        *   `getExcelSelectedColumns`: Selects specific columns for Excel exports based on the report type.
        *   `dateFilterOnExport`: Filters and formats date values in export data.
        *   `EXCEL_EXPORT_COLUMNS`: A predefined list of common columns for Excel exports.
    *   Significant effort was made to introduce and refine TypeScript interfaces (`User`, `UserRow`, `DataItem`) and type assertions for better code robustness and maintainability.

*   **`src\common\util\export.query.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 4:46:51 PM to 10/22/2025, 6:05:51 PM.
    *   This file was introduced to house complex SQL query fragments, primarily `bookingQuery`, which dynamically generates parts of SQL statements for various booking-related analytics reports, incorporating filters for stacked exports, display by month/week/quarter, and specific data groupings. It includes a `getMonthValue` helper for date transformations.

*   **`src\models\common\types\analytics.ts`**
    *   **Timestamps:** Multiple changes from 10/22/2025, 12:27:34 PM to 10/22/2025, 4:36:01 PM.
    *   This file defines critical interfaces for analytics data structures, evolving to include:
        *   `CheckBoxDetails`: For metrics selection state.
        *   `MenuRow`: For dashboard menu titles, metrics IDs, dashboard metrics, and size information.
        *   `DashboardItem`: For individual items displayed on a dashboard, including ID, name, endpoint, and dashboard name.
        *   `MetricListDataI`: For metric details in a list, including group and filter criteria.
        *   `MetricRow`: For basic metric ID and name.

**Patterns and Recurring Elements:**

*   **Analytics-Centric Development:** The entire log reflects a concerted effort to build out a robust analytics system, from defining API routes to implementing core logic for dashboard management, metric display, and data export.
*   **Modular Architecture:** New services and utility files were created (`coreViewService`, `coreMetricService`, `analyticsExportService`, `export.query.ts`, `analytics.ts`), indicating a clear separation of concerns.
*   **Timestamp Clustering:** Almost all development activity happened on **October 22, 2025**, suggesting a dedicated development push or a single large feature branch merge. Minor changes on the 23rd were non-functional cleanups or small adjustments.
*   **Database Interaction:** Frequent use of a `query` function to interact with several database tables (`dashboards`, `metrics`, `analytics_view_log`, `mtr_user_master`) for CRUD operations and data retrieval.
*   **TypeScript and Type Safety:** A recurring theme is the introduction and continuous refinement of TypeScript interfaces and explicit type annotations across all new files, significantly improving code maintainability and reducing potential runtime errors.
*   **Dynamic SQL Generation:** Services frequently construct SQL queries dynamically based on user input, which is powerful but requires careful handling to prevent SQL injection (parameterized queries were introduced in some cases).
*   **Standardized Data Handling:** Specific logic for data standardization, such as mapping "LONG BEACH" to "LOS ANGELES", is evident in export functions.
*   **User and Authentication Context:** Most service functions accept an `IAuthReq` (Authenticated Request) and utilize `req.user` to perform user-specific operations, indicating an emphasis on personalized dashboard experiences and secure data access.