# Activity Summary for 10/30/2025

## 10:49:53 AM
The provided log details changes across three files within an analytics backend system, primarily focusing on query generation and data export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 10/29/2025, 1:17:31 PM):**
    *   This file, responsible for fetching table data reports, has undergone significant expansion. The `getTableDataReports` function now includes a much larger `else if` block to handle numerous new `type` values related to `booking` and `cargo-ready` analytics. These new types include various calculations of time differences between dates (e.g., `BookingDatetoActualDeparture`, `BookingDatetoCargoReady`, `CargoReadyDatetoEstDepartureDate`) and their "MblWise" and "StackedBar" counterparts.
    *   Previously commented-out code for `ContainerShippedMblWise` using `mblQueryBuilder` is now fully removed, indicating a shift in how this specific report type is handled or a consolidation into other query builders.
    *   The `mainQuery` logging now includes the `type` parameter for better debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Multiple timestamps from 10/29/2025, 1:36:20 PM to 10/29/2025, 9:34:16 PM):**
    *   This controller handles data export. A key change is the modification of the `mblWiseQuery` construction. Initially, the `DISTINCT ON` clause for non-MBL wise queries specifically referenced `t49_cont_type` and `cont_type` without the `m.` alias. Later updates (1:41:44 PM) prefixed these with `m.`, indicating a correction to ensure the correct table column is referenced.
    *   Around 1:41:44 PM, error handling in the `catch` block was updated to include `error.message`.
    *   There were several identical updates around 6:00 PM, primarily adding more `console.log` statements for debugging `mblWiseQuery`, `COLUMNS`, and `customQuery` within the `if(isBooking)` block.
    *   A significant fix was introduced at 6:26:45 PM to correctly structure the `mainQuery` for booking-related exports. It now explicitly checks if `customQuery` already contains a `WHERE` clause to appropriately prepend `AND` or `WHERE` for date filtering, preventing SQL syntax errors.
    *   A major update at 10/29/2025, 9:33:01 PM introduces special handling for the "Containers Shipped (Mbl Wise)" report within the `if(isBooking)` block. This report now generates an aggregated query using a `WITH` clause to first select distinct MBLs with their `final_delivery_date` and `quarter`, then aggregates these results by month and quarter, counting distinct MBLs. This means this specific report type bypasses the general `SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery}` structure.
    *   The `replaceColumnHandler` function consistently maps 'LONG BEACH' to 'LOS ANGELES' for both `pod` and `place_of_delivery` fields across all versions of this file.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Multiple timestamps from 10/29/2025, 1:52:59 PM to 10/30/2025, 12:29:19 AM):**
    *   This file defines SQL query snippets for various analytics reports.
    *   Early changes expanded the `query` object with new report types, including "Booking Date to POD Arrival" and its MBL-wise counterpart.
    *   The "Container Shipped (MBL Wise)" report's SQL query evolved significantly. Initially, it was a simple `SELECT` statement (9:02:36 PM). Later, it was restructured (9:10:49 PM) to include `final_delivery_date` and `quarter` calculations based on `delivery_customer_date` or `updated_inland_arv_date`.
    *   Further refinement for "Containers Shipped (MBL Wise)" (9:23:10 PM) converted it into an aggregated query. It now selects `month` and calculates counts for "This Quarter" and "Last Quarter" based on a subquery that determines `final_delivery_date` and `quarter` for each MBL. This version uses `DATE_TRUNC('month', final_delivery_date)` for grouping and ordering.
    *   At 12:05:05 AM (10/30/2025), the "Containers Shipped (Mbl Wise)" query was refined again to format the month as 'Mon ''YY' and to calculate 'This Quarter' and 'Last Quarter' based on relative time intervals from `CURRENT_DATE`. It also directly counts distinct MBLs within this aggregated query, simplifying the subquery structure in comparison to the 9:23:10 PM version.
    *   Finally, the query for "Containers Shipped (Mbl Wise)" was reverted back to a detailed `SELECT * FROM (SELECT DISTINCT ON ...)` structure with calculated `final_delivery_date`, `month`, and `quarter` fields within the main select, and removed the outer aggregation logic (12:07:29 AM, 12:22:35 AM). It appears there was an attempt to simplify or modify the aggregation but it was later reverted or combined with the main query directly for columns. The very last change (12:28:49 AM, 12:29:19 AM) appears to be a reformatting and slight adjustment to the previous version, focusing on the `CASE WHEN` logic for `quarter` calculation and ensuring correct aliases.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Multiple timestamps from 10/29/2025, 2:06:58 PM to 10/30/2025, 10:48:56 AM):**
    *   This file defines SQL query builders for booking-related analytics reports. The `bookingQueryBuilder` function contains extensive `if-else if` logic to generate specific SQL queries based on the `type` parameter.
    *   Multiple identical changes are recorded for this file across several timestamps (e.g., 2:15:12 PM, 2:16:08 PM, 2:45:45 PM, and many subsequent identical timestamps up to 10/30/2025, 10:48:56 AM). These identical entries suggest repeated saves without functional changes to the displayed code segment, or minor non-functional changes not captured in the snippet. The constant content for these timestamps focuses on queries for:
        *   `BookingDatetoActualDeparture` (average day difference between dates, non-MBL wise).
        *   `BookingDatetoActualDepartureMblWise` (average day difference between dates, MBL wise).
        *   `BookingDatetoActualDepartureStackedBar` (stacked bar chart data, non-MBL wise, categorizing time differences into 'Less than 1 week', '1 - 2 weeks', etc.).
        *   `BookingDatetoActualDepartureMblWiseStackedBar` (stacked bar chart data, MBL wise).
    *   The structure for these queries consistently includes `DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL ... ELSE m.cont_type END)` for non-MBL wise reports, and `DISTINCT ON (LOWER(m.mblno))` for MBL-wise reports, ensuring uniqueness based on container or MBL.
    *   All queries filter by `account_name` (CompanyName) and a date range (`departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`).
    *   The `customizer` object is consistently updated with `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `chartType`, and `calColumnConfig` based on the report type.
    *   The `getColumnsByCategory` utility function is used to dynamically select columns, ignoring `country_name`, `networkdays`, `bl_release_date` but always including `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, `departure_date`.

**Recurring Elements and Patterns:**

*   **Analytics Context:** All changes are within an "analytics" module, indicating a continuous development cycle for reporting and data analysis features.
*   **Timestamp Pattern:** All timestamps fall on `10/29/2025` or `10/30/2025`, suggesting a focused development effort over these two days.
*   **Database Interaction:** The `query` function (presumably from `../../config/database`) is central to fetching data in all controllers. SQL queries are dynamically constructed using template literals and injected parameters.
*   **Date Handling:** A `defaultDateRange` utility is used if `fromDate` or `toDate` are missing. Date comparison and extraction (e.g., `EXTRACT(DAY FROM ...)`, `DATE_PART('day', ...)`, `DATE_TRUNC`) are common in the SQL queries.
*   **Company and User Specificity:** Queries consistently filter by `CompanyName` and `user_id` obtained via `getUserObject`, ensuring data segregation based on user and company.
*   **Report Type Driven Logic:** The `type` parameter (e.g., `'BookingDatetoActualDeparture'`, `'Containers Shipped (Mbl Wise)'`) dictates the specific SQL query and customizer configurations. This pattern is prominent in both `others.controller.ts` and `booking.query.ts`.
*   **"MBL Wise" and "Stacked Bar" Variations:** Many report types have "MBL Wise" and "Stacked Bar" counterparts, indicating different aggregation or visualization requirements for the same core data points.
*   **Data Transformation/Normalization:** The `replaceColumnHandler` function is consistently used in `core.export.controller.ts` to standardize 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery`, suggesting a data quality or display requirement.
*   **Query Construction Helpers:** The `bookingQuery` in `export.query.ts` and `bookingQueryBuilder` in `booking.query.ts` demonstrate a modular approach to building complex SQL queries based on report specifics and user selections.
*   **Debugging/Logging:** Frequent `console.log` and `logger.info` statements, particularly in `core.export.controller.ts`, suggest active debugging and monitoring during these changes.
*   **Query Safety:** The update to handle the `WHERE` clause dynamically (`customQuery.toLowerCase().includes("where") ? ... : ...`) in `core.export.controller.ts` at 6:26:45 PM indicates a focus on preventing SQL injection or syntax errors when combining query parts.
*   **Container/MBL Distinctness:** The `DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL ... ELSE m.cont_type END )` and `DISTINCT ON (LOWER(m.mblno))` clauses are repeatedly used to ensure unique records for container and MBL related queries.