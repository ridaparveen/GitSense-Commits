# Activity Summary for 10/30/2025

## 10:49:53 AM
The provided log details changes across three files within an analytics backend system, primarily focusing on query generation and data export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 10/29/2025, 1:17:31 PM):**
    *   This file, responsible for fetching table data reports, has undergone significant expansion. The `getTableDataReports` function now includes a much larger `else if` block to handle numerous new `type` values related to `booking` and `cargo-ready` analytics. These new types include various calculations of time differences between dates (e.g., `BookingDatetoActualDeparture`, `BookingDatetoCargoReady`, `CargoReadyDatetoEstDepartureDate`) and their "MblWise" and "StackedBar" counterparts.
    *   Previously commented-out code for `ContainerShippedMblWise` using `mblQueryBuilder` is now fully removed, indicating a shift in how this specific report type is handled or a consolidation into other query builders.
    *   The `mainQuery` logging now includes the `type` parameter for better debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Multiple timestamps from 10/29/2025, 1:36:20 PM to 10/29/2025, 9:34:16 PM):**
    *   This controller handles data export. A key change is the modification of the `mblWiseQuery` construction. Initially, the `DISTINCT ON` clause for non-MBL wise queries specifically referenced `t49_cont_type` and `cont_type` without the `m.` alias. Later updates (1:41:44 PM) prefixed these with `m.`, indicating a correction to ensure the correct table column is referenced.
    *   Around 1:41:44 PM, error handling in the `catch` block was updated to include `error.message`.
    *   There were several identical updates around 6:00 PM, primarily adding more `console.log` statements for debugging `mblWiseQuery`, `COLUMNS`, and `customQuery` within the `if(isBooking)` block.
    *   A significant fix was introduced at 6:26:45 PM to correctly structure the `mainQuery` for booking-related exports. It now explicitly checks if `customQuery` already contains a `WHERE` clause to appropriately prepend `AND` or `WHERE` for date filtering, preventing SQL syntax errors.
    *   A major update at 10/29/2025, 9:33:01 PM introduces special handling for the "Containers Shipped (Mbl Wise)" report within the `if(isBooking)` block. This report now generates an aggregated query using a `WITH` clause to first select distinct MBLs with their `final_delivery_date` and `quarter`, then aggregates these results by month and quarter, counting distinct MBLs. This means this specific report type bypasses the general `SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery}` structure.
    *   The `replaceColumnHandler` function consistently maps 'LONG BEACH' to 'LOS ANGELES' for both `pod` and `place_of_delivery` fields across all versions of this file.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Multiple timestamps from 10/29/2025, 1:52:59 PM to 10/30/2025, 12:29:19 AM):**
    *   This file defines SQL query snippets for various analytics reports.
    *   Early changes expanded the `query` object with new report types, including "Booking Date to POD Arrival" and its MBL-wise counterpart.
    *   The "Container Shipped (MBL Wise)" report's SQL query evolved significantly. Initially, it was a simple `SELECT` statement (9:02:36 PM). Later, it was restructured (9:10:49 PM) to include `final_delivery_date` and `quarter` calculations based on `delivery_customer_date` or `updated_inland_arv_date`.
    *   Further refinement for "Containers Shipped (MBL Wise)" (9:23:10 PM) converted it into an aggregated query. It now selects `month` and calculates counts for "This Quarter" and "Last Quarter" based on a subquery that determines `final_delivery_date` and `quarter` for each MBL. This version uses `DATE_TRUNC('month', final_delivery_date)` for grouping and ordering.
    *   At 12:05:05 AM (10/30/2025), the "Containers Shipped (Mbl Wise)" query was refined again to format the month as 'Mon ''YY' and to calculate 'This Quarter' and 'Last Quarter' based on relative time intervals from `CURRENT_DATE`. It also directly counts distinct MBLs within this aggregated query, simplifying the subquery structure in comparison to the 9:23:10 PM version.
    *   Finally, the query for "Containers Shipped (Mbl Wise)" was reverted back to a detailed `SELECT * FROM (SELECT DISTINCT ON ...)` structure with calculated `final_delivery_date`, `month`, and `quarter` fields within the main select, and removed the outer aggregation logic (12:07:29 AM, 12:22:35 AM). It appears there was an attempt to simplify or modify the aggregation but it was later reverted or combined with the main query directly for columns. The very last change (12:28:49 AM, 12:29:19 AM) appears to be a reformatting and slight adjustment to the previous version, focusing on the `CASE WHEN` logic for `quarter` calculation and ensuring correct aliases.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Multiple timestamps from 10/29/2025, 2:06:58 PM to 10/30/2025, 10:48:56 AM):**
    *   This file defines SQL query builders for booking-related analytics reports. The `bookingQueryBuilder` function contains extensive `if-else if` logic to generate specific SQL queries based on the `type` parameter.
    *   Multiple identical changes are recorded for this file across several timestamps (e.g., 2:15:12 PM, 2:16:08 PM, 2:45:45 PM, and many subsequent identical timestamps up to 10/30/2025, 10:48:56 AM). These identical entries suggest repeated saves without functional changes to the displayed code segment, or minor non-functional changes not captured in the snippet. The constant content for these timestamps focuses on queries for:
        *   `BookingDatetoActualDeparture` (average day difference between dates, non-MBL wise).
        *   `BookingDatetoActualDepartureMblWise` (average day difference between dates, MBL wise).
        *   `BookingDatetoActualDepartureStackedBar` (stacked bar chart data, non-MBL wise, categorizing time differences into 'Less than 1 week', '1 - 2 weeks', etc.).
        *   `BookingDatetoActualDepartureMblWiseStackedBar` (stacked bar chart data, MBL wise).
    *   The structure for these queries consistently includes `DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL ... ELSE m.cont_type END)` for non-MBL wise reports, and `DISTINCT ON (LOWER(m.mblno))` for MBL-wise reports, ensuring uniqueness based on container or MBL.
    *   All queries filter by `account_name` (CompanyName) and a date range (`departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`).
    *   The `customizer` object is consistently updated with `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `chartType`, and `calColumnConfig` based on the report type.
    *   The `getColumnsByCategory` utility function is used to dynamically select columns, ignoring `country_name`, `networkdays`, `bl_release_date` but always including `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, `departure_date`.

**Recurring Elements and Patterns:**

*   **Analytics Context:** All changes are within an "analytics" module, indicating a continuous development cycle for reporting and data analysis features.
*   **Timestamp Pattern:** All timestamps fall on `10/29/2025` or `10/30/2025`, suggesting a focused development effort over these two days.
*   **Database Interaction:** The `query` function (presumably from `../../config/database`) is central to fetching data in all controllers. SQL queries are dynamically constructed using template literals and injected parameters.
*   **Date Handling:** A `defaultDateRange` utility is used if `fromDate` or `toDate` are missing. Date comparison and extraction (e.g., `EXTRACT(DAY FROM ...)`, `DATE_PART('day', ...)`, `DATE_TRUNC`) are common in the SQL queries.
*   **Company and User Specificity:** Queries consistently filter by `CompanyName` and `user_id` obtained via `getUserObject`, ensuring data segregation based on user and company.
*   **Report Type Driven Logic:** The `type` parameter (e.g., `'BookingDatetoActualDeparture'`, `'Containers Shipped (Mbl Wise)'`) dictates the specific SQL query and customizer configurations. This pattern is prominent in both `others.controller.ts` and `booking.query.ts`.
*   **"MBL Wise" and "Stacked Bar" Variations:** Many report types have "MBL Wise" and "Stacked Bar" counterparts, indicating different aggregation or visualization requirements for the same core data points.
*   **Data Transformation/Normalization:** The `replaceColumnHandler` function is consistently used in `core.export.controller.ts` to standardize 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery`, suggesting a data quality or display requirement.
*   **Query Construction Helpers:** The `bookingQuery` in `export.query.ts` and `bookingQueryBuilder` in `booking.query.ts` demonstrate a modular approach to building complex SQL queries based on report specifics and user selections.
*   **Debugging/Logging:** Frequent `console.log` and `logger.info` statements, particularly in `core.export.controller.ts`, suggest active debugging and monitoring during these changes.
*   **Query Safety:** The update to handle the `WHERE` clause dynamically (`customQuery.toLowerCase().includes("where") ? ... : ...`) in `core.export.controller.ts` at 6:26:45 PM indicates a focus on preventing SQL injection or syntax errors when combining query parts.
*   **Container/MBL Distinctness:** The `DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL ... ELSE m.cont_type END )` and `DISTINCT ON (LOWER(m.mblno))` clauses are repeatedly used to ensure unique records for container and MBL related queries.

## 11:49:49 AM
The changes primarily affect two files related to analytics and data export functionalities within a backend application: `booking.query.ts` and `core.export.controller.ts`. The timestamps of these changes span from October 29, 2025, 5:01:49 PM to October 30, 2025, 11:48:05 AM, indicating active development during this period.

**File-specific Updates:**

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   This file, responsible for constructing SQL queries for booking-related analytics, underwent frequent minor modifications.
    *   **Timestamp:** Changes are logged between 10/29/2025, 5:01:49 PM and 10/30/2025, 11:09:18 AM.
    *   **Content:** The code content remained largely identical across all logs for this file, suggesting a series of saves or very minor, unlogged changes (e.g., whitespace, formatting) that are not discernable in the provided diffs. The core logic for `bookingQueryBuilder` and its conditional query generation based on `type` (e.g., `'BookingDatetoActualDeparture'`, `'BookingDatetoActualDepartureMblWise'`, `'BookingDatetoActualDepartureStackedBar'`) remained consistent.
    *   **Pattern:** Each entry for this file shows the *exact same code snippet*, implying no functional changes within the provided logs for this specific file. This is highly unusual for a typical development log and might indicate an issue with how the log was generated or filtered, or simply repeated saves without actual code modifications.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   This file handles the export of analytics data, processing incoming requests and building SQL queries using the `bookingQuery` and `nonBookingQuery` functions.
    *   **Timestamp:** Significant changes were recorded between 10/29/2025, 5:59:50 PM and 10/30/2025, 11:48:05 AM.
    *   **Content:**
        *   **Initial state (10/29/2025, 5:59:50 PM):** The `getExportData` function constructs `mainQuery` for booking and non-booking reports. For booking reports, it includes `mblWiseQuery`, `COLUMNS`, `customQuery`, and date filters directly concatenated.
        *   **Intermediate change (10/29/2025, 6:05:52 PM):** A comma was added before `customQuery` in the `mainQuery` string for booking reports: `... ${COLUMNS}, ${customQuery} ...`. This was likely a syntax fix.
        *   **Reversion (10/29/2025, 6:08:29 PM):** The comma added in the previous step was removed, reverting to `... ${COLUMNS} ${customQuery} ...`.
        *   **Minor Reversion (10/29/2025, 6:09:55 PM):** The comma was re-added. The code flips back and forth.
        *   **Attempted Fix (10/29/2025, 6:15:39 PM):** A more robust check was added for the `customQuery` to ensure a leading comma if it doesn't already start with one: `... ${customQuery.startsWith(',') ? customQuery : ',' + customQuery} ...`.
        *   **Major Refactoring & Bug Fix (10/29/2025, 6:26:45 PM):**
            *   The `mblWiseQuery` variable's template literal was slightly reformatted (`mblwise === "true" ? ... : ...`) but functionally remained the same.
            *   A significant logic change was introduced to the `mainQuery` construction for booking reports:
                *   A comment `// 🧠 FIXED: close customQuery with parentheses and move your date filter inside a proper WHERE block` was added.
                *   The `mainQuery` now includes a conditional `WHERE` or `AND` clause for date filtering, depending on whether the `customQuery` already contains a `WHERE` clause (`${customQuery.toLowerCase().includes("where") ? ... : ...}`). This aims to prevent SQL syntax errors when combining subqueries.
                *   The outer `ORDER BY departure_date ASC` now explicitly references `data.departure_date`.
        *   **Reversion/Error Introduction (10/29/2025, 6:27:30 PM):** The "major refactoring" of the SQL query string for booking reports was reverted, going back to the less robust concatenation (`${COLUMNS} ${customQuery} AND ${filterBy} ...`). This seems like an accidental rollback or an attempt that was later discarded.
        *   **Later attempt to fix (10/30/2025, 9:33:01 PM):** A special condition was introduced for `reportName === "Containers Shipped (Mbl Wise)"`. For this specific report, `mainQuery` directly uses the `customQuery` (which is expected to be a full, aggregated `WITH` query), bypassing the standard `SELECT * FROM (...)` wrapper and standard date filtering logic. For other reports, the standard wrapping and date filtering continue. The logging for `filteredData` was updated to `filteredData.length`.
        *   **Reversion (10/30/2025, 9:34:16 PM):** The special handling for "Containers Shipped (Mbl Wise)" was removed, reverting the booking query construction to its earlier, less robust form.
        *   **Final Major Change (10/30/2025, 11:28:18 AM):** The special handling for queries starting with "WITH" (implying a complex subquery) was re-introduced and refined. If `customQuery` starts with "WITH", it is used directly as `mainQuery`. Otherwise, the standard wrapping (`SELECT * FROM (SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery} AND ${filterBy} ...)`) is applied. This suggests a pattern of iterating on how to handle complex custom queries.

**Patterns and Recurring Elements:**

*   **File `booking.query.ts` consistency:** Despite multiple timestamps, the content of `booking.query.ts` is identical across all provided logs, indicating no effective code changes in this file. This suggests either a logging artifact or repeated, non-functional saves.
*   **File `core.export.controller.ts` iteration on query building:** This file shows a clear pattern of iterative attempts to correctly construct `mainQuery` for different report types, particularly for "booking" reports.
    *   There's a struggle with correctly handling the inclusion of `customQuery` and date filters within the main SQL query, including attempts to add/remove commas and conditional `WHERE`/`AND` clauses.
    *   A major pattern is the evolution of handling *complex, pre-formatted queries* (like those for "Containers Shipped (Mbl Wise)") that might already include their own `WITH` clauses or aggregation logic. The code moved from simple string concatenation to checking if `customQuery` itself is a complete query (starting with "WITH") and using it directly.
*   **"Booking Date to Actual Departure" variations:** Both files repeatedly reference variations of "Booking Date to Actual Departure" (e.g., standard, MBL-wise, stacked bar) for analytics and export. This indicates these are key report types.
*   **Date filtering logic:** A consistent date filtering pattern is applied: `AND ${filterBy} >= '${fromDate}'::timestamp AND ${filterBy} < '${toDate}'::timestamp + INTERVAL '1 day'`. This logic appears in both files and across various report types.
*   **`replaceColumnHandler` function:** This utility function is consistently present and used in `core.export.controller.ts` to transform `pod` (Port of Discharge) and `place_of_delivery` values from 'LONG BEACH' to 'LOS ANGELES', suggesting a data normalization requirement.
*   **User Object and Permissions:** `getUserObject` and `saveColumns` are consistently used to retrieve user information and save column preferences, highlighting user-specific customization and data persistence.
*   **Error Handling:** Both files include `try-catch` blocks for robust error handling, logging errors, and returning a 500 status on internal server errors.
*   **Logger usage:** `logger.info` is used for debugging and tracking column usage and main query generation.

## 12:53:11 PM
The `ViewContainer.jsx` component, updated at 10/28/2025, 2:02:33 PM and 3:48:07 PM, is responsible for managing custom analytics dashboard views. It handles the creation, editing, and deletion of user-defined dashboards, including the selection of up to 9 metrics using checkboxes. The component integrates with Redux for state management and interacts with an analytics API to save and fetch dashboard configurations. A debugging `console.log` statement was added to inspect `viewOptions`.

The `TreeViewContianer.jsx` component, timestamped 10/28/2025, 2:04:34 PM, 3:46:33 PM, and 3:46:51 PM, displays hierarchical analytics metrics in a tree structure. It received a temporary debugging modification at 3:46:33 PM (adding "kk" to a label) which was promptly reverted at 3:46:51 PM.

The `src\config\analytics.js` file, with multiple timestamps between 10/28/2025, 3:35:37 PM and 10/29/2025, 11:56:24 AM, defines core analytics configurations. This includes default API endpoints, columns for Excel exports, and a comprehensive mapping of report names to their header columns (`ANALYTICS_REPORT_HEADER`). The primary functional change was the completion and addition of entries within `ANALYTICS_REPORT_HEADER` related to container metrics. Subsequent identical logs for this file suggest repeated saving without actual code changes.

`PlanboardCardView.jsx`, updated at 10/28/2025, 4:05:26 PM and 4:08:24 PM, renders planboard data in customizable card views. It fetches data and applies filters based on user selection. A `console.log` was added at 4:08:24 PM for debugging the fetched `planboardData`.

The `MetricFooter.jsx` component, updated at 10/29/2025, 9:56:31 AM and 9:57:53 AM, provides export functionalities (Excel and PDF) and a full-screen option for analytics charts. It introduced a `ColumnsSelector` for customized Excel exports. Debugging `console.log` statements were added to inspect `item` data.

`MetricToolbar.jsx`, modified frequently between 10/29/2025, 10:54:57 AM and 5:27:47 PM, is responsible for the filter and view controls of individual metrics. This file experienced numerous temporary changes, including toggling the visibility of period, view-by, and date range filters, as well as transient HTML insertions, indicating active UI development and debugging. A `console.log` statement was added to monitor the `toolState`.

`MetricsBox.jsx`, updated between 10/29/2025, 11:02:52 AM and 12:11:06 PM, acts as a container for displaying various analytics charts. It dynamically renders chart types and includes functionality for enlarging charts. Similar to `MetricToolbar`, it saw temporary commenting/uncommenting of the `MetricToolbar` component, suggesting UI integration testing. Multiple `console.log` statements were added for debugging purposes.

The `methods.js` utility file, with significant changes at 10/29/2025, 11:18:07 AM and 11:25:01 AM, provides helper functions for analytics data processing and report generation. Key updates included refining the `metricsPackageHandler` for chart type detection (removing a specific report name check for `StackedBar`), and enhancing the `downloadReportSpreadsheet` function to handle `selectedColumns` for Excel export.

The `StackedBarChart.jsx` component was extensively modified between 10/29/2025, 11:45:45 AM and 5:20:39 PM. It showed an iterative development process to correctly handle data for stacked bar charts, particularly concerning quarter-over-quarter comparisons and different time period filters (month, week, quarter). The logic for generating chart categories and series was frequently refined, with changes being introduced and sometimes reverted to explore different data structuring approaches. This component also featured numerous `console.log` statements for debugging.

Finally, `AnalyticsContainer.jsx`, updated at 10/29/2025, 4:53:53 PM, is the main component orchestrating analytics metrics. It supports drag-and-drop reordering and resizing of metrics using `DndProvider`. It integrates Redux state and interacts with APIs to fetch reports and persist metric sequence and size changes, using helper functions from `methods.js` to process data.

**Key Patterns and Recurring Elements:**

*   **Debugging:** The logs show a strong pattern of developers adding and removing `console.log` statements across almost all files, indicating active and iterative debugging.
*   **UI Iteration:** Frequent commenting out and uncommenting of UI components (e.g., in `MetricToolbar.jsx` and `MetricsBox.jsx`) suggests active experimentation and refinement of user interface elements.
*   **Analytics Feature Development:** There's a clear focus on enhancing analytics features, including custom view management, flexible report generation, and robust chart rendering, especially for stacked bar charts.
*   **State Management and API Integration:** Redux is consistently used for managing application state, and interactions with backend APIs are central to data fetching, saving, and updating configurations.
*   **Configuration Refinement:** The `analytics.js` configuration file is evolving to support more detailed report headers and export options.

## 1:52:51 PM
The provided log details a series of changes primarily focused on the frontend of an analytics dashboard, encompassing custom view management, metric display, filtering, and export capabilities.

**File-Specific Updates:**

*   **`ViewContainer.jsx` (10/28/2025):** This component, responsible for managing custom analytic views, underwent minor debugging additions. `console.log` statements were added to inspect `viewOptions` and `viewName`. Functionally, it allows users to create, edit, save, and delete dashboards, select up to 9 metrics from "Container Wise" and "MBL Wise" categories, and view audit logs. It interacts with Redux for state management and an API for dashboard operations.

*   **`TreeViewContianer.jsx` (10/28/2025):** This component displays a hierarchical list of metrics for selection. A temporary string "kk" was briefly added and then removed from a metric label, indicating a quick UI test or debugging during development.

*   **`analytics.js` (Multiple timestamps 10/28/2025 - 10/30/2025):** This configuration file defines various analytics constants, including default API endpoints, columns for Excel exports, and comprehensive report headers (`ANALYTICS_REPORT_HEADER`) categorized by CBM, TEU, KGS, and Transit metrics. While many entries show identical content across timestamps, the initial entries corrected or expanded the `ANALYTICS_REPORT_HEADER` definition for container-related metrics. The numerous identical entries suggest frequent saves or minor, unrecorded changes being reverted.

*   **`PlanboardCardView.jsx` (10/28/2025):** This component, which renders planboard data in different views (yearly/monthly), had a `console.log` added to debug `planboardData`. It includes a `NoDataAvailable` component displaying a specific string "No Data Available123".

*   **`MetricFooter.jsx` (10/29/2025):** This component provides export functionality for analytics metrics. It added a `console.log` for debugging the `item` prop. Functionally, it supports displaying calculation chips, formula tooltips, and exporting data to Excel (with column selection) and PDF. A temporary "Excel1" label was present on the Excel export button.

*   **`MetricToolbar.jsx` (Multiple timestamps 10/29/2025):** This component handles filtering for metrics. It saw several rapid changes, including:
    *   Correction of a "Period1" label to "Period".
    *   Frequent commenting and uncommenting of the "Custom Date Range" popover panel.
    *   Brief addition and removal of debug HTML (`<h1>hhhhh</h1>`).
    *   Repeated commenting and uncommenting of the "Period", "View By", and "Filter" (date range) `SelectBoxLight` components.
    These changes indicate a dynamic and iterative development process for filter controls, possibly testing different UI configurations or debugging filter application. A `console.log` for `toolState` was also added.

*   **`MetricsBox.jsx` (Multiple timestamps 10/29/2025):** This component renders individual chart types and their associated toolbars/footers.
    *   It saw commenting and uncommenting of the `MetricToolbar` component, similar to `MetricToolbar.jsx`.
    *   Debugging `console.log` statements were added for `item` and `data`.
    *   The chart rendering logic for the non-enlarged view was updated to display only the first 9 data points (`item.data.slice(0, 9)`), implying a performance or layout optimization for the default view.

*   **`methods.js` (Multiple timestamps 10/29/2025):** This utility file for analytics was primarily subject to repetitive saves with identical content. One functional change involved simplifying the `findChartType` default logic in `metricsPackageHandler` to always return `AnalyticsChartType.General` rather than conditionally `AnalyticsChartType.Stackbar`.

*   **`StackedBarChart.jsx` (Multiple timestamps 10/29/2025):** This component, dedicated to stacked bar chart rendering, shows the most volatile change history:
    *   Initial setup included dynamic category generation and tooltip formatting.
    *   Early changes adjusted `plotOptions`, `dataLabels`, and `tooltip` styles.
    *   It underwent significant refactoring multiple times in `useEffect` and data preparation logic, particularly around handling "This Quarter" vs "Last Quarter" data and distinguishing it from general stacked metrics. This involved introducing `isQuarterData` flags and conditional data processing.
    *   There were several instances of implementing complex data aggregation and category generation based on period filters (`month`, `week`, `quarter`), followed by reverts to simpler or earlier implementations, and then re-implementing a more robust combined logic.
    *   Debugging `console.log` statements (`===hgdatta====`) were frequently added and removed. These repeated changes, including numerous reverts, suggest a challenging and iterative process to correctly process and visualize different data structures for stacked bar charts, especially quarter-over-quarter comparisons and period-based aggregations.

*   **`AnalyticsContainer.jsx` (10/29/2025):** This top-level analytics component was introduced, establishing a resizable grid layout for metrics using `react-dnd`. It implements functionalities for reordering metrics (`moveItem`), saving their sizes (`saveSize`), and updating their view types (`saveView`). It orchestrates fetching individual reports and updating the Redux state with processed data using `metricsPackageHandler`.

**Timestamps of Significant Changes:**

*   **October 28, 2025, 2:02:33 PM:** Initial implementation of `ViewContainer.jsx`, outlining core custom dashboard management.
*   **October 28, 2025, 3:37:47 PM:** Expansion/correction of `ANALYTICS_REPORT_HEADER` in `analytics.js`.
*   **October 29, 2025, 9:56:31 AM:** Initial detailed implementation of `MetricFooter.jsx` with export functionalities.
*   **October 29, 2025, 10:54:57 AM:** Initial detailed implementation of `MetricToolbar.jsx` with filtering options.
*   **October 29, 2025, 11:02:52 AM:** Initial detailed implementation of `MetricsBox.jsx` for dynamic chart rendering.
*   **October 29, 2025, 11:18:07 AM:** Initial detailed implementation of `methods.js` with various analytics utility functions.
*   **October 29, 2025, 11:20:37 AM:** Optimization in `MetricsBox.jsx` to limit initial data displayed in charts.
*   **October 29, 2025, 11:45:45 AM:** Initial implementation of `StackedBarChart.jsx`.
*   **October 29, 2025, 12:16:08 PM:** Introduction of smart detection for quarter-based data in `StackedBarChart.jsx`.
*   **October 29, 2025, 2:54:27 PM:** Major refinement to `StackedBarChart.jsx` data processing for robustness and error prevention. (Although later reverted and re-applied)
*   **October 29, 2025, 2:58:21 PM / 3:01:18 PM:** Refactoring in `StackedBarChart.jsx` to handle different period filters more explicitly.
*   **October 29, 2025, 3:36:07 PM / 3:37:11 PM:** Further attempts to solidify the `StackedBarChart.jsx` logic for quarter comparison and general stacked data.
*   **October 29, 2025, 4:53:53 PM:** Introduction of `AnalyticsContainer.jsx` integrating grid layout, drag-and-drop, and metric management.

**Patterns and Recurring Elements:**

*   **Frontend Analytics Focus:** The changes collectively show a strong focus on building a dynamic and interactive analytics dashboard, including custom views, data visualization (various chart types, especially stacked bars), and user interaction features like filtering, reordering, and data export.
*   **Redux for State Management:** Consistent use of Redux (via `@reduxjs/toolkit` and `react-redux`) across multiple components to manage application state, particularly for analytics data, filters, and user information.
*   **RTK Query for API Interaction:** Reliance on RTK Query (`@reduxjs/toolkit/query/react`) for fetching and mutating data, centralizing API interactions.
*   **MUI for UI Components:** Extensive use of Material-UI (MUI) components, indicating a standardized design system and component library.
*   **Iterative Refinement and Debugging:** Frequent `console.log` statements and repeated patterns of code changes (especially in `MetricToolbar.jsx` and `StackedBarChart.jsx`, where changes are made, reverted, and re-applied) suggest an active and often trial-and-error development process, particularly for complex data handling and UI logic.
*   **Date and Time Manipulation:** `moment.js` is used for date formatting, especially for filtering and displaying report periods.
*   **Export Functionality:** Consistent implementation of Excel (using `ExcelJS`) and PDF (using `jspdf` and `html2canvas`) export features for analytics reports.
*   **Clear Separation of Concerns:** Logic is well-separated into components (`ViewContainer`, `MetricToolbar`, `MetricFooter`, `MetricsBox`), chart-specific components (`StackedBarChart`), and utility files (`methods.js`, `analytics.js`).

## 3:31:53 PM
The log details changes across three TypeScript files responsible for analytics queries and exports in a `t360-backend` application.

**File-Specific Updates:**

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps (10/29/2025, 5:18:33 PM to 10/30/2025, 11:09:18 AM):** This file, containing the `bookingQueryBuilder` function, remained largely stable in terms of functional logic within the provided snippets. The core structure for handling different booking-related report types (e.g., `BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`) by constructing specific SQL queries did not change. Minor formatting adjustments (e.g., spacing around operators, interface syntax) were observed across some timestamps.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps (10/29/2025, 5:59:50 PM to 10/30/2025, 11:48:05 AM):** This controller (`getExportData`) manages the export of analytics data.
        *   Initial logic built `mainQuery` by combining `mblWiseQuery`, `COLUMNS`, and `customQuery` with date filters.
        *   Multiple changes occurred around how `customQuery` is integrated and how date filters are applied, indicating challenges in composing dynamic SQL. At one point (10/29/2025, 6:15:39 PM), explicit logic was added to prepend a comma to `customQuery` if missing. A more robust conditional `WHERE` clause insertion was attempted (10/29/2025, 6:26:45 PM) but then reverted (10/29/2025, 6:27:30 PM).
        *   Special handling for the "Containers Shipped (Mbl Wise)" report was introduced and subsequently reverted multiple times (e.g., 10/29/2025, 9:33:01 PM; 10/30/2025, 11:28:18 AM; 10/30/2025, 11:46:42 AM). This special handling aimed to use the `customQuery` directly if it was a complete CTE (Common Table Expression) based query, suggesting that some reports require a fully formed query from `bookingQuery` rather than a snippet.
        *   A `replaceColumnHandler` function consistently mapped 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery` columns.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps (10/29/2025, 6:03:39 PM to 10/30/2025, 11:26:54 AM):** This file defines SQL snippets returned by the `bookingQuery` function based on `reportName`.
        *   The "Containers Shipped (Mbl Wise)" report (and a singular "Container Shipped (MBL Wise)" variant) saw the most significant and volatile changes.
        *   Initially, it selected a long list of columns (10/29/2025, 6:03:39 PM).
        *   It then transitioned to an aggregated query calculating "This Quarter" and "Last Quarter" counts (10/29/2025, 9:13:06 PM), then back to a simpler form (10/30/2025, 12:05:05 AM).
        *   A complex CTE-based aggregation for "Containers Shipped (Mbl Wise)" was introduced (10/30/2025, 12:07:29 AM), including a critical bug of hardcoding `account_name = 'sp richards company'` and specific dates within the query string, rather than using the passed `CompanyName` and `fromDate`/`toDate` parameters. This hardcoding was temporarily fixed (10/30/2025, 12:22:35 AM) but re-introduced in subsequent revisions (10/30/2025, 12:27:12 AM).
        *   The final state in the log for this specific report (10/30/2025, 11:26:54 AM) is a highly complex, multi-CTE query attempting to select many detailed columns along with aggregated quarterly data, still containing the critical hardcoded `account_name` and date ranges.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **Timestamp (10/30/2025, 1:59:03 PM):** This file defines the `getTableDataReports` controller.
        *   It acts as a dispatcher, delegating query construction to various builders (`chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`, `mblQueryBuilder`).
        *   It includes a `codeCustomization` flag, which is `true` for `TotalShipments` reports, indicating that some reports have their data processed differently (e.g., not just raw SQL execution).
        *   A commented-out block for `ContainerShippedMblWise` suggests it previously had custom logic for that specific report type, potentially involving `mblQueryBuilder`.

**Timestamps of Significant Changes:**

*   **10/29/2025, 6:15:39 PM (`core.export.controller.ts`):** Introduction of logic to conditionally add a comma before `customQuery` in the main SQL string, improving query construction robustness.
*   **10/29/2025, 6:26:45 PM (`core.export.controller.ts`):** Attempted introduction of conditional `WHERE` clause handling (later reverted).
*   **10/29/2025, 9:13:06 PM (`export.query.ts`):** Major refactor of "Containers Shipped (Mbl Wise)" query to a complex, aggregated CTE structure, with initial hardcoding issues.
*   **10/29/2025, 9:28:16 PM (`export.query.ts`):** Further refinement of the "Containers Shipped (MBL Wise)" aggregated query, including a change in month formatting.
*   **10/30/2025, 12:22:35 AM (`export.query.ts`):** **Critical fix**: Dynamic `CompanyName` parameter correctly integrated into the "Containers Shipped (Mbl Wise)" query, replacing hardcoded values.
*   **10/30/2025, 12:27:12 AM (`export.query.ts`):** **Critical regression**: "Containers Shipped (Mbl Wise)" query significantly rewritten again, re-introducing hardcoded `account_name` and specific date ranges. The query also became overly complex, attempting to merge detailed column selection with aggregation.
*   **10/30/2025, 11:28:18 AM (`core.export.controller.ts`):** Introduced a conditional check to use `customQuery` directly if it starts with `WITH` (for complex CTE queries), otherwise wrap it in a standard `SELECT * FROM (...)` structure. This was later reverted, then implicitly handled differently.

**Patterns and Recurring Elements in Content:**

*   **Dynamic SQL Construction:** A central theme is the construction of dynamic SQL queries using template literals and injecting parameters like `CompanyName`, `fromDate`, `toDate`, and `displayBy`.
*   **Date Range Filtering:** Nearly all SQL queries apply date filtering using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.
*   **Company-Specific Filtering:** Queries consistently filter by company name using `LOWER(account_name) = '${CompanyName}'` or similar variations.
*   **Report-Specific Logic:** The system uses distinct `if/else if` blocks in `bookingQueryBuilder` and a map in `export.query.ts` to handle diverse reporting requirements, indicating a modular approach to query generation based on report type.
*   **"Stacked Bar" Reports:** These reports (`BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`) consistently categorize date differences into fixed weekly bins (`Less than 1 week`, `1 - 2 weeks`, etc.) for aggregated views.
*   **MBL-Wise/Container-Wise Differentiation:** Queries frequently utilize `DISTINCT ON` clauses (`DISTINCT ON (m.voyage,m.contno, ...)` or `DISTINCT ON (LOWER(m.mblno))`) to ensure uniqueness based on container or master bill of lading.
*   **Data Transformation Post-Query:** The `core.export.controller.ts` includes `dateFilterOnExport` and `replaceColumnHandler` functions, suggesting some common post-processing or data manipulation steps are applied after fetching raw data from the database. Notably, 'LONG BEACH' is consistently remapped to 'LOS ANGELES'.
*   **Logger Usage:** `logger.info` calls are spread throughout the `core.export.controller.ts` for debugging and tracing execution flow and query values.
*   **Inconsistencies and Regressions:** The frequent changes and reverts in `core.export.controller.ts` regarding query wrapping, and especially the re-introduction of hardcoded values and complex, possibly incorrect, query structures in `export.query.ts` for the "Containers Shipped (Mbl Wise)" report, highlight an iterative development process that sometimes introduces or re-introduces issues.

## 4:30:57 PM
The code changes primarily focus on refining analytics report generation, specifically for export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamp:** The earliest significant change is at `10/29/2025, 6:12:06 PM`, establishing the initial structure. Most intensive development on this file occurred between `10/29/2025, 9:02:36 PM` and `10/30/2025, 11:38:49 AM`.
    *   **Key Updates:** This file underwent several revisions, particularly for the `"Container Shipped (MBL Wise)"` and `"Containers Shipped (Mbl Wise)"` reports.
        *   Initially, queries were mostly simple SQL fragments calculating date differences.
        *   The "Container Shipped" report experienced multiple structural changes, fluctuating between being a detailed `SELECT` statement (10/29, 6:12 PM), a minimal `FROM` and `WHERE` clause fragment (10/29, 9:05 PM), a complex aggregated query using CTEs (10/29, 9:23 PM, 10/30, 12:21 AM), and eventually settling on a comma-prefixed fragment that provides `CASE` logic for quarter classification (10/30, 11:38 AM).
        *   Temporary hardcoding of the company name ('sp richards company') and date ranges appeared in some versions of the "Container Shipped" query and was later replaced with dynamic parameters.
        *   Minor formatting fixes (e.g., extra commas in function calls) were observed.
        *   The name of the "Container Shipped (MBL Wise)" report was changed to plural "Containers Shipped (Mbl Wise)" at some point, and then the singular version was commented out/removed.
    *   **Content:** Contains `getMonthValue` for month-name-to-number mapping. The `bookingQuery` function returns a map of report names to SQL query string fragments, which are largely joins between `mtr_tracking_data` and `agent_booking_entry` tables with various date calculations and conditional logic (e.g., categorizing time differences into 'Less than 1 week', '1 - 2 weeks', etc.).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamp:** Initial state at `10/29/2025, 6:15:39 PM`. Significant changes occurred between `10/29/2025, 6:20:00 PM` and `10/30/2025, 11:48:05 AM`.
    *   **Key Updates:** This controller dynamically constructs the final SQL query based on the report type and parameters.
        *   Logic for embedding `customQuery` (from `export.query.ts`) into the main SQL string was repeatedly adjusted:
            *   Initially, it would prepend a comma to `customQuery` if missing (10/29, 6:15 PM). This check was later removed (10/29, 6:20 PM).
            *   An attempt to intelligently append `WHERE` or `AND` clauses for date filtering based on whether `customQuery` already contained a `WHERE` clause was introduced (10/29, 6:26 PM) and then reverted (10/29, 6:27 PM).
            *   A temporary block to explicitly handle the complex "Containers Shipped (Mbl Wise)" report by constructing its entire query locally was added (10/29, 9:33 PM) and then removed (10/29, 9:34 PM).
            *   A more flexible mechanism to allow `customQuery` to be a full CTE-based query (starting with `WITH`) or a fragment was implemented (10/30, 11:28 AM) but subsequently reverted (10/30, 11:30 AM).
            *   The `mblWiseQuery` variable was briefly removed from the generic `SELECT` statement (10/30, 11:44 AM), suggesting it might be handled differently or omitted for certain reports.
            *   The special handling for "Containers Shipped (Mbl Wise)" was re-added (10/30, 11:46 AM) then reverted again (10/30, 11:48 AM).
        *   Includes a `replaceColumnHandler` function to standardize location names (e.g., 'LONG BEACH' to 'LOS ANGELES').
    *   **Content:** Imports `bookingQuery` and `nonBookingQuery`. Handles query parameters, fetches user/company data, and executes the constructed SQL query.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamp:** Introduced and stabilized around `10/29/2025, 11:38:12 PM`. Subsequent changes appear to be non-functional saves until the end of the log.
    *   **Key Updates:** This file was introduced to centralize and modularize the generation of SQL queries for "booking" related analytics reports.
        *   It defines the `bookingQueryBuilder` function which takes a `type` parameter and returns a full SQL query string.
        *   It populates a `customizer` object with metadata for chart rendering (e.g., `chartType`, `calType`, `dateColumns`).
        *   It defines various complex SQL queries for reports like `BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, and their `StackedBar` variations. These queries use CTEs, aggregate functions (`AVG`, `COUNT`), and conditional logic to categorize data.
    *   **Content:** Uses `getColumnsByCategory` and `getFilterQueryByDisplayValue` utility functions. Each query type involves joins between `mtr_tracking_data` and `agent_booking_entry` and applies specific filtering and grouping for detailed analytics.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **Timestamp:** Introduced at `10/30/2025, 1:59:03 PM`. A minor update occurred at `10/30/2025, 3:49:28 PM`.
    *   **Key Updates:** This file acts as a central dispatcher for various analytics reports, including those handled by `bookingQueryBuilder`.
        *   It routes requests to different query builders based on the `type` parameter.
        *   At `10/30/2025, 3:49:28 PM`, the condition for calling `bookingQueryBuilder` was expanded to include `'TotalSpendPerMonth'`.
    *   **Content:** Imports several query builder modules and orchestrates the execution of analytics queries, applying post-processing like date filtering and column replacement.

**Patterns and Recurring Elements:**

*   **Date-Based Analytics:** A strong emphasis on date calculations and filtering is evident across all modified files. This includes extracting day differences, truncating dates to month/week/quarter, and filtering data within specific date ranges.
*   **Conditional Data Categorization:** Extensive use of `CASE WHEN` statements in SQL queries to categorize data based on specific conditions (e.g., time differences for stacked bars, or data falling into "This Quarter" vs. "Last Quarter").
*   **Dynamic Query Construction:** The application builds SQL queries dynamically based on report names and user-provided parameters, indicating a flexible reporting framework.
*   **Data Normalization/Transformation:** The `replaceColumnHandler` consistently normalizes location names ('LONG BEACH' to 'LOS ANGELES'), suggesting a common data quality or display requirement.
*   **Iterative Development and Refactoring:** The frequent changes and occasional reverts related to the "Containers Shipped (Mbl Wise)" report, particularly in how its SQL query is defined and integrated, highlight an iterative development process, possibly exploring the most efficient or maintainable way to handle complex, aggregated report data within the system's architecture.
*   **MBL and Container Granularity:** Reports often come in two versions: a general version and an "MBL Wise" version, indicating a need for both high-level and detailed per-MBL analysis.
*   **Data Integrity Checks:** Queries consistently include `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` checks for date fields, ensuring valid data is processed.

## 4:50:06 PM
The `external.routes.ts` file, last modified on October 30, 2025, at 3:40:26 PM, defines a set of external API routes for the `t360-thirdparty` service.

**File-specific updates for `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-thirdparty\src\routes\external.routes.ts`:**
This file has been configured as an Express router, integrating several external-facing controllers. It imports and utilizes controllers for `shipments`, `bookings`, `7501_duties`, `invoice`, and `isf`, all sourced from a `v1` subdirectory within `external` controllers.

The following `GET` endpoints are exposed:
*   `/test`: A basic route to verify protected data access, returning a personalized message including `req.companyname`.
*   `/tracking`: Handled by `shipments.getAll`.
*   `/booking`: Handled by `bookings.getAll`.
*   `/7501_duties`: Handled by `duties.getAll`.
*   `/invoice`: Handled by `invoice.getAll`.
*   `/isf`: Handled by `isf.getAll`.

**Patterns and recurring elements:**
*   A consistent pattern is observed where each feature-specific route (e.g., `/tracking`, `/booking`) utilizes a `getAll` method from its dedicated controller.
*   All defined routes in this log entry are `GET` requests, indicating data retrieval operations.
*   The import paths (`../controller/external/v1/`) suggest a structured, versioned API (`v1`) under an `external` categorization for controllers.

## 5:30:27 PM
The log details recent changes across several files related to an analytics backend service. The primary focus of these updates revolves around enhancing and refining SQL query generation for various reports, particularly those concerning booking and shipment data.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamps:** A series of minor changes from October 29, 2025, 11:38:12 PM, extending through October 30, 2025, 4:34:26 PM.
    *   **Key Changes:** This file primarily defines the `bookingQueryBuilder` function, responsible for constructing PostgreSQL queries for various booking-related analytics. The changes within this file throughout the log are mostly cosmetic or involve minor formatting adjustments (e.g., adding commas, standardizing quotes). The core logic for each report type (e.g., 'BookingDatetoActualDeparture', 'BookingDatetoActualDepartureMblWise', 'BookingDatetoActualDepartureStackedBar') remains consistent. Each report type sets specific `customizer` properties and generates SQL queries that calculate day differences between dates, group data by entities (fileno/contno or fileno/mblno), and sometimes categorize these differences into time buckets (e.g., 'Less than 1 week', '1 - 2 weeks') for stacked bar charts. These queries consistently filter by `account_name` (CompanyName) and a date range.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamps:** Changes observed from October 30, 2025, 12:05:05 AM to 5:27:12 PM.
    *   **Key Changes:** This file defines a `getMonthValue` helper and the `bookingQuery` function, which provides SQL query fragments for various reports based on `reportName`.
        *   **"Containers Shipped (Mbl Wise)" Report:** This query underwent significant and iterative refactoring. Initially a simpler count, it evolved to a complex query involving two Common Table Expressions (CTEs): `date_series` (to generate a range of months) and `shipment_data` (to select distinct MBLs and their final delivery dates, categorized into "This Quarter" and "Last Quarter"). The `shipment_data` CTE was expanded to include a comprehensive list of columns from `mtr_tracking_data` and `agent_booking_entry`. There was a temporary removal and subsequent re-introduction of hardcoded company names ('sp richards company') and date filters within the `shipment_data` CTE, suggesting ongoing adjustments to how company-specific data filtering is applied during export generation.
        *   **"Total Spend per Month ($)" Report:** A new report type was introduced around October 30, 2025, 4:53:29 PM. This query uses a similar CTE structure (`date_series`, `invoice_data`) to calculate total spend per month, distinguishing between "This Quarter" and "Last Quarter". Notably, it dynamically selects the invoice table (`cng_invoice` or `spr_invoice`) based on the `CompanyName`, indicating company-specific data source handling.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamps:** Updates from October 30, 2025, 11:28:18 AM to 5:29:50 PM.
    *   **Key Changes:** This controller handles the overall export data generation.
        *   A significant change occurred around October 30, 2025, 11:46:42 AM, where the logic for constructing `mainQuery` for booking-related reports (`isBooking` is true) was modified. It now explicitly checks if the `reportName` is "Containers Shipped (Mbl Wise)". If so, it uses the `customQuery` returned by `bookingQuery` directly (implying this specific report's query is a complete SQL statement). For other booking reports, it continues to wrap the `customQuery` in a `SELECT * FROM (SELECT ... ) as data` structure.
        *   The file continues to log extensive debugging information (`console.log`, `logger.info`) about the generated queries.
        *   The `replaceColumnHandler` utility remains consistent, ensuring 'LONG BEACH' values in 'pod' and 'place_of_delivery' are converted to 'LOS ANGELES'.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **Timestamps:** Changes observed from October 30, 2025, 1:59:03 PM to 3:49:28 PM.
    *   **Key Changes:** This controller acts as a dispatcher, routing requests for different analytics report types to their respective query builders.
        *   Around October 30, 2025, 3:49:28 PM, the `TotalSpendPerMonth` report type was added to the list of report types handled by the `bookingQueryBuilder`. This indicates an expansion of the `bookingQueryBuilder`'s responsibilities beyond purely booking-related operational data to potentially include associated financial metrics.

**Patterns and Recurring Elements:**

*   **Modular Query Construction:** The codebase extensively uses helper functions (`getColumnsByCategory`, `getFilterQueryByDisplayValue`, `getMonthValue`, `columnsQuery`) and a query dictionary (`bookingQuery`) to construct dynamic SQL statements.
*   **Date-based Analytics:** A strong recurring theme is the calculation and filtering of data based on dates, including `EXTRACT(DAY FROM ...)` for duration, `DATE_TRUNC` for grouping by time periods (month, quarter), and precise timestamp filtering.
*   **Company-Specific Logic:** There are instances where SQL queries contain hardcoded company names (e.g., 'sp richards company' or explicit checks for "central national gottesman, inc."), indicating tailored data handling for specific clients.
*   **Data Standardization:** The `replaceColumnHandler` consistently re-maps "LONG BEACH" to "LOS ANGELES", suggesting a need for standardized location data in reports.
*   **Debugging and Logging:** Frequent use of `console.log` and `logger.info` statements points to ongoing development and debugging of the complex analytical queries.
*   **Report Categories:** Reports are broadly categorized into "chassis", "booking & cargo-ready", "containers", "departures", and "general", with dedicated query builders for each. The addition of "Total Spend per Month" to the "booking & cargo-ready" category suggests a broadening definition of what constitutes a "booking" report.

## 5:50:30 PM
The `external.routes.ts` file, located at `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-thirdparty\src\routes\`, defines a set of external API routes. The last recorded modification for this file was on **October 30, 2025, at 3:40:26 PM**.

The file configures GET endpoints to expose various data types through dedicated controllers, suggesting a modular architecture. Key updates include:

*   **Controller Integration**: It imports and utilizes controllers for `shipments`, `bookings`, `7501_duties`, `invoice`, and `isf`, all seemingly under a `v1` API version structure.
*   **API Endpoints**: The file establishes the following GET endpoints:
    *   `/test`: A basic test endpoint demonstrating protected data access, which returns a personalized message including `req.companyname`.
    *   `/tracking`: Routes to `shipments.getAll`.
    *   `/booking`: Routes to `bookings.getAll`.
    *   `/7501_duties`: Routes to `duties.getAll`.
    *   `/invoice`: Routes to `invoice.getAll`.
    *   `/isf`: Routes to `isf.getAll`.

A recurring pattern is the use of `router.get()` to define routes, consistently calling a `getAll` method from the imported controllers, indicating a standardized approach for retrieving collections of resources.

## 6:31:01 PM
The provided log entries detail changes across four files related to analytics and reporting in a backend API: `booking.query.ts`, `export.query.ts`, `core.export.controller.ts`, and `others.controller.ts`.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**:
    *   **Timestamp: Multiple entries between 10/29/2025, 11:53:55 PM and 10/30/2025, 4:34:26 PM.**
    *   No functional code changes are observed across these entries; the code content remains consistent.
    *   This file defines the `bookingQueryBuilder` function, responsible for constructing various SQL queries related to booking and cargo readiness. These queries include calculations for time differences (e.g., "Booking Date to Actual Departure"), and categorized counts for stacked bar charts (e.g., "Less than 1 week", "1-2 weeks").
    *   Queries are parameterized with `CompanyName`, `fromDate`, `toDate`, `displayBy`, `user_id`, and `reportName`.
    *   Common query patterns include `DISTINCT ON` clauses based on `mblno` or `voyage`/`contno`, and filters to exclude '0001-01-01 00:00:00 BC' dates.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**:
    *   **Timestamp: 10/30/2025, 12:05:05 AM (Initial significant entry).**
    *   Introduced the `bookingQuery` function, which serves as a central repository for SQL query strings, indexed by `reportName`. It includes a `getMonthValue` helper for converting month names to numbers.
    *   **Significant evolution of "Containers Shipped (Mbl Wise)" query:**
        *   Initially, it was a simple `COUNT` query (10/30/2025, 12:05:05 AM).
        *   Then, it became a detailed selection including many columns wrapped in a subquery (10/30/2025, 12:07:29 AM).
        *   It was simplified to just calculate `final_delivery_date` and `quarter` (10/30/2025, 12:12:17 AM), then re-aggregated with `COUNT(DISTINCT mblno)` (10/30/2025, 12:20:06 AM).
        *   A more structured approach using `WITH shipment_data AS (...)` CTE was adopted (10/30/2025, 12:22:35 AM), further refined to explicitly use CTE aliases (10/30/2025, 12:24:47 AM).
        *   A complex nested `SELECT * FROM (SELECT DISTINCT ON ...)` query was introduced for this report, temporarily hardcoding `CompanyName` and specific dates (10/30/2025, 12:27:12 AM).
        *   The hardcoded values were later replaced with dynamic parameters, and the query was refactored to use `date_series` and `shipment_data` CTEs to calculate monthly counts for "This Quarter" and "Last Quarter" (10/30/2025, 11:19:52 AM).
        *   Further simplification removed the `date_series` and complex aggregation, directly classifying shipments into quarters, and making `CompanyName` dynamic (10/30/2025, 11:38:49 AM).
    *   **New report additions:**
        *   `"Total Spend per Month ($)"` was added, using CTEs to calculate monthly spend from `cng_invoice` or `spr_invoice` and categorize it by quarter (10/30/2025, 4:53:29 PM).
        *   `"Average Transit Time per Month (Days)"` was added, using CTEs to calculate average transit time from departure to arrival, also categorized by quarter (10/30/2025, 6:27:10 PM).
    *   Minor formatting/whitespace changes were noted (e.g., 10/30/2025, 12:28:49 AM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**:
    *   **Timestamp: 10/30/2025, 11:28:18 AM (Initial significant entry).**
    *   This file defines the `getExportData` controller, which handles requests for exporting analytics data.
    *   It dynamically retrieves query parameters, defaults date ranges, and fetches company/user information.
    *   It uses `bookingQuery` and `nonBookingQuery` to get the appropriate SQL.
    *   A key feature is its handling of query wrapping:
        *   Initially, it conditionally wrapped the generated query based on whether it started with `WITH` (10/30/2025, 11:28:18 AM).
        *   This conditional wrapping was temporarily removed (10/30/2025, 11:30:01 AM), then re-introduced with a specific check for the "Containers Shipped (Mbl Wise)" report (10/30/2025, 11:46:42 AM), and finally removed again for general processing (10/30/2025, 11:48:05 AM).
    *   It applies `mblWiseQuery` for `DISTINCT ON` logic in booking reports (though this was also temporarily removed at 10/30/2025, 11:44:37 AM before being re-added).
    *   Includes a `replaceColumnHandler` function to standardize "LONG BEACH" port values to "LOS ANGELES" for consistency.
    *   Special handling for "TEU MBLwise" reports is implemented to deduplicate containers.
    *   Added `console.log` statements for debugging `mainQuery` and `mergedFilterData` (10/30/2025, 5:13:14 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**:
    *   **Timestamp: 10/30/2025, 1:59:03 PM (Initial significant entry).**
    *   This file contains `getTableDataReports`, which acts as a dispatcher, routing requests to specific query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) based on the `type` of report requested.
    *   The list of report types handled by `bookingQueryBuilder` is extensive.
    *   **Expanded `bookingQueryBuilder` scope:** The `'TotalSpendPerMonth'` report type was added to the list handled by `bookingQueryBuilder` (10/30/2025, 3:49:28 PM).
    *   Includes logging for the generated query before execution.

**Patterns and Recurring Elements:**

*   **Dynamic Query Construction:** All query files use template literals to construct SQL queries, allowing dynamic insertion of parameters like `CompanyName`, `fromDate`, `toDate`, and report-specific filters.
*   **Date Handling:** A consistent pattern of date filtering using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'` and explicit checks for `!= '0001-01-01 00:00:00 BC'` (an invalid date placeholder) is present across many queries.
*   **Report Variations:** Reports often exist in base, `MblWise`, and `StackedBar` variations, indicating different aggregation levels and visualization needs for analytics.
*   **Quarterly/Monthly Aggregation:** Several queries utilize PostgreSQL functions like `DATE_TRUNC('month', ...)` and `EXTRACT(QUARTER FROM ...)` along with `generate_series` CTEs to group and categorize data by time periods (months, quarters).
*   **Data Standardization:** A `replaceColumnHandler` uniformly modifies "LONG BEACH" to "LOS ANGELES" for `pod` and `place_of_delivery` fields, suggesting a need for consistent data representation in reports.
*   **Modular Query Builders:** The project adheres to a clear separation of concerns by using dedicated query builder functions (`bookingQueryBuilder`, `export.query.ts`'s `bookingQuery`, etc.) for different analytical report categories.
*   **Debugging Practices:** Frequent `console.log` and `logger.info` statements are used to trace query generation and data processing, indicating an active development and debugging environment.