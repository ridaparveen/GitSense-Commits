# Activity Summary for 10/10/2025

## 2:33:37 AM
The provided log details changes exclusively within the file `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\customerService.ts` across multiple timestamps on 10/9/2025, ranging from 10:07:03 PM to 10:52:12 PM.

Despite the numerous timestamps, the content of the file `customerService.ts` appears to be identical across all logged entries. This indicates that the file was saved multiple times without introducing any functional changes, additions, or deletions within these specific log entries.

The file contains several key functions related to customer management:

*   **`getAll`**: This function is responsible for retrieving a paginated and sortable list of customers. It supports extensive filtering based on `status`, `fromDate`, `toDate`, `customer_type`, `customer_id`, `location`, and `customer_name`. It also retrieves distinct values for `status`, `location`, and `customer_type` to populate dropdowns. The implementation uses a `QueryBuilder` for constructing dynamic SQL queries and includes error handling and logging.
*   **`getCustomerDashboardCardInfo`**: This function fetches aggregated customer statistics, specifically counts of 'ACTIVE', 'INACTIVE', and 'total' customers. It supports filtering by date ranges, including predefined "weekly" and "monthly" filters, or a custom `fromDate` to `toDate` range.
*   **`saveCustomerDetails`**: This function handles the initial saving of basic customer information. It generates a unique `customer_id` and inserts the customer's `name` and `pan_no` into the `customer` table. This operation is wrapped in a database transaction to ensure atomicity.
*   **`CreateCustomer`**: This is a more complex function for creating a comprehensive customer record. It takes `customer_id`, `gstLocations`, `status`, and `uploadDocuments` as input.
    *   It updates the customer's `status` if provided.
    *   It processes an array of `gstLocations`, inserting each into the `customer_gst_location` table. For each GST location, it then inserts associated `keyPersonalDetails` into `customer_key_personal` and `alertMappingDetails` into `customer_alerts`. The code snippet suggests it also handles `creditControlDetails`.
    *   Audit trails (`simpleAudit`) are recorded for the creation of each GST location, key personal detail, and customer alert.
    *   It anticipates file uploads (`req.files`) and handles potential stringified JSON inputs for `gstLocations` and `uploadDocuments`.
    *   All these operations are encapsulated within a database transaction.

**Patterns and Recurring Elements:**

*   **Database Transactions:** Both `saveCustomerDetails` and `CreateCustomer` functions utilize explicit `BEGIN`, `COMMIT`, and `ROLLBACK` database transactions to ensure data integrity.
*   **Error Handling:** All top-level asynchronous functions implement `try...catch` blocks to gracefully handle potential errors, logging them and returning appropriate HTTP status codes (e.g., `INTERNAL_SERVER_ERROR`, `BAD_REQUEST`).
*   **Dynamic Query Building:** The `getAll` function prominently uses a `QueryBuilder` utility to construct SQL queries dynamically based on various filter and sorting parameters.
*   **Logging:** `logger.info` and `logger.error` calls are interspersed throughout the code for operational logging and debugging. `console.log` is also frequently used.
*   **Date Management:** The `moment` library is used for formatting dates in SQL queries.
*   **Audit Trails:** The `simpleAudit` function from `auditModules` is consistently called after inserting related customer entities in `CreateCustomer`, indicating a robust auditing mechanism.
*   **Input Parsing:** The `CreateCustomer` function explicitly checks and parses `gstLocationsRaw` and `documentsRaw` from stringified JSON, suggesting that these might be sent as strings in the request body.