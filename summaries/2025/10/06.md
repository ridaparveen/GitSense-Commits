# Activity Summary for 10/6/2025

## 10:42:08 AM
The provided log details a series of rapid changes made to a single file, `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\customerService.ts`, all occurring within a few minutes on 10/6/2025, specifically between 9:45:19 AM and 9:47:19 AM.

**File-Specific Updates (`customerService.ts`):**

The modifications are concentrated within the `CreateCustomer` asynchronous function, specifically targeting how the `status` of a customer is handled during an update operation.

*   **Initial State (9:45:19 AM):** The `CreateCustomer` function updates the `customer` table's `status` directly using the provided `status` from the request body. A commented line suggested a potential `toUpperCase()` conversion.
*   **9:45:35 AM:** The `status` value for the `customer` update query was explicitly converted to uppercase using `toUpperCase()`. A minor typo (`cons`) was inadvertently introduced before the `if (status)` block.
*   **9:45:46 AM:** The `cons` typo was removed, and debugging `console.log` statements were added to inspect `documentsRaw` and `status` values, indicating active debugging. The `toUpperCase()` conversion for `status` remained in effect.
*   **9:46:23 AM:** The entire `if (status)` conditional block responsible for updating the customer status was commented out, and the `status` value was reverted to being used directly without any case conversion (`toUpperCase()` was removed from the update line). This likely represents a temporary test or rollback during development.
*   **9:47:19 AM:** The `if (status)` block was uncommented and re-enabled. The `status` value is now explicitly converted to lowercase using `toLowerCase()` before being used in the `UPDATE` query, signifying a change in the desired case for status values in the database.

**Patterns and Recurring Elements:**

The changes demonstrate a focused iteration on the `CreateCustomer` function, particularly around the `status` field. The recurring elements include:

*   **Status Case Conversion:** Repeated modifications involve toggling, adding, or changing the case conversion (uppercase, then no conversion, then lowercase) applied to the `status` field before persisting it to the database.
*   **Debugging Statements:** The presence and removal of `console.log` statements across different timestamps suggest active debugging and testing during this development phase.
*   **Transaction Management:** The `CreateCustomer` function consistently uses `await query("BEGIN")` and intends to `await query("COMMIT")` on success or `await query("ROLLBACK")` on error, ensuring data integrity for the complex multi-table inserts.
*   **Auditing:** `simpleAudit` is consistently used after inserting `customer_gst_location` entries, indicating a structured approach to logging changes.

## 11:42:11 AM
The file `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\customerService.ts`, updated on `10/6/2025, 11:38:44 AM`, primarily focuses on comprehensive customer management functionalities within the backend system.

Key updates and patterns observed are:

*   **`getAll` Function:** This endpoint has been significantly enhanced to retrieve customer data with extensive filtering, pagination, and sorting capabilities. It supports filtering by status, date ranges (`fromDate`, `toDate`), customer type, customer ID, location, and customer name. A `QueryBuilder` utility is utilized for dynamically constructing complex SQL queries, including a `LEFT JOIN` with `customer_gst_location` to enrich customer details. Additionally, it fetches distinct values for `status`, `location`, and `customer_type` to populate dropdowns in the frontend.
*   **`getCustomerDashboardCardInfo` Function:** A new function designed to provide aggregate customer statistics for a dashboard. It calculates `active_customer`, `inactive_customer`, and `total_customer` counts. Filters include specific `fromDate` and `toDate` or predefined intervals like `weekly`, `monthly`, or `all`, allowing for flexible data aggregation.
*   **`saveCustomerDetails` Function:** This function handles the initial creation of a customer record. It generates a unique `customer_id` and saves basic customer details like `name` and `pan_no` into the `customer` table. Database transactions (`BEGIN`, `COMMIT`) are used to ensure data integrity during the insertion process.
*   **`CreateCustomer` Function:** This is a highly detailed function for creating a customer with complex associated data.
    *   It begins a database transaction to ensure atomicity across multiple inserts.
    *   It can update a customer's `status` if provided in the request.
    *   A central feature is the handling of `gstLocations`, where each GST location entry is parsed and inserted into the `customer_gst_location` table. These locations contain extensive details including multiple addresses, contact information, various sales/CS metrics (e.g., `sales_export`, `cs_import`), and compliance identifiers (`iec_no`, `scac`, `sez`, `uid`, `kyc`, `tan_no`).
    *   Following the insertion of a GST location, `simpleAudit` is called, indicating an audit trail is maintained for these critical actions.
    *   For each GST location, it further allows for the insertion of `keyPersonalDetails` into `customer_key_personal` and `alertMappingDetails` into `customer_alerts`. The code snippet also initiates the insertion of `creditControlDetails`.
    *   The presence of `req.files` and an import for `saveDoc` suggests integration with a file upload mechanism for documents related to the customer or their GST locations.

**Recurring Patterns:**

*   **Database Transaction Management:** Explicit use of `await query("BEGIN")`, `await query("COMMIT")`, and `await query("ROLLBACK")` is a consistent pattern in `saveCustomerDetails` and `CreateCustomer` to maintain data consistency across multi-step operations.
*   **Extensive Data Modeling:** The functions, particularly `CreateCustomer`, reveal a highly detailed and nested data model for customers, encompassing GST locations, key personnel, alert configurations, and credit control.
*   **Dynamic Querying and Filtering:** The `QueryBuilder` in `getAll` and the dynamic `WHERE` clause construction in `getCustomerDashboardCardInfo` demonstrate a flexible approach to data retrieval.
*   **Logging and Error Handling:** `logger.info`, `logger.error`, `console.log`, and `console.error` are consistently used for monitoring and debugging, paired with appropriate `HttpStatusCodes` for API responses.
*   **Date/Time Handling:** `moment` and `new Date()` are used for timestamping records and formatting dates in queries.

## 12:57:27 PM
The code changes primarily focus on enhancing shipment tracking, filtering capabilities, and data modeling within the T360-V2 backend.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
*   **Timestamp: 10/6/2025, 11:46:39 AM**
    *   The `getAll` function in `shipmentService.ts` was significantly updated to include new query parameters: `contno` (container number) and `cardFilter`.
    *   Extensive logic was added to dynamically determine and assign `ShipmentStatus` (Pending, Loading, Departed, In_Transit, Custom_Hold, Arrived, Delivered) to each shipment based on various `MtrTrackingData` fields like `departure_date`, `t49_eta`, actual departure/arrival dates, `deliverd_date`, and `t49_holdspodterminal_name`.
    *   Port of Loading (POL) and Port of Discharge (POD) for `bookedItem` are now conditionally overridden by `mtrData.mtr_pol` and `mtrData.mtr_pod` if available.
    *   The `SqlQueryBuilder` class was expanded to incorporate `cardFilter` logic. This includes adding date range conditions (`mtr.departure_date BETWEEN fromDate AND toDate`) and specific conditions for different card filters:
        *   `pending_departure`: filters for null actual departure dates and `shipment_completed != 'Yes'`.
        *   `in_transit`: filters for non-null actual departure dates and null actual arrival dates, and `shipment_completed != 'Yes'`.
        *   `eta_within_1_week`: filters for upcoming ETAs within 7 days, non-null actual departure, and null actual arrival, and `shipment_completed != 'Yes'`.
        *   `out_for_delivery`: filters for `t49_contno_out_gated` being non-null and `t49_empty_return_date` being null, and `shipment_completed != 'Yes'`.
    *   User-specific conditions in `buildUserCondition` remain, ensuring data visibility based on user roles (Admin, Customer, FrontOffice, Agent).
*   **Timestamp: 10/6/2025, 11:48:17 AM - 12:09:35 PM**
    *   These entries show very minor or no functional code changes in `shipmentService.ts`. The `console.log` for status list was briefly modified and then removed in a later save. The `shipment_id` filter condition in `buildFilterConditions` was completed (`mtr.mblno = $$`, shipment_id), which was truncated in the earliest log. The repeated entries likely indicate iterative saves without substantial new functionality introduced in each specific timestamp.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\enum.ts`**
*   **Timestamp: 10/6/2025, 12:17:06 PM**
    *   The `ShipmentStatus` enum was updated:
        *   `Arrived` was renamed to `POD_Arrived` (label 'POD Arrived').
        *   A new status `All` was added.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\shipment.ts`**
*   **Timestamp: 10/6/2025, 12:21:07 PM**
    *   The `ShipmentQueryParams` interface gained `contno` and `viewType` properties to support new query filters.
    *   The `MtrTrackingData` interface now includes `mtr_pol` and `mtr_pod` fields.
    *   `ShipmentStatusType` was updated to reflect the `POD Arrived` status and include `All`.
    *   The `QueryFilters` interface expanded with `cardFromDate`, `cardToDate`, and `contno` properties.
    *   The `ShipmentDetailsQuery` interface added new fields like `shipment_completed`, `contno_out_gated`, `delivery_customer_date`, `orig_inland_arv_date`, and `updated_inland_arv_date` to store more detailed shipment information.

**Key Patterns and Recurring Elements:**
*   **Enhanced Filtering and Data Retrieval:** A consistent effort to provide more detailed filtering options for shipments, including card-based filters and container numbers.
*   **Refined Shipment Status Management:** A major theme is the complex logic introduced to accurately derive and present shipment statuses based on various tracking milestones and dates. The status definitions themselves were also updated to be more descriptive (`Arrived` to `POD Arrived`).
*   **Data Model Synchronization:** Changes to service logic (e.g., `shipmentService.ts`) are immediately followed by corresponding updates in data models (e.g., `enum.ts`, `types\shipment.ts`) to support the new fields and status definitions.
*   **MTR Data Utilization:** The backend heavily relies on `MTR` (Master Tracking Reference) data for tracking and status determination, evidenced by fields like `mtr_pol`, `mtr_pod`, `t49_eta`, `t49_vessel_actualdeparted_date`, `t49_vessel_actualarrived_date`, and `t49_holdspodterminal_name`.
*   **Iterative Saves:** Several timestamps show identical code content, indicating frequent saving during development without major functional changes between those specific points.

## 12:57:29 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts`, last modified on 10/6/2025 at 12:13:09 PM, defines a comprehensive set of global application constants. These include various status types (SHIPMENT_STATUS, REPORTS_STATUS, TEAM_MENBER_STATUS, BOOKING_STATUS) and roles (TEAM_MENBER_ROLE), each assigned a specific color. It also establishes shipment scope options (SHIPMENT_SCOPE) with labels and colors, and provides arrays for booking sorting options (BOOKING_SORT_OPTIONS) and shipment status filters (SHIPMENT_STATUS_FILTERS). This file centralizes configuration data for UI elements and business logic.

The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\types\shipment.types.ts` underwent several rapid updates:

*   **Initial change on 10/6/2025, 12:23:49 PM:** This update introduced core TypeScript interfaces and types for shipment management. Key definitions include `EventAttributes` for tracking event details, `ItemAttributes` for shipment item specifics, and `MilestoneItem` to combine these. It defined union types `ShipmentStatusType` and `ShipmentScopeValues`, mirroring the constants found in `global.ts`. Crucially, it established the `DashboardState` interface, outlining the structure for pagination, sorting (`SortModelItem`), and various filters such as `shipment_id`, `fromDate`, `toDate`, `pol`, `pod`, `contno`. At this point, the `status` filter within `DashboardState.filters` was typed as `['All']` (an array containing only the string 'All'). A `DashboardCardInfoState` was also defined for specific date filtering on cards.
*   **Subsequent change on 10/6/2025, 12:24:28 PM:** A minor refinement was made to the `DashboardState.filters.status` property, changing its type from `['All']` to a single string literal `'All'`.
*   **Further change on 10/6/2025, 12:24:42 PM:** This update reverted and expanded the `DashboardState.filters.status` type, changing it back to `string[]`, indicating that the status filter is expected to handle an array of strings, potentially for multiple status selections.
*   **Final change on 10/6/2025, 12:29:09 PM:** No functional code changes were observed in this timestamp compared to the previous one, suggesting a save without content modification or a reformat.

**Key Patterns and Recurring Elements:**

*   **Data Consistency:** There's a clear pattern of defining common sets of values (like shipment statuses and scopes) in both the `data/options` (for constant values and their properties like color/label) and `types` (for TypeScript type safety) directories.
*   **Color-Coding:** Numerous status and role definitions consistently include a `color` property, suggesting a strong emphasis on visual representation across the application.
*   **Dashboard-Centric Design:** Significant effort is dedicated to defining the state and filtering mechanisms for a dashboard, encompassing pagination, sorting, and various date and content-based filters.
*   **Rapid Iteration on Type Definitions:** The quick succession of changes to the `shipment.types.ts` file, particularly concerning the `DashboardState.filters.status` property, indicates active and iterative development on core data structures, likely driven by evolving UI requirements for filtering.

## 1:57:20 PM
The `shipment-dashboard-slice.ts` file, last updated on October 6, 2025, at 1:29:12 PM, introduces a Redux Toolkit slice designed to manage the state for a shipment dashboard. Its `initialState` defines comprehensive defaults including pagination settings (`page: 0`, `pageSize: 10`), an empty `sortModel`, and detailed `filters` for `shipment_id`, date ranges (`fromDate`, `toDate`), `status` (initially excluding "Delivered" shipments), `pol`, `pod`, and `contno`. It also sets up `dateFilter` for both general dashboard and specific shipment dates, along with `sortBy` and `cardFilter` fields. The slice provides reducers such as `dashboardSetPagination`, `dashboardSetFilters` (which merges new filters), `setDateRange`, `setPeriod`, `dashboardSetSortModel`, and `setCardFilter`. A notable detail is that `setCardFilter` also resets the pagination page to 0.

The `global.ts` file, with its most recent change recorded on October 6, 2025, at 1:30:31 PM, serves as a centralized hub for various global constants and configuration options. It defines numerous JavaScript objects that map labels or keys to specific attributes, often including `color` properties, for consistent UI representation. These include `SHIPMENT_STATUS`, `REPORTS_STATUS`, `TEAM_MENBER_STATUS`, `TEAM_MENBER_ROLE`, `BOOKING_STATUS`, `BOOKING_DASHBOARD_STATUS`, and `SHIPMENT_SCOPE`. Additionally, it exports arrays like `BOOKING_SORT_OPTIONS` for various sorting criteria and `SHIPMENT_STATUS_FILTERS` which enumerates different shipment statuses available for filtering. The `SHIPMENT_STATUS_FILTERS` directly underpins the `status` filtering logic found in the `shipment-dashboard-slice.ts` file.

A recurring pattern across these changes is the establishment of a robust and organized frontend architecture for the "T360-V2" project. There's a clear emphasis on structured state management using Redux Toolkit for dashboards, coupled with a centralized system for global constants and UI-related options. The consistent use of `color` properties within status and role definitions suggests a design principle focused on uniform visual cues. The close proximity of the timestamps for both files indicates these updates were likely part of a coordinated effort to enhance filtering, sorting, and overall state handling for shipment-related features.

## 1:57:44 PM
The provided log details multiple timestamped entries for the file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`.

All entries, spanning from 10/6/2025, 1:21:15 PM to 10/6/2025, 1:56:19 PM, contain identical code content. There are no discernible functional or structural changes in the provided code snippets across these timestamps.

The file `shipmentService.ts` appears to be related to managing and querying shipment data, including filtering, pagination, and determining shipment statuses (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields and MTR (Master Tracking Record) data. It includes a `SqlQueryBuilder` class for constructing database queries with user-specific conditions and card-based filters.

The recurring element is the exact same code content being logged multiple times within a 35-minute window, suggesting frequent saves or version control snapshots without substantive code modifications in the sections provided.

## 2:57:25 PM
The provided log entries, both timestamped 10/6/2025 at 2:04:40 PM and 2:07:21 PM, refer to the same file: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`. The code content between these two timestamps is identical, indicating no functional changes occurred during this brief period.

The file `shipmentService.ts` defines a core service for managing and retrieving shipment information in the T360-V2 backend.

Key information and changes:

*   **File:** `src\services\shipmentService.ts`
*   **Timestamps:** 10/6/2025, 2:04:40 PM and 10/6/2025, 2:07:21 PM. The code content is precisely the same for both entries, suggesting a snapshot or a log of an unchanged state.
*   **Core Functionality (`getAll` endpoint):** This asynchronous function handles requests to retrieve all shipments. It supports extensive filtering, pagination, and dynamic status calculation.
*   **Dynamic Query Building (`SqlQueryBuilder` class):** A central `SqlQueryBuilder` class is used to construct SQL queries based on various criteria.
    *   **User-Role Based Access Control:** `buildUserCondition` implements complex logic to filter shipments based on the authenticated user's role (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/account names or user IDs. There's a specific condition for "ZIGI USA, LLC" customers.
    *   **Filtering Options:** Supports filtering by `pol` (Port of Loading), `pod` (Port of Discharge), `shipment_id` (MBL number), `contno` (container number), `status`, and date ranges (`fromDate`, `toDate`).
    *   **"Card Filters":** `buildCardFilterCondition` introduces specialized filters for dashboard-like views, including `pending_departure`, `in_transit`, `eta_within_1_week`, and `out_for_delivery`. These filters apply specific SQL `WHERE` clauses based on actual/estimated departure/arrival dates and shipment completion status.
*   **Dynamic Shipment Status Derivation:** The `getAll` function processes the raw shipment data to assign a `status` (e.g., Pending, Loading, Departed, In_Transit, Custom_Hold, Arrived, Delivered). This status is derived dynamically using `moment.js` to compare various dates (`etd`, `eta`, `atd`, `ata`, `deliverd_date`) and checking for hold information from MTR tracking data (`t49_holdspodterminal_name`).
*   **MTR Data Integration:** The service extensively uses "MTR layer" data (e.g., `mtr.departure_date`, `mtrData.t49_eta`, `mtrData.mtr_pol`) to enrich and determine the most current status and details of each shipment.
*   **Dependencies:** Key dependencies include `@src/common/util/database` for database interaction, `@src/common/util/logger`, `moment` for date handling, and various types defined in `@src/models/common/types/shipment`.
*   **Patterns/Recurring Elements:**
    *   Heavy reliance on a builder pattern (`SqlQueryBuilder`) for constructing flexible and secure database queries.
    *   Extensive use of conditional logic to determine shipment status based on a hierarchy of date and event information.
    *   Logging information at various stages (`logger.info`) to aid in debugging and monitoring.
    *   Dynamic placeholder generation (`$$` replaced by `$${this.index}`) for parameterized queries to prevent SQL injection.
    *   `console.log(status)` statements are present within the status derivation logic, possibly indicating active development or debugging in that section.

## 3:57:20 PM
The file `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\data\options\common.ts`, updated on October 6, 2025, at 2:58:42 PM, serves as a central repository for various UI configuration options, tab structures, sorting criteria, and status mappings within the Envosys frontend application.

**File-Specific Updates:**

*   **UI Tab Definitions:** Several constants define the structure for different detail view tabs:
    *   `ENQUIRY_DETAILS_TABDATA`: Includes "Documents" and "Message".
    *   `BOOKING_DETAILS_TABDATA`: Covers "Cargo Details", "Sale Rate", "FAC", "Upload Document", and "Message".
    *   `HBL_DETAILS_TABDATA`: Specifies "Shipper", "Consignee", "Notify1", "Notify2", "Container", and "Routing".
    *   `CUSTOMER_DETAILS_TABDATA`: Contains "Key Personal", "Alert Mapping", "Credit Control", "FAC", "Upload Document", and "Audit".
    *   `CUSTOMER_CREDIT_DETAILS_TABDATA`: Details various types of shipments (Ocean/Air Export/Import, Freehand/Nomination).
*   **Filtering and Sorting Options:** A comprehensive set of options for filtering and sorting data:
    *   `TIME_PERIOD_FILTER_OPTIONS`: Provides "Weekly" and "Monthly" filters.
    *   `sortOptions`: Defines sorting by "Vessel Name" (Ascending/Descending).
    *   `VendorSortOptions`: Sorts by "Vendor Name" (A-Z/Z-A).
    *   `mblSortOptions`: Offers sorting by "Line", "Vessel", "Voyage", "POL", and "POD" (Ascending/Descending).
    *   `customerSortOptions`: Sorts by "Line Booking No" (Ascending/Descending).
    *   `customerDashboardSortOptions`: Allows sorting by "Customer ID" and "Customer Name" (Ascending/Descending).
    *   `procurementSortOptions`: Sorts by "Line Name", "POD", and "Transporter" (Ascending/Descending).
*   **General Selection Options:**
    *   `statusOptions`: "Active" and "Inactive".
    *   `unitOption`: "Feet" and "Meter".
    *   `LineNo`: Example line numbers "LineA", "LineB", "LineC".
    *   `POD`: Example Ports of Discharge "SHANGHAI", "ROSE", "SHAVANAH".
    *   `BookingNo`: Example booking number "ABC1234".
    *   `Transporter`: "Air", "Road", "Ocean" options.
*   **Enquiry Statuses:** `ENQUIRY_STATUS_OPTIONS` provides a detailed list of reasons for enquiry outcomes, ranging from "Lost due to quote on the higher side" to "Enquiry still active" and "Others".
*   **Status Mappings and UI Display:** Several `Record` types map status strings to their display values or associated UI properties (like color):
    *   `BOOKING_DASHBOARD_STATUS` and `BOOKING_STATUS`: Map booking statuses (Pending, New, Approved, Cancelled) to display labels and specific colors (lime, blue, amber, pink).
    *   `MBL_DASHBOARD_STATUS` and `MBL_STATUS`: Map MBL statuses (Booked, Completed, Transit, Destination) to display labels and colors.
    *   `STATUS` and `DASHBOARD_STATUS`: Provide mappings for general "Active" and "Inactive" statuses, including color definitions.
    *   `LINE_BOOKING_DASHBOARD_STATUS` and `LINE_BOOKING_STATUS`: Map line booking statuses (New, Allotted, Cancelled, Confirmed, Assigned) to labels and a wider range of colors (blue, violet, pink).

**Patterns and Recurring Elements:**

*   **Consistent Structure for Options:** Most constants are arrays of objects, each containing `label` and `value` properties, making them suitable for dropdowns, selects, or tab components.
*   **Logistics-Centric Data:** The options and statuses consistently revolve around logistics and shipping concepts (bookings, MBLs, vessels, customers, procurement, transporters, ports).
*   **Status Management:** A significant portion of the file is dedicated to defining and mapping various statuses, often including specific color codes for UI representation (e.g., `lime` for Approved/Active, `pink` for Cancelled/Inactive).
*   **Sorting Convention:** Many sorting options follow a `field*direction` or `field-direction` pattern (e.g., `vessel_name*asc`, `line-asc`) for their `value` property, indicating a programmatic approach to sort order.
*   **Timestamp Significance:** The timestamp indicates a recent and substantial update to the application's core data definitions, suggesting ongoing development or refinement of UI elements and backend integration points related to various operational entities.

## 3:57:22 PM
**File:** `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`
**Timestamp:** 10/6/2025, 3:02:42 PM

This extensive update to `shipmentService.ts` focuses on enhancing the `getAll` shipment retrieval functionality, introducing sophisticated filtering, dynamic query generation, and detailed status determination based on marine tracking data.

**Key Updates to `getAll` Function:**

*   **Enhanced Query Parameters:** The function now accepts a wider range of query parameters for filtering, including `pol`, `pod`, `shipment_id`, `status`, `fromDate`, `toDate`, `orderBy`, `cardFilter`, `contno`, and `viewType`.
*   **Dynamic Status Handling:** The `status` parameter can be a comma-separated string or an array, allowing for multi-status filtering.
*   **`SqlQueryBuilder` Integration:** A new `SqlQueryBuilder` class is introduced and utilized to construct complex SQL queries dynamically. This centralizes query logic and promotes reusability and security.
*   **MTR Data Enrichment:** After fetching initial shipment data, the service now actively enriches each shipment item with detailed tracking information from MTR (Marine Traffic) data. This involves:
    *   Determining the `status` of a shipment (e.g., `Pending`, `Loading`, `Departed`, `In_Transit`, `Custom_Hold`, `Arrived`, `Delivered`) based on various actual and estimated dates (`etd`, `eta`, `atd`, `ata`, `deliverd_date`) and hold names.
    *   Updating `eta`, `etd`, `ata`, `atd`, `pol`, and `pod` fields using more accurate MTR data.
*   **Card Filter Application:** Logic to apply `cardFilter` conditions (e.g., `pending_departure`, `in_transit`, `eta_within_1_week`, `out_for_delivery`) is now integrated, allowing for dashboard-style filtering.
*   **Error Handling:** A `try...catch` block is implemented to gracefully handle potential errors during shipment retrieval.

**Introduction of `SqlQueryBuilder` Class:**

A new `SqlQueryBuilder` class has been added to manage the construction of SQL queries, ensuring modularity and security:

*   **Dynamic Query Construction:** It uses an internal state (`conditions`, `params`, `index`) to build parameterized SQL `WHERE` clauses based on various inputs.
*   **Role-Based Access Control (`buildUserCondition`):** This critical method implements granular access control based on the user's role:
    *   `ADMIN` users have unrestricted access.
    *   `CUSTOMER` users are restricted to their `companyname` (with a special case for "ZIGI USA, LLC" including specific date filters).
    *   `FRONTOFFICE` users are filtered by `account_name` linked to their `userid`.
    *   `AGENT` users are filtered by `account_name` associated with their `companyname`.
    *   A fallback mechanism filters by `location` for other roles.
*   **Filter Condition Building (`buildFilterConditions`):** Dynamically adds conditions for `pol`, `pod`, `shipment_id`, and `contno` (though `contno`'s condition implementation is not fully shown in the provided snippet). `ILIKE` is used for partial string matching on locations, while `mblno` uses an exact match.
*   **Card Filter Specifics (`buildCardFilterCondition`):** Implements dedicated SQL conditions for each `cardFilter` option, typically involving checks on departure, arrival, and delivery dates, and explicitly excluding shipments marked as `shipment_completed = 'Yes'`.

**Patterns and Recurring Elements:**

*   **Parameterized Queries:** Extensive use of `$1`, `$2` style placeholders for SQL parameters ensures security against SQL injection.
*   **MTR Data Dependency:** The service heavily relies on external MTR data for real-time status updates and geographical information, signifying a focus on data accuracy and user visibility.
*   **Role-Based Access:** A strong pattern of role-based data access is implemented, demonstrating a robust security and data segregation model.
*   **Modularity:** The introduction of `SqlQueryBuilder` clearly separates query generation logic from the service endpoint, improving code organization.
*   **Logging:** Consistent use of `logger.info` throughout the code provides valuable insights into execution flow and debugging.
*   **Date Management:** `moment.js` is utilized for consistent and flexible date parsing and comparison, crucial for status determination.