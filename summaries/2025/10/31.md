# Activity Summary for 10/31/2025

## 9:49:31 AM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-thirdparty\src\routes\external.routes.ts` was updated on 10/30/2025, 3:40:26 PM. This file establishes external API routes using Express.js. It imports and utilizes controllers from `v1` of `shipments`, `bookings`, `7501_duties`, `invoice`, and `isf` modules.

The defined routes are:
*   `/test`: A GET endpoint that returns a protected message including `req.companyname`.
*   `/tracking`: A GET endpoint handled by `shipments.getAll`.
*   `/booking`: A GET endpoint handled by `bookings.getAll`.
*   `/7501_duties`: A GET endpoint handled by `duties.getAll`.
*   `/invoice`: A GET endpoint handled by `invoice.getAll`.
*   `/isf`: A GET endpoint handled by `isf.getAll`.

A clear pattern emerges where most external data retrieval routes (tracking, booking, duties, invoice, isf) consistently call a `getAll` method from their respective controllers, all residing under a `v1` directory, suggesting API versioning.

## 9:49:32 AM
The provided log shows a series of frequent, incremental changes focused on refining SQL queries and their handling within a backend analytics application. All modifications occurred between October 29, 2025, and October 30, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**:
    *   This file, responsible for building SQL queries related to booking data, saw numerous minor updates across 20 entries.
    *   All changes were consistent and appear to be formatting adjustments (e.g., adding spaces, newlines, changing double quotes to single quotes for strings) or minor structural reorganizations within existing SQL query strings. No functional changes were introduced in these specific log entries; the core logic for `BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`, and `BookingDatetoActualDepartureMblWiseStackedBar` remained identical across these timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**:
    *   This file defines SQL query snippets for various reports used in export functionality.
    *   Between 10/30/2025, 12:05:05 AM and 10/30/2025, 12:28:49 AM, a significant change was made to the `"Containers Shipped (Mbl Wise)"` query. Initially, it was a simple `SELECT COUNT(DISTINCT m.mblno)` grouped by month and quarter. It was then expanded significantly into a complex Common Table Expression (CTE) structure (`WITH shipment_data AS (...) SELECT TO_CHAR(...)`) to extract more detailed shipment data including various tracking fields, and to classify quarters based on dynamic date ranges relative to `CURRENT_DATE`.
    *   A new report type, `"Total Spend per Month ($)"`, was introduced around 10/30/2025, 4:53:29 PM. This query uses a CTE (`date_series`, `invoice_data`) to calculate total spend per month, categorized by "This Quarter" and "Last Quarter" based on invoice dates from `cng_invoice` or `spr_invoice` tables, depending on the `CompanyName`.
    *   Another new report type, `"Average Transit Time per Month (Days)"`, was added around 10/30/2025, 6:27:10 PM. This also uses CTEs (`date_series`, `transit_data`) to calculate the average transit time (actual arrival date - actual departure date) grouped by month and quarter.
    *   There were minor formatting adjustments similar to `booking.query.ts` as well, such as changing quotes (`'`) and spacing.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**:
    *   This controller handles the export data requests.
    *   Around 10/30/2025, 11:46:42 AM, logic was added to handle specific report types (`"Containers Shipped (Mbl Wise)"`) that might provide a full SQL query including CTEs (starting with `WITH`). For such reports, the `mainQuery` is directly assigned the `customQuery` to avoid wrapping it in an unnecessary `SELECT * FROM (...)` subquery, which was causing errors.
    *   Further refinements were made to this CTE handling logic around 10/30/2025, 6:41:38 PM and 10/30/2025, 6:42:42 PM, ensuring that if a `customQuery` starts with `WITH`, it is used as the base query, and if not, it's integrated into a standard `SELECT * FROM (...)` structure. This indicates a fix for how complex, pre-formed queries are incorporated into the export flow.
    *   The `replaceColumnHandler` function, which modifies `pod` and `place_of_delivery` values from 'LONG BEACH' to 'LOS ANGELES', remained consistent throughout.
    *   The `console.log` statements were added for debugging purposes (`mainQuery::booking`, `mainQuery::non-booking`, `mainQuery::filteredData`, `===merge`).

**Timestamps of Significant Changes:**

*   **10/30/2025, 12:05:05 AM**: Introduction of a more complex CTE structure for `"Containers Shipped (Mbl Wise)"` in `export.query.ts`.
*   **10/30/2025, 11:46:42 AM**: Logic added in `core.export.controller.ts` to correctly handle `WITH` clauses in `customQuery` for certain reports to prevent erroneous query construction during export.
*   **10/30/2025, 4:53:29 PM**: Addition of `"Total Spend per Month ($)"` report query in `export.query.ts`.
*   **10/30/2025, 6:27:10 PM**: Addition of `"Average Transit Time per Month (Days)"` report query in `export.query.ts`.
*   **10/30/2025, 6:41:38 PM - 6:42:42 PM**: Refinement of CTE handling logic in `core.export.controller.ts`.

**Patterns and Recurring Elements:**

*   **Date Range Filtering**: Many queries consistently apply a date range filter using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.
*   **Company-Specific Filtering**: Queries frequently include `LOWER(account_name) = '${CompanyName}'` or `LOWER(m.account_name) = '${CompanyName.toLowerCase()}'` to filter data by company.
*   **Null and Empty String Checks**: Numerous `WHERE` clauses include checks like `IS NOT NULL` and `<> ''` for critical fields such as `mblno`, `bookingdate`, and `t49_vessel_actualdeparted_date`. This indicates data quality considerations and robust query design.
*   **Date Difference Calculations**: Several queries use `EXTRACT(DAY FROM date1 - date2)` or `DATE_PART('day', date1 - date2)` to calculate day differences, often categorizing them into time buckets (e.g., "Less than 1 week", "1 - 2 weeks").
*   **Stacked Bar Chart Logic**: Reports with "Stacked Bar" in their name (`BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`) consistently use `CASE WHEN day_diff < 7 THEN 'Less than 1 week' ... ELSE 'Above 5 weeks' END AS name` for categorization.
*   **MBL Wise vs. Container Wise Aggregation**: Queries differentiate between `DISTINCT ON (m.voyage,m.contno, ...)` for container-level uniqueness and `DISTINCT ON (LOWER(m.mblno))` for MBL (Master Bill of Lading) level uniqueness.
*   **Debugging Logs**: Extensive `console.log` and `logger.info` statements are present, indicating active debugging during development or recent issue resolution.
*   **Standard Utility Imports**: Both `booking.query.ts` and `core.export.controller.ts` import utility functions like `getColumnsByCategory`, `getFilterQueryByDisplayValue`, `defaultDateRange`, `getUserObject`, `columnsQuery`, `dateFilterOnExport`, and `saveColumns` from `../../../utils/analytics`.
*   **Code Customization Flag**: The `codeCustomization` boolean in `others.controller.ts` is used to bypass the generic `query(mainQuery)` execution for certain reports (like `TotalShipments`), suggesting some reports require specific data processing outside the standard query builder flow.