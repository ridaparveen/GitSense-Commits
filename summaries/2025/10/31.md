# Activity Summary for 10/31/2025

## 9:49:31 AM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-thirdparty\src\routes\external.routes.ts` was updated on 10/30/2025, 3:40:26 PM. This file establishes external API routes using Express.js. It imports and utilizes controllers from `v1` of `shipments`, `bookings`, `7501_duties`, `invoice`, and `isf` modules.

The defined routes are:
*   `/test`: A GET endpoint that returns a protected message including `req.companyname`.
*   `/tracking`: A GET endpoint handled by `shipments.getAll`.
*   `/booking`: A GET endpoint handled by `bookings.getAll`.
*   `/7501_duties`: A GET endpoint handled by `duties.getAll`.
*   `/invoice`: A GET endpoint handled by `invoice.getAll`.
*   `/isf`: A GET endpoint handled by `isf.getAll`.

A clear pattern emerges where most external data retrieval routes (tracking, booking, duties, invoice, isf) consistently call a `getAll` method from their respective controllers, all residing under a `v1` directory, suggesting API versioning.

## 9:49:32 AM
The provided log shows a series of frequent, incremental changes focused on refining SQL queries and their handling within a backend analytics application. All modifications occurred between October 29, 2025, and October 30, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**:
    *   This file, responsible for building SQL queries related to booking data, saw numerous minor updates across 20 entries.
    *   All changes were consistent and appear to be formatting adjustments (e.g., adding spaces, newlines, changing double quotes to single quotes for strings) or minor structural reorganizations within existing SQL query strings. No functional changes were introduced in these specific log entries; the core logic for `BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`, and `BookingDatetoActualDepartureMblWiseStackedBar` remained identical across these timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**:
    *   This file defines SQL query snippets for various reports used in export functionality.
    *   Between 10/30/2025, 12:05:05 AM and 10/30/2025, 12:28:49 AM, a significant change was made to the `"Containers Shipped (Mbl Wise)"` query. Initially, it was a simple `SELECT COUNT(DISTINCT m.mblno)` grouped by month and quarter. It was then expanded significantly into a complex Common Table Expression (CTE) structure (`WITH shipment_data AS (...) SELECT TO_CHAR(...)`) to extract more detailed shipment data including various tracking fields, and to classify quarters based on dynamic date ranges relative to `CURRENT_DATE`.
    *   A new report type, `"Total Spend per Month ($)"`, was introduced around 10/30/2025, 4:53:29 PM. This query uses a CTE (`date_series`, `invoice_data`) to calculate total spend per month, categorized by "This Quarter" and "Last Quarter" based on invoice dates from `cng_invoice` or `spr_invoice` tables, depending on the `CompanyName`.
    *   Another new report type, `"Average Transit Time per Month (Days)"`, was added around 10/30/2025, 6:27:10 PM. This also uses CTEs (`date_series`, `transit_data`) to calculate the average transit time (actual arrival date - actual departure date) grouped by month and quarter.
    *   There were minor formatting adjustments similar to `booking.query.ts` as well, such as changing quotes (`'`) and spacing.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**:
    *   This controller handles the export data requests.
    *   Around 10/30/2025, 11:46:42 AM, logic was added to handle specific report types (`"Containers Shipped (Mbl Wise)"`) that might provide a full SQL query including CTEs (starting with `WITH`). For such reports, the `mainQuery` is directly assigned the `customQuery` to avoid wrapping it in an unnecessary `SELECT * FROM (...)` subquery, which was causing errors.
    *   Further refinements were made to this CTE handling logic around 10/30/2025, 6:41:38 PM and 10/30/2025, 6:42:42 PM, ensuring that if a `customQuery` starts with `WITH`, it is used as the base query, and if not, it's integrated into a standard `SELECT * FROM (...)` structure. This indicates a fix for how complex, pre-formed queries are incorporated into the export flow.
    *   The `replaceColumnHandler` function, which modifies `pod` and `place_of_delivery` values from 'LONG BEACH' to 'LOS ANGELES', remained consistent throughout.
    *   The `console.log` statements were added for debugging purposes (`mainQuery::booking`, `mainQuery::non-booking`, `mainQuery::filteredData`, `===merge`).

**Timestamps of Significant Changes:**

*   **10/30/2025, 12:05:05 AM**: Introduction of a more complex CTE structure for `"Containers Shipped (Mbl Wise)"` in `export.query.ts`.
*   **10/30/2025, 11:46:42 AM**: Logic added in `core.export.controller.ts` to correctly handle `WITH` clauses in `customQuery` for certain reports to prevent erroneous query construction during export.
*   **10/30/2025, 4:53:29 PM**: Addition of `"Total Spend per Month ($)"` report query in `export.query.ts`.
*   **10/30/2025, 6:27:10 PM**: Addition of `"Average Transit Time per Month (Days)"` report query in `export.query.ts`.
*   **10/30/2025, 6:41:38 PM - 6:42:42 PM**: Refinement of CTE handling logic in `core.export.controller.ts`.

**Patterns and Recurring Elements:**

*   **Date Range Filtering**: Many queries consistently apply a date range filter using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.
*   **Company-Specific Filtering**: Queries frequently include `LOWER(account_name) = '${CompanyName}'` or `LOWER(m.account_name) = '${CompanyName.toLowerCase()}'` to filter data by company.
*   **Null and Empty String Checks**: Numerous `WHERE` clauses include checks like `IS NOT NULL` and `<> ''` for critical fields such as `mblno`, `bookingdate`, and `t49_vessel_actualdeparted_date`. This indicates data quality considerations and robust query design.
*   **Date Difference Calculations**: Several queries use `EXTRACT(DAY FROM date1 - date2)` or `DATE_PART('day', date1 - date2)` to calculate day differences, often categorizing them into time buckets (e.g., "Less than 1 week", "1 - 2 weeks").
*   **Stacked Bar Chart Logic**: Reports with "Stacked Bar" in their name (`BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`) consistently use `CASE WHEN day_diff < 7 THEN 'Less than 1 week' ... ELSE 'Above 5 weeks' END AS name` for categorization.
*   **MBL Wise vs. Container Wise Aggregation**: Queries differentiate between `DISTINCT ON (m.voyage,m.contno, ...)` for container-level uniqueness and `DISTINCT ON (LOWER(m.mblno))` for MBL (Master Bill of Lading) level uniqueness.
*   **Debugging Logs**: Extensive `console.log` and `logger.info` statements are present, indicating active debugging during development or recent issue resolution.
*   **Standard Utility Imports**: Both `booking.query.ts` and `core.export.controller.ts` import utility functions like `getColumnsByCategory`, `getFilterQueryByDisplayValue`, `defaultDateRange`, `getUserObject`, `columnsQuery`, `dateFilterOnExport`, and `saveColumns` from `../../../utils/analytics`.
*   **Code Customization Flag**: The `codeCustomization` boolean in `others.controller.ts` is used to bypass the generic `query(mainQuery)` execution for certain reports (like `TotalShipments`), suggesting some reports require specific data processing outside the standard query builder flow.

## 9:51:02 AM
The changes primarily focus on the `t360-frontend` application, with significant activity in the analytics and planboard sections. Most modifications occurred on October 28th and 29th, 2025, often in rapid succession, suggesting active development and debugging.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **10/28/2025 (2:02:33 PM, 3:48:07 PM, 5:53:50 PM):** This component, responsible for managing custom analytical views, was updated to include more debugging `console.log` statements (e.g., `viewOptions`, `viewName`). The core functionality of creating, editing, saving, deleting, and auditing views, along with checkbox selection logic for metrics (with a maximum limit of 9), remained consistent. It integrates with Redux for state management and an analytics API for data operations.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **10/28/2025 (2:04:34 PM, 3:46:33 PM, 3:46:51 PM):** This component, which renders a selectable tree of metrics, saw a brief, likely debugging-related, addition of "kk" to a label at 3:46:33 PM, which was then immediately reverted at 3:46:51 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/28/2025 (3:35:37 PM to 3:38:11 PM) & 10/29/2025 (11:09:14 AM to 11:56:24 AM) & 10/30/2025 (1:44:18 PM to 5:34:31 PM):** This configuration file defines default analytics endpoints, columns for Excel exports, and report headers for various analytics reports (CBM, TEU, KGS, Transit, Chassis metrics). Although there are many timestamps for this file, the provided snippets across these dates show identical content, indicating either no functional changes in the displayed sections or minor, uncaptured changes like whitespace or comments. The overall pattern is a comprehensive and expanding definition of report headers, categorized by "Container Wise" and "MBL Wise" metrics.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **10/28/2025 (4:05:26 PM, 4:08:24 PM):** A debugging `console.log` statement for `planboardData` was added at 4:08:24 PM. This component is responsible for displaying planboard data in either monthly or yearly card views, applying filters from Redux state.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **10/29/2025 (9:56:31 AM, 9:57:53 AM) & 10/30/2025 (5:37:40 PM):** This component handles export functionalities (Excel, PDF) and full-screen view for analytics metrics. Debugging `console.log` statements were added for `item` (9:57:53 AM) and `columns` during Excel export (10/30/2025). The component also features a `ColumnsSelector` modal for custom Excel exports.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **10/29/2025 (10:54:57 AM to 11:02:26 AM) & 10/29/2025 (5:27:47 PM):** This file saw numerous rapid changes, including:
        *   Minor label correction (`"Period1"` to `"Period"`).
        *   Frequent commenting/uncommenting of `PopoverPanel` for custom date ranges and `SelectBoxLight` components for "Period" and "View By" filters. This indicates active testing and iteration of filter visibility and functionality.
        *   Temporary addition and removal of `<h1>hhhhh</h1>` and correction of a syntax error (`<SwitchBox`).
        *   Addition of a `console.log` for `toolState` at 5:27:47 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **10/29/2025 (11:02:52 AM to 12:11:06 PM):** This component manages the rendering of various chart types (Bar, Pie, Line, StackedBar, Gauge) and integrates with `MetricToolbar` and `MetricFooter`. Changes included:
        *   Temporary commenting/uncommenting of the `MetricToolbar` component.
        *   Addition of debugging `console.log` statements for `item` and `data`.
        *   Adjustment in how chart data is sliced for display versus full-screen view (e.g., `item.data.slice(0, 9)` for initial view).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **10/29/2025 (11:45:45 AM to 5:20:39 PM):** This file was the most frequently and extensively modified, indicating a highly iterative development process for handling stacked bar chart data. Key changes include:
        *   Numerous adjustments to chart options, including `plotOptions.bar`, `xaxis`, `yaxis`, `legend`, `dataLabels`, and `tooltip` formatting.
        *   Significant flux in data processing logic within `useEffect`. Initially, it had a `generateYAxisData` function, then shifted to a `prepareStackedData` function for explicit "This Quarter" vs "Last Quarter" comparisons.
        *   It then moved to a more dynamic approach using an `isQuarterData` flag to adapt data series and categories based on whether quarter comparison data is present, reverting between these complex and simpler data aggregation methods multiple times.
        *   Further refinements were made to handle different `periodFilter` values ("quarter", "week", "month") and safely parse numerical data (e.g., `parseInt(d.container_count || "0", 10)`).
        *   Many `console.log` statements (`"===hgdatta===="`) were added for debugging the data input.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\AnalyticsContainer.jsx`**
    *   **10/29/2025 (4:53:53 PM):** This top-level container for analytics metrics was updated. It handles drag-and-drop reordering of metrics (`moveItem`) and saving of metric sizes (`saveSize`). It also contains the `fetchSingleReport` function which makes API calls for individual metric data and processes it using `metricsPackageHandler`. A debugging `console.log` for `mainState` was added.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/29/2025 (11:18:07 AM to 1:31:56 PM) & 10/30/2025 (5:53:02 PM to 6:44:44 PM):** This utility file contains logic for packaging metrics data (`metricsPackageHandler`), generating report formulas (`reportFormula`), formatting dates (`weekDateFormater`), and the `downloadReportSpreadsheet` function.
        *   The `findChartType` function in `metricsPackageHandler` was simplified, removing a specific check for "Containers Shipped (Mbl Wise)".
        *   The `downloadReportSpreadsheet` function received significant updates, introducing complex conditional logic to correctly format data for Excel export based on `chartType` (e.g., "StackedBar", "transitBar") and `periodFilter` (month, week, quarter).
        *   Specific handling was added for reports like "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Containers Shipped (Mbl Wise)" to ensure correct data mapping and numerical conversion during Excel export. There was some duplication of code for "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)" that was later corrected.

**Patterns and Recurring Elements:**

*   **Debugging focus:** A pervasive pattern is the addition of `console.log` statements across various components (`ViewContainer`, `TreeViewContianer`, `PlanboardCardView`, `MetricFooter`, `MetricToolbar`, `MetricsBox`, `StackedBarChart`). This indicates active, in-progress development and debugging.
*   **Analytics Dashboard Enhancement:** The majority of changes are concentrated on refining the analytics dashboard, specifically around custom view creation, dynamic chart rendering (especially stacked bar charts), and robust data export capabilities to Excel and PDF.
*   **Iterative Chart Data Handling:** The `StackedBarChart.jsx` and `methods.js` files demonstrate a highly iterative process for handling complex data structures (like quarter-over-quarter comparisons or time-series data aggregated by month/week/quarter) for charts and exports, with multiple reverts and re-implementations of logic.
*   **Redux Integration:** Components frequently access and dispatch actions to a Redux store (`state.analytics`, `state.settings`, `state.auth`) for managing application state, user information, and analytical filters.
*   **API Interaction:** Components like `ViewContainer` and `AnalyticsContainer` extensively use RTK Query hooks (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`, `useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`) to interact with a backend API for data fetching and persistence.

## 11:01:02 AM
The log details changes in the file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`, with the timestamp 10/31/2025, 10:31:50 AM.

This file primarily focuses on an analytics export controller, specifically the `getExportData` function, which handles the generation and export of various reports.

Key updates and functionalities include:

*   **Export Data Retrieval (`getExportData` function):**
    *   It processes `AuthenticatedRequest` to extract query parameters such as `fromDate`, `toDate`, `mblwise`, `booking`, `filterBy`, `reportName`, `stackedExport`, `displayBy`, `month`, `startWeek`, `endWeek`, `quarter`, `group`, and `columns`.
    *   Default date ranges (`fromDate`, `toDate`) are applied if not provided in the request.
    *   It retrieves user and company information using `getUserObject`.
    *   Column definitions are processed via `columnsQuery` and `saveColumns` for persistence.
*   **Conditional Query Generation (Booking vs. Non-Booking):**
    *   The core logic branches based on a `booking` parameter (`isBooking`).
    *   **Booking Reports:**
        *   Utilizes `bookingQuery` to construct a base query.
        *   Applies `DISTINCT ON` clauses for `mblwise` or container/voyage uniqueness.
        *   Integrates date filtering based on `filterBy`, `fromDate`, and `toDate`.
        *   Executes the `mainQuery` and filters data using `dateFilterOnExport`.
    *   **Non-Booking Reports:**
        *   Utilizes `nonBookingQuery` to build the custom query.
        *   A specific filtering logic is applied for "TEU MBLwise" reports, where duplicate entries (based on voyage, container number, and container type) have their `teu` value replaced with `'-'`.
        *   Data is then filtered using `dateFilterOnExport`.
*   **Column Value Replacement (`replaceColumnHandler` function):**
    *   This helper function is called on the final dataset before sending the response.
    *   It iterates through the data and replaces specific string values: `pod` (Port of Discharge) and `place_of_delivery` if they contain 'LONG BEACH' (case-insensitive) with 'LOS ANGELES'. This ensures consistency in location names.
*   **Error Handling:** A `try-catch` block is used to catch potential errors during query execution or data processing, responding with a 500 Internal Server Error.
*   **Logging:** Extensive use of `logger.info` and `console.log` statements for debugging and tracing request parameters, main queries, and data processing steps.

**Patterns and Recurring Elements:**

*   **Date Range Management:** Consistent handling of `fromDate` and `toDate` for filtering.
*   **User/Company Context:** Repeated retrieval of `CompanyName` and `usercode` via `getUserObject`.
*   **Query String Construction:** Dynamic SQL query building based on various request parameters, often combining base queries from `bookingQuery` or `nonBookingQuery` with additional filters and selections.
*   **Logging:** Frequent use of `logger.info` and `console.log` for debugging throughout the data flow.
*   **Data Transformation:** The `dateFilterOnExport` and `replaceColumnHandler` functions are consistently applied to the query results for final data preparation.

## 11:01:37 AM
The provided log details changes to a single file: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`.

The significant changes occurred between 10/31/2025, 10:23:35 AM and 10/31/2025, 10:26:57 AM.

**File-Specific Updates (`methods.js`):**
The `downloadReportSpreadsheet` asynchronous function was updated. Specifically, the logic for exporting "StackedBar" chart types to Excel was refined and standardized across several reports.

*   **Before (10:23:35 AM):** For reports like "Containers Shipped (Mbl Wise)" and "Total Spend per Month ($)", an `updatedData` array was first created to map and normalize the report data (e.g., handling `d.month` or `d.Month`, `d.This_Quarter` or `d.This Quarter`). This `updatedData` was then pushed to the `reportArray`. The "Average Transit Time per Month (Days)" report had a similar commented-out `updatedData` block, followed by `if/else if` conditions for `periodFilter` (month, week, quarter).
*   **After (10:26:57 AM):** The intermediate `updatedData` step was removed. The logic for "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", and "Average Transit Time per Month (Days)" was refactored to directly incorporate `if/else if` conditions based on the `periodFilter` (month, week, quarter) within the `reportArray.push` call. This streamlines the data mapping for different time granularities, directly extracting and formatting relevant fields (e.g., `d["month"].split(" ")[0]`, `weekDateFormater`, `d["quarter"]`) for the first column, and `d["This Quarter"]`, `d["Last Quarter"]` for subsequent columns.

**Patterns and Recurring Elements:**
The primary pattern observed is the standardization of data export logic for "StackedBar" reports. The changes consistently replace a two-step process (map `item.data` to `updatedData`, then push `updatedData`) with a direct, single-step mapping within the `reportArray.push` call that incorporates `periodFilter` logic. This ensures a uniform approach to handling month, week, and quarter aggregations for various stacked bar charts when generating Excel reports.

## 12:01:08 PM
In `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`, updated on **October 31, 2025, at 10:31:50 AM**, the `getExportData` function, responsible for generating analytics reports, received significant enhancements.

Key updates include:
*   **Dynamic Query Construction:** The function now dynamically builds SQL queries based on various request parameters such as `reportName`, `mblwise`, `booking` status, date ranges (`fromDate`, `toDate`), and a list of `columns`. It differentiates between "booking" and "non-booking" report types, calling respective helper functions (`bookingQuery`, `nonBookingQuery`) to generate specific query segments.
*   **Column Management:** It integrates utilities (`columnsQuery`, `saveColumns`) to handle user-selected columns for export, suggesting a feature for customizing report outputs.
*   **Date Range Handling:** Default date ranges are applied if not provided in the request, and date filters are consistently applied to SQL queries and potentially post-query data with `dateFilterOnExport`.
*   **Data Transformation and Standardization:**
    *   A new `replaceColumnHandler` function has been introduced to standardize port names in the exported data. Specifically, any occurrences of 'LONG BEACH' (case-insensitive) in `pod` (port of discharge) or `place_of_delivery` fields are replaced with 'LOS ANGELES' to ensure consistency.
    *   A specific data de-duplication logic is implemented for "TEU MBLwise" reports, where duplicate entries based on `voyage`, `contno`, and `contType` will have their `teu` value set to `'-'`.
*   **Logging:** Extensive `logger.info` and `console.log` statements have been added throughout the function for debugging and tracking the generated queries and data processing steps.

The recurring patterns in this update involve extensive use of dynamic SQL generation, conditional logic based on report types and parameters, and post-query data manipulation for standardization and specific report requirements.

## 12:01:35 PM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js` primarily contains utility functions for analytics within a frontend application. Key functionalities include `TruncateText` for display purposes, `metricsPackageHandler` for processing API responses into chart-ready data, `allChartOptions` and `chartOptionsByType` for defining available chart types, `reportFormula` for generating calculation strings, and `weekDateFormater` for date presentation. The most significant changes observed in the log relate to the `downloadReportSpreadsheet` function, which handles exporting various analytics reports to Excel.

On **10/31/2025, 10:23:35 AM**, the `downloadReportSpreadsheet` function was updated to support Excel export for several `StackedBar` chart types. This included detailed logic for reports like "Cargo-Ready Date to ETD (Stacked Bar)", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)". For "Containers Shipped (Mbl Wise)" and "Total Spend per Month ($)", the implementation involved an intermediate `updatedData` mapping to normalize `Month` and `Quarter` fields before populating the spreadsheet. The "Average Transit Time per Month (Days)" report, however, already used a direct mapping based on the `periodFilter` (month, week, quarter), with a commented-out section that hinted at a potential alternative `updatedData` approach.

A rapid follow-up change occurred on **10/31/2025, 10:26:57 AM**. This update refined the `downloadReportSpreadsheet` function to standardize the data processing for `StackedBar` charts. Specifically, the intermediate `updatedData` mapping previously used for "Containers Shipped (Mbl Wise)" and "Total Spend per Month ($)" was removed. Instead, these reports now directly map data based on the `periodFilter` (month, week, quarter) in a manner consistent with other `StackedBar` reports. This change streamlined the export logic, ensuring a uniform approach to handling time-series data for stacked bar charts across different periods. The commented-out code for "Average Transit Time per Month (Days)" was also removed in this revision.

A recurring pattern in this file is the extensive use of `moment.js` for date formatting and `ExcelJS` for generating Excel workbooks. The `downloadReportSpreadsheet` function repeatedly checks `item?.customizer?.chartType` and `item.reportName` to apply specific data transformation and formatting rules for different report types and `periodFilter` values (month, week, quarter), often utilizing the `weekDateFormater` utility.

## 2:14:11 PM
The provided log details changes across two files related to an analytics frontend component. All modifications occurred on October 31, 2025, indicating a focused development effort.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/31/2025, 10:23:35 AM:** This initial log entry for the file shows the `downloadReportSpreadsheet` function containing logic for generating Excel reports. It has specific handling for various "StackedBar" chart types, including "Cargo-Ready Date to ETD (Stacked Bar)", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)". The implementation for "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", and "Average Transit Time per Month (Days)" was in a state of transition, with some commented-out logic and an incomplete `periodFilter` structure for "Average Transit Time per Month (Days)".
    *   **10/31/2025, 10:26:57 AM:** A significant update occurred where the `downloadReportSpreadsheet` function was refined. The commented-out logic for "Average Transit Time per Month (Days)" was removed, and the data mapping for "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", and "Average Transit Time per Month (Days)" was standardized. These reports now consistently use `if (periodFilter === "month")`, `else if (periodFilter === "week")`, and `else if (periodFilter === "quarter")` blocks to format data for Excel, aligning with the pattern used by "Cargo-Ready Date to ETD (Stacked Bar)".
    *   **10/31/2025, 12:30:38 PM & 10/31/2025, 12:31:21 PM:** Minor debugging `console.log` statements (`"====hhjjjk"`, `"jjjj"`) were added to inspect `headerCopy` and `item` within the `downloadReportSpreadsheet` function.
    *   **10/31/2025, 1:28:39 PM:** The report name string checked for "Containers Shipped (Mbl Wise)" was briefly changed to "Containers Shipped" in the `downloadReportSpreadsheet` function.
    *   **10/31/2025, 1:36:18 PM:** The report name change from the previous entry was reverted, restoring `item.reportName === "Containers Shipped (Mbl Wise)"` to its original state.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/31/2025, 12:33:31 PM:** This file defines essential configuration for the analytics module. It contains `DEFAULT_ANALYTICS_ENDPOINTS` (listing various CBM and TEU report URLs), `EXCEL_EXPORT_COLUMNS` (a comprehensive list of fields for general Excel exports), `CargoReadyToETD10Days` (specific columns for a particular report), and `ANALYTICS_REPORT_HEADER` (a large object mapping various report names to their display headers, including complex multi-column headers for transit reports, and new "Container by Ocean Freight Carrier (SCAC)" and "Container by Port of Loading" headers).
    *   **10/31/2025, 1:36:25 PM:** No discernible functional changes were introduced in this log entry; the content remains identical to the previous timestamp.

**Patterns and Recurring Elements:**

*   **Excel Report Generation:** A primary focus of these changes is enhancing and standardizing the logic for exporting analytics data to Excel spreadsheets, particularly for stacked bar charts.
*   **Standardization of StackedBar Logic:** Multiple "StackedBar" reports within `methods.js` were updated to use a consistent `periodFilter` (month, week, quarter) based data formatting for Excel export, improving maintainability and reducing redundancy.
*   **Debugging Efforts:** The insertion and subsequent removal (or non-persistence in the final state of the log) of `console.log` statements suggest active debugging during the development period.
*   **Report Name Adjustments:** A brief modification and reversion of a report name string indicates ongoing refinement or correction in how reports are identified and processed.
*   **Configuration Management:** The `analytics.js` file serves as a central repository for analytics-related configurations, including API endpoints, column definitions for exports, and report headers.

## 2:14:30 PM
This log primarily details changes across two files related to analytics export functionality: `core.export.controller.ts` and `export.query.ts`. The changes occurred frequently between 10:31 AM and 1:58 PM on October 31, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **10/31/2025, 10:31:50 AM:** The initial state of the `getExportData` function. It included logic to construct `mainQuery` for booking reports, checking if `customQuery` started with `WITH` to handle Common Table Expressions (CTEs). A `replaceColumnHandler` function was present to standardize 'LONG BEACH' to 'LOS ANGELES' in `pod` and `place_of_delivery` fields.
    *   **10/31/2025, 12:22:58 PM - 12:49:13 PM (Multiple entries):** This period shows a series of rapid modifications and reversions in how the `mainQuery` for booking reports is assembled. Initially, the check for `customQuery` starting with `WITH` was commented out, forcing a uniform wrapping of all `customQuery` inputs. Then, there was an attempt to explicitly construct `FROM`/`WHERE` clauses around `customQuery`, followed by a reversion to the earlier wrapping pattern. The `ORDER BY` clause was temporarily changed from `departure_date ASC` to `${filterBy} ASC` but was quickly reverted. Debugging `console.log` statements for `mainQuery` and `customQuery` were added.
    *   **10/31/2025, 1:39:02 PM:** A conditional logic for `mainQuery` construction was reintroduced to differentiate between CTE-based `customQuery` (starting with "WITH") and regular query fragments. However, it initially incorrectly wrapped even CTEs within another `SELECT * FROM (...) AS data`.
    *   **10/31/2025, 1:39:24 PM:** This issue was corrected. If `customQuery` starts with "WITH", it is now directly assigned to `mainQuery`, otherwise, it's wrapped in a subquery structure.
    *   **10/31/2025, 1:45:46 PM:** An additional conditional step was introduced for post-query data processing. If the `customQuery` was a CTE, the raw query results (`excelExportData.rows`) would be returned directly, bypassing `dateFilterOnExport` and `replaceColumnHandler`. For non-CTE queries, these processing steps would still apply.
    *   **10/31/2025, 1:48:05 PM:** The conditional data processing logic introduced at 1:45:46 PM was removed. The `dateFilterOnExport` and `replaceColumnHandler` functions are now always applied to `excelExportData.rows` before sending the response, regardless of whether `customQuery` was a CTE.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **10/31/2025, 12:26:25 PM:** This file defines a `getMonthValue` helper function and `bookingQuery`, a dictionary of SQL query fragments for various reports. Reports generally start with `,EXTRACT(...)` or `WITH ... SELECT ...` and filter by company name and date ranges. Some queries at the end were truncated in the log.
    *   **10/31/2025, 12:28:48 PM - 1:33:25 PM (Multiple entries):** No functional changes observed in the provided snippets during this period, indicating minor saving events or changes outside the logged portions.
    *   **10/31/2025, 1:35:58 PM:** A new report query, `"Containers Shipped (Mbl Wise)"`, was added. This query was initially a complex, aggregated CTE-based SQL statement that included conditional `CASE WHEN` logic for date calculations and hardcoded 'sp richards company' as the account name.
    *   **10/31/2025, 1:49:49 PM:** The `"Containers Shipped (MBL Wise)"` query was significantly refactored. It transformed from a CTE-based aggregated query into a direct `SELECT DISTINCT ON` statement designed to return detailed rows with computed fields like `final_delivery_date`. The hardcoded company name was replaced with the dynamic `CompanyName` variable. Additional `WHERE` clauses for `mblno` and `cbm` were added, and the `stackedExport` and `displayBy` conditional filters were adjusted. This version of the query focuses on selecting raw shipment details rather than aggregated counts.

**Patterns and Recurring Elements:**

*   **Date Filtering and Manipulation:** Many queries involve `EXTRACT(DAY FROM ... - ...)` to calculate date differences and use `FROM_DATE::timestamp` and `TO_DATE::timestamp + INTERVAL '1 day'` for date range filtering. The `getMonthValue` helper function is consistently used for month-based filtering.
*   **Company Name Filtering:** Almost all queries filter data by `LOWER(account_name) = LOWER('${CompanyName}')`, indicating a multi-tenancy or client-specific data access pattern.
*   **Data Validation:** Repeated checks like `IS NOT NULL`, `<> ''`, and `!= '0001-01-01 00:00:00 BC'` for date fields are common, suggesting an emphasis on handling incomplete or default data entries in the database.
*   **Conditional Query Generation:** Both `core.export.controller.ts` and `export.query.ts` frequently use conditional logic (`if(isBooking)`, `stackedExport === "true" ? ... : ...`) to dynamically build SQL queries based on report parameters like `mblwise`, `stackedExport`, `displayBy`, and `stackedGroup`.
*   **Port Name Standardization:** The `replaceColumnHandler` in `core.export.controller.ts` consistently replaces 'LONG BEACH' with 'LOS ANGELES' for `pod` and `place_of_delivery`, indicating a data cleansing or standardization requirement for export data.
*   **Debugging:** The presence of `console.log` statements for `mainQuery` and `customQuery` points to active debugging during development of the query generation logic.
*   **SQL Query Structure Evolution:** The `core.export.controller.ts` file shows a significant back-and-forth in determining the correct wrapper for `customQuery`, especially concerning `WITH` clauses, highlighting the complexity of handling diverse SQL inputs. The `export.query.ts` also shows a shift in one report from an aggregated CTE-based query to a detailed raw-data `SELECT` query.

## 3:14:09 PM
The changes primarily affect two JavaScript files related to analytics functionality within a frontend application: `methods.js` and `analytics.js`, with a new file `report_options.js` introduced.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
This file, updated multiple times between 10/31/2025, 10:23:35 AM and 1:36:18 PM, focuses on handling and exporting analytics data.
*   **Initial State (10:23:35 AM)**: The `downloadReportSpreadsheet` function contained extensive logic for exporting various analytics reports to Excel, with specific handling for "StackedBar" chart types and different `periodFilter` options (month, week, quarter). The logic for "Containers Shipped (Mbl Wise)" and "Total Spend per Month ($)" reports processed data into an `updatedData` object before mapping for export.
*   **Refactoring and Consolidation (10:26:57 AM)**: A significant change involved refactoring the data mapping logic within `downloadReportSpreadsheet` for "Containers Shipped (Mbl Wise)" and "Total Spend per Month ($)" reports. Instead of an intermediate `updatedData` step, these reports were updated to directly map `item.data` based on the `periodFilter` (month, week, quarter), aligning their structure with other similar stacked bar reports like "Average Transit Time per Month (Days)". This standardized the data processing for these report types.
*   **Debugging and Minor Adjustments (12:30:38 PM, 12:31:21 PM)**: Two `console.log` statements were added within `downloadReportSpreadsheet` (`console.log("====hhjjjk",headerCopy);` and `console.log("jjjj",item);`), indicating active debugging during development.
*   **Report Name Change and Reversion (1:28:39 PM, 1:36:18 PM)**: The report name "Containers Shipped (Mbl Wise)" was temporarily changed to "Containers Shipped" at 1:28:39 PM, then reverted back to "Containers Shipped (Mbl Wise)" at 1:36:18 PM. This suggests a brief experiment with report naming or an accidental change that was quickly corrected.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
This configuration file was modified twice between 10/31/2025, 2:45:55 PM and 2:46:58 PM.
*   **Temporary Text Change (2:45:55 PM)**: A minor, likely debugging or cosmetic, change was made to the `EXCEL_EXPORT_COLUMNS` array. The `name` property for the `completed_date` key was updated from "Completed Date" to "Completed Date123".
*   **Reversion (2:46:58 PM)**: This change was quickly reverted, restoring the `name` of `completed_date` back to "Completed Date".

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\report_options.js`**
This file was added or first appeared in the log at 10/31/2025, 2:47:32 PM.
*   **New Configuration Data**: This file defines various constant arrays for report options, including `scheduleOptions`, `filterByColumnOption`, `timeOptions` (for hours, minutes, AM/PM), `timeOptionsDaily`, `weekOptions`, and `monthOptions`. These constants likely provide selectable options for scheduling reports or filtering data in the analytics UI.

**Patterns and Recurring Elements:**
*   **Analytics-Focused Development**: All changes are concentrated on the analytics section of the application, particularly related to data handling, report generation, and Excel exports.
*   **StackedBar Report Logic Refinement**: There's a clear pattern of refining and standardizing how data is processed and formatted for "StackedBar" chart types within the `downloadReportSpreadsheet` function.
*   **Debugging Activities**: The addition and removal of `console.log` statements and a temporary text change in `analytics.js` suggest active debugging and testing during this period.
*   **Configuration Updates**: There are continuous updates to configuration files (`analytics.js`, `report_options.js`) to support the evolving analytics features.
*   **Timestamp Proximity**: The changes, especially within `analytics.js`, happened in very close succession, indicating rapid iterations or quick fixes.

## 3:15:11 PM
The changes log details updates across several files related to an analytics export feature in a backend application. The development activity centers around generating and executing complex SQL queries for various reports, with an emphasis on data formatting and conditional logic.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**
    *   **Timestamp: 10/31/2025, 10:31:50 AM**
        *   Introduces the `getExportData` function, which serves as the primary endpoint for analytics data export. It dynamically constructs a `mainQuery` based on request parameters (`fromDate`, `toDate`, `reportName`, `mblwise`, `booking`, `filterBy`, etc.).
        *   It uses utility functions like `defaultDateRange`, `columnsQuery`, `getUserObject`, `saveColumns`, `dateFilterOnExport`, and `replaceColumnHandler`.
        *   The `mainQuery` for booking reports initially includes logic to check if a `customQuery` starts with `WITH`, implying it might be a Common Table Expression (CTE), but this check is later commented out.
        *   A `replaceColumnHandler` function is present to standardize 'LONG BEACH' to 'LOS ANGELES' in `pod` and `place_of_delivery` fields.
        *   Special filtering is applied for "teu" and "mbl" reports.
    *   **Timestamp: 10/31/2025, 12:22:58 PM - 12:49:13 PM**
        *   This period shows a series of rapid changes and reversions related to the `mainQuery` construction within the `if(isBooking)` block.
        *   The `WITH` clause detection logic is repeatedly commented out and then (partially) restored, indicating uncertainty or debugging around how to integrate CTEs from `bookingQuery`.
        *   At 12:41:48 PM, the `mainQuery` structure for booking is changed to explicitly include `FROM mtr_tracking_data m LEFT JOIN agent_booking_entry a ON ... WHERE ...` which suggests `customQuery` was expected to be a fragment. This was quickly reverted by 12:44:42 PM, reverting to the original assumption that `customQuery` might contain `FROM` and `WHERE`.
        *   At 12:48:16 PM, date filtering is temporarily removed from the main query wrapper, then restored at 12:49:13 PM.
    *   **Timestamp: 10/31/2025, 1:22:31 PM - 1:25:12 PM**
        *   Introduction and subsequent reversion of dynamic `ORDER BY ${filterBy} ASC` clause to a fixed `ORDER BY departure_date ASC` within the booking query.
        *   Several `console.log` statements are added for debugging `customQuery`, `mainQuery`, and filtered data.
    *   **Timestamp: 10/31/2025, 1:39:02 PM - 1:48:05 PM**
        *   A significant functional change at 1:39:02 PM correctly re-introduces the `if (customQuery.trim().toUpperCase().startsWith("WITH"))` check, allowing CTEs to be executed directly (`mainQuery = customQuery;`) without being wrapped in an outer `SELECT * FROM (...)` statement. This is further refined at 1:39:24 PM.
        *   At 1:45:46 PM, post-query processing (`dateFilterOnExport`, `replaceColumnHandler`) is made conditional: applied only for non-CTE queries. This change is then fully reverted at 1:48:05 PM, restoring the previous behavior of always applying these transformations.
    *   **Timestamp: 10/31/2025, 2:34:52 PM - 2:37:25 PM**
        *   More `console.log` statements are added for debugging various query parameters.
        *   The `WITH` clause detection logic for `customQuery` continues to be toggled (commented out then restored).
    *   **Timestamp: 10/31/2025, 2:53:46 PM**
        *   Modified the `mainQuery` for booking to qualify `filterBy` with `m.` (`m.${filterBy}`) in both the `WHERE` and `ORDER BY` clauses.
    *   **Timestamp: 10/31/2025, 2:58:40 PM - 2:59:33 PM**
        *   A temporary bug is introduced by changing `mblwise === 'true'` to `mblwise === ''` and `booking === 'true'` to `booking === 'false'`, which are quickly reverted in subsequent commits.
    *   **Timestamp: 10/31/2025, 3:02:56 PM**
        *   The `m.` qualification for `filterBy` is reverted, removing the explicit table alias.
    *   **Timestamp: 10/31/2025, 3:04:53 PM**
        *   Additional `console.log` statements are added for filtered and merged data.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **Timestamp: 10/31/2025, 12:26:25 PM**
        *   Introduces the `getMonthValue` helper function and the `bookingQuery` function, which maps `reportName` strings to corresponding SQL query fragments.
        *   Queries are for various booking-related metrics, some of which are complex CTE-based aggregates (e.g., "Average Transit Time per Month (Days)"). They rely heavily on string interpolation for dynamic parameters.
    *   **Timestamp: 10/31/2025, 12:28:48 PM - 1:33:25 PM**
        *   No functional changes in this period; likely saves or minor formatting adjustments.
    *   **Timestamp: 10/31/2025, 1:35:58 PM**
        *   A new report query, `"Containers Shipped (Mbl Wise)"`, is added. This is a complex CTE-based query designed for aggregation.
    *   **Timestamp: 10/31/2025, 1:49:49 PM**
        *   The `"Containers Shipped (MBL Wise)"` query is significantly changed from a CTE-based aggregate to a `SELECT DISTINCT ON` query that returns detailed row-level data with a calculated `final_delivery_date`.
    *   **Timestamp: 10/31/2025, 2:22:48 PM**
        *   The `"Containers Shipped (MBL Wise)"` query is reverted back to a CTE-based aggregation, similar to its initial addition, which provides summarized results.
    *   **Timestamp: 10/31/2025, 2:55:45 PM**
        *   The `"Containers Shipped (MBL Wise)"` query is again reverted to the detailed `SELECT DISTINCT ON` format, adding a condition for `m.cbm` not being null or empty.
    *   **Timestamp: 10/31/2025, 3:01:06 PM - 3:02:24 PM**
        *   No functional changes.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**
    *   **Timestamp: 10/31/2025, 1:28:00 PM**
        *   This is a newly introduced file, separate from `export.query.ts`. It defines `bookingQueryBuilder`, a more structured function for generating booking analytics queries.
        *   It uses a `customizer` object to configure report characteristics (e.g., chart type, aggregation type).
        *   Contains queries for "BookingDatetoActualDeparture", "BookingDatetoActualDepartureMblWise", and "Stacked Bar" versions of these reports. All generated queries are full SQL statements (using CTEs), not fragments.

4.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**
    *   **Timestamp: 10/31/2025, 2:47:46 PM**
        *   This file provides a suite of utility functions for analytics processing:
            *   `defaultDateRange`: Provides a 365-day default date range.
            *   `replaceValueInQuery`: A string replacement helper, specifically for `pod` and `place_of_delivery`.
            *   `getUserObject`: Fetches user/company details.
            *   `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `dateTrunc`, and `SELECT` clauses based on `displayBy` (month, week, quarter).
            *   `getExcelSelectedColumns`: Selects specific columns for different reports ("Cargo-Ready Date to ETD", "BL Release KPI", general booking/non-booking).
            *   `dateFilterOnExport`: Formats and validates date strings in data rows, converting them to 'MM/DD/YYYY' or `null` if invalid (e.g., '0000-01-01T00:00:00.000Z').
            *   `EXCEL_EXPORT_COLUMNS`: A comprehensive list of column mappings for Excel export.
    *   **Timestamp: 10/31/2025, 2:50:11 PM**
        *   No functional changes.

### Patterns and Recurring Elements:

*   **Dynamic Query Construction:** A core pattern is the dynamic generation of SQL queries using string templates, incorporating user-defined filters, date ranges, and report types.
*   **Location Normalization:** Consistently replacing 'LONG BEACH' with 'LOS ANGELES' in location fields across the dataset for consistency.
*   **Date Handling and Validation:** Robust date handling is evident through `defaultDateRange`, the `dateFilterOnExport` function (which standardizes date formats and filters out invalid "0001-01-01 BC" dates), and date filtering clauses in SQL queries.
*   **Debugging:** Frequent addition and removal of `console.log` statements in `core.export.controller.ts` highlight an iterative and debugging-intensive development process, particularly around query formation and data processing.
*   **CTE Integration Challenges:** A prominent pattern is the struggle and refinement in `core.export.controller.ts` to correctly handle `customQuery` that are complete SQL statements (especially CTEs) versus query fragments. The `if (customQuery.trim().toUpperCase().startsWith("WITH"))` check is a recurring element, indicating an evolving strategy to avoid double-wrapping full SQL queries.
*   **Report Query Evolution:** The "Containers Shipped (MBL Wise)" report in `export.query.ts` shows a back-and-forth between a detailed, raw data output and an aggregated, CTE-based summary. This suggests experimentation with the desired output format or resolution of integration challenges with the controller.

## 4:13:59 PM
The provided log details changes across two files: `core.export.controller.ts` and `export.query.ts`, both related to analytics export functionality in a backend application.

### File-Specific Updates:

#### `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`

*   **Timestamp Range:** 10/31/2025, 10:31:50 AM to 10/31/2025, 3:29:32 PM
*   **Key Changes:**
    *   **Initial Logic:** The file initially defined `getExportData` to handle both booking and non-booking report exports, building `mainQuery` based on `isBooking` flag and `customQuery` from `bookingQuery` or `nonBookingQuery` functions. It applied `DISTINCT ON` logic for `mblWiseQuery` and date filtering.
    *   **Query Construction Refinement (10/31/2025, 12:22:58 PM):** The conditional `if (customQuery.trim().toUpperCase().startsWith('WITH'))` block for `mainQuery` construction was commented out in the `isBooking` section, simplifying the `mainQuery` to always wrap the `customQuery` within a `SELECT * FROM (...) as data` structure.
    *   **Further Query Construction Refinement (10/31/2025, 12:41:48 PM):** The `mainQuery` for booking reports was modified to explicitly include `FROM mtr_tracking_data m LEFT JOIN agent_booking_entry a ON LOWER(m.mblno) = LOWER(a.mblno) WHERE LOWER(m.account_name) = LOWER('${CompanyName}')` and append the `customQuery` conditionally.
    *   **Reversion of Query Construction and Minor Change (10/31/2025, 12:44:42 PM - 12:49:13 PM):** The query construction pattern reverted to its earlier state, where `customQuery` directly followed `COLUMNS` in the `SELECT` statement and included its own `AND` clause for date filtering. A minor change on `10/31/2025, 1:24:41 PM` briefly changed `ORDER BY departure_date ASC` to `ORDER BY ${filterBy} ASC`, but this was immediately reverted in the next commit.
    *   **Debugging/Logging Additions (10/31/2025, 1:22:31 PM, and recurring):** Multiple `console.log` statements were added (e.g., `mainQuery::customQuery`, `mainQuery::booking`, `mainQuery::filteredData`, `===merge`) for debugging purposes, which are visible in several subsequent commits.
    *   **Conditional Data Transformation (10/31/2025, 1:45:46 PM):** A significant change was introduced for booking reports: if `customQuery` starts with "WITH" (indicating a CTE-based, likely aggregated query), `excelExportData.rows` is returned directly without further `dateFilterOnExport` or `replaceColumnHandler` transformations. Otherwise, the data goes through the filtering and replacement pipeline. This logic was then immediately removed in the next commit (`10/31/2025, 1:48:05 PM`), reverting to the previous behavior of always filtering and replacing.
    *   **Restoration of CTE Handling (10/31/2025, 1:58:29 PM & 1:58:45 PM):** The conditional logic for handling CTE queries (`customQuery.trim().toUpperCase().startsWith("WITH")`) was re-introduced. This time, it specifically checks for "SELECT" instead of "WITH", wrapping the "SELECT" query inside a `SELECT * FROM (SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery}) AS data ORDER BY departure_date ASC;`. This logic was again promptly reverted.
    *   **Revised CTE Handling and Filter Column (10/31/2025, 2:53:46 PM):** The `mainQuery` for booking reports was updated to explicitly use `m.${filterBy}` instead of just `${filterBy}` for the date filtering in the `WHERE` clause (e.g., `m.${filterBy} >= ... AND m.${filterBy} < ...`). This change appears to have been reverted quickly.
    *   **Fix `mblWiseQuery` Logic (10/31/2025, 2:58:40 PM):** The condition for `mblWiseQuery` was changed from `mblwise === 'true'` to `mblwise === ''`, which likely introduced a bug, and was immediately corrected back to `mblwise === 'true'` in the next commit.
    *   **Final CTE Handling Adjustment (10/31/2025, 3:21:35 PM):** The logic for CTE-based `customQuery` was finalized. If `customQuery` starts with 'WITH', `mainQuery` is set directly to `customQuery`. Otherwise, it's wrapped in the standard `SELECT * FROM (SELECT ...) AS data ORDER BY ...`. This change was reverted, then re-applied indirectly.
    *   **Consistent Query Structure (10/31/2025, 3:28:48 PM & 3:29:32 PM):** The `mainQuery` for booking reports was modified to wrap the `customQuery` in a subquery `FROM ( ${customQuery} ) AS subquery` to allow applying `DISTINCT ON` and date filtering on the result of `customQuery`. This was quickly reverted to the prior structure.
    *   **Console Log Adjustments:** Throughout the changes, there are frequent additions and removals of `console.log` statements, indicating active debugging.

#### `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`

*   **Timestamp Range:** 10/31/2025, 12:26:25 PM to 10/31/2025, 4:04:34 PM
*   **Key Changes:**
    *   **`getMonthValue` Function:** This helper function remains consistent throughout, mapping short month names (e.g., "Jan") to their numeric values.
    *   **`bookingQuery` Function:** This function constructs SQL query strings based on `reportName` and other parameters.
    *   **Addition of "Containers Shipped (Mbl Wise)" Report Query (10/31/2025, 1:35:58 PM):** A new, complex SQL query using Common Table Expressions (CTEs) (`WITH date_series AS (...)`, `shipment_data AS (...)`) was added for the "Containers Shipped (Mbl Wise)" report. This query calculates container shipments per month, distinguishing between "This Quarter" and "Last Quarter" based on `delivery_customer_date` or `updated_inland_arv_date`. It also includes conditional filtering for `stackedExport`, `displayBy` (month, week, quarter), and `stackedGroup`.
    *   **Simplification of "Containers Shipped (MBL Wise)" (10/31/2025, 1:49:49 PM):** The complex CTE query for "Containers Shipped (MBL Wise)" was removed. It was replaced with a much simpler `SELECT DISTINCT ON (LOWER(m.mblno))` query that selects various columns directly from `mtr_tracking_data` and `agent_booking_entry`, with conditional filtering for `stackedExport` based on `displayBy` (month, week, quarter).
    *   **Re-introduction and Refinement of CTE for "Containers Shipped (MBL Wise)" (10/31/2025, 2:22:48 PM):** The detailed CTE-based query for "Containers Shipped (MBL Wise)" was re-introduced and further refined. It now explicitly filters `base_shipments` by `fromDate` and `toDate` for `delivery_customer_date` or `updated_inland_arv_date`. The outer `SELECT` aggregates `mbl_count` for "This Quarter" and "Last Quarter" based on `final_delivery_date`.
    *   **Removal of CTE Wrapping (10/31/2025, 2:23:26 PM):** The `Containers Shipped (Mbl Wise)` report query was reverted to a non-CTE based query.
    *   **Reversion of "Containers Shipped (MBL Wise)" to original non-CTE and addition of date filters (10/31/2025, 2:51:55 PM):** The `Containers Shipped (MBL Wise)` query was changed to a simple `SELECT DISTINCT ON` query, and it now includes `AND m.cbm IS NOT NULL AND TRIM(m.cbm) <> ''` and date filtering (`m.departure_date`) in the main `WHERE` clause.
    *   **Further Modification of "Containers Shipped (MBL Wise)" (10/31/2025, 3:14:37 PM):** The `Containers Shipped (Mbl Wise)` query was changed again to a CTE-based query. This version includes date ranges (`fromDate`, `toDate`) and adds more detailed `CASE` statements for `quarter` calculation within the `shipment_data` CTE. It also includes an additional `CASE` statement for `stackedGroup` filtering based on date differences, indicating a calculation for "transit time groups" (Under 1 month, 1-2 months, etc.).
    *   **Simplification of "Containers Shipped (MBL Wise)" (10/31/2025, 3:39:12 PM):** The "Containers Shipped (MBL Wise)" query was simplified, removing the `WITH` clauses and retaining only `EXTRACT(DAY FROM m.delivery_customer_date - m.updated_inland_arv_date) AS day_diff` and similar conditional logic, mimicking the structure of other "day\_diff" queries.
    *   **Reintroduction of Count and Group By for "Containers Shipped (MBL Wise)" (10/31/2025, 3:45:39 PM):** The `Containers Shipped (MBL Wise)` query was updated to include `COUNT(DISTINCT m.contno) AS container_count` and a `GROUP BY` clause. It retains the `stackedExport` conditional logic for date filtering.
    *   **Final Refinement for "Containers Shipped (MBL Wise)" (10/31/2025, 3:50:18 PM):** The `Containers Shipped (MBL Wise)` query was further refined to group by all selected columns to correctly use `DISTINCT ON` logic in conjunction with aggregation and `stackedExport` filtering.

### Patterns and Recurring Elements:

*   **Date Handling:**
    *   A `getMonthValue` helper function is consistently used to convert month strings or numbers into a numeric month value for SQL queries.
    *   Date filtering in SQL queries almost always uses `m.departure_date >= '${fromDate}'::timestamp AND m.departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.
    *   There's a utility function `dateFilterOnExport` that sanitizes and formats date values in the results, replacing invalid dates with `null` and formatting valid ones to "MM/DD/YYYY".
*   **Company Name Filtering:** All SQL queries consistently filter by `LOWER(account_name) = LOWER('${CompanyName}')`, indicating a multi-tenant or company-specific data access model.
*   **MBL-wise and Container Type Distinctness:** The `mblWiseQuery` variable frequently uses `DISTINCT ON (LOWER(m.mblno))` or `DISTINCT ON (m.voyage,m.contno, CASE WHEN t49_cont_type IS NOT NULL AND TRIM(t49_cont_type) <> '' AND TRIM(t49_cont_type) != '0' THEN t49_cont_type ELSE cont_type END )` to prevent duplicate records based on either MBL number or a combination of voyage, container number, and container type.
*   **Stacked Bar Report Logic:** Several queries (e.g., "Booking Date to Actual Departure (Stacked Bar)", "Booking Date to Actual Departure (MBL Wise Stacked Bar)") include conditional logic (`${stackedExport === "true" ? ... : ``}`) to apply additional filters and group by duration categories (e.g., "Less than 1 week", "1-2 weeks"). These conditions also dynamically apply date filters (`EXTRACT(MONTH FROM m.departure_date)`, `m.departure_date >= '${startWeek}'::timestamp`, `EXTRACT(QUARTER FROM m.departure_date)`) based on the `displayBy` parameter.
*   **Error Handling:** Both `core.export.controller.ts` and `export.query.ts` files use `try...catch` blocks for error handling, logging errors, and sending a 500 status code with an "Internal Server Error" message on failure.
*   **Column Selection:** The `COLUMNS` variable (derived from `columnsQuery` and passed from the request) and `getExcelSelectedColumns` function are used to dynamically select columns for the export.
*   **Port Name Normalization:** The `replaceColumnHandler` function is consistently applied to replace 'LONG BEACH' with 'LOS ANGELES' in the `pod` and `place_of_delivery` fields, ensuring data consistency.
*   **Debugging:** Extensive `console.log` statements are present throughout `core.export.controller.ts`, indicating active development and debugging.
*   **Query Structure Variability:** The `bookingQuery` function shows significant churn in the "Containers Shipped (MBL Wise)" report query, oscillating between complex CTEs, simpler `DISTINCT ON` queries, and different aggregation methods, suggesting an iterative process of optimizing or correcting the query logic for this specific report.
*   **Date Validation:** The `isValidDate` helper function is used to check for valid date strings, specifically excluding "0000-01-01T00:00:00.000Z" and dates before 1973.

## 4:14:12 PM
The code changes log details updates across three JavaScript files within the `t360-frontend` project, all occurring on **10/31/2025**.

**File-Specific Updates:**

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/31/2025, 10:23:35 AM**: The `downloadReportSpreadsheet` function, responsible for exporting analytics data to Excel, was updated. Initial code included a `updatedData` mapping for specific `StackedBar` reports ("Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)") which was then not used, suggesting potential redundancy. The entry ends with a cut-off `else if` block, indicating ongoing development.
    *   **10/31/2025, 10:26:57 AM**: The redundant `updatedData` mapping logic for the aforementioned `StackedBar` reports within `downloadReportSpreadsheet` was removed. Data processing for these reports was streamlined to directly use `item.data` within `month`, `week`, and `quarter` period filters. The file still ends with an incomplete `else if` statement.
    *   **10/31/2025, 12:30:38 PM & 12:31:21 PM**: Minor debugging `console.log` statements (`"====hhjjjk"`, `"jjjj"`) were added to the `downloadReportSpreadsheet` function, likely for inspecting `headerCopy` and `item` values during development. The incomplete `else if` condition persists.
    *   **10/31/2025, 1:28:39 PM**: A change in the `downloadReportSpreadsheet` function modified the report name condition from `"Containers Shipped (Mbl Wise)"` to `"Containers Shipped"` for a `StackedBar` chart, affecting how this specific report's data is handled during export.
    *   **10/31/2025, 1:36:18 PM**: The previous change at 1:28:39 PM was reverted; the report name condition was restored to `"Containers Shipped (Mbl Wise)"`. This suggests the prior modification was either a temporary test or an accidental change. The incomplete `else if` section remains consistent across all timestamps for this file.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/31/2025, 12:33:31 PM**: This file defines analytics report configurations, including `DEFAULT_ANALYTICS_ENDPOINTS`, `EXCEL_EXPORT_COLUMNS` (a comprehensive list of columns for spreadsheet exports), `CargoReadyToETD10Days` columns, and `ANALYTICS_REPORT_HEADER` which maps report names to their display headers.
    *   **10/31/2025, 1:36:25 PM**: No functional changes were recorded for this timestamp; the content is identical to the previous entry.
    *   **10/31/2025, 2:45:55 PM**: A minor textual change occurred in `EXCEL_EXPORT_COLUMNS`, where the `name` for the `completed_date` key was updated from `"Completed Date"` to `"Completed Date123"`.
    *   **10/31/2025, 2:46:58 PM**: The minor change to `completed_date`'s name in `EXCEL_EXPORT_COLUMNS` was immediately reverted, changing it back to `"Completed Date"`.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\report_options.js`**
    *   **10/31/2025, 2:47:32 PM**: This entry shows the introduction or significant update of configuration options related to report scheduling and filtering. It includes:
        *   `scheduleOptions`: Defines report scheduling frequencies (Specific Date and Time, Daily, Weekly, Monthly).
        *   `filterByColumnOption`: A comprehensive list of date-based columns available for report filtering.
        *   `timeOptions`: Detailed hour, minute, and AM/PM selections.
        *   `timeOptionsDaily`, `weekOptions`, and `monthOptions`: Predefined options for daily time ranges, days of the week, and days of the month respectively, to support scheduling.

**Patterns and Recurring Elements:**

*   **Concentrated Development:** All changes occurred on the same day (10/31/2025), primarily between 10 AM and 3 PM, indicating focused development or debugging sessions.
*   **Excel Export Logic Refinement:** The `methods.js` file shows repeated adjustments and streamlining of the Excel export logic, especially for `StackedBar` charts, and includes several debugging console logs. There was a brief inconsistency in report naming in `methods.js` that was quickly corrected.
*   **Configuration Management:** The `analytics.js` file serves as a central configuration point for report definitions and export schemas, with a minor, quickly reverted change to a column name.
*   **New Report Scheduling/Filtering Features:** The introduction of `report_options.js` with extensive options for scheduling and filtering points to the development of new, more flexible report generation capabilities.
*   **Incomplete Code Snippets:** A consistent pattern in `methods.js` is the presence of a trailing, incomplete `else if` statement, suggesting that log snapshots were taken during active coding where new report types were being incrementally added or modified.

## 5:14:21 PM
On October 31, 2025, a series of changes were made to the analytics functionality of the `t360-frontend` application, primarily focusing on report generation, data handling, and configuration.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/31/2025, 10:23:35 AM**: The `downloadReportSpreadsheet` function, responsible for generating Excel reports, was significantly updated. It includes logic to format data for various report types and period filters (month, week, quarter), specifically for `StackedBar` charts such as "Cargo-Ready Date to ETD", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)". The initial entry showed some logic for "Average Transit Time per Month (Days)" as commented out, and an `else if` block was truncated.
    *   **10/31/2025, 10:26:57 AM**: The truncated code block from the previous entry was completed. Data mapping for "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", and "Average Transit Time per Month (Days)" reports was refined to directly utilize "This Quarter" and "Last Quarter" fields based on the selected period filter, removing an intermediate data processing step. A new incomplete `else if` block was introduced at the end of the file.
    *   **10/31/2025, 12:30:38 PM & 10/31/2025, 12:31:21 PM**: Minor debugging `console.log` statements were added within the `downloadReportSpreadsheet` function to inspect `headerCopy` and `item` variables. The trailing incomplete `else if` block persisted.
    *   **10/31/2025, 1:28:39 PM**: A brief change occurred where the report name "Containers Shipped (Mbl Wise)" was modified to "Containers Shipped" within the `downloadReportSpreadsheet` function's conditional logic.
    *   **10/31/2025, 1:36:18 PM**: The change from 1:28:39 PM was reverted, and the report name was restored to "Containers Shipped (Mbl Wise)", indicating a potential re-evaluation or test of report naming conventions. The trailing incomplete `else if` block remained.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/31/2025, 12:33:31 PM**: This file was updated to define various constants essential for analytics reports. This includes `DEFAULT_ANALYTICS_ENDPOINTS` specifying API URLs for CBM and TEU reports, `EXCEL_EXPORT_COLUMNS` detailing all possible columns for Excel exports, `CargoReadyToETD10Days` for a specific report's columns, and `ANALYTICS_REPORT_HEADER` mapping report names to their display headers.
    *   **10/31/2025, 1:36:25 PM**: No functional changes were observed compared to the previous timestamp; this appears to be a re-save or automatic update.
    *   **10/31/2025, 2:45:55 PM**: A minor textual change was made, altering the display name for the "completed_date" column in `EXCEL_EXPORT_COLUMNS` from "Completed Date" to "Completed Date123".
    *   **10/31/2025, 2:46:58 PM**: The previous textual change was reverted, restoring the "completed_date" label back to "Completed Date" in `EXCEL_EXPORT_COLUMNS`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\report_options.js`**
    *   **10/31/2025, 2:47:32 PM**: This file was added or significantly updated to centralize various options used in report configuration. It now includes `scheduleOptions` (e.g., Daily, Weekly), `filterByColumnOption` (a comprehensive list of date fields for report filtering), and detailed `timeOptions` (for hours, minutes, AM/PM), `timeOptionsDaily` (hourly slots), `weekOptions` (days of the week), and `monthOptions` (days of the month).

**Patterns and Recurring Elements:**

*   All recorded changes occurred on the same day, **October 31, 2025**, indicating a concentrated development effort on the analytics module.
*   A significant amount of work was dedicated to refining the **Excel export functionality** within `methods.js`, specifically adapting to various report types and time-based aggregations.
*   There's a clear pattern of **iterative refinement and debugging** within `methods.js`, evidenced by the specific data mapping adjustments, temporary naming changes, and added `console.log` statements.
*   The frequent truncation of code in `methods.js` entries suggests that the file was saved multiple times in quick succession during active coding.
*   The changes in `analytics.js` are primarily **configuration-oriented**, defining the structure and labels for different reports and their exports. The minor label changes indicate small-scale adjustments or testing of these configurations.
*   The introduction of `report_options.js` points to an effort to **standardize and centralize UI options** related to report scheduling and filtering, improving consistency and maintainability.
*   The overarching theme is the **enhancement and robustification of analytics reporting and data visualization** capabilities, particularly in how data is prepared for export and how users can configure reports.

## 6:14:01 PM
The provided logs show a series of iterative changes focused on analytics and export functionalities within a backend application, specifically related to fetching and processing booking and non-booking data for various reports.

### File-Specific Updates:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts`**

*   **Timestamp Range:** 10/31/2025, 1:22:31 PM - 10/31/2025, 4:17:38 PM
*   **Key Changes:**
    *   **Initial State (1:22 PM):** The `getExportData` function constructs a `mainQuery` for booking data by wrapping `customQuery` within a `SELECT * FROM ( ... ) AS data ORDER BY departure_date ASC` structure. It includes a `replaceColumnHandler` to convert 'LONG BEACH' to 'LOS ANGELES' for `pod` and `place_of_delivery` fields.
    *   **Query Ordering (1:24 PM):** The `ORDER BY` clause for booking queries was changed from `ORDER BY departure_date ASC` to `ORDER BY ${filterBy} ASC`. This change was then reverted shortly after.
    *   **Conditional Query Wrapping (1:39 PM - 1:45 PM):** Introduced a conditional logic to determine how `customQuery` is used.
        *   If `customQuery` starts with "WITH" (indicating a CTE-based query), it was initially wrapped with `SELECT * FROM (SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery} ...)` but then changed to directly use `mainQuery = customQuery;`. This indicates that CTE-based queries from `bookingQuery` are expected to be complete SQL statements and should not be wrapped further.
        *   For non-CTE queries, the original wrapping logic (`SELECT * FROM ( SELECT ${mblWiseQuery} ${COLUMNS} ${customQuery} ... )`) is retained.
    *   **Post-Query Data Handling (1:45 PM):** A new conditional block was added to process `excelExportData.rows`. If `customQuery` starts with "WITH", the raw `excelExportData.rows` are used directly as `exportRows` (implying they are already aggregated). Otherwise, `dateFilterOnExport` and `replaceColumnHandler` are applied.
    *   **Reversion (1:48 PM):** The conditional wrapping logic and the new post-query data handling for CTEs introduced at 1:39 PM and 1:45 PM were reverted, returning to the simpler original structure where all `customQuery` results are uniformly wrapped and then processed through `dateFilterOnExport` and `replaceColumnHandler`.
    *   **Filter `mblWiseQuery` Logic (2:58 PM):** The condition for `mblWiseQuery` was temporarily changed from `mblwise === 'true'` to `mblwise === ''`, and then reverted to `mblwise === 'true'` (2:59 PM).
    *   **Debugging Console Logs:** Several `console.log` statements were added and modified throughout these changes to inspect query parameters, custom query content, and filtered data at different stages.
    *   **Table Alias in WHERE clause:** At `2:53:46 PM`, the `filterBy` parameter in the main query for booking data was explicitly prefixed with the table alias `m.` (e.g., `m.${filterBy}`). This was reverted in the next timestamp.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**

*   **Timestamp Range:** 10/31/2025, 1:26:45 PM - 10/31/2025, 6:13:31 PM
*   **Key Changes:**
    *   **"Containers Shipped (Mbl Wise)" Report (Multiple updates from 1:35 PM to 3:28 PM):**
        *   Initially, this report's query was a CTE-based aggregated query (`WITH date_series AS ( ... ), shipment_data AS ( ... ) SELECT ...`).
        *   **Intermediate Change (1:55 PM):** The query was modified to directly select a long list of columns from `mtr_tracking_data` and `agent_booking_entry` with a `DISTINCT ON (LOWER(m.mblno))` clause, and included calculation for `final_delivery_date`. It also included conditional filtering based on `stackedExport` and `displayBy`, and a `CASE` statement for `stackedGroup` quarter categorization. This essentially made it a detailed data selection query rather than a summarized one.
        *   **Reversion/Refinement (2:22 PM):** The query for "Containers Shipped (Mbl Wise)" was reverted to a CTE-based, aggregated format similar to its initial state, focusing on summing counts for "This Quarter" and "Last Quarter" based on `final_delivery_date`.
        *   **Wrapping the CTE Query (3:28 PM):** The entire CTE-based query for "Containers Shipped (Mbl Wise)" was wrapped within `SELECT * FROM ( ... ) AS data ORDER BY "Month" ASC`. This implies that this specific report's `bookingQuery` function now returns a complete, ordered SQL statement, contrasting with other reports that return partial `WHERE` clauses.
    *   **"Containers Shipped (Mbl Wise)" Query Logic Refinements (from 3:39 PM onwards):**
        *   The calculation for `day_diff` was changed to `EXTRACT(DAY FROM m.delivery_customer_date - m.updated_inland_arv_date)`.
        *   Conditional filtering (`stackedExport === "true"`) logic was refined, specifically for `displayBy` and `stackedGroup`, using dates like `m.delivery_customer_date` and `m.departure_date`.
        *   The `GROUP BY` clause was significantly expanded to include a large number of `m.` and `a.` columns (`3:50 PM`), suggesting a shift back to returning more detailed data rather than just aggregated counts.
        *   The `GROUP BY` and `ORDER BY` clauses for "Containers Shipped (Mbl Wise)" were frequently adjusted, sometimes removing explicit `GROUP BY` clauses within the `bookingQuery` function itself, or modifying the date column used for extraction and filtering.
        *   At `3:58 PM`, the "Containers Shipped (Mbl Wise)" query had its `GROUP BY` clause reduced to focus on just `m.mblno, m.delivery_customer_date, m.updated_inland_arv_date`.
        *   The `stackedExport` conditional logic for this report was also consistently adjusted, primarily focusing on `delivery_customer_date` or `departure_date` for month/week/quarter filtering, and reintroducing the `CASE WHEN DATE_PART('day', ...)` for `stackedGroup`.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`**

*   **Timestamp Range:** 10/31/2025, 1:28:00 PM - 10/31/2025, 6:03:17 PM
*   **Key Changes:**
    *   No significant functional changes in this file across the provided logs. It appears to remain consistent, defining SQL queries for various booking-related reports (Booking Date to Actual Departure, Stacked Bar variations) using CTEs and date calculations. The `getColumnsByCategory` and `getFilterQueryByDisplayValue` utilities are consistently imported and used.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`**

*   **Timestamp Range:** 10/31/2025, 2:47:46 PM - 10/31/2025, 5:12:55 PM
*   **Key Changes:**
    *   No functional changes in the `defaultDateRange`, `replaceValueInQuery`, `getUserObject`, `getFilterQueryByDisplayValue`, `getExcelSelectedColumns`, `isValidDate`, `dateFilterOnExport`, or `EXCEL_EXPORT_COLUMNS` functions across the provided log entries. The code remains consistent.
    *   There are commented-out lines in `replaceValueInQuery` that show an earlier or alternative implementation that was not used in the final version.

### Patterns and Recurring Elements:

*   **Date Handling:** Consistent use of `::timestamp` and `INTERVAL '1 day'` for date range filtering in SQL queries, indicating a focus on inclusive date ranges. The `defaultDateRange` function consistently calculates a one-year range ending on the current date. `isValidDate` and `dateFilterOnExport` are used to standardize and format date values in the results.
*   **Dynamic SQL Generation:** The system heavily relies on dynamic SQL generation, where parts of queries (columns, `WHERE` clauses, grouping, ordering) are constructed based on request parameters (`reportName`, `CompanyName`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, `displayBy`, `columns`, `filterBy`).
*   **Conditional Logic for Reports:** The `bookingQuery` and `nonBookingQuery` functions use extensive conditional logic (`if(isBooking)`, `if (reportName === "...")`, `if (stackedExport === "true")`) to tailor SQL queries based on the requested report type and display options.
*   **MBL-wise and Stacked Bar Reports:** There's a strong emphasis on `MBL Wise` (Master Bill of Lading-wise) and `Stacked Bar` reports, involving `DISTINCT ON (LOWER(m.mblno))` or other composite keys for distinctness, and specific `CASE` statements to categorize data for stacking (e.g., 'Less than 1 week', '1 - 2 weeks').
*   **Column Replacement/Standardization:** The `replaceColumnHandler` function consistently replaces 'LONG BEACH' with 'LOS ANGELES' for `pod` and `place_of_delivery` columns, indicating a data standardization requirement.
*   **Debugging Output:** Frequent `console.log` and `logger.info` statements are present, suggesting an iterative development or debugging process to monitor generated queries and data flow.
*   **PostgreSQL Features:** The SQL queries leverage PostgreSQL-specific features like `EXTRACT`, `DATE_PART`, `DATE_TRUNC`, `generate_series`, `COALESCE`, and `DISTINCT ON`.
*   **Error Handling:** All main export functions include a `try...catch` block to handle errors, logging them and returning a 500 status code.

### Timestamps of Significant Changes:

*   **10/31/2025, 1:24:41 PM:** Temporary change to `ORDER BY ${filterBy} ASC` in `core.export.controller.ts` for booking queries.
*   **10/31/2025, 1:35:58 PM:** Introduction of a complex CTE-based aggregated query for "Containers Shipped (Mbl Wise)" in `export.query.ts`.
*   **10/31/2025, 1:39:02 PM & 1:39:24 PM:** Attempted to add conditional logic in `core.export.controller.ts` to handle CTE-based `customQuery` differently (direct assignment vs. wrapping). This was reverted.
*   **10/31/2025, 1:45:46 PM:** Added logic in `core.export.controller.ts` for conditional post-query data processing based on whether `customQuery` is CTE-based. This was reverted.
*   **10/31/2025, 1:48:05 PM:** Reversion of conditional logic for CTE-based queries in `core.export.controller.ts`, returning to previous uniform wrapping.
*   **10/31/2025, 1:55:32 PM:** The "Containers Shipped (Mbl Wise)" query in `export.query.ts` was significantly altered from an aggregated CTE to a detailed column selection with conditional filtering.
*   **10/31/2025, 2:22:48 PM:** The "Containers Shipped (Mbl Wise)" query in `export.query.ts` was reverted back to a CTE-based aggregated format, and the date conditions in the CTE for 'This Quarter'/'Last Quarter' were defined.
*   **10/31/2025, 3:28:29 PM:** The "Containers Shipped (Mbl Wise)" CTE query in `export.query.ts` was wrapped entirely in `SELECT * FROM ( ... ) AS data ORDER BY "Month" ASC`, making it a self-contained executable query.
*   **10/31/2025, 3:28:48 PM:** An attempt was made in `core.export.controller.ts` to wrap the `customQuery` differently (using a subquery `FROM ( ${customQuery} ) AS subquery`), particularly when the custom query is itself a complete SQL statement, but this was also quickly reverted/refined.
*   **10/31/2025, 3:39:12 PM to 5:52:57 PM:** Frequent modifications and refinements to the "Containers Shipped (Mbl Wise)" query in `export.query.ts`, including changes to `day_diff` calculation, conditional filters, and `GROUP BY` clauses, indicating active development and testing of this specific report.

## 6:14:15 PM
The code changes primarily focus on refining and debugging the analytics reporting and Excel export functionalities within a frontend application. All modifications occurred on October 31, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/31/2025, 10:23:35 AM**: This timestamp represents the initial state, containing core logic for analytics data processing (`metricsPackageHandler`), chart options, report formula calculation, and extensive Excel spreadsheet generation (`downloadReportSpreadsheet`). The spreadsheet function specifically handles various `StackedBar` reports (e.g., "Cargo-Ready Date to ETD", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)") by mapping data based on `periodFilter` (month, week, quarter).
    *   **10/31/2025, 10:26:57 AM**: The `downloadReportSpreadsheet` function was updated. For `StackedBar` reports like "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", and "Average Transit Time per Month (Days)", the logic for preparing data for Excel export was streamlined. An intermediate `updatedData` processing step was removed, and data mapping was directly implemented based on the `periodFilter` (month, week, quarter) for consistency with other `StackedBar` reports.
    *   **10/31/2025, 12:30:38 PM & 12:31:21 PM**: Two `console.log` statements (`"====hhjjjk"`, `"jjjj"`) were added within the `downloadReportSpreadsheet` function, suggesting active debugging efforts.
    *   **10/31/2025, 1:28:39 PM**: A change in the `downloadReportSpreadsheet` function altered the report name condition from `"Containers Shipped (Mbl Wise)"` to `"Containers Shipped"`.
    *   **10/31/2025, 1:36:18 PM**: The previous change was reverted, and the report name condition was restored to `"Containers Shipped (Mbl Wise)"`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/31/2025, 12:33:31 PM**: This entry defines various constants used across the analytics module, including default API endpoints, columns for Excel export (`EXCEL_EXPORT_COLUMNS`), specific columns for "Cargo Ready To ETD 10 Days" reports, and a comprehensive mapping of analytics report headers (`ANALYTICS_REPORT_HEADER`) for different metrics (CBM, TEU, KGS, Transit) and grouping types (Container Wise, MBL Wise). Notably, Transit Time headers use a repetitive pattern (e.g., `["POL-POD", "Days", "","POL-POD", "Days", "","POL-POD", "Days" ]`).
    *   **10/31/2025, 1:36:25 PM**: No functional changes were observed in the provided content snippet compared to the previous timestamp; the content appears identical.
    *   **10/31/2025, 2:45:55 PM**: A minor, likely temporary, change was made in `EXCEL_EXPORT_COLUMNS`, where the `name` for the `completed_date` key was modified from `"Completed Date"` to `"Completed Date123"`.
    *   **10/31/2025, 2:46:58 PM**: The change to `completed_date` in `EXCEL_EXPORT_COLUMNS` was reverted, restoring its `name` to `"Completed Date"`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\report_options.js`**
    *   **10/31/2025, 2:47:32 PM**: This file, introduced at this timestamp, defines options for scheduling reports (Daily, Weekly, Monthly), a comprehensive list of filterable date columns (`filterByColumnOption` including many "Live" date fields prefixed `t49_`), and granular time/date selection options (hours, minutes, AM/PM, days of week, days of month).

**Patterns and Recurring Elements:**

*   **Analytics Focus**: All changes revolve around the analytics feature, specifically data presentation, processing, and export to Excel.
*   **Excel Export Refinement**: A significant portion of the changes in `methods.js` involves continuous refinement of the `downloadReportSpreadsheet` function, particularly for handling `StackedBar` charts and `periodFilter` options, indicating ongoing development of robust export capabilities.
*   **Debugging Activity**: The presence and subsequent removal of `console.log` statements in `methods.js`, along with the temporary "Completed Date123" change in `analytics.js`, point to active debugging and testing during this period.
*   **Date and Time Granularity**: The introduction of `report_options.js` highlights a need for detailed date and time filtering and scheduling capabilities, with numerous date-related fields (including "Live" data) being made available for user interaction.
*   **Consistency in StackedBar Logic**: A recurring pattern in `methods.js` is the application of similar data transformation logic for multiple `StackedBar` reports based on `periodFilter` (month, week, quarter) for consistent Excel export.
*   **Report Header Structure**: The `ANALYTICS_REPORT_HEADER` in `analytics.js` shows a well-defined structure for various report types, often including multiple columns for comparative metrics (e.g., "Actual", "Estimated", "Estimated vs. Actual" for transit times).