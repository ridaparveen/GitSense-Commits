# Activity Summary for 10/29/2025

## 10:25:04 AM
The core of these changes centers on enhancing the analytics and planboard features of a frontend application, specifically concerning custom view management, data display, and export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **(10/28/2025, 2:02:33 PM):** This file introduces a robust component for creating, editing, and deleting custom analytics dashboards. It includes state management for selected metrics (`checkBoxManager`, `numChecked`), a view name, and alert configurations. It integrates with Redux (`useSelector`, `useDispatch`) for global state management and interacts with an `analyticsApi` for fetching dashboard options and saving/deleting views. The component supports "Container Wise" and "MBL Wise" metric selection via tabs and a `TreeViewContianer`. Key actions like saving (POST/PUT based on `action`) and deleting views are implemented with toast notifications and Redux dispatches to update the UI. An `AuditViewDrawer` is also integrated for audit functionality.
    *   **(10/28/2025, 3:48:07 PM & 10/28/2025, 5:53:50 PM):** Minor debugging statements (`console.log`) were added to inspect `viewOptions` and `viewName`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **(10/28/2025, 2:04:34 PM):** This component is responsible for rendering a hierarchical tree view of analytics metrics, grouped by category. It uses `@mui/x-tree-view` components. Checkboxes are integrated into each metric item, and their checked state is controlled by the `checkBoxManager` prop, with `handleCheckBoxClicked` managing selection logic.
    *   **(10/28/2025, 3:46:33 PM & 10/28/2025, 3:46:51 PM):** A temporary "kk" string was added and subsequently removed from the metric label, indicating a brief debugging or testing phase for the display of metric names.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **(10/28/2025, 3:35:37 PM):** This file defines extensive configuration constants for analytics, including:
        *   `DEFAULT_ANALYTICS_ENDPOINTS`: A list of default report names and their corresponding API URLs, categorized by grouping columns (e.g., `scac_code`, `pol`, `pod`, `shipper`) and metrics (CBM, TEU).
        *   `EXCEL_EXPORT_COLUMNS`: A comprehensive list of column definitions (key and display name) for Excel exports, covering various shipping and tracking details.
        *   `CargoReadyToETD10Days`: A specific subset of columns.
        *   `ANALYTICS_REPORT_HEADER`: A large object mapping report names to arrays of strings representing their expected table headers, covering CBM, TEU, KGS, Transit Time, and Chassis-related metrics, both "Container Wise" and "MBL Wise."
    *   **(10/28/2025, 3:37:47 PM):** A previous incomplete header entry for "Containers Shipped" was removed, and an incomplete "Container by Ocean Freight Carrier (SCAC)" entry was completed, along with adding "Container by Port of Loading". This indicates a refinement and completion of the report header configurations.
    *   **(10/28/2025, 3:38:11 PM & 10/28/2025, 5:49:01 PM):** These timestamps show no discernible content changes, suggesting potential save operations or automated formatting updates without functional modifications.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **(10/28/2025, 4:05:26 PM):** This component manages the display of planboard data, supporting both "year" and "month" views. It fetches data using `useFetchPlanboardQuery` and processes it with `filterHandler` and `prepare...FilterObject` utility functions. It conditionally renders `YearViewItem` (grid layout) or `MonthViewItem` (horizontal stack of scrollable monthly cards) and includes a `NoDataAvailable` component. The `NoDataAvailable` text was temporarily `No Data Available123`.
    *   **(10/28/2025, 4:08:24 PM):** A debugging `console.log` statement was added to display `planboardData`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **(10/29/2025, 9:56:31 AM):** This component provides interactive footer elements for analytics metrics, enabling data export and view enlargement. It offers Excel export with a `ColumnsSelector` for user-defined columns, and PDF export using `jspdf` and `html2canvas` to render the chart component into a PDF. Loading states are managed for both export types. It also displays calculated metric values (`calShow`, `calType`, `calValue`) and tooltips for report formulas.
    *   **(10/29/2025, 9:57:53 AM):** A debugging `console.log` statement was added to inspect the `item` prop.

**Timestamps of Significant Changes:**

*   **10/28/2025, 2:02:33 PM:** Introduction of the comprehensive `ViewContainer.jsx` for analytics custom view management.
*   **10/28/2025, 2:04:34 PM:** Initial implementation of `TreeViewContianer.jsx` for displaying metrics.
*   **10/28/2025, 3:35:37 PM:** Detailed configuration of analytics reports and export columns in `analytics.js`.
*   **10/28/2025, 3:37:47 PM:** Refinement of analytics report headers in `analytics.js`, including completion of previously truncated entries.
*   **10/28/2025, 4:05:26 PM:** Implementation of `PlanboardCardView.jsx` for displaying planboard data in different views.
*   **10/29/2025, 9:56:31 AM:** Integration of advanced export functionalities (Excel with column selection, PDF generation) into `MetricFooter.jsx`.

**Patterns and Recurring Elements:**

*   **Debugging Statements:** There's a recurring pattern of adding `console.log` statements in various components (`ViewContainer`, `TreeViewContianer`, `PlanboardCardView`, `MetricFooter`) at different timestamps. This indicates active development, testing, and troubleshooting across these UI features.
*   **Redux/RTK Query Integration:** The application consistently uses Redux (`useSelector`, `useDispatch`) and RTK Query (`useFetch...Query`, `useSave...Mutation`) for state management and API interactions across multiple components (`ViewContainer`, `PlanboardCardView`, `MetricFooter`), highlighting a centralized data flow architecture.
*   **Material-UI (MUI) & Custom Components:** The changes extensively utilize Material-UI components (e.g., `Box`, `Stack`, `Grid`, `Button`, `Checkbox`, `CircularProgress`, `Tooltip`, `Chip`, `TreeItem`, `SimpleTreeView`) along with custom common components (`InputBox`, `ThemeButton`, `OutlinedButton`, `ThemeTabs`, `Loader`, `PopupAlert`, `AuditViewDrawer`, `TMenu`, `ThemedModal`, `ColumnsSelector`). This indicates a consistent design system and component-based development approach.
*   **Analytics Feature Development:** A strong focus is observed on the analytics section, encompassing custom dashboard creation, metric selection, configuration of various reports (CBM, TEU, KGS, Transit, Chassis), and comprehensive data export options.
*   **Rapid Iteration/Commits:** The timestamps for `analytics.js` show very close successive entries (3:35:37 PM, 3:37:47 PM, 3:38:11 PM, 5:49:01 PM), with some content appearing identical between logs. This could imply frequent saves, automated formatting, or quick, iterative adjustments.

## 10:25:15 AM
This log primarily details updates within the `t360-backend`'s analytics module, focusing on dashboard management and report query generation. Significant changes occurred across three main files: `core.view.controller.ts`, `core.metric.controller.ts`, and the query builders `export.query.ts` and `mbls.query.ts`, as well as the central `others.controller.ts`.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file, responsible for managing user-defined analytics dashboards, saw comprehensive updates. It now includes `getAll`, `create`, `update`, and `deleteView` functions, allowing users to manage their dashboard views.
    *   A key addition is the `logAudit` function, which records all dashboard modifications (creation, update, deletion) in an `analytics_view_log` table, capturing user details, action, menu title, and previous/new values.
    *   Dashboard metrics are stored as `ARRAY` in the `dashboards` table.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM)**
    *   This file contains the `bookingQuery` function, which generates dynamic SQL for various booking-related reports (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival").
    *   It supports filtering by month, week, or quarter and categorizing time differences into predefined ranges (e.g., "Less than 1 week", "1 - 2 weeks").
    *   A `getMonthValue` helper function is used to map month names to numerical values.
    *   Notably, the code content remained identical across multiple timestamps, suggesting frequent saves without functional changes or incomplete logs. The SQL query strings consistently appear truncated at the end in the provided log entries.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM)**
    *   This controller manages metrics and their display on dashboards.
    *   `getMetricList` was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and support preloading selected metrics for an existing dashboard.
    *   `dashboardEndPointList` retrieves metrics, their order, and crucially, new `rowSpan` and `columnSpan` properties, indicating added support for customizing metric display sizes.
    *   New functions `saveSequence` and `saveSize` were introduced:
        *   `saveSequence` allows users to reorder metrics on their dashboards.
        *   `saveSize` enables saving custom display dimensions (column and row span) for individual metrics, persisting this layout information in the `dashboards` table's `size` JSONB column.
    *   A minor `console.log` was added for debugging (`10/28/2025, 3:50:57 PM`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps: 10/28/2025, 4:22:21 PM; 10/28/2025, 5:05:54 PM; 10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM; 10/28/2025, 5:12:32 PM; 10/28/2025, 5:12:38 PM; 10/28/2025, 5:15:25 PM; 10/28/2025, 6:07:21 PM; 10/29/2025, 10:22:22 AM)**
    *   This file saw extensive and iterative development for the `mblQueryBuilder`.
    *   Initially (10/28/2025, 4:22:21 PM), it handled 'ContainerShippedMblWise' and 'TotalShipmentsMblWise' by calculating shipment/container counts.
    *   A major refactor (10/28/2025, 5:05:54 PM) changed 'ContainerShippedMblWise' to calculate container counts based on "completed shipments" (identified by delivery dates), grouped by dynamically determined 'Current Quarter' and 'Last Quarter' using complex date logic. The 'TotalShipmentsMblWise' report type was renamed to 'TotalShipments'.
    *   Subsequent changes (10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM) streamlined the builder, removing the `TotalShipments` report type from its scope.
    *   Refinements continued with the `codeCustomization`, `fromDate`, and `toDate` parameters being adjusted or removed from the `mblQueryBuilder` signature, indicating these parameters are now handled differently or are dynamically generated internally (10/28/2025, 5:12:32 PM; 10/28/2025, 5:15:25 PM; 10/29/2025, 10:22:22 AM).
    *   The dynamic quarter calculation for 'ContainerShippedMblWise' was further refined (10/28/2025, 5:15:25 PM), shifting to a "Last Quarter" and "This Quarter" window based on the current month, and the SQL query was updated to return monthly data within these quarters. The `maxTotal` calculation for percentages was removed as the data output structure changed.
    *   Further changes (10/29/2025, 10:22:22 AM) solidified the quarter logic to target a 3-month window for "This Quarter" (current month-1 to current month+1) and the preceding 3 months for "Last Quarter", and the query now groups by month within quarters.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps: 10/28/2025, 5:09:46 PM; 10/28/2025, 5:12:24 PM; 10/28/2025, 5:14:52 PM; 10/29/2025, 10:23:17 AM)**
    *   This central dispatcher for analytics reports was updated to incorporate the new `mblQueryBuilder`.
    *   A new `else if` block was added to call `mblQueryBuilder` specifically for the `ContainerShippedMblWise` report type, setting `codeCustomization = true`.
    *   Adjustments were made regarding the `codeCustomization` flag in relation to `mblQueryBuilder` calls, indicating a fine-tuning of which reports handle query generation internally vs. relying on a generic execution.
    *   The `fromDate` and `toDate` parameters were commented out in the call to `mblQueryBuilder` (`10/29/2025, 10:23:17 AM`), reflecting the internal date calculation logic now handled by `mbls.query.ts`.

### Timestamps of Significant Changes:

*   **10/28/2025, 1:58:56 PM:** Introduction of full CRUD operations and comprehensive audit logging for analytics dashboards.
*   **10/28/2025, 3:49:50 PM:** Major additions to dashboard metric management, including sorting and the ability to save custom metric display sizes (row/column span).
*   **10/28/2025, 5:05:54 PM:** Significant refactoring of `mblQueryBuilder`, introducing complex dynamic quarter-based calculations for `ContainerShippedMblWise`.
*   **10/28/2025, 5:15:25 PM & 10/29/2025, 10:22:22 AM:** Further iterative development and refinement of the `mblQueryBuilder` for 'ContainerShippedMblWise', specifically enhancing dynamic quarter calculations, adding monthly grouping, and adjusting parameter handling.
*   **10/29/2025, 10:23:17 AM:** Final adjustment in `others.controller.ts` to align `mblQueryBuilder` call with its updated parameter requirements.

### Patterns and Recurring Elements:

*   **Analytics Module Development:** All changes are concentrated within the `analytics` directory, indicating active and ongoing development of reporting and dashboard features.
*   **Dashboard Customization:** There's a clear emphasis on allowing users to customize their dashboards, from selecting metrics and their order to defining their visual layout (size).
*   **Dynamic SQL Query Generation:** The system heavily relies on specialized query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `mblQueryBuilder`) to construct complex SQL queries based on report type and user-specific parameters. This pattern suggests a highly flexible and extensible reporting infrastructure.
*   **Date-Based Reporting:** A recurring need for date and time-based filtering and grouping (by month, week, quarter) is evident across various reports, with specific logic for dynamic date range calculation.
*   **User/Company Context:** Queries consistently use `user_id` and `CompanyName` to filter data, reinforcing a multi-tenant or personalized analytics experience.
*   **Debugging/Logging:** The presence of `logger.info`, `logger.error`, and `console.log` statements suggests active development with a focus on observability and troubleshooting.
*   **Iterative Refinement:** Multiple timestamps for the same file, especially `mbls.query.ts` and `export.query.ts`, indicate an iterative development process, with frequent saves and incremental changes to logic and SQL queries.
*   **SQL String Interpolation:** SQL queries are often built using template literals, which requires careful input sanitization in a production environment to prevent SQL injection vulnerabilities.

## 11:25:07 AM
Changes across these files primarily focus on enhancing and refining the analytics dashboard and reporting functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM):** This file, managing analytics dashboards, introduced a comprehensive `logAudit` function to track user actions (CREATE, UPDATE, DELETE) on dashboards, recording user ID, action, menu title, and both previous and new metric values. The `update` function was modified to capture `previousValue` for auditing, and dashboard creation now includes a check to prevent duplicate views.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM):** This controller saw significant development. The `getMetricList` function was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and added a "preload" feature to mark selected metrics for existing dashboards. New functions `dashboardEndPointList` were introduced to fetch ordered dashboard metrics with their display properties (report name, URL, row/column span), and `saveSequence` and `saveSize` functions were added to allow users to customize the order and layout (size) of metrics on their dashboards, including special handling for "Default" dashboards. A minor debug `console.log` was added in a subsequent commit.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM):** This file defines SQL query templates for various booking-related reports. A notable change was the addition of a "Booking Date to POD Arrival (Stacked Bar)" query, which includes a filter for `t49_vessel_actualdeparted_date`. Multiple log entries for this file show virtually identical code content, suggesting minor non-functional updates or repeated saves without substantive changes in the provided snippets. The `bookingQuery` function dynamically constructs queries based on report name, company, and display settings (month, week, quarter).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps ranging from 10/28/2025, 4:22:21 PM to 10/29/2025, 10:44:49 AM):** This file, responsible for MBL-related queries, underwent several iterations. Initially, it included basic `ContainerShippedMblWise` and `TotalShipmentsMblWise` types calculating counts. Later, the `ContainerShippedMblWise` report was significantly refactored (around 10/28, 5:05:54 PM) to query for *completed shipments* and dynamically group container counts by "Current Quarter" and "Last Quarter" based on real-time dates. The `customizer.selectedColumns` `must` list was expanded to include many tracking data fields. Further refinements (around 10/29, 10:22:22 AM to 10/29, 10:44:49 AM) changed the quarter calculation logic to cover an "8-month window" (last 4 months + this 4 months) and group results by `quarter` and `month`, with `customizer.calType` also being temporarily set to "avg" before being removed again. The `fromDate` and `toDate` parameters were removed from the `mblQueryBuilder` signature, as the quarter calculation became internal.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps ranging from 10/28/2025, 5:09:46 PM to 10/29/2025, 11:23:55 AM):** This controller acts as the central dispatcher for analytics reports. It was updated to integrate the `mblQueryBuilder` for the `ContainerShippedMblWise` report type, marking it for `codeCustomization`. Throughout its changes, there were adjustments and re-additions of the `codeCustomization` flag when calling `mblQueryBuilder`, and parameter `fromDate`/`toDate` were removed from the `mblQueryBuilder` call, aligning with `mbls.query.ts`'s internal date handling. An attempt to set `customizer.chartType = "StackedBar";` for `ContainerShippedMblWise` in this file was later reverted, indicating the logic for `customizer` properties belongs within the individual query builders.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** All modifications are concentrated within the `analytics` domain, indicating active development of dashboard and reporting features.
*   **Database Interaction:** A `query` function (likely a database utility) is extensively used for data retrieval and manipulation across multiple files.
*   **User Contextualization:** Report generation and dashboard management consistently utilize `req.user` to fetch user-specific details (`usercode`, `companyname`) for personalized data access and filtering.
*   **Dynamic Query Generation:** SQL queries are frequently constructed dynamically using string interpolation and conditional logic based on various input parameters (e.g., report type, display options, date ranges).
*   **Date Filtering and Grouping:** There's a strong emphasis on date-based operations, including filtering by `fromDate` and `toDate`, extracting day differences (`EXTRACT(DAY FROM ...) `), and grouping by time periods (`DATE_TRUNC`, `TO_CHAR` for months/quarters). A recurring pattern in SQL WHERE clauses is to filter out invalid date values like `'0001-01-01 00:00:00 BC'`.
*   **Modular Query Builders:** The architecture leverages separate query builder files (`chassis.query`, `booking.query`, `container.query`, `departure.query`, `general.query`, `mbls.query`) to encapsulate the logic for different report types.
*   **`codeCustomization` Flag:** A `codeCustomization` flag is used to differentiate between reports where the controller executes a generated SQL query and those where the query builder itself processes data or returns a pre-processed result.
*   **Error Handling:** `try...catch` blocks are consistently used to wrap asynchronous operations, providing standard error responses.

## 11:25:18 AM
The changes logged primarily focus on frontend development within an analytics and planboard section of a React application, `t360-frontend`. The updates involve enhancing custom view functionality, refining metric visualization and export options, and general debugging.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Initial Update (10/28/2025, 2:02:33 PM):** This file received a significant update, establishing a `ViewContainer` component for creating, editing, and deleting custom analytics dashboards. It integrates with Redux for state management, fetches dashboard options, and saves/deletes user-defined dashboards via mutations. Key features include checkbox management for selecting metrics (limited to 9), input for dashboard naming, handling save/delete operations with toast notifications, and auditing functionality using an `AuditViewDrawer`. The component uses `ThemeTabs` to switch between "Container Wise" and "MBL Wise1" data views. An API key is used for data fetching and saving.
    *   **Debugging Console Logs (10/28/2025, 3:48:07 PM & 10/28/2025, 5:53:50 PM):** Minor changes were made to add `console.log` statements for debugging `viewOptions` and `viewName`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Initial Update (10/28/2025, 2:04:34 PM):** This component renders a tree-like structure (`SimpleTreeView` from `@mui/x-tree-view`) to display selectable analytics metrics. It takes `data`, `handleCheckBoxClicked`, and `checkBoxManager` as props to render grouped metrics with checkboxes.
    *   **Temporary Text Change & Revert (10/28/2025, 3:46:33 PM & 10/28/2025, 3:46:51 PM):** A temporary debugging change added "kk" to a metric name's label, which was immediately reverted.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Initial Extensive Definitions (10/28/2025, 3:35:37 PM):** This configuration file was updated with extensive definitions for analytics reports. It includes `DEFAULT_ANALYTICS_ENDPOINTS` for various CBM and TEU reports, `EXCEL_EXPORT_COLUMNS` for detailed data export, `CargoReadyToETD10Days` for specific reporting, and `ANALYTICS_REPORT_HEADER` which maps report names to their respective display headers for different data types (CBM, TEU, KGS, Transit, Chassis) and views (Container Wise, MBL Wise). The entry for "Container by Ocean Freight Carrier (SCAC)" was initially incomplete.
    *   **Completion of Report Header (10/28/2025, 3:37:47 PM):** The incomplete entry in `ANALYTICS_REPORT_HEADER` was corrected and a new entry "Container by Port of Loading" was added.
    *   **Subsequent Saves (10/28/2025, 3:38:11 PM, 10/28/2025, 5:49:01 PM, 10/29/2025, 11:09:14 AM, 10/29/2025, 11:17:33 AM):** Multiple saves of this file occurred without any further functional code changes, indicating perhaps continuous development in other areas or incidental saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Initial Update (10/28/2025, 4:05:26 PM):** This component handles the display of planboard items in either a yearly or monthly card view. It fetches planboard data, processes it through filter functions (`prepareYearlyFilterObject`, `prepareMonthlyFilterObject`, `filterHandler`), and renders `PlanBoardCardItems`. It includes `NoDataAvailable` component for empty states, which initially had a placeholder text "No Data Available123".
    *   **Debugging Console Log (10/28/2025, 4:08:24 PM):** A `console.log` statement for `planboardData` was added for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Initial Update (10/29/2025, 9:56:31 AM):** This component provides footer actions for analytics metrics, including displaying calculation chips, a tooltip for report formulas, and buttons for Excel and PDF export. The Excel button label was temporarily "Excel1". It handles loading states for exports, column selection for Excel, and full-screen view. PDF generation involves dynamically rendering a `PdfRenderer` component, capturing it with `html2canvas`, and creating a PDF using `jspdf`.
    *   **Debugging Console Log (10/29/2025, 9:57:53 AM):** A `console.log` statement for `item` was added to aid in debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Initial Update (10/29/2025, 10:54:57 AM):** This component serves as a toolbar for analytics metrics, providing options for chart view, period, and date range filtering. It dispatches Redux actions to update filters and triggers `fetchSingleReport` when filters change. The "Period" label was temporarily set to "Period1".
    *   **Label Correction (10/29/2025, 10:55:11 AM):** The "Period1" label was corrected back to "Period".
    *   **Repeated Commenting/Uncommenting & Debugging (10/29/2025, 10:58:17 AM - 10/29/2025, 11:02:26 AM):** A series of rapid changes occurred, involving commenting out and uncommenting various filter components (`PopoverPanel` for custom date range, "Period" `SelectBoxLight`, "View By" `SelectBoxLight`, "Filter" `SelectBoxLight`, and `SwitchBox`) and adding/removing temporary debugging HTML elements (`<`, `<h1>hhhhh</h1>`). This indicates intense, localized debugging and testing of the toolbar's filtering and display functionalities.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Initial Update (10/29/2025, 11:02:52 AM):** This component is responsible for rendering individual analytics metric boxes, including the `MetricToolbar`, various chart types (`PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`), and `MetricFooter`. It manages the chart view state and provides a full-screen modal for enlarged chart views.
    *   **Toolbar Commenting/Uncommenting (10/29/2025, 11:03:15 AM & 10/29/2025, 11:03:25 AM):** The `MetricToolbar` in the main render block was temporarily commented out and then restored, likely for testing purposes.
    *   **Debugging Console Log (10/29/2025, 11:04:05 AM):** A `console.log` for `item` was added, along with a minor refactor in how `getChartComponent` is called within the main render, though functionally identical to its previous state.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Initial Update (10/29/2025, 11:18:07 AM):** This file contains utility functions for analytics. It includes `TruncateText`, `metricsPackageHandler` (for formatting metric data, determining chart types, and calculating aggregate values), `allChartOptions` (chart type definitions), `chartOptionsByType` (mapping chart types to available views), `reportFormula` (generating formula strings), `weekDateFormater`, and `downloadReportSpreadsheet`. The `downloadReportSpreadsheet` function is notably complex, preparing data for Excel export with specific logic for different chart types, period filters, and report names. The provided code for `downloadReportSpreadsheet` is truncated, ending mid-statement.

**Patterns and Recurring Elements:**

*   **Active Debugging:** A prominent pattern is the frequent addition/removal of `console.log` statements, temporary text modifications (e.g., "MBL Wise1", "Excel1", "Period1", "No Data Available123"), and extensive commenting/uncommenting of UI blocks. This suggests that the developer was actively debugging and testing various frontend components and features, particularly within the analytics section.
*   **Redux for State Management:** All significant React components (`ViewContainer`, `MetricFooter`, `MetricToolbar`, `MetricsBox`, `PlanboardCardView`) extensively use `useSelector` and `useDispatch` from `react-redux`, indicating a centralized and predictable state management architecture.
*   **Analytics-focused Development:** A large portion of the changes revolves around the analytics dashboard: custom view creation, metric selection, chart rendering, and report generation (Excel/PDF).
*   **UI Component Reusability:** Custom components like `InputBox`, `Button`, `ThemeTabs`, `SelectBoxLight`, `PopoverPanel`, `ThemedModal`, and `Loader` are imported and used across different files, highlighting a component-based design approach.
*   **API Integration:** API calls for fetching and saving dashboard options are consistently made using a specific `apiKey`, suggesting a secure and structured way to interact with backend services.

## 12:25:09 PM
The changes log details updates across several files related to an analytics backend, focusing on dashboard management and report generation.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file handles core dashboard view operations: `getAll`, `create`, `update`, and `deleteView`.
    *   A significant addition is the `logAudit` function, which is now invoked for every create, update, and delete operation on dashboards. This function records details like `userId`, `action` (CREATE, UPDATE, DELETE), `menuTitle`, `previousValue`, `newValue`, and `user` into an `analytics_view_log` table, indicating enhanced auditing capabilities for user actions on dashboards.
    *   Dashboard creation checks for existing views and returns an error if a view with the same `user_id` and `menu_title` already exists.
    *   Update operations now retrieve `dashboard_metrics` before updating to capture `previousValue` for auditing.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM)**
    *   This file defines SQL query snippets for various "Booking Date to..." reports, including regular and "Stacked Bar" variations, with both container-wise and MBL-wise aggregations.
    *   The `bookingQuery` function dynamically constructs SQL based on `reportName` and parameters like `CompanyName`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, `stackedExport`, and `displayBy`.
    *   A helper function `getMonthValue` is included to convert abbreviated month names to numeric values for SQL queries.
    *   Across multiple timestamps, the code for this file remains largely identical, suggesting minor re-saves, formatting, or negligible changes. The primary function is to provide structured SQL for export reports.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM)**
    *   Manages analytics metrics for dashboards, including fetching, ordering, and resizing.
    *   `getMetricList`: Fetches all metrics, categorizes them by `filter_by` ('Container_Wise' or 'MBL_Wise'), and groups them by `group`. It supports a `preload` feature to mark metrics as `checked` if they are part of a specified `dashboard_name`. A `console.log` statement was temporarily added for debugging (`===jhjkkk`).
    *   `dashboardEndPointList`: Retrieves and sorts report endpoints based on a user's saved `dashboard_metrics` order for a given `menuTitle`. It also retrieves `size` information (rowSpan, columnSpan) for each metric from the `dashboards` table.
    *   `saveSequence`: Allows users to define and save the display order of metrics for a dashboard. It handles a special case for a 'Default' dashboard, creating it if it doesn't exist.
    *   `saveSize`: A new endpoint was added to save the `columnSpan` and `rowSpan` properties for individual metrics within a dashboard, storing this layout information in the `dashboards` table's `size` JSONB column.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Multiple timestamps from 10/28/2025, 4:22:21 PM to 10/29/2025, 12:17:47 PM)**
    *   This file, particularly the `mblQueryBuilder` function, saw significant iterative development.
    *   **Initial (10/28, 4:22 PM):** Handled `ContainerShippedMblWise` and `TotalShipmentsMblWise` with simple aggregation queries.
    *   **Major Refactoring (10/28, 5:05 PM onwards):**
        *   The `ContainerShippedMblWise` report was completely re-architected to analyze container counts across "Current Quarter" and "Last Quarter" based on `deliverd_date`.
        *   Introduced dynamic calculation of quarter start and end dates within the code, making the query self-contained for date ranges.
        *   The query now uses a Common Table Expression (CTE) `completed_shipments` to standardize `deliverd_date` calculation before grouping by quarter and month.
        *   Output formatting changed to include `quarter`, `month` (e.g., 'Mon'), and `container_count`.
    *   **Refinements (10/29):**
        *   The logic for defining "This Quarter" and "Last Quarter" date ranges was updated multiple times. Initially calculating based on a 3-month quarter, it evolved to define a "Last 4 months + This 4 months" window, providing more granular monthly data within these quarters.
        *   `customizer.calType` was briefly set to "avg" then removed, and `customizer.dateColumns` was added and refined to reflect the chart's axes, changing from `['This Quarter', 'Last Quarter']` to `['TEU', 'Month']` and finally `['Month', 'TEU']`.
        *   The `codeCustomization` flag in the interface/parameters was gradually simplified/removed as the builder became fully responsible for constructing the analytics data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Multiple timestamps from 10/28/2025, 5:09:46 PM to 10/29/2025, 11:23:55 AM)**
    *   This controller acts as a central dispatcher for analytics reports.
    *   It imports and calls various `QueryBuilder` functions (chassis, booking, departure, container, general, mbl) based on the `type` parameter in the request.
    *   For the `ContainerShippedMblWise` type, it was updated to call the `mblQueryBuilder`. Notably, `codeCustomization` is set to `true` when calling `generalQueryBuilder` and `mblQueryBuilder`, indicating these builders generate the full analytical data object, not just a SQL string for the main `query` function.
    *   In later updates, `fromDate` and `toDate` parameters were commented out when calling `mblQueryBuilder`, aligning with the changes in `mbls.query.ts` where date range calculation became internal to that builder. A temporary `customizer.chartType = "StackedBar";` was briefly inserted and then removed.

**Patterns and Recurring Elements:**

*   **Analytics Domain:** All changes are deeply embedded in the analytics domain, focusing on tracking, reporting, and dashboard customization.
*   **Database-Centric Operations:** The codebase heavily relies on direct SQL queries (`query` function) for data retrieval and manipulation, indicating a direct interaction with a PostgreSQL-like database.
*   **User Context and Personalization:** User-specific data (`user_id`, `user.usercode`, `CompanyName`) is consistently used to scope queries and dashboard views, suggesting personalized analytics. Dashboard definitions, metric order, and metric sizes are tied to individual users.
*   **Dynamic Query Generation:** Several query builder files (`export.query.ts`, `mbls.query.ts`) programmatically construct complex SQL queries based on request parameters and report types.
*   **Iterative Development & Refinement:** The frequent and sometimes minor consecutive commits, especially for `mbls.query.ts`, point to active development, feature refinement, and potentially bug fixing or optimization cycles. The evolution of quarter calculation logic and `customizer` properties illustrates this.
*   **Robust Error Handling:** `try...catch` blocks are consistently used across controllers and query builders, ensuring that internal server errors are caught and communicated gracefully to the client.
*   **Clear Separation of Concerns:** Logic is generally organized into controllers (handling requests/responses) and query builders (handling specific report logic and SQL generation).

## 12:25:27 PM
The log details recent changes primarily focused on enhancing the analytics section of the T360 frontend application, with minor updates to the planboard view.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Timestamp:** October 28, 2025, 2:02:33 PM, 3:48:07 PM, 5:53:50 PM.
    *   **Key Changes:** Introduced comprehensive functionality for managing custom analytics views. Users can now create, save, update, and delete custom dashboards. The component includes state management for checkbox selections (`checkBoxManager`, `numChecked`), enforcing a maximum of 9 metrics per view. It integrates with Redux (`useSelector`, `useDispatch`) to manage analytics state and trigger data refetches. Error handling with `react-hot-toast` for missing view names or no selected metrics is in place. Audit functionality, including a `PopupAlert` for deletions and an `AuditViewDrawer` for viewing audit logs, was added. Debug `console.log` statements were added at 3:48:07 PM and 5:53:50 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Timestamp:** October 28, 2025, 2:04:34 PM, 3:46:33 PM, 3:46:51 PM.
    *   **Key Changes:** This component was developed to display hierarchical data for metric selection using MUI's `SimpleTreeView` and `TreeItem`. Each metric is associated with a `Checkbox` that interacts with the `ViewContainer`'s `checkBoxManager`. Styles were applied for scrollable content. Minor debugging changes involved adding and then reverting "kk" to a label at 3:46:33 PM and 3:46:51 PM, alongside a `console.log`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Timestamp:** October 28, 2025, 3:35:37 PM, 3:37:47 PM. Subsequent timestamps (5:49:01 PM, 11:09:14 AM, 11:17:33 AM, 11:53:55 AM, 11:54:19 AM, 11:55:32 AM, 11:56:24 AM on October 29) show identical code content, suggesting multiple saves without functional changes.
    *   **Key Changes:** The `ANALYTICS_REPORT_HEADER` constant, which maps report names to their display columns, was significantly expanded. New categories like "Container Wise KGS", "MBL Wise KGS", "Container Wise Transit", "MBL Wise Transit", and "Chassis MBL Wise" were added with their respective column definitions. A specific entry, "Containers Shipped ", was removed at 3:37:47 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Timestamp:** October 28, 2025, 4:05:26 PM, 4:08:24 PM.
    *   **Key Changes:** A debugging change involved adding "123" to the "No Data Available" `Typography` component's text. A `console.log` for `planboardData` was also introduced at 4:05:26 PM. The subsequent timestamp shows identical content.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Timestamp:** October 29, 2025, 9:56:31 AM, 9:57:53 AM.
    *   **Key Changes:** Introduced functionality for exporting report data. Buttons for "Excel" and "PDF" export were added, conditionally displayed based on data availability. Excel export now includes a `ColumnsSelector` modal to allow users to choose which columns to export. PDF export utilizes `jspdf` and `html2canvas` to render the chart component into a PDF. Loading states for both exports (`loading`, `pdfLoading`) were implemented. A `console.log` for `item` was added at 9:57:53 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Timestamp:** October 29, 2025, from 10:54:57 AM to 11:02:26 AM.
    *   **Key Changes:** This file saw frequent, minor, and often transient changes, primarily involving commenting out and uncommenting various filter components (`SelectBoxLight` for "Period", "View By", "Filter", and `PopoverPanel` for `DateRange`) and the `SwitchBox` component. A temporary `<h1>hhhhh</h1>` tag was added and removed at 11:00:16 AM and 11:00:25 AM, respectively. These rapid changes suggest active debugging and UI layout experimentation. Ultimately, by 11:02:26 AM, all previously commented-out filter components and the `SwitchBox` were restored.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** October 29, 2025, 11:02:52 AM, 11:03:15 AM, 11:03:25 AM, 11:04:05 AM, 11:20:37 AM.
    *   **Key Changes:** This component handles the rendering of various chart types (Bar, Pie, Line, Stacked Bar, Gauge) and their associated toolbars and footers. It was updated to dynamically render charts based on `chartType` and `chartView`. A `ThemedModal` was integrated for a full-screen chart view. The `MetricToolbar` was temporarily commented out and restored in the main render at 11:03:15 AM and 11:03:25 AM. At 11:20:37 AM, the main chart component (`chartComponent`) was explicitly configured to display only the first 9 data points, while the full data is used for the enlarged view. Debug `console.log` statements were added at 11:02:52 AM and 11:20:37 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Timestamp:** October 29, 2025, 11:18:07 AM, 11:25:01 AM.
    *   **Key Changes:** Significant refactoring of analytics utility methods. The `metricsPackageHandler` function was updated to refine how chart types are determined (`findChartType`) and how calculation types (e.g., Average, Total) and their display (`getCal`) are handled, specifically excluding `StackBar` and `Transit` charts from displaying 'Avg'. A `formatHandler` was introduced for dynamic formatting based on data type. The `downloadReportSpreadsheet` function received major updates to support `selectedColumns` for Excel export and intricate logic to format report headers and data based on `periodFilter` and `chartType`, especially for stacked bar and transit charts. A minor correction in `findChartType` was made at 11:25:01 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **Timestamp:** October 29, 2025, 11:45:45 AM, 11:46:15 AM, 12:13:49 PM, 12:16:08 PM.
    *   **Key Changes:** This component underwent several iterations of development. Initially (11:45:45 AM), it was set up for basic stacked bar rendering with dynamic categories, tooltip formatting, and animation control. At 11:46:15 AM, `plotOptions.bar.bar: { distributed: false }` was added, tooltip styles were changed, and `dataLabels.offsetX` was adjusted, while explicit colors were temporarily removed from state options. A major refactor at 12:13:49 PM introduced `prepareStackedData` for explicit handling of "This Quarter" vs "Last Quarter" data, leading to a more structured way of forming series for quarter-based comparisons, and restoring the specific colors for these quarters. The final update at 12:16:08 PM generalized this by introducing `isQuarterData` for "smart detection" of quarter-based data, allowing the chart to dynamically adapt its series generation and color palette based on the data content, using a default palette otherwise.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** The vast majority of changes are centered on enhancing and debugging the analytics functionality, including custom view creation, report generation, chart rendering, and data filtering.
*   **Debugging Practices:** Frequent use of `console.log` statements with distinct identifiers (e.g., "===jhhjkk", "===tree") and temporary UI element commenting/uncommenting indicates an active and iterative debugging process across multiple components.
*   **UI/UX Enhancements:** Introduction of modals for column selection (Excel export) and full-screen chart views, along with dynamic chart rendering capabilities, points to ongoing improvements in user interface and experience.
*   **Redux for State Management:** Consistent use of `useSelector` and `useDispatch` highlights a strong reliance on Redux for managing application state, particularly for analytics filters and data.
*   **API Integration:** Components frequently interact with API queries (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`) to fetch and save user-defined analytics configurations.
*   **Hardcoded Values:** The `apiKey: "nRKniUrJd6rjNCyvT8iRRHmG"` is hardcoded in `ViewContainer.jsx` for API requests.
*   **Date Handling:** The `moment.js` library is used for formatting dates in reports and chart labels.
*   **MUI Component Usage:** Material-UI components are extensively used for building the user interface, ensuring a consistent design.

## 1:25:21 PM
The logged changes across the `t360-frontend` repository primarily focus on enhancing the analytics and planboard sections. This includes improvements to custom dashboard views, dynamic chart rendering, and report generation functionalities. A recurring pattern observed is the frequent use and subsequent removal or commenting out of `console.log` statements, indicating active debugging and development cycles. Many components also underwent rapid toggling (commenting/uncommenting) of UI elements and logic, especially within the analytics toolbar, suggesting iterative development and testing.

**File-Specific Updates:**

*   **`ViewContainer.jsx`**: This component, responsible for managing custom analytics dashboards (creating, editing, deleting), received several debugging `console.log` additions to track `viewOptions` and `viewName` on October 28, 2025. It also includes a hardcoded API key for `useFetchDashboardOptionsQuery` and `useSaveDasboardMutation`.
*   **`TreeViewContianer.jsx`**: This component, which renders a tree-like structure for selecting metrics in custom views, saw a brief, temporary string `kk` added to a label and then immediately removed on October 28, 2025, likely for quick UI testing.
*   **`analytics.js`**: On October 28, 2025, the `ANALYTICS_REPORT_HEADER` object was updated to complete an existing entry (`"Container by Ocean Freight Carrier (SCAC)"`) and add a new one (`"Container by Port of Loading"`). Subsequent timestamps for this file on October 29, 2025, show no functional changes, suggesting repetitive save operations.
*   **`PlanboardCardView.jsx`**: A debugging `console.log` for `planboardData` was added to this component on October 28, 2025. The component also displays a "No Data Available123" message when no data is present.
*   **`MetricFooter.jsx`**: On October 29, 2025, the footer component gained a "Select Columns" modal for more controlled Excel exports. A debugging `console.log` was added, and the Excel button label was temporarily set to "Excel1".
*   **`MetricToolbar.jsx`**: This component experienced rapid and extensive changes on October 29, 2025, between 10:54 AM and 11:02 AM. This included adding/removing debugging statements, temporarily changing a label to "Period1", and repeatedly commenting out and uncommenting various filter elements (custom date range `PopoverPanel`, "Period" filter, "View By" filter, and the main "Filter" select box). This indicates intensive debugging and feature adjustments.
*   **`MetricsBox.jsx`**: Also on October 29, 2025, this component (which wraps individual analytics metrics) saw `MetricToolbar` being temporarily commented out and then restored, both in the main render and within the full-screen modal. A key functional change involved explicitly slicing chart data to a maximum of 9 items for non-enlarged views. A debugging `console.log` for item data was also added.
*   **`methods.js`**: The `findChartType` function was updated on October 29, 2025, to remove a specific condition that would force a "StackedBar" type for "Containers Shipped (Mbl Wise)" reports, making it default to `AnalyticsChartType.General`. The Excel export logic for `transitBar` charts has an incomplete code block.
*   **`StackedBarChart.jsx`**: This chart component underwent significant refactoring on October 29, 2025, from 11:45 AM to 12:16 PM. The changes involved evolving the data preparation and series generation logic to intelligently handle both specific "This Quarter" / "Last Quarter" data structures and more general stacked metric data, including conditional color palettes and `stackType` settings.

**Timestamps of Significant Changes:**

*   **October 28, 2025 (afternoon):** Initial setup of custom view components (`ViewContainer.jsx`, `TreeViewContianer.jsx`), expansion of analytics report headers (`analytics.js`), and a debugging addition to `PlanboardCardView.jsx`.
*   **October 29, 2025 (morning, particularly 9:56 AM - 12:16 PM):** A period of intense development and debugging activity within the analytics features. This includes the introduction of export column selection (`MetricFooter.jsx`), rapid iteration and testing of filter controls (`MetricToolbar.jsx`), data handling adjustments in `MetricsBox.jsx`, and a substantial refactoring of the `StackedBarChart.jsx` component to handle diverse data inputs.

**Patterns or Recurring Elements:**

*   **Debugging statements:** The frequent addition and removal or commenting of `console.log` statements in various files suggests a development process that heavily relies on in-code logging for troubleshooting.
*   **Iterative UI/Logic refinement:** The repeated commenting/uncommenting of code blocks, particularly in `MetricToolbar.jsx` and `MetricsBox.jsx`, points to a rapid, iterative process of testing and adjusting UI elements and their associated functionalities.
*   **Analytics Feature Development:** A strong focus on improving the analytics dashboard's functionality, from custom view management to chart rendering and export options.
*   **Conditional data visualization:** The `StackedBarChart.jsx` component's evolution indicates a move towards making chart components more adaptable to different data structures and reporting needs.

## 1:25:30 PM
The provided log details changes primarily within the analytics module of the `t360-backend` application, focusing on dashboard management and report generation.

**File-Specific Updates and Timestamps:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts`**
    *   **10/28/2025, 1:58:56 PM:** This file defines the core API for managing user-specific dashboards. It includes functions for:
        *   `getAll`: Retrieving a user's saved dashboards (menu titles).
        *   `create`: Creating a new dashboard with a name and associated metrics, including a check for existing view names and an audit log entry.
        *   `update`: Modifying an existing dashboard's name and metrics, also with an audit log entry that records previous and new metric values.
        *   `deleteView`: Removing a dashboard, again with an audit log.
        *   A `logAudit` helper function is used internally to record these dashboard management actions.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts`**
    *   **10/28/2025, 3:49:50 PM:** Introduces functionalities related to analytics metrics:
        *   `getMetricList`: Fetches all available metrics, categorizing them into 'Container_Wise' and 'MBL_Wise' groups. It supports a 'preload' feature to mark metrics already selected for a specific dashboard.
        *   `dashboardEndPointList`: Retrieves the endpoints for metrics associated with a given dashboard, sorted by a user-defined order and including `rowSpan` and `columnSpan` for display sizing.
        *   `saveSequence`: Allows users to define and save the display order of metrics within a dashboard. Special handling is included for a 'Default' dashboard.
        *   `saveSize`: Stores custom `columnSpan` and `rowSpan` values for individual metrics within a dashboard.
    *   **10/28/2025, 3:50:57 PM:** A minor change was introduced to `getMetricList` by adding a `console.log` statement for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **10/28/2025, 3:38:52 PM - 10/29/2025, 10:10:01 AM:** This file remained largely consistent across multiple timestamps, primarily defining the `bookingQuery` function. This function dynamically generates complex SQL queries for various "Booking Date to X" reports, including "Actual Departure", "Estimated Departure", and "POD Arrival", with options for MBL-wise and stacked bar visualizations. The stacked bar logic incorporates date filtering by month, week, or quarter and categorizes differences (e.g., `day_diff`) into time buckets like "Less than 1 week", "1 - 2 weeks", etc. A `getMonthValue` helper translates month names to numbers.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts`**
    *   **10/28/2025, 4:22:21 PM:** Initial version of `mblQueryBuilder` handling `ContainerShippedMblWise` and `TotalShipmentsMblWise` reports, calculating shipment and container/MBL counts.
    *   **10/28/2025, 5:05:54 PM:** Major refactoring. `ContainerShippedMblWise` was redefined to calculate container counts for "completed shipments" categorized by "Current Quarter" and "Last Quarter" based on dynamic date ranges, using a `WITH` clause for `completed_shipments`. The original `ContainerShippedMblWise` logic was seemingly moved/renamed to `TotalShipments`.
    *   **10/28/2025, 5:06:57 PM:** Minor adjustment to `must` columns for the `TotalShipments` report type's `customizer.selectedColumns`.
    *   **10/28/2025, 5:08:14 PM:** Reverted, focusing `mblQueryBuilder` back exclusively on `ContainerShippedMblWise` with the complex quarter-based logic. The `codeCustomization` parameter was removed from the function signature and destructured parameters.
    *   **10/28/2025, 5:12:32 PM - 5:12:38 PM:** The `codeCustomization = true;` line within `ContainerShippedMblWise` logic was commented out.
    *   **10/28/2025, 5:15:25 PM:** `mblQueryBuilder`'s function signature was updated for explicit typing. `fromDate` and `toDate` were made optional. The quarter calculation logic was refined with a `fmt` helper, and the post-query data mapping was adjusted to include percentage calculations after determining `maxTotal`.
    *   **10/28/2025, 6:07:21 PM:** No functional changes.
    *   **10/29/2025, 10:22:22 AM:** The quarter calculation logic was further refined to define "This Quarter" and "Last Quarter" each spanning *four months*, with the SQL query updated to group results by month within these quarters. The result mapping was simplified, omitting `maxTotal` and `percentage` calculation at this stage.
    *   **10/29/2025, 10:35:41 AM:** The 8-month window calculation was explicitly defined (last 4 months for "This Quarter", previous 4 for "Last Quarter"). `TO_CHAR(deliverd_date, 'Mon')` was introduced for shorter month names, and ordering by `DATE_TRUNC('month', deliverd_date)` was added.
    *   **10/29/2025, 10:43:50 AM - 10:44:49 AM:** Added `customizer.calType = "avg";` in `ContainerShippedMblWise` logic to configure how `customizer` processes the data.
    *   **10/29/2025, 11:37:34 AM:** Set `customizer.dateColumns = ['This Quarter', 'Last Quarter']` within the `ContainerShippedMblWise` logic.
    *   **10/29/2025, 11:38:49 AM:** Changed `customizer.dateColumns` to `['TEU', 'Month']`.
    *   **10/29/2025, 12:17:47 PM:** Changed `customizer.dateColumns` again to `['Month', 'TEU']`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **10/28/2025, 5:09:46 PM:** This file functions as a central dispatcher (`getTableDataReports`) for various analytics reports, calling different query builder functions (chassis, booking, container, departure, general, mbls) based on the `type` parameter. It introduced a `codeCustomization` flag to determine if the query builder directly returns data or if a generic `query(mainQuery)` call is needed. `ContainerShippedMblWise` was explicitly handled by `mblQueryBuilder` with `codeCustomization` set to true.
    *   **10/28/2025, 5:12:24 PM:** Removed the explicit `codeCustomization = true;` setting before calling `mblQueryBuilder`.
    *   **10/28/2025, 5:14:52 PM:** Re-added the explicit `codeCustomization = true;` setting before calling `mblQueryBuilder`.
    *   **10/29/2025, 10:23:17 AM:** Modified the call to `mblQueryBuilder` by commenting out `fromDate` and `toDate` arguments, reflecting the internal date calculation changes in `mbls.query.ts`.
    *   **10/29/2025, 11:23:41 AM:** An erroneous line `customizer.chartType = "StackedBar";` was temporarily added directly in this controller before calling `mblQueryBuilder`.
    *   **10/29/2025, 11:23:55 AM:** The erroneous `customizer.chartType` assignment was removed.
    *   **10/29/2025, 1:14:39 PM:** Significantly re-routed `ContainerShippedMblWise`: it was moved from its dedicated `else if` block to be handled by `bookingQueryBuilder` alongside other booking-related reports. A redundant `else if` block for `ContainerShippedMblWise` was still present below.
    *   **10/29/2025, 1:17:31 PM:** The redundant `else if (type === 'ContainerShippedMblWise')` block was commented out, solidifying the change to route this report type through `bookingQueryBuilder`.

**Patterns and Recurring Elements:**

1.  **Analytics Focus:** All changes are consistently related to building and serving analytics reports and managing user dashboards.
2.  **Date-Centric Logic:** Many reports heavily rely on date calculations, date range filtering, and date-based aggregations (e.g., `EXTRACT(DAY FROM...)`, `DATE_TRUNC`, dynamic quarter/month calculations). The `mbls.query.ts` file shows a clear evolution in its date handling, shifting from simple `fromDate`/`toDate` to sophisticated dynamic quarter definitions.
3.  **Database Interaction:** Extensive use of raw PostgreSQL queries (via a `query` helper) is central to all data retrieval. Queries are dynamically constructed based on user input and report type.
4.  **`customizer` Object:** A `customizer` object is frequently passed around and mutated by query builder functions to convey metadata about the report, such as date columns, calculation types (`avg`, `total`), and chart types (`StackedBar`).
5.  **Report Dispatcher:** The `others.controller.ts` acts as a dispatcher for various report types, using a long `if/else if` chain to delegate to specialized query builder functions.
6.  **`getColumnsByCategory` Utility:** This utility function is consistently used to dynamically select relevant columns for reports, often specifying columns to ignore or include.
7.  **Audit Logging:** The `core.view.controller.ts` explicitly implements audit logging for dashboard creation, updates, and deletions.
8.  **Error Handling:** `try...catch` blocks are consistently used to handle potential errors and return 500 status codes.
9.  **Refactoring and Evolution:** The log shows a clear iterative development process, with functions like `mblQueryBuilder` undergoing significant refactoring (e.g., date logic, removal of parameters) and reports being re-routed between different query builders (e.g., `ContainerShippedMblWise` moving from `mblQueryBuilder` to `bookingQueryBuilder`).
10. **Stacked Bar Charts:** Specific logic for stacked bar charts is present in `export.query.ts` and `mbls.query.ts`, categorizing data into time-based bins (e.g., "Less than 1 week", "This Quarter", "Last Quarter").