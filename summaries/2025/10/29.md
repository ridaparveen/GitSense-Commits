# Activity Summary for 10/29/2025

## 10:25:04 AM
The core of these changes centers on enhancing the analytics and planboard features of a frontend application, specifically concerning custom view management, data display, and export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **(10/28/2025, 2:02:33 PM):** This file introduces a robust component for creating, editing, and deleting custom analytics dashboards. It includes state management for selected metrics (`checkBoxManager`, `numChecked`), a view name, and alert configurations. It integrates with Redux (`useSelector`, `useDispatch`) for global state management and interacts with an `analyticsApi` for fetching dashboard options and saving/deleting views. The component supports "Container Wise" and "MBL Wise" metric selection via tabs and a `TreeViewContianer`. Key actions like saving (POST/PUT based on `action`) and deleting views are implemented with toast notifications and Redux dispatches to update the UI. An `AuditViewDrawer` is also integrated for audit functionality.
    *   **(10/28/2025, 3:48:07 PM & 10/28/2025, 5:53:50 PM):** Minor debugging statements (`console.log`) were added to inspect `viewOptions` and `viewName`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **(10/28/2025, 2:04:34 PM):** This component is responsible for rendering a hierarchical tree view of analytics metrics, grouped by category. It uses `@mui/x-tree-view` components. Checkboxes are integrated into each metric item, and their checked state is controlled by the `checkBoxManager` prop, with `handleCheckBoxClicked` managing selection logic.
    *   **(10/28/2025, 3:46:33 PM & 10/28/2025, 3:46:51 PM):** A temporary "kk" string was added and subsequently removed from the metric label, indicating a brief debugging or testing phase for the display of metric names.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **(10/28/2025, 3:35:37 PM):** This file defines extensive configuration constants for analytics, including:
        *   `DEFAULT_ANALYTICS_ENDPOINTS`: A list of default report names and their corresponding API URLs, categorized by grouping columns (e.g., `scac_code`, `pol`, `pod`, `shipper`) and metrics (CBM, TEU).
        *   `EXCEL_EXPORT_COLUMNS`: A comprehensive list of column definitions (key and display name) for Excel exports, covering various shipping and tracking details.
        *   `CargoReadyToETD10Days`: A specific subset of columns.
        *   `ANALYTICS_REPORT_HEADER`: A large object mapping report names to arrays of strings representing their expected table headers, covering CBM, TEU, KGS, Transit Time, and Chassis-related metrics, both "Container Wise" and "MBL Wise."
    *   **(10/28/2025, 3:37:47 PM):** A previous incomplete header entry for "Containers Shipped" was removed, and an incomplete "Container by Ocean Freight Carrier (SCAC)" entry was completed, along with adding "Container by Port of Loading". This indicates a refinement and completion of the report header configurations.
    *   **(10/28/2025, 3:38:11 PM & 10/28/2025, 5:49:01 PM):** These timestamps show no discernible content changes, suggesting potential save operations or automated formatting updates without functional modifications.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **(10/28/2025, 4:05:26 PM):** This component manages the display of planboard data, supporting both "year" and "month" views. It fetches data using `useFetchPlanboardQuery` and processes it with `filterHandler` and `prepare...FilterObject` utility functions. It conditionally renders `YearViewItem` (grid layout) or `MonthViewItem` (horizontal stack of scrollable monthly cards) and includes a `NoDataAvailable` component. The `NoDataAvailable` text was temporarily `No Data Available123`.
    *   **(10/28/2025, 4:08:24 PM):** A debugging `console.log` statement was added to display `planboardData`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **(10/29/2025, 9:56:31 AM):** This component provides interactive footer elements for analytics metrics, enabling data export and view enlargement. It offers Excel export with a `ColumnsSelector` for user-defined columns, and PDF export using `jspdf` and `html2canvas` to render the chart component into a PDF. Loading states are managed for both export types. It also displays calculated metric values (`calShow`, `calType`, `calValue`) and tooltips for report formulas.
    *   **(10/29/2025, 9:57:53 AM):** A debugging `console.log` statement was added to inspect the `item` prop.

**Timestamps of Significant Changes:**

*   **10/28/2025, 2:02:33 PM:** Introduction of the comprehensive `ViewContainer.jsx` for analytics custom view management.
*   **10/28/2025, 2:04:34 PM:** Initial implementation of `TreeViewContianer.jsx` for displaying metrics.
*   **10/28/2025, 3:35:37 PM:** Detailed configuration of analytics reports and export columns in `analytics.js`.
*   **10/28/2025, 3:37:47 PM:** Refinement of analytics report headers in `analytics.js`, including completion of previously truncated entries.
*   **10/28/2025, 4:05:26 PM:** Implementation of `PlanboardCardView.jsx` for displaying planboard data in different views.
*   **10/29/2025, 9:56:31 AM:** Integration of advanced export functionalities (Excel with column selection, PDF generation) into `MetricFooter.jsx`.

**Patterns and Recurring Elements:**

*   **Debugging Statements:** There's a recurring pattern of adding `console.log` statements in various components (`ViewContainer`, `TreeViewContianer`, `PlanboardCardView`, `MetricFooter`) at different timestamps. This indicates active development, testing, and troubleshooting across these UI features.
*   **Redux/RTK Query Integration:** The application consistently uses Redux (`useSelector`, `useDispatch`) and RTK Query (`useFetch...Query`, `useSave...Mutation`) for state management and API interactions across multiple components (`ViewContainer`, `PlanboardCardView`, `MetricFooter`), highlighting a centralized data flow architecture.
*   **Material-UI (MUI) & Custom Components:** The changes extensively utilize Material-UI components (e.g., `Box`, `Stack`, `Grid`, `Button`, `Checkbox`, `CircularProgress`, `Tooltip`, `Chip`, `TreeItem`, `SimpleTreeView`) along with custom common components (`InputBox`, `ThemeButton`, `OutlinedButton`, `ThemeTabs`, `Loader`, `PopupAlert`, `AuditViewDrawer`, `TMenu`, `ThemedModal`, `ColumnsSelector`). This indicates a consistent design system and component-based development approach.
*   **Analytics Feature Development:** A strong focus is observed on the analytics section, encompassing custom dashboard creation, metric selection, configuration of various reports (CBM, TEU, KGS, Transit, Chassis), and comprehensive data export options.
*   **Rapid Iteration/Commits:** The timestamps for `analytics.js` show very close successive entries (3:35:37 PM, 3:37:47 PM, 3:38:11 PM, 5:49:01 PM), with some content appearing identical between logs. This could imply frequent saves, automated formatting, or quick, iterative adjustments.

## 10:25:15 AM
This log primarily details updates within the `t360-backend`'s analytics module, focusing on dashboard management and report query generation. Significant changes occurred across three main files: `core.view.controller.ts`, `core.metric.controller.ts`, and the query builders `export.query.ts` and `mbls.query.ts`, as well as the central `others.controller.ts`.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file, responsible for managing user-defined analytics dashboards, saw comprehensive updates. It now includes `getAll`, `create`, `update`, and `deleteView` functions, allowing users to manage their dashboard views.
    *   A key addition is the `logAudit` function, which records all dashboard modifications (creation, update, deletion) in an `analytics_view_log` table, capturing user details, action, menu title, and previous/new values.
    *   Dashboard metrics are stored as `ARRAY` in the `dashboards` table.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM)**
    *   This file contains the `bookingQuery` function, which generates dynamic SQL for various booking-related reports (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival").
    *   It supports filtering by month, week, or quarter and categorizing time differences into predefined ranges (e.g., "Less than 1 week", "1 - 2 weeks").
    *   A `getMonthValue` helper function is used to map month names to numerical values.
    *   Notably, the code content remained identical across multiple timestamps, suggesting frequent saves without functional changes or incomplete logs. The SQL query strings consistently appear truncated at the end in the provided log entries.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM)**
    *   This controller manages metrics and their display on dashboards.
    *   `getMetricList` was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and support preloading selected metrics for an existing dashboard.
    *   `dashboardEndPointList` retrieves metrics, their order, and crucially, new `rowSpan` and `columnSpan` properties, indicating added support for customizing metric display sizes.
    *   New functions `saveSequence` and `saveSize` were introduced:
        *   `saveSequence` allows users to reorder metrics on their dashboards.
        *   `saveSize` enables saving custom display dimensions (column and row span) for individual metrics, persisting this layout information in the `dashboards` table's `size` JSONB column.
    *   A minor `console.log` was added for debugging (`10/28/2025, 3:50:57 PM`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps: 10/28/2025, 4:22:21 PM; 10/28/2025, 5:05:54 PM; 10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM; 10/28/2025, 5:12:32 PM; 10/28/2025, 5:12:38 PM; 10/28/2025, 5:15:25 PM; 10/28/2025, 6:07:21 PM; 10/29/2025, 10:22:22 AM)**
    *   This file saw extensive and iterative development for the `mblQueryBuilder`.
    *   Initially (10/28/2025, 4:22:21 PM), it handled 'ContainerShippedMblWise' and 'TotalShipmentsMblWise' by calculating shipment/container counts.
    *   A major refactor (10/28/2025, 5:05:54 PM) changed 'ContainerShippedMblWise' to calculate container counts based on "completed shipments" (identified by delivery dates), grouped by dynamically determined 'Current Quarter' and 'Last Quarter' using complex date logic. The 'TotalShipmentsMblWise' report type was renamed to 'TotalShipments'.
    *   Subsequent changes (10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM) streamlined the builder, removing the `TotalShipments` report type from its scope.
    *   Refinements continued with the `codeCustomization`, `fromDate`, and `toDate` parameters being adjusted or removed from the `mblQueryBuilder` signature, indicating these parameters are now handled differently or are dynamically generated internally (10/28/2025, 5:12:32 PM; 10/28/2025, 5:15:25 PM; 10/29/2025, 10:22:22 AM).
    *   The dynamic quarter calculation for 'ContainerShippedMblWise' was further refined (10/28/2025, 5:15:25 PM), shifting to a "Last Quarter" and "This Quarter" window based on the current month, and the SQL query was updated to return monthly data within these quarters. The `maxTotal` calculation for percentages was removed as the data output structure changed.
    *   Further changes (10/29/2025, 10:22:22 AM) solidified the quarter logic to target a 3-month window for "This Quarter" (current month-1 to current month+1) and the preceding 3 months for "Last Quarter", and the query now groups by month within quarters.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps: 10/28/2025, 5:09:46 PM; 10/28/2025, 5:12:24 PM; 10/28/2025, 5:14:52 PM; 10/29/2025, 10:23:17 AM)**
    *   This central dispatcher for analytics reports was updated to incorporate the new `mblQueryBuilder`.
    *   A new `else if` block was added to call `mblQueryBuilder` specifically for the `ContainerShippedMblWise` report type, setting `codeCustomization = true`.
    *   Adjustments were made regarding the `codeCustomization` flag in relation to `mblQueryBuilder` calls, indicating a fine-tuning of which reports handle query generation internally vs. relying on a generic execution.
    *   The `fromDate` and `toDate` parameters were commented out in the call to `mblQueryBuilder` (`10/29/2025, 10:23:17 AM`), reflecting the internal date calculation logic now handled by `mbls.query.ts`.

### Timestamps of Significant Changes:

*   **10/28/2025, 1:58:56 PM:** Introduction of full CRUD operations and comprehensive audit logging for analytics dashboards.
*   **10/28/2025, 3:49:50 PM:** Major additions to dashboard metric management, including sorting and the ability to save custom metric display sizes (row/column span).
*   **10/28/2025, 5:05:54 PM:** Significant refactoring of `mblQueryBuilder`, introducing complex dynamic quarter-based calculations for `ContainerShippedMblWise`.
*   **10/28/2025, 5:15:25 PM & 10/29/2025, 10:22:22 AM:** Further iterative development and refinement of the `mblQueryBuilder` for 'ContainerShippedMblWise', specifically enhancing dynamic quarter calculations, adding monthly grouping, and adjusting parameter handling.
*   **10/29/2025, 10:23:17 AM:** Final adjustment in `others.controller.ts` to align `mblQueryBuilder` call with its updated parameter requirements.

### Patterns and Recurring Elements:

*   **Analytics Module Development:** All changes are concentrated within the `analytics` directory, indicating active and ongoing development of reporting and dashboard features.
*   **Dashboard Customization:** There's a clear emphasis on allowing users to customize their dashboards, from selecting metrics and their order to defining their visual layout (size).
*   **Dynamic SQL Query Generation:** The system heavily relies on specialized query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `mblQueryBuilder`) to construct complex SQL queries based on report type and user-specific parameters. This pattern suggests a highly flexible and extensible reporting infrastructure.
*   **Date-Based Reporting:** A recurring need for date and time-based filtering and grouping (by month, week, quarter) is evident across various reports, with specific logic for dynamic date range calculation.
*   **User/Company Context:** Queries consistently use `user_id` and `CompanyName` to filter data, reinforcing a multi-tenant or personalized analytics experience.
*   **Debugging/Logging:** The presence of `logger.info`, `logger.error`, and `console.log` statements suggests active development with a focus on observability and troubleshooting.
*   **Iterative Refinement:** Multiple timestamps for the same file, especially `mbls.query.ts` and `export.query.ts`, indicate an iterative development process, with frequent saves and incremental changes to logic and SQL queries.
*   **SQL String Interpolation:** SQL queries are often built using template literals, which requires careful input sanitization in a production environment to prevent SQL injection vulnerabilities.

## 11:25:07 AM
Changes across these files primarily focus on enhancing and refining the analytics dashboard and reporting functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM):** This file, managing analytics dashboards, introduced a comprehensive `logAudit` function to track user actions (CREATE, UPDATE, DELETE) on dashboards, recording user ID, action, menu title, and both previous and new metric values. The `update` function was modified to capture `previousValue` for auditing, and dashboard creation now includes a check to prevent duplicate views.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM):** This controller saw significant development. The `getMetricList` function was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and added a "preload" feature to mark selected metrics for existing dashboards. New functions `dashboardEndPointList` were introduced to fetch ordered dashboard metrics with their display properties (report name, URL, row/column span), and `saveSequence` and `saveSize` functions were added to allow users to customize the order and layout (size) of metrics on their dashboards, including special handling for "Default" dashboards. A minor debug `console.log` was added in a subsequent commit.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM):** This file defines SQL query templates for various booking-related reports. A notable change was the addition of a "Booking Date to POD Arrival (Stacked Bar)" query, which includes a filter for `t49_vessel_actualdeparted_date`. Multiple log entries for this file show virtually identical code content, suggesting minor non-functional updates or repeated saves without substantive changes in the provided snippets. The `bookingQuery` function dynamically constructs queries based on report name, company, and display settings (month, week, quarter).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps ranging from 10/28/2025, 4:22:21 PM to 10/29/2025, 10:44:49 AM):** This file, responsible for MBL-related queries, underwent several iterations. Initially, it included basic `ContainerShippedMblWise` and `TotalShipmentsMblWise` types calculating counts. Later, the `ContainerShippedMblWise` report was significantly refactored (around 10/28, 5:05:54 PM) to query for *completed shipments* and dynamically group container counts by "Current Quarter" and "Last Quarter" based on real-time dates. The `customizer.selectedColumns` `must` list was expanded to include many tracking data fields. Further refinements (around 10/29, 10:22:22 AM to 10/29, 10:44:49 AM) changed the quarter calculation logic to cover an "8-month window" (last 4 months + this 4 months) and group results by `quarter` and `month`, with `customizer.calType` also being temporarily set to "avg" before being removed again. The `fromDate` and `toDate` parameters were removed from the `mblQueryBuilder` signature, as the quarter calculation became internal.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps ranging from 10/28/2025, 5:09:46 PM to 10/29/2025, 11:23:55 AM):** This controller acts as the central dispatcher for analytics reports. It was updated to integrate the `mblQueryBuilder` for the `ContainerShippedMblWise` report type, marking it for `codeCustomization`. Throughout its changes, there were adjustments and re-additions of the `codeCustomization` flag when calling `mblQueryBuilder`, and parameter `fromDate`/`toDate` were removed from the `mblQueryBuilder` call, aligning with `mbls.query.ts`'s internal date handling. An attempt to set `customizer.chartType = "StackedBar";` for `ContainerShippedMblWise` in this file was later reverted, indicating the logic for `customizer` properties belongs within the individual query builders.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** All modifications are concentrated within the `analytics` domain, indicating active development of dashboard and reporting features.
*   **Database Interaction:** A `query` function (likely a database utility) is extensively used for data retrieval and manipulation across multiple files.
*   **User Contextualization:** Report generation and dashboard management consistently utilize `req.user` to fetch user-specific details (`usercode`, `companyname`) for personalized data access and filtering.
*   **Dynamic Query Generation:** SQL queries are frequently constructed dynamically using string interpolation and conditional logic based on various input parameters (e.g., report type, display options, date ranges).
*   **Date Filtering and Grouping:** There's a strong emphasis on date-based operations, including filtering by `fromDate` and `toDate`, extracting day differences (`EXTRACT(DAY FROM ...) `), and grouping by time periods (`DATE_TRUNC`, `TO_CHAR` for months/quarters). A recurring pattern in SQL WHERE clauses is to filter out invalid date values like `'0001-01-01 00:00:00 BC'`.
*   **Modular Query Builders:** The architecture leverages separate query builder files (`chassis.query`, `booking.query`, `container.query`, `departure.query`, `general.query`, `mbls.query`) to encapsulate the logic for different report types.
*   **`codeCustomization` Flag:** A `codeCustomization` flag is used to differentiate between reports where the controller executes a generated SQL query and those where the query builder itself processes data or returns a pre-processed result.
*   **Error Handling:** `try...catch` blocks are consistently used to wrap asynchronous operations, providing standard error responses.