# Activity Summary for 10/29/2025

## 10:25:04 AM
The core of these changes centers on enhancing the analytics and planboard features of a frontend application, specifically concerning custom view management, data display, and export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **(10/28/2025, 2:02:33 PM):** This file introduces a robust component for creating, editing, and deleting custom analytics dashboards. It includes state management for selected metrics (`checkBoxManager`, `numChecked`), a view name, and alert configurations. It integrates with Redux (`useSelector`, `useDispatch`) for global state management and interacts with an `analyticsApi` for fetching dashboard options and saving/deleting views. The component supports "Container Wise" and "MBL Wise" metric selection via tabs and a `TreeViewContianer`. Key actions like saving (POST/PUT based on `action`) and deleting views are implemented with toast notifications and Redux dispatches to update the UI. An `AuditViewDrawer` is also integrated for audit functionality.
    *   **(10/28/2025, 3:48:07 PM & 10/28/2025, 5:53:50 PM):** Minor debugging statements (`console.log`) were added to inspect `viewOptions` and `viewName`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **(10/28/2025, 2:04:34 PM):** This component is responsible for rendering a hierarchical tree view of analytics metrics, grouped by category. It uses `@mui/x-tree-view` components. Checkboxes are integrated into each metric item, and their checked state is controlled by the `checkBoxManager` prop, with `handleCheckBoxClicked` managing selection logic.
    *   **(10/28/2025, 3:46:33 PM & 10/28/2025, 3:46:51 PM):** A temporary "kk" string was added and subsequently removed from the metric label, indicating a brief debugging or testing phase for the display of metric names.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **(10/28/2025, 3:35:37 PM):** This file defines extensive configuration constants for analytics, including:
        *   `DEFAULT_ANALYTICS_ENDPOINTS`: A list of default report names and their corresponding API URLs, categorized by grouping columns (e.g., `scac_code`, `pol`, `pod`, `shipper`) and metrics (CBM, TEU).
        *   `EXCEL_EXPORT_COLUMNS`: A comprehensive list of column definitions (key and display name) for Excel exports, covering various shipping and tracking details.
        *   `CargoReadyToETD10Days`: A specific subset of columns.
        *   `ANALYTICS_REPORT_HEADER`: A large object mapping report names to arrays of strings representing their expected table headers, covering CBM, TEU, KGS, Transit Time, and Chassis-related metrics, both "Container Wise" and "MBL Wise."
    *   **(10/28/2025, 3:37:47 PM):** A previous incomplete header entry for "Containers Shipped" was removed, and an incomplete "Container by Ocean Freight Carrier (SCAC)" entry was completed, along with adding "Container by Port of Loading". This indicates a refinement and completion of the report header configurations.
    *   **(10/28/2025, 3:38:11 PM & 10/28/2025, 5:49:01 PM):** These timestamps show no discernible content changes, suggesting potential save operations or automated formatting updates without functional modifications.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **(10/28/2025, 4:05:26 PM):** This component manages the display of planboard data, supporting both "year" and "month" views. It fetches data using `useFetchPlanboardQuery` and processes it with `filterHandler` and `prepare...FilterObject` utility functions. It conditionally renders `YearViewItem` (grid layout) or `MonthViewItem` (horizontal stack of scrollable monthly cards) and includes a `NoDataAvailable` component. The `NoDataAvailable` text was temporarily `No Data Available123`.
    *   **(10/28/2025, 4:08:24 PM):** A debugging `console.log` statement was added to display `planboardData`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **(10/29/2025, 9:56:31 AM):** This component provides interactive footer elements for analytics metrics, enabling data export and view enlargement. It offers Excel export with a `ColumnsSelector` for user-defined columns, and PDF export using `jspdf` and `html2canvas` to render the chart component into a PDF. Loading states are managed for both export types. It also displays calculated metric values (`calShow`, `calType`, `calValue`) and tooltips for report formulas.
    *   **(10/29/2025, 9:57:53 AM):** A debugging `console.log` statement was added to inspect the `item` prop.

**Timestamps of Significant Changes:**

*   **10/28/2025, 2:02:33 PM:** Introduction of the comprehensive `ViewContainer.jsx` for analytics custom view management.
*   **10/28/2025, 2:04:34 PM:** Initial implementation of `TreeViewContianer.jsx` for displaying metrics.
*   **10/28/2025, 3:35:37 PM:** Detailed configuration of analytics reports and export columns in `analytics.js`.
*   **10/28/2025, 3:37:47 PM:** Refinement of analytics report headers in `analytics.js`, including completion of previously truncated entries.
*   **10/28/2025, 4:05:26 PM:** Implementation of `PlanboardCardView.jsx` for displaying planboard data in different views.
*   **10/29/2025, 9:56:31 AM:** Integration of advanced export functionalities (Excel with column selection, PDF generation) into `MetricFooter.jsx`.

**Patterns and Recurring Elements:**

*   **Debugging Statements:** There's a recurring pattern of adding `console.log` statements in various components (`ViewContainer`, `TreeViewContianer`, `PlanboardCardView`, `MetricFooter`) at different timestamps. This indicates active development, testing, and troubleshooting across these UI features.
*   **Redux/RTK Query Integration:** The application consistently uses Redux (`useSelector`, `useDispatch`) and RTK Query (`useFetch...Query`, `useSave...Mutation`) for state management and API interactions across multiple components (`ViewContainer`, `PlanboardCardView`, `MetricFooter`), highlighting a centralized data flow architecture.
*   **Material-UI (MUI) & Custom Components:** The changes extensively utilize Material-UI components (e.g., `Box`, `Stack`, `Grid`, `Button`, `Checkbox`, `CircularProgress`, `Tooltip`, `Chip`, `TreeItem`, `SimpleTreeView`) along with custom common components (`InputBox`, `ThemeButton`, `OutlinedButton`, `ThemeTabs`, `Loader`, `PopupAlert`, `AuditViewDrawer`, `TMenu`, `ThemedModal`, `ColumnsSelector`). This indicates a consistent design system and component-based development approach.
*   **Analytics Feature Development:** A strong focus is observed on the analytics section, encompassing custom dashboard creation, metric selection, configuration of various reports (CBM, TEU, KGS, Transit, Chassis), and comprehensive data export options.
*   **Rapid Iteration/Commits:** The timestamps for `analytics.js` show very close successive entries (3:35:37 PM, 3:37:47 PM, 3:38:11 PM, 5:49:01 PM), with some content appearing identical between logs. This could imply frequent saves, automated formatting, or quick, iterative adjustments.

## 10:25:15 AM
This log primarily details updates within the `t360-backend`'s analytics module, focusing on dashboard management and report query generation. Significant changes occurred across three main files: `core.view.controller.ts`, `core.metric.controller.ts`, and the query builders `export.query.ts` and `mbls.query.ts`, as well as the central `others.controller.ts`.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file, responsible for managing user-defined analytics dashboards, saw comprehensive updates. It now includes `getAll`, `create`, `update`, and `deleteView` functions, allowing users to manage their dashboard views.
    *   A key addition is the `logAudit` function, which records all dashboard modifications (creation, update, deletion) in an `analytics_view_log` table, capturing user details, action, menu title, and previous/new values.
    *   Dashboard metrics are stored as `ARRAY` in the `dashboards` table.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM)**
    *   This file contains the `bookingQuery` function, which generates dynamic SQL for various booking-related reports (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival").
    *   It supports filtering by month, week, or quarter and categorizing time differences into predefined ranges (e.g., "Less than 1 week", "1 - 2 weeks").
    *   A `getMonthValue` helper function is used to map month names to numerical values.
    *   Notably, the code content remained identical across multiple timestamps, suggesting frequent saves without functional changes or incomplete logs. The SQL query strings consistently appear truncated at the end in the provided log entries.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM)**
    *   This controller manages metrics and their display on dashboards.
    *   `getMetricList` was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and support preloading selected metrics for an existing dashboard.
    *   `dashboardEndPointList` retrieves metrics, their order, and crucially, new `rowSpan` and `columnSpan` properties, indicating added support for customizing metric display sizes.
    *   New functions `saveSequence` and `saveSize` were introduced:
        *   `saveSequence` allows users to reorder metrics on their dashboards.
        *   `saveSize` enables saving custom display dimensions (column and row span) for individual metrics, persisting this layout information in the `dashboards` table's `size` JSONB column.
    *   A minor `console.log` was added for debugging (`10/28/2025, 3:50:57 PM`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps: 10/28/2025, 4:22:21 PM; 10/28/2025, 5:05:54 PM; 10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM; 10/28/2025, 5:12:32 PM; 10/28/2025, 5:12:38 PM; 10/28/2025, 5:15:25 PM; 10/28/2025, 6:07:21 PM; 10/29/2025, 10:22:22 AM)**
    *   This file saw extensive and iterative development for the `mblQueryBuilder`.
    *   Initially (10/28/2025, 4:22:21 PM), it handled 'ContainerShippedMblWise' and 'TotalShipmentsMblWise' by calculating shipment/container counts.
    *   A major refactor (10/28/2025, 5:05:54 PM) changed 'ContainerShippedMblWise' to calculate container counts based on "completed shipments" (identified by delivery dates), grouped by dynamically determined 'Current Quarter' and 'Last Quarter' using complex date logic. The 'TotalShipmentsMblWise' report type was renamed to 'TotalShipments'.
    *   Subsequent changes (10/28/2025, 5:06:57 PM; 10/28/2025, 5:08:14 PM) streamlined the builder, removing the `TotalShipments` report type from its scope.
    *   Refinements continued with the `codeCustomization`, `fromDate`, and `toDate` parameters being adjusted or removed from the `mblQueryBuilder` signature, indicating these parameters are now handled differently or are dynamically generated internally (10/28/2025, 5:12:32 PM; 10/28/2025, 5:15:25 PM; 10/29/2025, 10:22:22 AM).
    *   The dynamic quarter calculation for 'ContainerShippedMblWise' was further refined (10/28/2025, 5:15:25 PM), shifting to a "Last Quarter" and "This Quarter" window based on the current month, and the SQL query was updated to return monthly data within these quarters. The `maxTotal` calculation for percentages was removed as the data output structure changed.
    *   Further changes (10/29/2025, 10:22:22 AM) solidified the quarter logic to target a 3-month window for "This Quarter" (current month-1 to current month+1) and the preceding 3 months for "Last Quarter", and the query now groups by month within quarters.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps: 10/28/2025, 5:09:46 PM; 10/28/2025, 5:12:24 PM; 10/28/2025, 5:14:52 PM; 10/29/2025, 10:23:17 AM)**
    *   This central dispatcher for analytics reports was updated to incorporate the new `mblQueryBuilder`.
    *   A new `else if` block was added to call `mblQueryBuilder` specifically for the `ContainerShippedMblWise` report type, setting `codeCustomization = true`.
    *   Adjustments were made regarding the `codeCustomization` flag in relation to `mblQueryBuilder` calls, indicating a fine-tuning of which reports handle query generation internally vs. relying on a generic execution.
    *   The `fromDate` and `toDate` parameters were commented out in the call to `mblQueryBuilder` (`10/29/2025, 10:23:17 AM`), reflecting the internal date calculation logic now handled by `mbls.query.ts`.

### Timestamps of Significant Changes:

*   **10/28/2025, 1:58:56 PM:** Introduction of full CRUD operations and comprehensive audit logging for analytics dashboards.
*   **10/28/2025, 3:49:50 PM:** Major additions to dashboard metric management, including sorting and the ability to save custom metric display sizes (row/column span).
*   **10/28/2025, 5:05:54 PM:** Significant refactoring of `mblQueryBuilder`, introducing complex dynamic quarter-based calculations for `ContainerShippedMblWise`.
*   **10/28/2025, 5:15:25 PM & 10/29/2025, 10:22:22 AM:** Further iterative development and refinement of the `mblQueryBuilder` for 'ContainerShippedMblWise', specifically enhancing dynamic quarter calculations, adding monthly grouping, and adjusting parameter handling.
*   **10/29/2025, 10:23:17 AM:** Final adjustment in `others.controller.ts` to align `mblQueryBuilder` call with its updated parameter requirements.

### Patterns and Recurring Elements:

*   **Analytics Module Development:** All changes are concentrated within the `analytics` directory, indicating active and ongoing development of reporting and dashboard features.
*   **Dashboard Customization:** There's a clear emphasis on allowing users to customize their dashboards, from selecting metrics and their order to defining their visual layout (size).
*   **Dynamic SQL Query Generation:** The system heavily relies on specialized query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `mblQueryBuilder`) to construct complex SQL queries based on report type and user-specific parameters. This pattern suggests a highly flexible and extensible reporting infrastructure.
*   **Date-Based Reporting:** A recurring need for date and time-based filtering and grouping (by month, week, quarter) is evident across various reports, with specific logic for dynamic date range calculation.
*   **User/Company Context:** Queries consistently use `user_id` and `CompanyName` to filter data, reinforcing a multi-tenant or personalized analytics experience.
*   **Debugging/Logging:** The presence of `logger.info`, `logger.error`, and `console.log` statements suggests active development with a focus on observability and troubleshooting.
*   **Iterative Refinement:** Multiple timestamps for the same file, especially `mbls.query.ts` and `export.query.ts`, indicate an iterative development process, with frequent saves and incremental changes to logic and SQL queries.
*   **SQL String Interpolation:** SQL queries are often built using template literals, which requires careful input sanitization in a production environment to prevent SQL injection vulnerabilities.

## 11:25:07 AM
Changes across these files primarily focus on enhancing and refining the analytics dashboard and reporting functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM):** This file, managing analytics dashboards, introduced a comprehensive `logAudit` function to track user actions (CREATE, UPDATE, DELETE) on dashboards, recording user ID, action, menu title, and both previous and new metric values. The `update` function was modified to capture `previousValue` for auditing, and dashboard creation now includes a check to prevent duplicate views.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM):** This controller saw significant development. The `getMetricList` function was updated to categorize metrics into `Container_Wise` and `MBL_Wise` groups and added a "preload" feature to mark selected metrics for existing dashboards. New functions `dashboardEndPointList` were introduced to fetch ordered dashboard metrics with their display properties (report name, URL, row/column span), and `saveSequence` and `saveSize` functions were added to allow users to customize the order and layout (size) of metrics on their dashboards, including special handling for "Default" dashboards. A minor debug `console.log` was added in a subsequent commit.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM):** This file defines SQL query templates for various booking-related reports. A notable change was the addition of a "Booking Date to POD Arrival (Stacked Bar)" query, which includes a filter for `t49_vessel_actualdeparted_date`. Multiple log entries for this file show virtually identical code content, suggesting minor non-functional updates or repeated saves without substantive changes in the provided snippets. The `bookingQuery` function dynamically constructs queries based on report name, company, and display settings (month, week, quarter).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps ranging from 10/28/2025, 4:22:21 PM to 10/29/2025, 10:44:49 AM):** This file, responsible for MBL-related queries, underwent several iterations. Initially, it included basic `ContainerShippedMblWise` and `TotalShipmentsMblWise` types calculating counts. Later, the `ContainerShippedMblWise` report was significantly refactored (around 10/28, 5:05:54 PM) to query for *completed shipments* and dynamically group container counts by "Current Quarter" and "Last Quarter" based on real-time dates. The `customizer.selectedColumns` `must` list was expanded to include many tracking data fields. Further refinements (around 10/29, 10:22:22 AM to 10/29, 10:44:49 AM) changed the quarter calculation logic to cover an "8-month window" (last 4 months + this 4 months) and group results by `quarter` and `month`, with `customizer.calType` also being temporarily set to "avg" before being removed again. The `fromDate` and `toDate` parameters were removed from the `mblQueryBuilder` signature, as the quarter calculation became internal.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps ranging from 10/28/2025, 5:09:46 PM to 10/29/2025, 11:23:55 AM):** This controller acts as the central dispatcher for analytics reports. It was updated to integrate the `mblQueryBuilder` for the `ContainerShippedMblWise` report type, marking it for `codeCustomization`. Throughout its changes, there were adjustments and re-additions of the `codeCustomization` flag when calling `mblQueryBuilder`, and parameter `fromDate`/`toDate` were removed from the `mblQueryBuilder` call, aligning with `mbls.query.ts`'s internal date handling. An attempt to set `customizer.chartType = "StackedBar";` for `ContainerShippedMblWise` in this file was later reverted, indicating the logic for `customizer` properties belongs within the individual query builders.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** All modifications are concentrated within the `analytics` domain, indicating active development of dashboard and reporting features.
*   **Database Interaction:** A `query` function (likely a database utility) is extensively used for data retrieval and manipulation across multiple files.
*   **User Contextualization:** Report generation and dashboard management consistently utilize `req.user` to fetch user-specific details (`usercode`, `companyname`) for personalized data access and filtering.
*   **Dynamic Query Generation:** SQL queries are frequently constructed dynamically using string interpolation and conditional logic based on various input parameters (e.g., report type, display options, date ranges).
*   **Date Filtering and Grouping:** There's a strong emphasis on date-based operations, including filtering by `fromDate` and `toDate`, extracting day differences (`EXTRACT(DAY FROM ...) `), and grouping by time periods (`DATE_TRUNC`, `TO_CHAR` for months/quarters). A recurring pattern in SQL WHERE clauses is to filter out invalid date values like `'0001-01-01 00:00:00 BC'`.
*   **Modular Query Builders:** The architecture leverages separate query builder files (`chassis.query`, `booking.query`, `container.query`, `departure.query`, `general.query`, `mbls.query`) to encapsulate the logic for different report types.
*   **`codeCustomization` Flag:** A `codeCustomization` flag is used to differentiate between reports where the controller executes a generated SQL query and those where the query builder itself processes data or returns a pre-processed result.
*   **Error Handling:** `try...catch` blocks are consistently used to wrap asynchronous operations, providing standard error responses.

## 11:25:18 AM
The changes logged primarily focus on frontend development within an analytics and planboard section of a React application, `t360-frontend`. The updates involve enhancing custom view functionality, refining metric visualization and export options, and general debugging.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Initial Update (10/28/2025, 2:02:33 PM):** This file received a significant update, establishing a `ViewContainer` component for creating, editing, and deleting custom analytics dashboards. It integrates with Redux for state management, fetches dashboard options, and saves/deletes user-defined dashboards via mutations. Key features include checkbox management for selecting metrics (limited to 9), input for dashboard naming, handling save/delete operations with toast notifications, and auditing functionality using an `AuditViewDrawer`. The component uses `ThemeTabs` to switch between "Container Wise" and "MBL Wise1" data views. An API key is used for data fetching and saving.
    *   **Debugging Console Logs (10/28/2025, 3:48:07 PM & 10/28/2025, 5:53:50 PM):** Minor changes were made to add `console.log` statements for debugging `viewOptions` and `viewName`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Initial Update (10/28/2025, 2:04:34 PM):** This component renders a tree-like structure (`SimpleTreeView` from `@mui/x-tree-view`) to display selectable analytics metrics. It takes `data`, `handleCheckBoxClicked`, and `checkBoxManager` as props to render grouped metrics with checkboxes.
    *   **Temporary Text Change & Revert (10/28/2025, 3:46:33 PM & 10/28/2025, 3:46:51 PM):** A temporary debugging change added "kk" to a metric name's label, which was immediately reverted.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Initial Extensive Definitions (10/28/2025, 3:35:37 PM):** This configuration file was updated with extensive definitions for analytics reports. It includes `DEFAULT_ANALYTICS_ENDPOINTS` for various CBM and TEU reports, `EXCEL_EXPORT_COLUMNS` for detailed data export, `CargoReadyToETD10Days` for specific reporting, and `ANALYTICS_REPORT_HEADER` which maps report names to their respective display headers for different data types (CBM, TEU, KGS, Transit, Chassis) and views (Container Wise, MBL Wise). The entry for "Container by Ocean Freight Carrier (SCAC)" was initially incomplete.
    *   **Completion of Report Header (10/28/2025, 3:37:47 PM):** The incomplete entry in `ANALYTICS_REPORT_HEADER` was corrected and a new entry "Container by Port of Loading" was added.
    *   **Subsequent Saves (10/28/2025, 3:38:11 PM, 10/28/2025, 5:49:01 PM, 10/29/2025, 11:09:14 AM, 10/29/2025, 11:17:33 AM):** Multiple saves of this file occurred without any further functional code changes, indicating perhaps continuous development in other areas or incidental saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Initial Update (10/28/2025, 4:05:26 PM):** This component handles the display of planboard items in either a yearly or monthly card view. It fetches planboard data, processes it through filter functions (`prepareYearlyFilterObject`, `prepareMonthlyFilterObject`, `filterHandler`), and renders `PlanBoardCardItems`. It includes `NoDataAvailable` component for empty states, which initially had a placeholder text "No Data Available123".
    *   **Debugging Console Log (10/28/2025, 4:08:24 PM):** A `console.log` statement for `planboardData` was added for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Initial Update (10/29/2025, 9:56:31 AM):** This component provides footer actions for analytics metrics, including displaying calculation chips, a tooltip for report formulas, and buttons for Excel and PDF export. The Excel button label was temporarily "Excel1". It handles loading states for exports, column selection for Excel, and full-screen view. PDF generation involves dynamically rendering a `PdfRenderer` component, capturing it with `html2canvas`, and creating a PDF using `jspdf`.
    *   **Debugging Console Log (10/29/2025, 9:57:53 AM):** A `console.log` statement for `item` was added to aid in debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Initial Update (10/29/2025, 10:54:57 AM):** This component serves as a toolbar for analytics metrics, providing options for chart view, period, and date range filtering. It dispatches Redux actions to update filters and triggers `fetchSingleReport` when filters change. The "Period" label was temporarily set to "Period1".
    *   **Label Correction (10/29/2025, 10:55:11 AM):** The "Period1" label was corrected back to "Period".
    *   **Repeated Commenting/Uncommenting & Debugging (10/29/2025, 10:58:17 AM - 10/29/2025, 11:02:26 AM):** A series of rapid changes occurred, involving commenting out and uncommenting various filter components (`PopoverPanel` for custom date range, "Period" `SelectBoxLight`, "View By" `SelectBoxLight`, "Filter" `SelectBoxLight`, and `SwitchBox`) and adding/removing temporary debugging HTML elements (`<`, `<h1>hhhhh</h1>`). This indicates intense, localized debugging and testing of the toolbar's filtering and display functionalities.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Initial Update (10/29/2025, 11:02:52 AM):** This component is responsible for rendering individual analytics metric boxes, including the `MetricToolbar`, various chart types (`PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`), and `MetricFooter`. It manages the chart view state and provides a full-screen modal for enlarged chart views.
    *   **Toolbar Commenting/Uncommenting (10/29/2025, 11:03:15 AM & 10/29/2025, 11:03:25 AM):** The `MetricToolbar` in the main render block was temporarily commented out and then restored, likely for testing purposes.
    *   **Debugging Console Log (10/29/2025, 11:04:05 AM):** A `console.log` for `item` was added, along with a minor refactor in how `getChartComponent` is called within the main render, though functionally identical to its previous state.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Initial Update (10/29/2025, 11:18:07 AM):** This file contains utility functions for analytics. It includes `TruncateText`, `metricsPackageHandler` (for formatting metric data, determining chart types, and calculating aggregate values), `allChartOptions` (chart type definitions), `chartOptionsByType` (mapping chart types to available views), `reportFormula` (generating formula strings), `weekDateFormater`, and `downloadReportSpreadsheet`. The `downloadReportSpreadsheet` function is notably complex, preparing data for Excel export with specific logic for different chart types, period filters, and report names. The provided code for `downloadReportSpreadsheet` is truncated, ending mid-statement.

**Patterns and Recurring Elements:**

*   **Active Debugging:** A prominent pattern is the frequent addition/removal of `console.log` statements, temporary text modifications (e.g., "MBL Wise1", "Excel1", "Period1", "No Data Available123"), and extensive commenting/uncommenting of UI blocks. This suggests that the developer was actively debugging and testing various frontend components and features, particularly within the analytics section.
*   **Redux for State Management:** All significant React components (`ViewContainer`, `MetricFooter`, `MetricToolbar`, `MetricsBox`, `PlanboardCardView`) extensively use `useSelector` and `useDispatch` from `react-redux`, indicating a centralized and predictable state management architecture.
*   **Analytics-focused Development:** A large portion of the changes revolves around the analytics dashboard: custom view creation, metric selection, chart rendering, and report generation (Excel/PDF).
*   **UI Component Reusability:** Custom components like `InputBox`, `Button`, `ThemeTabs`, `SelectBoxLight`, `PopoverPanel`, `ThemedModal`, and `Loader` are imported and used across different files, highlighting a component-based design approach.
*   **API Integration:** API calls for fetching and saving dashboard options are consistently made using a specific `apiKey`, suggesting a secure and structured way to interact with backend services.

## 12:25:09 PM
The changes log details updates across several files related to an analytics backend, focusing on dashboard management and report generation.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file handles core dashboard view operations: `getAll`, `create`, `update`, and `deleteView`.
    *   A significant addition is the `logAudit` function, which is now invoked for every create, update, and delete operation on dashboards. This function records details like `userId`, `action` (CREATE, UPDATE, DELETE), `menuTitle`, `previousValue`, `newValue`, and `user` into an `analytics_view_log` table, indicating enhanced auditing capabilities for user actions on dashboards.
    *   Dashboard creation checks for existing views and returns an error if a view with the same `user_id` and `menu_title` already exists.
    *   Update operations now retrieve `dashboard_metrics` before updating to capture `previousValue` for auditing.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM)**
    *   This file defines SQL query snippets for various "Booking Date to..." reports, including regular and "Stacked Bar" variations, with both container-wise and MBL-wise aggregations.
    *   The `bookingQuery` function dynamically constructs SQL based on `reportName` and parameters like `CompanyName`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, `stackedExport`, and `displayBy`.
    *   A helper function `getMonthValue` is included to convert abbreviated month names to numeric values for SQL queries.
    *   Across multiple timestamps, the code for this file remains largely identical, suggesting minor re-saves, formatting, or negligible changes. The primary function is to provide structured SQL for export reports.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM)**
    *   Manages analytics metrics for dashboards, including fetching, ordering, and resizing.
    *   `getMetricList`: Fetches all metrics, categorizes them by `filter_by` ('Container_Wise' or 'MBL_Wise'), and groups them by `group`. It supports a `preload` feature to mark metrics as `checked` if they are part of a specified `dashboard_name`. A `console.log` statement was temporarily added for debugging (`===jhjkkk`).
    *   `dashboardEndPointList`: Retrieves and sorts report endpoints based on a user's saved `dashboard_metrics` order for a given `menuTitle`. It also retrieves `size` information (rowSpan, columnSpan) for each metric from the `dashboards` table.
    *   `saveSequence`: Allows users to define and save the display order of metrics for a dashboard. It handles a special case for a 'Default' dashboard, creating it if it doesn't exist.
    *   `saveSize`: A new endpoint was added to save the `columnSpan` and `rowSpan` properties for individual metrics within a dashboard, storing this layout information in the `dashboards` table's `size` JSONB column.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Multiple timestamps from 10/28/2025, 4:22:21 PM to 10/29/2025, 12:17:47 PM)**
    *   This file, particularly the `mblQueryBuilder` function, saw significant iterative development.
    *   **Initial (10/28, 4:22 PM):** Handled `ContainerShippedMblWise` and `TotalShipmentsMblWise` with simple aggregation queries.
    *   **Major Refactoring (10/28, 5:05 PM onwards):**
        *   The `ContainerShippedMblWise` report was completely re-architected to analyze container counts across "Current Quarter" and "Last Quarter" based on `deliverd_date`.
        *   Introduced dynamic calculation of quarter start and end dates within the code, making the query self-contained for date ranges.
        *   The query now uses a Common Table Expression (CTE) `completed_shipments` to standardize `deliverd_date` calculation before grouping by quarter and month.
        *   Output formatting changed to include `quarter`, `month` (e.g., 'Mon'), and `container_count`.
    *   **Refinements (10/29):**
        *   The logic for defining "This Quarter" and "Last Quarter" date ranges was updated multiple times. Initially calculating based on a 3-month quarter, it evolved to define a "Last 4 months + This 4 months" window, providing more granular monthly data within these quarters.
        *   `customizer.calType` was briefly set to "avg" then removed, and `customizer.dateColumns` was added and refined to reflect the chart's axes, changing from `['This Quarter', 'Last Quarter']` to `['TEU', 'Month']` and finally `['Month', 'TEU']`.
        *   The `codeCustomization` flag in the interface/parameters was gradually simplified/removed as the builder became fully responsible for constructing the analytics data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Multiple timestamps from 10/28/2025, 5:09:46 PM to 10/29/2025, 11:23:55 AM)**
    *   This controller acts as a central dispatcher for analytics reports.
    *   It imports and calls various `QueryBuilder` functions (chassis, booking, departure, container, general, mbl) based on the `type` parameter in the request.
    *   For the `ContainerShippedMblWise` type, it was updated to call the `mblQueryBuilder`. Notably, `codeCustomization` is set to `true` when calling `generalQueryBuilder` and `mblQueryBuilder`, indicating these builders generate the full analytical data object, not just a SQL string for the main `query` function.
    *   In later updates, `fromDate` and `toDate` parameters were commented out when calling `mblQueryBuilder`, aligning with the changes in `mbls.query.ts` where date range calculation became internal to that builder. A temporary `customizer.chartType = "StackedBar";` was briefly inserted and then removed.

**Patterns and Recurring Elements:**

*   **Analytics Domain:** All changes are deeply embedded in the analytics domain, focusing on tracking, reporting, and dashboard customization.
*   **Database-Centric Operations:** The codebase heavily relies on direct SQL queries (`query` function) for data retrieval and manipulation, indicating a direct interaction with a PostgreSQL-like database.
*   **User Context and Personalization:** User-specific data (`user_id`, `user.usercode`, `CompanyName`) is consistently used to scope queries and dashboard views, suggesting personalized analytics. Dashboard definitions, metric order, and metric sizes are tied to individual users.
*   **Dynamic Query Generation:** Several query builder files (`export.query.ts`, `mbls.query.ts`) programmatically construct complex SQL queries based on request parameters and report types.
*   **Iterative Development & Refinement:** The frequent and sometimes minor consecutive commits, especially for `mbls.query.ts`, point to active development, feature refinement, and potentially bug fixing or optimization cycles. The evolution of quarter calculation logic and `customizer` properties illustrates this.
*   **Robust Error Handling:** `try...catch` blocks are consistently used across controllers and query builders, ensuring that internal server errors are caught and communicated gracefully to the client.
*   **Clear Separation of Concerns:** Logic is generally organized into controllers (handling requests/responses) and query builders (handling specific report logic and SQL generation).

## 12:25:27 PM
The log details recent changes primarily focused on enhancing the analytics section of the T360 frontend application, with minor updates to the planboard view.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Timestamp:** October 28, 2025, 2:02:33 PM, 3:48:07 PM, 5:53:50 PM.
    *   **Key Changes:** Introduced comprehensive functionality for managing custom analytics views. Users can now create, save, update, and delete custom dashboards. The component includes state management for checkbox selections (`checkBoxManager`, `numChecked`), enforcing a maximum of 9 metrics per view. It integrates with Redux (`useSelector`, `useDispatch`) to manage analytics state and trigger data refetches. Error handling with `react-hot-toast` for missing view names or no selected metrics is in place. Audit functionality, including a `PopupAlert` for deletions and an `AuditViewDrawer` for viewing audit logs, was added. Debug `console.log` statements were added at 3:48:07 PM and 5:53:50 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Timestamp:** October 28, 2025, 2:04:34 PM, 3:46:33 PM, 3:46:51 PM.
    *   **Key Changes:** This component was developed to display hierarchical data for metric selection using MUI's `SimpleTreeView` and `TreeItem`. Each metric is associated with a `Checkbox` that interacts with the `ViewContainer`'s `checkBoxManager`. Styles were applied for scrollable content. Minor debugging changes involved adding and then reverting "kk" to a label at 3:46:33 PM and 3:46:51 PM, alongside a `console.log`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Timestamp:** October 28, 2025, 3:35:37 PM, 3:37:47 PM. Subsequent timestamps (5:49:01 PM, 11:09:14 AM, 11:17:33 AM, 11:53:55 AM, 11:54:19 AM, 11:55:32 AM, 11:56:24 AM on October 29) show identical code content, suggesting multiple saves without functional changes.
    *   **Key Changes:** The `ANALYTICS_REPORT_HEADER` constant, which maps report names to their display columns, was significantly expanded. New categories like "Container Wise KGS", "MBL Wise KGS", "Container Wise Transit", "MBL Wise Transit", and "Chassis MBL Wise" were added with their respective column definitions. A specific entry, "Containers Shipped ", was removed at 3:37:47 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Timestamp:** October 28, 2025, 4:05:26 PM, 4:08:24 PM.
    *   **Key Changes:** A debugging change involved adding "123" to the "No Data Available" `Typography` component's text. A `console.log` for `planboardData` was also introduced at 4:05:26 PM. The subsequent timestamp shows identical content.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Timestamp:** October 29, 2025, 9:56:31 AM, 9:57:53 AM.
    *   **Key Changes:** Introduced functionality for exporting report data. Buttons for "Excel" and "PDF" export were added, conditionally displayed based on data availability. Excel export now includes a `ColumnsSelector` modal to allow users to choose which columns to export. PDF export utilizes `jspdf` and `html2canvas` to render the chart component into a PDF. Loading states for both exports (`loading`, `pdfLoading`) were implemented. A `console.log` for `item` was added at 9:57:53 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Timestamp:** October 29, 2025, from 10:54:57 AM to 11:02:26 AM.
    *   **Key Changes:** This file saw frequent, minor, and often transient changes, primarily involving commenting out and uncommenting various filter components (`SelectBoxLight` for "Period", "View By", "Filter", and `PopoverPanel` for `DateRange`) and the `SwitchBox` component. A temporary `<h1>hhhhh</h1>` tag was added and removed at 11:00:16 AM and 11:00:25 AM, respectively. These rapid changes suggest active debugging and UI layout experimentation. Ultimately, by 11:02:26 AM, all previously commented-out filter components and the `SwitchBox` were restored.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** October 29, 2025, 11:02:52 AM, 11:03:15 AM, 11:03:25 AM, 11:04:05 AM, 11:20:37 AM.
    *   **Key Changes:** This component handles the rendering of various chart types (Bar, Pie, Line, Stacked Bar, Gauge) and their associated toolbars and footers. It was updated to dynamically render charts based on `chartType` and `chartView`. A `ThemedModal` was integrated for a full-screen chart view. The `MetricToolbar` was temporarily commented out and restored in the main render at 11:03:15 AM and 11:03:25 AM. At 11:20:37 AM, the main chart component (`chartComponent`) was explicitly configured to display only the first 9 data points, while the full data is used for the enlarged view. Debug `console.log` statements were added at 11:02:52 AM and 11:20:37 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Timestamp:** October 29, 2025, 11:18:07 AM, 11:25:01 AM.
    *   **Key Changes:** Significant refactoring of analytics utility methods. The `metricsPackageHandler` function was updated to refine how chart types are determined (`findChartType`) and how calculation types (e.g., Average, Total) and their display (`getCal`) are handled, specifically excluding `StackBar` and `Transit` charts from displaying 'Avg'. A `formatHandler` was introduced for dynamic formatting based on data type. The `downloadReportSpreadsheet` function received major updates to support `selectedColumns` for Excel export and intricate logic to format report headers and data based on `periodFilter` and `chartType`, especially for stacked bar and transit charts. A minor correction in `findChartType` was made at 11:25:01 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **Timestamp:** October 29, 2025, 11:45:45 AM, 11:46:15 AM, 12:13:49 PM, 12:16:08 PM.
    *   **Key Changes:** This component underwent several iterations of development. Initially (11:45:45 AM), it was set up for basic stacked bar rendering with dynamic categories, tooltip formatting, and animation control. At 11:46:15 AM, `plotOptions.bar.bar: { distributed: false }` was added, tooltip styles were changed, and `dataLabels.offsetX` was adjusted, while explicit colors were temporarily removed from state options. A major refactor at 12:13:49 PM introduced `prepareStackedData` for explicit handling of "This Quarter" vs "Last Quarter" data, leading to a more structured way of forming series for quarter-based comparisons, and restoring the specific colors for these quarters. The final update at 12:16:08 PM generalized this by introducing `isQuarterData` for "smart detection" of quarter-based data, allowing the chart to dynamically adapt its series generation and color palette based on the data content, using a default palette otherwise.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** The vast majority of changes are centered on enhancing and debugging the analytics functionality, including custom view creation, report generation, chart rendering, and data filtering.
*   **Debugging Practices:** Frequent use of `console.log` statements with distinct identifiers (e.g., "===jhhjkk", "===tree") and temporary UI element commenting/uncommenting indicates an active and iterative debugging process across multiple components.
*   **UI/UX Enhancements:** Introduction of modals for column selection (Excel export) and full-screen chart views, along with dynamic chart rendering capabilities, points to ongoing improvements in user interface and experience.
*   **Redux for State Management:** Consistent use of `useSelector` and `useDispatch` highlights a strong reliance on Redux for managing application state, particularly for analytics filters and data.
*   **API Integration:** Components frequently interact with API queries (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`) to fetch and save user-defined analytics configurations.
*   **Hardcoded Values:** The `apiKey: "nRKniUrJd6rjNCyvT8iRRHmG"` is hardcoded in `ViewContainer.jsx` for API requests.
*   **Date Handling:** The `moment.js` library is used for formatting dates in reports and chart labels.
*   **MUI Component Usage:** Material-UI components are extensively used for building the user interface, ensuring a consistent design.

## 1:25:21 PM
The logged changes across the `t360-frontend` repository primarily focus on enhancing the analytics and planboard sections. This includes improvements to custom dashboard views, dynamic chart rendering, and report generation functionalities. A recurring pattern observed is the frequent use and subsequent removal or commenting out of `console.log` statements, indicating active debugging and development cycles. Many components also underwent rapid toggling (commenting/uncommenting) of UI elements and logic, especially within the analytics toolbar, suggesting iterative development and testing.

**File-Specific Updates:**

*   **`ViewContainer.jsx`**: This component, responsible for managing custom analytics dashboards (creating, editing, deleting), received several debugging `console.log` additions to track `viewOptions` and `viewName` on October 28, 2025. It also includes a hardcoded API key for `useFetchDashboardOptionsQuery` and `useSaveDasboardMutation`.
*   **`TreeViewContianer.jsx`**: This component, which renders a tree-like structure for selecting metrics in custom views, saw a brief, temporary string `kk` added to a label and then immediately removed on October 28, 2025, likely for quick UI testing.
*   **`analytics.js`**: On October 28, 2025, the `ANALYTICS_REPORT_HEADER` object was updated to complete an existing entry (`"Container by Ocean Freight Carrier (SCAC)"`) and add a new one (`"Container by Port of Loading"`). Subsequent timestamps for this file on October 29, 2025, show no functional changes, suggesting repetitive save operations.
*   **`PlanboardCardView.jsx`**: A debugging `console.log` for `planboardData` was added to this component on October 28, 2025. The component also displays a "No Data Available123" message when no data is present.
*   **`MetricFooter.jsx`**: On October 29, 2025, the footer component gained a "Select Columns" modal for more controlled Excel exports. A debugging `console.log` was added, and the Excel button label was temporarily set to "Excel1".
*   **`MetricToolbar.jsx`**: This component experienced rapid and extensive changes on October 29, 2025, between 10:54 AM and 11:02 AM. This included adding/removing debugging statements, temporarily changing a label to "Period1", and repeatedly commenting out and uncommenting various filter elements (custom date range `PopoverPanel`, "Period" filter, "View By" filter, and the main "Filter" select box). This indicates intensive debugging and feature adjustments.
*   **`MetricsBox.jsx`**: Also on October 29, 2025, this component (which wraps individual analytics metrics) saw `MetricToolbar` being temporarily commented out and then restored, both in the main render and within the full-screen modal. A key functional change involved explicitly slicing chart data to a maximum of 9 items for non-enlarged views. A debugging `console.log` for item data was also added.
*   **`methods.js`**: The `findChartType` function was updated on October 29, 2025, to remove a specific condition that would force a "StackedBar" type for "Containers Shipped (Mbl Wise)" reports, making it default to `AnalyticsChartType.General`. The Excel export logic for `transitBar` charts has an incomplete code block.
*   **`StackedBarChart.jsx`**: This chart component underwent significant refactoring on October 29, 2025, from 11:45 AM to 12:16 PM. The changes involved evolving the data preparation and series generation logic to intelligently handle both specific "This Quarter" / "Last Quarter" data structures and more general stacked metric data, including conditional color palettes and `stackType` settings.

**Timestamps of Significant Changes:**

*   **October 28, 2025 (afternoon):** Initial setup of custom view components (`ViewContainer.jsx`, `TreeViewContianer.jsx`), expansion of analytics report headers (`analytics.js`), and a debugging addition to `PlanboardCardView.jsx`.
*   **October 29, 2025 (morning, particularly 9:56 AM - 12:16 PM):** A period of intense development and debugging activity within the analytics features. This includes the introduction of export column selection (`MetricFooter.jsx`), rapid iteration and testing of filter controls (`MetricToolbar.jsx`), data handling adjustments in `MetricsBox.jsx`, and a substantial refactoring of the `StackedBarChart.jsx` component to handle diverse data inputs.

**Patterns or Recurring Elements:**

*   **Debugging statements:** The frequent addition and removal or commenting of `console.log` statements in various files suggests a development process that heavily relies on in-code logging for troubleshooting.
*   **Iterative UI/Logic refinement:** The repeated commenting/uncommenting of code blocks, particularly in `MetricToolbar.jsx` and `MetricsBox.jsx`, points to a rapid, iterative process of testing and adjusting UI elements and their associated functionalities.
*   **Analytics Feature Development:** A strong focus on improving the analytics dashboard's functionality, from custom view management to chart rendering and export options.
*   **Conditional data visualization:** The `StackedBarChart.jsx` component's evolution indicates a move towards making chart components more adaptable to different data structures and reporting needs.

## 1:25:30 PM
The provided log details changes primarily within the analytics module of the `t360-backend` application, focusing on dashboard management and report generation.

**File-Specific Updates and Timestamps:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts`**
    *   **10/28/2025, 1:58:56 PM:** This file defines the core API for managing user-specific dashboards. It includes functions for:
        *   `getAll`: Retrieving a user's saved dashboards (menu titles).
        *   `create`: Creating a new dashboard with a name and associated metrics, including a check for existing view names and an audit log entry.
        *   `update`: Modifying an existing dashboard's name and metrics, also with an audit log entry that records previous and new metric values.
        *   `deleteView`: Removing a dashboard, again with an audit log.
        *   A `logAudit` helper function is used internally to record these dashboard management actions.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts`**
    *   **10/28/2025, 3:49:50 PM:** Introduces functionalities related to analytics metrics:
        *   `getMetricList`: Fetches all available metrics, categorizing them into 'Container_Wise' and 'MBL_Wise' groups. It supports a 'preload' feature to mark metrics already selected for a specific dashboard.
        *   `dashboardEndPointList`: Retrieves the endpoints for metrics associated with a given dashboard, sorted by a user-defined order and including `rowSpan` and `columnSpan` for display sizing.
        *   `saveSequence`: Allows users to define and save the display order of metrics within a dashboard. Special handling is included for a 'Default' dashboard.
        *   `saveSize`: Stores custom `columnSpan` and `rowSpan` values for individual metrics within a dashboard.
    *   **10/28/2025, 3:50:57 PM:** A minor change was introduced to `getMetricList` by adding a `console.log` statement for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts`**
    *   **10/28/2025, 3:38:52 PM - 10/29/2025, 10:10:01 AM:** This file remained largely consistent across multiple timestamps, primarily defining the `bookingQuery` function. This function dynamically generates complex SQL queries for various "Booking Date to X" reports, including "Actual Departure", "Estimated Departure", and "POD Arrival", with options for MBL-wise and stacked bar visualizations. The stacked bar logic incorporates date filtering by month, week, or quarter and categorizes differences (e.g., `day_diff`) into time buckets like "Less than 1 week", "1 - 2 weeks", etc. A `getMonthValue` helper translates month names to numbers.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts`**
    *   **10/28/2025, 4:22:21 PM:** Initial version of `mblQueryBuilder` handling `ContainerShippedMblWise` and `TotalShipmentsMblWise` reports, calculating shipment and container/MBL counts.
    *   **10/28/2025, 5:05:54 PM:** Major refactoring. `ContainerShippedMblWise` was redefined to calculate container counts for "completed shipments" categorized by "Current Quarter" and "Last Quarter" based on dynamic date ranges, using a `WITH` clause for `completed_shipments`. The original `ContainerShippedMblWise` logic was seemingly moved/renamed to `TotalShipments`.
    *   **10/28/2025, 5:06:57 PM:** Minor adjustment to `must` columns for the `TotalShipments` report type's `customizer.selectedColumns`.
    *   **10/28/2025, 5:08:14 PM:** Reverted, focusing `mblQueryBuilder` back exclusively on `ContainerShippedMblWise` with the complex quarter-based logic. The `codeCustomization` parameter was removed from the function signature and destructured parameters.
    *   **10/28/2025, 5:12:32 PM - 5:12:38 PM:** The `codeCustomization = true;` line within `ContainerShippedMblWise` logic was commented out.
    *   **10/28/2025, 5:15:25 PM:** `mblQueryBuilder`'s function signature was updated for explicit typing. `fromDate` and `toDate` were made optional. The quarter calculation logic was refined with a `fmt` helper, and the post-query data mapping was adjusted to include percentage calculations after determining `maxTotal`.
    *   **10/28/2025, 6:07:21 PM:** No functional changes.
    *   **10/29/2025, 10:22:22 AM:** The quarter calculation logic was further refined to define "This Quarter" and "Last Quarter" each spanning *four months*, with the SQL query updated to group results by month within these quarters. The result mapping was simplified, omitting `maxTotal` and `percentage` calculation at this stage.
    *   **10/29/2025, 10:35:41 AM:** The 8-month window calculation was explicitly defined (last 4 months for "This Quarter", previous 4 for "Last Quarter"). `TO_CHAR(deliverd_date, 'Mon')` was introduced for shorter month names, and ordering by `DATE_TRUNC('month', deliverd_date)` was added.
    *   **10/29/2025, 10:43:50 AM - 10:44:49 AM:** Added `customizer.calType = "avg";` in `ContainerShippedMblWise` logic to configure how `customizer` processes the data.
    *   **10/29/2025, 11:37:34 AM:** Set `customizer.dateColumns = ['This Quarter', 'Last Quarter']` within the `ContainerShippedMblWise` logic.
    *   **10/29/2025, 11:38:49 AM:** Changed `customizer.dateColumns` to `['TEU', 'Month']`.
    *   **10/29/2025, 12:17:47 PM:** Changed `customizer.dateColumns` again to `['Month', 'TEU']`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`**
    *   **10/28/2025, 5:09:46 PM:** This file functions as a central dispatcher (`getTableDataReports`) for various analytics reports, calling different query builder functions (chassis, booking, container, departure, general, mbls) based on the `type` parameter. It introduced a `codeCustomization` flag to determine if the query builder directly returns data or if a generic `query(mainQuery)` call is needed. `ContainerShippedMblWise` was explicitly handled by `mblQueryBuilder` with `codeCustomization` set to true.
    *   **10/28/2025, 5:12:24 PM:** Removed the explicit `codeCustomization = true;` setting before calling `mblQueryBuilder`.
    *   **10/28/2025, 5:14:52 PM:** Re-added the explicit `codeCustomization = true;` setting before calling `mblQueryBuilder`.
    *   **10/29/2025, 10:23:17 AM:** Modified the call to `mblQueryBuilder` by commenting out `fromDate` and `toDate` arguments, reflecting the internal date calculation changes in `mbls.query.ts`.
    *   **10/29/2025, 11:23:41 AM:** An erroneous line `customizer.chartType = "StackedBar";` was temporarily added directly in this controller before calling `mblQueryBuilder`.
    *   **10/29/2025, 11:23:55 AM:** The erroneous `customizer.chartType` assignment was removed.
    *   **10/29/2025, 1:14:39 PM:** Significantly re-routed `ContainerShippedMblWise`: it was moved from its dedicated `else if` block to be handled by `bookingQueryBuilder` alongside other booking-related reports. A redundant `else if` block for `ContainerShippedMblWise` was still present below.
    *   **10/29/2025, 1:17:31 PM:** The redundant `else if (type === 'ContainerShippedMblWise')` block was commented out, solidifying the change to route this report type through `bookingQueryBuilder`.

**Patterns and Recurring Elements:**

1.  **Analytics Focus:** All changes are consistently related to building and serving analytics reports and managing user dashboards.
2.  **Date-Centric Logic:** Many reports heavily rely on date calculations, date range filtering, and date-based aggregations (e.g., `EXTRACT(DAY FROM...)`, `DATE_TRUNC`, dynamic quarter/month calculations). The `mbls.query.ts` file shows a clear evolution in its date handling, shifting from simple `fromDate`/`toDate` to sophisticated dynamic quarter definitions.
3.  **Database Interaction:** Extensive use of raw PostgreSQL queries (via a `query` helper) is central to all data retrieval. Queries are dynamically constructed based on user input and report type.
4.  **`customizer` Object:** A `customizer` object is frequently passed around and mutated by query builder functions to convey metadata about the report, such as date columns, calculation types (`avg`, `total`), and chart types (`StackedBar`).
5.  **Report Dispatcher:** The `others.controller.ts` acts as a dispatcher for various report types, using a long `if/else if` chain to delegate to specialized query builder functions.
6.  **`getColumnsByCategory` Utility:** This utility function is consistently used to dynamically select relevant columns for reports, often specifying columns to ignore or include.
7.  **Audit Logging:** The `core.view.controller.ts` explicitly implements audit logging for dashboard creation, updates, and deletions.
8.  **Error Handling:** `try...catch` blocks are consistently used to handle potential errors and return 500 status codes.
9.  **Refactoring and Evolution:** The log shows a clear iterative development process, with functions like `mblQueryBuilder` undergoing significant refactoring (e.g., date logic, removal of parameters) and reports being re-routed between different query builders (e.g., `ContainerShippedMblWise` moving from `mblQueryBuilder` to `bookingQueryBuilder`).
10. **Stacked Bar Charts:** Specific logic for stacked bar charts is present in `export.query.ts` and `mbls.query.ts`, categorizing data into time-based bins (e.g., "Less than 1 week", "This Quarter", "Last Quarter").

## 2:32:50 PM
`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx` (multiple timestamps: 10/28/2025, 2:02:33 PM; 10/28/2025, 3:48:07 PM; 10/28/2025, 5:53:50 PM):
This React component manages the creation, editing, and deletion of custom analytic views. It uses Material-UI for its interface (Box, Stack, InputBox, Buttons, Tabs). Redux (Redux Toolkit's `useSelector`, `useDispatch`, `useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`) is heavily used for state management, fetching data, and saving/deleting dashboards. Key features include:
- State management for `checkBoxManager` (selected metrics), `viewName`, `numChecked` (number of selected metrics), `alertConfig` for pop-up alerts, and `modal` for drawers.
- Fetching dashboard options based on user ID, company name, and view title.
- Handling checkbox clicks with a limit of 9 metrics and showing a toast error if exceeded.
- Save functionality for new (`POST`) and edited (`PUT`) dashboards, with success/error toasts and Redux state updates (`setRefetchAll`, `setDashboard`).
- Delete functionality with a confirmation `PopupAlert`.
- Integration with `AuditViewDrawer` for audit logs.
- Renders `TreeViewContianer` to display container-wise and MBL-wise metrics for selection.
- Minor changes included adding `console.log` statements for debugging `viewOptions` and `viewName`.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx` (multiple timestamps: 10/28/2025, 2:04:34 PM; 10/28/2025, 3:46:33 PM; 10/28/2025, 3:46:51 PM):
This component displays a hierarchical tree view of metrics for selection. It utilizes Material-UI's `SimpleTreeView` and `TreeItem` to render nested groups of metrics. Each metric has a checkbox managed by the `checkBoxManager` state passed from `ViewContainer.jsx` and an `onChange` handler (`handleCheckBoxClicked`).
- Minor changes involved temporary text additions (`kk`) to a label and subsequent removal, indicating testing or minor UI adjustments.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js` (multiple timestamps: 10/28/2025, 3:35:37 PM; 10/28/2025, 3:37:47 PM; 10/28/2025, 3:38:11 PM; 10/28/2025, 5:49:01 PM; 10/29/2025, 11:09:14 AM; 10/29/2025, 11:17:33 AM; 10/29/2025, 11:53:55 AM; 10/29/2025, 11:54:19 AM; 10/29/2025, 11:55:32 AM; 10/29/2025, 11:56:24 AM):
This configuration file defines several constant arrays and objects related to analytics:
- `DEFAULT_ANALYTICS_ENDPOINTS`: An array of objects, each specifying a `reportName` and its corresponding API `url` for CBM and TEU metrics, grouped by columns like `scac_code`, `pol`, `pod`, `shipper`, `country_of_origin`.
- `EXCEL_EXPORT_COLUMNS`: A large array defining the keys and display names for columns used in Excel exports, covering various shipment and container details (file number, account, shipper, MBL/BL numbers, container info, dates, etc.).
- `CargoReadyToETD10Days`: A smaller array of columns relevant to "Cargo-Ready Date to ETD 10 Days" reports.
- `ANALYTICS_REPORT_HEADER`: A comprehensive object mapping report names to arrays of headers (e.g., `["SCAC", "CBM"]`, `["POL", "Days"]`). This object was frequently appended to, specifically for Transit, Chassis, KGS, TEU, and CBM metrics, adding "Container" as a header option for some reports. The repeated updates consistently appended additional report headers for container-wise and MBL-wise data categories, including `Container by Ocean Freight Carrier (SCAC)` and `Container by Port of Loading`. This indicates an ongoing expansion of the types of analytics reports supported.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx` (multiple timestamps: 10/28/2025, 4:05:26 PM; 10/28/2025, 4:08:24 PM):
This component renders different views (yearly or monthly) of planboard items, primarily displaying them as cards. It uses Material-UI Grid and Stack for layout.
- It fetches planboard data using `useFetchPlanboardQuery` and dynamically sets filter objects based on the view type (`year` or `month`).
- Includes `MonthViewItem` and `YearViewItem` sub-components for rendering data specific to those views.
- The `NoDataAvailable` component is used when no data is present.
- A `console.log` statement was added to inspect `planboardData`. Minor changes were made to the `NoDataAvailable` message string (adding "123" and removing it).

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx` (multiple timestamps: 10/29/2025, 9:56:31 AM; 10/29/2025, 9:57:53 AM):
This component provides actions and information at the footer of an analytics metric display.
- Functionality includes Excel and PDF export options.
- Excel export now allows selecting specific columns using a `ColumnsSelector` modal and dispatches `setSelectedColumns` action.
- PDF export uses `jspdf` and `html2canvas` to render the chart component as a PDF.
- Displays calculation details (`calType`, `calValue`) and a tooltip for complex report formulas.
- An `IconButton` is provided for fullscreen view (`setEnlarge`).
- A `console.log` was added to debug the `item` prop. Minor text change from "Excel" to "Excel1" in button label.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx` (multiple timestamps: 10/29/2025, 10:54:57 AM to 10:29/2025, 11:02:26 AM):
This component provides filtering and view options for individual analytics metrics.
- It allows users to switch between chart views (using `SwitchBox`), and apply date (`DATE_FILTER_OPTIONS`), period (`PERIOD_FILTER_OPTIONS`), and "view by" (`VIEW_BY_FILTER_OPTIONS`) filters.
- Supports custom date range selection via `PopoverPanel` and `DateRange`.
- Dispatches Redux actions (`setDateFilter`, `setPeriodFilter`, `setViewFilter`) to update the analytics state.
- `useEffect` hook triggers `fetchSingleReport` whenever filters change.
- Several changes involved commenting out and uncommenting various `SelectBoxLight` components (Period, View By, Filter) and the `PopoverPanel` with `DateRange`, and briefly adding an `<h1>hhhhh</h1>` tag. These actions suggest active debugging, testing, and ultimately restoring or partially restoring filtering functionalities. The final state shows the `SwitchBox`, `Period`, `View By`, and `Filter` dropdowns, along with the `DateRange` popover, all present and functional, implying these features were being refined.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx` (multiple timestamps: 10/29/2025, 11:02:52 AM to 10/29/2025, 12:11:06 PM):
This is a wrapper component responsible for rendering a specific analytics metric, including its toolbar, chart, and footer.
- It determines the chart type (`PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`) based on the `item.chartType` prop and renders the appropriate chart component.
- Manages `chartView` state and `enlarge` state for fullscreen mode.
- Includes `MetricToolbar` for filters and `MetricFooter` for export/fullscreen.
- Displays `NoDataAvailable` when no data is present.
- Minor changes included commenting out and uncommenting the `MetricToolbar` in both the main view and the fullscreen modal, and adding `console.log` statements to inspect `item`. The final version shows `MetricToolbar` enabled in the main view but commented out in the fullscreen modal, suggesting a design decision to hide toolbar options in fullscreen.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js` (multiple timestamps: 10/29/2025, 11:18:07 AM to 10/29/2025, 1:31:56 PM):
This file contains utility functions for analytics reports.
- `TruncateText`: A helper function to truncate long text.
- `metricsPackageHandler`: Transforms raw metric data into a structured object suitable for display, including determining `chartType`, calculating aggregate values (`Avg`, `Total`), and applying formatting. Notably, it changed the default chart type for "Containers Shipped (Mbl Wise)" from `Stackbar` to `General` and then back to default.
- `allChartOptions` and `chartOptionsByType`: Define available chart types and their icons.
- `reportFormula`: Generates display formulas for transit time calculations.
- `weekDateFormater`: Formats dates for weekly displays.
- `downloadReportSpreadsheet`: Handles Excel export logic. It dynamically structures the Excel sheet based on report type (`StackedBar`, `transitBar`, or general), period filter (`month`, `week`, `quarter`), and report name, including specific logic for "Cargo-Ready Date to ETD" reports and "BL Release KPI". It also includes logic for calculation flags (`Avg`, `NA`, `Total`). Console logs were added for debugging `reportArray`.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx` (multiple timestamps: 10/29/2025, 11:45:45 AM to 10/29/2025, 1:33:41 PM):
This component renders a stacked bar chart using `ReactApexChart`.
- It dynamically generates `xaxis` categories based on the selected period filter (`month`, `week`, `quarter`).
- It processes the `data` prop to create series for the stacked bar chart.
- The component includes logic for a smart detection of quarter-based data (e.g., "This Quarter" vs. "Last Quarter") and customizes series and colors accordingly.
- The `tooltip` formatter shows both the value and its percentage of the total for each stack.
- Includes a `Tooltip` for the chart title, with text overflow handling.
- Multiple revisions were made to the `StackedBarChart` logic. Initially, it included specific logic for "This Quarter" and "Last Quarter" colors and series ordering, then simplified to a more general approach of filtering out specific keys, and finally reintroduced the "smart detection" for quarter-based data to apply specific colors and series preparation, otherwise reverting to general stacked metrics. This indicates refinement in handling different types of stacked bar data presentations.
- The `tooltip` formatter was updated to specifically handle cases where data might be `null` or `undefined` by using `s.data[dataIndex] || 0` to ensure robust calculations.

**General Patterns and Recurring Elements:**
- **Analytics Module Focus:** A significant portion of changes revolves around the analytics dashboard, specifically custom view creation/editing, metric display, filtering, and data export.
- **Redux Integration:** The use of `useSelector`, `useDispatch`, and specific API query/mutation hooks (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`) from Redux Toolkit is consistent across multiple components, highlighting a centralized state management approach.
- **Material-UI for UI:** All components consistently use Material-UI components (Box, Stack, Grid, Typography, Buttons, Tabs, TreeView, Checkbox, Tooltip, Chip, IconButton, CircularProgress) for building the user interface.
- **Data Visualization (ApexCharts):** The analytics section heavily relies on `ReactApexChart` for rendering various chart types (Bar, Pie, Line, Stacked Bar, Gauge).
- **Export Functionality:** Both Excel and PDF export capabilities are being actively developed and refined across `MetricFooter.jsx` and `methods.js`. The Excel export logic is particularly complex, adapting to different report types and time filters.
- **Debugging and Refinement:** Repeated additions/removals of `console.log` statements, temporary UI changes (`kk`, `<h1>hhhhh</h1>`), and commenting/uncommenting blocks of code suggest an iterative development and debugging process for specific features (e.g., `MetricToolbar` filters, `StackedBarChart` data handling).
- **Date and Period Filtering:** Components like `MetricToolbar` and `methods.js` show a strong emphasis on flexible date and period filtering (`month`, `week`, `quarter`, `custom`) for analytics reports.
- **Report Header Configuration:** The `analytics.js` configuration file is a central place for defining report headers and structure, indicating a declarative approach to report generation.

## 2:33:15 PM
The provided log details several code changes within an analytics module, primarily focusing on dashboard management, report generation, and data export functionalities. These changes occurred between October 28th and October 29th, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   Enhanced dashboard view management with `getAll`, `create`, `update`, and `deleteView` functions.
    *   A `logAudit` function was introduced to track all dashboard view modifications (create, update, delete) in an `analytics_view_log` table, capturing user and change details.
    *   The `create` function now includes a check to prevent the creation of duplicate dashboard views.
    *   The `update` function was modified to log the `previousValue` of `dashboard_metrics` for auditing purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM - 10/29/2025, 1:55:14 PM)**
    *   This file, responsible for generating SQL query fragments for data exports, saw multiple updates.
    *   Initially, it contained `bookingQuery` with various report types like "Booking Date to Actual Departure" (normal, MBL-wise, stacked bar), including logic for date differences, `CompanyName` filtering, and grouping by display options (month, week, quarter).
    *   A significant update on **10/29/2025, 1:52:59 PM**, introduced a new report type: "Container Shipped (MBL Wise)". This query calculates delivery dates dynamically, assigns them to 'This Quarter' or 'Last Quarter' based on an 8-month sliding window (last 4 months and 4 months prior), and retrieves specific shipping-related columns.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM - 10/28/2025, 3:50:57 PM)**
    *   Manages the retrieval of metric lists, dashboard endpoint configurations, and saving user-defined report sequences and display sizes.
    *   `getMetricList` organizes metrics into 'Container_Wise' and 'MBL_Wise' groups, with an option to `preload` selected metrics for a given dashboard.
    *   `dashboardEndPointList` fetches and sorts report endpoints based on user dashboard configurations, including `rowSpan` and `columnSpan`.
    *   `saveSequence` allows users to order reports in their dashboards, with special handling for a 'Default' dashboard.
    *   `saveSize` updates the `size` property of a dashboard to store `columnSpan` and `rowSpan` for individual metrics.
    *   A minor logging statement was added on **10/28/2025, 3:50:57 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps: 10/28/2025, 4:22:21 PM - 10/29/2025, 12:17:47 PM)**
    *   This file, containing the `mblQueryBuilder`, underwent extensive refactoring and development over the two days.
    *   Initially supported 'ContainerShippedMblWise' and 'TotalShipmentsMblWise' reports, providing counts and percentages.
    *   On **10/28/2025, 5:05:54 PM**, the 'TotalShipmentsMblWise' type was eventually removed, and the `ContainerShippedMblWise` logic was significantly expanded to query for completed shipments, dynamically calculate quarter ranges (based on the current date), and group results by these quarters.
    *   Further changes on **10/29/2025** refined the `ContainerShippedMblWise` report:
        *   Quarter calculation shifted to an 8-month window (last 4 months and current 4 months, labeled 'Last Quarter' and 'This Quarter').
        *   The SQL query was modified to group by both quarter and month (`TO_CHAR(deliverd_date, 'Mon')`), providing container counts for each month within these quarters.
        *   Metadata in the `customizer` object was updated to reflect chart type (`StackedBar`), calculation type (`avg`), and the axis labels (`dateColumns` changed from `['This Quarter', 'Last Quarter']` to `['TEU', 'Month']` and then `['Month', 'TEU']`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps: 10/28/2025, 5:09:46 PM - 10/29/2025, 1:17:31 PM)**
    *   This controller dispatches requests to various query builders based on the `type` of analytics report.
    *   It consistently determines `CompanyName` and `user_id` from the authenticated request.
    *   Changes focused on how `mblQueryBuilder` was invoked for the `ContainerShippedMblWise` report, including toggling the `codeCustomization` flag and adjusting parameters passed (e.g., `fromDate` and `toDate` were removed from the `mblQueryBuilder` call on **10/29/2025, 10:23:17 AM**, as the query builder itself started managing these dynamically).
    *   A notable change on **10/29/2025, 1:14:39 PM** briefly and erroneously routed `ContainerShippedMblWise` to `bookingQueryBuilder`, which was quickly corrected by removing it from that block and commenting out its dedicated `mblQueryBuilder` call on **10/29/2025, 1:17:31 PM**, suggesting ongoing refactoring or temporary disabling of that specific report's integration.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Timestamps: 10/29/2025, 1:36:20 PM - 10/29/2025, 1:42:25 PM)**
    *   Handles data export, generating SQL queries and processing results for various reports.
    *   It selects columns dynamically, saves user column preferences, and differentiates between 'booking' and 'non-booking' related reports.
    *   Includes a `replaceColumnHandler` to standardize "LONG BEACH" to "LOS ANGELES" for `pod` and `place_of_delivery` fields.
    *   Special logic is implemented for "TEU MBLwise" reports to collapse duplicate entries.
    *   On **10/29/2025, 1:41:44 PM**, the `mblWiseQuery` construction was slightly refined, and error responses were improved to include the error message.

**Patterns and Recurring Elements:**

*   **Focus on Analytics:** All changes revolve around building, managing, and exporting analytics data and reports, especially dashboard views.
*   **Database-Centric Operations:** Heavy reliance on `query` calls to interact with the PostgreSQL database (`dashboards`, `metrics`, `mtr_tracking_data`, `agent_booking_entry`, `analytics_view_log` tables).
*   **Dynamic SQL Generation:** SQL queries are frequently constructed dynamically using string interpolation, based on user input (e.g., `CompanyName`, `reportName`, date ranges).
*   **User Contextualization:** Report generation and dashboard management consistently use `user.usercode` and `CompanyName` to filter and personalize data.
*   **Date and Time Manipulation:** Extensive use of `EXTRACT(DAY FROM...)`, `DATE_TRUNC`, and `::timestamp` in SQL queries, and `Date` object manipulation in TypeScript for calculating and filtering based on time periods (e.g., weeks, months, quarters).
*   **`customizer` Object:** A `customizer` object is used across multiple query builders to pass metadata about the report's characteristics (e.g., `calType`, `chartType`, `dateRange`, `dateColumns`, `selectedColumns`), which likely informs client-side rendering.
*   **Error Handling and Logging:** Consistent `try...catch` blocks for robust error handling and `logger.info`/`logger.error` for debugging and monitoring are present throughout the controller files.
*   **Data Transformation:** Post-query processing logic, such as `replaceColumnHandler` for standardizing location names and specific logic for "TEU MBLwise" reports, indicates efforts to refine and format data before presentation.
*   **Evolution of Reports:** The log shows a clear progression in the sophistication of specific reports, particularly "Container Shipped (MBL Wise)", which evolved from simple counts to detailed, month-by-quarter stacked bar data.

## 3:33:16 PM
The code changes log primarily reflects active development and debugging within the `t360-frontend` application, specifically in the analytics and planboard sections. All recorded changes occurred on 10/28/2025 and 10/29/2025.

**Key File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **10/28/2025 (2:02 PM - 5:53 PM):** This component, responsible for creating, editing, and deleting custom analytics views, remained functionally stable, but saw the addition of `console.log` statements (`===jhhjkk`, `===viewname`) for debugging the `viewOptions` data and `viewName` state.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **10/28/2025 (2:04 PM - 3:46 PM):** This component, which renders the hierarchical tree view for selecting analytics metrics, included a temporary debugging string (`kk`) appended to `innerItem.name` at 3:46:33 PM, which was quickly reverted at 3:46:51 PM, indicating a brief test of rendering. It also retains an initial `console.log("===tree",data);`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **10/28/2025 (3:35 PM - 3:38 PM):** The `ANALYTICS_REPORT_HEADER` object was initially truncated and then corrected in subsequent commits.
    *   **10/28/2025 (5:49 PM) to 10/29/2025 (11:56 AM):** This file saw multiple entries without any discernible functional changes, suggesting repeated saving or non-substantive commits after the initial fix.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **10/28/2025 (4:05 PM - 4:08 PM):** The component for displaying planboard data added a `console.log("===planboardData",planboardData);` for debugging the fetched data. A "123" suffix in the "No Data Available" message persisted, which might be a lingering debug artifact.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **10/29/2025 (9:56 AM - 9:57 AM):** This component, handling report export and full-screen view, had a temporary "Excel1" label on the Excel export button and gained a `console.log("===item",item);` for debugging.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **10/29/2025 (10:54 AM - 11:02 AM):** This file shows highly volatile changes, with frequent commenting and uncommenting of UI elements (`SwitchBox`, `SelectBoxLight` for "Period" and "View By", and `PopoverPanel` for custom date range). A temporary `<h1>hhhhh</h1>` was also briefly added and removed. This indicates intensive development and testing of filter visibility and interactions.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **10/29/2025 (11:02 AM - 12:11 PM):** This component, responsible for rendering various chart types, showed patterns of debugging (`console.log`) and temporary commenting/uncommenting of the `MetricToolbar` for the primary view. It also clarified the data slicing for initial chart rendering (`item.data.slice(0, 9)`) versus full-screen view (`item.data`).
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **10/29/2025 (11:18 AM - 11:25 AM):** A functional change occurred where the special case for `AnalyticsChartType.Stackbar` based on the report name "Containers Shipped (Mbl Wise)" was removed from `findChartType`, making the default behavior more generalized.
    *   **10/29/2025 (1:30 PM - 1:31 PM):** Similar to `analytics.js`, this file had several identical entries without functional changes after the initial update.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **10/29/2025 (11:45 AM - 3:07 PM):** This file underwent the most significant and frequent changes. It shows an iterative process of refining data preparation and chart rendering logic for stacked bar charts. Key changes include:
        *   Initial setup with dynamic y-axis data generation based on period.
        *   Refactoring to specifically handle "This Quarter" vs "Last Quarter" data display.
        *   Introduction and subsequent changes to a smart detection mechanism (`isQuarterData`) to switch between specialized quarter views and general stacked bar data processing.
        *   Volatile changes in how `periodFilter` (month, week, quarter) impacts data aggregation and categorization.
        *   Improvements in data parsing (`parseInt`, `parseFloat`, nullish coalescing) and series data validation to prevent ApexCharts rendering errors.
        *   Multiple back-and-forth commits between two distinct implementations for period-based data handling within the `useEffect` hook.

**Patterns and Recurring Elements:**

*   **Debugging focus:** A pervasive pattern across multiple files is the insertion and removal of `console.log` statements, temporary UI elements, and commented-out code blocks. This suggests an active, rapid development and debugging cycle.
*   **UI/Filter Iteration:** The `MetricToolbar.jsx` changes highlight frequent experimentation or bug fixing related to how filter options are presented and controlled, with components being enabled and disabled repeatedly.
*   **Data Processing Refinement:** The `StackedBarChart.jsx` file exhibits continuous refinement of data transformation logic, particularly for handling time-series and comparative (e.g., quarter-over-quarter) data. This indicates complex data visualization requirements and ongoing adjustments to ensure correct and flexible chart generation.
*   **Non-Substantive Commits:** Several files (`analytics.js`, `methods.js`) show identical content across multiple timestamps, suggesting either saving without changes or minor, unrecorded edits.
*   **Frontend-Centric Development:** All changes are concentrated in the frontend `src` directory, indicating a strong focus on the client-side user experience, analytics visualization, and data presentation.

## 3:33:18 PM
The log details a series of changes primarily focused on enhancing and refining analytics reporting features within the `t360-backend` application. All updates occurred between October 28th and 29th, 2025.

**File-Specific Updates:**

*   **`src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    This file, responsible for managing user-defined dashboard views, received significant updates. New functionalities were added to perform CRUD (Create, Read All, Update, Delete) operations on dashboards, including the ability to store a list of associated metrics. A new `logAudit` function was introduced to meticulously record every dashboard creation, update, and deletion, capturing user information and, for updates, both previous and new dashboard metric configurations.

*   **`src\controllers\analytics\query\export.query.ts` (Multiple timestamps: 10/28/2025, 3:38:52 PM - 10/29/2025, 1:55:14 PM)**
    This file, which provides SQL query snippets for data export, saw iterative modifications. It defines `bookingQuery` to generate dynamic SQL for various booking-related reports (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival"), accommodating MBL-wise and stacked bar views with filtering by month, week, or quarter. A key change was the introduction of a new, complex "Container Shipped (MBL Wise)" report at 10/29/2025, 1:52:59 PM. This report's query involves advanced date calculations to categorize and count containers based on delivery dates within "This Quarter" and "Last Quarter" (each spanning a 4-month period).

*   **`src\controllers\analytics\core.metric.controller.ts` (Multiple timestamps: 10/28/2025, 3:49:50 PM - 10/28/2025, 3:50:57 PM)**
    This controller manages analytics metrics and dashboard layout. It was updated to:
    *   Retrieve and group metrics by type (Container-Wise, MBL-Wise) and support preloading selected metrics for an existing dashboard.
    *   Provide dashboard endpoint lists, including configuration for report sizing (rowSpan, columnSpan).
    *   Allow users to save the sequence of metrics on a dashboard and persist individual report display sizes. A debugging `console.log` statement was temporarily added in `getMetricList`.

*   **`src\controllers\analytics\query\mbls.query.ts` (Multiple timestamps: 10/28/2025, 4:22:21 PM - 10/29/2025, 12:17:47 PM)**
    This file underwent substantial and frequent changes, largely centered around the `ContainerShippedMblWise` report.
    *   Initially, it handled simple shipment and container counts.
    *   By 10/28/2025, 5:05:54 PM, the `ContainerShippedMblWise` report was refactored to use a CTE (`completed_shipments`) and dynamically calculate container counts categorized by 'Current Quarter' and 'Last Quarter' based on delivery dates, removing explicit `fromDate` and `toDate` parameters from its signature.
    *   Further iterations on 10/29/2025 adjusted the quarter definition to cover an 8-month window (last 4 months and 4 months before that), grouping results by quarter and abbreviated month (`'Mon'`).
    *   The `customizer` object's properties (`calType`, `chartType`, `dateColumns`) were iteratively updated to reflect the new chart's nature, finally settling on `['Month', 'TEU']` for `dateColumns` at 10/29/2025, 12:17:47 PM. These numerous, rapid changes suggest active development and refinement of this specific report's data processing logic and metadata.

*   **`src\controllers\analytics\others.controller.ts` (Multiple timestamps: 10/28/2025, 5:09:46 PM - 10/29/2025, 1:17:31 PM)**
    This acts as the main entry point for general analytics reports, dispatching requests to specific query builders. Changes here primarily reflect the integration and re-integration of the `mblQueryBuilder` for `ContainerShippedMblWise`. Parameters for `mblQueryBuilder` were adjusted to remove `fromDate` and `toDate` (10/29/2025, 10:23:17 AM). A brief period saw an incorrect call to `bookingQueryBuilder` for `ContainerShippedMblWise` (10/29/2025, 1:14:39 PM), which was then resolved by commenting out the `ContainerShippedMblWise` dispatch entirely (10/29/2025, 1:17:31 PM), indicating ongoing development or debugging of this report's integration.

*   **`src\controllers\analytics\core.export.controller.ts` (Multiple timestamps: 10/29/2025, 1:36:20 PM - 10/29/2025, 1:42:25 PM)**
    This controller manages the export of data. It saves user-selected columns, then dynamically builds and executes SQL queries based on whether the report is "booking" related or not. It includes logic to handle `DISTINCT ON` clauses for MBL-wise reports and a post-processing step (`replaceColumnHandler`) to standardize geographical names (e.g., 'LONG BEACH' to 'LOS ANGELES'). Error responses were enhanced to include `error.message`.

**Patterns and Recurring Elements:**

*   **Analytics Focus:** All changes are concentrated within the analytics module, focusing on dashboard management, report generation, and data export.
*   **Database-Centric Operations:** The codebase heavily relies on direct SQL queries (`query` function) for data retrieval and manipulation.
*   **Parameterized Queries:** SQL queries are dynamically constructed using template literals and injected parameters (e.g., `CompanyName`, `fromDate`, `toDate`), which highlights a risk if not properly sanitized to prevent SQL injection.
*   **User and Company Context:** User-specific data (`user.usercode`, `req.query.companyname`, `req.user.firstname`) is consistently used for filtering data and logging actions.
*   **Dynamic Report Metadata:** A `customizer` object is frequently used across controllers and query builders to pass and update metadata about the current report (e.g., `chartType`, `calType`, `dateColumns`), suggesting a flexible frontend rendering based on this configuration.
*   **Date Handling and Formatting:** Extensive use of PostgreSQL's `EXTRACT`, `DATE_TRUNC`, and `TO_CHAR` functions for complex date difference calculations, grouping, and formatting within SQL queries. There's also explicit handling for invalid date strings (`'0001-01-01 00:00:00 BC'`).
*   **Iterative Development:** Numerous small, timestamped changes within the same files, especially `mbls.query.ts` and `others.controller.ts`, indicate an active and iterative development process, particularly for new and complex reports like "Container Shipped (MBL Wise)".
*   **Error Handling:** `try...catch` blocks are used consistently, logging errors and returning 500 status codes for internal server issues.

## 4:33:44 PM
The provided log details a series of code changes primarily focused on the frontend of an analytics dashboard, particularly involving custom view management, chart rendering, and export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Initial State (10/28/2025, 2:02:33 PM):** This component is responsible for creating, editing, and deleting custom analytics dashboards. It manages user selections of up to 9 metrics, handles API interactions for saving/updating/deleting views, and integrates an audit drawer.
    *   **Minor Changes (10/28/2025, 3:48:07 PM & 5:53:50 PM):** Introduced `console.log` statements for debugging `viewOptions` and `viewName`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Initial State (10/28/2025, 2:04:34 PM):** This component renders a selectable tree view of metrics, categorized into "Container Wise" and "MBL Wise", used within the `ViewContainer`.
    *   **Temporary Testing (10/28/2025, 3:46:33 PM & 3:46:51 PM):** A temporary string "kk" was added to a metric label for testing purposes and then immediately reverted.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Initial State (10/28/2025, 3:35:37 PM):** This configuration file defines default analytics endpoints, columns for Excel exports, and a large `ANALYTICS_REPORT_HEADER` object which maps report names to their corresponding column headers for various metrics (CBM, TEU, KGS, Transit, Chassis). The initial log entry shows an incomplete `ANALYTICS_REPORT_HEADER` definition.
    *   **Completion (10/28/2025, 3:37:47 PM):** The `ANALYTICS_REPORT_HEADER` definition was completed by adding missing entries for "Container by Ocean Freight Carrier (SCAC)" and "Container by Port of Loading".
    *   **Subsequent Saves (Various timestamps until 10/29/2025, 11:56:24 AM):** The file was saved multiple times without any functional code changes after its initial completion.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Initial State (10/28/2025, 4:05:26 PM):** Displays planboard data in either a yearly or monthly card view, with filtering capabilities and a "No Data Available" message.
    *   **Minor Change (10/28/2025, 4:08:24 PM):** Added a `console.log` statement for debugging `planboardData`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Initial State (10/29/2025, 9:56:31 AM):** Provides export options (Excel, PDF) for analytics reports, supports column selection for Excel, full-screen chart view, and displays calculation results and formulas.
    *   **Minor Change (10/29/2025, 9:57:53 AM):** Added a `console.log` statement for debugging the `item` prop.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Initial State (10/29/2025, 10:54:57 AM):** Contains UI controls for filtering analytics charts, including a chart view switch, period and view-by filters, and a date range filter with a custom date picker. It dispatches Redux actions to manage filter states. The "Period" label was initially "Period1".
    *   **Fix and Extensive Testing (10/29/2025, 10:55:11 AM - 11:02:26 AM):** The "Period1" label was corrected to "Period". Following this, the component underwent a series of rapid changes involving commenting out and re-enabling various UI elements (SwitchBox, Period/View By/Date Filter `SelectBoxLight`s, and `PopoverPanel`), and even temporary HTML additions (`<h1>hhhhh</h1>`). This indicates active and iterative testing of the toolbar's controls.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Initial State (10/29/2025, 11:02:52 AM):** This component dynamically renders various chart types (Bar, Pie, Line, StackedBar, Gauge) based on metric data. It integrates `MetricToolbar` for controls and `MetricFooter` for export/full-screen functionality.
    *   **Toolbar Management & Debugging (10/29/2025, 11:03:15 AM - 11:04:05 AM):** The `MetricToolbar` was temporarily commented out from the main render and/or the full-screen modal, and a `console.log` was added for debugging `item`.
    *   **Chart Rendering Adjustment (10/29/2025, 11:20:37 AM - 12:11:06 PM):** The rendering of the main chart component was explicitly set to use `item.data.slice(0, 9)` to limit data points, though this was already handled within the `getChartComponent` definition. Further `console.log` statements were added for debugging data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Initial State (10/29/2025, 11:18:07 AM):** Contains utility functions for analytics such as text truncation, `metricsPackageHandler` (which processes raw metric data to prepare it for charts, including chart type detection and calculation of totals/averages), chart option definitions, `reportFormula` generation, date formatting, and `downloadReportSpreadsheet` (logic for generating Excel reports with detailed conditional formatting based on chart type and period). A specific logic for `"Containers Shipped (Mbl Wise)"` to default to StackedBar was present.
    *   **Chart Type Logic Refinement (10/29/2025, 11:25:01 AM):** The special case in `metricsPackageHandler` for `"Containers Shipped (Mbl Wise)"` to default to `StackedBar` was removed, making `AnalyticsChartType.General` the default.
    *   **Subsequent Saves (Various timestamps until 10/29/2025, 1:31:56 PM):** The file was saved multiple times without functional code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **Initial State (10/29/2025, 11:45:45 AM):** Renders a stacked bar chart, dynamically generates categories and series based on period filters (month, week, quarter), includes tooltip formatting, and special color handling for "This Quarter" / "Last Quarter" comparison.
    *   **Extensive Refactoring and Reversions (10/29/2025, 11:46:15 AM - 4:31:53 PM):** This file shows a consistent pattern of iterative development, specifically around how data is prepared for the chart when dealing with different period filters (month, week, quarter) and special "This Quarter" vs. "Last Quarter" comparisons.
        *   Initial changes improved loading state and minor chart option tweaks.
        *   Significant changes introduced and then repeatedly reverted or re-implemented logic to explicitly handle and aggregate data for "This Quarter" vs. "Last Quarter" comparisons (e.g., using `prepareStackedData`, `isQuarterData`, or `hasQuarterComparison` flags).
        *   Multiple attempts were made to control chart colors based on the data type (quarter comparison vs. general).
        *   Logic was added to robustly handle empty data or ensure numeric types (`parseInt`, `parseFloat`) for chart data, and to guard against ApexCharts data mismatches (using `safeSeries`), but these improvements were also frequently reverted.
        *   The timestamp trail reveals a back-and-forth in implementation, indicating a challenging and evolving requirement for displaying stacked bar charts with flexible period filtering and comparative data.

**Key Timestamps and Patterns:**

*   **Late October 28, 2025:** Initial development and debugging of custom analytics views (`ViewContainer.jsx`, `TreeViewContianer.jsx`) and the planboard component (`PlanboardCardView.jsx`). `analytics.js` receives its initial, then completed, set of analytical report headers and export columns.
*   **Morning/Afternoon October 29, 2025:** Intense development activity in the analytics section:
    *   `MetricFooter.jsx` and `MetricsBox.jsx` see updates related to export options and full-screen chart display.
    *   `MetricToolbar.jsx` undergoes rapid prototyping/debugging, with elements being repeatedly commented and uncommented.
    *   `StackedBarChart.jsx` is the most actively changed file, showing a clear pattern of continuous refactoring, attempting to implement specific data processing for quarter-on-quarter comparisons and period filtering, followed by multiple partial or full reversions. This suggests ongoing challenges or changing requirements in rendering complex stacked bar charts.
    *   `analytics.js` remains largely stable after its initial setup, serving as a static configuration.

The overall log indicates active development on the analytics and planboard features, with a particular focus on refining custom view creation, data visualization (especially stacked bar charts with period comparisons), and export functionality. The frequent `console.log` statements and comment/uncomment cycles highlight a process of debugging and iterative refinement.

## 4:35:09 PM
The provided log entries detail significant updates across several analytics-related controller and query builder files, primarily focusing on report generation, dashboard management, and data export functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM)**
    *   This file introduces comprehensive CRUD (Create, Read, Update, Delete) operations for analytics dashboards.
    *   New functions `getAll`, `create`, `update`, and `deleteView` were added to manage user-defined dashboards, including associating metrics and handling menu titles.
    *   A new `logAudit` helper function was implemented to track all dashboard modifications (create, update, delete) in an `analytics_view_log` table, recording user, action, menu title, and value changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamps: 10/28/2025, 3:49:50 PM & 10/28/2025, 3:50:57 PM)**
    *   This controller manages metrics for analytics.
    *   The `getMetricList` function was updated to retrieve metrics, categorize them into `Container_Wise` and `MBL_Wise` groups, and support preloading a dashboard's selected metrics.
    *   `dashboardEndPointList` was implemented to fetch ordered metrics for a given dashboard, including `rowSpan` and `columnSpan` information from dashboard settings.
    *   `saveSequence` was added to update the order of metrics on a dashboard, with special handling for a "Default" dashboard.
    *   `saveSize` was introduced to allow users to customize the display size (column/row span) of individual metrics on a dashboard, storing this configuration in the `dashboards` table.
    *   A minor change involved adding a `console.log` for debugging `metricsListData` (10/28/2025, 3:50:57 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Timestamps: 10/28/2025, 3:38:52 PM - 10/29/2025, 1:55:14 PM)**
    *   This file centralizes SQL query generation for various export reports.
    *   The `bookingQuery` function dynamically constructs SQL based on `reportName`, `CompanyName`, and date/grouping parameters for "Booking Date to X" reports, including complex stacked bar variants that categorize day differences into week ranges.
    *   A significant addition on **10/29/2025, 1:52:59 PM** introduced a new report query for "Container Shipped (MBL Wise)" directly into the `bookingQuery` object. This query fetches detailed container/MBL tracking data and includes dynamic quarter calculation (last 4 months vs. 4-8 months ago) as part of the select statement.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Timestamps: 10/28/2025, 4:22:21 PM - 10/29/2025, 12:17:47 PM)**
    *   This file manages specific MBL-related analytics queries via the `mblQueryBuilder` function.
    *   Initially, it handled "ContainerShippedMblWise" and "TotalShipmentsMblWise" by counting distinct filings/voyages/MBLs (10/28/2025, 4:22:21 PM).
    *   A major refactoring on **10/28/2025, 5:05:54 PM** redefined "ContainerShippedMblWise" to count distinct containers per dynamically calculated "Current Quarter" and "Last Quarter" using a Common Table Expression (CTE) for completed shipments. The "TotalShipments" logic was likely moved to `generalQueryBuilder`.
    *   Further refinements included adjusting `customizer.selectedColumns` (10/28/2025, 5:06:57 PM), simplifying the `mblQueryBuilder` signature to remove `fromDate` and `toDate` for this dynamic report type (10/28/2025, 5:12:32 PM, 10/28/2025, 5:15:25 PM).
    *   On **10/29/2025, 10:22:22 AM**, the quarter calculation logic was heavily revised to define "This Quarter" and "Last Quarter" as specific 4-month windows (e.g., last 4 months, and the 4 months before that) and the SQL was updated to group by `quarter` and `month` (e.g., `TO_CHAR(deliverd_date, 'Month')`).
    *   Metadata for the chart was updated via `customizer.calType = "avg";` (10/29/2025, 10:43:50 AM) and `customizer.dateColumns` was set to `['Month', 'TEU']` (10/29/2025, 11:38:49 AM, reordered on 10/29/2025, 12:17:47 PM) indicating changes in how the data should be displayed on a chart.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamps: 10/28/2025, 5:09:46 PM - 10/29/2025, 1:17:31 PM)**
    *   This is the main entry point for fetching analytics reports (`getTableDataReports`).
    *   It was updated to integrate `mblQueryBuilder` into its conditional logic, explicitly marking it for `codeCustomization` (10/28/2025, 5:09:46 PM, 10/28/2025, 5:14:52 PM).
    *   Multiple attempts and reverts were made to move the `ContainerShippedMblWise` type from `mblQueryBuilder` to `bookingQueryBuilder` (10/29/2025, 11:23:41 AM, 10/29/2025, 1:14:39 PM), indicating some indecision or refactoring in progress, but eventually, it was kept separate or removed from `bookingQueryBuilder`'s condition (10/29/2025, 1:17:31 PM).
    *   Removed `fromDate` and `toDate` when calling `mblQueryBuilder` to align with the `mbls.query.ts` changes (10/29/2025, 10:23:17 AM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Timestamps: 10/29/2025, 1:36:20 PM & 10/29/2025, 1:41:44 PM)**
    *   A new `getExportData` function was added to handle data export.
    *   It dynamically builds export queries using `bookingQuery` and `nonBookingQuery`, applying column selection, date filtering, and `mblwise` distinctness.
    *   Includes specific post-processing logic for "TEU MBLwise" reports to handle duplicate entries by setting 'teu' to '-'.
    *   A `replaceColumnHandler` utility was introduced to standardize 'LONG BEACH' values to 'LOS ANGELES' in `pod` and `place_of_delivery` columns for all exported data.
    *   Error responses were enhanced to include `error.message` (10/29/2025, 1:41:44 PM).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Timestamps: 10/29/2025, 11:23:09 AM - 10/29/2025, 4:29:29 PM)**
    *   This file defines the `bookingQueryBuilder` function, which creates SQL queries for various booking and cargo-ready related reports.
    *   It supports different types of reports (`BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, and their `StackedBar` versions).
    *   Queries involve calculating day differences between dates, applying company and date range filters, and for stacked bars, categorizing results into week ranges (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   Metadata is added to `customizer` including `dateRange`, `calType`, `chartType`, `dateColumns`, and `calColumnConfig`.
    *   Many entries for this file show identical code, suggesting minor non-functional saves or reformatting.

**Patterns and Recurring Elements:**

1.  **Analytics Context:** All changes revolve around building an analytics and reporting backend, with controllers and query builders clearly separated by report category.
2.  **Dynamic SQL Generation:** A dominant pattern is the construction of complex SQL queries using string interpolation based on various parameters. This implies a highly customizable reporting system.
3.  **Date and Time Manipulation:** Frequent use of `EXTRACT(DAY FROM ...)` and `DATE_TRUNC` in SQL, along with `fromDate` / `toDate` parameters, highlights a strong focus on time-series analysis and date-based reporting. Dynamic quarter calculation logic is repeatedly refined.
4.  **User and Company Context:** `user_id` and `CompanyName` are consistently passed to query builders and used in SQL `WHERE` clauses, indicating multi-tenancy or user-specific data access.
5.  **Data Categorization and Aggregation:** Queries often involve `COUNT(DISTINCT ...)` for aggregation and `CASE WHEN ... THEN ... END` statements for categorizing data (e.g., day differences into week buckets, delivery dates into quarters).
6.  **`customizer` Object for Frontend Hinting:** The `customizer` object is extensively used to pass metadata (e.g., `chartType`, `calType`, `dateColumns`, `calColumnConfig`) to the frontend, likely guiding how reports are rendered.
7.  **Error Handling and Logging:** Standard `try...catch` blocks with `logger.info`/`logger.error` and `res.status(500).json(...)` are used across controllers for robust error management.
8.  **Data Consistency:** The `replaceColumnHandler` in `core.export.controller.ts` ensures data consistency by mapping specific location names, suggesting data cleansing or standardization requirements.
9.  **Iterative Development:** The multiple timestamp entries for the same file, sometimes with minor changes or reverts, suggest an iterative development process, with frequent saves and adjustments to the query logic and report definitions.
10. **Distinctness Logic:** `DISTINCT ON` clauses are used to ensure unique records based on certain criteria (e.g., `voyage`, `contno`, `mblno`) in many queries.

## 5:32:59 PM
The log details a series of updates across several analytics-related backend files, primarily focusing on report generation, dashboard management, and data export.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM):** This file defines the core API for managing user-specific analytics dashboards (views). It includes functionalities to retrieve all dashboards (`getAll`), create a new dashboard (`create`) with associated metrics, update an existing dashboard's metrics and title (`update`), and delete a dashboard (`deleteView`). A new `logAudit` function was introduced to track these dashboard actions (CREATE, UPDATE, DELETE) in an `analytics_view_log` table, recording user, action, menu title, and value changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Significant changes: 10/28/2025, 3:38:52 PM - 10/29/2025, 1:55:14 PM):** This file provides SQL query snippets for various booking-related reports for data export.
    *   Initially, it contained queries for reports like "Booking Date to Actual Departure" and its "Stacked Bar" and "MBL Wise Stacked Bar" variations, dynamically filtering by month, week, or quarter.
    *   A major update on 10/29/2025, 1:52:59 PM, introduced a new report query type: "Container Shipped (MBL Wise)". This query calculates 'This Quarter' and 'Last Quarter' based on a dynamic 8-month window relative to the current date, joining `mtr_tracking_data` and `agent_booking_entry` tables and filtering for completed shipments (those with `delivery_customer_date` or `updated_inland_arv_date` in the past).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Significant changes: 10/28/2025, 3:49:50 PM - 10/28/2025, 3:50:57 PM):** This controller manages metric lists and dashboard configurations.
    *   It retrieves and groups metrics (`getMetricList`) by `Container_Wise` and `MBL_Wise` types, with an option to preload checked states based on existing dashboards.
    *   It provides `dashboardEndPointList` to fetch sorted report endpoints for a specific dashboard, including `rowSpan` and `columnSpan` for display.
    *   `saveSequence` allows users to reorder metrics on a dashboard, including a special case for initializing a 'Default' dashboard.
    *   `saveSize` persists the display dimensions (`columnSpan`, `rowSpan`) for individual metrics.
    *   A minor change at 10/28/2025, 3:50:57 PM involved adding a `console.log` statement for debugging in `getMetricList`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Significant changes: 10/28/2025, 4:22:21 PM - 10/29/2025, 12:17:47 PM):** This file is responsible for building MBL-related queries.
    *   Initially handled `ContainerShippedMblWise` and `TotalShipmentsMblWise` with basic counts.
    *   Evolved significantly to focus primarily on `ContainerShippedMblWise` by 10/28/2025, 5:08:14 PM, with the `TotalShipments` type being removed.
    *   The `ContainerShippedMblWise` logic was expanded to calculate container counts per quarter, dynamically determining quarter start/end dates.
    *   Further refinements throughout 10/29/2025, including a major overhaul of the quarter calculation logic to cover an 8-month window (last 4 months + this 4 months) and group by month.
    *   Added `customizer.calType = "avg";`, `customizer.chartType = "StackedBar";`, and adjusted `customizer.dateColumns` (e.g., to `['Month', 'TEU']`) multiple times.
    *   The `codeCustomization` parameter was removed from the function signature, indicating it's now handled internally or its explicit usage within this builder is no longer needed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Significant changes: 10/28/2025, 5:09:46 PM - 10/29/2025, 1:17:31 PM):** This controller dispatches requests to the appropriate query builder based on the report `type`.
    *   It contains extensive `if-else if` conditions to route different analytics report types to `chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`, or `mblQueryBuilder`.
    *   Between 10/29/2025, 11:23:41 AM and 1:17:31 PM, there was a temporary attempt to consolidate `ContainerShippedMblWise` under `bookingQueryBuilder`, followed by a revert where its dedicated `mblQueryBuilder` call was commented out, suggesting it was being moved or refactored.
    *   `fromDate` and `toDate` parameters for `mblQueryBuilder` were commented out in one iteration, aligning with `mbls.query.ts` taking over date range calculation.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Significant changes: 10/29/2025, 1:36:20 PM - 10/29/2025, 1:42:25 PM):** This controller handles the export of analytics data.
    *   It builds export-specific SQL queries using `bookingQuery` or `nonBookingQuery` from `export.query.ts`.
    *   It dynamically constructs `DISTINCT ON` clauses based on whether `mblwise` is requested.
    *   It includes a `replaceColumnHandler` function to normalize `pod` and `place_of_delivery` values from 'LONG BEACH' to 'LOS ANGELES'.
    *   Minor structural changes were made to the `if (isBooking)` block on 10/29/2025, 1:41:44 PM, to explicitly separate `mainQuery` construction for MBL-wise and non-MBL-wise booking queries and added error handling details.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Significant changes: 10/29/2025, 11:23:09 AM - 10/29/2025, 5:31:30 PM):** This file provides query building logic for various booking-related reports.
    *   It defines queries for `BookingDatetoActualDeparture` and its MBL-wise and Stacked Bar variations.
    *   The `customizer` object is extensively used to configure report-specific metadata like `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `chartType`, and `calColumnConfig`.
    *   Queries use `EXTRACT(DAY FROM ...)` for day differences and `DATE_TRUNC` for grouping.
    *   There were several minor timestamped changes throughout the day on 10/29, most of which appear to be saving operations without substantial code changes in the provided snippets, primarily related to `customizer` property assignments and the `query` logic for stacked bar reports.

**Patterns and Recurring Elements:**

*   **Modular Query Builders:** The architecture heavily relies on separate "query builder" files (e.g., `chassis.query`, `booking.query`, `mbls.query`, `export.query`) to encapsulate SQL generation logic for different report types.
*   **Dynamic SQL Generation:** SQL queries are frequently constructed using string interpolation with variables like `CompanyName`, `fromDate`, `toDate`, and report-specific parameters.
*   **Report Customization (`customizer` object):** A `customizer` object is passed to query builders and updated with metadata about the report's visualization and calculation types (e.g., `calType`, `chartType`, `dateColumns`, `dateRange`, `booking`, `mblwise`), which seems to inform the frontend on how to display the data.
*   **Date Range and Filtering:** Most queries include date range filtering using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`. There's also specialized logic for calculating and filtering by "quarters" and "months".
*   **Data Normalization:** The `replaceColumnHandler` function indicates a pattern of normalizing specific data values (e.g., 'LONG BEACH' to 'LOS ANGELES') for consistency.
*   **Error Handling:** Consistent use of `try-catch` blocks for robust error management, returning `500 Internal Server Error` with a message.
*   **User-Specific Data:** `user_id` and `CompanyName` from the authenticated user (`req.user`) are consistently used in queries and logic to filter data relevant to the requesting user.
*   **Logging:** `logger.info` and `logger.error` are used throughout the controllers for debugging and operational visibility.

## 5:33:48 PM
The provided code changes primarily focus on enhancements and debugging within an analytics and planboard section of a frontend application, specifically concerning custom view management, metric display, filtering, and data export. There are several recurring patterns, including active debugging via `console.log` statements, rapid iteration on UI component visibility, and repeated saving of configuration files.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\ViewContainer.jsx`**
    *   **Timestamp:** Primarily 10/28/2025, with minor debugging updates at 3:48:07 PM and 5:53:50 PM.
    *   **Updates:** This component, responsible for creating, editing, and deleting custom analytics dashboards, received its main implementation. It manages metric selections using checkboxes (with a limit of 9 metrics), validates input, and interacts with an `analyticsApi` for saving and deleting views. Success or error messages are shown via toasts, and Redux actions are dispatched to update the application state. An `AuditViewDrawer` can be opened for audit details. Debugging `console.log` statements for `viewOptions` and `viewName` were temporarily added. The component hardcodes an `apiKey` directly in its API queries, which is a potential security concern.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\custom-view\TreeViewContianer.jsx`**
    *   **Timestamp:** 10/28/2025, with very quick, temporary debugging changes at 3:46:33 PM and a reversion at 3:46:51 PM.
    *   **Updates:** This component was implemented to render a hierarchical tree view of analytics metrics using `@mui/x-tree-view`, allowing users to select metrics via checkboxes. A temporary string literal "kk" was added to a label for testing purposes and then immediately removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\config\analytics.js`**
    *   **Timestamp:** Major update at 10/28/2025, 3:35:37 PM, followed by numerous identical saves up to 10/29/2025, 11:56:24 AM.
    *   **Updates:** This configuration file received substantial additions, defining:
        *   `DEFAULT_ANALYTICS_ENDPOINTS`: A list of common analytics reports (e.g., CBM by carrier, TEU by origin) with their corresponding API URLs.
        *   `EXCEL_EXPORT_COLUMNS`: A comprehensive schema for columns available in Excel exports, covering detailed shipping and tracking information.
        *   `CargoReadyToETD10Days`: A smaller, specific list of columns for a particular report.
        *   `ANALYTICS_REPORT_HEADER`: A large mapping object defining column headers for various analytics reports, categorizing them by "Container Wise" and "MBL Wise" metrics (CBM, TEU, KGS, Transit, Chassis). Notably, the last entry for "Container by Ocean Freight Carrier (SCAC)" consistently appears truncated across multiple saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\planboard\PlanboardCardView.jsx`**
    *   **Timestamp:** 10/28/2025, with a minor debugging update at 4:08:24 PM.
    *   **Updates:** This component displays planboard data in either a yearly or monthly card view, fetching and filtering data using Redux. A debugging `console.log` for `planboardData` was added. The "No Data Available" message includes a test string "123".

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricFooter.jsx`**
    *   **Timestamp:** 10/29/2025, with a minor debugging update at 9:57:53 AM.
    *   **Updates:** Significant additions to handle report export functionality. It introduces a `ColumnsSelector` within a modal for selecting Excel export columns and implements PDF export using `jsPDF` and `html2canvas`. It also displays calculated metrics (e.g., Average, Total) and report formulas. A test string "Excel1" was added to the Excel export button.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricToolbar.jsx`**
    *   **Timestamp:** 10/29/2025, with rapid, iterative changes from 10:54:57 AM to 11:02:26 AM, and a final debugging `console.log` at 5:27:47 PM.
    *   **Updates:** This component manages filters (date range, period, view by) and chart view toggles for analytics metrics. It dynamically shows a custom date range picker. There were frequent commenting out and uncommenting of various filter `SelectBoxLight` components and the `SwitchBox`, suggesting intense debugging or testing of filter visibility and functionality. Temporary string literal "Period1" and `<h1>hhhhh</h1>` were briefly introduced and removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** 10/29/2025, with minor debugging updates at 11:04:05 AM and 12:11:06 PM, and a functional change at 11:20:37 AM.
    *   **Updates:** This component serves as a container for individual metric charts. It dynamically renders various chart types (Bar, Pie, Line, StackedBar, Gauge) and handles full-screen views. A significant change was implemented at 11:20:37 AM to display only the top 9 data points in the default view while showing all data in the enlarged (full-screen) view. Debugging `console.log` statements for `item` and `data` were added.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
    *   **Timestamp:** Major functional updates at 10/29/2025, 11:18:07 AM, followed by several identical saves until 1:31:56 PM.
    *   **Updates:** This file was updated to include core logic for processing analytics data:
        *   `metricsPackageHandler`: Transforms raw API data into a standardized format for chart rendering, including determining chart type, calculation type (Avg, Total), and data formatting. It initially had a specific `chartType` logic for "Containers Shipped (Mbl Wise)" which was later generalized.
        *   `reportFormula`: Generates display formulas for reports, especially for transit time calculations.
        *   `downloadReportSpreadsheet`: A complex function to generate Excel files, dynamically structuring headers and data based on report type and applied filters (period, view by).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\Charts\StackedBarChart.jsx`**
    *   **Timestamp:** Iterative development throughout 10/29/2025 (11:45:45 AM to 5:20:39 PM).
    *   **Updates:** This component saw extensive and frequent changes to its data processing and rendering logic. Key developments include:
        *   Initial setup with basic stacked bar chart configurations (horizontal, rounded bars, tooltip formatting).
        *   Repeated refactoring of the `useEffect` hook to handle different data structures, specifically distinguishing between generic stacked bar data and data designed for "This Quarter" vs "Last Quarter" comparisons. This logic went through several additions, removals, and modifications, trying different approaches for category generation and series population.
        *   At one point, it included logic to aggregate `container_count` based on `periodFilter` (quarter, week, month), which was then reverted multiple times.
        *   The `colors` array initialization was simplified and later conditionally applied based on `isQuarterData`.
        *   Debugging `console.log("===hgdatta====",data);` was frequently added and removed during this iterative process, indicating ongoing efforts to correctly process diverse data inputs for stacked bar charts.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\AnalyticsContainer.jsx`**
    *   **Timestamp:** 10/29/2025, 4:53:53 PM.
    *   **Updates:** This component, a central orchestrator for the analytics dashboard, was updated to include drag-and-drop (`DndProvider`, `HTML5Backend`) for reordering metrics, and functions (`moveItem`, `saveSize`) to persist these layout changes to the backend. It also refined `fetchSingleReport` to dynamically retrieve data based on user selections and apply necessary formatting using `metricsPackageHandler`.

**Patterns and Recurring Elements:**

*   **Active Debugging:** Numerous `console.log` statements and temporary string literals ("kk", "Excel1", "123", "hhhhh") are scattered throughout the log, indicating an active debugging and development phase.
*   **Rapid UI Iteration:** `MetricToolbar.jsx` shows frequent toggling (commenting/uncommenting) of UI filter components, suggesting quick testing and adjustments to visual elements and their conditional rendering.
*   **Configuration Management:** The `analytics.js` file serves as a central configuration point for reports, columns, and headers, undergoing significant initial setup and then many non-functional saves.
*   **Complex Chart Data Handling:** `StackedBarChart.jsx` demonstrates a struggle to generalize data preparation for different types of stacked bar reports (generic multi-category vs. specific quarter-over-quarter comparisons), leading to repeated refactoring of the `useEffect` logic.
*   **Persistence of User Customizations:** The changes in `AnalyticsContainer.jsx` for saving metric sequence and size, and `ViewContainer.jsx` for saving custom views, highlight a focus on enabling and persisting user-defined dashboard layouts and metric selections.

## 9:39:08 PM
The provided logs detail a series of changes across several TypeScript files within an analytics backend, primarily focused on reporting, data querying, and dashboard management.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 10/28/2025, 1:58:56 PM):**
    *   This file manages dashboard views (getAll, create, update, deleteView).
    *   It now includes a `logAudit` function for auditing user actions (CREATE, UPDATE, DELETE) on dashboards, storing `userId`, `action`, `menuTitle`, `previousValue`, `newValue`, and `user` in an `analytics_view_log` table. This indicates a new auditing feature.
    *   The `create` and `update` functions handle dashboard metric selection and update logic, with `dashboardInfo` containing `metricsId` arrays.
    *   `update` also now stores `previousValue` of `dashboard_metrics` for auditing purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\export.query.ts` (Multiple timestamps: 10/28/2025, 3:38:52 PM; 10/28/2025, 3:40:05 PM; 10/29/2025, 10:08:47 AM; 10/29/2025, 10:09:05 AM; 10/29/2025, 10:10:01 AM; 10/29/2025, 1:52:59 PM; 10/29/2025, 1:55:14 PM; 10/29/2025, 6:03:39 PM; 10/29/2025, 9:02:36 PM; 10/29/2025, 9:05:19 PM; 10/29/2025, 9:10:49 PM; 10/29/2025, 9:13:06 PM; 10/29/2025, 9:13:55 PM; 10/29/2025, 9:14:05 PM; 10/29/2025, 9:14:24 PM; 10/29/2025, 9:20:47 PM; 10/29/2025, 9:23:10 PM; 10/29/2025, 9:26:50 PM; 10/29/2025, 9:28:16 PM; 10/29/2025, 9:30:56 PM):**
    *   This file defines SQL query snippets for various booking-related reports, including "Booking Date to Actual Departure" (and its stacked bar and MBL-wise variants), "Booking Date to Estimated Departure," and "Booking Date to POD Arrival."
    *   A significant and recurring change across several timestamps is the addition and modification of the "Container Shipped (MBL Wise)" and "Containers Shipped (MBL Wise)" report queries.
    *   Initially, the "Container Shipped (MBL Wise)" queries directly selected columns. Later, around **10/29/2025, 9:02:36 PM**, a new report "Containers Shipped (Mbl Wise)" was introduced, which seems to focus on aggregated quarterly data (This Quarter, Last Quarter) based on `final_delivery_date`.
    *   Further updates around **10/29/2025, 9:13:06 PM** refined the "Containers Shipped (Mbl Wise)" query to use `final_delivery_date` in the `CASE` statements for quarter determination and added `TO_CHAR(DATE_TRUNC('month', final_delivery_date), 'MM') AS month` for grouping, indicating a shift towards monthly aggregated data within quarters for this specific report.
    *   Finally, at **10/29/2025, 9:28:16 PM**, the `TO_CHAR` format was changed from 'MM' to 'Mon' for month representation. The `Container Shipped (MBL Wise)` report (without 's') was also modified to directly select columns and include `final_delivery_date` and `quarter` calculations.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Multiple timestamps: 10/28/2025, 3:49:50 PM; 10/28/2025, 3:50:57 PM):**
    *   This file handles fetching metric lists and dashboard endpoints.
    *   `getMetricList` groups metrics by `filter_by` ('Container_Wise', 'MBL_Wise') and applies a `checked` status if a metric is part of a preloaded dashboard.
    *   `dashboardEndPointList` fetches selected metrics for a dashboard, sorts them according to a saved sequence, and includes `rowSpan` and `columnSpan` for each report, implying dashboard layout customization.
    *   `saveSequence` saves the order of reports for a dashboard.
    *   `saveSize` is a new endpoint added (around 10/28/2025, 3:49:50 PM) to persist `columnSpan` and `rowSpan` for individual metrics within a dashboard. This introduces layout customization capabilities for metrics.
    *   Minor log additions (`console.log("===jhjkkk",metricsListData);`) were made at **10/28/2025, 3:50:57 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\mbls.query.ts` (Multiple timestamps: 10/28/2025, 4:22:21 PM to 10/29/2025, 12:17:47 PM):**
    *   This file provides query builders for MBL-related analytics.
    *   Initial changes (10/28/2025, 4:22:21 PM) included `ContainerShippedMblWise` and `TotalShipmentsMblWise` which provided shipment and container/MBL counts.
    *   At **10/28/2025, 5:05:54 PM**, the `TotalShipmentsMblWise` type was renamed to `TotalShipments` and `ContainerShippedMblWise` was significantly refactored to calculate container counts by "Current Quarter", "Last Quarter", and "Other" based on delivery dates, using dynamically calculated quarter start/end dates. This indicates a shift towards more time-based, aggregated reporting for containers.
    *   Subsequent changes refined the quarter calculation logic, specifically around the definition of "This Quarter" and "Last Quarter" to cover an 8-month window (last 4 months + this 4 months) at **10/29/2025, 10:35:41 AM**.
    *   `customizer.calType` was set to "avg" and `customizer.dateColumns` was updated to `['Month', 'TEU']` (10/29/2025, 11:38:49 AM and 10/29/2025, 12:17:47 PM), suggesting a change in how MBL-wise container shipment data is displayed or calculated in the UI.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Multiple timestamps: 10/28/2025, 5:09:46 PM to 10/29/2025, 1:17:31 PM):**
    *   This controller acts as a dispatcher for various analytics reports, invoking specific query builders (`chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`, `mblQueryBuilder`) based on the `type` parameter.
    *   A key pattern observed is the introduction and refinement of `codeCustomization` flag, which determines if the data processing is handled within the controller or by direct database queries.
    *   The `ContainerShippedMblWise` report (handled by `mblQueryBuilder`) initially had `codeCustomization = true` (10/28/2025, 5:09:46 PM). This flag was later removed from the `mblQueryBuilder` call itself (10/28/2025, 5:12:32 PM, by commenting it out), and then explicitly set in the controller around **10/29/2025, 10:23:17 AM**, indicating a decision to handle its data processing directly in the `mblQueryBuilder` and prevent the default `query(mainQuery)` execution path in the `others.controller.ts`.
    *   At **10/29/2025, 11:23:41 AM**, a line `customizer.chartType = "StackedBar";` was temporarily added directly in the controller before the `mblQueryBuilder` call, but then removed in the subsequent commit (10/29/2025, 11:23:55 AM) as it was moved into the `mbls.query.ts` file itself.
    *   At **10/29/2025, 1:14:39 PM**, `ContainerShippedMblWise` was added to the `bookingQueryBuilder`'s `else if` block, which seems like an erroneous change, as `ContainerShippedMblWise` is handled by `mblQueryBuilder`. This was rectified at **10/29/2025, 1:17:31 PM** by commenting out the `mblQueryBuilder` call entirely, temporarily removing its custom handling, allowing it to fall through to the generic query execution path. This indicates some back-and-forth on how `ContainerShippedMblWise` should be handled.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.export.controller.ts` (Multiple timestamps: 10/29/2025, 1:36:20 PM to 10/29/2025, 9:34:16 PM):**
    *   This controller handles exporting analytics data.
    *   It retrieves export parameters like date ranges, report name, company name, stacked bar details, and selected columns.
    *   It includes a `replaceColumnHandler` function to standardize "LONG BEACH" to "LOS ANGELES" for `pod` and `place_of_delivery` fields.
    *   A new feature was added to save user-selected columns for reports (`saveColumns`).
    *   It distinguishes between `booking` and `nonBooking` queries and uses respective query builders from `export.query.ts`.
    *   Around **10/29/2025, 6:05:52 PM**, the construction of `mainQuery` for booking reports was modified to ensure the `customQuery` part (which sometimes starts with a comma) is correctly prepended with a comma if missing, and to ensure date filters are applied.
    *   The most significant update occurs around **10/29/2025, 6:26:45 PM**, where the logic for constructing the `mainQuery` for `isBooking` reports was heavily revised. It now conditionally adds the `WHERE` clause or `AND` clause for date filtering based on whether `customQuery` already contains a `WHERE` clause, fixing a potential SQL syntax issue.
    *   Finally, at **10/29/2025, 9:33:01 PM**, a dedicated `if (isContainerShippedReport)` block was added for the "Containers Shipped (MBL Wise)" report to handle its complex aggregated query logic directly within this controller, utilizing a `WITH` clause and specific grouping/ordering for monthly and quarterly data. This indicates that this specific report requires special aggregation logic that cannot be dynamically generated by the general `bookingQuery` function.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Multiple timestamps: 10/29/2025, 11:23:09 AM to 10/29/2025, 5:40:54 PM):**
    *   This file contains query builders for various booking-related reports.
    *   Each report type (`BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`) has specific SQL queries defined.
    *   There are numerous minor changes (e.g., adding `logger.info`, `console.log`) throughout the timestamps in this file, often reflecting debugging or logging additions rather than functional changes to the SQL queries themselves.
    *   The core structure of these booking-related queries remains consistent: they calculate day differences between dates, aggregate data, and use `DISTINCT ON` clauses for specific entities (fileno, contno, mblno) to avoid duplicates, followed by calculations of percentages relative to a maximum value. Stacked bar versions use `DATE_TRUNC` for time-series grouping.

**Patterns and Recurring Elements:**

1.  **Analytics and Reporting Focus:** All changes are concentrated on analytics features, including dashboard management, metric display, data export, and specialized query generation for various reports.
2.  **Database Interaction:** Extensive use of `query` function (likely a PostgreSQL client) to interact with `dashboards`, `metrics`, `mtr_tracking_data`, and `agent_booking_entry` tables.
3.  **Auditing:** Introduction of an explicit auditing mechanism (`logAudit`) for dashboard operations, highlighting a focus on data governance and tracking.
4.  **Dashboard Customization:** Features to customize dashboards, including ordering of metrics (`saveSequence`) and adjusting their size/span (`saveSize`), implying a flexible UI for analytics.
5.  **Query Parameterization & Dynamic SQL Generation:** Many queries are dynamically built using template literals and parameters from the request (`CompanyName`, `fromDate`, `toDate`, `filterBy`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, `displayBy`). This allows for flexible reporting based on user input.
6.  **Date and Time-based Analytics:** Frequent use of `EXTRACT(DAY FROM ...)` and `DATE_TRUNC` functions in SQL queries for calculating time differences and grouping data by time periods (day, month, week, quarter). Dynamic calculation of quarter start/end dates is also a recurring pattern in `mbls.query.ts`.
7.  **Data Transformation/Normalization:** The `replaceColumnHandler` in `core.export.controller.ts` demonstrates a pattern of transforming specific data values (e.g., "LONG BEACH" to "LOS ANGELES") before sending the response, suggesting data standardization for consistency.
8.  **MBL-Wise vs. Container-Wise Grouping:** Queries often include logic to handle both "MBL Wise" and "Container Wise" data, usually distinguished by the `mblwise` parameter and different `DISTINCT ON` clauses or grouping criteria.
9.  **Error Handling:** `try...catch` blocks are consistently used in controllers to handle potential errors and return a 500 "Internal Server Error" response.
10. **Logging:** Frequent use of `logger.info` and `logger.error` for debugging and operational visibility, particularly for generated SQL queries and error scenarios.
11. **Refinement and Iteration:** Multiple changes to the same files, especially `export.query.ts` and `mbls.query.ts`, indicate an iterative process of refining SQL queries, fixing bugs (e.g., the `customQuery` comma issue), and enhancing report logic. The `ContainerShippedMblWise` report, in particular, underwent several structural changes from a simple count to a more complex quarterly aggregation, and its handling shifted between `mbls.query.ts` and `core.export.controller.ts`, indicating evolving requirements or architectural decisions for that specific report.