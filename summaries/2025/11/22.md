# Activity Summary for 11/22/2025

## 9:11:11 AM
The `usercard.tsx` file, updated on 11/21/2025, 10:15:47 AM, primarily refines the user logout mechanism and user display logic. The `handleLogout` function has been significantly modified:
- Previously, it conditionally removed user data and tokens after redirection/navigation.
- The updated logic for Auth0 users now clears `token`, `user`, and dispatches `auth/logout` **before** redirecting to the login page (`${link}/login`) instead of the logout endpoint (`${link}/logout`).
- For non-Auth0 users, the `token`, `user` are cleared, `auth/logout` dispatched, and then navigates to the root path (`/`).
The component displays the user's initials, first name, last name, and role, prioritizing `first_name` and `last_name` from a fetched user preference query (`data`) over local storage data.

The `layout.tsx` file, updated shortly after on 11/21/2025, 10:20:01 AM, introduces robust session management and role-based customer selection logic.
- It includes an `isTokenExpired` function to check if the `exp` timestamp in the `localUser` from `localStorage` has passed the current time.
- An `useEffect` hook runs on component mount to check for token expiration; if expired, it clears `user` and `token` from `localStorage` and redirects the user to the root path (`/`). If the token is valid, it dispatches `initializeSelectedCustomer()`.
- A second `useEffect` hook dynamically manages the `selectedCustomer` state based on the user's role:
    - If the user role is "CUSTOMER", it sets `selectedCustomer` to their `companyname` and stores it in `localStorage`.
    - If the user role is "ADMIN_V2", it clears `selectedCustomer` (sets to `null`) and removes it from `localStorage`.
- The layout conditionally renders an `Outlet` (for child routes) only if a `selectedCustomer` is present. Otherwise, if the user is an "ADMIN_V2", it displays a message prompting them to select a customer.

**Patterns and Recurring Elements:**
- **`localStorage` Dependency:** Both files extensively use `localStorage` to persist and retrieve user data (`user`, `token`, `authtype`) and `selectedCustomer` state across sessions.
- **Redux Integration:** Both components interact with a Redux store, using `useDispatch` for actions like `auth/logout`, `initializeSelectedCustomer`, and `setSelectedCustomer`, and `useSelector` to retrieve state (`selectedCustomer`).
- **`react-router-dom` for Navigation:** Both files utilize `useNavigate` for programmatic navigation, typically for redirection after login/logout or to specific routes.
- **Role-Based Logic:** Both components implement logic that varies based on the user's role (e.g., "CUSTOMER", "ADMIN_V2", "auth0" vs. normal logout).
- **Session Management:** The changes indicate a focus on improving user session management, including logout procedures and token expiration handling.
- **Timestamp Proximity:** The timestamps suggest these changes were made in a concentrated development effort, likely as part of a single feature or bug fix related to user authentication and session management.

## 9:11:19 AM
**c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js**
On 11/21/2025 at 11:31:13 AM and again at 11:34:00 AM, the `App.js` file was updated (or saved identically). This file serves as the central routing configuration for a large React application. It imports a vast array of screens and components, indicating a comprehensive system covering user management, supply chain logistics (e.g., packing lists, BOLs, POs, OTM BOLs), financial processes (e.g., service invoices, expense codes, commercial invoices, CNG invoices), planning (planboards), and various tracking functionalities (FCL, LCL, Rail, Air, Trucking). The application extensively uses `react-router-dom` for navigation, `ProtectedRoute` for role-based access control leveraging `UserRoleEnum` (roles include `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`), and `AuthGuard` for initial authentication flows (login, callback, registration). The routes are deeply nested, following a pattern of listing pages and corresponding form screens (e.g., `/spr/packing_list` and `/spr/packing_list/form`). A debug console log `TEST on Flow` is present, indicating active development or testing. The content for both timestamps is identical, suggesting no functional changes were introduced between these two logged instances.

**c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx**
On 11/21/2025 at 11:36:28 AM, the `MetricsBox.jsx` component was updated. This component is designed for displaying various analytical charts within the application. It imports multiple chart types (Pie, Bar, Line, Stacked Bar, Gauge) and related utility components (`MetricToolbar`, `MetricFooter`, `ThemedModal`, `NoDataAvailable`). The component dynamically renders different chart visualizations based on `item.chartType` and `chartView` state, supporting types like "General", "StackBar", "Transit", and "Count". It also includes functionality for displaying charts in a full-screen modal, dynamically adjusting chart height for larger views, and provides a toolbar for user interaction (e.g., changing chart views). Data for the initial chart render is limited to the first 9 entries, while the full-screen view utilizes all available data. The presence of `console.log` statements within the component suggests recent debugging activities.

**Patterns and Recurring Elements:**
*   **Extensive Role-Based Access Control:** The `App.js` file demonstrates a strong emphasis on security and authorization through the widespread use of `ProtectedRoute` and a detailed `UserRoleEnum`, covering a broad spectrum of user types within the system.
*   **Comprehensive Feature Set:** The sheer volume of routes and imported screens across different domains (user management, logistics, finance, planning, analytics, tracking) points to a large, enterprise-grade application with a rich feature set.
*   **Modular Component Architecture:** The application follows a component-based approach with React, organizing UI and functionality into distinct, reusable components, such as the `MetricsBox` for analytics.
*   **Debugging Practices:** `console.log` statements found in both `App.js` and `MetricsBox.jsx` indicate ongoing development, testing, or recent debugging sessions.
*   **Data Visualization Focus:** The `MetricsBox.jsx` component highlights a significant focus on data analytics and visualization, offering various chart types and interactive features for displaying metrics.
*   **Consistent Routing Structure:** Many routes follow a `/<feature>/<sub-feature>` or `/<feature>/<sub-feature>/form` pattern, suggesting a systematic approach to navigation for listing and editing data.

## 9:11:22 AM
The code changes primarily focus on two areas: refining company data retrieval and implementing/updating HBL (House Bill of Lading) entry and management. All recorded changes occurred on **11/21/2025**.

### File-Specific Updates:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
   - **Timestamp 1 (11/21/2025, 10:07:54 AM):** The `getAll` function was implemented to retrieve company names based on user roles. For `AGENT` users, it fetches distinct company names (`cname`) from `agent_po_account_master`. For `CUSTOMER` users, it fetches distinct `account_name` from `mtr_tracking_data`. This function includes pagination logic (using `LIMIT` and `OFFSET`) for `CUSTOMER` if `pagination` is `true`, otherwise, it defaults to a limit of 10. Debugging `console.log` statements were present.
   - **Timestamp 2 (11/21/2025, 10:08:08 AM):** This update was minor, primarily removing the `console.log` statements that were present in the `CUSTOMER` role's pagination logic. The core functionality remained the same.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
   - **Timestamp 1 (11/21/2025, 11:40:37 AM):** Several new routes related to OTM BOL (Bill of Lading) functionality were added or confirmed. These include `excel_data`, fetching `PLPOByBOL`, `fetch_payload`, `fetchByBOLNo`, `editOtmBol`, `upload_save_edit`, `fetchByCommonKey`, `generateXML`, and `sendToOTM`. Notably, a `POST /upload` route, likely for excel file uploads, was commented out, suggesting a change in file upload strategy or a temporary disablement.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
   - **Timestamp 1 (11/21/2025, 3:11:14 PM):** Introduced `createHblMasterBooking` and `saveHblBooking` functions.
     - `createHblMasterBooking` handles the creation of new HBL master entries with extensive payload sanitization and database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`). Error handling used `next(new HttpError(...))`.
     - `saveHblBooking` manages both adding and updating HBL bookings. Updates involve fetching current data (booking, vessel, routing, container, HBL, PO) before applying changes and logging both old and new states into `agent_booking_hbl_history`. Sub-collections like routing, containers, and POs are handled by `DELETE` followed by `INSERT` operations. New bookings generate a unique `agent_booking_id`.
   - **Timestamp 2 (11/21/2025, 3:13:11 PM):** The error handling in `createHblMasterBooking` was changed from sending an `HttpError` via `next()` to simply logging the error (`logger.error(error);`). This change means the API would no longer return a 500 response for errors in this function.
   - **Timestamp 3 (11/21/25, 3:16:23 PM):** In the `saveHblBooking` function, the `bookingdate` field within the `bookingInsertQuery` object was updated to explicitly handle `null` values (`payload.booking_date || null`), ensuring that if `bookingdate` is not provided, it is stored as `null`.
   - **Timestamp 4 (11/21/2025, 3:17:07 PM):** Similarly, in the `createHblMasterBooking` function, the `bookingdate` field in the initial `payload` definition was updated to accept `null` (`AppDateFormate(req.body.bookingdate, db_format) || null`).
   - **Timestamp 5 (11/21/2025, 3:19:06 PM):** A significant change in `createHblMasterBooking` involved commenting out the `bookingdate` field from the `payload` object, meaning this field will no longer be processed or stored when creating HBL master bookings via this specific function.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
   - **Timestamp 1 (11/21/2025, 3:11:42 PM):** The initial route definition included two `POST /` routes for `saveHblBooking` and `createHblMasterBooking`. This configuration would have caused `createHblMasterBooking` to be unreachable.
   - **Timestamp 2 (11/21/2025, 3:19:52 PM):** The routing conflict was resolved by changing the `createHblMasterBooking` route from `POST /` to `POST /create`. Now `saveHblBooking` handles `POST /` and `createHblMasterBooking` is accessible via `POST /create`.

### Patterns and Recurring Elements:

- **Consistent Timestamp:** All changes were logged on the same day, **November 21, 2025**, indicating a concentrated period of development.
- **Role-Based Data Access:** The `company_details.controller.ts` demonstrates a clear pattern of implementing different data retrieval logic based on user roles (`AGENT` vs. `CUSTOMER`).
- **Pagination Support:** Explicit support for pagination (`LIMIT`, `OFFSET`, `total` count) is implemented in `company_details.controller.ts` for handling larger datasets efficiently.
- **Robust Data Handling in HBL:** The `hblEntry.controller.ts` consistently uses database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure data integrity during complex multi-table operations.
- **Extensive Input Sanitization:** All incoming request body data for HBL entries is rigorously sanitized using `sanitizeString()` before database operations.
- **Detailed Logging and History:** Both `logger.info` and `logger.error` are frequently used across controllers for debugging and operational insights. Furthermore, a specific `agent_booking_hbl_history` table is utilized to maintain an audit trail of HBL booking updates, storing both the original and modified data.
- **Handling of Nullable Dates:** A recurring pattern in `hblEntry.controller.ts` is the explicit handling of nullable date fields using `AppDateFormate(..., db_format) || null`.