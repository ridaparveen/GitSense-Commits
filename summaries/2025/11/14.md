# Activity Summary for 11/14/2025

## 9:25:52 AM
The changes log details a day of active development across several backend services, focusing primarily on data retrieval, filtering, and reporting functionalities. All modifications occurred on **November 13, 2025**.

Here's a breakdown of the key information by file:

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
*   **11/13/2025, 10:50:09 AM:** This version established the core functionalities for managing user-scheduled reports.
    *   `setReport`: Handles the creation of new user reports, inserting data into the `v2_user_reports` table with support for optional fields.
    *   `fetchScheduledReports`: Retrieves active scheduled reports for a given user, with optional filtering by report ID or company name. It includes a `timeZoneConverter` utility to adjust date and time based on the report's specified timezone.
    *   `editReport`: Allows updating existing scheduled reports.
*   **11/13/2025, 11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where the `companyName` filter incorrectly tried to use `req.query.id` instead of `req.query.CompanyName`. A `console.log` was added for debugging.
*   **11/13/2025, 11:06:07 AM:** The bug in `fetchScheduledReports` was fixed, restoring the correct `companyName` extraction from `req.query.CompanyName`. The `console.log` remained.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
*   **11/13/2025, 11:21:33 AM:** This version introduced robust report history management.
    *   `saveReportHistory`: Saves detailed report execution parameters and status into `public.v2_report_history` using secure parameterized queries.
    *   `getReportHistory`: Retrieves report history with comprehensive filtering options (user ID, name, date range, status, company name), pagination, and sorting. It also uses parameterized queries and calculates total pages.
*   **11/13/2025, 11:22:34 AM:** A `console.log` statement was added to `getReportHistory` for debugging purposes.
*   **11/13/2025, 3:13:42 PM:** The `console.log` statement in `getReportHistory` was removed, reverting the code to its state at 11:21:33 AM.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
*   **11/13/2025, 2:56:24 PM:** This initial commit for the dashboard service provided core functions:
    *   `getDashboardCardInfo`: Retrieves key shipment metrics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents from `mtr_tracking_data`, with filters for date range and company name.
    *   `getDeliveryData`: Fetches either delivery or vessel arrival data, supporting different delivery modes (ALL, Rail, Door, Port Delivery).
*   **11/13/2025, 2:56:30 PM:** Minor, non-functional changes.
*   **11/13/2025, 2:56:43 PM:** The `getDeliveryData` function was updated to apply user-specific conditions (`useWhere`) to the `sqlQueryDelivery` for enhanced access control.
*   **11/13/2025, 2:58:05 PM:**
    *   `getDeliveryData`: The logic for applying `companyFilter` was refined, now using `useWhere` if no specific `CompanyName` is provided. The `SqlQueryVesselArrival` was also updated to explicitly use `useWhere`.
    *   Removed a commented-out block for `CompanyName` in `getDashboardCardInfo`.
*   **11/13/2025, 2:59:21 PM:**
    *   `getDashboardCardInfo`: The `CompanyName` filter was removed from the `baseQuery`, potentially relying solely on `useWhere` being pushed to `conditions` (though this explicit push was missing in this version).
*   **11/13/2025, 3:04:35 PM:**
    *   `getDashboardCardInfo`: Reintroduced and clarified `CompanyName` filtering. `useWhere` is now explicitly added to `conditions`, and `CompanyName` is correctly added as a condition if provided, ensuring proper filtering. A `console.log` was removed.
*   **11/13/2025, 3:05:15 PM:** Minor update to a logging message in `getDashboardCardInfo`. Another `console.log` was removed.
*   **11/13/2025, 3:05:33 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:06:20 PM:** A `console.log(error);` statement was removed from the `catch` block of `getDeliveryData`.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
*   **11/13/2025, 3:06:59 PM:** This significant update introduced the `BookingQueryBuilder` class, a refactor to centralize booking query construction.
    *   The `getAll` function now leverages `BookingQueryBuilder` to fetch bookings, supporting extensive filtering (pagination, sorting, status, POL, POD, shipper, booking type, CompanyName, date ranges).
    *   It also provides aggregated counts for various booking statuses and options for filter dropdowns.
    *   User role-based conditions (`userWhere`) are applied to filter bookings.
*   **11/13/2025, 4:46:10 PM:** In `getAll`, the `CompanyName` filter was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (partial, case-insensitive match), improving flexibility for `CompanyName` searches.
*   **11/13/2025, 4:59:17 PM:** The `BookingQueryBuilder` was enhanced to accept an optional `companyName` parameter in its constructor. This allows ADMIN and ADMIN_V2 users to explicitly filter bookings by a specific company. The `setWhereClause` was updated to incorporate this new filtering capability for admin roles.
*   **11/13/2025, 5:57:22 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
*   **11/13/2025, 3:08:39 PM:** This new file or significant update introduced `getAllBookingPlanbaord`, a function to visualize booking data on a plan board.
    *   It groups bookings by month or week, aggregates total weight and CBM, and determines date ranges for each group.
    *   Data is filtered by `selectedYear` and `CompanyName`.
    *   The `pointModifierForBooking` utility groups and sorts booking points by Port of Discharge (POD).
*   **11/13/2025, 3:09:00 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
*   **11/13/2025, 3:10:59 PM:** This file introduced the `SqlQueryBuilder` class, a sophisticated mechanism for constructing shipment tracking queries.
    *   It dynamically builds queries for 'ocean', 'air', or 'both' transport modes based on user filters.
    *   Includes detailed user role-based access controls for filtering (`ADMIN`, `CUSTOMER`, `FRONTOFFICE`, `AGENT`).
    *   Supports various filters like POL, POD, shipment ID, date range, container number, and CompanyName.
    *   Implements "card filters" for specific shipment statuses (e.g., 'pending_departure', 'in_transit') that apply targeted SQL conditions.
    *   Manages complex status conditions for both air and ocean shipments, mapping abstract statuses to granular database field checks.
    *   Utilizes parameterized queries (`$$` syntax converted to `$N`) for improved security.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
*   **11/13/2025, 3:12:03 PM:** This version introduced the `getAllCompanyDetails` function to fetch distinct company names for AGENT and CUSTOMER roles.
    *   It supports searching and, for `CUSTOMER` role, includes pagination with total count.
    *   Fetches from `agent_po_account_master` for agents and `mtr_tracking_data` for customers.
    *   Initial version contained several `console.log` statements for debugging.
*   **11/13/2025, 3:12:15 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:12:38 PM:** Updated pagination logic for `page` and `perPage` to use the nullish coalescing operator (`??`) for more robust handling of undefined or null query parameters.
*   **11/13/2025, 3:13:07 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
*   **11/13/2025, 3:57:57 PM:** This new utility file introduced `bookingQueryBuilder`, a function designed to construct analytical SQL queries specifically for booking data.
    *   It supports various calculation types like "BookingDatetoActualDeparture" (container-wise and MBL-wise) and their stacked bar chart representations.
    *   Calculates the day difference between booking and actual departure dates, categorizing results for visualization (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   Dynamically selects columns and applies filtering based on `CompanyName`, date ranges, and `displayBy` parameters.

**Patterns and Recurring Elements:**
*   **Query Builder Pattern:** A prominent pattern across `bookingService.ts` and `shipmentService.ts` is the adoption of dedicated "QueryBuilder" classes (`BookingQueryBuilder`, `SqlQueryBuilder`). This indicates a strategic effort to centralize SQL query logic, improve maintainability, enhance security (through parameterized queries), and manage complex filtering and access control.
*   **Company-Specific Filtering:** The ability to filter data by `CompanyName` is a critical and frequently updated feature, appearing in `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, `shipmentService.ts`, and `company-details-service.ts`. This suggests robust multi-tenancy or client-specific data access requirements.
*   **User Role-Based Access Control:** User roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) consistently influence the data retrieved across various services (`bookingService.ts`, `dashboardService.ts`, `shipmentService.ts`, `planbaordService.ts`), highlighting a fine-grained access control model.
*   **Debugging Practices:** Frequent additions and removals of `console.log` statements throughout the log, particularly in `dashboardService.ts` and `reportHistory.ts` during the earlier timestamps, suggest active and iterative debugging during the development process.
*   **Date and Time Handling:** Several services involve complex date and time processing, including timezone conversions (`scheduleReport.ts`) and date range filtering for analytical purposes (`dashboardService.ts`, `reportHistory.ts`, `booking.query.ts`, `planbaordService.ts`, `shipmentService.ts`).
*   **Logger Usage:** Extensive use of `logger.info` and `logger.error` is observed across all files, indicating a strong emphasis on logging for operational monitoring and troubleshooting.

## 9:26:00 AM
The log details recent development focusing on integrating and refining a customer selection mechanism across the application, along with general feature enhancements and bug fixes.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (11/13/2025, 3:15:38 PM - 4:38:13 PM & 5:43:05 PM):**
    *   **Initial Setup (3:15:38 PM):** The layout component ensures user authentication by checking token expiration and redirects if necessary. It also dispatches `initializeSelectedCustomer` and, for `CUSTOMER` roles, sets their company as the selected customer.
    *   **Conditional Rendering Introduced (4:31:01 PM onwards):** A significant change was introduced to conditionally render the main application content (`<Outlet />`) based on whether a `selectedCustomer` exists in the global Redux state. If no customer is selected, a placeholder message "Please select a customer." is displayed. Numerous subsequent commits (from 4:31:51 PM to 4:38:13 PM, and 5:43:05 PM) involve minor styling adjustments and the addition of an `BsInfoCircle` icon to this placeholder message, refining its appearance and alignment.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx` (11/13/2025, 3:16:14 PM & 4:26:07 PM & 4:33:08 PM):**
    *   **Customer Selection for Admins (3:16:14 PM):** Initially, the `SelectCustomerPanel` was conditionally rendered for `ADMIN_V2` users.
    *   **Temporary Menu Hiding (4:26:07 PM):** A change was introduced to hide the entire sidebar menu for `ADMIN_V2` users if no `selectedCustomer` was set, displaying a message instead.
    *   **Reversion (4:33:08 PM):** This conditional hiding of the sidebar menu was reverted, so the menu is always visible, and only the `SelectCustomerPanel` remains conditional for `ADMIN_V2`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (11/13/2025, 3:16:47 PM):**
    *   This file saw a major update to its PDF export functionality. Two older, commented-out PDF generation methods were replaced with a new, more robust implementation using `jsPDF` and `html2canvas-pro`. The new function includes logic to capture dashboard content, convert it to an image, add a logo, and save it as a PDF, with proper loading state management. It also explicitly shows `SelectCustomerPanel` based on user permissions.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx` (11/13/2025, 3:17:47 PM - 5:53:52 PM):**
    *   **Initial Conditional Rendering (3:17:47 PM):** The booking dashboard content was initially conditional on `selectedCustomer`, displaying a message if none was chosen. The `CompanyName` parameter for the data query used `selectedCustomer || localUser?.companyname`.
    *   **Removal of Conditional Rendering (4:27:00 PM):** This conditional rendering of the main dashboard content was removed, making the content always visible.
    *   **API Parameter Refinement (4:50:11 PM, 5:53:52 PM):** The `CompanyName` parameter in the `useFetchBookingDashboardDataQuery` was first changed to `selectedCustomer || ""` (removing the `localUser` fallback) and later to `selectedCustomer || undefined`, indicating a preference for truly optional API parameters over empty strings or fallback values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\planboard\PlanboardCardView.tsx` (11/13/2025, 3:18:16 PM & 3:18:22 PM):**
    *   This component remained largely stable, responsible for displaying planboard data based on selected view (year/month) and year, always considering the `selectedCustomer` for data fetching.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts` (11/13/2025, 3:18:43 PM):**
    *   This configuration file defines the static sidebar menu structure. It includes a rule to disable "Preferences" for `ADMIN_V2` roles and a conditional "Dev" section based on the `VITE_MODE` environment variable.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (11/13/2025, 3:19:32 PM - 5:54:28 PM):**
    *   **API Parameter Refinement (5:54:28 PM):** The `CompanyName` parameter for `useFetchDeliveryDataQuery` was updated from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, aligning with the pattern of making this parameter optional. Other dashboard API calls retain the `localUser` fallback.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx` (11/13/2025, 3:20:12 PM & 5:42:25 PM):**
    *   **Initial Conditional Rendering (3:20:12 PM):** Similar to booking, planboard content was initially hidden if no `selectedCustomer` was set.
    *   **Removal of Conditional Rendering (5:42:25 PM):** This conditional rendering was removed, making the planboard content always visible.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx` (11/13/2025, 3:20:39 PM & 5:41:46 PM):**
    *   This page consistently uses `selectedCustomer ?? undefined` for the `CompanyName` parameter in `useGetReportHistoryQuery`, maintaining its logic throughout the changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx` (11/13/2025, 3:20:56 PM - 5:49:14 PM):**
    *   **Initial Conditional Rendering (3:20:56 PM):** The page content was initially conditional on `selectedCustomer`.
    *   **Removal of Conditional Rendering (5:47:04 PM):** The main content is now always rendered.
    *   **API Parameter Refinement (5:47:04 PM, 5:49:14 PM):** The `CompanyName` parameter for both `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was updated, initially removing `localUser` fallback, and eventually using `selectedCustomer || undefined` to make it optional.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx` (11/13/2025, 3:21:09 PM & 5:48:09 PM):**
    *   **API Parameter Refinement (5:48:09 PM):** The `CompanyName` parameter for `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was changed from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, ensuring consistent optional parameter handling.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts` (11/13/2025, 3:23:14 PM & 3:23:24 PM):**
    *   This file provides various static status and filter options with associated colors for shipments, air shipments, reports, team members, and bookings. No significant functional changes were made.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx` (11/13/2025, 5:01:14 PM - 5:35:37 PM):**
    *   **Complex Conditional Rendering and API Guards (Repeated changes throughout):** This file saw the most volatile changes, particularly regarding the conditional rendering of `AnalyticsContainer` and the API calls within its `useEffect`.
        *   The logic for displaying a "Please Select Any Customer" message versus `AnalyticsContainer` for `ADMIN_V2` users was repeatedly toggled and refined, aiming for `ADMIN_V2` users to only see analytics when a customer is selected.
        *   Guard clauses (`if (!user?.userid || !mainState.selectedDashobard || !selectedCustomer) return;`) were added and removed from the main data fetching `useEffect`, indicating an ongoing effort to prevent API calls with incomplete parameters.
        *   The `companyname` parameter in analytics API queries consistently uses `selectedCustomer`.
        *   The global `setLoading` state from `global-slice.ts` was integrated for loading indicators.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts` (11/13/2025, 5:05:40 PM):**
    *   This new Redux slice was introduced to manage application-wide state. It centralizes `selectedCustomer` (with `localStorage` persistence) and a general `loading` boolean, allowing these states to be easily accessed and modified across the application.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx` (11/13/2025, 5:37:21 PM - 5:54:48 PM):**
    *   **Customer-Based Fetching (5:37:21 PM):** The component fetches notification data based on `selectedCustomer || ""`.
    *   **Minor Refinements (5:38:36 PM - 5:54:48 PM):** Subsequent changes involve minor bug fixes like explicitly checking for `mblno` before navigation, briefly changing and then reverting the loading skeleton count, removing a duplicate `useNavigate` import, and refining a prop type definition.

**Patterns and Recurring Elements:**

1.  **Centralized Customer Context (`selectedCustomer`):** The most significant pattern is the extensive use of `selectedCustomer` from a global Redux slice. This state variable dictates data fetching parameters and conditional UI rendering across almost all application pages and core components, indicating a strong emphasis on a multi-customer architecture where data is always filtered by the currently selected customer.
2.  **API Query Parameter Normalization:** There's a clear trend of updating API query parameters for `CompanyName` from `selectedCustomer || localUser?.companyname` or `selectedCustomer || ""` to `selectedCustomer || undefined`. This suggests a move towards standardizing how optional company-specific data is requested, preferring `undefined` for omitted parameters rather than empty strings or user-specific fallbacks, which typically leads to cleaner API behavior.
3.  **Conditional Content Rendering:** Many pages (`layout.tsx`, `booking-dashboard.tsx`, `planboard-page.tsx`, `shipment-container-page.tsx`, `analytics-page.tsx`) initially included or frequently adjusted logic to hide primary content and display a "Please select a customer" message if no customer was chosen, especially for administrative roles. While this was sometimes added and then reverted in some files (e.g., `booking-dashboard.tsx`, `planboard-page.tsx`), the `layout.tsx` and `analytics-page.tsx` show a sustained effort to enforce this behavior for admin users.
4.  **Redux for Global State Management:** The introduction of `global-slice.ts` formalizes the management of application-wide concerns like `selectedCustomer` and a general `loading` state, demonstrating a commitment to a predictable state management pattern.
5.  **UI/UX Refinements:** Numerous small changes related to styling (`className` adjustments, icon additions) suggest an ongoing iterative process of improving the user interface and experience.
6.  **Loading Indicators:** Consistent use of loading states and components (`Loader`, `Spinner`, skeleton loaders) indicates attention to user feedback during data fetching operations.