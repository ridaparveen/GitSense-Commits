# Activity Summary for 11/14/2025

## 9:25:52 AM
The changes log details a day of active development across several backend services, focusing primarily on data retrieval, filtering, and reporting functionalities. All modifications occurred on **November 13, 2025**.

Here's a breakdown of the key information by file:

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
*   **11/13/2025, 10:50:09 AM:** This version established the core functionalities for managing user-scheduled reports.
    *   `setReport`: Handles the creation of new user reports, inserting data into the `v2_user_reports` table with support for optional fields.
    *   `fetchScheduledReports`: Retrieves active scheduled reports for a given user, with optional filtering by report ID or company name. It includes a `timeZoneConverter` utility to adjust date and time based on the report's specified timezone.
    *   `editReport`: Allows updating existing scheduled reports.
*   **11/13/2025, 11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where the `companyName` filter incorrectly tried to use `req.query.id` instead of `req.query.CompanyName`. A `console.log` was added for debugging.
*   **11/13/2025, 11:06:07 AM:** The bug in `fetchScheduledReports` was fixed, restoring the correct `companyName` extraction from `req.query.CompanyName`. The `console.log` remained.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
*   **11/13/2025, 11:21:33 AM:** This version introduced robust report history management.
    *   `saveReportHistory`: Saves detailed report execution parameters and status into `public.v2_report_history` using secure parameterized queries.
    *   `getReportHistory`: Retrieves report history with comprehensive filtering options (user ID, name, date range, status, company name), pagination, and sorting. It also uses parameterized queries and calculates total pages.
*   **11/13/2025, 11:22:34 AM:** A `console.log` statement was added to `getReportHistory` for debugging purposes.
*   **11/13/2025, 3:13:42 PM:** The `console.log` statement in `getReportHistory` was removed, reverting the code to its state at 11:21:33 AM.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
*   **11/13/2025, 2:56:24 PM:** This initial commit for the dashboard service provided core functions:
    *   `getDashboardCardInfo`: Retrieves key shipment metrics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents from `mtr_tracking_data`, with filters for date range and company name.
    *   `getDeliveryData`: Fetches either delivery or vessel arrival data, supporting different delivery modes (ALL, Rail, Door, Port Delivery).
*   **11/13/2025, 2:56:30 PM:** Minor, non-functional changes.
*   **11/13/2025, 2:56:43 PM:** The `getDeliveryData` function was updated to apply user-specific conditions (`useWhere`) to the `sqlQueryDelivery` for enhanced access control.
*   **11/13/2025, 2:58:05 PM:**
    *   `getDeliveryData`: The logic for applying `companyFilter` was refined, now using `useWhere` if no specific `CompanyName` is provided. The `SqlQueryVesselArrival` was also updated to explicitly use `useWhere`.
    *   Removed a commented-out block for `CompanyName` in `getDashboardCardInfo`.
*   **11/13/2025, 2:59:21 PM:**
    *   `getDashboardCardInfo`: The `CompanyName` filter was removed from the `baseQuery`, potentially relying solely on `useWhere` being pushed to `conditions` (though this explicit push was missing in this version).
*   **11/13/2025, 3:04:35 PM:**
    *   `getDashboardCardInfo`: Reintroduced and clarified `CompanyName` filtering. `useWhere` is now explicitly added to `conditions`, and `CompanyName` is correctly added as a condition if provided, ensuring proper filtering. A `console.log` was removed.
*   **11/13/2025, 3:05:15 PM:** Minor update to a logging message in `getDashboardCardInfo`. Another `console.log` was removed.
*   **11/13/2025, 3:05:33 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:06:20 PM:** A `console.log(error);` statement was removed from the `catch` block of `getDeliveryData`.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
*   **11/13/2025, 3:06:59 PM:** This significant update introduced the `BookingQueryBuilder` class, a refactor to centralize booking query construction.
    *   The `getAll` function now leverages `BookingQueryBuilder` to fetch bookings, supporting extensive filtering (pagination, sorting, status, POL, POD, shipper, booking type, CompanyName, date ranges).
    *   It also provides aggregated counts for various booking statuses and options for filter dropdowns.
    *   User role-based conditions (`userWhere`) are applied to filter bookings.
*   **11/13/2025, 4:46:10 PM:** In `getAll`, the `CompanyName` filter was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (partial, case-insensitive match), improving flexibility for `CompanyName` searches.
*   **11/13/2025, 4:59:17 PM:** The `BookingQueryBuilder` was enhanced to accept an optional `companyName` parameter in its constructor. This allows ADMIN and ADMIN_V2 users to explicitly filter bookings by a specific company. The `setWhereClause` was updated to incorporate this new filtering capability for admin roles.
*   **11/13/2025, 5:57:22 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
*   **11/13/2025, 3:08:39 PM:** This new file or significant update introduced `getAllBookingPlanbaord`, a function to visualize booking data on a plan board.
    *   It groups bookings by month or week, aggregates total weight and CBM, and determines date ranges for each group.
    *   Data is filtered by `selectedYear` and `CompanyName`.
    *   The `pointModifierForBooking` utility groups and sorts booking points by Port of Discharge (POD).
*   **11/13/2025, 3:09:00 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
*   **11/13/2025, 3:10:59 PM:** This file introduced the `SqlQueryBuilder` class, a sophisticated mechanism for constructing shipment tracking queries.
    *   It dynamically builds queries for 'ocean', 'air', or 'both' transport modes based on user filters.
    *   Includes detailed user role-based access controls for filtering (`ADMIN`, `CUSTOMER`, `FRONTOFFICE`, `AGENT`).
    *   Supports various filters like POL, POD, shipment ID, date range, container number, and CompanyName.
    *   Implements "card filters" for specific shipment statuses (e.g., 'pending_departure', 'in_transit') that apply targeted SQL conditions.
    *   Manages complex status conditions for both air and ocean shipments, mapping abstract statuses to granular database field checks.
    *   Utilizes parameterized queries (`$$` syntax converted to `$N`) for improved security.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
*   **11/13/2025, 3:12:03 PM:** This version introduced the `getAllCompanyDetails` function to fetch distinct company names for AGENT and CUSTOMER roles.
    *   It supports searching and, for `CUSTOMER` role, includes pagination with total count.
    *   Fetches from `agent_po_account_master` for agents and `mtr_tracking_data` for customers.
    *   Initial version contained several `console.log` statements for debugging.
*   **11/13/2025, 3:12:15 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:12:38 PM:** Updated pagination logic for `page` and `perPage` to use the nullish coalescing operator (`??`) for more robust handling of undefined or null query parameters.
*   **11/13/2025, 3:13:07 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
*   **11/13/2025, 3:57:57 PM:** This new utility file introduced `bookingQueryBuilder`, a function designed to construct analytical SQL queries specifically for booking data.
    *   It supports various calculation types like "BookingDatetoActualDeparture" (container-wise and MBL-wise) and their stacked bar chart representations.
    *   Calculates the day difference between booking and actual departure dates, categorizing results for visualization (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   Dynamically selects columns and applies filtering based on `CompanyName`, date ranges, and `displayBy` parameters.

**Patterns and Recurring Elements:**
*   **Query Builder Pattern:** A prominent pattern across `bookingService.ts` and `shipmentService.ts` is the adoption of dedicated "QueryBuilder" classes (`BookingQueryBuilder`, `SqlQueryBuilder`). This indicates a strategic effort to centralize SQL query logic, improve maintainability, enhance security (through parameterized queries), and manage complex filtering and access control.
*   **Company-Specific Filtering:** The ability to filter data by `CompanyName` is a critical and frequently updated feature, appearing in `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, `shipmentService.ts`, and `company-details-service.ts`. This suggests robust multi-tenancy or client-specific data access requirements.
*   **User Role-Based Access Control:** User roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) consistently influence the data retrieved across various services (`bookingService.ts`, `dashboardService.ts`, `shipmentService.ts`, `planbaordService.ts`), highlighting a fine-grained access control model.
*   **Debugging Practices:** Frequent additions and removals of `console.log` statements throughout the log, particularly in `dashboardService.ts` and `reportHistory.ts` during the earlier timestamps, suggest active and iterative debugging during the development process.
*   **Date and Time Handling:** Several services involve complex date and time processing, including timezone conversions (`scheduleReport.ts`) and date range filtering for analytical purposes (`dashboardService.ts`, `reportHistory.ts`, `booking.query.ts`, `planbaordService.ts`, `shipmentService.ts`).
*   **Logger Usage:** Extensive use of `logger.info` and `logger.error` is observed across all files, indicating a strong emphasis on logging for operational monitoring and troubleshooting.

## 9:26:00 AM
The log details recent development focusing on integrating and refining a customer selection mechanism across the application, along with general feature enhancements and bug fixes.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (11/13/2025, 3:15:38 PM - 4:38:13 PM & 5:43:05 PM):**
    *   **Initial Setup (3:15:38 PM):** The layout component ensures user authentication by checking token expiration and redirects if necessary. It also dispatches `initializeSelectedCustomer` and, for `CUSTOMER` roles, sets their company as the selected customer.
    *   **Conditional Rendering Introduced (4:31:01 PM onwards):** A significant change was introduced to conditionally render the main application content (`<Outlet />`) based on whether a `selectedCustomer` exists in the global Redux state. If no customer is selected, a placeholder message "Please select a customer." is displayed. Numerous subsequent commits (from 4:31:51 PM to 4:38:13 PM, and 5:43:05 PM) involve minor styling adjustments and the addition of an `BsInfoCircle` icon to this placeholder message, refining its appearance and alignment.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx` (11/13/2025, 3:16:14 PM & 4:26:07 PM & 4:33:08 PM):**
    *   **Customer Selection for Admins (3:16:14 PM):** Initially, the `SelectCustomerPanel` was conditionally rendered for `ADMIN_V2` users.
    *   **Temporary Menu Hiding (4:26:07 PM):** A change was introduced to hide the entire sidebar menu for `ADMIN_V2` users if no `selectedCustomer` was set, displaying a message instead.
    *   **Reversion (4:33:08 PM):** This conditional hiding of the sidebar menu was reverted, so the menu is always visible, and only the `SelectCustomerPanel` remains conditional for `ADMIN_V2`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (11/13/2025, 3:16:47 PM):**
    *   This file saw a major update to its PDF export functionality. Two older, commented-out PDF generation methods were replaced with a new, more robust implementation using `jsPDF` and `html2canvas-pro`. The new function includes logic to capture dashboard content, convert it to an image, add a logo, and save it as a PDF, with proper loading state management. It also explicitly shows `SelectCustomerPanel` based on user permissions.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx` (11/13/2025, 3:17:47 PM - 5:53:52 PM):**
    *   **Initial Conditional Rendering (3:17:47 PM):** The booking dashboard content was initially conditional on `selectedCustomer`, displaying a message if none was chosen. The `CompanyName` parameter for the data query used `selectedCustomer || localUser?.companyname`.
    *   **Removal of Conditional Rendering (4:27:00 PM):** This conditional rendering of the main dashboard content was removed, making the content always visible.
    *   **API Parameter Refinement (4:50:11 PM, 5:53:52 PM):** The `CompanyName` parameter in the `useFetchBookingDashboardDataQuery` was first changed to `selectedCustomer || ""` (removing the `localUser` fallback) and later to `selectedCustomer || undefined`, indicating a preference for truly optional API parameters over empty strings or fallback values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\planboard\PlanboardCardView.tsx` (11/13/2025, 3:18:16 PM & 3:18:22 PM):**
    *   This component remained largely stable, responsible for displaying planboard data based on selected view (year/month) and year, always considering the `selectedCustomer` for data fetching.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts` (11/13/2025, 3:18:43 PM):**
    *   This configuration file defines the static sidebar menu structure. It includes a rule to disable "Preferences" for `ADMIN_V2` roles and a conditional "Dev" section based on the `VITE_MODE` environment variable.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (11/13/2025, 3:19:32 PM - 5:54:28 PM):**
    *   **API Parameter Refinement (5:54:28 PM):** The `CompanyName` parameter for `useFetchDeliveryDataQuery` was updated from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, aligning with the pattern of making this parameter optional. Other dashboard API calls retain the `localUser` fallback.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx` (11/13/2025, 3:20:12 PM & 5:42:25 PM):**
    *   **Initial Conditional Rendering (3:20:12 PM):** Similar to booking, planboard content was initially hidden if no `selectedCustomer` was set.
    *   **Removal of Conditional Rendering (5:42:25 PM):** This conditional rendering was removed, making the planboard content always visible.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx` (11/13/2025, 3:20:39 PM & 5:41:46 PM):**
    *   This page consistently uses `selectedCustomer ?? undefined` for the `CompanyName` parameter in `useGetReportHistoryQuery`, maintaining its logic throughout the changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx` (11/13/2025, 3:20:56 PM - 5:49:14 PM):**
    *   **Initial Conditional Rendering (3:20:56 PM):** The page content was initially conditional on `selectedCustomer`.
    *   **Removal of Conditional Rendering (5:47:04 PM):** The main content is now always rendered.
    *   **API Parameter Refinement (5:47:04 PM, 5:49:14 PM):** The `CompanyName` parameter for both `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was updated, initially removing `localUser` fallback, and eventually using `selectedCustomer || undefined` to make it optional.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx` (11/13/2025, 3:21:09 PM & 5:48:09 PM):**
    *   **API Parameter Refinement (5:48:09 PM):** The `CompanyName` parameter for `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was changed from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, ensuring consistent optional parameter handling.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts` (11/13/2025, 3:23:14 PM & 3:23:24 PM):**
    *   This file provides various static status and filter options with associated colors for shipments, air shipments, reports, team members, and bookings. No significant functional changes were made.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx` (11/13/2025, 5:01:14 PM - 5:35:37 PM):**
    *   **Complex Conditional Rendering and API Guards (Repeated changes throughout):** This file saw the most volatile changes, particularly regarding the conditional rendering of `AnalyticsContainer` and the API calls within its `useEffect`.
        *   The logic for displaying a "Please Select Any Customer" message versus `AnalyticsContainer` for `ADMIN_V2` users was repeatedly toggled and refined, aiming for `ADMIN_V2` users to only see analytics when a customer is selected.
        *   Guard clauses (`if (!user?.userid || !mainState.selectedDashobard || !selectedCustomer) return;`) were added and removed from the main data fetching `useEffect`, indicating an ongoing effort to prevent API calls with incomplete parameters.
        *   The `companyname` parameter in analytics API queries consistently uses `selectedCustomer`.
        *   The global `setLoading` state from `global-slice.ts` was integrated for loading indicators.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts` (11/13/2025, 5:05:40 PM):**
    *   This new Redux slice was introduced to manage application-wide state. It centralizes `selectedCustomer` (with `localStorage` persistence) and a general `loading` boolean, allowing these states to be easily accessed and modified across the application.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx` (11/13/2025, 5:37:21 PM - 5:54:48 PM):**
    *   **Customer-Based Fetching (5:37:21 PM):** The component fetches notification data based on `selectedCustomer || ""`.
    *   **Minor Refinements (5:38:36 PM - 5:54:48 PM):** Subsequent changes involve minor bug fixes like explicitly checking for `mblno` before navigation, briefly changing and then reverting the loading skeleton count, removing a duplicate `useNavigate` import, and refining a prop type definition.

**Patterns and Recurring Elements:**

1.  **Centralized Customer Context (`selectedCustomer`):** The most significant pattern is the extensive use of `selectedCustomer` from a global Redux slice. This state variable dictates data fetching parameters and conditional UI rendering across almost all application pages and core components, indicating a strong emphasis on a multi-customer architecture where data is always filtered by the currently selected customer.
2.  **API Query Parameter Normalization:** There's a clear trend of updating API query parameters for `CompanyName` from `selectedCustomer || localUser?.companyname` or `selectedCustomer || ""` to `selectedCustomer || undefined`. This suggests a move towards standardizing how optional company-specific data is requested, preferring `undefined` for omitted parameters rather than empty strings or user-specific fallbacks, which typically leads to cleaner API behavior.
3.  **Conditional Content Rendering:** Many pages (`layout.tsx`, `booking-dashboard.tsx`, `planboard-page.tsx`, `shipment-container-page.tsx`, `analytics-page.tsx`) initially included or frequently adjusted logic to hide primary content and display a "Please select a customer" message if no customer was chosen, especially for administrative roles. While this was sometimes added and then reverted in some files (e.g., `booking-dashboard.tsx`, `planboard-page.tsx`), the `layout.tsx` and `analytics-page.tsx` show a sustained effort to enforce this behavior for admin users.
4.  **Redux for Global State Management:** The introduction of `global-slice.ts` formalizes the management of application-wide concerns like `selectedCustomer` and a general `loading` state, demonstrating a commitment to a predictable state management pattern.
5.  **UI/UX Refinements:** Numerous small changes related to styling (`className` adjustments, icon additions) suggest an ongoing iterative process of improving the user interface and experience.
6.  **Loading Indicators:** Consistent use of loading states and components (`Loader`, `Spinner`, skeleton loaders) indicates attention to user feedback during data fetching operations.

## 10:25:40 AM
The code changes primarily focus on refining data querying, filtering, and presentation across several backend services, with a recurring emphasis on company-specific data access and robust SQL query construction.

***

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   **Initial state (11/13/2025, 10:50:09 AM):** This file contains functionalities for scheduling (`setReport`), fetching (`fetchScheduledReports`), and editing (`editReport`) user reports. It includes a `timeZoneConverter` for date/time adjustments. The `fetchScheduledReports` function filters by `user_id` and `status = 'active'`, and optionally by `id` and `CompanyName`.
    *   **Minor bug and revert (11/13/2025, 11:03:19 AM - 11:06:07 AM):** A change was introduced where `CompanyName` in `fetchScheduledReports` was mistakenly assigned `req.query.id`, which was then corrected within minutes back to `req.query.CompanyName`. A `console.log` statement was added during this process and remains in the later version.
    *   **Final state (11/13/2025, 3:14:00 PM):** No significant changes from the corrected version at 11:06:07 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   **Initial state (11/13/2025, 11:21:33 AM):** This file manages report history, including `saveReportHistory` (inserting into `v2_report_history` with various report parameters) and `getReportHistory`. The `getReportHistory` function supports pagination, sorting, and filtering by `user_id`, `CompanyName`, report `name`, date ranges (`fromDate`, `toDate`), and `status`. It uses parameterized queries for enhanced security.
    *   **Minor debugging (11/13/2025, 11:22:34 AM - 3:13:42 PM):** A `console.log` statement was temporarily added to `getReportHistory` to inspect the `CompanyName` query parameter, and subsequently removed.
    *   **Final state (11/13/2025, 3:13:42 PM):** The code reverts to a clean state similar to the initial one, with the `console.log` removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Initial state (11/13/2025, 2:56:24 PM):** Contains `getDashboardCardInfo` for fetching aggregated shipment statistics (pending departure, in transit, ETA within 1 week, out for delivery) and `getDeliveryData` for fetching detailed delivery or vessel arrival information. Both functions apply filtering by `CompanyName` and incorporate user-specific conditions (`buildMtrUserCondition`).
    *   **Refinement of `useWhere` and `companyFilter` (11/13/2025, 2:56:43 PM - 2:58:05 PM):** The `getDeliveryData` function was updated to explicitly include `useWhere` conditions in the `sqlQueryDelivery`. The `companyFilter` logic was changed to default to `useWhere` if no `CompanyName` is provided, rather than an empty string, ensuring user-specific filtering is always applied.
    *   **`CompanyName` filter logic refactor (11/13/2025, 2:59:21 PM):** The `getDashboardCardInfo` function's handling of the `CompanyName` filter was refactored. Instead of directly injecting it into the base query's `WHERE` clause, it now adds it to a `conditions` array, ensuring consistent application alongside other conditions. `buildMtrUserCondition` (`useWhere`) is now also conditionally pushed into the `conditions` array.
    *   **Logging and debugging (11/13/2025, 3:04:35 PM - 3:07:52 PM):** Minor `logger.info` messages were adjusted, and multiple `console.log` statements for debugging `req.query`, `CompanyName`, and `companyFilter` were added and subsequently removed.
    *   **Final state (11/13/2025, 3:07:52 PM):** The final version removes debug `console.log` statements, leaving the refined filtering logic in place.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Initial state (11/13/2025, 3:06:59 PM):** This service defines a `BookingQueryBuilder` class to construct dynamic SQL queries for booking data. It supports various filters, pagination, and sorting, and calculates counts for different booking statuses. The `getAll` endpoint uses this builder.
    *   **Filter type change (11/13/2025, 4:46:10 PM):** The `CompanyName` filter for `abe.customer` was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (ILIKE search).
    *   **Admin company filter enhancement (11/13/2025, 4:59:17 PM):** The `BookingQueryBuilder` was modified to allow "ADMIN" and "ADMIN_V2" roles to filter bookings by a specific `companyName` passed to the constructor. This `companyName` filter takes precedence over the default `1=1` for admins in the `setWhereClause` method.
    *   **Final state (11/13/2025, 5:57:22 PM):** No further changes were detected from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   **Initial state (11/13/2025, 3:08:39 PM):** The `getAllBookingPlanbaord` function retrieves booking plan board data, grouped by month or week, for a specified year. It includes data aggregation (total weight, total CBM) and date range calculations. User-specific and `CompanyName` filtering logic is applied, with `CompanyName` from query params taking precedence for filtering. Booking points are modified to be grouped by `pod` (Port of Discharge).
    *   **Final state (11/13/2025, 3:09:00 PM):** No changes detected.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Initial state (11/13/2025, 3:10:59 PM):** This file defines a comprehensive `SqlQueryBuilder` class for both ocean and air shipment tracking data. It supports a wide range of filters (POL, POD, shipment_id, container_no, CompanyName, date ranges), shipment statuses, user roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT), and view types ("container" or "shipment"). It also includes logic for card-based dashboard filters (pending departure, in transit, ETA within 1 week, out for delivery).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   **Initial state (11/13/2025, 3:12:03 PM):** The `getAllCompanyDetails` function fetches distinct company names based on the user's `role` (AGENT from `agent_po_account_master` or CUSTOMER from `mtr_tracking_data`). It implements optional pagination with `LIMIT` and `OFFSET`.
    *   **Nullish coalescing operator adoption (11/13/2025, 3:12:38 PM):** The assignment of default values for `page` and `perPage` was updated from the logical OR operator (`||`) to the nullish coalescing operator (`??`), providing more precise default handling (i.e., defaults apply only for `null` or `undefined`, not for falsy values like `0` or empty strings).
    *   **Final state (11/13/2025, 3:13:07 PM):** No changes detected.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Initial state (11/13/2025, 3:57:57 PM):** This utility file contains the `bookingQueryBuilder` function, which dynamically generates SQL queries for various booking analytics. It supports different analysis types (e.g., "BookingDatetoActualDeparture", "BookingDatetoActualDepartureMblWise", "BookingDatetoActualDepartureStackedBar") by constructing complex `WITH` clauses and conditional logic based on `CompanyName`, date ranges, and user preferences. It also integrates `getColumnsByCategory` and `getFilterQueryByDisplayValue` for flexible column selection and display formatting.

### Patterns and Recurring Elements:

*   **`CompanyName` Filtering:** Almost all services (`scheduleReport`, `reportHistory`, `dashboardService`, `planbaordService`, `shipmentService`, `bookingService`, `analytics\company-details-service`, `booking.query`) show active development and refinement around filtering data by `CompanyName`. This highlights a consistent requirement for multi-tenancy or company-specific data views.
*   **User Role-Based Access Control:** Several services (`dashboardService`, `bookingService`, `planbaordService`, `shipmentService`) implement logic (`userWhere` or similar) to restrict data access based on the authenticated user's role (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT), indicating a security-conscious design.
*   **Dynamic SQL Query Building:** There's a strong pattern of using dedicated classes (`BookingQueryBuilder`, `SqlQueryBuilder`) or functions (`bookingQueryBuilder`) to programmatically construct complex SQL queries. This approach facilitates maintainability, reusability, and parameterized query execution for security against SQL injection.
*   **Extensive Logging:** `logger.info` and `logger.error` are ubiquitous across all files, indicating a thorough logging strategy for monitoring application flow, debugging, and error tracking.
*   **Debugging with `console.log`:** Numerous `console.log` statements were temporarily added and removed across several files, particularly `dashboardService.ts` and `reportHistory.ts`, suggesting iterative development and active debugging sessions.
*   **Pagination and Sorting:** Implemented in `reportHistory.ts`, `bookingService.ts`, and `analytics\company-details-service.ts` for efficient handling of large datasets in API responses.
*   **Date and Timezone Handling:** `scheduleReport.ts` includes explicit `timeZoneConverter` utilities, indicating the importance of accurate date and time presentation across different timezones.
*   **Refinement of Query Operators:** The subtle change from `||` to `??` in `analytics\company-details-service.ts` demonstrates an evolution towards more precise handling of `null` and `undefined` values in TypeScript.
*   **Iterative Development:** The tight sequence of timestamps within a short period for multiple files (e.g., `dashboardService.ts` and `company-details-service.ts`) suggests rapid, iterative development, possibly involving immediate testing and fixes.

## 10:25:59 AM
The code changes primarily focus on refining customer selection and data loading mechanisms across various frontend components. A recurring pattern involves the integration of a `selectedCustomer` state (managed globally via Redux) to filter data and conditionally render UI elements.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`** (Numerous changes between 11/13/2025, 3:15:38 PM and 4:38:13 PM, then a final minor save at 5:43:05 PM):
    *   Initially set up with token expiration handling and Redux dispatch for customer initialization.
    *   A significant update at **4:31:01 PM** introduced conditional rendering: the main application content (`<Outlet />`) is now displayed only if a `selectedCustomer` exists in the global Redux state; otherwise, a "Please select a customer" placeholder message appears.
    *   Subsequent commits refined the styling, positioning, and content of this placeholder message, eventually incorporating an informational icon (`<BsInfoCircle />`) for better user guidance (e.g., at **4:36:09 PM** and **4:37:13 PM**).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`** (Changes at 11/13/2025, 3:16:14 PM, 4:26:07 PM, and 4:33:08 PM):
    *   The sidebar displays navigation items and a customer selection panel for "ADMIN\_V2" roles.
    *   A notable change at **4:26:07 PM** attempted to conditionally hide the entire sidebar menu for "ADMIN\_V2" users if no customer was selected, displaying a "Please select a customer to view the menu" message. This change was then **reverted at 4:33:08 PM**, restoring the sidebar menu to always be visible, with only the `SelectCustomerPanel` remaining conditional for admins.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`** (Single entry at 11/13/2025, 3:16:47 PM):
    *   This component was introduced, providing a toolbar for analytics dashboards.
    *   It manages Redux state for filters and dashboard views, and includes a sophisticated PDF export feature using `jspdf` and `html2canvas-pro`, with commented-out code demonstrating the evolution of the PDF generation logic.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx`** (Changes between 11/13/2025, 3:17:47 PM and 5:53:52 PM):
    *   Initially included a page-level conditional render that would display a "Please select a customer" message if `selectedCustomer` was not set. This conditional rendering was **removed at 4:27:00 PM**.
    *   The `CompanyName` parameter in API calls (`useFetchBookingDashboardDataQuery`) was initially `selectedCustomer || localUser?.companyname`, briefly changed to `selectedCustomer || ""` at **4:50:11 PM**, and then standardized to `selectedCustomer || undefined` at **5:53:52 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\planboard\PlanboardCardView.tsx`** (Minor changes at 11/13/2025, 3:18:16 PM and 3:18:22 PM):
    *   Displays planboard data in year or month views, fetching data based on `view`, `selectedYear`, and `selectedCustomer`. No significant functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts`** (Single entry at 11/13/2025, 3:18:43 PM):
    *   Defines the application's sidebar menu structure, with dynamic disabling of "Preferences" for "ADMIN\_V2" and a conditional "Dev" section based on environment variables.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`** (Changes between 11/13/2025, 3:19:32 PM and 5:54:28 PM):
    *   Manages the main dashboard with shipment overviews and a calendar.
    *   The `CompanyName` parameter for `useFetchDeliveryDataQuery` was updated from an implicit `selectedCustomer || ""` to `selectedCustomer || undefined` at **5:46:38 PM**, aligning with other components.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx`** (Changes at 11/13/2025, 3:20:12 PM and 5:42:25 PM):
    *   Initially had a page-level conditional render based on `selectedCustomer`. This conditional rendering was **removed at 5:42:25 PM**, allowing the planboard UI to load even without a selected customer.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx`** (Changes at 11/13/2025, 3:20:39 PM and 5:41:46 PM):
    *   Manages scheduled and recent reports, including Excel download functionality.
    *   Similar to `planboard-page.tsx`, the page-level conditional render based on `selectedCustomer` was **removed at 5:41:46 PM**. The `CompanyName` parameter for `useGetReportHistoryQuery` was adjusted to `selectedCustomer ?? undefined`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx`** (Changes between 11/13/2025, 3:20:56 PM and 5:49:14 PM):
    *   Displays shipment data in a container view. It consistently retains its page-level conditional rendering based on `selectedCustomer` throughout the logs.
    *   The `CompanyName` parameter in API calls was refined from `selectedCustomer || ""` to `selectedCustomer || undefined` at **5:48:40 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx`** (Changes between 11/13/2025, 3:21:09 PM and 5:48:09 PM):
    *   Provides a comprehensive shipment view with various filters and data cards.
    *   The `CompanyName` parameter in API calls was standardized to `selectedCustomer || undefined` at **5:48:09 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts`** (Minor changes at 11/13/2025, 3:23:14 PM and 3:23:24 PM):
    *   This file defines global constants for status types, roles, filter options, and inventory types. No significant changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`** (Single entry at 11/13/2025, 5:05:40 PM):
    *   Introduced a new Redux slice to manage `selectedCustomer` (persisting to `localStorage`) and a global `loading` state, indicating a new or refined global state management approach.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`** (Extensive and iterative changes between 11/13/2025, 5:01:14 PM and 5:35:37 PM):
    *   Underwent significant refactoring regarding conditional rendering and data fetching for analytics.
    *   Initially had conditional rendering for `AnalyticsContainer` based on `user.role === "ADMIN_V2" && !selectedCustomer`. This logic was frequently modified and refined across multiple commits.
    *   At **5:06:27 PM**, the loading state management was shifted to use the global `setLoading` from `global-slice.ts`.
    *   The main `useEffect` for data fetching was updated multiple times, notably at **5:33:03 PM**, to include `!selectedCustomer` as a guard clause, ensuring analytics data is only fetched when a customer is selected.
    *   The UI rendering for "ADMIN\_V2" users also evolved to display a "Please Select Any Customer" message when no customer is active (e.g., at **5:17:16 PM** and **5:20:12 PM**), otherwise rendering `AnalyticsContainer` potentially with a loading spinner.

**Patterns and Recurring Elements:**

*   **Customer-Centric Data Loading:** Almost all data-fetching components (`booking-dashboard`, `dashboard-page`, `planboard-page`, `report-page`, `shipment-container-page`, `shipment-page`, `analytics-page`, `notification-page`) now incorporate `selectedCustomer` in their API query parameters. This is a crucial functional pattern across the application.
*   **Dynamic UI based on `selectedCustomer`:** Many pages (`layout`, `sidebar`, `analytics-page`, `shipment-container-page`) conditionally render their primary content or display "Please select a customer" messages. This indicates a consistent user experience approach for multi-customer environments.
*   **Redux for Global State and RTK Query for Data:** The application heavily relies on Redux for managing UI state (filters, pagination, selected customer) and RTK Query for efficient data fetching and caching.
*   **API Parameter Fallback Standardization:** There's a clear trend to standardize fallback values for the `CompanyName` parameter in API queries, moving from `selectedCustomer || localUser?.companyname` or `selectedCustomer || ""` to `selectedCustomer || undefined`.
*   **Iterative UI/UX Refinement:** Especially in `layout.tsx` and `analytics-page.tsx`, there are numerous small changes to styling, message content, and conditional rendering logic, indicating an iterative development process for user experience.
*   **Consistent Loading Indicators:** Components frequently use `isLoading` and `isFetching` states from RTK Query to display loading components (`Loader`, `Spinner`), improving feedback to the user.
*   **All changes occurred on 11/13/2025**, suggesting a concentrated period of development, likely a single sprint or feature implementation effort.

## 11:25:53 AM
The provided code changes, all dated **11/13/2025**, reflect active development across several backend services related to reports, dashboards, bookings, and analytics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   This file handles scheduling, fetching, and editing user reports.
    *   **10:50:09 AM:** Initial state included `setReport` (report creation), `fetchScheduledReports` (retrieval with `reportId` and `companyName` filters), and `editReport` (update). A `timeZoneConverter` utility was present for date/time adjustments.
    *   **11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where `companyName` was incorrectly assigned `req.query.id`. A debugging `console.log` was added.
    *   **11:06:07 AM:** The bug in `fetchScheduledReports` was promptly reverted, restoring `companyName` to `req.query.CompanyName`. The `console.log` remained.
    *   **3:14:00 PM:** The code was identical to the 11:06:07 AM version, indicating a re-save or minor non-functional change.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   This file manages saving and retrieving user report execution history.
    *   **11:21:33 AM:** Introduced `saveReportHistory` (to persist report parameters) and `getReportHistory` (to fetch history with pagination, sorting, and various filters like name, date range, status, and company name). This file notably uses **parameterized SQL queries**, a secure practice.
    *   **11:22:34 AM:** A `console.log` for `CompanyName` was added within `getReportHistory` for debugging.
    *   **3:13:42 PM:** The debugging `console.log` was removed, reverting to the functional state of 11:21:33 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   This file provides data for dashboard cards and delivery/vessel information.
    *   **2:56:24 PM:** Initial code for `getDashboardCardInfo` (summary stats) and `getDeliveryData` (delivery/vessel lists). Both functions filtered by `CompanyName` and used `buildMtrUserCondition` for user-specific access.
    *   **2:56:43 PM:** `useWhere` conditions were added to `sqlQueryDelivery` in `getDeliveryData`.
    *   **2:58:05 PM:** In `getDeliveryData`, the `companyFilter` logic was changed to default to `useWhere` if `CompanyName` is not provided, altering filter behavior for non-admin users.
    *   **2:59:21 PM:** `getDashboardCardInfo` temporarily removed direct `CompanyName` filtering from its `baseQuery`.
    *   **3:04:35 PM:** The direct `CompanyName` filtering was re-added to `getDashboardCardInfo`, correcting the previous change. Several `console.log` statements were removed.
    *   **3:05:15 PM - 3:07:52 PM:** A series of minor changes primarily involved removing debugging `console.log` statements from both `getDashboardCardInfo` and `getDeliveryData`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   Manages booking data using a `BookingQueryBuilder` class.
    *   **3:06:59 PM:** The `BookingQueryBuilder` class was detailed, offering extensive filtering, sorting, and pagination for booking data, including fetching counts for various booking statuses and options for filter dropdowns.
    *   **4:46:10 PM:** The `CompanyName` filter in `getAll` was changed from an exact match (`addFilterClause`) to a wildcard search (`addSearchClause`).
    *   **4:59:17 PM:** The `BookingQueryBuilder` constructor was updated to accept an optional `companyName` parameter, and the `setWhereClause` logic for `ADMIN`/`ADMIN_V2` roles was modified to use this parameter. However, the `getAll` function did not pass `CompanyName` to the constructor in this entry, potentially limiting the immediate impact of this refactoring.
    *   **5:57:22 PM:** The code was identical to the 4:59:17 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   Retrieves booking planboard data, grouped by month or week.
    *   **3:08:39 PM:** Provided functionality to fetch planboard data for a `selectedYear`, with filtering by `CompanyName` and display options for `month` or `week_number` views. Helper functions `getFromDateToDate` and `pointModifierForBooking` were included.
    *   **3:09:00 PM:** The code was identical to the 3:08:39 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   Contains `SqlQueryBuilder` for complex shipment tracking queries.
    *   **3:10:59 PM:** A comprehensive `SqlQueryBuilder` class was defined, supporting a wide array of filters (transport mode, POL, POD, shipment ID, container number, CompanyName), status conditions for both ocean and air, card filters, pagination, and user-role-based access control. This file consistently uses **parameterized SQL queries**. The provided log entry for this file is a single, detailed snapshot.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   Provides an endpoint to retrieve company names based on user role.
    *   **3:12:03 PM:** Introduced `getAllCompanyDetails`, fetching distinct company names for AGENT or CUSTOMER roles, with search and pagination for customers. Parameterized SQL queries were used.
    *   **3:12:38 PM:** A minor refinement was made to default `page` and `perPage` using the **nullish coalescing operator (`??`)** instead of logical OR (`||`), improving how default values are handled for `null` or `undefined`.
    *   **3:12:15 PM & 3:13:07 PM:** These entries were identical to previous versions, representing re-saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   A utility file for generating SQL queries for booking analytics.
    *   **3:57:57 PM:** Contains the `bookingQueryBuilder` function, which creates complex SQL queries for various "Booking date to actual departure" metrics (container-wise, MBL-wise, stacked bar charts). **Crucially, this file directly concatenates user-provided values like `CompanyName`, `fromDate`, and `toDate` into its SQL queries**, creating a significant **SQL injection vulnerability**.

**Patterns and Recurring Elements:**

1.  **Concentrated Development:** All changes occurred on a single date, **11/13/2025**, with a burst of activity between **10:50 AM and 5:57 PM**, indicating focused development or hotfixes.
2.  **SQL Query Security Discrepancy:** A major pattern is the inconsistent use of secure SQL query practices:
    *   **Secure (Parameterized Queries):** `reportHistory.ts`, `shipmentService.ts`, and `company-details-service.ts` (for customer logic) use parameterized queries (`$1`, `$$`), which is the recommended secure approach.
    *   **Vulnerable (String Concatenation):** `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, and critically, `booking.query.ts` (especially with `CompanyName`, `fromDate`, `toDate`) construct SQL queries using direct string concatenation, making them susceptible to SQL injection.
3.  **Debugging Practices:** Frequent additions and removals of `console.log` statements are seen across `scheduleReport.ts`, `reportHistory.ts`, `dashboardService.ts`, and `company-details-service.ts`, indicative of active debugging during the development process.
4.  **Company-Based Filtering:** `CompanyName` is a ubiquitous filter parameter across almost all services (`scheduleReport`, `dashboardService`, `bookingService`, `planbaordService`, `shipmentService`, `company-details-service`, `booking.query.ts`), reflecting a core business requirement. Its implementation varies in security and robustness.
5.  **User Role-Based Access Control:** Many services implement logic to filter data based on the user's role (e.g., ADMIN, CUSTOMER, AGENT), ensuring data visibility adheres to permissions.
6.  **Error Handling:** A consistent pattern of `try-catch` blocks with `logger.error` and generic `Internal Server Error` responses is used across files.
7.  **Pagination and Sorting:** Implemented in `reportHistory.ts`, `bookingService.ts`, and `company-details-service.ts` for efficient data retrieval and display.

## 11:25:56 AM
This log primarily details updates to a React frontend application, focusing on state management, user experience, and data fetching logic across several core and feature-specific components. All timestamps are from **11/13/2025** to **11/14/2025**.

### File-Specific Updates:

*   **`src\components\core\layout.tsx` (Frequent Updates: 11/13/2025, 4:32:12 PM - 5:52:44 PM)**:
    *   This component saw numerous small but continuous changes related to the conditional display of content when a `selectedCustomer` is not set.
    *   Initially, the "Please select a customer" message was rendered outside the main layout content. It was then moved inside the `<Main>` component wrapper.
    *   There were multiple styling refinements for this message, involving changes to Tailwind CSS classes (`h-96`, `justify-center`, `items-center`, `my-8`, `my-10`, `my-15`, `flex`, `gap-2`).
    *   An `BsInfoCircle` icon was added to the "Please select a customer" message, with subsequent styling adjustments for its size and color.
    *   The core logic for checking token expiration and initializing `selectedCustomer` from `localStorage` on component mount remained consistent across all iterations.
    *   A `setSelectedCustomer` dispatch is used if the `localUser` has a "CUSTOMER" role.

*   **`src\components\core\sidebar.tsx` (Single Update: 11/13/2025, 4:33:08 PM)**:
    *   This file was updated to include a `SelectCustomerPanel`, which allows `ADMIN_V2` users to select a customer.
    *   The `selectedCustomer` state from the global Redux slice is utilized for the panel's initial value, and changes are dispatched using `setSelectedCustomer`.

*   **`src\components\screen\booking\booking-dashboard.tsx` (Updates: 11/13/2025, 4:39:16 PM - 5:53:52 PM)**:
    *   This component manages the booking dashboard, displaying various booking statuses and a list of bookings.
    *   Initial API calls for `bookingDashboardCartData` used `selectedCustomer || localUser?.companyname` for the `CompanyName` query parameter.
    *   This was later changed to `selectedCustomer || ""` and then further refined to `selectedCustomer || undefined`, indicating an intention to omit the `CompanyName` parameter from the API request if `selectedCustomer` is not explicitly set.
    *   The component includes features for pagination, sorting, and filtering booking data.

*   **`src\pages\analytics\analytics-page.tsx` (Frequent Updates: 11/13/2025, 5:01:14 PM - 11/14/2025, 11:16:25 AM)**:
    *   This page underwent extensive modifications related to displaying analytics dashboards based on `selectedCustomer` and user roles.
    *   Early changes involved conditionally rendering the `AnalyticsContainer` or a "Please Select Any Customer" message, primarily for `ADMIN_V2` users without a customer selected. The logic for this conditional display was adjusted and reverted several times.
    *   Loading state management was shifted from a local `isLoading` state to `loading` from the global Redux slice, with corresponding import and usage changes for `setLoading`. `Spinner` was initially used for loading, then `Loader`.
    *   The `useEffect` hook responsible for fetching reports and endpoints gained a more robust guard clause (`!user?.userid || !selectedCustomer || !mainState.selectedDashobard`) to prevent unnecessary API calls.
    *   API queries for dashboards, reports, and endpoints consistently include `companyname: selectedCustomer` and `access: user.role`. The `useFetchDashboardsQuery` was updated to use `skipToken` to prevent fetching if `selectedCustomer` is absent.
    *   A commented-out `useEffect` block related to setting `selectedCustomer` for `CUSTOMER` roles was added and removed multiple times, indicating ongoing design decisions about how customer context is initialized.
    *   The `companyname` parameter for various queries in the main `useEffect` was briefly switched to `mainState.selectedCustomer` and then reverted to `selectedCustomer`.
    *   The import for `useState` was removed, as the component moved away from managing its own loading state.

*   **`src\store\fretures\global-slice.ts` (Single Update: 11/13/2025, 5:05:40 PM)**:
    *   This file defines the Redux `globalSlice` which centrally manages `selectedCustomer` and a global `loading` state.
    *   `setSelectedCustomer` stores the selected customer in `localStorage` for persistence, and `initializeSelectedCustomer` retrieves it. `setLoading` allows global control over loading indicators.

*   **`src\pages\notifications\notification-page.tsx` (Frequent Updates: 11/13/2025, 5:37:21 PM - 5:54:48 PM)**:
    *   This page displays user notifications, retrieving data using `useFetchNotificationDataQuery` with `CompanyName: selectedCustomer || ""`.
    *   It includes a `NavigateTo` function to redirect users to shipment details based on the notification.
    *   Loading UI with animated placeholders was introduced.
    *   Minor adjustments were made to `NotificationsProps` type and HTML `gap` attributes in card headers. There was a temporary duplicate `useNavigate` import which was subsequently removed.

*   **`src\pages\reports\report-page.tsx` (Single Update: 11/13/2025, 5:41:46 PM)**:
    *   This page manages scheduled and recent reports. It fetches report history and saved reports, using `selectedCustomer ?? undefined` for filtering.
    *   Functionality includes downloading individual or multiple reports as Excel files, and displaying report schedule statuses.
    *   It uses a `Loader` for operations like multi-report download.

*   **`src\pages\planboard\planboard-page.tsx` (Single Update: 11/13/2025, 5:42:25 PM)**:
    *   This component displays a "Booking Planboard" with options to view by year or month.
    *   It uses `selectedCustomer` to filter the data displayed in the `PlanboardCardView`.
    *   A tooltip was added to provide information on color-coded week indicators.

*   **`src\pages\dashboard\dashboard-page.tsx` (Updates: 11/13/2025, 5:46:38 PM - 5:54:28 PM)**:
    *   This main dashboard component fetches shipment and delivery data.
    *   The `CompanyName` parameter for `useFetchShipmentDataQuery` and `useFetchCartDataQuery` was initially set to `selectedCustomer || localUser?.companyname`.
    *   For `useFetchDeliveryDataQuery`, the `CompanyName` parameter was changed from `selectedCustomer || ""` to `selectedCustomer || undefined`.

*   **`src\pages\shipment\shipment-container-page.tsx` (Updates: 11/13/2025, 5:47:04 PM - 5:49:14 PM)**:
    *   This page displays shipment data in a container view.
    *   It initially used `selectedCustomer || ""` for the `CompanyName` parameter in `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery`.
    *   This was later changed to `selectedCustomer || undefined` for both queries, making the parameter optional if no customer is selected.
    *   It includes a conditional message "Please select a customer to view container data." if `selectedCustomer` is not set.

*   **`src\pages\shipment\shipment-page.tsx` (Single Update: 11/13/2025, 5:48:09 PM)**:
    *   This page displays general shipment data.
    *   It consistently uses `selectedCustomer || undefined` for the `CompanyName` parameter in `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery`.
    *   It also defines specific filter options for air shipments and transport modes.

*   **`src\components\screen\analytics\analyticsContainer.tsx` (Single Update: 11/14/2025, 11:10:30 AM)**:
    *   This component enables a dynamic, interactive analytics dashboard with draggable and resizable metric widgets.
    *   It uses `selectedCustomer` for fetching individual report data and dispatches state changes related to metric order and size.
    *   It uses `react-dnd` for drag-and-drop functionality.

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx` (Single Update: 11/14/2025, 11:11:19 AM)**:
    *   This component provides an interface for users to create, edit, and manage custom analytics dashboard views.
    *   It fetches dashboard options using `selectedCustomer` and includes functionality for selecting metrics (with a limit of 9), naming views, and performing audit actions.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx` (Updates: 11/14/2025, 11:20:29 AM - 11:24:40 AM)**:
    *   This toolbar provides controls for the analytics dashboard, including date filters (local/global, standard periods, and a newly added custom date range picker).
    *   It also offers modes for interacting with chart views (move/resize) and a PDF export functionality (using `jspdf` and `html2canvas-pro`, including logo rendering).
    *   Functionality for managing and creating custom views is exposed here, leveraging the `ViewContainer` component.

### Patterns and Recurring Elements:

*   **Centralized Customer Selection:** The `selectedCustomer` state is a critical, shared piece of information across almost all parts of the application. Its value (or lack thereof) dictates data fetching parameters and UI elements, particularly for `ADMIN_V2` users who need to select a customer to view relevant data. This is managed via the `global-slice.ts` Redux slice.
*   **Redux Toolkit for State & API:** The application heavily relies on Redux Toolkit for state management (`useSelector`, `useDispatch`) and data fetching (`RTK Query` hooks like `useFetch...Query`, `useLazyFetch...Query`, `useMutation`). This provides a consistent and scalable approach to data flow.
*   **Conditional Data Fetching:** A recurring pattern is to conditionally execute RTK Query hooks or modify query parameters (e.g., `CompanyName: selectedCustomer || undefined`) based on whether `selectedCustomer` is available, often using `skipToken` to prevent unnecessary API calls.
*   **UI for "No Customer Selected":** Many pages implement specific UI (a message, an icon, or conditional rendering of main content) to guide `ADMIN_V2` users to select a customer before displaying data, reflecting a common requirement for multi-tenancy or admin oversight.
*   **Loading Indicators:** The application consistently employs loading indicators (`Loader`, `Spinner`, `CircularProgress`) during data fetching or intensive operations to improve user feedback. The shift towards managing a global `loading` state in `global-slice.ts` suggests a move towards unified loading management.
*   **Styling and Icons:** Tailwind CSS classes are extensively used for styling, and `react-icons` are widely adopted to enhance the visual presentation and interactivity of UI elements.
*   **`localStorage` for Session Persistence:** User authentication details (`user`, `token`) and the `selectedCustomer` are stored in `localStorage` for basic session and state persistence.
*   **Date and Filter Controls:** Dashboard and analytics pages consistently provide filtering capabilities, including date range selections (with predefined periods and custom options) and various data-specific filters.

## 12:38:25 PM
The provided log shows a series of code changes primarily focused on backend services for a T360 application, dealing with reports, dashboards, bookings, and analytics.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   **Timestamp: 11/13/2025, 10:50:09 AM**
        *   Initial implementation or a major update to functionalities for `setReport` (scheduling a new report), `fetchScheduledReports` (retrieving existing reports), and `editReport` (updating reports).
        *   Introduces a `timeZoneConverter` utility for handling date and time conversions based on specified timezones.
        *   All report operations involve SQL `INSERT` or `UPDATE` statements on the `v2_user_reports` table and include logging for request parameters and SQL queries.
        *   `fetchScheduledReports` includes filtering by `user_id`, `status`, `id`, and `account_name` (referred to as `CompanyName` in query params).
    *   **Timestamp: 11/13/2025, 11:03:19 AM**
        *   A minor change in `fetchScheduledReports`: The `companyName` variable is incorrectly assigned `req.query.id` instead of `req.query.CompanyName`. A `console.log` statement for `companyName` was also added. This is likely a bug introduction.
    *   **Timestamp: 11/13/2025, 11:06:07 AM**
        *   Reverts the error introduced at 11:03:19 AM in `fetchScheduledReports`, correctly reassigning `companyName` to `req.query.CompanyName`. The `console.log` for `companyName` remains.
    *   **Timestamp: 11/13/2025, 3:14:00 PM**
        *   No functional changes appear in the provided code snippet compared to the previous version at 11:06:07 AM. It seems to be a minor re-save or formatting change.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   **Timestamp: 11/13/2025, 11:21:33 AM**
        *   Introduces `saveReportHistory` and `getReportHistory` functions.
        *   `saveReportHistory` inserts detailed report parameters into `public.v2_report_history` using parameterized SQL queries.
        *   `getReportHistory` fetches report history with pagination, sorting, and various filters (user ID, company name, report name, date range, status). It uses parameterized queries for security and efficiency.
        *   Includes detailed logging for parameters and generated SQL queries.
    *   **Timestamp: 11/13/2025, 11:22:34 AM**
        *   A `console.log` statement for `CompanyName` was added within `getReportHistory`.
    *   **Timestamp: 11/13/2025, 3:13:42 PM**
        *   The `console.log` statement for `CompanyName` within `getReportHistory` was removed. No functional changes appear otherwise.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamp: 11/13/2025, 2:56:24 PM**
        *   Implements `getDashboardCardInfo` and `getDeliveryData` for retrieving dashboard-related information.
        *   `getDashboardCardInfo` calculates counts and TEU (Twenty-foot Equivalent Unit) for "Pending Departure", "In Transit", "ETA Within 1 Week", and "Out for Delivery" statuses from `mtr_tracking_data`. It supports date range and company name filtering.
        *   `getDeliveryData` retrieves delivery or vessel arrival data based on `type` and `mode` (ALL, Rail, Door, Port Delivery). It includes filtering by company name.
        *   Initial attempts to apply `CompanyName` filtering in `getDashboardCardInfo` are present, with commented-out code and direct string interpolation into SQL, which can be a SQL injection risk.
    *   **Timestamp: 11/13/2025, 2:56:30 PM & 11/13/2025, 2:56:43 PM**
        *   These timestamps show no discernible functional changes in the provided code. They are likely minor saves or formatting updates.
    *   **Timestamp: 11/13/2025, 2:58:05 PM**
        *   The `getDeliveryData` function's `companyFilter` logic was modified. Previously, if `CompanyName` was provided, it used `AND LOWER(account_name) = LOWER(...)`, otherwise an empty string. This change makes it use `useWhere` (which comes from `buildMtrUserCondition`) if `CompanyName` is not provided. This implies a change in how company-specific filtering is applied, potentially relying more on user role-based conditions when no explicit company is selected.
    *   **Timestamp: 11/13/2025, 2:59:21 PM**
        *   In `getDashboardCardInfo`, the direct company name filter `AND LOWER(account_name) = LOWER('${CompanyName?.replace(/'/g, "''") || ""}')` was removed from the `baseQuery`. Now, the `conditions` array is used, which `useWhere` (derived from `buildMtrUserCondition`) is pushed into, but `CompanyName` filtering is removed directly. This removes company filtering from `getDashboardCardInfo` if `useWhere` doesn't provide it.
    *   **Timestamp: 11/13/2025, 3:04:35 PM**
        *   Reintroduces `CompanyName` filtering for `getDashboardCardInfo`. Now, `useWhere` is *always* added to `conditions` if it exists, and an *additional* condition for `CompanyName` is explicitly added if `CompanyName` is provided and not empty. This means both user-specific conditions (`useWhere`) and explicit `CompanyName` can apply.
        *   A console log `console.log("result[0]", result[0])` was added.
        *   The logger message for `baseQuery` changed from `sql query :: 1234` to `sql query ::`.
    *   **Timestamp: 11/13/2025, 3:05:15 PM & 11/13/2025, 3:05:33 PM**
        *   No discernible functional changes. Minor saves or formatting.
    *   **Timestamp: 11/13/2025, 3:06:20 PM**
        *   A `console.log(error)` statement was removed from the catch block of `getDeliveryData`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   **Timestamp: 11/13/2025, 3:08:39 PM**
        *   Introduces the `getAllBookingPlanbaord` function.
        *   This service fetches booking data to populate a "plan board", grouped by month or week, for a `selectedYear`.
        *   It dynamically constructs SQL queries to extract `month` and `week_number` from `est_cargo_ready_date` and aggregates booking details (serial ID, agent booking ID, total weight, total CBM, POR, POL, POD, SCAC code, ship name, booking date, estimated cargo ready date, line booking number, container inventory).
        *   Includes a `userWhere` clause to filter data based on the user's company or location, which can be overridden by a `CompanyName` query parameter.
        *   Features `getFromDateToDate` to determine date ranges and `pointModifierForBooking` to group points by POD, sorting known PODs and placing "UNKNOWN" last.
    *   **Timestamp: 11/13/2025, 3:09:00 PM**
        *   No functional changes in the provided snippet. Likely a minor save or formatting.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp: 11/13/2025, 3:10:59 PM & 11/14/2025, 12:14:35 PM**
        *   Introduces `SqlQueryBuilder` class for dynamically building SQL queries for shipment data.
        *   Handles filtering by `transpot_mode` ('ocean', 'air', 'both'), `airstatus`, `status`, `pol`, `pod`, `shipment_id`, `contno`, `CompanyName`, and date ranges.
        *   Includes logic for user-specific conditions based on `role` (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and `companyname`/`location`. Special handling for "ZIGI USA, LLC" customers.
        *   The `buildCardFilterCondition` method applies filters for dashboard cards like 'pending_departure', 'in_transit', 'eta_within_1_week', and 'out_for_delivery'.
        *   Uses parameterized queries (`$$` placeholder replaced with `$N`) to prevent SQL injection.
        *   The two timestamps show no functional differences in the provided log, indicating a re-save or minor non-functional change.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   **Timestamp: 11/13/2025, 3:12:03 PM**
        *   Initial implementation of `getAllCompanyDetails` to fetch company names based on user `role` (AGENT or CUSTOMER) and a `search` term.
        *   For AGENT role, it queries `agent_po_account_master` for `cname`.
        *   For CUSTOMER role, it queries `mtr_tracking_data` for `account_name`.
        *   Introduces pagination logic, dynamically building `COUNT` and `SELECT` queries with `LIMIT` and `OFFSET` if `pagination` is enabled.
        *   Includes `console.log` statements for debugging.
    *   **Timestamp: 11/13/2025, 3:12:15 PM & 11/13/2025, 3:13:07 PM**
        *   No functional changes in the provided snippets. Minor saves or formatting.
    *   **Timestamp: 11/13/2025, 3:12:38 PM**
        *   Changed how `page` and `perPage` query parameters are defaulted, switching from `req.query.page || 1` to `req.query.page ?? 1` (and similar for `perPage`). This uses the nullish coalescing operator `??`, which provides a default only if the left-hand side is `null` or `undefined`, distinguishing it from falsy values like `0` or `''` which `||` would catch.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp: 11/13/2025, 3:57:57 PM**
        *   Introduces `bookingQueryBuilder` function, responsible for generating complex SQL queries for booking analytics based on various `type`s and a `customizer` object.
        *   Currently implements queries for:
            *   `BookingDatetoActualDeparture` (container-wise average day difference).
            *   `BookingDatetoActualDepartureMblWise` (MBL-wise average day difference).
            *   `BookingDatetoActualDepartureStackedBar` (container-wise aggregated day difference into time buckets for stacked bar charts).
            *   `BookingDatetoActualDepartureMblWiseStackedBar` (MBL-wise aggregated day difference into time buckets for stacked bar charts).
        *   These queries join `mtr_tracking_data` and `agent_booking_entry` to calculate time differences between booking date and actual departure date, filtered by `CompanyName` and a date range.
        *   The `customizer` object is updated with analytical configurations like `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `chartType`, and `calColumnConfig`.
        *   Uses `getColumnsByCategory` and `getFilterQueryByDisplayValue` utility functions.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamp: 11/13/2025, 4:46:10 PM**
        *   Corrects the `addFilterClause` for `abe.customer` in `getAll`, changing it from `addFilterClause` to `addSearchClause`. This means `CompanyName` filtering will now use `ILIKE '%${value}%'` instead of `IN ('value1', 'value2')`, allowing for partial matches.
    *   **Timestamp: 11/13/2025, 4:59:17 PM**
        *   Introduces a `companyName` field to the `BookingQueryBuilder` constructor and class.
        *   Modifies the `userWhere` logic in `setWhereClause`. For `ADMIN` or `ADMIN_V2` roles, if `this.companyName` is provided, it uses `abe.customer = '${this.companyName.toUpperCase()}'`; otherwise, it defaults to `"1=1"`. This allows administrators to explicitly filter by a company name passed into the builder.
    *   **Timestamp: 11/13/2025, 5:57:22 PM**
        *   No functional changes observed. Likely a minor save or formatting.

### Patterns and Recurring Elements:

1.  **Date: 11/13/2025**: All changes occurred on the same day, indicating a concentrated development effort.
2.  **Company Name Filtering**: A consistent theme across multiple services (`scheduleReport.ts`, `dashboardService.ts`, `reportHistory.ts`, `bookingService.ts`, `company-details-service.ts`) is the implementation and refinement of filtering data by `CompanyName` or `account_name`. This often involves converting to lowercase and handling potential single quotes for SQL safety (`.replace(/'/g, "''")`).
3.  **User Role-Based Access Control**: Services frequently use `req.user?.userid`, `req.user?.companyname`, and `req.user?.role` to determine data access and filtering conditions, particularly for `ADMIN`, `CUSTOMER`, `FRONTOFFICE`, and `AGENT` roles.
4.  **Logging**: Extensive use of `logger.info` and `logger.error` for tracking function calls, parameters, executed queries, and error messages across all modified files. Debug `console.log` statements are also common, sometimes added and then removed.
5.  **SQL Query Building**: Several services (e.g., `SqlQueryBuilder` in `shipmentService.ts`, `BookingQueryBuilder` in `bookingService.ts`, and the functions in `booking.query.ts`) employ dynamic SQL query construction, often using string concatenation. While parameterized queries are used in `reportHistory.ts` and `SqlQueryBuilder` for values, some places still directly embed variables into string literals, posing a potential SQL injection risk (e.g., `scheduleReport.ts` and parts of `dashboardService.ts`).
6.  **Pagination and Sorting**: `getReportHistory` and `getAll` (in `bookingService.ts`) implement robust pagination (`page`, `limit`, `offset`) and sorting (`orderBy`) mechanisms. `getAllCompanyDetails` also includes pagination logic.
7.  **Error Handling**: All major service functions include `try...catch` blocks to handle errors and return `HttpStatusCodes.INTERNAL_SERVER_ERROR` responses with appropriate error logging.
8.  **Data Transformation**: Services often transform raw database results into a more client-friendly format (e.g., `formattedReports` in `scheduleReport.ts`, grouping by POD in `planbaordService.ts`).
9.  **Timezone Conversion**: The `scheduleReport.ts` file includes a `timeZoneConverter` utility to handle date and time conversions.

## 12:38:50 PM
The log details a series of changes across multiple frontend files, primarily focusing on customer selection logic, loading state management, and minor UI adjustments.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (11/13/2025, 4:32 PM - 5:52 PM)**: This file underwent numerous, iterative changes. Initially, the main content (`Outlet`) was conditionally rendered based on `selectedCustomer`. This was then refined to always render the `Main` component, with the `Outlet` or a "Please select a customer" placeholder rendered conditionally inside. The placeholder message itself saw several styling adjustments, including changes to margins (`my-8`, `my-10`, `my-15`), layout (`flex`, `justify-center`, `items-center`), and the introduction and styling of an info icon (`BsInfoCircle`). The `BsInfo` import was added and later removed. The token expiration logic and `initializeSelectedCustomer` dispatch remained consistent.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx` (11/13/2025, 4:33 PM)**: Introduced a `SelectCustomerPanel` component, which is conditionally rendered for "ADMIN_V2" roles. This panel allows admins to select a customer, triggering a `setSelectedCustomer` dispatch to update the global state.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx` (11/13/2025, 4:39 PM - 5:53 PM)**: The `CompanyName` parameter for fetching booking dashboard data (`useFetchBookingDashboardDataQuery`) was adjusted. It initially fell back to `localUser?.companyname` if `selectedCustomer` was null, then changed to an empty string `""`, and finally to `undefined`.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx` (11/13/2025, 5:01 PM - 11/14/2025, 11:16 AM)**: This file experienced the most frequent and significant changes. Key updates include:
    *   **Conditional Rendering**: Repeated adjustments to how `AnalyticsContainer` and a "Please select a customer" message are rendered, especially for "ADMIN_V2" users, depending on whether `selectedCustomer` is present. This included uncommenting/commenting display logic, inverting conditions, and refining JSX structure.
    *   **Loading State**: Shifting from a local `isLoading` state to a global `loading` state from `global-slice`, with frequent commenting/uncommenting of `setLoading` dispatches and conditional rendering of `Loader` or `Spinner` components.
    *   **API Query Parameters**: The `companyname` parameter in `useFetchDashboardsQuery`, `fetchReport`, and `fetchEndpoints` was repeatedly toggled between `selectedCustomer` and `mainState.selectedCustomer`, with a final state generally using `selectedCustomer`. Conditional skipping of `useFetchDashboardsQuery` via `skipToken` was introduced if `selectedCustomer` is null.
    *   **Dependency Arrays and Guards**: `useEffect` dependency arrays were updated, and explicit guards (e.g., `if (!user?.userid || !selectedCustomer || !mainState.selectedDashobard) return;`) were added and sometimes removed, indicating ongoing refinement of data fetching triggers.
    *   **Reducer Interaction**: Changed `setLoading` import between `analytics-slice` and `global-slice`, settling on `global-slice`. Changed `setCustomer` to `setSelectedCustomer` for customer role initialization.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts` (11/13/2025, 5:05 PM)**: Introduced a `loading` boolean state and a `setLoading` reducer action to manage a global loading indicator.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx` (11/13/2025, 5:37 PM - 5:54 PM)**: Refactored notification rendering into a dedicated function (`renderNotificationList`). The `CompanyName` parameter for `useFetchNotificationDataQuery` consistently uses `selectedCustomer || ""`. There were several minor saves without functional changes.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx` (11/13/2025, 5:41 PM)**: Updated `CompanyName` parameter in `useGetReportHistoryQuery` to `selectedCustomer ?? undefined`.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx` (11/13/2025, 5:42 PM)**: `selectedCustomer` was passed as a prop to `PlanboardCardView`.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (11/13/2025, 5:46 PM - 5:54 PM)**: Adjusted the `CompanyName` parameter for `useFetchShipmentDataQuery` and `useFetchCartDataQuery` to use `selectedCustomer || localUser?.companyname`. For `useFetchDeliveryDataQuery`, it changed from `selectedCustomer || ""` to `selectedCustomer || undefined`.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx` (11/13/2025, 5:47 PM - 5:49 PM)**: The `CompanyName` parameter for shipment data queries was updated to `selectedCustomer || undefined`. Conditional rendering to show a "Please select a customer" message was introduced, removed, and then re-introduced.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx` (11/13/2025, 5:48 PM)**: Standardized the `CompanyName` parameter for shipment and card data queries to `selectedCustomer || undefined`.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx` (11/14/2025, 11:10 AM)**: Integrated `selectedCustomer` into the `fetchReport` query.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx` (11/14/2025, 11:11 AM)**: Used `selectedCustomer` in `useFetchDashboardOptionsQuery` and the `saveDashboard` mutation.
*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (11/14/2025, 11:20 AM - 11:24 AM)**: Introduced PDF export functionality using `jspdf` and `html2canvas-pro`, including logo embedding. Added advanced date filtering options with a `PopoverPanel` and `DateRange` component for custom date selection.

**Timestamps of Significant Changes:**

*   **11/13/2025, 4:32 PM**: Initial UI structure and conditional rendering changes in `layout.tsx`.
*   **11/13/2025, 4:33 PM**: Introduction of customer selection for admins in `sidebar.tsx`.
*   **11/13/2025, 5:01 PM - 5:27 PM (multiple entries)**: Intensive iteration on `analytics-page.tsx` for conditional rendering, loading states, and API parameter handling related to customer selection.
*   **11/13/2025, 5:05 PM**: Introduction of global loading state in `global-slice.ts`.
*   **11/13/2025, 5:33 PM (multiple entries)**: Refinement of API query guards and dashboard default checks in `analytics-page.tsx`.
*   **11/14/2025, 10:55 AM**: Introduction of `skipToken` and explicit `!selectedCustomer` guards for API queries in `analytics-page.tsx`, and a change in `setSelectedCustomer` dispatch.
*   **11/14/2025, 11:10 AM - 11:11 AM**: Integration of `selectedCustomer` into `analyticsContainer.tsx` and `ViewContainer.tsx`.
*   **11/14/2025, 11:20 AM - 11:23 AM**: Implementation of PDF export and custom date range filtering in `AnalyticsToolbar.tsx`.

**Patterns and Recurring Elements:**

*   **`selectedCustomer` Integration**: The `selectedCustomer` value from a Redux global slice (`state.globalSlice`) is a central piece of state, consistently used across almost all features (layout, sidebar, booking, analytics, notifications, reports, planboard, dashboard, shipments) to scope data requests and UI elements.
*   **Conditional Rendering**: A frequent pattern is the conditional rendering of components or placeholder messages based on the presence of `selectedCustomer`, especially for administrative roles, ensuring that data is only displayed when a customer context is established.
*   **Loading Indicators**: The application often displays loading states (using `Loader` or `Spinner`) while fetching data, with the management of these states evolving from local component state to a centralized Redux global `loading` state.
*   **RTK Query**: The application leverages RTK Query hooks (`useFetch...Query`, `useLazyFetch...Query`, `use...Mutation`) extensively for data fetching and mutations, with query parameters dynamically built from Redux states and `localStorage` user data.
*   **`localStorage` Usage**: User session information (`user`, `token`) and the `selectedCustomer` are persistently stored and retrieved from `localStorage`.
*   **UI/UX Refinements**: There are many small, iterative changes to UI styling and layout, particularly evident in `layout.tsx` and `analytics-page.tsx`, indicating ongoing design and usability improvements.

## 2:38:49 PM
**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`**

This file, a core layout component, underwent several UI/UX adjustments for a placeholder message displayed when no customer is selected.
*   **11/13/2025, 4:34:53 PM - 4:35:44 PM**: The styling of the "Please select a customer" message was iteratively refined, mainly adjusting vertical margins (from `h-96` to `my-8`, then `my-10`, then `my-15`) and flexbox properties.
*   **11/13/2025, 4:36:09 PM - 4:38:13 PM**: An `BsInfoCircle` icon was introduced and styled (text color, size, top margin `mt-1`) and integrated alongside the "Please select a customer" text for better visual communication. The surrounding container's flexbox properties were also adjusted for centering and spacing.
*   **11/13/2025, 5:43:05 PM - 5:52:44 PM**: Minor cleanup, including redundant import removal of `BsInfo`, but no significant functional changes.
The core logic for conditionally rendering the application `Outlet` only if a `selectedCustomer` is present remained consistent throughout the changes.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx`**

Changes to this booking dashboard component primarily focused on how customer information is passed to API queries.
*   **11/13/2025, 4:39:16 PM**: The initial implementation used `selectedCustomer || localUser?.companyname` as the `CompanyName` parameter for `useFetchBookingDashboardDataQuery`.
*   **11/13/2025, 4:50:11 PM - 5:53:52 PM**: This fallback logic was revised, first to `selectedCustomer || ""` and then to `selectedCustomer || undefined`, indicating a preference for explicitly passing `undefined` rather than an empty string when `selectedCustomer` is absent.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**

This analytics screen component experienced numerous, often iterative, updates affecting loading states, data fetching, and conditional UI.
*   **11/13/2025, 5:01:14 PM - 5:02:12 PM**: Initial changes focused on conditional rendering of an "Please Select Any Customer" message for `ADMIN_V2` roles when `selectedCustomer` is not set, shifting between displaying the message and the `AnalyticsContainer`.
*   **11/13/2025, 5:03:22 PM - 5:08:12 PM**: The component transitioned its loading state management from local `useState` to using a global `loading` state from `global-slice`. A `Spinner` (later `Loader`) component was introduced for visual loading feedback, initially wrapped around `AnalyticsContainer`.
*   **11/13/2025, 5:13:31 PM - 5:14:08 PM**: The `companyname` parameter in API queries (for `fetchReport` and `fetchEndpoints`) was temporarily switched from `selectedCustomer` to `mainState.selectedCustomer` and then reverted. A guard condition based on `!selectedCustomer` was also added and removed from the main data-fetching `useEffect`.
*   **11/13/2025, 5:17:16 PM - 5:27:35 PM**: The conditional rendering for `ADMIN_V2` users and the `selectedCustomer` check were extensively refactored, often with temporary logical errors, eventually settling on a pattern to show a "Please Select Any Customer" message or the `AnalyticsContainer`. Loading indicators were also moved around, sometimes wrapping the entire toolbar and content, and sometimes just the container.
*   **11/13/2025, 5:33:03 PM - 5:35:37 PM**: Refinements to the main data-fetching `useEffect` included adding `!selectedCustomer` as a guard condition (and later removing it), and including `_Default_` as a recognized default dashboard.
*   **11/14/2025, 10:42:36 AM - 10:55:49 AM**: `AnalyticsToolbar` was temporarily commented out, then restored. The `useFetchDashboardsQuery` was updated to use `skipToken` from `@reduxjs/toolkit/query` to prevent unnecessary fetches if `selectedCustomer` is null. The `setSelectedCustomer` action from `global-slice` was used to initialize customer data for `CUSTOMER` roles. Imports for `Alert` and `Spinner` were removed.
*   **11/14/2025, 11:02:21 AM - 11:04:22 AM**: An explicit guard `if (!selectedCustomer) return;` was added within the `fetchAllEndpoints` function, and the `useEffect` setting `setSelectedCustomer` for `CUSTOMER` roles was briefly commented out and then restored.
*   **11/14/2025, 11:07:27 AM - 11:11:49 AM**: There was a brief period where `companyname` in API calls used `selectedCustomer || mainState.selectedCustomer`, which was then reverted to just `selectedCustomer`.
*   **11/14/2025, 11:15:39 AM - 11:16:25 AM**: The `Loader` component was re-integrated into the rendering, conditionally displayed based on the `global-slice`'s `loading` state, affecting the `AnalyticsContainer` display. The local `isLoading` state variable was completely removed.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**

This Redux slice was updated to centralize application-wide loading state management.
*   **11/13/2025, 5:05:40 PM**: A `loading` boolean state and a `setLoading` reducer were added to the `globalSlice`, providing a unified mechanism for indicating loading states across the application.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx`**

This notification page saw minor structural and styling adjustments, particularly related to loading states and prop types.
*   **11/13/2025, 5:37:21 PM - 5:38:42 PM**: The number of placeholder items displayed during loading (`isLoading || isFetching`) briefly changed from `limit` to `3` and then back to `limit`. A CSS `gap` value in `Card.Header` was adjusted.
*   **11/13/2025, 5:39:58 PM**: The type of `selectedNotification` prop was briefly changed to `any` and then reverted to `NotificationItemValues | null`. A redundant `useNavigate` import was added.
*   **11/13/2025, 5:54:48 PM**: No notable functional changes, mostly re-saves.
The `useFetchNotificationDataQuery` consistently used `CompanyName: selectedCustomer || ""` for API calls.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx`**

This reports page was updated to use the globally selected customer for fetching report history.
*   **11/13/2025, 5:41:46 PM**: The `useGetReportHistoryQuery` now includes `CompanyName: selectedCustomer ?? undefined` in its parameters, ensuring that report history is filtered by the active customer.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx`**

The planboard page was updated to integrate the globally selected customer into its view component.
*   **11/13/2025, 5:42:25 PM**: The `selectedCustomer` from `globalSlice` is now passed as a prop to the `PlanboardCardView` component, indicating that the displayed data is customer-specific.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`**

This dashboard page was updated to incorporate customer selection into its data fetching.
*   **11/13/2025, 5:46:38 PM**: The `selectedCustomer` from `globalSlice` was integrated into `useFetchShipmentDataQuery`, `useFetchDeliveryDataQuery`, and `useFetchCartDataQuery` for filtering data, with fallbacks of `localUser?.companyname` or an empty string.
*   **11/13/2025, 5:54:28 PM**: The `CompanyName` fallback for `useFetchDeliveryDataQuery` was refined from an empty string to `undefined`.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx`**

This page was significantly updated to depend on a selected customer for rendering and data fetching.
*   **11/13/2025, 5:47:04 PM**: The page introduced conditional rendering, displaying its content only if a `selectedCustomer` is available; otherwise, a "Please select a customer..." message is shown. `selectedCustomer` was integrated into `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery`, with fallbacks.
*   **11/13/2025, 5:48:40 PM - 5:49:14 PM**: The `CompanyName` fallback in `useFetchShipmentCardDataQuery` and `useFetchShipmentDataQuery` was changed from `localUser?.companyname` or `""` to `undefined`.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx`**

This shipment page also adopted the global customer selection for its data.
*   **11/13/2025, 5:48:09 PM**: `selectedCustomer` from `globalSlice` was integrated into `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` for filtering data, using `undefined` as a fallback. New constants (`AIR_SHIPMENT_STATUS_FILTERS`, `TRANSPORT_MODE_OPTIONS`) were defined.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx`**

The analytics container component was updated to filter its reports by the selected customer.
*   **11/14/2025, 11:10:30 AM**: The `fetchSingleReport` function now includes `selectedCustomer` from `globalSlice` in its query parameters for fetching report data.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`**

This view management component now filters dashboard options and audit logs by customer.
*   **11/14/2025, 11:11:19 AM**: `selectedCustomer` from `globalSlice` was integrated into `useFetchDashboardOptionsQuery` and the `AuditViewDrawer` query parameters.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**

The analytics toolbar gained new export and filtering capabilities.
*   **11/14/2025, 11:20:29 AM - 11:21:00 AM**: A `downloadDashboardPDF` function was implemented using `jspdf` and `html2canvas-pro` to export the dashboard as a PDF, including a logo and a loading indicator.
*   **11/14/2025, 11:23:34 AM - 11:24:40 AM**: Custom date range filtering functionality was added using `PopoverPanel` and `DateRange` components, allowing users to define specific date filters.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\reports\report-form.tsx`**

The report form was updated to associate reports with the selected customer.
*   **11/14/2025, 1:01:10 PM - 1:15:25 PM**: The `selectedCustomer` from `globalSlice` was added to the payload for both `getReport` (for downloading existing reports) and `createReport` (for creating new scheduled reports), ensuring customer-specific report management.

---

**Key Information & Patterns from Changes:**

*   **Centralized Customer Selection (`selectedCustomer`)**: A dominant theme across almost all modified files is the integration and reliance on a `selectedCustomer` state managed by the Redux `global-slice`. This `selectedCustomer` is consistently used to filter data for API calls across various dashboards, reports, and component views, indicating a shift towards a multi-customer architecture where data is always context-specific.
*   **Conditional UI based on `selectedCustomer`**: Many pages (`layout.tsx`, `shipment-container-page.tsx`, `analytics-page.tsx`) now feature conditional rendering that prompts users to select a customer if none is active, or gates the display of data until a selection is made.
*   **Evolving Loading State Management**: The application's approach to displaying loading indicators (`Loader`, `Spinner`) and managing the loading state (`isLoading`, `isFetching`) is being refined, transitioning from local component states to a global `loading` state within the Redux `global-slice`. This process involved several iterative changes and refactorings within `analytics-page.tsx`.
*   **API Parameter Refinement**: There's a recurring pattern of refining the `CompanyName` parameter for API calls, evolving from optional `localUser?.companyname` or empty string fallbacks to `undefined`, suggesting stricter API contract adherence or clearer data handling.
*   **UI/UX Polish**: Frequent minor styling adjustments are observed, especially in `layout.tsx` and `notifications-page.tsx`, indicating ongoing UI refinement efforts.
*   **New Feature Implementation**: `AnalyticsToolbar.tsx` received significant updates for PDF export and custom date range filtering, adding substantial new functionality to the analytics section.
*   **Timestamp Patterns**: All changes occurred within a short period across `11/13/2025` and `11/14/2025`, suggesting a concentrated development effort. Multiple commits for the same file within minutes indicate rapid, iterative development and debugging, especially for UI tweaks and logic adjustments.