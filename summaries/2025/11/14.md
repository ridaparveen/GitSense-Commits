# Activity Summary for 11/14/2025

## 9:25:52 AM
The changes log details a day of active development across several backend services, focusing primarily on data retrieval, filtering, and reporting functionalities. All modifications occurred on **November 13, 2025**.

Here's a breakdown of the key information by file:

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
*   **11/13/2025, 10:50:09 AM:** This version established the core functionalities for managing user-scheduled reports.
    *   `setReport`: Handles the creation of new user reports, inserting data into the `v2_user_reports` table with support for optional fields.
    *   `fetchScheduledReports`: Retrieves active scheduled reports for a given user, with optional filtering by report ID or company name. It includes a `timeZoneConverter` utility to adjust date and time based on the report's specified timezone.
    *   `editReport`: Allows updating existing scheduled reports.
*   **11/13/2025, 11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where the `companyName` filter incorrectly tried to use `req.query.id` instead of `req.query.CompanyName`. A `console.log` was added for debugging.
*   **11/13/2025, 11:06:07 AM:** The bug in `fetchScheduledReports` was fixed, restoring the correct `companyName` extraction from `req.query.CompanyName`. The `console.log` remained.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
*   **11/13/2025, 11:21:33 AM:** This version introduced robust report history management.
    *   `saveReportHistory`: Saves detailed report execution parameters and status into `public.v2_report_history` using secure parameterized queries.
    *   `getReportHistory`: Retrieves report history with comprehensive filtering options (user ID, name, date range, status, company name), pagination, and sorting. It also uses parameterized queries and calculates total pages.
*   **11/13/2025, 11:22:34 AM:** A `console.log` statement was added to `getReportHistory` for debugging purposes.
*   **11/13/2025, 3:13:42 PM:** The `console.log` statement in `getReportHistory` was removed, reverting the code to its state at 11:21:33 AM.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
*   **11/13/2025, 2:56:24 PM:** This initial commit for the dashboard service provided core functions:
    *   `getDashboardCardInfo`: Retrieves key shipment metrics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents from `mtr_tracking_data`, with filters for date range and company name.
    *   `getDeliveryData`: Fetches either delivery or vessel arrival data, supporting different delivery modes (ALL, Rail, Door, Port Delivery).
*   **11/13/2025, 2:56:30 PM:** Minor, non-functional changes.
*   **11/13/2025, 2:56:43 PM:** The `getDeliveryData` function was updated to apply user-specific conditions (`useWhere`) to the `sqlQueryDelivery` for enhanced access control.
*   **11/13/2025, 2:58:05 PM:**
    *   `getDeliveryData`: The logic for applying `companyFilter` was refined, now using `useWhere` if no specific `CompanyName` is provided. The `SqlQueryVesselArrival` was also updated to explicitly use `useWhere`.
    *   Removed a commented-out block for `CompanyName` in `getDashboardCardInfo`.
*   **11/13/2025, 2:59:21 PM:**
    *   `getDashboardCardInfo`: The `CompanyName` filter was removed from the `baseQuery`, potentially relying solely on `useWhere` being pushed to `conditions` (though this explicit push was missing in this version).
*   **11/13/2025, 3:04:35 PM:**
    *   `getDashboardCardInfo`: Reintroduced and clarified `CompanyName` filtering. `useWhere` is now explicitly added to `conditions`, and `CompanyName` is correctly added as a condition if provided, ensuring proper filtering. A `console.log` was removed.
*   **11/13/2025, 3:05:15 PM:** Minor update to a logging message in `getDashboardCardInfo`. Another `console.log` was removed.
*   **11/13/2025, 3:05:33 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:06:20 PM:** A `console.log(error);` statement was removed from the `catch` block of `getDeliveryData`.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
*   **11/13/2025, 3:06:59 PM:** This significant update introduced the `BookingQueryBuilder` class, a refactor to centralize booking query construction.
    *   The `getAll` function now leverages `BookingQueryBuilder` to fetch bookings, supporting extensive filtering (pagination, sorting, status, POL, POD, shipper, booking type, CompanyName, date ranges).
    *   It also provides aggregated counts for various booking statuses and options for filter dropdowns.
    *   User role-based conditions (`userWhere`) are applied to filter bookings.
*   **11/13/2025, 4:46:10 PM:** In `getAll`, the `CompanyName` filter was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (partial, case-insensitive match), improving flexibility for `CompanyName` searches.
*   **11/13/2025, 4:59:17 PM:** The `BookingQueryBuilder` was enhanced to accept an optional `companyName` parameter in its constructor. This allows ADMIN and ADMIN_V2 users to explicitly filter bookings by a specific company. The `setWhereClause` was updated to incorporate this new filtering capability for admin roles.
*   **11/13/2025, 5:57:22 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
*   **11/13/2025, 3:08:39 PM:** This new file or significant update introduced `getAllBookingPlanbaord`, a function to visualize booking data on a plan board.
    *   It groups bookings by month or week, aggregates total weight and CBM, and determines date ranges for each group.
    *   Data is filtered by `selectedYear` and `CompanyName`.
    *   The `pointModifierForBooking` utility groups and sorts booking points by Port of Discharge (POD).
*   **11/13/2025, 3:09:00 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
*   **11/13/2025, 3:10:59 PM:** This file introduced the `SqlQueryBuilder` class, a sophisticated mechanism for constructing shipment tracking queries.
    *   It dynamically builds queries for 'ocean', 'air', or 'both' transport modes based on user filters.
    *   Includes detailed user role-based access controls for filtering (`ADMIN`, `CUSTOMER`, `FRONTOFFICE`, `AGENT`).
    *   Supports various filters like POL, POD, shipment ID, date range, container number, and CompanyName.
    *   Implements "card filters" for specific shipment statuses (e.g., 'pending_departure', 'in_transit') that apply targeted SQL conditions.
    *   Manages complex status conditions for both air and ocean shipments, mapping abstract statuses to granular database field checks.
    *   Utilizes parameterized queries (`$$` syntax converted to `$N`) for improved security.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
*   **11/13/2025, 3:12:03 PM:** This version introduced the `getAllCompanyDetails` function to fetch distinct company names for AGENT and CUSTOMER roles.
    *   It supports searching and, for `CUSTOMER` role, includes pagination with total count.
    *   Fetches from `agent_po_account_master` for agents and `mtr_tracking_data` for customers.
    *   Initial version contained several `console.log` statements for debugging.
*   **11/13/2025, 3:12:15 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:12:38 PM:** Updated pagination logic for `page` and `perPage` to use the nullish coalescing operator (`??`) for more robust handling of undefined or null query parameters.
*   **11/13/2025, 3:13:07 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
*   **11/13/2025, 3:57:57 PM:** This new utility file introduced `bookingQueryBuilder`, a function designed to construct analytical SQL queries specifically for booking data.
    *   It supports various calculation types like "BookingDatetoActualDeparture" (container-wise and MBL-wise) and their stacked bar chart representations.
    *   Calculates the day difference between booking and actual departure dates, categorizing results for visualization (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   Dynamically selects columns and applies filtering based on `CompanyName`, date ranges, and `displayBy` parameters.

**Patterns and Recurring Elements:**
*   **Query Builder Pattern:** A prominent pattern across `bookingService.ts` and `shipmentService.ts` is the adoption of dedicated "QueryBuilder" classes (`BookingQueryBuilder`, `SqlQueryBuilder`). This indicates a strategic effort to centralize SQL query logic, improve maintainability, enhance security (through parameterized queries), and manage complex filtering and access control.
*   **Company-Specific Filtering:** The ability to filter data by `CompanyName` is a critical and frequently updated feature, appearing in `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, `shipmentService.ts`, and `company-details-service.ts`. This suggests robust multi-tenancy or client-specific data access requirements.
*   **User Role-Based Access Control:** User roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) consistently influence the data retrieved across various services (`bookingService.ts`, `dashboardService.ts`, `shipmentService.ts`, `planbaordService.ts`), highlighting a fine-grained access control model.
*   **Debugging Practices:** Frequent additions and removals of `console.log` statements throughout the log, particularly in `dashboardService.ts` and `reportHistory.ts` during the earlier timestamps, suggest active and iterative debugging during the development process.
*   **Date and Time Handling:** Several services involve complex date and time processing, including timezone conversions (`scheduleReport.ts`) and date range filtering for analytical purposes (`dashboardService.ts`, `reportHistory.ts`, `booking.query.ts`, `planbaordService.ts`, `shipmentService.ts`).
*   **Logger Usage:** Extensive use of `logger.info` and `logger.error` is observed across all files, indicating a strong emphasis on logging for operational monitoring and troubleshooting.

## 9:26:00 AM
The log details recent development focusing on integrating and refining a customer selection mechanism across the application, along with general feature enhancements and bug fixes.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (11/13/2025, 3:15:38 PM - 4:38:13 PM & 5:43:05 PM):**
    *   **Initial Setup (3:15:38 PM):** The layout component ensures user authentication by checking token expiration and redirects if necessary. It also dispatches `initializeSelectedCustomer` and, for `CUSTOMER` roles, sets their company as the selected customer.
    *   **Conditional Rendering Introduced (4:31:01 PM onwards):** A significant change was introduced to conditionally render the main application content (`<Outlet />`) based on whether a `selectedCustomer` exists in the global Redux state. If no customer is selected, a placeholder message "Please select a customer." is displayed. Numerous subsequent commits (from 4:31:51 PM to 4:38:13 PM, and 5:43:05 PM) involve minor styling adjustments and the addition of an `BsInfoCircle` icon to this placeholder message, refining its appearance and alignment.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx` (11/13/2025, 3:16:14 PM & 4:26:07 PM & 4:33:08 PM):**
    *   **Customer Selection for Admins (3:16:14 PM):** Initially, the `SelectCustomerPanel` was conditionally rendered for `ADMIN_V2` users.
    *   **Temporary Menu Hiding (4:26:07 PM):** A change was introduced to hide the entire sidebar menu for `ADMIN_V2` users if no `selectedCustomer` was set, displaying a message instead.
    *   **Reversion (4:33:08 PM):** This conditional hiding of the sidebar menu was reverted, so the menu is always visible, and only the `SelectCustomerPanel` remains conditional for `ADMIN_V2`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (11/13/2025, 3:16:47 PM):**
    *   This file saw a major update to its PDF export functionality. Two older, commented-out PDF generation methods were replaced with a new, more robust implementation using `jsPDF` and `html2canvas-pro`. The new function includes logic to capture dashboard content, convert it to an image, add a logo, and save it as a PDF, with proper loading state management. It also explicitly shows `SelectCustomerPanel` based on user permissions.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx` (11/13/2025, 3:17:47 PM - 5:53:52 PM):**
    *   **Initial Conditional Rendering (3:17:47 PM):** The booking dashboard content was initially conditional on `selectedCustomer`, displaying a message if none was chosen. The `CompanyName` parameter for the data query used `selectedCustomer || localUser?.companyname`.
    *   **Removal of Conditional Rendering (4:27:00 PM):** This conditional rendering of the main dashboard content was removed, making the content always visible.
    *   **API Parameter Refinement (4:50:11 PM, 5:53:52 PM):** The `CompanyName` parameter in the `useFetchBookingDashboardDataQuery` was first changed to `selectedCustomer || ""` (removing the `localUser` fallback) and later to `selectedCustomer || undefined`, indicating a preference for truly optional API parameters over empty strings or fallback values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\planboard\PlanboardCardView.tsx` (11/13/2025, 3:18:16 PM & 3:18:22 PM):**
    *   This component remained largely stable, responsible for displaying planboard data based on selected view (year/month) and year, always considering the `selectedCustomer` for data fetching.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts` (11/13/2025, 3:18:43 PM):**
    *   This configuration file defines the static sidebar menu structure. It includes a rule to disable "Preferences" for `ADMIN_V2` roles and a conditional "Dev" section based on the `VITE_MODE` environment variable.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (11/13/2025, 3:19:32 PM - 5:54:28 PM):**
    *   **API Parameter Refinement (5:54:28 PM):** The `CompanyName` parameter for `useFetchDeliveryDataQuery` was updated from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, aligning with the pattern of making this parameter optional. Other dashboard API calls retain the `localUser` fallback.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx` (11/13/2025, 3:20:12 PM & 5:42:25 PM):**
    *   **Initial Conditional Rendering (3:20:12 PM):** Similar to booking, planboard content was initially hidden if no `selectedCustomer` was set.
    *   **Removal of Conditional Rendering (5:42:25 PM):** This conditional rendering was removed, making the planboard content always visible.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx` (11/13/2025, 3:20:39 PM & 5:41:46 PM):**
    *   This page consistently uses `selectedCustomer ?? undefined` for the `CompanyName` parameter in `useGetReportHistoryQuery`, maintaining its logic throughout the changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx` (11/13/2025, 3:20:56 PM - 5:49:14 PM):**
    *   **Initial Conditional Rendering (3:20:56 PM):** The page content was initially conditional on `selectedCustomer`.
    *   **Removal of Conditional Rendering (5:47:04 PM):** The main content is now always rendered.
    *   **API Parameter Refinement (5:47:04 PM, 5:49:14 PM):** The `CompanyName` parameter for both `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was updated, initially removing `localUser` fallback, and eventually using `selectedCustomer || undefined` to make it optional.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx` (11/13/2025, 3:21:09 PM & 5:48:09 PM):**
    *   **API Parameter Refinement (5:48:09 PM):** The `CompanyName` parameter for `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` was changed from `selectedCustomer || localUser?.companyname` to `selectedCustomer || undefined`, ensuring consistent optional parameter handling.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts` (11/13/2025, 3:23:14 PM & 3:23:24 PM):**
    *   This file provides various static status and filter options with associated colors for shipments, air shipments, reports, team members, and bookings. No significant functional changes were made.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx` (11/13/2025, 5:01:14 PM - 5:35:37 PM):**
    *   **Complex Conditional Rendering and API Guards (Repeated changes throughout):** This file saw the most volatile changes, particularly regarding the conditional rendering of `AnalyticsContainer` and the API calls within its `useEffect`.
        *   The logic for displaying a "Please Select Any Customer" message versus `AnalyticsContainer` for `ADMIN_V2` users was repeatedly toggled and refined, aiming for `ADMIN_V2` users to only see analytics when a customer is selected.
        *   Guard clauses (`if (!user?.userid || !mainState.selectedDashobard || !selectedCustomer) return;`) were added and removed from the main data fetching `useEffect`, indicating an ongoing effort to prevent API calls with incomplete parameters.
        *   The `companyname` parameter in analytics API queries consistently uses `selectedCustomer`.
        *   The global `setLoading` state from `global-slice.ts` was integrated for loading indicators.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts` (11/13/2025, 5:05:40 PM):**
    *   This new Redux slice was introduced to manage application-wide state. It centralizes `selectedCustomer` (with `localStorage` persistence) and a general `loading` boolean, allowing these states to be easily accessed and modified across the application.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx` (11/13/2025, 5:37:21 PM - 5:54:48 PM):**
    *   **Customer-Based Fetching (5:37:21 PM):** The component fetches notification data based on `selectedCustomer || ""`.
    *   **Minor Refinements (5:38:36 PM - 5:54:48 PM):** Subsequent changes involve minor bug fixes like explicitly checking for `mblno` before navigation, briefly changing and then reverting the loading skeleton count, removing a duplicate `useNavigate` import, and refining a prop type definition.

**Patterns and Recurring Elements:**

1.  **Centralized Customer Context (`selectedCustomer`):** The most significant pattern is the extensive use of `selectedCustomer` from a global Redux slice. This state variable dictates data fetching parameters and conditional UI rendering across almost all application pages and core components, indicating a strong emphasis on a multi-customer architecture where data is always filtered by the currently selected customer.
2.  **API Query Parameter Normalization:** There's a clear trend of updating API query parameters for `CompanyName` from `selectedCustomer || localUser?.companyname` or `selectedCustomer || ""` to `selectedCustomer || undefined`. This suggests a move towards standardizing how optional company-specific data is requested, preferring `undefined` for omitted parameters rather than empty strings or user-specific fallbacks, which typically leads to cleaner API behavior.
3.  **Conditional Content Rendering:** Many pages (`layout.tsx`, `booking-dashboard.tsx`, `planboard-page.tsx`, `shipment-container-page.tsx`, `analytics-page.tsx`) initially included or frequently adjusted logic to hide primary content and display a "Please select a customer" message if no customer was chosen, especially for administrative roles. While this was sometimes added and then reverted in some files (e.g., `booking-dashboard.tsx`, `planboard-page.tsx`), the `layout.tsx` and `analytics-page.tsx` show a sustained effort to enforce this behavior for admin users.
4.  **Redux for Global State Management:** The introduction of `global-slice.ts` formalizes the management of application-wide concerns like `selectedCustomer` and a general `loading` state, demonstrating a commitment to a predictable state management pattern.
5.  **UI/UX Refinements:** Numerous small changes related to styling (`className` adjustments, icon additions) suggest an ongoing iterative process of improving the user interface and experience.
6.  **Loading Indicators:** Consistent use of loading states and components (`Loader`, `Spinner`, skeleton loaders) indicates attention to user feedback during data fetching operations.

## 10:25:40 AM
The code changes primarily focus on refining data querying, filtering, and presentation across several backend services, with a recurring emphasis on company-specific data access and robust SQL query construction.

***

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   **Initial state (11/13/2025, 10:50:09 AM):** This file contains functionalities for scheduling (`setReport`), fetching (`fetchScheduledReports`), and editing (`editReport`) user reports. It includes a `timeZoneConverter` for date/time adjustments. The `fetchScheduledReports` function filters by `user_id` and `status = 'active'`, and optionally by `id` and `CompanyName`.
    *   **Minor bug and revert (11/13/2025, 11:03:19 AM - 11:06:07 AM):** A change was introduced where `CompanyName` in `fetchScheduledReports` was mistakenly assigned `req.query.id`, which was then corrected within minutes back to `req.query.CompanyName`. A `console.log` statement was added during this process and remains in the later version.
    *   **Final state (11/13/2025, 3:14:00 PM):** No significant changes from the corrected version at 11:06:07 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   **Initial state (11/13/2025, 11:21:33 AM):** This file manages report history, including `saveReportHistory` (inserting into `v2_report_history` with various report parameters) and `getReportHistory`. The `getReportHistory` function supports pagination, sorting, and filtering by `user_id`, `CompanyName`, report `name`, date ranges (`fromDate`, `toDate`), and `status`. It uses parameterized queries for enhanced security.
    *   **Minor debugging (11/13/2025, 11:22:34 AM - 3:13:42 PM):** A `console.log` statement was temporarily added to `getReportHistory` to inspect the `CompanyName` query parameter, and subsequently removed.
    *   **Final state (11/13/2025, 3:13:42 PM):** The code reverts to a clean state similar to the initial one, with the `console.log` removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Initial state (11/13/2025, 2:56:24 PM):** Contains `getDashboardCardInfo` for fetching aggregated shipment statistics (pending departure, in transit, ETA within 1 week, out for delivery) and `getDeliveryData` for fetching detailed delivery or vessel arrival information. Both functions apply filtering by `CompanyName` and incorporate user-specific conditions (`buildMtrUserCondition`).
    *   **Refinement of `useWhere` and `companyFilter` (11/13/2025, 2:56:43 PM - 2:58:05 PM):** The `getDeliveryData` function was updated to explicitly include `useWhere` conditions in the `sqlQueryDelivery`. The `companyFilter` logic was changed to default to `useWhere` if no `CompanyName` is provided, rather than an empty string, ensuring user-specific filtering is always applied.
    *   **`CompanyName` filter logic refactor (11/13/2025, 2:59:21 PM):** The `getDashboardCardInfo` function's handling of the `CompanyName` filter was refactored. Instead of directly injecting it into the base query's `WHERE` clause, it now adds it to a `conditions` array, ensuring consistent application alongside other conditions. `buildMtrUserCondition` (`useWhere`) is now also conditionally pushed into the `conditions` array.
    *   **Logging and debugging (11/13/2025, 3:04:35 PM - 3:07:52 PM):** Minor `logger.info` messages were adjusted, and multiple `console.log` statements for debugging `req.query`, `CompanyName`, and `companyFilter` were added and subsequently removed.
    *   **Final state (11/13/2025, 3:07:52 PM):** The final version removes debug `console.log` statements, leaving the refined filtering logic in place.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Initial state (11/13/2025, 3:06:59 PM):** This service defines a `BookingQueryBuilder` class to construct dynamic SQL queries for booking data. It supports various filters, pagination, and sorting, and calculates counts for different booking statuses. The `getAll` endpoint uses this builder.
    *   **Filter type change (11/13/2025, 4:46:10 PM):** The `CompanyName` filter for `abe.customer` was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (ILIKE search).
    *   **Admin company filter enhancement (11/13/2025, 4:59:17 PM):** The `BookingQueryBuilder` was modified to allow "ADMIN" and "ADMIN_V2" roles to filter bookings by a specific `companyName` passed to the constructor. This `companyName` filter takes precedence over the default `1=1` for admins in the `setWhereClause` method.
    *   **Final state (11/13/2025, 5:57:22 PM):** No further changes were detected from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   **Initial state (11/13/2025, 3:08:39 PM):** The `getAllBookingPlanbaord` function retrieves booking plan board data, grouped by month or week, for a specified year. It includes data aggregation (total weight, total CBM) and date range calculations. User-specific and `CompanyName` filtering logic is applied, with `CompanyName` from query params taking precedence for filtering. Booking points are modified to be grouped by `pod` (Port of Discharge).
    *   **Final state (11/13/2025, 3:09:00 PM):** No changes detected.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Initial state (11/13/2025, 3:10:59 PM):** This file defines a comprehensive `SqlQueryBuilder` class for both ocean and air shipment tracking data. It supports a wide range of filters (POL, POD, shipment_id, container_no, CompanyName, date ranges), shipment statuses, user roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT), and view types ("container" or "shipment"). It also includes logic for card-based dashboard filters (pending departure, in transit, ETA within 1 week, out for delivery).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   **Initial state (11/13/2025, 3:12:03 PM):** The `getAllCompanyDetails` function fetches distinct company names based on the user's `role` (AGENT from `agent_po_account_master` or CUSTOMER from `mtr_tracking_data`). It implements optional pagination with `LIMIT` and `OFFSET`.
    *   **Nullish coalescing operator adoption (11/13/2025, 3:12:38 PM):** The assignment of default values for `page` and `perPage` was updated from the logical OR operator (`||`) to the nullish coalescing operator (`??`), providing more precise default handling (i.e., defaults apply only for `null` or `undefined`, not for falsy values like `0` or empty strings).
    *   **Final state (11/13/2025, 3:13:07 PM):** No changes detected.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Initial state (11/13/2025, 3:57:57 PM):** This utility file contains the `bookingQueryBuilder` function, which dynamically generates SQL queries for various booking analytics. It supports different analysis types (e.g., "BookingDatetoActualDeparture", "BookingDatetoActualDepartureMblWise", "BookingDatetoActualDepartureStackedBar") by constructing complex `WITH` clauses and conditional logic based on `CompanyName`, date ranges, and user preferences. It also integrates `getColumnsByCategory` and `getFilterQueryByDisplayValue` for flexible column selection and display formatting.

### Patterns and Recurring Elements:

*   **`CompanyName` Filtering:** Almost all services (`scheduleReport`, `reportHistory`, `dashboardService`, `planbaordService`, `shipmentService`, `bookingService`, `analytics\company-details-service`, `booking.query`) show active development and refinement around filtering data by `CompanyName`. This highlights a consistent requirement for multi-tenancy or company-specific data views.
*   **User Role-Based Access Control:** Several services (`dashboardService`, `bookingService`, `planbaordService`, `shipmentService`) implement logic (`userWhere` or similar) to restrict data access based on the authenticated user's role (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT), indicating a security-conscious design.
*   **Dynamic SQL Query Building:** There's a strong pattern of using dedicated classes (`BookingQueryBuilder`, `SqlQueryBuilder`) or functions (`bookingQueryBuilder`) to programmatically construct complex SQL queries. This approach facilitates maintainability, reusability, and parameterized query execution for security against SQL injection.
*   **Extensive Logging:** `logger.info` and `logger.error` are ubiquitous across all files, indicating a thorough logging strategy for monitoring application flow, debugging, and error tracking.
*   **Debugging with `console.log`:** Numerous `console.log` statements were temporarily added and removed across several files, particularly `dashboardService.ts` and `reportHistory.ts`, suggesting iterative development and active debugging sessions.
*   **Pagination and Sorting:** Implemented in `reportHistory.ts`, `bookingService.ts`, and `analytics\company-details-service.ts` for efficient handling of large datasets in API responses.
*   **Date and Timezone Handling:** `scheduleReport.ts` includes explicit `timeZoneConverter` utilities, indicating the importance of accurate date and time presentation across different timezones.
*   **Refinement of Query Operators:** The subtle change from `||` to `??` in `analytics\company-details-service.ts` demonstrates an evolution towards more precise handling of `null` and `undefined` values in TypeScript.
*   **Iterative Development:** The tight sequence of timestamps within a short period for multiple files (e.g., `dashboardService.ts` and `company-details-service.ts`) suggests rapid, iterative development, possibly involving immediate testing and fixes.

## 10:25:59 AM
The code changes primarily focus on refining customer selection and data loading mechanisms across various frontend components. A recurring pattern involves the integration of a `selectedCustomer` state (managed globally via Redux) to filter data and conditionally render UI elements.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`** (Numerous changes between 11/13/2025, 3:15:38 PM and 4:38:13 PM, then a final minor save at 5:43:05 PM):
    *   Initially set up with token expiration handling and Redux dispatch for customer initialization.
    *   A significant update at **4:31:01 PM** introduced conditional rendering: the main application content (`<Outlet />`) is now displayed only if a `selectedCustomer` exists in the global Redux state; otherwise, a "Please select a customer" placeholder message appears.
    *   Subsequent commits refined the styling, positioning, and content of this placeholder message, eventually incorporating an informational icon (`<BsInfoCircle />`) for better user guidance (e.g., at **4:36:09 PM** and **4:37:13 PM**).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`** (Changes at 11/13/2025, 3:16:14 PM, 4:26:07 PM, and 4:33:08 PM):
    *   The sidebar displays navigation items and a customer selection panel for "ADMIN\_V2" roles.
    *   A notable change at **4:26:07 PM** attempted to conditionally hide the entire sidebar menu for "ADMIN\_V2" users if no customer was selected, displaying a "Please select a customer to view the menu" message. This change was then **reverted at 4:33:08 PM**, restoring the sidebar menu to always be visible, with only the `SelectCustomerPanel` remaining conditional for admins.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`** (Single entry at 11/13/2025, 3:16:47 PM):
    *   This component was introduced, providing a toolbar for analytics dashboards.
    *   It manages Redux state for filters and dashboard views, and includes a sophisticated PDF export feature using `jspdf` and `html2canvas-pro`, with commented-out code demonstrating the evolution of the PDF generation logic.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-dashboard.tsx`** (Changes between 11/13/2025, 3:17:47 PM and 5:53:52 PM):
    *   Initially included a page-level conditional render that would display a "Please select a customer" message if `selectedCustomer` was not set. This conditional rendering was **removed at 4:27:00 PM**.
    *   The `CompanyName` parameter in API calls (`useFetchBookingDashboardDataQuery`) was initially `selectedCustomer || localUser?.companyname`, briefly changed to `selectedCustomer || ""` at **4:50:11 PM**, and then standardized to `selectedCustomer || undefined` at **5:53:52 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\planboard\PlanboardCardView.tsx`** (Minor changes at 11/13/2025, 3:18:16 PM and 3:18:22 PM):
    *   Displays planboard data in year or month views, fetching data based on `view`, `selectedYear`, and `selectedCustomer`. No significant functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts`** (Single entry at 11/13/2025, 3:18:43 PM):
    *   Defines the application's sidebar menu structure, with dynamic disabling of "Preferences" for "ADMIN\_V2" and a conditional "Dev" section based on environment variables.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`** (Changes between 11/13/2025, 3:19:32 PM and 5:54:28 PM):
    *   Manages the main dashboard with shipment overviews and a calendar.
    *   The `CompanyName` parameter for `useFetchDeliveryDataQuery` was updated from an implicit `selectedCustomer || ""` to `selectedCustomer || undefined` at **5:46:38 PM**, aligning with other components.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx`** (Changes at 11/13/2025, 3:20:12 PM and 5:42:25 PM):
    *   Initially had a page-level conditional render based on `selectedCustomer`. This conditional rendering was **removed at 5:42:25 PM**, allowing the planboard UI to load even without a selected customer.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx`** (Changes at 11/13/2025, 3:20:39 PM and 5:41:46 PM):
    *   Manages scheduled and recent reports, including Excel download functionality.
    *   Similar to `planboard-page.tsx`, the page-level conditional render based on `selectedCustomer` was **removed at 5:41:46 PM**. The `CompanyName` parameter for `useGetReportHistoryQuery` was adjusted to `selectedCustomer ?? undefined`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-container-page.tsx`** (Changes between 11/13/2025, 3:20:56 PM and 5:49:14 PM):
    *   Displays shipment data in a container view. It consistently retains its page-level conditional rendering based on `selectedCustomer` throughout the logs.
    *   The `CompanyName` parameter in API calls was refined from `selectedCustomer || ""` to `selectedCustomer || undefined` at **5:48:40 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\shipment\shipment-page.tsx`** (Changes between 11/13/2025, 3:21:09 PM and 5:48:09 PM):
    *   Provides a comprehensive shipment view with various filters and data cards.
    *   The `CompanyName` parameter in API calls was standardized to `selectedCustomer || undefined` at **5:48:09 PM**.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts`** (Minor changes at 11/13/2025, 3:23:14 PM and 3:23:24 PM):
    *   This file defines global constants for status types, roles, filter options, and inventory types. No significant changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`** (Single entry at 11/13/2025, 5:05:40 PM):
    *   Introduced a new Redux slice to manage `selectedCustomer` (persisting to `localStorage`) and a global `loading` state, indicating a new or refined global state management approach.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`** (Extensive and iterative changes between 11/13/2025, 5:01:14 PM and 5:35:37 PM):
    *   Underwent significant refactoring regarding conditional rendering and data fetching for analytics.
    *   Initially had conditional rendering for `AnalyticsContainer` based on `user.role === "ADMIN_V2" && !selectedCustomer`. This logic was frequently modified and refined across multiple commits.
    *   At **5:06:27 PM**, the loading state management was shifted to use the global `setLoading` from `global-slice.ts`.
    *   The main `useEffect` for data fetching was updated multiple times, notably at **5:33:03 PM**, to include `!selectedCustomer` as a guard clause, ensuring analytics data is only fetched when a customer is selected.
    *   The UI rendering for "ADMIN\_V2" users also evolved to display a "Please Select Any Customer" message when no customer is active (e.g., at **5:17:16 PM** and **5:20:12 PM**), otherwise rendering `AnalyticsContainer` potentially with a loading spinner.

**Patterns and Recurring Elements:**

*   **Customer-Centric Data Loading:** Almost all data-fetching components (`booking-dashboard`, `dashboard-page`, `planboard-page`, `report-page`, `shipment-container-page`, `shipment-page`, `analytics-page`, `notification-page`) now incorporate `selectedCustomer` in their API query parameters. This is a crucial functional pattern across the application.
*   **Dynamic UI based on `selectedCustomer`:** Many pages (`layout`, `sidebar`, `analytics-page`, `shipment-container-page`) conditionally render their primary content or display "Please select a customer" messages. This indicates a consistent user experience approach for multi-customer environments.
*   **Redux for Global State and RTK Query for Data:** The application heavily relies on Redux for managing UI state (filters, pagination, selected customer) and RTK Query for efficient data fetching and caching.
*   **API Parameter Fallback Standardization:** There's a clear trend to standardize fallback values for the `CompanyName` parameter in API queries, moving from `selectedCustomer || localUser?.companyname` or `selectedCustomer || ""` to `selectedCustomer || undefined`.
*   **Iterative UI/UX Refinement:** Especially in `layout.tsx` and `analytics-page.tsx`, there are numerous small changes to styling, message content, and conditional rendering logic, indicating an iterative development process for user experience.
*   **Consistent Loading Indicators:** Components frequently use `isLoading` and `isFetching` states from RTK Query to display loading components (`Loader`, `Spinner`), improving feedback to the user.
*   **All changes occurred on 11/13/2025**, suggesting a concentrated period of development, likely a single sprint or feature implementation effort.

## 11:25:53 AM
The provided code changes, all dated **11/13/2025**, reflect active development across several backend services related to reports, dashboards, bookings, and analytics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   This file handles scheduling, fetching, and editing user reports.
    *   **10:50:09 AM:** Initial state included `setReport` (report creation), `fetchScheduledReports` (retrieval with `reportId` and `companyName` filters), and `editReport` (update). A `timeZoneConverter` utility was present for date/time adjustments.
    *   **11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where `companyName` was incorrectly assigned `req.query.id`. A debugging `console.log` was added.
    *   **11:06:07 AM:** The bug in `fetchScheduledReports` was promptly reverted, restoring `companyName` to `req.query.CompanyName`. The `console.log` remained.
    *   **3:14:00 PM:** The code was identical to the 11:06:07 AM version, indicating a re-save or minor non-functional change.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   This file manages saving and retrieving user report execution history.
    *   **11:21:33 AM:** Introduced `saveReportHistory` (to persist report parameters) and `getReportHistory` (to fetch history with pagination, sorting, and various filters like name, date range, status, and company name). This file notably uses **parameterized SQL queries**, a secure practice.
    *   **11:22:34 AM:** A `console.log` for `CompanyName` was added within `getReportHistory` for debugging.
    *   **3:13:42 PM:** The debugging `console.log` was removed, reverting to the functional state of 11:21:33 AM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   This file provides data for dashboard cards and delivery/vessel information.
    *   **2:56:24 PM:** Initial code for `getDashboardCardInfo` (summary stats) and `getDeliveryData` (delivery/vessel lists). Both functions filtered by `CompanyName` and used `buildMtrUserCondition` for user-specific access.
    *   **2:56:43 PM:** `useWhere` conditions were added to `sqlQueryDelivery` in `getDeliveryData`.
    *   **2:58:05 PM:** In `getDeliveryData`, the `companyFilter` logic was changed to default to `useWhere` if `CompanyName` is not provided, altering filter behavior for non-admin users.
    *   **2:59:21 PM:** `getDashboardCardInfo` temporarily removed direct `CompanyName` filtering from its `baseQuery`.
    *   **3:04:35 PM:** The direct `CompanyName` filtering was re-added to `getDashboardCardInfo`, correcting the previous change. Several `console.log` statements were removed.
    *   **3:05:15 PM - 3:07:52 PM:** A series of minor changes primarily involved removing debugging `console.log` statements from both `getDashboardCardInfo` and `getDeliveryData`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   Manages booking data using a `BookingQueryBuilder` class.
    *   **3:06:59 PM:** The `BookingQueryBuilder` class was detailed, offering extensive filtering, sorting, and pagination for booking data, including fetching counts for various booking statuses and options for filter dropdowns.
    *   **4:46:10 PM:** The `CompanyName` filter in `getAll` was changed from an exact match (`addFilterClause`) to a wildcard search (`addSearchClause`).
    *   **4:59:17 PM:** The `BookingQueryBuilder` constructor was updated to accept an optional `companyName` parameter, and the `setWhereClause` logic for `ADMIN`/`ADMIN_V2` roles was modified to use this parameter. However, the `getAll` function did not pass `CompanyName` to the constructor in this entry, potentially limiting the immediate impact of this refactoring.
    *   **5:57:22 PM:** The code was identical to the 4:59:17 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   Retrieves booking planboard data, grouped by month or week.
    *   **3:08:39 PM:** Provided functionality to fetch planboard data for a `selectedYear`, with filtering by `CompanyName` and display options for `month` or `week_number` views. Helper functions `getFromDateToDate` and `pointModifierForBooking` were included.
    *   **3:09:00 PM:** The code was identical to the 3:08:39 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   Contains `SqlQueryBuilder` for complex shipment tracking queries.
    *   **3:10:59 PM:** A comprehensive `SqlQueryBuilder` class was defined, supporting a wide array of filters (transport mode, POL, POD, shipment ID, container number, CompanyName), status conditions for both ocean and air, card filters, pagination, and user-role-based access control. This file consistently uses **parameterized SQL queries**. The provided log entry for this file is a single, detailed snapshot.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   Provides an endpoint to retrieve company names based on user role.
    *   **3:12:03 PM:** Introduced `getAllCompanyDetails`, fetching distinct company names for AGENT or CUSTOMER roles, with search and pagination for customers. Parameterized SQL queries were used.
    *   **3:12:38 PM:** A minor refinement was made to default `page` and `perPage` using the **nullish coalescing operator (`??`)** instead of logical OR (`||`), improving how default values are handled for `null` or `undefined`.
    *   **3:12:15 PM & 3:13:07 PM:** These entries were identical to previous versions, representing re-saves.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   A utility file for generating SQL queries for booking analytics.
    *   **3:57:57 PM:** Contains the `bookingQueryBuilder` function, which creates complex SQL queries for various "Booking date to actual departure" metrics (container-wise, MBL-wise, stacked bar charts). **Crucially, this file directly concatenates user-provided values like `CompanyName`, `fromDate`, and `toDate` into its SQL queries**, creating a significant **SQL injection vulnerability**.

**Patterns and Recurring Elements:**

1.  **Concentrated Development:** All changes occurred on a single date, **11/13/2025**, with a burst of activity between **10:50 AM and 5:57 PM**, indicating focused development or hotfixes.
2.  **SQL Query Security Discrepancy:** A major pattern is the inconsistent use of secure SQL query practices:
    *   **Secure (Parameterized Queries):** `reportHistory.ts`, `shipmentService.ts`, and `company-details-service.ts` (for customer logic) use parameterized queries (`$1`, `$$`), which is the recommended secure approach.
    *   **Vulnerable (String Concatenation):** `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, and critically, `booking.query.ts` (especially with `CompanyName`, `fromDate`, `toDate`) construct SQL queries using direct string concatenation, making them susceptible to SQL injection.
3.  **Debugging Practices:** Frequent additions and removals of `console.log` statements are seen across `scheduleReport.ts`, `reportHistory.ts`, `dashboardService.ts`, and `company-details-service.ts`, indicative of active debugging during the development process.
4.  **Company-Based Filtering:** `CompanyName` is a ubiquitous filter parameter across almost all services (`scheduleReport`, `dashboardService`, `bookingService`, `planbaordService`, `shipmentService`, `company-details-service`, `booking.query.ts`), reflecting a core business requirement. Its implementation varies in security and robustness.
5.  **User Role-Based Access Control:** Many services implement logic to filter data based on the user's role (e.g., ADMIN, CUSTOMER, AGENT), ensuring data visibility adheres to permissions.
6.  **Error Handling:** A consistent pattern of `try-catch` blocks with `logger.error` and generic `Internal Server Error` responses is used across files.
7.  **Pagination and Sorting:** Implemented in `reportHistory.ts`, `bookingService.ts`, and `company-details-service.ts` for efficient data retrieval and display.