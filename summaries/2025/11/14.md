# Activity Summary for 11/14/2025

## 9:25:52 AM
The changes log details a day of active development across several backend services, focusing primarily on data retrieval, filtering, and reporting functionalities. All modifications occurred on **November 13, 2025**.

Here's a breakdown of the key information by file:

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
*   **11/13/2025, 10:50:09 AM:** This version established the core functionalities for managing user-scheduled reports.
    *   `setReport`: Handles the creation of new user reports, inserting data into the `v2_user_reports` table with support for optional fields.
    *   `fetchScheduledReports`: Retrieves active scheduled reports for a given user, with optional filtering by report ID or company name. It includes a `timeZoneConverter` utility to adjust date and time based on the report's specified timezone.
    *   `editReport`: Allows updating existing scheduled reports.
*   **11/13/2025, 11:03:19 AM:** A bug was introduced in `fetchScheduledReports` where the `companyName` filter incorrectly tried to use `req.query.id` instead of `req.query.CompanyName`. A `console.log` was added for debugging.
*   **11/13/2025, 11:06:07 AM:** The bug in `fetchScheduledReports` was fixed, restoring the correct `companyName` extraction from `req.query.CompanyName`. The `console.log` remained.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
*   **11/13/2025, 11:21:33 AM:** This version introduced robust report history management.
    *   `saveReportHistory`: Saves detailed report execution parameters and status into `public.v2_report_history` using secure parameterized queries.
    *   `getReportHistory`: Retrieves report history with comprehensive filtering options (user ID, name, date range, status, company name), pagination, and sorting. It also uses parameterized queries and calculates total pages.
*   **11/13/2025, 11:22:34 AM:** A `console.log` statement was added to `getReportHistory` for debugging purposes.
*   **11/13/2025, 3:13:42 PM:** The `console.log` statement in `getReportHistory` was removed, reverting the code to its state at 11:21:33 AM.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
*   **11/13/2025, 2:56:24 PM:** This initial commit for the dashboard service provided core functions:
    *   `getDashboardCardInfo`: Retrieves key shipment metrics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents from `mtr_tracking_data`, with filters for date range and company name.
    *   `getDeliveryData`: Fetches either delivery or vessel arrival data, supporting different delivery modes (ALL, Rail, Door, Port Delivery).
*   **11/13/2025, 2:56:30 PM:** Minor, non-functional changes.
*   **11/13/2025, 2:56:43 PM:** The `getDeliveryData` function was updated to apply user-specific conditions (`useWhere`) to the `sqlQueryDelivery` for enhanced access control.
*   **11/13/2025, 2:58:05 PM:**
    *   `getDeliveryData`: The logic for applying `companyFilter` was refined, now using `useWhere` if no specific `CompanyName` is provided. The `SqlQueryVesselArrival` was also updated to explicitly use `useWhere`.
    *   Removed a commented-out block for `CompanyName` in `getDashboardCardInfo`.
*   **11/13/2025, 2:59:21 PM:**
    *   `getDashboardCardInfo`: The `CompanyName` filter was removed from the `baseQuery`, potentially relying solely on `useWhere` being pushed to `conditions` (though this explicit push was missing in this version).
*   **11/13/2025, 3:04:35 PM:**
    *   `getDashboardCardInfo`: Reintroduced and clarified `CompanyName` filtering. `useWhere` is now explicitly added to `conditions`, and `CompanyName` is correctly added as a condition if provided, ensuring proper filtering. A `console.log` was removed.
*   **11/13/2025, 3:05:15 PM:** Minor update to a logging message in `getDashboardCardInfo`. Another `console.log` was removed.
*   **11/13/2025, 3:05:33 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:06:20 PM:** A `console.log(error);` statement was removed from the `catch` block of `getDeliveryData`.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
*   **11/13/2025, 3:06:59 PM:** This significant update introduced the `BookingQueryBuilder` class, a refactor to centralize booking query construction.
    *   The `getAll` function now leverages `BookingQueryBuilder` to fetch bookings, supporting extensive filtering (pagination, sorting, status, POL, POD, shipper, booking type, CompanyName, date ranges).
    *   It also provides aggregated counts for various booking statuses and options for filter dropdowns.
    *   User role-based conditions (`userWhere`) are applied to filter bookings.
*   **11/13/2025, 4:46:10 PM:** In `getAll`, the `CompanyName` filter was changed from `addFilterClause` (exact match from a list) to `addSearchClause` (partial, case-insensitive match), improving flexibility for `CompanyName` searches.
*   **11/13/2025, 4:59:17 PM:** The `BookingQueryBuilder` was enhanced to accept an optional `companyName` parameter in its constructor. This allows ADMIN and ADMIN_V2 users to explicitly filter bookings by a specific company. The `setWhereClause` was updated to incorporate this new filtering capability for admin roles.
*   **11/13/2025, 5:57:22 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
*   **11/13/2025, 3:08:39 PM:** This new file or significant update introduced `getAllBookingPlanbaord`, a function to visualize booking data on a plan board.
    *   It groups bookings by month or week, aggregates total weight and CBM, and determines date ranges for each group.
    *   Data is filtered by `selectedYear` and `CompanyName`.
    *   The `pointModifierForBooking` utility groups and sorts booking points by Port of Discharge (POD).
*   **11/13/2025, 3:09:00 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
*   **11/13/2025, 3:10:59 PM:** This file introduced the `SqlQueryBuilder` class, a sophisticated mechanism for constructing shipment tracking queries.
    *   It dynamically builds queries for 'ocean', 'air', or 'both' transport modes based on user filters.
    *   Includes detailed user role-based access controls for filtering (`ADMIN`, `CUSTOMER`, `FRONTOFFICE`, `AGENT`).
    *   Supports various filters like POL, POD, shipment ID, date range, container number, and CompanyName.
    *   Implements "card filters" for specific shipment statuses (e.g., 'pending_departure', 'in_transit') that apply targeted SQL conditions.
    *   Manages complex status conditions for both air and ocean shipments, mapping abstract statuses to granular database field checks.
    *   Utilizes parameterized queries (`$$` syntax converted to `$N`) for improved security.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
*   **11/13/2025, 3:12:03 PM:** This version introduced the `getAllCompanyDetails` function to fetch distinct company names for AGENT and CUSTOMER roles.
    *   It supports searching and, for `CUSTOMER` role, includes pagination with total count.
    *   Fetches from `agent_po_account_master` for agents and `mtr_tracking_data` for customers.
    *   Initial version contained several `console.log` statements for debugging.
*   **11/13/2025, 3:12:15 PM:** Minor, non-functional changes.
*   **11/13/2025, 3:12:38 PM:** Updated pagination logic for `page` and `perPage` to use the nullish coalescing operator (`??`) for more robust handling of undefined or null query parameters.
*   **11/13/2025, 3:13:07 PM:** Minor, non-functional changes.

**`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
*   **11/13/2025, 3:57:57 PM:** This new utility file introduced `bookingQueryBuilder`, a function designed to construct analytical SQL queries specifically for booking data.
    *   It supports various calculation types like "BookingDatetoActualDeparture" (container-wise and MBL-wise) and their stacked bar chart representations.
    *   Calculates the day difference between booking and actual departure dates, categorizing results for visualization (e.g., 'Less than 1 week', '1 - 2 weeks').
    *   Dynamically selects columns and applies filtering based on `CompanyName`, date ranges, and `displayBy` parameters.

**Patterns and Recurring Elements:**
*   **Query Builder Pattern:** A prominent pattern across `bookingService.ts` and `shipmentService.ts` is the adoption of dedicated "QueryBuilder" classes (`BookingQueryBuilder`, `SqlQueryBuilder`). This indicates a strategic effort to centralize SQL query logic, improve maintainability, enhance security (through parameterized queries), and manage complex filtering and access control.
*   **Company-Specific Filtering:** The ability to filter data by `CompanyName` is a critical and frequently updated feature, appearing in `scheduleReport.ts`, `dashboardService.ts`, `bookingService.ts`, `planbaordService.ts`, `shipmentService.ts`, and `company-details-service.ts`. This suggests robust multi-tenancy or client-specific data access requirements.
*   **User Role-Based Access Control:** User roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) consistently influence the data retrieved across various services (`bookingService.ts`, `dashboardService.ts`, `shipmentService.ts`, `planbaordService.ts`), highlighting a fine-grained access control model.
*   **Debugging Practices:** Frequent additions and removals of `console.log` statements throughout the log, particularly in `dashboardService.ts` and `reportHistory.ts` during the earlier timestamps, suggest active and iterative debugging during the development process.
*   **Date and Time Handling:** Several services involve complex date and time processing, including timezone conversions (`scheduleReport.ts`) and date range filtering for analytical purposes (`dashboardService.ts`, `reportHistory.ts`, `booking.query.ts`, `planbaordService.ts`, `shipmentService.ts`).
*   **Logger Usage:** Extensive use of `logger.info` and `logger.error` is observed across all files, indicating a strong emphasis on logging for operational monitoring and troubleshooting.