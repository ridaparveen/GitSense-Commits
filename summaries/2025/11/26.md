# Activity Summary for 11/26/2025

## 11:10:56 AM
The changes primarily involve enhancements and debugging related to an Anchor JSON data export and SFTP upload process, alongside configuration updates.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\config\config.js`**
    *   **11/26/2025, 10:15:44 AM:** Initial setup for Anchor JSON integration. This included defining a new `sftpConfigJSON` (SFTP configuration for Anchor Ingredients) with host, port, and username. It also added an `anchor24HrJsonReport` email list for development and commented out local file paths for Anchor JSON files.
    *   **11/26/2025, 10:18:03 AM:** The `anchor24HrJsonReport` email distribution list in the development environment was expanded to include an additional recipient.
    *   **11/26/2025, 10:36:34 AM:** Local development paths `anchorJsonFilePath` and `anchorJsonArcFilePath` were uncommented and defined, pointing to a specific user directory.
    *   **11/26/2025, 11:02:32 AM:** The `anchorJsonArcFilePath` in the development environment was updated to specify an `archive` subdirectory for processed files.
    *   **11/26/2025, 11:08:48 AM:** The SFTP configuration key `sftpConfigJSON` was renamed to `anchorSftpConfigJSON` across both development and production environments, indicating a more specific naming convention for Anchor-related SFTP settings.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\anchorJsonUploadToSftp.js`**
    *   **11/26/2025, 10:15:53 AM:** This file was introduced or significantly updated to include the `AnchorJsonData` class. This class is responsible for:
        *   Retrieving a `last_run_timestamp` from `anchor_json_run.json` to enable incremental data fetching.
        *   Connecting to an SFTP server.
        *   Fetching shipment data from a database (`mtr_tracking_data`, `agent_booking_entry`, `t49_tracking_details`, `po_details`) for 'ANCHOR INGREDIENTS CO.' within a specified time window.
        *   Formatting the fetched data into a JSON structure, including booking details, MBL/BL numbers, dates (ETD, ATD, ETA, ATA), customs information, PO numbers, and container milestones.
        *   Generating a JSON file (`Anchor_Ingredients_Shipment_YYYY-MM-DD_HH-mm-ss.json`) locally.
        *   Uploading this JSON file to a remote `/anchor` directory on the SFTP server.
        *   Moving the local JSON file to an archive path after successful upload.
        *   Updating the `last_run_timestamp` in `anchor_json_run.json`.
        *   Sending email notifications to `execptionMailList` upon errors.
    *   **11/26/2025, 10:32:20 AM:** A minor correction was made to the email subject line for error reports, changing `fromDate` and `toDate` to `this.fromDate` and `this.toDate`, though `this.fromDate` and `this.toDate` were not defined as class properties, suggesting a potential logical error.
    *   **11/26/2025, 10:35:49 AM:** The SFTP connection method was updated to use `config.sftpConfig7501` instead of `config.sftpConfigJSON`. This is a significant change, redirecting the SFTP connection to a different configuration.
    *   **11/26/2025, 10:37:58 AM:** The remote path for SFTP upload was modified from `/anchor/${fileName}` to `./anchor/${fileName}`, potentially altering the target directory structure on the SFTP server.
    *   **11/26/2025, 10:45:05 AM:** Logic was introduced to ensure the local directory for generating JSON files exists, with a fallback to a `tempDir` if `anchorJsonFilePath` is not specified.
    *   **11/26/2025, 10:45:58 AM:** A new line `await sftp.mkdir(remotePath, true);` was added before the `sftp.put` operation to explicitly create the remote directory on the SFTP server if it doesn't exist. This line incorrectly used the full file path for `mkdir`.
    *   **11/26/2025, 10:46:47 AM:** The `filePath` for writing the local JSON file was aligned with the directory creation logic, using `config.paths.anchorJsonFilePath || tempDir`.
    *   **11/26/2025, 10:49:15 AM:** The SFTP directory creation logic was corrected. `await sftp.mkdir('/anchor', true);` was changed to create only the parent directory `/anchor`, and `sftp.put` then correctly specifies the full file path `/anchor/${fileName}`.
    *   **11/26/2025, 10:50:57 AM:** The `moveFiles` utility call was updated to also use `config.paths.anchorJsonArcFilePath || tempDir` for the archive destination, similar to the local file path creation.
    *   **11/26/2025, 11:04:36 AM:** The fallback to `tempDir` for local file and archive paths was removed, indicating a preference to always use the explicitly configured paths (`config.paths.anchorJsonFilePath` and `config.paths.anchorJsonArcFilePath`).
    *   **11/26/2025, 11:08:56 AM and 11:09:16 AM:** The `connect` method was updated to use the newly renamed `config.anchorSftpConfigJSON` instead of `config.sftpConfig7501`, aligning with the configuration file change.

**Patterns and Recurring Elements:**

*   **Rapid Development & Debugging:** A concentrated series of changes occurred between 10:15 AM and 11:09 AM on 11/26/2025, indicating active development and iterative debugging of the Anchor JSON SFTP upload functionality.
*   **SFTP Integration Focus:** A significant portion of the changes revolves around establishing and refining SFTP connections and file transfer logic, including host configurations, directory creation, and file placement.
*   **Path Management:** Frequent modifications to local and archive file paths for the Anchor JSON files (e.g., commenting/uncommenting, adding subdirectories, and temporarily introducing/removing fallback `tempDir` logic).
*   **Configuration-driven:** The system heavily relies on `config.js` to define environment-specific settings for databases, SFTP, and file paths.
*   **Error Reporting:** A consistent pattern of sending email notifications to a predefined exception list upon encountering errors in the JSON upload process.
*   **Database Querying:** The core data extraction logic from the database remains consistent, targeting specific tables and conditions to retrieve shipment data for 'ANCHOR INGREDIENTS CO.'.
*   **Timestamp-based Batching:** The process uses a `last_run_timestamp` to determine the data fetching window, ensuring only new or updated records are processed.

## 2:32:03 PM
The provided log details changes to a single file: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`.

The initial and most significant code update occurred at `11/26/2025, 12:21:43 PM`. Subsequent entries at `11/26/2025, 12:22:12 PM`, `11/26/2025, 12:28:33 PM`, `11/26/2025, 12:30:06 PM`, and `11/26/2025, 12:30:44 PM` show identical code snippets to the first, indicating no functional changes within the visible portions of the code during those later timestamps.

**File-Specific Updates (`hblEntry.controller.ts`):**

The file defines two asynchronous Express controller functions: `createHblMasterBooking` and `saveHblBooking`, both responsible for managing House Bill of Lading (HBL) entries.

1.  **`createHblMasterBooking` Function:**
    *   Handles the initial creation of an HBL master booking.
    *   It extracts numerous fields from `req.body`, performing `sanitizeString` on most string inputs and `AppDateFormate` for date fields (e.g., `eta`, `hbldate`, `booking_date`).
    *   It initiates a database transaction (`BEGIN`).
    *   It inserts data into several tables: `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`.
    *   It conditionally inserts multiple records into `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables if corresponding lists (`routingList`, `containerList`, `basicPoList`) are provided in the request body.
    *   Each insert operation is followed by a check for `rowCount`, throwing an `HttpError` if the insert fails.
    *   The transaction is committed upon success or rolled back in case of an error.

2.  **`saveHblBooking` Function:**
    *   Designed to handle both adding and updating HBL records. The `EntryMode` is determined by the presence of `agent_booking_id` in the payload.
    *   Similar to `createHblMasterBooking`, it parses, sanitizes, and formats a wide array of `req.body` fields into a payload.
    *   It also determines `locationByRole` based on the user's role (`AGENT` uses `location`, others use `companyname`).
    *   It initiates a database transaction (`BEGIN`).
    *   If `entryMode` is `EntryMode.UPDATE`, it performs multiple `SELECT` queries to fetch existing data for the given `agent_booking_id` from tables like `agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, and `agent_booking_po`. The subsequent `updateQuery` call is truncated in the provided logs, so the full update logic isn't visible.

**Patterns and Recurring Elements:**

*   **Extensive Data Sanitization:** Nearly all string fields from the request body are processed with `sanitizeString()`, indicating a strong emphasis on preventing injection attacks or ensuring clean data.
*   **Consistent Date Formatting:** Dates are consistently formatted using `AppDateFormate(..., 'YYYY-MM-DD')` before database insertion, ensuring uniformity.
*   **Transactional Database Operations:** Both functions utilize explicit SQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure data consistency across multiple related database insertions/updates.
*   **Structured Payload Mapping:** Request body data is meticulously mapped to a `hblEntryPayloadTypes` object, followed by a `bookingInsertQuery` object for database interactions.
*   **Conditional Batch Inserts:** Lists for routing, containers, and purchase orders (`routingList`, `containerList`, `basicPoList`) are processed and inserted in bulk only if they are non-empty.
*   **Role-Based Logic:** The `locationByRole` variable demonstrates conditional logic based on the authenticated user's role.
*   **Robust Error Handling:** Both functions include `try...catch` blocks that roll back transactions on error and log the error, providing a mechanism for graceful failure.
*   **Verbose Logging:** `console.log` and `logger.info` statements are present, indicating a focus on debugging and operational visibility.