# Activity Summary for 11/26/2025

## 11:10:56 AM
The changes primarily involve enhancements and debugging related to an Anchor JSON data export and SFTP upload process, alongside configuration updates.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\config\config.js`**
    *   **11/26/2025, 10:15:44 AM:** Initial setup for Anchor JSON integration. This included defining a new `sftpConfigJSON` (SFTP configuration for Anchor Ingredients) with host, port, and username. It also added an `anchor24HrJsonReport` email list for development and commented out local file paths for Anchor JSON files.
    *   **11/26/2025, 10:18:03 AM:** The `anchor24HrJsonReport` email distribution list in the development environment was expanded to include an additional recipient.
    *   **11/26/2025, 10:36:34 AM:** Local development paths `anchorJsonFilePath` and `anchorJsonArcFilePath` were uncommented and defined, pointing to a specific user directory.
    *   **11/26/2025, 11:02:32 AM:** The `anchorJsonArcFilePath` in the development environment was updated to specify an `archive` subdirectory for processed files.
    *   **11/26/2025, 11:08:48 AM:** The SFTP configuration key `sftpConfigJSON` was renamed to `anchorSftpConfigJSON` across both development and production environments, indicating a more specific naming convention for Anchor-related SFTP settings.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\anchorJsonUploadToSftp.js`**
    *   **11/26/2025, 10:15:53 AM:** This file was introduced or significantly updated to include the `AnchorJsonData` class. This class is responsible for:
        *   Retrieving a `last_run_timestamp` from `anchor_json_run.json` to enable incremental data fetching.
        *   Connecting to an SFTP server.
        *   Fetching shipment data from a database (`mtr_tracking_data`, `agent_booking_entry`, `t49_tracking_details`, `po_details`) for 'ANCHOR INGREDIENTS CO.' within a specified time window.
        *   Formatting the fetched data into a JSON structure, including booking details, MBL/BL numbers, dates (ETD, ATD, ETA, ATA), customs information, PO numbers, and container milestones.
        *   Generating a JSON file (`Anchor_Ingredients_Shipment_YYYY-MM-DD_HH-mm-ss.json`) locally.
        *   Uploading this JSON file to a remote `/anchor` directory on the SFTP server.
        *   Moving the local JSON file to an archive path after successful upload.
        *   Updating the `last_run_timestamp` in `anchor_json_run.json`.
        *   Sending email notifications to `execptionMailList` upon errors.
    *   **11/26/2025, 10:32:20 AM:** A minor correction was made to the email subject line for error reports, changing `fromDate` and `toDate` to `this.fromDate` and `this.toDate`, though `this.fromDate` and `this.toDate` were not defined as class properties, suggesting a potential logical error.
    *   **11/26/2025, 10:35:49 AM:** The SFTP connection method was updated to use `config.sftpConfig7501` instead of `config.sftpConfigJSON`. This is a significant change, redirecting the SFTP connection to a different configuration.
    *   **11/26/2025, 10:37:58 AM:** The remote path for SFTP upload was modified from `/anchor/${fileName}` to `./anchor/${fileName}`, potentially altering the target directory structure on the SFTP server.
    *   **11/26/2025, 10:45:05 AM:** Logic was introduced to ensure the local directory for generating JSON files exists, with a fallback to a `tempDir` if `anchorJsonFilePath` is not specified.
    *   **11/26/2025, 10:45:58 AM:** A new line `await sftp.mkdir(remotePath, true);` was added before the `sftp.put` operation to explicitly create the remote directory on the SFTP server if it doesn't exist. This line incorrectly used the full file path for `mkdir`.
    *   **11/26/2025, 10:46:47 AM:** The `filePath` for writing the local JSON file was aligned with the directory creation logic, using `config.paths.anchorJsonFilePath || tempDir`.
    *   **11/26/2025, 10:49:15 AM:** The SFTP directory creation logic was corrected. `await sftp.mkdir('/anchor', true);` was changed to create only the parent directory `/anchor`, and `sftp.put` then correctly specifies the full file path `/anchor/${fileName}`.
    *   **11/26/2025, 10:50:57 AM:** The `moveFiles` utility call was updated to also use `config.paths.anchorJsonArcFilePath || tempDir` for the archive destination, similar to the local file path creation.
    *   **11/26/2025, 11:04:36 AM:** The fallback to `tempDir` for local file and archive paths was removed, indicating a preference to always use the explicitly configured paths (`config.paths.anchorJsonFilePath` and `config.paths.anchorJsonArcFilePath`).
    *   **11/26/2025, 11:08:56 AM and 11:09:16 AM:** The `connect` method was updated to use the newly renamed `config.anchorSftpConfigJSON` instead of `config.sftpConfig7501`, aligning with the configuration file change.

**Patterns and Recurring Elements:**

*   **Rapid Development & Debugging:** A concentrated series of changes occurred between 10:15 AM and 11:09 AM on 11/26/2025, indicating active development and iterative debugging of the Anchor JSON SFTP upload functionality.
*   **SFTP Integration Focus:** A significant portion of the changes revolves around establishing and refining SFTP connections and file transfer logic, including host configurations, directory creation, and file placement.
*   **Path Management:** Frequent modifications to local and archive file paths for the Anchor JSON files (e.g., commenting/uncommenting, adding subdirectories, and temporarily introducing/removing fallback `tempDir` logic).
*   **Configuration-driven:** The system heavily relies on `config.js` to define environment-specific settings for databases, SFTP, and file paths.
*   **Error Reporting:** A consistent pattern of sending email notifications to a predefined exception list upon encountering errors in the JSON upload process.
*   **Database Querying:** The core data extraction logic from the database remains consistent, targeting specific tables and conditions to retrieve shipment data for 'ANCHOR INGREDIENTS CO.'.
*   **Timestamp-based Batching:** The process uses a `last_run_timestamp` to determine the data fetching window, ensuring only new or updated records are processed.

## 2:32:03 PM
The provided log details changes to a single file: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`.

The initial and most significant code update occurred at `11/26/2025, 12:21:43 PM`. Subsequent entries at `11/26/2025, 12:22:12 PM`, `11/26/2025, 12:28:33 PM`, `11/26/2025, 12:30:06 PM`, and `11/26/2025, 12:30:44 PM` show identical code snippets to the first, indicating no functional changes within the visible portions of the code during those later timestamps.

**File-Specific Updates (`hblEntry.controller.ts`):**

The file defines two asynchronous Express controller functions: `createHblMasterBooking` and `saveHblBooking`, both responsible for managing House Bill of Lading (HBL) entries.

1.  **`createHblMasterBooking` Function:**
    *   Handles the initial creation of an HBL master booking.
    *   It extracts numerous fields from `req.body`, performing `sanitizeString` on most string inputs and `AppDateFormate` for date fields (e.g., `eta`, `hbldate`, `booking_date`).
    *   It initiates a database transaction (`BEGIN`).
    *   It inserts data into several tables: `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`.
    *   It conditionally inserts multiple records into `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables if corresponding lists (`routingList`, `containerList`, `basicPoList`) are provided in the request body.
    *   Each insert operation is followed by a check for `rowCount`, throwing an `HttpError` if the insert fails.
    *   The transaction is committed upon success or rolled back in case of an error.

2.  **`saveHblBooking` Function:**
    *   Designed to handle both adding and updating HBL records. The `EntryMode` is determined by the presence of `agent_booking_id` in the payload.
    *   Similar to `createHblMasterBooking`, it parses, sanitizes, and formats a wide array of `req.body` fields into a payload.
    *   It also determines `locationByRole` based on the user's role (`AGENT` uses `location`, others use `companyname`).
    *   It initiates a database transaction (`BEGIN`).
    *   If `entryMode` is `EntryMode.UPDATE`, it performs multiple `SELECT` queries to fetch existing data for the given `agent_booking_id` from tables like `agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, and `agent_booking_po`. The subsequent `updateQuery` call is truncated in the provided logs, so the full update logic isn't visible.

**Patterns and Recurring Elements:**

*   **Extensive Data Sanitization:** Nearly all string fields from the request body are processed with `sanitizeString()`, indicating a strong emphasis on preventing injection attacks or ensuring clean data.
*   **Consistent Date Formatting:** Dates are consistently formatted using `AppDateFormate(..., 'YYYY-MM-DD')` before database insertion, ensuring uniformity.
*   **Transactional Database Operations:** Both functions utilize explicit SQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure data consistency across multiple related database insertions/updates.
*   **Structured Payload Mapping:** Request body data is meticulously mapped to a `hblEntryPayloadTypes` object, followed by a `bookingInsertQuery` object for database interactions.
*   **Conditional Batch Inserts:** Lists for routing, containers, and purchase orders (`routingList`, `containerList`, `basicPoList`) are processed and inserted in bulk only if they are non-empty.
*   **Role-Based Logic:** The `locationByRole` variable demonstrates conditional logic based on the authenticated user's role.
*   **Robust Error Handling:** Both functions include `try...catch` blocks that roll back transactions on error and log the error, providing a mechanism for graceful failure.
*   **Verbose Logging:** `console.log` and `logger.info` statements are present, indicating a focus on debugging and operational visibility.

## 3:32:06 PM
The provided log details several code changes across a React frontend application, primarily focusing on booking and House Bill of Lading (HBL) functionality, with updates to API interactions, UI components, data table columns, and user actions.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js` (Timestamp: 11/26/2025, 2:53:21 PM)**
    *   This file, responsible for defining API endpoints using Redux Toolkit Query, underwent significant expansion.
    *   **New `tagTypes`:** `FormDetails` was added to the existing `add`, `Details`, `ISF`, `UPDATE`, `CUSTOMER_APPROVE`, `HBL` types.
    *   **New Endpoints:**
        *   `fetchBookingFormDetails`: A query to fetch booking form details, providing `FormDetails` and `UPDATE` tags.
        *   `isfDescXmlCreate`: A mutation to create ISF description XML, invalidating `ISF`.
        *   `isfDescXmlUpload`: A mutation to upload ISF description XML, invalidating `ISF`.
        *   `createBookingXml`: A mutation to generate booking XML, invalidating `add`.
        *   `uploadBookingXml`: A mutation to upload booking XML, invalidating `add`.
        *   `saveHblBooking`: A mutation to save HBL booking data, invalidating `HBL`.
        *   `fetchHblBookingFormDetails`: A query to fetch HBL booking form details, providing `HBL`.
        *   `updateCarrierBooking`: A mutation to update carrier booking information, invalidating `add` and `Details`.
        *   `updateDo`: A mutation to update Delivery Order (DO) information, specifically handling `Content-Type` header removal, invalidating `add` and `Details`.
        *   `exportSprReport`: A query to export an SPR booking report.
        *   `getHblDashboard`: A query to fetch HBL dashboard data, providing `HBL`.
    *   **Exported Hooks:** Corresponding hooks for all new queries and mutations were added, including `useFetchBookingFormDetailsQuery`, `useIsfDescXmlCreateMutation`, `useIsfDescXmlUploadMutation`, `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`, `useSaveHblBookingMutation`, `useFetchHblBookingFormDetailsQuery`, `useUpdateCarrierBookingMutation`, `useUpdateDoMutation`, `useLazyExportSprReportQuery`, and `useGetHblDashboardQuery`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx` (Timestamp: 11/26/2025, 2:57:40 PM)**
    *   This component displays a list of HBL details.
    *   It imports `useGetHblDashboardQuery` from `agentBookingApi` to fetch data and `HBL_COLUMNS` for grid definition.
    *   It uses a `ThemedGrid` to render data, setting up `GridActions` with `getHblActions`.
    *   Initially, it renders a `isfDummyData` array, suggesting development or placeholder content.
    *   The "Add HBL" button navigates to `/app/booking/hbl_form` with state containing `booking_serial_id`, `booking_id`, and `formAction: "add"`.
    *   The `uniqueId` for the `ThemedGrid` is set to `"agent_booking_id"`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx` (Timestamp: 11/26/2025, 2:58:49 PM)**
    *   This is a follow-up change to the same `HBLListDetails.jsx` file, occurring shortly after the previous one.
    *   **Key change:** The `ThemedGrid` component's `data` prop was updated from `isfDummyData` to `hblData?.data`, indicating a transition from dummy data to live data fetched via `useGetHblDashboardQuery`.
    *   **Key change:** The `uniqueId` prop for `ThemedGrid` was changed from `"agent_booking_id"` to `"serial_id"`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js` (Timestamp: 11/26/2025, 3:01:38 PM)**
    *   This file defines column configurations for various data grids related to bookings.
    *   The provided snippet shows definitions for `BOOKING_VESSEL_COLUMN`, `BOOKING_VESSEL_COLUMN_CUSTOMER`, `BOOKING_CARGO_COLUMN`, `BOOKING_DASHBOARD_COLUMNS_GRID`, and `BOOKING_DASHBOARD_COLUMNS_CARDS`.
    *   Columns often include `renderCell` functions for formatting dates using `appDateFormat` or numerical values with `toFixed(2)`.
    *   `BOOKING_DASHBOARD_COLUMNS_GRID` includes a `Chip` component in `renderCell` for `booking_status` to display status with different colors (success, error, primary).
    *   The `BOOKING_CARGO_COLUMN` conditionally includes an "Action" column with an `AddCircleOutlined` button if `setModal` is provided.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js` (Timestamp: 11/26/2025, 3:10:12 PM)**
    *   This entry shows the exact same content as the previous timestamp for `agent.booking.js`. There are no visible changes between these two timestamps. This might indicate a save operation without code modifications or a revert.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js` (Timestamp: 11/26/2025, 3:13:47 PM)**
    *   This file defines functions (`getBookingActions`, `getHblActions`) that return an array of actions (e.g., "Edit", "Copy", "View") based on user roles (`access`).
    *   **Refactored `getBookingActions`:** The previous commented-out, monolithic structure was replaced with a modular approach, defining reusable base actions (`bookingActions`, `isfActions`, `hblAction`, `createHblAction`, `viewHblAction`, `viewAction`, `updateLineBookingAction`, `updateDOAction`).
    *   Actions are now combined based on `access.agentBookingMenu`, `access.customerBookingMenu`, and `access.adminBookingMenu` to provide tailored options.
    *   **New Actions Introduced:**
        *   "HBL" (for creating a new HBL via `/app/booking/hbl_form_screen`).
        *   "View Hbl Details" (to set a modal with type 'view-hbl').
        *   "Update Line Booking" (to set a modal with type 'line-entry').
        *   "Update DO" (to set a modal with type 'update-do').
    *   **New `getHblActions` function:** A dedicated function `getHblActions` was introduced, specifically returning an "Edit HBL" action that navigates to `/app/booking/hbl_form`.

**Patterns and Recurring Elements:**

*   **Redux Toolkit Query (RTK Query):** A consistent pattern of defining API interactions (`createApi`, `fetchBaseQuery`, `endpoints`, `tagTypes`, `query`, `mutation`, `providesTags`, `invalidatesTags`) is observed in `agentBookingApi.js`.
*   **`getAppHeaders()`:** All API requests consistently use `getAppHeaders()` for authorization and other standard headers.
*   **`URLSearchParams`:** GET requests frequently use `new URLSearchParams(params).toString()` for constructing query strings.
*   **Date Formatting:** Dates across grid columns are uniformly formatted using `appDateFormat`.
*   **Modular Action Definitions:** The refactoring in `actions.js` demonstrates a move towards more modular and role-based action management.
*   **Navigation with `react-router-dom`:** `useLocation` and `useNavigate` are used for programmatic navigation, often passing state objects to new routes.
*   **MUI Components:** The UI consistently leverages Material-UI components (`Box`, `Card`, `Stack`, `Chip`, `IconButton`, `Tooltip`, `ThemeButton`, `OutlinedButton`) for building layouts and visual elements.
*   **Data Grids:** The application frequently uses a `ThemedGrid` component, often configured with `GridActions` and custom `renderCell` functions for rich data display and interaction.
*   **Focus on Booking and HBL:** A significant portion of the changes revolves around extending functionalities for "Booking," "ISF," and especially "HBL" (House Bill of Lading) management, including creation, editing, viewing, and dashboard listing.
*   **Access Control:** The `useAccess` hook is frequently used to conditionally render or enable actions and UI elements based on user roles.
*   **Formik:** The `HBLListDetails.jsx` component shows the use of `Formik` for form management, even though the form's content isn't fully detailed in the provided log.

## 3:32:11 PM
**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial Major Change (11/26/2025, 12:21:43 PM)**: Introduction of `createHblMasterBooking` and `saveHblBooking` functions.
        *   `createHblMasterBooking` handles the creation of a new HBL entry, sanitizing a wide array of input fields from the request body. It performs a series of database insertions into `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables, all wrapped within a database transaction.
        *   `saveHblBooking` is designed for both adding and updating HBL entries. It also sanitizes inputs and, for updates, retrieves existing data from various tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`) before proceeding with an update operation. Note that the log snippets for `saveHblBooking` are consistently truncated, cutting off before the full update logic is shown.
    *   **Minor Update (11/26/2025, 2:32:34 PM)**: Within `createHblMasterBooking`, the `bookingInsertQuery` object was modified. Previously commented-out fields, specifically `bookingdate` and `transport_mode`, were uncommented and explicitly included in the data passed for insertion into `hbl_master`.
    *   Other timestamps for this file (11/26/2025, 12:22:12 PM, 12:28:33 PM, 12:30:06 PM, 12:30:44 PM, 2:49:21 PM, 3:07:10 PM, 3:08:50 PM, 3:11:53 PM) show no discernible functional code changes in the provided snippets, largely duplicating the content from the closest preceding significant update.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **Major Update (11/26/2025, 2:49:43 PM)**: This file was updated to include the newly defined `createHblMasterBooking` controller function via a new `POST` route at `/create`. Additionally, it began importing `getHbl` and exposed it through a `GET` route at `/get-hbl`, expanding the API's HBL-related functionalities.

**Timestamps of Significant Changes:**

*   **11/26/2025, 12:21:43 PM**: Initial implementation of HBL creation and saving logic in the controller.
*   **11/26/2025, 2:32:34 PM**: Refinement of data fields for HBL master booking insertion in the controller.
*   **11/26/2025, 2:49:43 PM**: API endpoint expansion to include HBL creation and retrieval routes.

**Patterns or Recurring Elements in the Content:**

*   **Extensive Input Sanitization**: Almost all incoming request body fields are consistently processed with `sanitizeString()` to prevent potential injection attacks or data inconsistencies.
*   **Transactional Database Operations**: Both `createHblMasterBooking` and `saveHblBooking` explicitly use `query("BEGIN")`, `query("COMMIT")`, and `query("ROLLBACK")` to ensure atomic and reliable database transactions.
*   **Date Formatting Utility**: Dates from the request body (e.g., `eta`, `hbldate`, `booking_date`) are uniformly converted to a 'YYYY-MM-DD' format using a custom `AppDateFormate` utility before being stored in the database.
*   **Modular Database Interactions**: The code leverages utility functions like `insertMany`, `insertQuery`, `query`, and `updateQuery` from `../config/database`, indicating a centralized and reusable approach to database operations.
*   **Structured Data Storage**: HBL-related data is split across multiple tables (e.g., `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), with complex objects like `routingList`, `containerList`, and `basicPoList` being handled by `insertMany` for bulk insertion.
*   **Role-Based Data Assignment**: The `locationByRole` variable dynamically assigns a location based on the authenticated user's role (either `req.user?.location` for 'AGENT' or `req.user?.companyname` otherwise), which is then used in database insertions.

## 4:32:05 PM
The changes log details updates across two files: `hblEntry.controller.ts` and `hblEntry.route.ts`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**

*   **Initial State (11/26/2025, 12:21:43 PM):**
    *   The file contains two asynchronous controller functions: `createHblMasterBooking` for creating new HBL entries and `saveHblBooking` for handling updates or additions based on `agent_booking_id`.
    *   Both functions parse a large `hblEntryPayloadTypes` object from the request body, extensively using `sanitizeString` for most fields and `AppDateFormate` for date fields like `eta` and `hbldate`.
    *   Database operations are wrapped in transactions (`BEGIN`, `COMMIT`, `ROLLBACK`).
    *   `createHblMasterBooking` inserts data into `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, and conditionally into `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` tables. Notably, the `bookingInsertQuery` object used for `hbl_master` explicitly had the `bookingdate` field commented out.
    *   `saveHblBooking` starts by defining `payload` similarly and includes logic for `EntryMode.UPDATE`. It fetches current booking, vessel, routing, container, HBL, and PO details before an intended update operation, though the `updateQuery` itself is truncated in the provided log snippet. The `bookingInsertQuery` in `saveHblBooking` also had `bookingdate` commented out.
*   **Significant Update (11/26/2025, 2:32:34 PM):**
    *   In both `createHblMasterBooking` and `saveHblBooking` functions, the `bookingdate` field within the `bookingInsertQuery` object was uncommented, making it an active field for database operations (`bookingdate: payload.booking_date`).
    *   A new field, `transport_mode: req.body.transportaion_mode`, was added to the `bookingInsertQuery` object for both functions, indicating that the transportation mode is now explicitly stored with the main booking record.
*   **Subsequent Entries (11/26/2025, 2:49:21 PM to 3:11:53 PM):** No further changes were made to the code content in this file after the 2:32:34 PM update.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**

*   **Sole Entry (11/26/2025, 2:49:43 PM):** This file defines the API routes related to HBL entries:
    *   `POST /`: Maps to the `saveHblBooking` controller function.
    *   `GET /`: Maps to `fetchHblFormDetails` (function not detailed in `hblEntry.controller.ts` log).
    *   `GET /get-hbl`: Maps to `getHbl` (function not detailed in `hblEntry.controller.ts` log).
    *   `POST /create`: Maps to the `createHblMasterBooking` controller function.

**Patterns and Recurring Elements:**

*   **Database Transaction Management:** Both `createHblMasterBooking` and `saveHblBooking` consistently use `await query("BEGIN")`, `await query("COMMIT")`, and `await query("ROLLBACK")` to ensure atomicity of multiple database operations.
*   **Data Sanitization and Formatting:** The `sanitizeString` utility is heavily used across almost all incoming request body fields (`req.body.fieldName`) to prevent potential injection attacks or ensure data consistency. `AppDateFormate` is consistently applied for date fields.
*   **Error Handling:** `HttpError` is used for specific business logic errors (e.g., "Unable to save HBL"), and a generic `logger.error(error)` is present in catch blocks to log unexpected issues.
*   **Modular Structure:** The code imports from `../requests`, `../types`, `../config`, `../utils`, and `../modules`, indicating a well-structured application with separation of concerns.
*   **Payload Construction:** A large `hblEntryPayloadTypes` object is consistently built by mapping and sanitizing numerous fields from `req.body` before database interaction.
*   **Repetitive Logs:** There are several consecutive logs for `hblEntry.controller.ts` where the code content remains identical, suggesting minor edits or saves without functional changes between 12:21 PM and 2:32 PM, and then again after 2:32 PM. The most impactful functional change happened at 2:32:34 PM.

## 5:32:39 PM
The changes log details a series of updates to a frontend application related to booking management, with a clear focus on integrating House Bill of Lading (HBL) functionality.

**File-specific Updates and Timestamps:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js` (Timestamp: 11/26/2025, 2:53:21 PM)**
    *   This file, which defines Redux Toolkit Query API endpoints, was significantly expanded.
    *   New `tagTypes` for `FormDetails` and `HBL` were added.
    *   Several new endpoints were introduced: `fetchBookingFormDetails` (query), `saveHblBooking` (mutation), `fetchHblBookingFormDetails` (query), `getHblDashboard` (query), `updateCarrierBooking` (mutation), `updateDo` (mutation), and `exportSprReport` (query).
    *   Corresponding hooks for these new endpoints were exported, indicating the activation of these new functionalities within the application. The `updateDo` mutation specifically removes the `Content-Type` header, which is an unusual but deliberate change.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx` (Timestamp: 11/26/2025, 2:57:40 PM and 11/26/2025, 2:58:49 PM)**
    *   This component, responsible for displaying HBL list details, received two updates within a minute.
    *   Initially (2:57:40 PM), it was set up to import and use the `useGetHblDashboardQuery` hook, but still rendered grid data using `isfDummyData`. The `Add HBL` button navigates to `/app/booking/hbl_form`.
    *   Shortly after (2:58:49 PM), the `ThemedGrid` component was updated to fetch and display actual HBL data from `hblData?.data` instead of `isfDummyData`. The `uniqueId` prop for the grid was also changed from `"agent_booking_id"` to `"serial_id"`. This second change indicates a quick follow-up to transition from placeholder data to live API integration.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js` (Timestamp: 11/26/2025, 3:01:38 PM and 11/26/2025, 3:10:12 PM)**
    *   This file defines various column configurations for booking-related grids. Both log entries for this file show identical content, suggesting either no actual change occurred between these two timestamps, or the log captured the same state twice. The content itself details columns for vessel, cargo, and dashboard views, including date formatting and status chips.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js` (Timestamp: 11/26/2025, 3:13:47 PM)**
    *   This file, which manages grid actions based on user roles, underwent significant refactoring.
    *   The `getBookingActions` function was rewritten, modularizing actions into distinct arrays like `bookingActions`, `isfActions`, `hblAction`, `createHblAction`, `viewHblAction`, `viewAction`, `updateLineBookingAction`, and `updateDOAction`.
    *   New actions for HBL were added, including `createHblAction` (navigating to `/app/booking/hbl_form_screen`) and `viewHblAction` (opening a modal with HBL details).
    *   Actions to `Update Line Booking` and `Update DO` (Delivery Order) were also introduced, both using modals for input.
    *   A new `getHblActions` function was specifically added for HBL-related actions, currently containing an "Edit HBL" option.

**Patterns and Recurring Elements:**

*   **HBL Feature Integration:** The most prominent pattern is the comprehensive integration of House Bill of Lading (HBL) features, spanning API endpoints, UI components, and user-facing actions.
*   **Redux Toolkit Query Usage:** The `agentBookingApi.js` file consistently utilizes Redux Toolkit Query for managing API interactions, employing `tagTypes`, `invalidatesTags`, and `providesTags` for efficient data caching and synchronization. All API calls uniformly use `getAppHeaders()` for authorization.
*   **Modular Design for Actions:** The refactoring in `actions.js` highlights a move towards a more modular and role-based approach for defining and applying grid actions, improving maintainability and scalability.
*   **Standardized Date Formatting:** Date fields across different column definitions (`agent.booking.js`) consistently use `appDateFormat` for uniform display.
*   **Modal-Driven Interactions:** Several new actions, particularly for viewing details or performing updates (e.g., HBL viewing, updating DO), leverage a generic `setModal` function, indicating a reusable modal component for various interactions.
*   **Query String Construction:** API queries in `agentBookingApi.js` consistently use `new URLSearchParams(params).toString()` to build URL query strings.
*   **Future Timestamps:** All log entries share the future date of "11/26/2025," suggesting these logs might be from a development environment with mock timestamps or a system with an incorrect date configuration.

## 5:32:53 PM
The provided log details significant development activity within the `t360-backend` service, primarily focusing on the `hblEntry.controller.ts` file, with a single update to `hblEntry.route.ts`. All changes occurred on **11/26/2025**.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **11/26/2025, 12:21:43 PM - 12:30:44 PM**: Initial or early versions of the `createHblMasterBooking` and `saveHblBooking` functions are present. The code for these timestamps is largely identical in the provided snippets, indicating minor or no functional changes during this period. Both functions involve extensive sanitization of `req.body` to construct a `hblEntryPayloadTypes` object and then perform multiple database insertions (for `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po`) within a database transaction. The `saveHblBooking` function also includes logic to fetch current booking data (for `agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`) if an `agent_booking_id` is present, suggesting it's intended for updates.
    *   **11/26/2025, 2:32:34 PM**:
        *   In `createHblMasterBooking`, the `bookingInsertQuery` object was updated to uncomment the `bookingdate` field and add a new `transport_mode` field derived from `req.body.transportaion_mode`.
    *   **11/26/2025, 2:49:21 PM - 3:11:53 PM**:
        *   A significant refactoring attempt was made in `createHblMasterBooking` to handle both creation and updates. A `serial_id` was introduced from `req.query`.
        *   The function adopted a conditional structure: `if (req.query.serial_id)` for updates (using `updateQuery` for `hbl_master`) and an `else` block for new creations (using `insertQuery`).
        *   Crucially, the database insertion logic for related tables (`agent_booking_vessel`, `agent_booking_hbl`, and various lists) was duplicated into both the `if` and `else` blocks, implying that these related records would *always* be inserted, even during an update operation, rather than being modified or selectively replaced. This pattern suggests a potential design flaw for update operations on child tables.
    *   **11/26/2025, 4:41:31 PM - 4:42:11 PM**: No new functional changes are visible in the provided snippets during this period, despite multiple timestamps.
    *   **11/26/2025, 4:55:19 PM**:
        *   Inside the `if (serial_id)` block of `createHblMasterBooking`, the database operation for `agent_booking_vessel` was changed from `insertQuery` to `updateQuery`, using `hbl_master_id:serial_id` as a condition. This indicates a move towards proper updating of related records. However, other related tables (`agent_booking_hbl`, `routingList`, `containerList`, `basicPoList`) still used `insertMany`/`insertQuery`.
    *   **11/26/2025, 4:55:51 PM**:
        *   The change in `createHblMasterBooking` for `agent_booking_vessel` was reverted, changing its operation back to `insertQuery` even within the `if(serial_id)` (update) block.
    *   **11/26/2025, 4:56:29 PM**:
        *   The entire `if(req.query.serial_id){ ... } else { ... }` conditional logic in `createHblMasterBooking` was removed.
        *   The function was simplified to *always* perform `insertQuery` for `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`, and `insertMany` for all lists, effectively reverting `createHblMasterBooking` to solely handle *new HBL creations*. The `saveHblBooking` function, not fully detailed in the logs for these timestamps, is presumably intended to handle updates.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **11/26/2025, 2:49:43 PM**: This file defines the API routes for HBL entry.
        *   `POST /` is mapped to `saveHblBooking`.
        *   `GET /` is mapped to `fetchHblFormDetails`.
        *   `GET /get-hbl` is mapped to `getHbl`.
        *   `POST /create` is mapped to `createHblMasterBooking`.
        *   This explicit mapping indicates that `saveHblBooking` is intended for a general save/update operation (on the root path), while `createHblMasterBooking` (on `/create`) is for explicit new creations. This route structure clarifies the roles of the two controller functions.

### Patterns and Recurring Elements:

*   **Consistent Data Sanitization**: Almost all incoming request body fields are processed through `sanitizeString()` to prevent potential injection vulnerabilities, and dates are formatted using `AppDateFormate()`.
*   **Transactional Database Operations**: All `createHblMasterBooking` and `saveHblBooking` operations are wrapped in SQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure atomicity.
*   **Modular Database Interactions**: The application uses helper functions like `insertMany`, `insertQuery`, `query`, and `updateQuery` from `../config/database` for interacting with the database.
*   **Error Handling**: `HttpError` is used for application-specific errors, and `logger.error` is used for logging errors within `catch` blocks.
*   **Role-Based Data Logic**: The `locationByRole` variable is dynamically set based on the authenticated user's role (AGENT uses `req.user?.location`, others use `req.user?.companyname`).
*   **Code Duplication**: Significant code duplication exists between `createHblMasterBooking` and `saveHblBooking` in constructing the `payload` and `bookingInsertQuery` objects, and in the logic for inserting/updating related tables.

## 9:08:00 PM
The changes primarily focus on implementing and enhancing the House Bill of Lading (HBL) functionality within the T360 application, affecting both API integration and frontend components. All recorded modifications occurred on **11/26/2025**.

### File-Specific Updates:

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
- **Timestamp: 11/26/2025, 2:53:21 PM**
  - Expanded the `agentBookingApi` by adding new RTK Query endpoints.
  - Introduced `FormDetails` as a new `tagType`.
  - Added `fetchBookingFormDetails` to retrieve booking form data.
  - Implemented several HBL-related endpoints:
    - `saveHblBooking` (POST to `/hblEntry/create`).
    - `fetchHblBookingFormDetails` (GET to `/hblEntry`).
    - `getHblDashboard` (GET to `/hblEntry/get-hbl`).
  - Added `updateCarrierBooking` and `updateDo` mutations for carrier and delivery order updates.
  - Included `exportSprReport` for fetching reports.
  - Corresponding `use...Query` and `use...Mutation` hooks were exported for all new endpoints.
- **Timestamp: 11/26/2025, 5:48:11 PM**
  - Modified the `saveHblBooking` mutation's URL from `/hblEntry/create` to a simpler `/hblEntry`.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
- **Timestamp: 11/26/2025, 2:57:40 PM**
  - Initial integration of HBL dashboard functionality.
  - Imported `useGetHblDashboardQuery` to fetch HBL data.
  - Configured `COLUMNS_GRID` using `HBL_COLUMNS` and `GridActions` with `getHblActions`.
  - Added an "Add HBL" button that navigates to the HBL form.
  - The `ThemedGrid` component was set to display `isfDummyData`.
- **Timestamp: 11/26/2025, 2:58:49 PM**
  - Updated the `ThemedGrid` to display actual fetched data (`hblData?.data`) instead of `isfDummyData`.
  - Changed the `uniqueId` prop for `ThemedGrid` from `"agent_booking_id"` to `"serial_id"`.
- **Timestamp: 11/26/2025, 6:03:04 PM**
  - Enhanced `useGetHblDashboardQuery` by passing `agent_booking_id` from `location.state` to filter HBL records, making the dashboard context-aware.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
- **Timestamp: 11/26/2025, 3:01:38 PM & 11/26/2025, 3:10:12 PM**
  - These entries appear identical, indicating no functional change in the column definitions between these two timestamps.
  - The file defines various column configurations (`BOOKING_VESSEL_COLUMN`, `BOOKING_CARGO_COLUMN`, `BOOKING_DASHBOARD_COLUMNS_GRID`, `BOOKING_DASHBOARD_COLUMNS_CARDS`) for different booking-related data grids, including date formatting and rendering conditional UI elements like `Chip` for status.
  - No specific `HBL_COLUMNS` definition is provided in these logs, though it's imported in `HBLListDetails.jsx`.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
- **Timestamp: 11/26/2025, 3:13:47 PM**
  - Significant expansion of booking actions based on user roles (`agentBookingMenu`, `customerBookingMenu`, `adminBookingMenu`).
  - Introduced specific actions for HBL: "Edit HBL", "HBL" (to create a new HBL form), and "View Hbl Details".
  - Added "Update Line Booking" and "Update DO" actions.
  - Created a new `getHblActions` function specifically for HBL, initially containing an "Edit HBL" action that navigates using `agent_booking_id`.
- **Timestamp: 11/26/2025, 5:33:49 PM**
  - Modified the "Edit HBL" action within `getHblActions` to pass `serial_id` (instead of `agent_booking_id`) to the navigation state.
- **Timestamp: 11/26/2025, 5:35:42 PM**
  - Further refined the "Edit HBL" action in `getHblActions` to pass both `agent_booking_id` and `serial_id` to the navigation state for the HBL form.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
- **Timestamp: 11/26/2025, 5:55:57 PM**
  - Initial implementation of the `HBLForm` component for creating and editing HBLs.
  - Utilizes `Formik` for form state management and `useSaveHblBookingMutation` for data submission.
  - Features a detailed `handleSave` function that constructs a comprehensive payload by extracting and transforming form values, including `routingList`, `containerList`, and `basicPoList` from Redux state.
  - Implements error and success feedback using `toast` and a custom `ValidationErrorsPopup`.
  - Includes keyboard shortcuts for common form actions (Edit/View/Add Party, Save).
  - Structures the form with `HblHeaderForms`, a "HBL Parties" section with `ThemeTabs` for different party types (Shipper, Consignee, Notify), and sections for `HblContainerDetailsForm`, `HblRoutingForm`, and `BasicPoForm`.
- **Timestamp: 11/26/2025, 6:11:50 PM**
  - Updated the `handleSave` function to explicitly include `serial_id` from `location.state` in the payload, which is crucial for distinguishing between new HBL creations and updates to existing ones.

### Patterns and Recurring Elements:

-   **HBL Feature Development:** A consistent theme across all changes is the robust development of the HBL (House Bill of Lading) feature. This includes API endpoints for saving and fetching HBL data, a dedicated list component, and a comprehensive form for HBL entry.
-   **Redux Toolkit Query (RTK Query):** The `agentBookingApi.js` file demonstrates heavy reliance on RTK Query for declarative and efficient data fetching and mutation, defining `providesTags` and `invalidatesTags` for cache invalidation.
-   **Form Management with Formik:** Both `HBLListDetails.jsx` and `HBLform.jsx` utilize `Formik` for managing form state, initial values, validation schemas, and submission logic.
-   **UI Consistency with Material-UI:** The use of `@mui/material` components (Card, Stack, Typography, Buttons) and custom `ThemedGrid`, `ScreenToolbar`, `ThemedBreadcrumb`, and `ThemeTabs` is prevalent, ensuring a consistent user interface.
-   **Navigation and State Passing:** `react-router-dom`'s `useNavigate` and `useLocation` are frequently employed to manage routing and pass `state` objects between components, often containing `agent_booking_id`, `serial_id`, and `formAction` to dictate form behavior (add, edit, copy).
-   **Access Control:** The `useAccess` hook is used in `HBLListDetails.jsx` and `actions.js` to dynamically adjust UI and available actions based on user roles (`agentBookingMenu`, `customerBookingMenu`, `adminBookingMenu`), highlighting a permission-based system.
-   **Data Transformation:** The `recoverValue` utility function in `HBLform.jsx` demonstrates a pattern of parsing concatenated string values (e.g., "name~code") for use in API payloads, indicating a common format for certain data types.