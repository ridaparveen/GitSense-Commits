# Activity Summary for 11/24/2025

## 9:15:44 AM
The provided code changes primarily involve frontend components related to user authentication, session management, and role-based access.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx`** (Timestamp: 11/21/2025, 10:15:47 AM)
    *   The `handleLogout` function has been significantly refactored to modify the logout flow.
    *   For users authenticated via "auth0," `localStorage` items (`token` and `user`) are now explicitly removed *before* initiating the redirect. The redirect target has also changed from `VITE_UI_V1_BASE_URL/logout` to `VITE_UI_V1_BASE_URL/login`.
    *   For other authentication types, `localStorage` items are also cleared before dispatching the `auth/logout` action and navigating to the root (`/`).
    *   The component continues to display user information (name, role) from `user` data retrieved from `localStorage` or `useFetchUserPreferenceQuery`, and provides a "Sign out" dropdown item.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`** (Timestamp: 11/21/2025, 10:20:01 AM)
    *   This layout component introduces robust session management and role-based content display.
    *   An `isTokenExpired` function was added to check the validity of the user's session based on `localUser` and `localToken` from `localStorage` and a timestamp (`exp`).
    *   Upon component mount, a `useEffect` hook checks for token expiration: if expired, it clears `user` and `token` from `localStorage` and redirects to the root (`/`); otherwise, it dispatches `initializeSelectedCustomer()`.
    *   Another `useEffect` hook manages the `selectedCustomer` state based on the user's role: "CUSTOMER" roles automatically set their company as the `selectedCustomer`, while "ADMIN_V2" roles clear any `selectedCustomer` filter. This state is synchronized with Redux and `localStorage`.
    *   The `Outlet` (main content) is only rendered if a `selectedCustomer` is present. "ADMIN_V2" users without a selected customer are shown a prompt to select one.

**Timestamps of Significant Changes:**
The two changes occurred in close succession on **11/21/2025** at **10:15:47 AM** and **10:20:01 AM**, suggesting a coordinated effort to update authentication and session handling logic across the frontend application.

**Patterns and Recurring Elements:**

*   **Reliance on `localStorage`:** Both files heavily utilize `localStorage` to store and retrieve user authentication tokens (`token`), user details (`user`), and authentication type (`authtype`). This is also central to clearing session data during logout or expiration.
*   **Redux for State Management:** `react-redux` (`useDispatch`, `useSelector`) is consistently used for managing global application state, specifically for handling logout actions (`auth/logout`) and customer selection (`setSelectedCustomer`, `initializeSelectedCustomer`).
*   **Role-based Logic:** The application implements different behaviors and UI elements based on the user's role (e.g., "CUSTOMER" vs. "ADMIN_V2"), particularly in how customer filters are applied and how content is displayed.
*   **Authentication and Session Control:** There's a strong focus on ensuring authenticated access and managing session validity, including token expiration checks and consistent logout procedures.
*   **Navigation:** `react-router-dom`'s `useNavigate` hook is used for programmatically redirecting users after logout or session expiration.

## 9:15:48 AM
The log indicates changes across two files within the `t360-frontend` project.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**
    *   **Timestamp:** The file appeared in the log at `11/21/2025, 11:31:13 AM` and again at `11/21/2025, 11:34:00 AM`. The content of the file remained identical between these two timestamps, suggesting no functional changes were committed in this specific time window, but rather the file's state was logged twice.
    *   **Content:** This file serves as the main application entry point and defines the routing structure for a React application. It heavily utilizes `react-router-dom` to set up numerous routes for various features such as user management, packing lists, service invoices, PO/DSO orders, booking, analytics, and different tracking screens (FCL, LCL, Rail, Air).
    *   **Key Functionality:**
        *   It imports a large number of page and component files, indicating a comprehensive application with many distinct screens.
        *   Routes are nested under a `Layout` component, typically for a consistent application shell.
        *   Crucially, most routes are wrapped in `ProtectedRoute` components, enforcing role-based access control using `UserRoleEnum` (e.g., `ADMIN`, `CUSTOMER`, `AGENT`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`, `CSF`).
        *   Specific routes include dashboards (`DashboardScreen`, `ShipmentTrackingScreen`, `BookingDashbaordScreenExtend`, `ISFDashboardScreen`), various form screens (e.g., `UserFormScreen`, `PLFormScreen`, `AgentBookingFormScreenExtend`), and master data management (`PortmasterScreen`, `CityMaster`, `CustomerScreen`).
        *   Authentication is managed through `AuthGuard` for login and registration pages, including a `HandleAuthCallback` for OAuth flows (likely Auth0 given previous commented `Auth0Login` route).
        *   New tracking screens like `FCLScreen`, `LCLScreen`, `RailScreen`, and `AirTrackingScreen` have been integrated, along with specific components like `AddMtrForm` and `GetTruckingDetails`.
        *   New features like `AlcScreen`, `CngInvoiceScreen`, `ReportSchedulerScreen`, `PdfParserScreen`, and `AlcExceptionDashboard` are also routed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** `11/21/2025, 11:36:28 AM`
    *   **Content:** This React component is designed to display various types of analytical metrics and charts.
    *   **Key Functionality:**
        *   It dynamically renders different chart types (Bar, Pie, Line, Stacked Bar, Gauge) based on `item.chartType` and `chartView` state.
        *   It incorporates `MetricToolbar` for controls (likely chart type switching or filtering), `MetricFooter` for additional actions, and `ThemedModal` to provide a full-screen view of the selected chart.
        *   State management uses `useState` for `chartView` and `enlarge` (for modal visibility) and `useSelector` to access `analytics` data from Redux.
        *   The component includes logic to handle cases where no data is available (`NoDataAvailable` component).
        *   It demonstrates a modular approach to data visualization, allowing various charts to be rendered within a consistent container.

**Patterns and Recurring Elements:**

*   **Extensive Routing and Role-Based Access Control:** The `App.js` file clearly shows a robust and granular routing system where almost every application route is protected by `ProtectedRoute`, indicating a strong emphasis on user role management and access control throughout the application. Multiple user roles (`ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, etc.) are explicitly defined and used for route authorization.
*   **Modular Component and Page Structure:** The application is highly modular, with numerous imports from dedicated `pages` and `components` directories, suggesting a well-organized codebase following a feature-sliced or domain-driven structure.
*   **Analytics and Data Visualization:** The presence of `MetricsBox.jsx` and various related imports (e.g., `PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`) indicates a significant focus on displaying analytical data and providing interactive charts to users.
*   **Dashboard-Centric Design:** Many routes point to different "Dashboard" screens (e.g., `DashboardScreen`, `BookingDashbaordScreen`, `ISFDashboardScreen`), highlighting a dashboard-driven user experience for various application domains.
*   **Form and Master Data Management:** There are many "form" and "master" routes (e.g., `UserFormScreen`, `PLFormScreen`, `CustomerFormScreen`, `PortmasterScreen`, `CityMaster`), indicating comprehensive CRUD (Create, Read, Update, Delete) operations for various entities within the system.

## 9:15:58 AM
The changes log details updates across three core areas of the T360_Api backend, all occurring on November 21, 2025.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
This file handles fetching company details based on user roles (AGENT or CUSTOMER).
*   **Initial Change (10:07:54 AM):** The `getAll` function was implemented to retrieve distinct company names. For `AGENT`s, it queries `agent_po_account_master` and applies a `LIMIT 10`. For `CUSTOMER`s, it features more complex logic: it determines if pagination is requested. If so, it executes a `COUNT` query for the total number of records and a paginated `SELECT DISTINCT` query from `mtr_tracking_data`. If not paginated, it also applies a `LIMIT 10`. All results are formatted as `{ value: name, label: name }`. Temporary `console.log` statements were present for debugging pagination results.
*   **Subsequent Change (10:08:08 AM):** The `console.log` statements within the `CUSTOMER` pagination logic were removed, indicating a cleanup or stabilization of the debugging output.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
This file defines API endpoints for OTM (Oracle Transportation Management) Bill of Lading operations.
*   **Single Change (11:40:37 AM):** Several routes were defined:
    *   `GET /excel_data`: Exports Excel data.
    *   `GET /`: Fetches PLPO by BOL.
    *   `GET /fetch_payload`: Fetches payload data.
    *   `GET /:bol`: Fetches by BOL number.
    *   `POST /`: Edits an OTM BOL.
    *   `POST /upload_save_edit`: Handles upload, save, and edit operations.
    *   `GET /fetch/:common_key`: Fetches by a common key.
    *   `POST /generate_xml`: Generates XML.
    *   `POST /send_to_otm`: Sends data to OTM.
    *   A `POST /upload` route for file uploads using `uploadMiddleware` was commented out.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
This file manages the creation and saving of HBL (House Bill of Lading) bookings. It includes complex transaction handling and logging.
*   **Initial Change (3:11:14 PM):**
    *   `createHblMasterBooking` was introduced to create a master HBL entry. It sanitizes various body parameters, formats the `bookingdate`, and inserts them into the `hbl_master` table within a database transaction, returning a success response. Error handling uses `next(new HttpError())`.
    *   `saveHblBooking` was implemented to handle both adding and updating HBL bookings. It involves extensive data sanitization for numerous fields related to shipper, consignee, notify parties, ports, and other booking details.
    *   **Update Flow:** If an `agent_booking_id` is provided, it fetches current data across multiple related tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`) for logging purposes. It then updates `agent_booking_entry` and `agent_booking_vessel`, and performs a delete-and-re-insert pattern for `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` based on payload lists. It also updates `agent_booking_hbl`. Crucially, it logs both the old and new states of the booking to `agent_booking_hbl_history`.
    *   **Add Flow (incomplete):** If `agent_booking_id` is not present, a new `booking_id` is generated, and an entry is made into `agent_booking_entry`. The remaining logic for inserting into related tables for new bookings is cut off.
*   **Second Change (3:13:11 PM):** In `createHblMasterBooking`, the error handling was modified to `logger.error(error);`, removing the explicit `res.status(500).json(...)` response for errors. The `saveHblBooking` portion remained mostly unchanged.
*   **Third Change (3:16:23 PM):** In `saveHblBooking`, the `bookingdate` field within the `bookingInsertQuery` for `agent_booking_entry` was updated to `payload.booking_date || null`, making it explicitly nullable.
*   **Fourth Change (3:17:07 PM):**
    *   In `createHblMasterBooking`, the `bookingdate` in the payload was changed to `AppDateFormate(req.body.bookingdate, db_format) || null`, allowing it to be nullable.
    *   In `saveHblBooking`, the `hbldate` payload field now assigns `null` (instead of the string `'null'`) if `req.body.hbldate` is falsy. The `bookingdate` in `bookingInsertQuery` for `saveHblBooking` was reverted to `payload.booking_date` (no `|| null`).
*   **Fifth Change (3:19:06 PM):** In `createHblMasterBooking`, the `bookingdate` field in the payload was completely commented out, preventing its insertion into `hbl_master`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
This file configures the API routes for HBL entry.
*   **Initial Change (3:11:42 PM):** Routes were set up for `POST /` (mapped to `saveHblBooking`), `GET /` (mapped to `fetchHblFormDetails`), and another `POST /` (mapped to `createHblMasterBooking`). This created a routing conflict for `POST /`.
*   **Subsequent Change (3:19:52 PM):** The routing conflict was resolved by changing the second `POST /` route to `POST /create` for the `createHblMasterBooking` function. The `POST /` route remains for `saveHblBooking`, and `GET /` for `fetchHblFormDetails`.

**Patterns and Recurring Elements:**
*   **Timestamp Consistency:** All changes occurred on the same day, November 21, 2025, suggesting a focused development effort within a short timeframe.
*   **Database Operations:** There's a strong emphasis on database interaction, including `SELECT`, `INSERT`, `UPDATE`, `DELETE` queries, and explicit transaction management (`BEGIN`, `COMMIT`, `ROLLBACK`) across different controllers.
*   **Data Sanitization and Formatting:** The `sanitizeString` utility is frequently used for request body fields, indicating a focus on preventing common vulnerabilities. Dates are consistently formatted using `AppDateFormate` before database insertion or update.
*   **Role-Based Logic:** The `company_details.controller.ts` demonstrates logic branching based on user roles (AGENT vs. CUSTOMER).
*   **Logging:** `logger.info` and `logger.error` are extensively used for internal logging, and `console.log` was temporarily used for debugging.
*   **Complex Business Logic:** The `hblEntry.controller.ts` showcases intricate logic for handling HBL bookings, including multiple related data entities (booking, vessel, routing, container, PO) and a history tracking mechanism.
*   **Routing Refinement:** An initial routing conflict was identified and quickly resolved, indicating an iterative development process.

## 10:15:39 AM
The `App.js` file, recorded at 11/21/2025, 11:31:13 AM and identically at 11/21/2025, 11:34:00 AM, outlines the entire routing structure of a React frontend application. It imports a multitude of components from various functional modules such as `packing-list`, `service-invoice`, `expense-code`, `destination`, `vendor`, `po_order`, `dso_order`, `otm_bol`, `code` (customer, party, agent), `planboard`, `detention`, `commercial-invoice`, `booking`, `analytics`, `agent_po`, `cng-invoice`, `alc`, `shipping_orders`, `container-report`, `report`, `parse-pdf`, `alc_dashboard`, `tracking` (fcl, lcl, rail, air, mtr, trucking details), `dashboard_7501`, `shipments`, `cng-booking`, `city-master`, and `portmaster`. The application uses `react-router-dom` for navigation, `ThemeProvider` from `@mui/material` for styling, and `react-hot-toast` for notifications. A `console.log("ðŸš€ ~ file: App.js:2 ~ TEST on Flow");` statement is present. The core functionality relies heavily on `ProtectedRoute` components, applying granular role-based access control using `UserRoleEnum` for almost every route. Common roles include `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, and `ADMIN_V2`. Key routes cover dashboards, user management, various forms (booking, ISF, HBL, PO, BOL), master data maintenance, analytics, reporting, and extensive shipment tracking capabilities.

The `MetricsBox.jsx` file, updated at 11/21/2025, 11:36:28 AM, is a React component designed for displaying and interacting with various analytical charts. It dynamically renders `BarChart`, `PieChart`, `LineChart`, `StackedBarChart`, and `GaugeChart` based on the `item.chartType` property. The component integrates a `MetricToolbar` for managing chart views and options, a `MetricFooter` for additional actions, and a `ThemedModal` to provide a full-screen view of charts. It utilizes `useState` for managing local UI state like `chartView` and the modal's `enlarge` state, and `useSelector` from `react-redux` to access application-wide analytics state. The component also handles cases where no data is available for a chart.

Across these changes, a clear pattern of modular application development is evident, with distinct components and pages for different functionalities. The timestamps show that these updates were made within a short timeframe on November 21, 2025, indicating focused development activity. A recurring theme, particularly in `App.js`, is the emphasis on robust role-based access control for nearly all features, underscoring security and user permissions as critical aspects of the application's design. The use of a consistent `UserRoleEnum` across numerous protected routes highlights this pattern.