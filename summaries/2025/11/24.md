# Activity Summary for 11/24/2025

## 9:15:44 AM
The provided code changes primarily involve frontend components related to user authentication, session management, and role-based access.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx`** (Timestamp: 11/21/2025, 10:15:47 AM)
    *   The `handleLogout` function has been significantly refactored to modify the logout flow.
    *   For users authenticated via "auth0," `localStorage` items (`token` and `user`) are now explicitly removed *before* initiating the redirect. The redirect target has also changed from `VITE_UI_V1_BASE_URL/logout` to `VITE_UI_V1_BASE_URL/login`.
    *   For other authentication types, `localStorage` items are also cleared before dispatching the `auth/logout` action and navigating to the root (`/`).
    *   The component continues to display user information (name, role) from `user` data retrieved from `localStorage` or `useFetchUserPreferenceQuery`, and provides a "Sign out" dropdown item.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`** (Timestamp: 11/21/2025, 10:20:01 AM)
    *   This layout component introduces robust session management and role-based content display.
    *   An `isTokenExpired` function was added to check the validity of the user's session based on `localUser` and `localToken` from `localStorage` and a timestamp (`exp`).
    *   Upon component mount, a `useEffect` hook checks for token expiration: if expired, it clears `user` and `token` from `localStorage` and redirects to the root (`/`); otherwise, it dispatches `initializeSelectedCustomer()`.
    *   Another `useEffect` hook manages the `selectedCustomer` state based on the user's role: "CUSTOMER" roles automatically set their company as the `selectedCustomer`, while "ADMIN_V2" roles clear any `selectedCustomer` filter. This state is synchronized with Redux and `localStorage`.
    *   The `Outlet` (main content) is only rendered if a `selectedCustomer` is present. "ADMIN_V2" users without a selected customer are shown a prompt to select one.

**Timestamps of Significant Changes:**
The two changes occurred in close succession on **11/21/2025** at **10:15:47 AM** and **10:20:01 AM**, suggesting a coordinated effort to update authentication and session handling logic across the frontend application.

**Patterns and Recurring Elements:**

*   **Reliance on `localStorage`:** Both files heavily utilize `localStorage` to store and retrieve user authentication tokens (`token`), user details (`user`), and authentication type (`authtype`). This is also central to clearing session data during logout or expiration.
*   **Redux for State Management:** `react-redux` (`useDispatch`, `useSelector`) is consistently used for managing global application state, specifically for handling logout actions (`auth/logout`) and customer selection (`setSelectedCustomer`, `initializeSelectedCustomer`).
*   **Role-based Logic:** The application implements different behaviors and UI elements based on the user's role (e.g., "CUSTOMER" vs. "ADMIN_V2"), particularly in how customer filters are applied and how content is displayed.
*   **Authentication and Session Control:** There's a strong focus on ensuring authenticated access and managing session validity, including token expiration checks and consistent logout procedures.
*   **Navigation:** `react-router-dom`'s `useNavigate` hook is used for programmatically redirecting users after logout or session expiration.

## 9:15:48 AM
The log indicates changes across two files within the `t360-frontend` project.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**
    *   **Timestamp:** The file appeared in the log at `11/21/2025, 11:31:13 AM` and again at `11/21/2025, 11:34:00 AM`. The content of the file remained identical between these two timestamps, suggesting no functional changes were committed in this specific time window, but rather the file's state was logged twice.
    *   **Content:** This file serves as the main application entry point and defines the routing structure for a React application. It heavily utilizes `react-router-dom` to set up numerous routes for various features such as user management, packing lists, service invoices, PO/DSO orders, booking, analytics, and different tracking screens (FCL, LCL, Rail, Air).
    *   **Key Functionality:**
        *   It imports a large number of page and component files, indicating a comprehensive application with many distinct screens.
        *   Routes are nested under a `Layout` component, typically for a consistent application shell.
        *   Crucially, most routes are wrapped in `ProtectedRoute` components, enforcing role-based access control using `UserRoleEnum` (e.g., `ADMIN`, `CUSTOMER`, `AGENT`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`, `CSF`).
        *   Specific routes include dashboards (`DashboardScreen`, `ShipmentTrackingScreen`, `BookingDashbaordScreenExtend`, `ISFDashboardScreen`), various form screens (e.g., `UserFormScreen`, `PLFormScreen`, `AgentBookingFormScreenExtend`), and master data management (`PortmasterScreen`, `CityMaster`, `CustomerScreen`).
        *   Authentication is managed through `AuthGuard` for login and registration pages, including a `HandleAuthCallback` for OAuth flows (likely Auth0 given previous commented `Auth0Login` route).
        *   New tracking screens like `FCLScreen`, `LCLScreen`, `RailScreen`, and `AirTrackingScreen` have been integrated, along with specific components like `AddMtrForm` and `GetTruckingDetails`.
        *   New features like `AlcScreen`, `CngInvoiceScreen`, `ReportSchedulerScreen`, `PdfParserScreen`, and `AlcExceptionDashboard` are also routed.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** `11/21/2025, 11:36:28 AM`
    *   **Content:** This React component is designed to display various types of analytical metrics and charts.
    *   **Key Functionality:**
        *   It dynamically renders different chart types (Bar, Pie, Line, Stacked Bar, Gauge) based on `item.chartType` and `chartView` state.
        *   It incorporates `MetricToolbar` for controls (likely chart type switching or filtering), `MetricFooter` for additional actions, and `ThemedModal` to provide a full-screen view of the selected chart.
        *   State management uses `useState` for `chartView` and `enlarge` (for modal visibility) and `useSelector` to access `analytics` data from Redux.
        *   The component includes logic to handle cases where no data is available (`NoDataAvailable` component).
        *   It demonstrates a modular approach to data visualization, allowing various charts to be rendered within a consistent container.

**Patterns and Recurring Elements:**

*   **Extensive Routing and Role-Based Access Control:** The `App.js` file clearly shows a robust and granular routing system where almost every application route is protected by `ProtectedRoute`, indicating a strong emphasis on user role management and access control throughout the application. Multiple user roles (`ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, etc.) are explicitly defined and used for route authorization.
*   **Modular Component and Page Structure:** The application is highly modular, with numerous imports from dedicated `pages` and `components` directories, suggesting a well-organized codebase following a feature-sliced or domain-driven structure.
*   **Analytics and Data Visualization:** The presence of `MetricsBox.jsx` and various related imports (e.g., `PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`) indicates a significant focus on displaying analytical data and providing interactive charts to users.
*   **Dashboard-Centric Design:** Many routes point to different "Dashboard" screens (e.g., `DashboardScreen`, `BookingDashbaordScreen`, `ISFDashboardScreen`), highlighting a dashboard-driven user experience for various application domains.
*   **Form and Master Data Management:** There are many "form" and "master" routes (e.g., `UserFormScreen`, `PLFormScreen`, `CustomerFormScreen`, `PortmasterScreen`, `CityMaster`), indicating comprehensive CRUD (Create, Read, Update, Delete) operations for various entities within the system.

## 9:15:58 AM
The changes log details updates across three core areas of the T360_Api backend, all occurring on November 21, 2025.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
This file handles fetching company details based on user roles (AGENT or CUSTOMER).
*   **Initial Change (10:07:54 AM):** The `getAll` function was implemented to retrieve distinct company names. For `AGENT`s, it queries `agent_po_account_master` and applies a `LIMIT 10`. For `CUSTOMER`s, it features more complex logic: it determines if pagination is requested. If so, it executes a `COUNT` query for the total number of records and a paginated `SELECT DISTINCT` query from `mtr_tracking_data`. If not paginated, it also applies a `LIMIT 10`. All results are formatted as `{ value: name, label: name }`. Temporary `console.log` statements were present for debugging pagination results.
*   **Subsequent Change (10:08:08 AM):** The `console.log` statements within the `CUSTOMER` pagination logic were removed, indicating a cleanup or stabilization of the debugging output.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
This file defines API endpoints for OTM (Oracle Transportation Management) Bill of Lading operations.
*   **Single Change (11:40:37 AM):** Several routes were defined:
    *   `GET /excel_data`: Exports Excel data.
    *   `GET /`: Fetches PLPO by BOL.
    *   `GET /fetch_payload`: Fetches payload data.
    *   `GET /:bol`: Fetches by BOL number.
    *   `POST /`: Edits an OTM BOL.
    *   `POST /upload_save_edit`: Handles upload, save, and edit operations.
    *   `GET /fetch/:common_key`: Fetches by a common key.
    *   `POST /generate_xml`: Generates XML.
    *   `POST /send_to_otm`: Sends data to OTM.
    *   A `POST /upload` route for file uploads using `uploadMiddleware` was commented out.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
This file manages the creation and saving of HBL (House Bill of Lading) bookings. It includes complex transaction handling and logging.
*   **Initial Change (3:11:14 PM):**
    *   `createHblMasterBooking` was introduced to create a master HBL entry. It sanitizes various body parameters, formats the `bookingdate`, and inserts them into the `hbl_master` table within a database transaction, returning a success response. Error handling uses `next(new HttpError())`.
    *   `saveHblBooking` was implemented to handle both adding and updating HBL bookings. It involves extensive data sanitization for numerous fields related to shipper, consignee, notify parties, ports, and other booking details.
    *   **Update Flow:** If an `agent_booking_id` is provided, it fetches current data across multiple related tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`) for logging purposes. It then updates `agent_booking_entry` and `agent_booking_vessel`, and performs a delete-and-re-insert pattern for `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` based on payload lists. It also updates `agent_booking_hbl`. Crucially, it logs both the old and new states of the booking to `agent_booking_hbl_history`.
    *   **Add Flow (incomplete):** If `agent_booking_id` is not present, a new `booking_id` is generated, and an entry is made into `agent_booking_entry`. The remaining logic for inserting into related tables for new bookings is cut off.
*   **Second Change (3:13:11 PM):** In `createHblMasterBooking`, the error handling was modified to `logger.error(error);`, removing the explicit `res.status(500).json(...)` response for errors. The `saveHblBooking` portion remained mostly unchanged.
*   **Third Change (3:16:23 PM):** In `saveHblBooking`, the `bookingdate` field within the `bookingInsertQuery` for `agent_booking_entry` was updated to `payload.booking_date || null`, making it explicitly nullable.
*   **Fourth Change (3:17:07 PM):**
    *   In `createHblMasterBooking`, the `bookingdate` in the payload was changed to `AppDateFormate(req.body.bookingdate, db_format) || null`, allowing it to be nullable.
    *   In `saveHblBooking`, the `hbldate` payload field now assigns `null` (instead of the string `'null'`) if `req.body.hbldate` is falsy. The `bookingdate` in `bookingInsertQuery` for `saveHblBooking` was reverted to `payload.booking_date` (no `|| null`).
*   **Fifth Change (3:19:06 PM):** In `createHblMasterBooking`, the `bookingdate` field in the payload was completely commented out, preventing its insertion into `hbl_master`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
This file configures the API routes for HBL entry.
*   **Initial Change (3:11:42 PM):** Routes were set up for `POST /` (mapped to `saveHblBooking`), `GET /` (mapped to `fetchHblFormDetails`), and another `POST /` (mapped to `createHblMasterBooking`). This created a routing conflict for `POST /`.
*   **Subsequent Change (3:19:52 PM):** The routing conflict was resolved by changing the second `POST /` route to `POST /create` for the `createHblMasterBooking` function. The `POST /` route remains for `saveHblBooking`, and `GET /` for `fetchHblFormDetails`.

**Patterns and Recurring Elements:**
*   **Timestamp Consistency:** All changes occurred on the same day, November 21, 2025, suggesting a focused development effort within a short timeframe.
*   **Database Operations:** There's a strong emphasis on database interaction, including `SELECT`, `INSERT`, `UPDATE`, `DELETE` queries, and explicit transaction management (`BEGIN`, `COMMIT`, `ROLLBACK`) across different controllers.
*   **Data Sanitization and Formatting:** The `sanitizeString` utility is frequently used for request body fields, indicating a focus on preventing common vulnerabilities. Dates are consistently formatted using `AppDateFormate` before database insertion or update.
*   **Role-Based Logic:** The `company_details.controller.ts` demonstrates logic branching based on user roles (AGENT vs. CUSTOMER).
*   **Logging:** `logger.info` and `logger.error` are extensively used for internal logging, and `console.log` was temporarily used for debugging.
*   **Complex Business Logic:** The `hblEntry.controller.ts` showcases intricate logic for handling HBL bookings, including multiple related data entities (booking, vessel, routing, container, PO) and a history tracking mechanism.
*   **Routing Refinement:** An initial routing conflict was identified and quickly resolved, indicating an iterative development process.

## 10:15:39 AM
The `App.js` file, recorded at 11/21/2025, 11:31:13 AM and identically at 11/21/2025, 11:34:00 AM, outlines the entire routing structure of a React frontend application. It imports a multitude of components from various functional modules such as `packing-list`, `service-invoice`, `expense-code`, `destination`, `vendor`, `po_order`, `dso_order`, `otm_bol`, `code` (customer, party, agent), `planboard`, `detention`, `commercial-invoice`, `booking`, `analytics`, `agent_po`, `cng-invoice`, `alc`, `shipping_orders`, `container-report`, `report`, `parse-pdf`, `alc_dashboard`, `tracking` (fcl, lcl, rail, air, mtr, trucking details), `dashboard_7501`, `shipments`, `cng-booking`, `city-master`, and `portmaster`. The application uses `react-router-dom` for navigation, `ThemeProvider` from `@mui/material` for styling, and `react-hot-toast` for notifications. A `console.log("ðŸš€ ~ file: App.js:2 ~ TEST on Flow");` statement is present. The core functionality relies heavily on `ProtectedRoute` components, applying granular role-based access control using `UserRoleEnum` for almost every route. Common roles include `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, and `ADMIN_V2`. Key routes cover dashboards, user management, various forms (booking, ISF, HBL, PO, BOL), master data maintenance, analytics, reporting, and extensive shipment tracking capabilities.

The `MetricsBox.jsx` file, updated at 11/21/2025, 11:36:28 AM, is a React component designed for displaying and interacting with various analytical charts. It dynamically renders `BarChart`, `PieChart`, `LineChart`, `StackedBarChart`, and `GaugeChart` based on the `item.chartType` property. The component integrates a `MetricToolbar` for managing chart views and options, a `MetricFooter` for additional actions, and a `ThemedModal` to provide a full-screen view of charts. It utilizes `useState` for managing local UI state like `chartView` and the modal's `enlarge` state, and `useSelector` from `react-redux` to access application-wide analytics state. The component also handles cases where no data is available for a chart.

Across these changes, a clear pattern of modular application development is evident, with distinct components and pages for different functionalities. The timestamps show that these updates were made within a short timeframe on November 21, 2025, indicating focused development activity. A recurring theme, particularly in `App.js`, is the emphasis on robust role-based access control for nearly all features, underscoring security and user permissions as critical aspects of the application's design. The use of a consistent `UserRoleEnum` across numerous protected routes highlights this pattern.

## 10:15:49 AM
The changes log details updates across `company_details.controller.ts`, `otm_bol.route.ts`, `hblEntry.controller.ts`, and `hblEntry.route.ts`, all occurring on **11/21/2025**.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
    *   **Timestamp: 11/21/2025, 10:07:54 AM**: The `getAll` function was significantly updated to handle company details based on user roles (`AGENT` or `CUSTOMER`).
        *   For `AGENT`s, it queries `cname` from `agent_po_account_master` with a search filter and limits results to 10.
        *   For `CUSTOMER`s, previous search logic was commented out and replaced with new logic that supports both paginated and non-paginated searches for `account_name` from `mtr_tracking_data`. Pagination includes fetching a total count and applying `LIMIT` and `OFFSET`. Several `console.log` statements were added for debugging purposes in the customer pagination logic.
    *   **Timestamp: 11/21/2025, 10:08:08 AM**: This update refined the `getAll` function in `company_details.controller.ts` by removing the debugging `console.log` statements that were introduced in the `CUSTOMER` role's pagination block.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
    *   **Timestamp: 11/21/2025, 11:40:37 AM**: Numerous new GET and POST routes were added to handle OTM BOL (Bill of Lading) functionalities. These include routes for fetching payload, fetching by BOL number and common key, editing OTM BOL, uploading and saving edits, generating XML, and sending data to OTM. A previous file upload route was commented out.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **Timestamp: 11/21/2025, 3:11:14 PM**: Introduced `createHblMasterBooking` and `saveHblBooking` functions.
        *   `createHblMasterBooking` handles the initial creation of HBL entries into `hbl_master` with extensive data sanitization and date formatting, using database transactions.
        *   `saveHblBooking` implements complex logic for both updating and creating HBL bookings, handling various related tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`). It includes fetching existing data before updates, performing deletes and re-inserts for lists (routing, containers, POs), and logging detailed historical changes (old and new payloads) to `agent_booking_hbl_history`.
    *   **Timestamp: 11/21/2025, 3:13:11 PM**: Modified the error handling in `createHblMasterBooking`'s catch block, changing from `next(new HttpError(...))` to `logger.error(error);`, effectively removing the HTTP error response from this specific function's error path.
    *   **Timestamp: 11/21/2025, 3:16:23 PM**: In `saveHblBooking`, the `bookingInsertQuery` was updated to explicitly handle a potentially null `booking_date` by assigning `payload.booking_date || null`.
    *   **Timestamp: 11/21/2025, 3:17:07 PM**: In `createHblMasterBooking`, the `bookingdate` payload field was also updated to explicitly handle null values using `AppDateFormate(...) || null`.
    *   **Timestamp: 11/21/2025, 3:19:06 PM**: The `bookingdate` field in the payload of `createHblMasterBooking` was commented out, indicating it will no longer be processed or inserted as part of that specific payload.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **Timestamp: 11/21/2025, 3:11:42 PM**: Routes were added for HBL entry, including `POST /` for `saveHblBooking`, `GET /` for `fetchHblFormDetails`, and another `POST /` for `createHblMasterBooking`. This created a routing conflict for `POST /`.
    *   **Timestamp: 11/21/2025, 3:19:52 PM**: The routing conflict was resolved by changing the route for `createHblMasterBooking` from `POST /` to `POST /create`.

**Patterns and Recurring Elements:**

*   **Unified Timestamp:** All changes occurred on the same date, 11/21/2025, suggesting a focused development sprint or feature implementation.
*   **Database Transactions:** There is a consistent pattern of using explicit database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) in the controller logic, especially in `hblEntry.controller.ts`, to ensure data integrity during complex multi-table operations.
*   **Data Sanitization and Formatting:** `sanitizeString` and `AppDateFormate` utilities are heavily used across controllers to process request body data before database interactions, ensuring consistency and security.
*   **Role-Based Logic:** The `company_details.controller.ts` demonstrates role-based data retrieval (`AGENT` vs. `CUSTOMER`), and `hblEntry.controller.ts` uses `req.user.role` to determine `locationByRole`.
*   **Detailed Logging:** `logger.info` and `logger.error` are extensively used for internal logging and error tracking throughout the controllers.
*   **Update-Delete-Insert Pattern:** For updating complex entries (like HBL bookings), the strategy involves fetching current data, deleting old related entries (e.g., routing, containers, POs), and then re-inserting the updated lists.
*   **Historical Data Logging:** In `hblEntry.controller.ts`, updates to HBL bookings are meticulously logged to `agent_booking_hbl_history`, capturing both the old and new states of the booking as JSON, which is valuable for auditing and debugging.

## 11:15:40 AM
The code changes primarily focus on user management, authentication flow, and application layout, with timestamps indicating a concise period of development on November 21, 2025.

In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx` (timestamp: 11/21/2025, 10:15:47 AM):
The `UserCard` component, responsible for displaying user information and providing a logout option, underwent significant revisions in its `handleLogout` function. The updated logic now ensures that for Auth0 authentication, `localStorage` items (`token`, `user`) are cleared and an `auth/logout` Redux action is dispatched *before* redirecting the user to the `login` page of the UI V1 base URL (previously `logout`). For standard authentication, the clearing of `localStorage` and dispatching of the logout action also happen before navigation. Additionally, the component now prioritizes displaying the user's first and last name from `useFetchUserPreferenceQuery` data, falling back to `localStorage` user data if the fetched data is unavailable. A utility function `getInitials` for avatar display was also added.

For `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (timestamp: 11/21/2025, 10:20:01 AM):
The `Layout` component received updates to manage user session and customer selection based on user role. An `useEffect` hook was added to check if the user token has expired or if `user` and `token` are missing from `localStorage` upon initial load. If invalid, it clears `localStorage` and redirects to the root path. Otherwise, it initializes the selected customer state. A second `useEffect` dynamically manages the `selectedCustomer` state: "CUSTOMER" roles automatically set their company name as the selected customer, while "ADMIN_V2" roles clear any selected customer. If an "ADMIN_V2" user has no selected customer, the layout now displays a "Please select a customer" prompt.

Recurring patterns across these changes include:
- **`localStorage` Dependency:** Both components heavily rely on `localStorage` for storing `user` and `token` information, as well as `selectedCustomer`.
- **Redux Integration:** State management is handled through Redux, with `useDispatch`, `useSelector`, and specific slices/APIs (`user-api`, `global-slice`) being used for data fetching, state initialization, and logout actions.
- **Role-Based Logic:** User roles ("CUSTOMER", "ADMIN_V2") are central to dictating application behavior, especially concerning logout redirects and customer filtering.
- **Navigation:** `react-router-dom` (`useNavigate`, `Outlet`) is used for managing application routes and redirects.
- **Session Management:** Both files contribute to robust session management by checking token validity and clearing user data upon logout or session expiration.

## 11:15:42 AM
The log primarily details changes across two files within a `t360-frontend` project, all occurring on November 21, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**
    *   **Timestamp:** The file was logged twice at **11:31:13 AM** and **11:34:00 AM**.
    *   **Changes:** Between these two timestamps, a very minor adjustment was made to the role-based access control for two specific routes: `shipment_tracking` and `booking`. The `UserRoleEnum.ADMIN_V2` role was removed from the `allowedRoles` array for both of these `ProtectedRoute` components.
    *   **Content Overview:** This file acts as the central routing configuration for the entire React application. It imports a vast number of screen components from various subdirectories (`pages`, `components`) and defines numerous routes, almost all of which are protected by `ProtectedRoute` components with specific `UserRoleEnum` roles. The application supports a wide range of features including user management, various administrative masters (expense code, destination, vendor, portmaster, city master), packing lists, service invoices, PO/DSO orders, OTM BOL management, diverse "code" entities (customer, party, agent), planboards, detention, commercial invoices, agent POs, CNG invoices, ALC, shipping orders, container reports, Auth0 authentication, report scheduling, PDF parsing, ALC dashboards, and several tracking functionalities (FCL, LCL, Rail, Air). There are also "extended" versions of booking and dashboard screens.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp:** **11/21/2025, 11:36:28 AM**.
    *   **Changes:** This is a single entry, representing the state of the `MetricsBox` component.
    *   **Content Overview:** This component is designed for displaying various types of analytical charts (Bar, Pie, Line, Stacked Bar, Gauge) within an analytics section. It includes a `MetricToolbar` for interactions, a `MetricFooter` (potentially for export or full-screen options), and a `ThemedModal` for enlarging charts. It handles cases where no data is available and dynamically renders the appropriate chart component based on `item.chartType` and `chartView`. The component uses `react-redux` for state management and features a `chartTree` object to map chart types to their respective React components.

**Patterns and Recurring Elements:**

*   **Role-Based Access Control:** A dominant pattern, especially in `App.js`, is the extensive use of `ProtectedRoute` with `UserRoleEnum` to enforce granular access permissions for different user roles (e.g., `ADMIN`, `CUSTOMER`, `AGENT`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `CSF`).
*   **Modular Feature Development:** The presence of numerous distinct screen components imported into `App.js` suggests a highly modular application architecture, with dedicated components for specific business functionalities (e.g., `PackingListScreen`, `UserManagementScreen`, `OtmBolScreen`).
*   **"Extended" and "V2" Naming:** The appearance of components like `AgentBookingFormScreenExtend`, `BookingDashbaordScreenExtend`, `CngBookingScreenExtend`, and the `ADMIN_V2` role implies an ongoing development process with iterations or upgraded versions of existing features.
*   **Analytics and Data Visualization:** The introduction of `MetricsBox.jsx` indicates a significant focus on presenting data through various chart types, suggesting a dedicated analytics dashboard or reporting feature within the application.
*   **Rapid Development Cycle:** All recorded changes occurred on the same day within a short span (just a few minutes), suggesting focused development or refinement activity.

## 11:15:51 AM
The code changes log details updates across three main files within a `t360-backend` project, all occurring on November 21, 2025.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
    *   **11/21/2025, 10:07:54 AM**: This version of the `getAll` function introduced logic to fetch company names based on user `role` (AGENT or CUSTOMER).
        *   For `AGENT`s, it queries `agent_po_account_master` for `cname` with an optional search and a limit of 10.
        *   For `CUSTOMER`s, it supports an optional search for `account_name` from `mtr_tracking_data`. A significant change here was the implementation of pagination, including a `COUNT` query for total records and a `SELECT DISTINCT` query with `LIMIT` and `OFFSET` for paginated results. It also included debug `console.log` statements.
    *   **11/21/2025, 10:08:08 AM**: A minor update removed two `console.log` statements (`"====totalResult"` and `"====result"`) from the `CUSTOMER` role's pagination logic, suggesting a cleanup of temporary debugging outputs.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
    *   **11/21/2025, 11:40:37 AM**: This entry shows the definition of several routes related to OTM (Oracle Transportation Management) Bill of Lading operations.
        *   It includes routes for fetching Excel data, getting PLPO (Packing List/Purchase Order) by BOL, fetching payload, fetching by BOL number, editing OTM BOL, uploading and saving edits, fetching by common key, generating XML, and sending data to OTM.
        *   A `POST /upload` route for file uploads with `uploadMiddleware` was present but commented out, indicating it was either under development, temporarily disabled, or replaced by another mechanism like `/upload_save_edit`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **11/21/2025, 3:11:14 PM**: Introduced `createHblMasterBooking` and `saveHblBooking` functions.
        *   `createHblMasterBooking` handles the insertion of new HBL records into the `hbl_master` table using transactions. It includes extensive payload sanitization.
        *   `saveHblBooking` handles both adding and updating HBL bookings (`agent_booking_entry` and related tables). For updates, it meticulously fetches current data across multiple tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`) to construct `old_hbl_logs` before performing updates, and then logs both old and new data to `agent_booking_hbl_history`. Lists like `routingList`, `containerList`, and `basicPoList` are managed by deleting existing entries and re-inserting the new ones during updates. New bookings generate a unique `agent_booking_id`.
    *   **11/21/2025, 3:13:11 PM**: The error handling in `createHblMasterBooking` was changed from passing an `HttpError` to the `next` middleware to simply logging the error with `logger.error`, which might leave the client waiting for a response.
    *   **11/21/2025, 3:16:23 PM**: In `saveHblBooking`, the `bookingdate` field within the `bookingInsertQuery` was updated to explicitly allow `null` values (`payload.booking_date || null`).
    *   **11/21/2025, 3:17:07 PM**: In `createHblMasterBooking`, the `bookingdate` field in the payload was also modified to allow `null` values (`AppDateFormate(...) || null`).
    *   **11/21/2025, 3:19:06 PM**: In `createHblMasterBooking`, the `bookingdate` field was completely commented out from the payload construction, indicating it is no longer being stored or handled in that specific operation.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **11/21/2025, 3:11:42 PM**: Initial route definitions for HBL entry. It included a problematic duplicate `POST /` route, where both `saveHblBooking` and `createHblMasterBooking` were assigned to the same path.
    *   **11/21/2025, 3:19:52 PM**: The duplicated `POST /` route was resolved by changing the `createHblMasterBooking` endpoint to `POST /create`, ensuring distinct paths for different functionalities.

### Patterns and Recurring Elements:

*   **Consistent Timestamp**: All changes logged occurred on the same date, November 21, 2025, suggesting a focused development session.
*   **Data Sanitization**: `sanitizeString(req.body.<field>)` is frequently used across controllers to clean input data, indicating a focus on security and data integrity.
*   **Date Formatting**: `AppDateFormate(date, db_format)` is consistently applied to format date fields to `YYYY-MM-DD` for database interaction, often with a fallback to `null`.
*   **Database Transactions**: `await query("BEGIN");`, `await insertQuery(...)`, `await updateQuery(...)`, `await query("COMMIT");`, and `await query("ROLLBACK");` are extensively used in controllers to ensure atomicity and data consistency for multi-step database operations.
*   **Logging**: `logger.info` and `logger.error` are common for internal debugging and error reporting.
*   **CRUD Operations with History**: The `hblEntry.controller.ts` demonstrates a robust approach to updates, first fetching current data to record historical changes before applying new ones, particularly for `agent_booking_hbl_history`.
*   **List Management in Updates**: For nested data like `routingList`, `containerList`, and `basicPoList`, the strategy is to delete all existing related records for a booking and then re-insert the updated list items.
*   **API Design Refinement**: The change in `hblEntry.route.ts` from a duplicated `POST /` route to a specific `POST /create` indicates an iteration on API endpoint design for clarity and functionality.

## 12:33:10 PM

The `usercard.tsx` file, updated on 11/21/2025 at 10:15:47 AM, primarily manages user display and logout functionality. It utilizes Redux for dispatching logout actions and React Router for navigation. Key updates include a refined `handleLogout` function: for Auth0 users, it now explicitly removes `token` and `user` from `localStorage` before redirecting to the `/login` endpoint defined by `VITE_UI_V1_BASE_URL`. For other authentication types, it clears `localStorage` and navigates to the root path (`/`). The component fetches user preferences via `useFetchUserPreferenceQuery` and displays the user's name and role, with a preference for data from the query over `localStorage`. It also includes a `getInitials` helper for avatar display.

The `layout.tsx` file, updated on 11/21/2025 at 10:20:01 AM, functions as the main application layout, enforcing authentication and managing customer selection. It checks for token expiration using `isTokenExpired`, which validates the presence of `user` and `token` in `localStorage` and verifies the token's `exp` timestamp. Upon an expired or missing token, it clears `localStorage` and redirects to the root path (`/`). A `useEffect` hook dynamically sets or clears the `selectedCustomer` in Redux and `localStorage` based on the `localUser`'s role: "CUSTOMER" roles automatically select their company, while "ADMIN_V2" roles clear any customer selection. If no customer is selected and the user is an "ADMIN_V2", a prompt to select a customer is displayed.

A recurring pattern across both files is the heavy reliance on `localStorage` for storing and retrieving user information (`user`, `token`, `authtype`, `selectedCustomer`). Both components also deeply integrate with Redux for state management (dispatching logout actions, managing `selectedCustomer` state) and React Router for navigation. The updates, occurring within minutes of each other, suggest a coordinated effort to refine user authentication, logout processes, and initial application state management, particularly regarding user roles and customer context.

## 12:33:18 PM
The provided log details changes across two frontend files, `App.js` and `MetricsBox.jsx`, all occurring on 11/21/2025.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**

*   **Timestamp: 11/21/2025, 11:31:13 AM**
    *   This update introduces a significant expansion of the application's routing configuration. Numerous new pages and components are imported, indicating a broad range of features being integrated.
    *   Key imports include: `Layout`, `ThemeProvider`, `ProtectedRoute`, `AuthGuard`, and `UserRoleEnum`, which are central to the application's structure and access control.
    *   Many new screen imports are added across various domains such as user management, packing lists, service invoices, expense codes, destinations, vendors, purchase orders, dashboards, settings, OTM BOLs, customer/party/agent code, planboards, detention, commercial invoices, analytics, ISF, agent POs, CNG invoices, ALC, shipping orders, container reports, Auth0 integration, report scheduling, PDF parsing, ALC dashboards, and various tracking screens (FCL, LCL, Rail, Air).
    *   The `App` component defines routes using `react-router-dom`, extensively utilizing `AuthGuard` for initial authentication and `ProtectedRoute` for role-based access control (`allowedRoles`) within the authenticated `/app` path. Supported roles include `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, and `ADMIN_V2`.
    *   Several routes, such as those related to booking forms and dashboards, are updated to use "Extend" versions of components (e.g., `AgentBookingFormScreenExtend`, `BookingDashbaordScreenExtend`).
    *   A `console.log` statement ("TEST on Flow") is present at the top level of the file.

*   **Timestamp: 11/21/2025, 11:34:00 AM**
    *   This change is a minor adjustment to the previous update. Specifically, the `UserRoleEnum.ADMIN_V2` role is **removed** from the `allowedRoles` array for the `/app/shipment_tracking` and `/app/booking` routes. This suggests a refinement in access control for these specific features shortly after their initial configuration. Otherwise, the file content remains identical to the previous timestamp.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**

*   **Timestamp: 11/21/2025, 11:36:28 AM**
    *   This log entry details the implementation of a `MetricsBox` component responsible for displaying various analytical charts.
    *   It imports several chart components (`PieChart`, `BarChart`, `LineChart`, `StackedBarChart`, `GaugeChart`), along with `MetricToolbar`, `MetricFooter`, `ThemedModal`, and Redux's `useSelector`.
    *   The `MetricsBox` component dynamically renders different chart types based on `item.chartType` and a local `chartView` state, which can be `bar`, `pie`, `line`, `stack`, or `gauge`.
    *   It integrates a `MetricToolbar` for controlling chart views and `MetricFooter` for additional chart actions.
    *   Charts are displayed with a fallback `NoDataAvailable` message if `item.data` is empty.
    *   A `ThemedModal` is implemented to provide a full-screen, enlarged view of the charts, with height calculated dynamically based on data length. For the regular view, `item.data` is sliced to show only the first 9 entries, suggesting an optimization for initial display.
    *   A subtle correction in import path case is observed from `./charts/PieChart` to `./Charts/PieChart`.
    *   The component retrieves analytics state from Redux using `useSelector`.

**Patterns and Recurring Elements:**

*   **Role-Based Access Control:** A dominant pattern in `App.js` is the extensive use of `ProtectedRoute` and `UserRoleEnum` to enforce fine-grained access control across almost all application routes. This indicates a robust security and authorization architecture.
*   **Modular Component Design:** Both files demonstrate a modular approach. `App.js` orchestrates various "screens" (pages), each likely being a composite component. `MetricsBox.jsx` itself is a component designed to encapsulate chart display logic and associated controls.
*   **Dynamic UI Rendering:** `MetricsBox.jsx` specifically showcases dynamic rendering of UI elements (charts) based on data and user interaction, allowing for flexible visualization of analytics.
*   **Feature Expansion:** The sheer volume of new imports and routes in `App.js` suggests a rapid and significant expansion of the application's capabilities, particularly in areas like logistics tracking (FCL, LCL, Rail, Air), administrative master data, and various order/invoice processes.
*   **Consistency in Naming:** Page components follow a consistent naming convention (e.g., `[Feature]Screen`, `[Feature]FormScreen`).
*   **Timestamp Proximity:** All changes occurred within a short time frame on the same date, suggesting active development and refinement of existing or newly introduced features.

## 12:33:24 PM
The provided log details code changes across three primary files, focusing on company details, OTM (Oracle Transportation Management) Bill of Lading (BOL) routes, and HBL (House Bill of Lading) entry and routing logic. All timestamps are dated 11/21/2025, which appears to be a consistent placeholder or future date.

### File-Specific Updates:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
   - **Timestamp: 11/21/2025, 10:07:54 AM**
     - Introduced an endpoint `getAll` that fetches company details based on the user's role (`AGENT` or `CUSTOMER`).
     - For `AGENT` roles, it queries `agent_po_account_master` for distinct company names (`cname`) with a search filter and limits results to 10.
     - For `CUSTOMER` roles, it queries `mtr_tracking_data` for distinct `account_name`. This section includes pagination logic, allowing fetching a total count and paginated results based on `page` and `perPage` parameters, or a default limit of 10 if pagination is not enabled.
     - The code includes robust error handling and logging.
   - **Timestamp: 11/21/2025, 10:08:08 AM**
     - A minor cleanup, removing `console.log` statements related to `totalResult`, `result`, and `total` from the `CUSTOMER` role's pagination logic. No functional changes.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
   - **Timestamp: 11/21/2025, 11:40:37 AM**
     - This file defines various API routes related to OTM BOL management.
     - Routes include:
       - `GET /excel_data` for exporting excel data.
       - `GET /` to fetch PLPO (Packing List / Purchase Order) by BOL.
       - `GET /fetch_payload` to retrieve payload data.
       - `GET /:bol` to fetch data by a specific BOL number.
       - `POST /` to edit OTM BOL details.
       - A `POST /upload` route for file uploads (`plFile`, `dutyFile`) is commented out.
       - `POST /upload_save_edit` for uploading, saving, and editing.
       - `GET /fetch/:common_key` to fetch data by a common key.
       - `POST /generate_xml` to generate XML.
       - `POST /send_to_otm` to send data to OTM.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
   - This file underwent significant, iterative changes throughout the day.
   - **Timestamp: 11/21/2025, 3:11:14 PM**
     - Introduced `createHblMasterBooking` and `saveHblBooking` functions.
     - `createHblMasterBooking`: Handles the creation of a new HBL master record, sanitizing various shipping, consignee, and notification details, and performing an atomic database insert into `hbl_master` within a transaction. Includes error handling using `HttpError`.
     - `saveHblBooking`: This is a comprehensive function for both creating (`ADD`) and updating (`UPDATE`) HBL bookings.
       - It sanitizes a large number of fields from the request body.
       - In `UPDATE` mode, it first fetches existing booking data (entry, vessel, routing, container, HBL details, POs) for logging purposes. It then updates `agent_booking_entry` and `agent_booking_vessel`. For routing, containers, and POs, it deletes existing records and re-inserts the new lists. Finally, it updates `agent_booking_hbl` and logs both old and new data into `agent_booking_hbl_history` for auditing.
       - The `ADD` mode logic is partially visible, showing the generation of a new `booking_id` and initial insertion into `agent_booking_entry`.
   - **Timestamp: 11/21/2025, 3:13:11 PM**
     - Changed error handling in `createHblMasterBooking`'s catch block from `next(new HttpError(error.message, 500))` to `logger.error(error);`, removing the explicit `HttpError` response for that specific function.
     - Minor adjustment in `saveHblBooking` where `hbldate` payload assignment changed from `'null'` string to actual `null` if the date is not provided.
   - **Timestamp: 11/21/2025, 3:16:23 PM**
     - Changed `bookingdate` in the `bookingInsertQuery` within `saveHblBooking` to explicitly allow `null` (`payload.booking_date || null`).
   - **Timestamp: 11/21/2025, 3:17:07 PM**
     - Reverted the `hbldate` change in `saveHblBooking` back to `'null'` string.
     - Reverted the `bookingdate` change in `saveHblBooking`'s `bookingInsertQuery` back to `payload.booking_date` (without `|| null`).
     - Added `|| null` to the `bookingdate` assignment in `createHblMasterBooking`'s payload.
     - This timestamp primarily shows reverts to previous changes regarding null handling for dates.
   - **Timestamp: 11/21/2025, 3:19:06 PM**
     - Commented out the `bookingdate` field completely from the `payload` initialization in `createHblMasterBooking`, indicating that `bookingdate` will no longer be handled by this specific function.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
   - **Timestamp: 11/21/2025, 3:11:42 PM**
     - Defined routes for HBL entry: `POST /` for `saveHblBooking`, `GET /` for `fetchHblFormDetails`, and a conflicting `POST /` for `createHblMasterBooking`.
   - **Timestamp: 11/21/2025, 3:19:52 PM**
     - Resolved the route conflict by changing the `POST /` route for `createHblMasterBooking` to `POST /create`.

### Patterns and Recurring Elements:

*   **Future Timestamps**: All log entries share timestamps in November 2025, suggesting a non-real-time log or placeholder dates.
*   **Role-Based Access/Logic**: The `company_details.controller.ts` clearly segments data retrieval based on user roles (`AGENT` vs. `CUSTOMER`).
*   **Database Interactions**: There is heavy reliance on database queries (`query`, `insertQuery`, `updateQuery`) and transaction management (`BEGIN`, `COMMIT`, `ROLLBACK`) across the controllers, particularly in `hblEntry.controller.ts` for ensuring data integrity during complex booking operations.
*   **Data Sanitization**: The `hblEntry.controller.ts` consistently uses `sanitizeString(req.body.<field>)` for numerous fields, indicating an emphasis on preventing SQL injection or other input-related vulnerabilities.
*   **Date Handling**: Dates are consistently formatted using `AppDateFormate` and a `YYYY-MM-DD` format. There were several small changes and reverts related to handling `null` values for dates.
*   **Audit Trail**: The `saveHblBooking` function implements an extensive audit logging mechanism, capturing `old_hbl_logs` and `new_hbl_logs` in a `agent_booking_hbl_history` table during updates.
*   **Update Strategy for Lists**: For nested lists within HBL bookings (e.g., `routingList`, `containerList`, `basicPoList`), the update mechanism involves deleting all existing child records associated with the booking and then re-inserting the entire new list.
*   **Centralized Error Handling**: `HttpError` is commonly used for consistent error responses, although `hblEntry.controller.ts` shows a brief deviation from this pattern.
*   **Detailed Logging**: `logger.info` and `logger.error` statements are pervasive, indicating an emphasis on detailed operational logging and debugging.

## 1:33:09 PM
The `usercard.tsx` file, last modified on 11/21/2025, 10:15:47 AM, introduces a `UserCard` component responsible for displaying user information and providing a logout mechanism. Key updates include:
*   An `handleLogout` function was refactored to ensure `localStorage` items (`token`, `user`) are cleared and an `auth/logout` Redux action is dispatched **before** any redirection occurs.
*   For Auth0 users, the logout now redirects to a login page (`${link}/login`) instead of a dedicated logout endpoint, after clearing local user data.
*   The component fetches user preferences using `useFetchUserPreferenceQuery` and displays the user's name (from fetched data or `localStorage`) and role.
*   It utilizes a `getInitials` helper function to generate avatar initials.

The `layout.tsx` file, updated on 11/21/2025, 10:20:01 AM, focuses on application layout and managing global customer selection and authentication state:
*   It implements an `isTokenExpired` function to check the validity of the user's session based on an `exp` property in `localStorage`'s user object.
*   An `useEffect` hook ensures that if the token is expired or missing, `localStorage` is cleared, and the user is redirected to the root path. Otherwise, it dispatches `initializeSelectedCustomer`.
*   Another `useEffect` manages the `selectedCustomer` state in Redux and `localStorage` based on the user's role: "CUSTOMER" roles automatically set their company as the `selectedCustomer`, while "ADMIN_V2" roles clear any selected customer.
*   The component conditionally renders its `Outlet` content only if a `selectedCustomer` is present. For "ADMIN_V2" users without a selected customer, it displays a "Please select a customer" message.

Recurring patterns across both files include:
*   Extensive use of `localStorage` for managing user authentication tokens, user details, and selected customer information.
*   Integration with Redux (`useDispatch`, `useSelector`) for managing global application state, such as authentication status and selected customer.
*   Utilization of `react-router-dom` for navigation (`useNavigate`, `Outlet`).
*   A strong emphasis on user role-based logic and secure handling of user sessions (login/logout, token expiry).

## 1:33:16 PM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js` underwent significant updates, primarily focused on expanding routing and role-based access control.

*   **11/21/2025, 11:31:13 AM:** This commit introduced a large number of new screens and their corresponding routes, indicating a major feature expansion across various modules. Key additions include:
    *   **New Master Data Screens:** `CustomerScreen`, `PartyScreen`, `AgentScreen`, `PortmasterScreen`, `CityMaster`, each with associated form screens.
    *   **Booking and Planning:** `AgentBookingFormScreenExtend` (replacing an older version), `BookingDashbaordScreenExtend` (also replacing an older version), `BookingPlanBoardScreen`, `SPRPlanBoardScreen`, `ISFEntryFormScreen`, `HblEntryFormScreen`, `AgentPoFormScreen`, `AgentPoFormExtend`, `CngBookingScreen`, `CngBookingFormScreen`, `CngBookingScreenExtend`.
    *   **Tracking and Shipping:** `ShippingOrdersScreen`, `ContainerReportScreen`, `FCLScreen`, `LCLScreen`, `RailScreen`, `AirTrackingScreen`, `ShipmentTrackingScreen`, `AddMtrForm`, `GetTruckingDetails`.
    *   **Invoice and Financials:** `ServiceInvoiceScreen`, `ExpenseCodeScreen`, `CIScreen`, `CngInvoiceScreen`, `SprInvoiceScreen`, `AlcScreen`, `AlcFormScreen`, `SprAlcScreen`, `AlcGenerated`, `AlcExceptionDashboard`, `AlcDestinationCostRecord`.
    *   **Reporting and Analytics:** `AnalyticsScreen`, `ReportSchedulerScreen`, `NewReportScreen`, `EditReportScreen`, `PdfParserScreen`, `ISFDashboardScreen`, `Dashboard7501Screen`.
    *   **User Management/Admin:** `UserManagementScreen`, `NewRegisteredUserScreen`, `SettingsScreen`, `BackOfficeAdminTerminal`.
    *   **OTM BOL Management:** `OtmBolScreen`, `AddOtmBolScreen`, `EditOtmBolScreen`, `UploadOTMBOL`.
    *   **Detention:** `LineWiseScreen`, `CustomerWiseScreen`.
    *   The root path configuration was updated, explicitly using `LoginScreen` within an `AuthGuard` while `Auth0Login` was commented out. The main `/app` route and several sub-routes (`shipment_tracking`, `booking`) were configured to allow `UserRoleEnum.ADMIN_V2` along with other roles.

*   **11/21/2025, 11:34:00 AM:** A subsequent change to `App.js` removed `UserRoleEnum.ADMIN_V2` from the `allowedRoles` array for both the `/app/shipment_tracking` and `/app/booking` routes. This indicates a refinement in the access control strategy for these specific features shortly after the initial expansion.

The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx` was updated on **11/21/2025, 11:36:28 AM**. This component is responsible for displaying various types of analytical charts (Pie, Bar, Line, Stacked Bar, Gauge) with filtering and full-screen viewing capabilities.
*   It imports a range of chart components and utility components like `MetricToolbar`, `MetricFooter`, `ThemedModal`, and `NoDataAvailable`.
*   It uses `useState` to manage the currently selected chart view (`chartView`) and the state of an "enlarge" modal (`enlarge`).
*   The `useSelector` hook from `react-redux` is used to access the `analytics` state, suggesting integration with a global state management system.
*   A `getChartComponent` function dynamically renders the appropriate chart based on `item.chartType` and `chartView`, including logic to calculate dynamic chart height for larger views.
*   The component conditionally renders either the chart or a `NoDataAvailable` message.
*   It provides a `MetricToolbar` for interactivity (e.g., changing chart views) and a `MetricFooter` that includes the "enlarge" functionality, allowing users to view charts in a full-screen modal.
*   Debugging `console.log` statements (`"==data==jjj"`, `"===item===1234556"`) are present.

**Patterns and Recurring Elements:**
*   **Role-Based Access Control:** A dominant pattern in `App.js` is the extensive use of `ProtectedRoute` and `AuthGuard` with `UserRoleEnum` to enforce granular access based on user roles (e.g., `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`).
*   **Feature Expansion:** The `App.js` changes consistently add new screens and routes, indicating continuous development and growth of the application's functional scope, especially in areas like booking, tracking, and various administrative/master data management modules.
*   **Component Evolution:** The replacement of base components with "Extend" versions (e.g., `AgentBookingFormScreen` to `AgentBookingFormScreenExtend`) suggests iterative improvements or refactoring of core features.
*   **Modular UI with State Management:** In `MetricsBox.jsx`, the use of separate components for different chart types, a dedicated toolbar and footer, and `useState` with `useSelector` (Redux) highlights a modular approach to UI development and data handling.

## 1:33:30 PM
The code changes primarily focus on refining API endpoints and business logic for `company_details`, OTM BOL (Bill of Lading), and HBL (House Bill of Lading) entries.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
    *   **Timestamp: 11/21/2025, 10:07:54 AM & 10:08:08 AM**
        *   The `getAll` function was implemented to fetch company details based on user role (`AGENT` or `CUSTOMER`).
        *   `AGENT` role fetches `cname` from `agent_po_account_master` with a search filter and limit.
        *   `CUSTOMER` role includes logic for both paginated and non-paginated data retrieval of `account_name` from `mtr_tracking_data`. The paginated version supports `page`, `perPage`, `offset`, and returns a `total` count.
        *   Minor logging adjustments were made between the two timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
    *   **Timestamp: 11/21/2025, 11:40:37 AM**
        *   An existing POST route for `/upload` (using `uploadMiddleware` for file uploads) was commented out.
        *   A new POST route `/upload_save_edit` was introduced, likely replacing or streamlining the previous upload functionality into a combined upload, save, and edit endpoint (`otm_bolController.uploadSaveEdit`).
        *   Other GET and POST routes for OTM BOL operations (fetching data by various keys, editing, generating XML, sending to OTM) remain defined.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **Initial Implementation (11/21/2025, 3:11:14 PM)**:
        *   Introduced `createHblMasterBooking` for single HBL master record creation and `saveHblBooking` for comprehensive HBL booking management.
        *   `saveHblBooking` supports both adding new bookings and updating existing ones, involving complex multi-table operations (`agent_booking_entry`, `_vessel`, `_routing`, `_container`, `_hbl`, `_po`). It also implements a logging mechanism to record old and new data for updates.
    *   **Subsequent Refinements and Changes:**
        *   **11/21/2025, 3:13:11 PM**: Modified error handling in `createHblMasterBooking` to use `logger.error` instead of `HttpError` middleware, removing a direct HTTP error response.
        *   **11/21/2025, 3:16:23 PM & 3:17:07 PM**: `bookingdate` fields in both `saveHblBooking` and `createHblMasterBooking` were made nullable. `bookingdate` was then commented out entirely from `createHblMasterBooking` at **3:19:06 PM**.
        *   **11/24/2025, 1:19:43 PM**: `createHblMasterBooking` was updated to return all inserted rows (`data: rows`) instead of just the first, and a proper 500 HTTP error response was re-added to its catch block.
        *   **Major Refactor for Bulk Creation (11/24/2025, 1:23:51 PM)**: `createHblMasterBooking` was significantly refactored to accept an array of HBL entries (`hbl_entries`) for bulk insertion into the `hbl_master` table using a new `insertMany` utility. It also began including `lastmodifieddate: "NOW()"`.
        *   **Minor Reversals and Potential Bug (11/24/2025, 1:24:40 PM - 1:29:01 PM)**: The `lastmodifieddate` addition was commented out. Crucially, the `insertMany` call in `createHblMasterBooking` was changed back to `insertQuery` while still attempting to pass an array (`payloadArray`), which likely introduces a bug as `insertQuery` typically handles single objects. This potential bug persisted across multiple subsequent commits.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **Timestamp: 11/21/2025, 3:11:42 PM**: Initially, a route conflict existed where both `saveHblBooking` and `createHblMasterBooking` were assigned to the same POST endpoint (`/`).
    *   **Timestamp: 11/21/2025, 3:19:52 PM**: The route conflict was resolved by moving `createHblMasterBooking` to a dedicated POST endpoint (`/create`), making both functionalities independently accessible.

**Timestamps of Significant Changes:**

*   **11/21/2025, 10:07:54 AM**: Initial implementation of role-based company data fetching with pagination logic.
*   **11/21/2025, 11:40:37 AM**: Restructuring of OTM BOL upload functionality, deprecating an old route and introducing a new combined endpoint.
*   **11/21/2025, 3:11:14 PM**: Introduction of core HBL master and booking creation/update logic, including comprehensive multi-table updates and change logging.
*   **11/21/2025, 3:19:52 PM**: Resolution of a critical route conflict for HBL POST operations.
*   **11/24/2025, 1:23:51 PM**: Major refactor of `createHblMasterBooking` to support bulk insertion of HBL entries.

**Patterns and Recurring Elements:**

*   **Database Transactions:** Extensive use of `BEGIN`, `COMMIT`, and `ROLLBACK` to maintain data integrity during complex database operations, especially in `hblEntry.controller.ts`.
*   **Input Sanitization and Date Formatting:** Consistent application of `sanitizeString` and `AppDateFormate` across controllers for data cleaning and consistency.
*   **Detailed Logging:** Frequent use of `logger.info` for operational insights and `logger.error` for error tracking.
*   **Role-Based Access/Logic:** Evident in `company_details.controller.ts` where different data retrieval strategies are employed based on user roles (`AGENT` vs. `CUSTOMER`).
*   **Audit/History Logging:** `saveHblBooking` demonstrates a pattern of capturing the state of data before and after updates for auditing purposes, storing logs as JSON.
*   **Evolving API Design:** The `hblEntry.controller.ts` shows a dynamic development process, from single-entry handling to bulk operations, with intermediate steps involving nullability and error handling adjustments. The route definition for HBL also shows a quick correction of a design flaw.

## 2:43:52 PM
The `usercard.tsx` file, last updated on 11/21/2025 at 10:15:47 AM, primarily manages user display and logout functionality. Key changes involve a significant refactor of the `handleLogout` function. For Auth0 users, the updated logic now clears `token` and `user` from `localStorage` and dispatches an `auth/logout` action *before* redirecting to the `/login` endpoint of the UI V1 base URL. Previously, this occurred after a redirect to `/logout`. For non-Auth0 users, the logout process remains similar: clearing local storage, dispatching `auth/logout`, and navigating to the root (`/`). The component displays the user's initials, name (preferring fetched user preferences over `localStorage` data), and role within a dropdown menu, which includes the sign-out option.

The `layout.tsx` file, updated on 11/21/2025 at 10:20:01 AM, focuses on application layout, session management, and customer selection logic. It includes an `isTokenExpired` function that checks the validity of the user's session based on a token's expiration timestamp stored in `localStorage`. An initial `useEffect` hook ensures that if the token is expired or missing, `localStorage` is cleared, and the user is redirected to the root path (`/`); otherwise, it dispatches `initializeSelectedCustomer`. A second `useEffect` hook dynamically manages the `selectedCustomer` state based on the user's role: `CUSTOMER` roles automatically set their own company as the `selectedCustomer`, while `ADMIN_V2` roles clear any `selectedCustomer` filter. The component renders child routes via `<Outlet />` only if a `selectedCustomer` is present. If an `ADMIN_V2` user has no selected customer, a prompt "Please select a customer" is displayed.

A recurring pattern across both files is the extensive use of `localStorage` for storing and retrieving user authentication (token) and profile (`user`) information. Both components also utilize Redux (`useDispatch`, `useSelector`) for state management and `useNavigate` for programmatic routing. Conditional logic based on user roles (`CUSTOMER`, `ADMIN_V2`) and authentication status (token presence/expiration) is central to their functionality, governing UI presentation and application flow.

## 2:43:59 PM
The `App.js` file underwent multiple updates, primarily focused on refining routing and access control within the application, indicating active development in the frontend's navigation structure.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**
    *   **Timestamp: 11/21/2025, 11:31:13 AM:** This version shows a comprehensive set of routes covering various modules like user management, packing lists, service invoices, expense codes, destinations, vendors, PO/DSO orders, OTM BOLs, customer/party/agent management, planboards, detention, commercial invoices, agent POs, CNG invoices, ALC, shipping orders, container reports, reporting, PDF parsing, ALC dashboards, and extensive tracking features (FCL, LCL, MTR, Trucking, Rail, Air). Many routes are protected by `ProtectedRoute` based on multiple `UserRoleEnum`s including `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, and `ADMIN_V2`. Notable additions or updates include `AgentBookingFormScreenExtend`, `AgentPoFormExtend`, `BookingDashbaordScreenExtend`, `Dashboard7501Screen`, `ShipmentsScreen`, `CngBookingScreen`, `CngBookingFormScreen`, `CngBookingScreenExtend`, `CityMaster`, `UploadOTMBOL`, `PortmasterScreen`, and `AirTrackingScreen`. A debug `console.log("ðŸš€ ~ file: App.js:2 ~ TEST on Flow");` is present.
    *   **Timestamp: 11/21/2025, 11:34:00 AM:** This entry is very similar to the previous one for `App.js`, but with subtle changes in role-based access control. Specifically, the `UserRoleEnum.ADMIN_V2` role was removed from the `allowedRoles` array for the "shipment\_tracking" and "booking" routes. This suggests a minor adjustment to the permissions for this specific administrator role on these two features.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\MetricsBox.jsx`**
    *   **Timestamp: 11/21/2025, 11:36:28 AM:** This file defines the `MetricsBox` React component, which is responsible for rendering various chart types (Bar, Pie, Line, Stacked Bar, Gauge) within an analytics dashboard. It includes a `MetricToolbar` for interactions, handles `NoDataAvailable` states, and provides a `MetricFooter` with an enlarge feature using `ThemedModal`. The component dynamically selects chart components based on `item.chartType` and `chartView` states. A minor fix involved changing the import path for `PieChart` from `./charts/PieChart` to `./Charts/PieChart` (capitalization change). The component utilizes Redux state via `useSelector` and contains `console.log` statements for debugging purposes.

**Patterns and recurring elements:**

*   **Extensive React Routing with Role-Based Access Control:** The `App.js` changes repeatedly demonstrate the use of `react-router-dom` `Routes` and `Route` components, heavily relying on `ProtectedRoute` and `AuthGuard` to enforce granular access control for different user roles (`ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`). This pattern is central to the application's security and navigation.
*   **Modular Component and Page Structure:** The application follows a clear module-based architecture, with many dedicated "screens" (pages) for specific functionalities, often paired with corresponding "form" screens (e.g., `PackingListScreen`/`PLFormScreen`).
*   **Focus on Analytics and Reporting:** The introduction of `AnalyticsScreen` and the detailed `MetricsBox` component, along with report scheduling and editing screens, highlights a strong emphasis on data visualization and reporting features.
*   **Expansion of Tracking and Master Data Features:** Numerous new screens related to shipment tracking (`FCLScreen`, `LCLScreen`, `ShipmentTrackingScreen`, `RailScreen`, `AirTrackingScreen`) and master data management (`CityMaster`, `PortmasterScreen`) indicate continuous development in logistics and data management capabilities.
*   **Iterative Development/Feature Extensions:** Several components are named with "Extend" (e.g., `AgentBookingFormScreenExtend`, `BookingDashbaordScreenExtend`), suggesting enhancements or new versions of existing functionalities.
*   **Debugging Practices:** The presence of `console.log` statements in both `App.js` and `MetricsBox.jsx` indicates developers are using basic debugging outputs in the codebase.

## 2:44:14 PM
The log details development activities primarily within the `t360-backend` API, focusing on company details, OTM BOL (Bill of Lading), and HBL (House Bill of Lading) entry functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`**
    *   **Timestamp: 11/21/2025, 10:07:54 AM & 10:08:08 AM**
        *   The `getAll` function was implemented to retrieve company names based on user roles ('AGENT' or 'CUSTOMER').
        *   For 'AGENT' users, it fetches distinct company names (`cname`) from the `agent_po_account_master` table, limiting results to 10 and supporting search by `cname`.
        *   For 'CUSTOMER' users, it fetches distinct account names (`account_name`) from the `mtr_tracking_data` table. This section includes logic for both paginated and non-paginated results, allowing for dynamic limits and offsets.
        *   Database transactions (`query`, `logger.info`, `logger.error`) and structured error responses (`res.status(500).json`) are used. The two timestamps represent nearly identical saves, indicating minor or no functional changes between them.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`**
    *   **Timestamp: 11/21/2025, 11:40:37 AM**
        *   New routes were added for OTM BOL operations, including:
            *   GET endpoints: `/excel_data` (for excel export), `/` (for PL/PO by BOL), `/fetch_payload`, `/:bol` (fetch by BOL number), and `/fetch/:common_key`.
            *   POST endpoints: `/` (for editing OTM BOL), `/upload_save_edit`, `/generate_xml`, and `/send_to_otm`.
        *   A previous `/upload` POST route, utilizing `uploadMiddleware`, was commented out.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **Initial Implementation & Refinement (11/21/2025, 3:11:14 PM - 3:19:06 PM):**
        *   Introduced `createHblMasterBooking` for creating single HBL master entries and `saveHblBooking` for a more comprehensive upsert (create or update) operation of HBL bookings.
        *   `saveHblBooking` performs detailed updates across multiple tables (`agent_booking_entry`, `agent_booking_vessel`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_hbl`, `agent_booking_po`), including fetching current data for logging, deleting and re-inserting related list data, and tracking changes in `agent_booking_hbl_history`.
        *   There were incremental changes:
            *   The error handling in `createHblMasterBooking` initially used `HttpError` but was temporarily simplified to just `logger.error`, removing the client-facing error response.
            *   Date field handling was adjusted (`bookingdate`, `hbldate`) to explicitly accept `null` values instead of default strings or direct parsing, and `bookingdate` in `createHblMasterBooking` was commented out of the payload construction, indicating it might not be relevant for that specific entry type.
    *   **Major Refactor for Bulk Insertion (11/24/2025, 1:19:05 PM - 1:29:01 PM):**
        *   The `createHblMasterBooking` function underwent a significant refactor to support the bulk creation of HBL entries. It now expects an array named `hbl_entries` in the request body.
        *   It validates the input array and uses `insertMany` (after a brief, quickly reverted error using `insertQuery`) to efficiently insert multiple HBL records into the `hbl_master` table within a single transaction.
        *   The success response for bulk creation was updated to return all inserted rows (`data: rows`) instead of just the first.
        *   Error handling for `createHblMasterBooking` was re-introduced to provide a `500 Internal server error` response.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **Route Conflict Resolution (11/21/2025, 3:11:42 PM - 3:19:52 PM):**
        *   Initially, there was a route conflict where both `saveHblBooking` and `createHblMasterBooking` were assigned to `POST /`.
        *   This was resolved by moving `createHblMasterBooking` to a new endpoint: `POST /create`.

**Patterns and Recurring Elements:**

*   **Database Transactions:** A consistent pattern of wrapping database operations in explicit transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) is observed across controllers, ensuring data integrity.
*   **Input Sanitization:** Extensive use of `sanitizeString()` for request body parameters to mitigate potential security vulnerabilities like injection attacks.
*   **Date Formatting:** Dates are consistently formatted using `AppDateFormate(date, db_format)` before database interaction.
*   **Logging and Error Handling:** `logger.info` and `logger.error` are frequently used for debugging and operational visibility. Error handling typically involves catching exceptions, rolling back transactions, and responding with a `500 Internal server error` message to the client. The custom `HttpError` class is also utilized.
*   **Role-Based Logic:** The `company_details.controller.ts` demonstrates logic branching based on user roles (`AGENT` vs `CUSTOMER`), indicating a role-aware application design.
*   **Bulk Operations:** The refactor of `createHblMasterBooking` to use `insertMany` highlights a move towards optimizing database write operations for multiple records.