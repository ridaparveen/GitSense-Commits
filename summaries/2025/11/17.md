# Activity Summary for 11/17/2025

## 10:45:45 AM
The provided log details changes to a single file: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\notificationService.ts`. All modifications focus on the `getNotificationDetails` asynchronous function within this service, indicating active development or debugging related to notification retrieval logic.

**File-specific updates for `src/services/notificationService.ts`:**

*   **11/17/2025, 9:57:34 AM:**
    *   The initial version of the `getNotificationDetails` function is shown. It fetches user-specific event preferences (`t49_cont_emptyout_date`, etc.) from `public.v2_user_details` based on `usercode`.
    *   It then filters these preferences to get `trueFields` (event types the user wants notifications for).
    *   An `auditEventSql` query is constructed using these `trueFields` in an `IN` clause to fetch audit log notifications from `public.v2_notification_log`.
    *   `auditParams` is set using `req?.user?.companyname`.
    *   The function also fetches message notifications from `shipment_tracking_message`.
    *   Both audit and message notifications are merged, sorted by `lastmodifieddate`, and limited by `pageSize`.

*   **11/17/2025, 9:59:36 AM:**
    *   **Introduced a SQL safety fix:** A new variable `safeFields` was added. This variable ensures that if `trueFields` (from user event preferences) is empty, the `field_id in (...)` clause in `auditEventSql` doesn't become `IN ()`, which would cause a SQL error. Instead, it defaults to `["__no_match__"]` if `trueFields` is empty.
    *   `auditParams` was updated to use the `companyName` variable (which is derived from `req.query.CompanyName` or `req.user?.companyname`) instead of directly `req?.user?.companyname`.
    *   A large commented-out block of the original `auditEventSql` was added, reflecting the change.

*   **11/17/2025, 10:36:22 AM:**
    *   **Reverted the SQL safety fix:** The `safeFields` variable and its usage in `auditEventSql` were removed, returning to directly using `trueFields` which could potentially lead to the `IN ()` SQL error if `trueFields` is empty.
    *   The large commented-out `auditEventSql` block was also removed.

*   **11/17/2025, 10:38:58 AM:**
    *   **Re-introduced the SQL safety fix:** The `safeFields` variable was added back, along with the `// FIX: prevent SQL error IN ()` comment, re-implementing the protection against empty `IN ()` clauses in the `auditEventSql`.
    *   There was a temporary code duplication: the lines defining `userEvents` and `trueFields` were commented out and then re-declared right below, with the `safeFields` logic inserted after the duplicated block. This appears to be a copy-paste artifact during the re-introduction of the fix.

*   **11/17/2025, 10:41:34 AM:**
    *   **Code cleanup and minor addition:** The duplicate and commented-out `userEvents`/`trueFields` declarations were removed, streamlining the code. The `safeFields` logic remained correctly in place.
    *   A `console.log("====name",companyName);` statement was added after the `companyName` variable declaration, likely for debugging the company name value.

*   **11/17/2025, 10:42:10 AM:**
    *   **Company Name Case Handling Change:** The logic for determining `companyName` from `req.query.CompanyName` was modified. It now converts the decoded query parameter to `toUpperCase().trim()` instead of `toLowerCase().trim()`. The fallback from `req.user?.companyname` still uses `toLowerCase().trim()`. This change suggests an adjustment in how company names are matched or stored in the database (e.g., if the `account_name` in `v2_notification_log` is stored in uppercase).

**Patterns and Recurring Elements:**

*   **Focus on `getNotificationDetails`:** All changes are concentrated in this single function, indicating it's a critical or frequently modified part of the application.
*   **SQL `IN ()` Clause Safety:** A significant recurring theme is the introduction, removal, and re-introduction of a fix to prevent SQL errors when a dynamic list of `field_id` values might be empty for the `IN` clause. This highlights a robustification effort for database queries.
*   **Debugging Statements:** The repeated addition and removal of `console.log` statements for variables like `pageSize`, `usercode`, and `companyName` suggest an iterative debugging process.
*   **Company Name Handling:** Adjustments to how the `companyName` is derived and its case (specifically the change from `toLowerCase()` to `toUpperCase()` for the query parameter) indicate ongoing refinement of data processing and consistency with database schemas.
*   **Timestamp Proximity:** The rapid sequence of changes (all within less than an hour on the same day) points to an intense, focused session of development and testing for this particular service.

## 11:54:53 AM
The `cng-batches/config/config.js` file, timestamped 11/17/2025, 10:56:35 AM, defines application configurations for both `development` and `production` environments, with the active configuration determined by an `environment` variable.

Key updates and differences between environments include:

*   **Database Settings**: Distinct database credentials, user accounts, hostnames, and database names are configured for development (local PostgreSQL instance named `Rida_Database`) and production (an AWS RDS instance named `insproject`).
*   **File Paths**: A comprehensive list of file system paths for various operations (e.g., XML, Excel, CSV handling, and archives) is defined. These paths show a clear distinction, with `development` using Windows-style local drive paths (`D:/Files`, `D:/Office`) and `production` utilizing Linux-style server paths (`/home/node/batches`, `/var/efs`). Specifically, `googleTokenPath` also differs across environments.
*   **Email Configuration**: While the email service, sender's user, and sending password (for `cr@transmodalscoreboard.com`) remain consistent, the recipient lists for various reports and notifications (e.g., `all`, `office`, `execptionMailList`, `isfTeam`, `isf24HrReport`, `isfNotMatchReport`, `doBatchReport`, `openFileEmail`, `air_data_pulling_failure`) are significantly different. The `development` environment lists primarily include specific personal email addresses for testing, whereas `production` features a much broader and more formal distribution list of Transmodal employees.
*   **SFTP Private Key Path**: The path to the SFTP private key (`privateKey`) differs between environments, reflecting the respective operating system file structures.
*   **T360 Credentials**: The `username` and associated `password` for the `t360` service are distinct for development and production, while the `baseUrl` remains `http://localhost:8080` in both.

**Configurations that remain consistent across both environments include:**

*   **`cngIntegration`**: Settings for an OTM integration service, including the username, password, and `sentXmlUrl`, are identical.
*   **`sftpConfig7501`**: Host, port, username, and password for `ftp.iesltd.com` are the same for both development and production.
*   **`t360Url`**: The URL `https://transmodal360.com/app/admin_master/registered_users` is constant.
*   **`alc_7501_xml_validation` and `alcTolerance`**: These specific settings are identical.
*   **`mtr_air_config`**: The `schema` is set to `public` in both environments.

The overall pattern indicates a well-defined separation of configuration for development and production, essential for managing different operational contexts, local testing versus live deployment, and varying security and distribution requirements.

## 12:07:36 PM
The primary changes observed across these log entries are concentrated within the `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\notificationService.ts` file, occurring in rapid succession on **11/17/2025** at **11:10:32 AM**, **11:11:16 AM**, and **11:11:29 AM**.

**File-Specific Updates (notificationService.ts):**

The `getNotificationDetails` function underwent a series of modifications concerning how the `companyName` variable is derived:

1.  **Initial State (11:10:32 AM):** The `companyName` was consistently sourced from `req?.user?.companyname?.toLowerCase()`.
2.  **First Revision (11:11:16 AM):** The logic was updated to first attempt retrieving `companyName` from `req.query.CompanyName`. If present, it would be `decodeURIComponent`, converted to `toUpperCase()`, and trimmed. As a fallback, it would use `req?.user?.companyname?.to().trim()`, which contained a likely typo (`.to()` instead of `.toLowerCase()` or `.toUpperCase()`).
3.  **Second Revision (11:11:29 AM):** This revision corrected the typo in the fallback logic, changing `.to()` to `.toLowerCase()`. Additionally, the processing of `req.query.CompanyName` was changed from `toUpperCase()` to `toLowerCase()`, ensuring that `companyName` is consistently handled in lowercase regardless of its source (query parameter or user object).

**Patterns and Recurring Elements:**

*   **Consistent File Focus:** All logged changes are confined to the `notificationService.ts` file, indicating focused development or debugging efforts on notification-related logic.
*   **Rapid Iteration:** The very close timestamps (within seconds) suggest quick iterations to refine a specific piece of logic, likely the `companyName` extraction and standardization.
*   **Standard Project Utilities:** The code consistently utilizes common utilities like `HttpStatusCodes` for response statuses, `query` for database interactions, `logger` for logging information and errors, and `formatDate`/`timeAgo` for date manipulation.
*   **Robust Error Handling and Logging:** Both `getNotificationDetails` and `getRecentUpdateDetails` functions employ `try...catch` blocks for error management and log various stages of execution (API calls, SQL queries, row counts) and errors, promoting maintainability and debugging.
*   **Database Interaction:** Both functions perform complex SQL queries, fetching data from `public.v2_user_details`, `public.v2_notification_log`, and `shipment_tracking_message` tables.
*   **Data Transformation and Merging:** Notifications are retrieved from multiple sources (audit logs and messages), enhanced with descriptions and time calculations, and then merged and sorted before being paginated and sent as a response.
*   **Status Mapping:** A `StatusMap` object is used consistently to translate internal `field_id` values into more user-friendly status descriptions, which is then used to construct notification messages.
*   **Pagination:** Both notification retrieval functions respect a `pageSize` parameter for limiting the number of returned results.

## 5:01:12 PM
The `jsonAnchor.js` module underwent significant changes throughout the day on 11/17/2025, primarily focused on modifying its `fetchData` method's SQL query to retrieve different sets of data.

**File: `modules\anchor\jsonAnchor.js`**

*   **Initial Query (11/17/2025, 2:21:54 PM):** The `fetchData` method initially retrieved distinct booking, cargo, and container details (`agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, `pkg_type`, `chargeable_wt`, `total_cbm`) by joining `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container`. The `WHERE` clause was dynamic but initially empty.
*   **Shift to Tracking Data (11/17/2025, 2:49:47 PM):** The SQL query was substantially revamped to focus on shipment tracking data. It began joining `mtr_tracking_data` (aliased as `m`) instead of `agent_booking_cargolist` and selected numerous new fields related to shipment status, master bill of lading, SCAC codes, various rail/vessel dates, terminal information, and release dates. The `WHERE` clause remained empty at this point.
*   **Query Refinements and Aliases (11/17/2025, 4:12:09 PM):** The `SELECT` statement was further refined, adding aliases for many date and status fields (e.g., `departure_date as etd`, `t49_terminal_name as terminal_name`, `isf_status as isf`, `freight_release_date as fda_release_date`). `customs_release_date` and `custom_release_status` were added, while `customer_code` and `account_name` were removed from the selection.
*   **Introduction of Filtering (11/17/2025, 4:15:02 PM):** Conditions were introduced into the `whereClauses` array, specifically `m.shipment_completed <> 'No'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`, to filter the results.
*   **Repeated `shipment_completed` Condition Toggling (11/17/2025, 4:15 PM - 4:18 PM):** Over a short period, the condition for `m.shipment_completed` was repeatedly changed between `'<> 'No'`, `'<> 'Yes'`, and `'= 'Yes'`, suggesting active testing or debugging of the shipment completion status logic.
*   **Join Order and Type Revisions (11/17/2025, 4:33:11 PM - 4:35:58 PM):** The SQL query's `JOIN` types and primary `FROM` table were adjusted multiple times. It switched from `JOIN` to `LEFT JOIN`, with the `FROM` clause alternating between `agent_booking_entry e` and `mtr_tracking_data m` as the starting point, before settling on `mtr_tracking_data m LEFT JOIN agent_booking_entry e`. This indicates an iterative process to correctly link booking and tracking data, possibly to ensure all tracking data is included even if no matching booking entry exists.
*   **Query Override for Testing (11/17/2025, 4:57:56 PM):** A significant change occurred when the `fetchData` method's execution was modified to run a simpler, hardcoded SQL query: `select * from t49_tracking_details`. This suggests a temporary override for testing a specific table or simplifying data retrieval, effectively bypassing the complex joins and WHERE clauses previously developed.

**File: `scripts\run.AnchorJsonData.js`**

*   **Batch Execution Script (11/17/2025, 2:23:35 PM):** This file, responsible for executing the `AnchorJsonData` batch, remained functionally stable. It configures a logger, imports `jsonAnchor.js`, and orchestrates the `fetchData` call within an asynchronous function. It consistently logs the batch start and end times, and the total execution duration.

**Patterns and Recurring Elements:**

*   **Iterative SQL Query Development:** The `jsonAnchor.js` file demonstrates a strong pattern of iterative refinement of its SQL query within the `fetchData` method, moving from basic data selection to complex joins, extensive field selection, dynamic `WHERE` clauses, and changes in join types. This indicates an ongoing development process to pinpoint the exact data required.
*   **Focus on `mtr_tracking_data`:** After the initial version, the core focus of the `jsonAnchor.js` module shifted decisively towards fetching and filtering data from the `mtr_tracking_data` table.
*   **Logging for Visibility:** Both files consistently utilize logging (using a `logger` object and `console.log`) to track execution flow, fetched data, and potential errors, highlighting a strong emphasis on operational monitoring and debugging.
*   **Dynamic `WHERE` Clause:** The pattern of building the `WHERE` clause dynamically using `whereClauses.push()` is consistent in `jsonAnchor.js` after its introduction, allowing for flexible filtering logic.