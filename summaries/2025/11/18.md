# Activity Summary for 11/18/2025

## 9:32:08 AM
The changes primarily focus on two files: `modules\anchor\jsonAnchor.js` and `scripts\run.AnchorJsonData.js`, with one log entry for a JSON sample file. All modifications occurred on 11/17/2025, indicating a concentrated development effort.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`

This file, which defines an `AnchorJsonData` class responsible for fetching data from a database, underwent continuous and significant evolution throughout the day.

*   **Initial Query (2:21 PM):** The `fetchData` method began with a basic SQL query joining `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container`. It selected fields like `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, and `total_cbm`.
*   **Major Query Refactor (2:49 PM - 4:12 PM):** The SQL query was substantially revamped. The `agent_booking_cargolist` table was removed, and `mtr_tracking_data` was introduced and joined with `agent_booking_entry`. The `SELECT` clause was expanded to include a wide array of new fields from `agent_booking_entry` (e.g., `bookingno`, `isf_status`, `mblno`, `blno`) and `mtr_tracking_data` (e.g., `shipment_completed`, `scac_code`, various dates like `rail_ata`, `delivery_customer_date`, `pol`, `pod`, terminal information, `customs_release_date`, `po_no`, `account_name`). Many columns were aliased for clarity in the output (e.g., `departure_date as etd`).
*   **Adding Filtering Conditions (4:15 PM):** Filtering conditions were introduced to the `WHERE` clause: `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`. There was a brief period of toggling the `shipment_completed` condition between `'No'`, `'Yes'`, and `='Yes'` (4:15 PM - 4:18 PM), suggesting active testing or debugging of this filter.
*   **`DISTINCT` Keyword Toggling (4:24 PM):** The `DISTINCT` keyword was briefly removed and then re-added to the `SELECT` statement.
*   **Join Type and Primary Table Changes (4:33 PM - 4:35 PM):** The SQL query's structure around `FROM` and `JOIN` clauses saw changes, experimenting with `mtr_tracking_data` as the primary table with `LEFT JOIN`s, then reverting, and finally settling on `mtr_tracking_data m LEFT JOIN agent_booking_entry e`.
*   **Introducing `t49_tracking_details` and Iterative Processing (4:57 PM - 5:14 PM):**
    *   A new SQL query (`select * from t49_tracking_details`) was added and used to fetch data, initially overshadowing the main `getQuery`.
    *   The fetched data (`rows:data`) began to be processed in a loop, attempting to construct a `containerDetails` array with "Empty Out" events. A potential bug was introduced where `return result;` was inside the loop, causing the function to exit after the first iteration. This loop and `result` variable were later removed.
    *   The `t49_tracking_details` table was then explicitly `LEFT JOIN`ed with `mtr_tracking_data` in `sqlQuery`.
*   **Major Output Restructuring and Unified Query (5:18 PM):** The `fetchData` method underwent a significant refactor:
    *   A single, comprehensive SQL query (`sql`) was established, joining `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details`. It included selecting various container milestone timestamps (e.g., `empty_out_at`, `loaded_return AS full_in`, `vessel_loaded`, `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in`).
    *   The raw query results (`rows`) were then transformed into a structured `shipmentMap` object, grouping related containers and their milestones under each `bookingno`. This correctly returned the aggregated data outside the loop.
*   **Refinement of Joins and Milestones (5:19 PM - 6:56 PM):**
    *   The `agent_booking_container` join was removed, and `m.contno` was used directly for `container_number`.
    *   Specific milestone fields in the `SELECT` query were adjusted, and `m.t49_contno_out_gated` was added to the selection.
    *   The mapping of milestone events to database columns in the output structure was refined, using `r.atd` for "Vessel Departed" and `r.ata` for "Vessel Arrived", and `r.t49_contno_out_gated` for "Full Out". The "Empty In" milestone was initially removed from the `SELECT` list, then still pushed in the output structure (implicitly `undefined`), then eventually explicitly removed from the output structure.
    *   `COALESCE` functions were introduced for `atd` and `ata` to provide fallback values from `m.vessel_actualdeparted_date` and `m.vessel_actualarrived_date` respectively. `eta` was specifically mapped to `m.t49_eta`.
    *   A unique grouping key `r.bookingno || r.mblno` was introduced for the `shipmentMap` to handle potential null `bookingno` values, with a minor bug introduced and quickly corrected regarding `shipmentMap[r.key]`.
*   **Logging:** Numerous `console.log` statements were added, removed, or commented out for debugging the SQL queries and their results.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`

This script is responsible for executing the `AnchorJsonData` batch.

*   **Batch Execution Setup (2:23 PM):** It was established to load environment variables, create a logger, and use `moment` for timestamping. It initialized the `AnchorJsonData` class, called its `fetchData` method, and logged batch start/end and total execution time.
*   **Output Logging Changes (5:21 PM - 6:56 PM):** The script frequently changed how the `fetchData` result (`res`) was logged to the console. This included toggling between `console.log(res, "res==data")`, `logger.info(json data, JSON.stringify(res))`, and pretty-printing the JSON output using `JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`, often commenting out one form of output logging in favor of another.

### File: `c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`

*   **Sample Payload (6:33 PM):** This file contains a sample JSON structure representing two shipment records. Each record includes comprehensive details about the shipment (booking, MBL, dates, locations, customs, PO numbers) and nested container objects, each with its own list of milestones (event and timestamp). This JSON structure appears to be the target output format the `jsonAnchor.js` module was being developed to produce.

### Patterns and Recurring Elements:

*   **Iterative Development and Debugging:** The rapid sequence of changes, especially within `jsonAnchor.js`, and the frequent addition/removal of `console.log` statements, demonstrate an iterative development and debugging process aimed at refining the data fetching and transformation logic.
*   **SQL Query Complexity:** The SQL query in `jsonAnchor.js` progressively became more complex, incorporating more tables, columns, aliases, and `COALESCE` functions to handle data retrieval.
*   **Structured JSON Output:** A consistent goal was to produce a highly structured JSON output, grouping container milestones under their respective shipments, as evidenced by the `shipmentMap` logic and the provided sample JSON payload.
*   **Date/Time Handling:** The reliance on `moment.js` in the `run.AnchorJsonData.js` script and the extensive selection of date/timestamp fields in `jsonAnchor.js` highlight the importance of time-related data in the application.
*   **Specific Business Logic:** The filters `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'` indicate that this batch processing is tailored for specific "ANCHOR INGREDIENTS CO." shipments that are marked as "completed".