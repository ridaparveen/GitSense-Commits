# Activity Summary for 11/18/2025

## 9:32:08 AM
The changes primarily focus on two files: `modules\anchor\jsonAnchor.js` and `scripts\run.AnchorJsonData.js`, with one log entry for a JSON sample file. All modifications occurred on 11/17/2025, indicating a concentrated development effort.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`

This file, which defines an `AnchorJsonData` class responsible for fetching data from a database, underwent continuous and significant evolution throughout the day.

*   **Initial Query (2:21 PM):** The `fetchData` method began with a basic SQL query joining `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container`. It selected fields like `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, and `total_cbm`.
*   **Major Query Refactor (2:49 PM - 4:12 PM):** The SQL query was substantially revamped. The `agent_booking_cargolist` table was removed, and `mtr_tracking_data` was introduced and joined with `agent_booking_entry`. The `SELECT` clause was expanded to include a wide array of new fields from `agent_booking_entry` (e.g., `bookingno`, `isf_status`, `mblno`, `blno`) and `mtr_tracking_data` (e.g., `shipment_completed`, `scac_code`, various dates like `rail_ata`, `delivery_customer_date`, `pol`, `pod`, terminal information, `customs_release_date`, `po_no`, `account_name`). Many columns were aliased for clarity in the output (e.g., `departure_date as etd`).
*   **Adding Filtering Conditions (4:15 PM):** Filtering conditions were introduced to the `WHERE` clause: `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`. There was a brief period of toggling the `shipment_completed` condition between `'No'`, `'Yes'`, and `='Yes'` (4:15 PM - 4:18 PM), suggesting active testing or debugging of this filter.
*   **`DISTINCT` Keyword Toggling (4:24 PM):** The `DISTINCT` keyword was briefly removed and then re-added to the `SELECT` statement.
*   **Join Type and Primary Table Changes (4:33 PM - 4:35 PM):** The SQL query's structure around `FROM` and `JOIN` clauses saw changes, experimenting with `mtr_tracking_data` as the primary table with `LEFT JOIN`s, then reverting, and finally settling on `mtr_tracking_data m LEFT JOIN agent_booking_entry e`.
*   **Introducing `t49_tracking_details` and Iterative Processing (4:57 PM - 5:14 PM):**
    *   A new SQL query (`select * from t49_tracking_details`) was added and used to fetch data, initially overshadowing the main `getQuery`.
    *   The fetched data (`rows:data`) began to be processed in a loop, attempting to construct a `containerDetails` array with "Empty Out" events. A potential bug was introduced where `return result;` was inside the loop, causing the function to exit after the first iteration. This loop and `result` variable were later removed.
    *   The `t49_tracking_details` table was then explicitly `LEFT JOIN`ed with `mtr_tracking_data` in `sqlQuery`.
*   **Major Output Restructuring and Unified Query (5:18 PM):** The `fetchData` method underwent a significant refactor:
    *   A single, comprehensive SQL query (`sql`) was established, joining `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details`. It included selecting various container milestone timestamps (e.g., `empty_out_at`, `loaded_return AS full_in`, `vessel_loaded`, `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in`).
    *   The raw query results (`rows`) were then transformed into a structured `shipmentMap` object, grouping related containers and their milestones under each `bookingno`. This correctly returned the aggregated data outside the loop.
*   **Refinement of Joins and Milestones (5:19 PM - 6:56 PM):**
    *   The `agent_booking_container` join was removed, and `m.contno` was used directly for `container_number`.
    *   Specific milestone fields in the `SELECT` query were adjusted, and `m.t49_contno_out_gated` was added to the selection.
    *   The mapping of milestone events to database columns in the output structure was refined, using `r.atd` for "Vessel Departed" and `r.ata` for "Vessel Arrived", and `r.t49_contno_out_gated` for "Full Out". The "Empty In" milestone was initially removed from the `SELECT` list, then still pushed in the output structure (implicitly `undefined`), then eventually explicitly removed from the output structure.
    *   `COALESCE` functions were introduced for `atd` and `ata` to provide fallback values from `m.vessel_actualdeparted_date` and `m.vessel_actualarrived_date` respectively. `eta` was specifically mapped to `m.t49_eta`.
    *   A unique grouping key `r.bookingno || r.mblno` was introduced for the `shipmentMap` to handle potential null `bookingno` values, with a minor bug introduced and quickly corrected regarding `shipmentMap[r.key]`.
*   **Logging:** Numerous `console.log` statements were added, removed, or commented out for debugging the SQL queries and their results.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`

This script is responsible for executing the `AnchorJsonData` batch.

*   **Batch Execution Setup (2:23 PM):** It was established to load environment variables, create a logger, and use `moment` for timestamping. It initialized the `AnchorJsonData` class, called its `fetchData` method, and logged batch start/end and total execution time.
*   **Output Logging Changes (5:21 PM - 6:56 PM):** The script frequently changed how the `fetchData` result (`res`) was logged to the console. This included toggling between `console.log(res, "res==data")`, `logger.info(json data, JSON.stringify(res))`, and pretty-printing the JSON output using `JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`, often commenting out one form of output logging in favor of another.

### File: `c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`

*   **Sample Payload (6:33 PM):** This file contains a sample JSON structure representing two shipment records. Each record includes comprehensive details about the shipment (booking, MBL, dates, locations, customs, PO numbers) and nested container objects, each with its own list of milestones (event and timestamp). This JSON structure appears to be the target output format the `jsonAnchor.js` module was being developed to produce.

### Patterns and Recurring Elements:

*   **Iterative Development and Debugging:** The rapid sequence of changes, especially within `jsonAnchor.js`, and the frequent addition/removal of `console.log` statements, demonstrate an iterative development and debugging process aimed at refining the data fetching and transformation logic.
*   **SQL Query Complexity:** The SQL query in `jsonAnchor.js` progressively became more complex, incorporating more tables, columns, aliases, and `COALESCE` functions to handle data retrieval.
*   **Structured JSON Output:** A consistent goal was to produce a highly structured JSON output, grouping container milestones under their respective shipments, as evidenced by the `shipmentMap` logic and the provided sample JSON payload.
*   **Date/Time Handling:** The reliance on `moment.js` in the `run.AnchorJsonData.js` script and the extensive selection of date/timestamp fields in `jsonAnchor.js` highlight the importance of time-related data in the application.
*   **Specific Business Logic:** The filters `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'` indicate that this batch processing is tailored for specific "ANCHOR INGREDIENTS CO." shipments that are marked as "completed".

## 10:32:08 AM
The changes primarily revolve around a Node.js batch application designed to extract and transform shipment tracking data for "ANCHOR INGREDIENTS CO." into a structured JSON format.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`**: This file contains the core logic for fetching and processing data.
    *   **Initial Data Fetching (11/17/2025, 2:21 PM - 2:49 PM)**: The module `jsonAnchor.js` started with a `fetchData` method querying `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container` to retrieve basic booking and cargo details like `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, and `total_cbm`.
    *   **Shift to Shipment Tracking Data (11/17/2025, 2:49 PM)**: A significant overhaul of the SQL query occurred, replacing cargo-related tables with `mtr_tracking_data` and focusing on comprehensive shipment tracking details (e.g., `mblno`, `blno`, `scac_code`, various ETD/ETA/ATA dates, terminal info, customs release, `po_no`).
    *   **Introduction of Filtering (11/17/2025, 4:15 PM - 4:18 PM)**: The `fetchData` method was enhanced to include `WHERE` clauses to filter shipments. This involved repeated changes between `m.shipment_completed = 'Yes'` and `m.shipment_completed <> 'Yes'`, eventually settling on `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`, indicating a focus on completed shipments for a specific client.
    *   **Query Structure Refinement (11/17/2025, 4:33 PM - 4:35 PM)**: There were several adjustments to the SQL query's `FROM` clause and join types, alternating between starting the query from `agent_booking_entry` or `mtr_tracking_data` and consistently using `LEFT JOIN`.
    *   **Attempt at Milestone Processing (11/17/2025, 4:57 PM - 5:14 PM)**: An attempt was made to introduce a separate `sqlQuery` for `t49_tracking_details` and loop through its results. This initial implementation had logical flaws, such as re-initializing the result array within the loop.
    *   **Major Data Transformation Logic (11/17/2025, 5:18 PM)**: A substantial change consolidated the data fetching into a single complex SQL query. This query joined `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details` to select a wide array of shipment and container milestone data. Post-query processing was introduced to transform the flat database rows into a hierarchical JSON object, grouping containers and their milestones under each shipment.
    *   **Refinement of Container Joins and Milestones (11/17/2025, 5:19 PM - 6:56 PM)**: Further adjustments refined how container numbers were joined (`m.contno AS container_number` instead of `con.contno`) and which specific milestone fields (`t.empty_out_at`, `t.loaded_return AS full_in`, `t.vessel_loaded`, `m.t49_contno_out_gated`) were selected. Missing milestone timestamps in the output structure were corrected by either mapping to existing fields or removing events that were not retrieved. The SQL query was updated to use `COALESCE` for some date fields (e.g., `atd`, `ata`) to ensure data availability from multiple potential sources. A bug where containers were incorrectly assigned to shipments (`shipmentMap[r.key]`) was introduced and subsequently fixed. The "Empty In" milestone was ultimately removed from the output structure, aligning it with the SQL query.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`**: This file is a batch script responsible for executing the `jsonAnchor` module.
    *   **Basic Batch Execution (11/17/2025, 2:23 PM)**: Initial setup included loading environment variables, creating a logger, marking batch start/end times, calling `anchorJsonData.fetchData()`, and logging the raw result.
    *   **Logging Refinements (11/17/2025, 5:21 PM - 6:56 PM)**: Repeated modifications were made to how the fetched data was logged. This involved toggling between `console.log(res)`, `logger.info(JSON.stringify(res))`, and pretty-printing JSON output (`JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`), indicating active debugging and presentation considerations for the output.

*   **`c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`**: This JSON file (timestamp 11/17/2025, 6:33 PM) serves as an example of the structured output that the `jsonAnchor.js` module is designed to produce. It contains an array of shipment objects, each with detailed tracking information and a nested array of containers, each listing specific milestones with timestamps (e.g., Empty Out, Full In, Vessel Loaded). This demonstrates the desired hierarchical data format.

**Patterns and Recurring Elements:**

*   **Iterative Development and Debugging**: There's a clear pattern of incremental changes, particularly in `jsonAnchor.js`, where the SQL query and data transformation logic are progressively refined. Frequent commits modifying SQL joins, selected columns, and `WHERE` clauses, along with the insertion and removal of `console.log` statements in both files, highlight an active development and debugging process.
*   **Focus on Shipment Tracking**: The core purpose of the changes is to retrieve and structure detailed shipment and container tracking information, specifically for the "ANCHOR INGREDIENTS CO." account.
*   **Data Transformation from Flat to Hierarchical**: A key recurring theme is the effort to transform flat database query results into a more complex, nested JSON structure suitable for programmatic use or display, grouping container milestones under their respective shipments.
*   **Timestamp-Based Milestone Tracking**: The `milestione` array within containers, containing `event` and `timestamp` pairs, is a consistent element in the desired output structure, indicating a focus on tracking event chronology.
*   **Database Interaction**: Both `jsonAnchor.js` and `run.AnchorJsonData.js` consistently interact with a PostgreSQL database via a `pool` object, indicating a data-driven application.
*   **Error Handling**: The `fetchData` method in `jsonAnchor.js` consistently includes a `try-catch` block to handle potential database errors.

## 11:32:07 AM
The development log details a focused session on November 17, 2025, predominantly affecting two files within a `cng-batches` project related to `anchor` data processing. The core task appears to be extracting and structuring shipment tracking information from a database into a specific JSON format.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`**
    *   **Initial Query (2:21 PM)**: Started with a basic `fetchData` function querying `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container` for booking details, cargo pieces, and CBM.
    *   **Query Refinement (2:49 PM - 4:12 PM)**: The SQL query was significantly revamped to join `mtr_tracking_data` instead of `agent_booking_cargolist`, shifting focus to tracking data (MBL, BL, status, various dates like rail ATA, delivery, LFD, POL, POD, terminal info, customs, PO numbers, FDA release). Columns were aliased for clarity (e.g., `etd`, `eta`, `atd`).
    *   **Filtering Logic (4:15 PM - 4:18 PM)**: `whereClauses` were introduced to filter data based on `m.shipment_completed` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`. The `shipment_completed` condition was actively tested and toggled between `'No'`, `'Yes'`, and `<> 'Yes'` before settling on `m.shipment_completed = 'Yes'`.
    *   **Join Types and Order Changes (4:33 PM - 4:35 PM)**: There were several rapid changes in the `FROM` clause and `JOIN` types (from `JOIN` to `LEFT JOIN`) and the order of tables, indicating experimentation with how the tables should be related (`mtr_tracking_data` or `agent_booking_entry` as primary).
    *   **Temporary Query Change (4:57 PM)**: A brief diversion occurred where the `fetchData` function temporarily switched to an independent `SELECT * FROM t49_tracking_details` query, discarding the main complex query.
    *   **Comprehensive Query and Data Transformation (5:12 PM - 5:18 PM)**: A major refactor combined the various data sources into a single, complex `LEFT JOIN` SQL query. This new query (`sql`) targeted `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details` to select a broad range of shipment details and container-specific milestones. Post-query processing was introduced to map flat results into a hierarchical JSON structure, grouping by `bookingno` and nesting `containers` with `milestone` events.
    *   **Container and Milestone Refinement (5:19 PM - 6:56 PM)**:
        *   The `agent_booking_container` join was removed, and `container_number` was sourced from `m.contno`.
        *   Milestone events were meticulously mapped to specific database columns (e.g., `Vessel Departed` to `r.atd`, `Full Out` to `r.t49_contno_out_gated`).
        *   The `SELECT` clause for `atd` and `ata` was enhanced with `COALESCE` to handle potentially missing data by falling back to alternative date columns (`m.vessel_actualdeparted_date`, `m.vessel_actualarrived_date`).
        *   A unique grouping `key` (`r.bookingno || r.mblno`) was introduced for robustness, and a bug in its application for container pushing was swiftly corrected.
        *   The `Empty In` milestone was removed from the output structure.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`**
    *   **Batch Script Initialization (2:23 PM)**: A script was set up to run the `fetchData` function from `jsonAnchor.js`, including logger setup and batch timing.
    *   **Console Logging for Debugging (5:21 PM - 6:56 PM)**: There were frequent adjustments to how the `fetchData` result was logged to the console, oscillating between simple `console.log(res)`, `JSON.stringify(res)`, and `JSON.stringify(res, null, 2)` (pretty-printed JSON) to aid in debugging and reviewing the structured output.

*   **`c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`**
    *   **Example Output (6:33 PM)**: This file represents the desired final JSON output structure, containing an array of shipment objects, each with detailed booking, tracking, and nested container-specific milestone data. It serves as a reference for the `jsonAnchor.js` output transformation.

**Patterns and Recurring Elements:**

*   **Iterative SQL Development**: The `jsonAnchor.js` file shows a clear pattern of continuous refinement of a single, complex SQL query over many commits, indicating an effort to precisely select and join multiple database tables.
*   **Data Restructuring Focus**: A dominant theme is the transformation of relational database query results into a structured, hierarchical JSON format, grouping shipments and nesting container-specific milestones. This pattern is implemented and refined in the Node.js code after the database query.
*   **Debugging-Driven Changes**: Frequent additions, modifications, and removals of `console.log` statements across both `.js` files highlight an active debugging process to inspect both the raw query results and the transformed JSON output.
*   **Consistent Project/Client Context**: The presence of "ANCHOR INGREDIENTS CO." in the SQL `WHERE` clauses and "Anchor_Ingedients_Shipmnet_Payload" in the JSON filename indicates a specific client or project for which this data processing is being developed.
*   **Logger Integration**: The `run.AnchorJsonData.js` script consistently uses a custom logger (`createLogger`) for batch status and timing, which is a common practice in batch processing applications.
*   **Single-Day Development**: All changes occurred on the same day (November 17, 2025), suggesting a concentrated development effort.

## 3:44:52 PM
The log details changes across three primary files: `jsonAnchor.js`, `run.AnchorJsonData.js`, and one JSON file. The timeline of these changes spans November 17-18, 2025, showing a progressive development and refinement of a data fetching and SFTP upload process.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`**:
    *   **Initial Development (11/17/2025, 2:21 PM - 4:12 PM):** The file starts with a basic `fetchData` method, querying `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container`. The `SELECT` clause initially fetches booking, POL/POD codes, PO number, pieces, package type, and CBM. Over several commits, the `SELECT` statement undergoes significant expansion.
    *   **Query Expansion and Refinement (11/17/2025, 2:49 PM - 4:12 PM):** The SQL query is drastically changed to join `mtr_tracking_data` and select a much broader set of fields related to shipment tracking, master bill of lading (MBL) details, SCAC code, various dates (ETD, ETA, ATD, ATA, rail dates, delivery dates, LFD, demurrage), terminal information, customs and freight release dates, ISF status, PO numbers, and customer details. The join conditions are also updated to primarily use `m.mblno = e.mblno`.
    *   **Adding Filtering Conditions (11/17/2025, 4:15 PM - 4:18 PM):** `WHERE` clauses are introduced to filter data where `m.shipment_completed` is either not 'No' (later changed to not 'Yes', then 'Yes') and `m.account_name` is 'ANCHOR INGREDIENTS CO.'. There's an oscillation in the `shipment_completed` condition between `'Yes'` and `NOT 'Yes'`.
    *   **Refining Query and Joins (11/17/2025, 4:24 PM - 4:35 PM):** The `DISTINCT` keyword is temporarily removed from the `SELECT` clause (4:24 PM) and then re-added (4:24 PM). The `JOIN` types for `mtr_tracking_data` and `agent_booking_entry` are changed from `JOIN` to `LEFT JOIN` (4:33 PM, 4:35 PM), and the primary table in the `FROM` clause is switched between `agent_booking_entry` and `mtr_tracking_data`.
    *   **Milestone Integration Attempt (11/17/2025, 4:57 PM - 5:14 PM):** There's an attempt to fetch data from `t49_tracking_details` via a separate `sqlQuery` and then iterate over it to extract container milestone details, such as "Empty Out" timestamps. This initial attempt seems incomplete and potentially buggy (e.g., `for(rows of data)` followed by `const result = []`). It leads to confusion by having two distinct queries.
    *   **Consolidated Query and Data Structuring (11/17/2025, 5:18 PM - 5:19 PM):** The `fetchData` method is significantly refactored. A single, complex SQL query is introduced using `LEFT JOIN` with `t49_tracking_details` to directly pull container milestones (`empty_out_at`, `loaded_return` as `full_in`, `vessel_loaded`, etc.). The JavaScript code then processes the flat SQL result into a hierarchical JSON structure, grouping shipments by `booking_no` and nesting container details with their milestones. The `agent_booking_container` join is removed, and `m.contno` is used for container number and joining with `t49_tracking_details`.
    *   **Query Refinement and Milestone Mapping (11/17/2025, 5:19 PM - 6:56 PM):** The `SELECT` statement for milestones is slightly adjusted (e.g., `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in` are removed from the direct select and then added back using derived values or existing columns like `m.atd` and `m.ata` for vessel departure/arrival). A `t49_contno_out_gated` field is added to the SQL query to represent the "Full Out" milestone. The `eta` and `atd` fields in the `SELECT` statement are updated to use `COALESCE` with `t49_vessel_actualdeparted_date`/`vessel_actualdeparted_date` and `t49_vessel_actualarrived_date`/`vessel_actualarrived_date` respectively, and `m.t49_eta` for `eta`. The logic for grouping containers ensures unique shipments are formed (`shipmentMap[key]`) and containers are pushed to the correct shipment. A bug is fixed where `shipmentMap[r.key]` was used instead of `shipmentMap[key]` when adding containers.
    *   **SFTP Integration and File Generation (11/18/2025, 1:43 PM - 2:02 PM):** The `AnchorJsonData` class is extended with new responsibilities.
        *   It now includes a `moveAnchorJsonFileToSftp` method which orchestrates the entire process: fetching data (`fetchAnchorJsonData`), connecting to an SFTP server, generating JSON files locally in a `temp/anchor-json` directory, uploading these files to a remote `/anchor/` directory on the SFTP server, and then cleaning up the local temporary files.
        *   New dependencies `fs`, `path`, `config`, `Client` (from `ssh2-sftp-client`), `moveFiles`, and `gmail` are imported.
        *   Error handling for SFTP operations is added, including sending email notifications via `gmailSender.utils`.
        *   The `connect` method is extracted to handle SFTP connection logic, explicitly logging the SFTP configuration and potential connection failures. It also switches `config.sftpConfig` to `config.sftpConfig7501` at 2:02 PM, indicating a change in the target SFTP configuration.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`**:
    *   **Batch Execution Script (11/17/2025, 2:23 PM):** This script is responsible for running the data fetching batch. It initializes a logger, records start/end times, calls `anchorJsonData.fetchData()`, and logs the results.
    *   **Logging and Output Changes (11/17/2025, 5:21 PM - 5:23 PM):** The script's output logging is modified, initially adding `logger.info('json data',JSON.stringify(res))` (5:21 PM), then removing it (5:21 PM), and finally refining how `res` is logged to the console using `JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)` for pretty-printing.
    *   **Invoking SFTP Upload (11/18/2025, 1:53 PM):** The script's core execution is changed from calling `anchorJsonData.fetchData()` to `anchorJsonData.moveAnchorJsonFileToSftp()`, reflecting the new functionality of the `jsonAnchor.js` module. The `console.log(res)` statements might become less relevant since `moveAnchorJsonFileToSftp` doesn't directly return the processed data but handles the file operations internally.

*   **`c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`**:
    *   **Sample Data (11/17/2025, 6:33 PM):** This file appears to be a sample of the desired JSON output structure, containing two shipment records with detailed booking, MBL, tracking, and container milestone information. This likely served as a reference for the `jsonAnchor.js` module's data structuring logic.

**Timestamps of Significant Changes:**

*   **11/17/2025, 2:49 PM:** Major SQL query overhaul in `jsonAnchor.js` to fetch expanded tracking data.
*   **11/17/2025, 4:15 PM:** Introduction of specific `WHERE` clauses for `shipment_completed` and `account_name` in `jsonAnchor.js`.
*   **11/17/2025, 5:18 PM:** Major refactoring in `jsonAnchor.js` to consolidate SQL queries and transform flat results into a nested JSON structure with container milestones.
*   **11/18/2025, 1:43 PM:** `jsonAnchor.js` is transformed to include SFTP connection, local file generation, and upload logic, moving beyond just data fetching.
*   **11/18/2025, 1:53 PM:** `run.AnchorJsonData.js` is updated to call the new SFTP upload method.
*   **11/18/2025, 1:53 PM & 1:54 PM:** `gmailSender.utils` is integrated into `jsonAnchor.js` for error notifications, then commented out.
*   **11/18/2025, 2:02 PM:** Change in SFTP configuration object used for connection in `jsonAnchor.js` (`config.sftpConfig` to `config.sftpConfig7501`).

**Patterns and Recurring Elements:**

*   **Iterative Query Refinement:** The SQL query in `jsonAnchor.js` (within the `fetchData` or `fetchAnchorJsonData` method) is continually expanded and refined. This includes adding new `SELECT` fields, changing `JOIN` types, and adjusting `WHERE` clauses.
*   **Data Transformation:** There's a consistent pattern of fetching flat relational data from the database and then transforming it into a more structured, nested JSON object, especially for grouping containers and their milestones under a shipment.
*   **Logging:** The use of `logger.info` and `console.log` is prevalent across both JavaScript files for debugging and tracing execution flow.
*   **Error Handling:** `try...catch` blocks are consistently used in asynchronous functions to catch and propagate errors, often including logging the error message.
*   **SFTP Integration:** The latter part of the log shows a clear focus on integrating SFTP functionality, including connecting, uploading files, and handling related errors.
*   **Hardcoded Account Name:** The `m.account_name = 'ANCHOR INGREDIENTS CO.'` condition remains constant throughout the evolution of the SQL query, indicating a specific client or context for this batch process.
*   **Milestone Event Mapping:** The list of milestone events (Empty Out, Full In, Vessel Loaded, Vessel Departed, Vessel Arrived, Full Out, Empty In) and their corresponding timestamp fields from the database is a recurring structure in the data transformation logic.
*   **Temporary File Generation:** The pattern of generating temporary JSON files locally before uploading them via SFTP and then deleting them is established in the later stages.

## 4:44:58 PM
The changes primarily revolve around two files: `modules/anchor/jsonAnchor.js` and `scripts/run.AnchorJsonData.js`, with one log entry for `config/config.js` and one for `modules/isf/sendISF24hReport.js`, and one non-code file `Anchor_Ingedients_Shipmnet_Payload (1).json`.

**File-Specific Updates:**

**`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js` (Most Frequent Changes, spanning 11/17/2025, 2:21:54 PM to 11/18/2025, 4:42:07 PM):**

*   **Initial State (11/17/2025, 2:21:54 PM - 2:21:59 PM):** The file defines `AnchorJsonData` class with a `fetchData` method to query `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container` tables. The initial SELECT statement retrieves basic booking, location, cargo, and CBM details.
*   **Major Query Refactor (11/17/2025, 2:49:47 PM):** The SQL query within `fetchData` is significantly changed. It now joins `agent_booking_entry` with `mtr_tracking_data` and `agent_booking_container`, selecting a much wider range of fields related to tracking (e.g., `isf_status`, `mblno`, `blno`, `shipment_completed`, various dates, terminal info, customs release, PO number, customer code, account name). The previous cargo-related fields are removed.
*   **Further Query Refinement and Aliases (11/17/2025, 4:12:09 PM):** The SELECT statement is further refined, introducing aliases for various date fields (`etd`, `eta`, `atd`, `ata`), and terminal information. It also includes `customs_release_date`, `custom_release_status`, `isf_status`, `po_no`, and `fda_release_date`.
*   **Adding WHERE Clauses (11/17/2025, 4:15:02 PM - 4:18:55 PM):** Conditional filtering is introduced in the `fetchData` method. `whereClauses` are added to filter results where `m.shipment_completed <> 'No'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`. This condition is then toggled between `m.shipment_completed <> 'Yes'` and `m.shipment_completed = 'Yes'` several times, indicating testing or refinement of the desired data set.
*   **Removal of `DISTINCT` keyword (11/17/2025, 4:24:04 PM):** The `DISTINCT` keyword is temporarily removed from the main SQL query, then re-added shortly after (11/17/2025, 4:24:15 PM).
*   **Change in JOIN order (11/17/2025, 4:33:11 PM):** The main SQL query's JOIN order is reversed, starting with `mtr_tracking_data` and using `LEFT JOIN` for `agent_booking_entry` and `agent_booking_container`. This change is then reverted back to `agent_booking_entry` as the main table (11/17/2025, 4:35:17 PM), and then back to `mtr_tracking_data` as the main table (11/17/2025, 4:35:58 PM).
*   **Introduction of `sqlQuery` and Data Processing Loop (11/17/2025, 4:57:29 PM - 5:14:24 PM):** A new `sqlQuery = select * from t49_tracking_details;` is added. Initially, `getQuery` results are used, then `sqlQuery` results are used for processing. A loop is introduced to iterate over `data` (results from `sqlQuery`), aiming to build `containerDetails` with "Empty Out" events, but the `result` array is re-initialized inside the loop, leading to incorrect logic. The `sqlQuery` is then modified to include a `LEFT JOIN` with `mtr_tracking_data` on `container_number`. The `logger.info` for JSON stringify is toggled between `data` and `result`.
*   **Major Refactoring for Structured Output (11/17/2025, 5:18:17 PM):** The `fetchData` method undergoes a significant overhaul.
    *   The SQL query is consolidated into a single `sql` variable, joining `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details`.
    *   It now selects specific container milestone events directly from `t49_tracking_details` (e.g., `empty_out_at`, `loaded_return` as `full_in`, `vessel_loaded`, `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in`).
    *   A `shipmentMap` object is introduced to group results by `bookingno`, structuring the output into a hierarchical JSON where each shipment contains an array of containers, and each container has an array of milestones.
    *   The `agent_booking_container` join is removed and `m.contno` is used for `container_number` (11/17/2025, 5:19:26 PM).
    *   The number of milestone fields selected directly in the SQL is reduced (11/17/2025, 5:19:52 PM).
*   **Minor Adjustments to Milestone Mapping (11/17/2025, 6:36:14 PM):** Specific milestone timestamps are mapped to different SQL columns (e.g., `Vessel Departed` maps to `r.atd`, `Vessel Arrived` to `r.ata`, `Full Out` to `r.t49_contno_out_gated`). `console.log(rows, "===rows");` is added and later commented out.
*   **Database Query Refinement (11/17/2025, 6:50:59 PM):** `COALESCE` is introduced for `atd` (using `t49_vessel_actualdeparted_date` or `vessel_actualdeparted_date`) and `ata` (using `t49_vessel_actualarrived_date` or `vessel_actualarrived_date`), and `m.t49_eta` is explicitly selected for `eta`.
*   **Correction in `shipmentMap` Keying (11/17/2025, 6:54:39 PM - 6:55:35 PM):** The `shipmentMap` logic is updated to use `key` (which is `r.bookingno || r.mblno`) when pushing containers, rather than `r.bookingno` directly, ensuring containers are added to the correct shipment entry. The `Empty In` milestone is removed from the list (11/17/2025, 6:55:35 PM) and re-added later (11/18/2025, 3:50:47 PM).
*   **Major Feature: SFTP Upload (11/18/2025, 1:43:26 PM):**
    *   Imports for `config`, `ssh2-sftp-client`, `moveFiles`, and `gmailSender.utils` are added.
    *   A new asynchronous method `moveAnchorJsonFileToSftp` is introduced, becoming the main entry point for the batch process.
    *   This method now fetches data, connects to an SFTP server, uploads generated files (initially intended to be CSV, then JSON), and handles error logging/emailing.
    *   The `fetchData` method is renamed to `fetchAnchorJsonData`.
    *   Initial logic involved iterating `data` for `csv_path` and `csv_file_name` and an `updateAlcStatus` (likely a relic from a CSV batch), which is quickly refactored.
*   **JSON File Generation and SFTP Logic Refinement (11/18/2025, 1:46:54 PM - 1:51:10 PM):**
    *   The `moveAnchorJsonFileToSftp` method is refined to explicitly create temporary JSON files (`ANCHOR_booking_no_or_mbl_number.json`) in a `temp/anchor-json` directory.
    *   It then iterates through these generated files, uploads them to `/anchor/` on the SFTP server, and finally deletes the local temporary files.
    *   Imports for `fs` and `path` are added.
    *   The `milestione` key for containers is corrected to `milestone`.
*   **SFTP Configuration Updates (11/18/2025, 2:01:55 PM - 2:02:50 PM):** The `connect` method now logs the SFTP configuration and uses `config.sftpConfig7501` for connection, with added error handling for SFTP connection.
*   **Batch File Naming and Single File Output (11/18/2025, 3:46:37 PM - 4:15:35 PM):**
    *   The JSON file generation logic is changed to produce a *single* `Anchor_Ingedients_Shipment.json` file containing all fetched data, instead of one file per shipment.
    *   The temporary directory path is shifted between `../../temp/anchor-json`, `../../anchor/anchor-json`, and `../../config/anchor-json` before settling back to `../../temp/anchor-json` (11/18/2025, 4:18:42 PM).
    *   The `po_no` field in the SELECT statement is updated to `p.po_no` requiring a `LEFT JOIN po_details p ON p.agent_booing_no = e.bookingno` (11/18/2025, 4:05:26 PM).
*   **Batch Run Timestamp Management (11/18/2025, 4:35:15 PM):**
    *   New methods `getLastRunTimestamp` and `saveLastRunTimestamp` are added to manage a `anchor_json_run.json` batch file, allowing the batch to process data incrementally based on `m.lastmodifieddate`.
    *   The `moveAnchorJsonFileToSftp` method now uses these timestamp methods to determine the `fromDate` and `toDate` for its data fetch.
    *   A `logger` module is imported instead of relying on `global.logger`.
    *   A `sentMail` method is implemented (though not called in this version) for sending email notifications with attachments (similar to ISF report).
    *   The `fetchAnchorJsonData` method now accepts `fromDate` and `toDate` parameters and adds a `m.lastmodifieddate BETWEEN ...` clause to its SQL query.
    *   The `rail_eta` field is re-added to the SELECT statement and the `shipmentMap` (11/18/2025, 3:50:47 PM - 3:52:11 PM).
    *   `isf` default value is set to `false` if `null` (11/18/2025, 3:50:47 PM).
    *   Milestones `empty_in` and `full_out` are mapped to `t.cont_emptyin_date` and `t.cont_fullout_date` respectively.
*   **Email Integration (11/18/2025, 4:42:07 PM):** The `sentMail` function is made available, accepting attachments and formatted dates, sending emails to recipients specified in `config.email.anchor24HrJsonReport`.

**`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js` (Batch Execution Script, spanning 11/17/2025, 2:23:35 PM to 11/18/2025, 1:53:04 PM):**

*   **Initial Setup (11/17/2025, 2:23:35 PM):** Sets up `dotenv`, `logger`, `moment`, and imports `anchorJsonData`. It calls `anchorJsonData.fetchData()` and logs the result and execution time.
*   **Logging Refinements (11/17/2025, 5:21:11 PM - 5:23:17 PM):** Logs the `res` as JSON string (`JSON.stringify(res)`) and later prettifies the output (`JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`).
*   **Integration with SFTP Function (11/18/2025, 1:53:04 PM):** The script is updated to call the newly introduced `anchorJsonData.moveAnchorJsonFileToSftp()` method, which orchestrates the entire data fetching, JSON generation, and SFTP upload process.

**`c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json` (11/17/2025, 6:33:44 PM):**

*   This is a sample JSON file, not code, showing the expected output structure for shipment data, including `booking_no`, `mbl_number`, `scac_code`, `bl_number`, various date/time fields (`etd`, `atd`, `eta`, `ata`, `rail_ata`, etc.), `pol`, `pod`, `terminal` information, `customs` status, `isf`, `ponos`, `fda_release_date`, and an array of `containers` each with a `number` and an array of `milestone` objects (event, timestamp). This file likely serves as a reference for the desired output format of the `jsonAnchor.js` module.

**`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\isf\sendISF24hReport.js` (11/18/2025, 4:34:26 PM):**

*   Introduces a new module responsible for generating and sending an ISF (Importer Security Filing) 24-hour report as an Excel file.
*   Includes functionality to track the last run timestamp in a JSON file (`isf_batch_run.json`) to fetch data incrementally.
*   Connects to the database to query ISF-related data from `agent_booking_entry`, `cng_xml_batchlog`, `mtr_tracking_data`, and `isf_response` tables, filtering by `updated_at` or `created_at` within the last run period.
*   Uses `ExcelJS` to create a structured Excel report with specific columns and styling.
*   Sends the generated Excel report via email using `gmailSender.utils`.

**`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\config\config.js` (11/18/2025, 4:39:44 PM):**

*   Adds a new email configuration `anchor24HrJsonReport` under both `development` and `production` environments, specifying `to` and `cc` recipients for Anchor JSON reports.
*   Removes `logger = require("../../utils/logger");` from `jsonAnchor.js` at 3:51:24 PM, implying `logger` is a global variable or handled elsewhere for `jsonAnchor.js`, while `sendISF24hReport.js` directly imports `logger`. This discrepancy might point to inconsistent logging practices or a global logger setup in `run.AnchorJsonData.js`. (Self-correction: The `logger` import was missing in the earlier versions of `jsonAnchor.js` and was added in the 3:50:47 PM version, but the log for 3:51:24 PM omitted it, which is likely an oversight in the log generation rather than an actual removal, as subsequent logs (3:52:03 PM) do not show it removed explicitly.)

**Patterns and Recurring Elements:**

*   **Database Interaction:** All code changes heavily involve interacting with a PostgreSQL database (`public.agent_booking_entry`, `agent_booking_cargolist`, `agent_booking_container`, `mtr_tracking_data`, `t49_tracking_details`, `po_details`, `cng_xml_batchlog`, `isf_response`).
*   **SQL Query Evolution:** There's a clear evolution in the SQL queries, moving from simple SELECTs to complex JOINs with aliases, `COALESCE`, and specific `WHERE` clauses. The primary goal is to gather comprehensive shipment and container milestone data.
*   **Data Transformation:** A recurring pattern in `jsonAnchor.js` is fetching raw database rows and then transforming them into a more structured JSON format using a `shipmentMap` (grouped by `bookingno` or `mblno`), where containers and their milestones are nested.
*   **Batch Processing Paradigm:** Both `jsonAnchor.js` and `sendISF24hReport.js` adopt a batch processing model, including:
    *   Tracking the "last run timestamp" in a local JSON file (`anchor_json_run.json` or `isf_batch_run.json`).
    *   Fetching data based on a time window (e.g., last 24 hours, or since the last run).
    *   Performing an action (uploading JSON to SFTP, sending Excel report via email).
    *   Updating the "last run timestamp" upon successful completion.
*   **Error Handling and Logging:** Robust `try-catch` blocks are used for error handling, with `logger.error` for logging errors and `gmail.sendEmail` for sending email alerts on critical failures.
*   **SFTP Integration:** The `jsonAnchor.js` module specifically integrates with an SFTP client (`ssh2-sftp-client`) to upload generated JSON files to a remote server, suggesting an external system consumes this data.
*   **Configuration Dependency:** Both modules rely heavily on a `config` file for database connection details, email settings, and SFTP credentials.
*   **Date/Time Manipulation:** `moment.js` is consistently used for handling and formatting timestamps.
*   **"ANCHOR INGREDIENTS CO." Filter:** The `m.account_name = 'ANCHOR INGREDIENTS CO.'` condition appears consistently in the SQL queries of `jsonAnchor.js`, indicating that this batch is specifically tailored for a client named "ANCHOR INGREDIENTS CO.".
*   **`shipment_completed = 'Yes'` Filter:** Similarly, the `m.shipment_completed = 'Yes'` condition is consistently applied in `jsonAnchor.js` (after initial experimentation with `!= 'No'`), suggesting it focuses on completed shipments.

## 9:09:09 PM
The provided log details changes across three files, focusing on data extraction and SFTP processing for "Anchor Ingredients Co." shipments.

**File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`**

This file undergoes the most significant and frequent changes, primarily in its `fetchData` and later `fetchAnchorJsonData` methods, which are responsible for querying a database and formatting the results.

*   **11/17/2025, 2:21 PM - 2:21 PM:** Initial state. The `fetchData` method queries `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container` tables to retrieve basic booking and cargo details (e.g., `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`).
*   **11/17/2025, 2:49 PM:** The SQL query in `fetchData` is significantly revised. It now joins `mtr_tracking_data` instead of `agent_booking_cargolist` and fetches a much wider array of shipment tracking and status fields (e.g., `isf_status`, `mblno`, `blno`, `shipment_completed`, `rail_ata`, `delivery_customer_date`, `customs_release_date`, `po_no`, `account_name`).
*   **11/17/2025, 4:12 PM:** The `fetchData` query is refined further, introducing aliases for various date fields (`etd`, `eta`, `atd`, `ata`) and other details (`terminal_name`, `terminal_firms_code`, `fda_release_date`). The `mblno` is used for the `mtr_tracking_data` join condition.
*   **11/17/2025, 4:15 PM - 4:18 PM:** Conditional clauses are added to the `fetchData` query to filter results:
    *   `m.shipment_completed <> 'No'` (4:15 PM)
    *   `m.shipment_completed <> 'Yes'` (4:15 PM, reverted in later changes)
    *   `m.shipment_completed = 'Yes'` (4:15 PM, 4:18 PM)
    *   A consistent filter `m.account_name = 'ANCHOR INGREDIENTS CO.'` is introduced and maintained.
*   **11/17/2025, 4:24 PM:** The `DISTINCT` keyword is removed from the `SELECT` statement, then re-added shortly after (4:24 PM), indicating a minor back-and-forth on data uniqueness requirements.
*   **11/17/2025, 4:33 PM - 4:35 PM:** The `JOIN` types in the SQL query are changed from `JOIN` to `LEFT JOIN` for `mtr_tracking_data` and `agent_booking_container`, allowing shipments without matching entries in these tables to still be returned. The order of joins is also flipped, making `mtr_tracking_data` the primary table.
*   **11/17/2025, 4:57 PM - 5:14 PM:**
    *   A new, simpler `sqlQuery` (`select * from t49_tracking_details`) is introduced and used to fetch data, overriding the more complex `getQuery`. This suggests a temporary change for testing or a shift in data source focus.
    *   Initial attempts to process this `t49_tracking_details` data into a `containerDetails` array with "Empty Out" event and timestamp are added, including iterating over `data` with `for(rows of data)` and later `for(const row of data)`.
    *   The `t49_tracking_details` query is enhanced to include a `LEFT JOIN` with `mtr_tracking_data` on `container_number`.
    *   Console logs are added and removed for debugging.
*   **11/17/2025, 5:18 PM:** A major refactor occurs. The `fetchData` method is entirely restructured to aggregate shipment and container data.
    *   The SQL query is consolidated to directly join `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details` to fetch all necessary fields, including specific milestone timestamps (`empty_out_at`, `loaded_return` as `full_in`, `vessel_loaded`, `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in`).
    *   Post-query, the `rows` are processed into a `shipmentMap` object, grouping containers and their milestones under each `bookingno`.
*   **11/17/2025, 5:19 PM:** The `agent_booking_container` join is removed, and `m.contno` is directly used as `container_number` in the `mtr_tracking_data` table for joining with `t49_tracking_details`. The milestone `vessel_departed` timestamp is mapped to `r.atd` (which itself is `m.t49_vessel_actualdeparted_date`).
*   **11/17/2025, 5:19 PM:** The `vessel_departed`, `vessel_arrived`, `full_out`, and `empty_in` milestones are removed from the `SELECT` list in the SQL query, although they remain in the hardcoded `milestone` array in the JavaScript.
*   **11/17/2025, 6:30 PM:** Console logs for the raw SQL query and fetched rows are added for debugging.
*   **11/17/2025, 6:36 PM - 6:50 PM:**
    *   `m.t49_contno_out_gated` is added to the SQL `SELECT` statement and mapped to the "Full Out" milestone.
    *   The "Vessel Departed" and "Vessel Arrived" timestamps in the JavaScript `milestone` array are corrected to use `r.atd` and `r.ata` respectively.
    *   The `console.log(rows,"===rows")` is commented out.
*   **11/17/2025, 6:50 PM:** `COALESCE` is introduced for `atd` (using `m.t49_vessel_actualdeparted_date` or `m.vessel_actualdeparted_date`) and `ata` (using `m.t49_vessel_actualarrived_date` or `m.vessel_actualarrived_date`). `m.t49_eta` is specifically selected for `eta`.
*   **11/17/2025, 6:54 PM - 6:56 PM:**
    *   A `key` variable (`r.bookingno || r.mblno`) is introduced for `shipmentMap` to handle cases where `bookingno` might be null.
    *   A bug is introduced where `shipmentMap[r.key]` is used instead of `shipmentMap[key]` to push containers, then fixed immediately after.
    *   The "Empty In" milestone is removed from the JavaScript `milestone` array.
*   **11/18/2025, 1:43 PM:** Major functional overhaul. The `fetchData` method is renamed to `fetchAnchorJsonData` and a new `moveAnchorJsonFileToSftp` method is added.
    *   This new method integrates SFTP client (`ssh2-sftp-client`), file system operations (`fs`, `path`), and email utility (`gmail`).
    *   It now fetches JSON data, generates local JSON files, uploads them to an SFTP server (`/anchor/`), and handles error logging and email notifications.
    *   The `updateAlcStatus` and `moveFiles` utilities are imported and used, suggesting integration with an existing file management flow (though `updateAlcStatus` is later removed).
*   **11/18/2025, 1:46 PM:** Refinements to SFTP upload logic, messages, and error handling. The `updateAlcStatus` and `moveFiles` related code is removed.
*   **11/18/2025, 1:51 PM:**
    *   Introduces `fs` and `path` for local file creation and management.
    *   JSON files are now generated locally in a `temp/anchor-json` directory.
    *   Each shipment gets its own JSON file, named `ANCHOR_${booking_no_or_mbl_number}.json`.
    *   After upload, these local temp files are deleted.
    *   The `milestione` key is corrected to `milestone`.
*   **11/18/2025, 1:53 PM:** Imports `gmail` utility for error reporting emails.
*   **11/18/2025, 1:54 PM:** The `gmail.sendEmail` call in the `catch` block is commented out, then uncommented almost immediately after (1:54 PM).
*   **11/18/2025, 2:01 PM - 2:02 PM:** Adds `console.log("SFTP CONFIG =", config.sftpConfig)` (later `config.sftpConfig7501`) inside the `connect` method for debugging SFTP configuration. The SFTP config `sftpConfig` is changed to `sftpConfig7501`.
*   **11/18/2025, 3:46 PM:** The file generation logic is changed to produce a single large JSON file named `Anchor_Ingedients_Shipment.json` containing all fetched data, instead of individual files per shipment.
*   **11/18/2025, 3:50 PM:** Major refactoring for clarity and robustness:
    *   Comments are added to structure the class methods into "MAIN FUNCTION", "SFTP CONNECTION", and "FETCH & FORMAT SHIPMENT DATA".
    *   The `logger` utility is directly imported, removing `global.logger` dependency within the file.
    *   New milestone fields `t.cont_emptyin_date AS empty_in` and `t.cont_fullout_date AS full_out` are added to the SQL query.
    *   These new fields (`full_out`, `empty_in`) are correctly mapped in the `milestone` array in the JavaScript processing logic.
    *   The `isf` property in `shipmentMap` is given a default value of `false`.
    *   The module export is changed from `new AnchorJsonData(pool)` to `module.exports = new AnchorJsonData(pool);`.
*   **11/18/2025, 3:52 PM:** Reverts the `rail_eta` mapping in `shipmentMap` from `r.rail_eta` back to `r.rail_ata` (likely a copy-paste error correction). The `empty_in` and `full_out` milestone timestamps are adjusted back to use `r.t49_contno_out_gated` and the previous `vessel_departed`/`vessel_arrived` fields, rather than the newly introduced `t.cont_emptyin_date` and `t.cont_fullout_date` from `t49_tracking_details`. This indicates a potential data source issue or change in data mapping strategy. This change is almost immediately reverted, and `t.cont_emptyin_date AS empty_in` and `t.cont_fullout_date AS full_out` are brought back to the `SELECT` query, and correctly used in the `milestone` array. This part of the log is a bit confusing due to very rapid reverts, but the final state for this timestamp seems to use the `t.cont_emptyin_date` and `t.cont_fullout_date` if they are defined in the SQL select. However, inspecting the final state, `empty_in` and `full_out` are mapped to `r.empty_in` and `r.full_out` which are correctly aliased in the SQL.
*   **11/18/2025, 4:05 PM:** The `po_details` table is joined using `p.agent_booing_no = e.bookingno` to retrieve `p.po_no`.
*   **11/18/2025, 4:12 PM - 4:18 PM:** Minor changes in file naming (`ANCHOR_SHIPMENTS.json` to `Anchor_Ingedients_Shipment.json`) and temporary directory path (`../../temp/anchor-json`, then `../../anchor/anchor-json`, then `../../config/anchor-json`, then finally back to `../../temp/anchor-json`). The email sending logic for exceptions is consistently commented out.
*   **11/18/2025, 4:35 PM - 4:50 PM:** Introduces batch processing logic based on `last_run_timestamp` stored in a JSON file (`anchor_json_run.json`).
    *   `getLastRunTimestamp` and `saveLastRunTimestamp` methods are added.
    *   `moveAnchorJsonFileToSftp` now fetches data for a 24-hour window since the last run.
    *   A `lastmodifieddate` filter (`m.lastmodifieddate BETWEEN '${fromDate}' AND '${toDate}'`) is added to the SQL query in `fetchAnchorJsonData`.
    *   The `lastmodifieddate` is also added to the output `shipmentMap`.
    *   The `whereClauses.push(m.shipment_completed = 'Yes')` is temporarily changed to `m.shipment_completed <> 'Yes'` at 4:50 PM, indicating a shift in the target shipment status. This specific change is key as it alters the core business logic of what shipments are considered "completed". The error email logic is uncommented and now includes `fromDate` and `toDate` in the subject.

**File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`**

This is a batch script used to execute the `AnchorJsonData` module.

*   **11/17/2025, 2:23 PM:** Initial version. It imports `jsonAnchor`, initializes a logger, calls `anchorJsonData.fetchData()`, and logs the results.
*   **11/17/2025, 5:21 PM:** Adds `logger.info(json data,JSON.stringify(res));` for more detailed logging of the output.
*   **11/17/2025, 5:22 PM - 5:23 PM:** Changes `console.log(res,"res==data")` to `console.log(JSON.stringify(res, null, 2))` (later `JSON.stringify(res, 2)`) to pretty-print the JSON output, suggesting debugging of the structured data.
*   **11/17/2025, 6:34 PM:** Reverts `JSON.stringify(res, 2)` to `JSON.stringify(res, null, 2)` (minor formatting change).
*   **11/17/2025, 6:36 PM:** The `console.log` for the JSON result is commented out, indicating the output format is no longer needed in the console directly.
*   **11/18/2025, 1:53 PM:** The script is updated to call `anchorJsonData.moveAnchorJsonFileToSftp()` instead of `fetchData()`, reflecting the change in `jsonAnchor.js` to a full SFTP upload process. The `console.log`s are re-enabled, with the `JSON.stringify` including `null, 2` for pretty printing.
*   **11/18/2025, 4:51 PM:** The import path for `anchorJsonData` is changed from `../modules/anchor/jsonAnchor` to `../modules/anchor/anchorJsonUploadToSftp`, indicating a file rename or move.

**File: `c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`**

*   **11/17/2025, 6:33 PM:** This file is a JSON payload example. It represents the target output structure for the "Anchor Ingredients Co." shipment data, including shipment details and a nested array of containers, each with a `milestone` array (event and timestamp). This file serves as a reference or test output for the `jsonAnchor.js` transformations.

**File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\isf\sendISF24hReport.js`**

*   **11/18/2025, 4:34 PM:** This file, located in a different module (`isf`), is introduced. It's responsible for generating and sending an "ISF 24h Report" via email in Excel format.
    *   It includes logic to track the `last_run_timestamp` in `isf_batch_run.json` to fetch data for the last 24 hours.
    *   The `main` method orchestrates data fetching, Excel report creation, and email sending.
    *   The `createExcelReport` method formats the data into an Excel worksheet with specific column headers, styling, and auto-width.
    *   The `sentMail` method sends the generated Excel file as an attachment.
    *   The SQL query fetches distinct ISF-related data, joining `agent_booking_entry`, `cng_xml_batchlog`, `mtr_tracking_data`, and `isf_response`, filtering by `updated_at` or `created_at` within the last 24 hours and `isf_status IS NOT NULL`.

**File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\config\config.js`**

*   **11/18/2025, 4:39 PM:** This configuration file is updated to include a new email distribution list `anchor24HrJsonReport` for "Anchor Ingredients Co." specific JSON reports, adding `rida@dyneinfotech.com,rajeev.kumar@transmodal.net` as recipients in development mode.

**Patterns and Recurring Elements:**

*   **Database Query Evolution:** The primary development effort revolves around refining a complex SQL query to extract and join various shipment and tracking data points from `agent_booking_entry`, `mtr_tracking_data`, `agent_booking_container`, `t49_tracking_details`, and `po_details`. The query continuously expands its `SELECT` fields, introduces aliases, and changes `JOIN` types.
*   **Data Transformation:** There's a consistent pattern of fetching raw relational data and transforming it into a structured JSON output (a `shipmentMap` where each shipment has an array of containers, each with its own `milestone` events).
*   **SFTP Integration:** A recurring theme is the implementation of SFTP connectivity and file upload functionality (`ssh2-sftp-client`) for generated data. This moves from a general CSV upload concept to specific JSON file generation and upload.
*   **Logging and Error Handling:** `logger.info` and `logger.error` are extensively used throughout the code for tracking batch execution, data fetching, file generation, and SFTP operations. Error handling often involves `try...catch` blocks that throw new errors with detailed messages. Email notifications for exceptions are also a recurring feature.
*   **Timestamp-Based Batch Processing:** A new pattern emerges with the introduction of `getLastRunTimestamp` and `saveLastRunTimestamp` methods, indicating a shift towards incremental batch processing for both Anchor JSON data and ISF reports, processing data modified within a specific time window (e.g., last 24 hours).
*   **Specific Customer Focus:** A strong recurring element is the hardcoded filter `m.account_name = 'ANCHOR INGREDIENTS CO.'`, indicating that these batches are specifically tailored for this client.
*   **Debugging Artifacts:** Frequent additions and removals of `console.log` statements and `JSON.stringify` formatting indicate active debugging during development.
*   **Milestone Tracking:** The concept of tracking various shipment milestones (Empty Out, Full In, Vessel Loaded, Departed, Arrived, Full Out, Empty In) is a central data point being extracted and structured.