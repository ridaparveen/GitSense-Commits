# Activity Summary for 11/18/2025

## 9:32:08 AM
The changes primarily focus on two files: `modules\anchor\jsonAnchor.js` and `scripts\run.AnchorJsonData.js`, with one log entry for a JSON sample file. All modifications occurred on 11/17/2025, indicating a concentrated development effort.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`

This file, which defines an `AnchorJsonData` class responsible for fetching data from a database, underwent continuous and significant evolution throughout the day.

*   **Initial Query (2:21 PM):** The `fetchData` method began with a basic SQL query joining `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container`. It selected fields like `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, and `total_cbm`.
*   **Major Query Refactor (2:49 PM - 4:12 PM):** The SQL query was substantially revamped. The `agent_booking_cargolist` table was removed, and `mtr_tracking_data` was introduced and joined with `agent_booking_entry`. The `SELECT` clause was expanded to include a wide array of new fields from `agent_booking_entry` (e.g., `bookingno`, `isf_status`, `mblno`, `blno`) and `mtr_tracking_data` (e.g., `shipment_completed`, `scac_code`, various dates like `rail_ata`, `delivery_customer_date`, `pol`, `pod`, terminal information, `customs_release_date`, `po_no`, `account_name`). Many columns were aliased for clarity in the output (e.g., `departure_date as etd`).
*   **Adding Filtering Conditions (4:15 PM):** Filtering conditions were introduced to the `WHERE` clause: `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`. There was a brief period of toggling the `shipment_completed` condition between `'No'`, `'Yes'`, and `='Yes'` (4:15 PM - 4:18 PM), suggesting active testing or debugging of this filter.
*   **`DISTINCT` Keyword Toggling (4:24 PM):** The `DISTINCT` keyword was briefly removed and then re-added to the `SELECT` statement.
*   **Join Type and Primary Table Changes (4:33 PM - 4:35 PM):** The SQL query's structure around `FROM` and `JOIN` clauses saw changes, experimenting with `mtr_tracking_data` as the primary table with `LEFT JOIN`s, then reverting, and finally settling on `mtr_tracking_data m LEFT JOIN agent_booking_entry e`.
*   **Introducing `t49_tracking_details` and Iterative Processing (4:57 PM - 5:14 PM):**
    *   A new SQL query (`select * from t49_tracking_details`) was added and used to fetch data, initially overshadowing the main `getQuery`.
    *   The fetched data (`rows:data`) began to be processed in a loop, attempting to construct a `containerDetails` array with "Empty Out" events. A potential bug was introduced where `return result;` was inside the loop, causing the function to exit after the first iteration. This loop and `result` variable were later removed.
    *   The `t49_tracking_details` table was then explicitly `LEFT JOIN`ed with `mtr_tracking_data` in `sqlQuery`.
*   **Major Output Restructuring and Unified Query (5:18 PM):** The `fetchData` method underwent a significant refactor:
    *   A single, comprehensive SQL query (`sql`) was established, joining `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details`. It included selecting various container milestone timestamps (e.g., `empty_out_at`, `loaded_return AS full_in`, `vessel_loaded`, `vessel_departed`, `vessel_arrived`, `full_out`, `empty_in`).
    *   The raw query results (`rows`) were then transformed into a structured `shipmentMap` object, grouping related containers and their milestones under each `bookingno`. This correctly returned the aggregated data outside the loop.
*   **Refinement of Joins and Milestones (5:19 PM - 6:56 PM):**
    *   The `agent_booking_container` join was removed, and `m.contno` was used directly for `container_number`.
    *   Specific milestone fields in the `SELECT` query were adjusted, and `m.t49_contno_out_gated` was added to the selection.
    *   The mapping of milestone events to database columns in the output structure was refined, using `r.atd` for "Vessel Departed" and `r.ata` for "Vessel Arrived", and `r.t49_contno_out_gated` for "Full Out". The "Empty In" milestone was initially removed from the `SELECT` list, then still pushed in the output structure (implicitly `undefined`), then eventually explicitly removed from the output structure.
    *   `COALESCE` functions were introduced for `atd` and `ata` to provide fallback values from `m.vessel_actualdeparted_date` and `m.vessel_actualarrived_date` respectively. `eta` was specifically mapped to `m.t49_eta`.
    *   A unique grouping key `r.bookingno || r.mblno` was introduced for the `shipmentMap` to handle potential null `bookingno` values, with a minor bug introduced and quickly corrected regarding `shipmentMap[r.key]`.
*   **Logging:** Numerous `console.log` statements were added, removed, or commented out for debugging the SQL queries and their results.

### File: `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`

This script is responsible for executing the `AnchorJsonData` batch.

*   **Batch Execution Setup (2:23 PM):** It was established to load environment variables, create a logger, and use `moment` for timestamping. It initialized the `AnchorJsonData` class, called its `fetchData` method, and logged batch start/end and total execution time.
*   **Output Logging Changes (5:21 PM - 6:56 PM):** The script frequently changed how the `fetchData` result (`res`) was logged to the console. This included toggling between `console.log(res, "res==data")`, `logger.info(json data, JSON.stringify(res))`, and pretty-printing the JSON output using `JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`, often commenting out one form of output logging in favor of another.

### File: `c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`

*   **Sample Payload (6:33 PM):** This file contains a sample JSON structure representing two shipment records. Each record includes comprehensive details about the shipment (booking, MBL, dates, locations, customs, PO numbers) and nested container objects, each with its own list of milestones (event and timestamp). This JSON structure appears to be the target output format the `jsonAnchor.js` module was being developed to produce.

### Patterns and Recurring Elements:

*   **Iterative Development and Debugging:** The rapid sequence of changes, especially within `jsonAnchor.js`, and the frequent addition/removal of `console.log` statements, demonstrate an iterative development and debugging process aimed at refining the data fetching and transformation logic.
*   **SQL Query Complexity:** The SQL query in `jsonAnchor.js` progressively became more complex, incorporating more tables, columns, aliases, and `COALESCE` functions to handle data retrieval.
*   **Structured JSON Output:** A consistent goal was to produce a highly structured JSON output, grouping container milestones under their respective shipments, as evidenced by the `shipmentMap` logic and the provided sample JSON payload.
*   **Date/Time Handling:** The reliance on `moment.js` in the `run.AnchorJsonData.js` script and the extensive selection of date/timestamp fields in `jsonAnchor.js` highlight the importance of time-related data in the application.
*   **Specific Business Logic:** The filters `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'` indicate that this batch processing is tailored for specific "ANCHOR INGREDIENTS CO." shipments that are marked as "completed".

## 10:32:08 AM
The changes primarily revolve around a Node.js batch application designed to extract and transform shipment tracking data for "ANCHOR INGREDIENTS CO." into a structured JSON format.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\anchor\jsonAnchor.js`**: This file contains the core logic for fetching and processing data.
    *   **Initial Data Fetching (11/17/2025, 2:21 PM - 2:49 PM)**: The module `jsonAnchor.js` started with a `fetchData` method querying `agent_booking_entry`, `agent_booking_cargolist`, and `agent_booking_container` to retrieve basic booking and cargo details like `agent_booking_id`, `pol_code`, `pod_code`, `pono`, `pieces`, and `total_cbm`.
    *   **Shift to Shipment Tracking Data (11/17/2025, 2:49 PM)**: A significant overhaul of the SQL query occurred, replacing cargo-related tables with `mtr_tracking_data` and focusing on comprehensive shipment tracking details (e.g., `mblno`, `blno`, `scac_code`, various ETD/ETA/ATA dates, terminal info, customs release, `po_no`).
    *   **Introduction of Filtering (11/17/2025, 4:15 PM - 4:18 PM)**: The `fetchData` method was enhanced to include `WHERE` clauses to filter shipments. This involved repeated changes between `m.shipment_completed = 'Yes'` and `m.shipment_completed <> 'Yes'`, eventually settling on `m.shipment_completed = 'Yes'` and `m.account_name = 'ANCHOR INGREDIENTS CO.'`, indicating a focus on completed shipments for a specific client.
    *   **Query Structure Refinement (11/17/2025, 4:33 PM - 4:35 PM)**: There were several adjustments to the SQL query's `FROM` clause and join types, alternating between starting the query from `agent_booking_entry` or `mtr_tracking_data` and consistently using `LEFT JOIN`.
    *   **Attempt at Milestone Processing (11/17/2025, 4:57 PM - 5:14 PM)**: An attempt was made to introduce a separate `sqlQuery` for `t49_tracking_details` and loop through its results. This initial implementation had logical flaws, such as re-initializing the result array within the loop.
    *   **Major Data Transformation Logic (11/17/2025, 5:18 PM)**: A substantial change consolidated the data fetching into a single complex SQL query. This query joined `mtr_tracking_data`, `agent_booking_entry`, `agent_booking_container`, and `t49_tracking_details` to select a wide array of shipment and container milestone data. Post-query processing was introduced to transform the flat database rows into a hierarchical JSON object, grouping containers and their milestones under each shipment.
    *   **Refinement of Container Joins and Milestones (11/17/2025, 5:19 PM - 6:56 PM)**: Further adjustments refined how container numbers were joined (`m.contno AS container_number` instead of `con.contno`) and which specific milestone fields (`t.empty_out_at`, `t.loaded_return AS full_in`, `t.vessel_loaded`, `m.t49_contno_out_gated`) were selected. Missing milestone timestamps in the output structure were corrected by either mapping to existing fields or removing events that were not retrieved. The SQL query was updated to use `COALESCE` for some date fields (e.g., `atd`, `ata`) to ensure data availability from multiple potential sources. A bug where containers were incorrectly assigned to shipments (`shipmentMap[r.key]`) was introduced and subsequently fixed. The "Empty In" milestone was ultimately removed from the output structure, aligning it with the SQL query.

*   **`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\scripts\run.AnchorJsonData.js`**: This file is a batch script responsible for executing the `jsonAnchor` module.
    *   **Basic Batch Execution (11/17/2025, 2:23 PM)**: Initial setup included loading environment variables, creating a logger, marking batch start/end times, calling `anchorJsonData.fetchData()`, and logging the raw result.
    *   **Logging Refinements (11/17/2025, 5:21 PM - 6:56 PM)**: Repeated modifications were made to how the fetched data was logged. This involved toggling between `console.log(res)`, `logger.info(JSON.stringify(res))`, and pretty-printing JSON output (`JSON.stringify(res, null, 2)` or `JSON.stringify(res, 2)`), indicating active debugging and presentation considerations for the output.

*   **`c:\Users\ridap\Downloads\Anchor_Ingedients_Shipmnet_Payload (1).json`**: This JSON file (timestamp 11/17/2025, 6:33 PM) serves as an example of the structured output that the `jsonAnchor.js` module is designed to produce. It contains an array of shipment objects, each with detailed tracking information and a nested array of containers, each listing specific milestones with timestamps (e.g., Empty Out, Full In, Vessel Loaded). This demonstrates the desired hierarchical data format.

**Patterns and Recurring Elements:**

*   **Iterative Development and Debugging**: There's a clear pattern of incremental changes, particularly in `jsonAnchor.js`, where the SQL query and data transformation logic are progressively refined. Frequent commits modifying SQL joins, selected columns, and `WHERE` clauses, along with the insertion and removal of `console.log` statements in both files, highlight an active development and debugging process.
*   **Focus on Shipment Tracking**: The core purpose of the changes is to retrieve and structure detailed shipment and container tracking information, specifically for the "ANCHOR INGREDIENTS CO." account.
*   **Data Transformation from Flat to Hierarchical**: A key recurring theme is the effort to transform flat database query results into a more complex, nested JSON structure suitable for programmatic use or display, grouping container milestones under their respective shipments.
*   **Timestamp-Based Milestone Tracking**: The `milestione` array within containers, containing `event` and `timestamp` pairs, is a consistent element in the desired output structure, indicating a focus on tracking event chronology.
*   **Database Interaction**: Both `jsonAnchor.js` and `run.AnchorJsonData.js` consistently interact with a PostgreSQL database via a `pool` object, indicating a data-driven application.
*   **Error Handling**: The `fetchData` method in `jsonAnchor.js` consistently includes a `try-catch` block to handle potential database errors.