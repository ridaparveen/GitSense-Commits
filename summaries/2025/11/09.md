# Activity Summary for 11/9/2025

## 8:31:46 PM
The log shows development activity across three primary files: `AuthRoutes.ts`, `dashboardService.ts`, and `bookingService.ts`, with minor updates to `Paths.ts` and `booking.ts` (type definition file). The changes occurred between November 5th and November 7th, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   This file, responsible for authentication routes, had a single change. It defines a GET endpoint for `Paths.Auth.GetUserInfo` that logs the requested user information and returns it with an `OK` status.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** Multiple changes throughout 11/5/2025, from 6:04:50 PM to 11:23:11 PM.
    *   This service handles dashboard data fetching (`getDashboardCardInfo` and `getDeliveryData`).
    *   **Key changes in `getDashboardCardInfo`:**
        *   Initial versions included `CompanyName` directly from `req.query`.
        *   Later updates introduced `getUserObject` to dynamically fetch `CompanyName` based on `req.user`, `req.query.companyname`, and `req.query.access`. This indicates an enhancement in how user-specific or company-specific data is filtered for the dashboard cards.
        *   Several commits involved adding `console.log("req.CompanyName", CompanyName);` for debugging purposes.
        *   A line `// if(useWhere) conditions.push(useWhere);` was commented out in multiple updates for `getDashboardCardInfo`, suggesting an attempt to modify or temporarily disable user-specific filtering in the `cardQuery` part, while the `useWhere` variable is still being built.
        *   The `baseQuery` for `getDashboardCardInfo` consistently filters by `LOWER(account_name) = '${CompanyName}'`.
    *   **Key changes in `getDeliveryData`:**
        *   Similar to `getDashboardCardInfo`, the `CompanyName` retrieval was modified to use `getUserObject`.
        *   A `companyFilter` variable was introduced and refined for safe SQL injection prevention using `CompanyName.replace(/'/g, "''")` and applying `LOWER()` to both sides of the comparison. This indicates a significant security improvement in how company names are handled in SQL queries for both `sqlQueryDelivery` and `SqlQueryVesselArrival`.
        *   Multiple `console.log("companyFilter", companyFilter);` statements were added for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps:** Multiple changes on 11/5/2025, from 8:51:00 PM to 8:51:46 PM.
    *   This service manages user-related operations like login, saving preferences, fetching preferences, saving invite logs, fetching company users, and user settings.
    *   No functional changes were observed within the provided diffs for this file; the content is identical across the three timestamps, suggesting re-saves or minor non-functional changes not captured in the diff format. The file defines `TokenPayload` interface and exports several asynchronous functions for user management.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 (5:06:22 PM, 5:13:57 PM, 7:20:31 PM) and 11/7/2025 (12:17:18 PM, 12:24:55 PM).
    *   This file defines application API paths.
    *   A `createBookingApproveDetails` path was added under `Paths.Booking` on 11/6/2025.
    *   A `vesselAdd` path was added under `Paths.Booking` with a dynamic `/:agent_booking_id` parameter on 11/7/2025, 12:17:18 PM.
    *   This `vesselAdd` path was then changed to a static `"/vessel"` on 11/7/2025, 12:24:55 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 (5:06:41 PM, 5:15:38 PM) and 11/7/2025 (12:17:36 PM, 1:14:41 PM, 1:14:50 PM).
    *   This file defines routes for booking-related API endpoints.
    *   The `updateBookingApproveDetails` service function was imported and associated with the new `Paths.Booking.createBookingApproveDetails` POST route.
    *   The `addBookingVessel` service function was imported and associated with the new `Paths.Booking.vesselAdd` POST route (11/7/2025, 12:17:36 PM).
    *   Later, `addBookingVessel` was renamed to `addOrUpdateBookingVessel` in the import and route association, indicating a change in the booking vessel functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **Timestamp:** 11/6/2025, 6:02:57 PM
    *   A `CONFIRMED` status was added to the `BookingStatus` enum.

**Patterns and Recurring Elements:**

*   **Database Interactions:** Frequent use of `query`, `insertQuery`, and `updateQuery` functions, indicating a strong reliance on direct SQL queries for database operations. This is often coupled with string interpolation, which can be a SQL injection risk if not handled carefully (though `addCondition` and `companyFilter` show attempts to address this).
*   **Logging:** Extensive use of `logger.info()` and `logger.error()` throughout the services for tracking execution flow and debugging, as well as `console.log` statements for immediate output during development.
*   **Request/Response Handling:** Consistent use of `IAuthReq` and `IRes` types for request and response objects, and `HttpStatusCodes` for standardizing HTTP responses.
*   **Query Building Logic:** Both `dashboardService.ts` and `bookingService.ts` employ a pattern of building SQL queries dynamically based on user roles and various query parameters (filters, search, date ranges). The `BookingQueryBuilder` class encapsulates this logic for booking-related queries.
*   **User-Specific Filtering:** A recurring requirement is to filter data based on the authenticated user's role and company. The `buildMtrUserCondition` and similar logic in `BookingQueryBuilder` are designed for this purpose.
*   **Error Handling:** Services consistently use `try...catch` blocks to handle errors and return `HttpStatusCodes.INTERNAL_SERVER_ERROR` with a generic error message in case of exceptions. `HttpError` is used for specific business logic errors.
*   **Data Sanitization:** The `sanitizeString` utility function is used in `saveBooking` in `bookingService.ts` to clean up input, indicating awareness of potential data integrity issues.
*   **Dashboard Status Logic:** The `getAll` function in `shipmentService.ts` includes complex conditional logic to determine a shipment's status (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields and T49 data.
*   **Date Handling:** Multiple services deal with date parameters (e.g., `fromDate`, `toDate`, `cargoReadyFromDate`, `cargoReadyToDate`) for filtering and formatting (`AppDateFormate`).
*   **Query Parameter Evolution:** Changes in `dashboardService.ts` regarding `CompanyName` extraction and in `bookingService.ts` related to date range filters show an iterative process of refining how query parameters are processed and applied to SQL queries.
*   **New Features in Booking Service:** The addition of `est_cargo_ready_date` in `BookingQueryBuilder`, new date range filtering for cargo ready dates, and routes/functions for `booking_approve` and `vesselAdd` indicate active development of booking management functionalities. The update in `BookingRoutes.ts` from `addBookingVessel` to `addOrUpdateBookingVessel` further suggests refining of the vessel management process within bookings.