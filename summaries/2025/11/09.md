# Activity Summary for 11/9/2025

## 8:31:46 PM
The log shows development activity across three primary files: `AuthRoutes.ts`, `dashboardService.ts`, and `bookingService.ts`, with minor updates to `Paths.ts` and `booking.ts` (type definition file). The changes occurred between November 5th and November 7th, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   This file, responsible for authentication routes, had a single change. It defines a GET endpoint for `Paths.Auth.GetUserInfo` that logs the requested user information and returns it with an `OK` status.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** Multiple changes throughout 11/5/2025, from 6:04:50 PM to 11:23:11 PM.
    *   This service handles dashboard data fetching (`getDashboardCardInfo` and `getDeliveryData`).
    *   **Key changes in `getDashboardCardInfo`:**
        *   Initial versions included `CompanyName` directly from `req.query`.
        *   Later updates introduced `getUserObject` to dynamically fetch `CompanyName` based on `req.user`, `req.query.companyname`, and `req.query.access`. This indicates an enhancement in how user-specific or company-specific data is filtered for the dashboard cards.
        *   Several commits involved adding `console.log("req.CompanyName", CompanyName);` for debugging purposes.
        *   A line `// if(useWhere) conditions.push(useWhere);` was commented out in multiple updates for `getDashboardCardInfo`, suggesting an attempt to modify or temporarily disable user-specific filtering in the `cardQuery` part, while the `useWhere` variable is still being built.
        *   The `baseQuery` for `getDashboardCardInfo` consistently filters by `LOWER(account_name) = '${CompanyName}'`.
    *   **Key changes in `getDeliveryData`:**
        *   Similar to `getDashboardCardInfo`, the `CompanyName` retrieval was modified to use `getUserObject`.
        *   A `companyFilter` variable was introduced and refined for safe SQL injection prevention using `CompanyName.replace(/'/g, "''")` and applying `LOWER()` to both sides of the comparison. This indicates a significant security improvement in how company names are handled in SQL queries for both `sqlQueryDelivery` and `SqlQueryVesselArrival`.
        *   Multiple `console.log("companyFilter", companyFilter);` statements were added for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps:** Multiple changes on 11/5/2025, from 8:51:00 PM to 8:51:46 PM.
    *   This service manages user-related operations like login, saving preferences, fetching preferences, saving invite logs, fetching company users, and user settings.
    *   No functional changes were observed within the provided diffs for this file; the content is identical across the three timestamps, suggesting re-saves or minor non-functional changes not captured in the diff format. The file defines `TokenPayload` interface and exports several asynchronous functions for user management.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 (5:06:22 PM, 5:13:57 PM, 7:20:31 PM) and 11/7/2025 (12:17:18 PM, 12:24:55 PM).
    *   This file defines application API paths.
    *   A `createBookingApproveDetails` path was added under `Paths.Booking` on 11/6/2025.
    *   A `vesselAdd` path was added under `Paths.Booking` with a dynamic `/:agent_booking_id` parameter on 11/7/2025, 12:17:18 PM.
    *   This `vesselAdd` path was then changed to a static `"/vessel"` on 11/7/2025, 12:24:55 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 (5:06:41 PM, 5:15:38 PM) and 11/7/2025 (12:17:36 PM, 1:14:41 PM, 1:14:50 PM).
    *   This file defines routes for booking-related API endpoints.
    *   The `updateBookingApproveDetails` service function was imported and associated with the new `Paths.Booking.createBookingApproveDetails` POST route.
    *   The `addBookingVessel` service function was imported and associated with the new `Paths.Booking.vesselAdd` POST route (11/7/2025, 12:17:36 PM).
    *   Later, `addBookingVessel` was renamed to `addOrUpdateBookingVessel` in the import and route association, indicating a change in the booking vessel functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **Timestamp:** 11/6/2025, 6:02:57 PM
    *   A `CONFIRMED` status was added to the `BookingStatus` enum.

**Patterns and Recurring Elements:**

*   **Database Interactions:** Frequent use of `query`, `insertQuery`, and `updateQuery` functions, indicating a strong reliance on direct SQL queries for database operations. This is often coupled with string interpolation, which can be a SQL injection risk if not handled carefully (though `addCondition` and `companyFilter` show attempts to address this).
*   **Logging:** Extensive use of `logger.info()` and `logger.error()` throughout the services for tracking execution flow and debugging, as well as `console.log` statements for immediate output during development.
*   **Request/Response Handling:** Consistent use of `IAuthReq` and `IRes` types for request and response objects, and `HttpStatusCodes` for standardizing HTTP responses.
*   **Query Building Logic:** Both `dashboardService.ts` and `bookingService.ts` employ a pattern of building SQL queries dynamically based on user roles and various query parameters (filters, search, date ranges). The `BookingQueryBuilder` class encapsulates this logic for booking-related queries.
*   **User-Specific Filtering:** A recurring requirement is to filter data based on the authenticated user's role and company. The `buildMtrUserCondition` and similar logic in `BookingQueryBuilder` are designed for this purpose.
*   **Error Handling:** Services consistently use `try...catch` blocks to handle errors and return `HttpStatusCodes.INTERNAL_SERVER_ERROR` with a generic error message in case of exceptions. `HttpError` is used for specific business logic errors.
*   **Data Sanitization:** The `sanitizeString` utility function is used in `saveBooking` in `bookingService.ts` to clean up input, indicating awareness of potential data integrity issues.
*   **Dashboard Status Logic:** The `getAll` function in `shipmentService.ts` includes complex conditional logic to determine a shipment's status (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields and T49 data.
*   **Date Handling:** Multiple services deal with date parameters (e.g., `fromDate`, `toDate`, `cargoReadyFromDate`, `cargoReadyToDate`) for filtering and formatting (`AppDateFormate`).
*   **Query Parameter Evolution:** Changes in `dashboardService.ts` regarding `CompanyName` extraction and in `bookingService.ts` related to date range filters show an iterative process of refining how query parameters are processed and applied to SQL queries.
*   **New Features in Booking Service:** The addition of `est_cargo_ready_date` in `BookingQueryBuilder`, new date range filtering for cargo ready dates, and routes/functions for `booking_approve` and `vesselAdd` indicate active development of booking management functionalities. The update in `BookingRoutes.ts` from `addBookingVessel` to `addOrUpdateBookingVessel` further suggests refining of the vessel management process within bookings.

## 8:31:48 PM
The provided log details several code changes across various service and routing files, all occurring on November 7, 2025. The updates reflect ongoing development in areas such as data retrieval, API routing, and document/note management, with a notable pattern of iteration and refinement in PDF parsing functionality.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\docsParseService.ts` (11/7/2025, 5:03:25 PM):**
    This file contains an `getAllPdfParse` function which, despite its name, is primarily a **vendor listing service**. It fetches paginated and sorted vendor data, includes filtering by `vendor_name`, `status`, and `email`, and dynamically retrieves associated `document_upload` entries (of `ref_type = 'vendor_doc'`) for each vendor. It also generates distinct `status` and `email` options, cleaning and formatting them. This code is very similar to the `getAll` function in `vendorServices.ts`, suggesting a possible refactor or redundancy.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\pdfParseService.ts` (Multiple timestamps):**
    This file, containing the `getAllPdfParse` function, undergoes significant and frequent changes:
    *   **Initial (11/7/2025, 5:06:48 PM):** Implements pagination and sorting for `AI_Parse_Document` using `QueryBuilder`, ordered by `process_date_time`.
    *   **Refinement (11/7/2025, 5:06:59 PM - 5:07:04 PM):** Adds `count` to the response data for pagination metadata.
    *   **Path Generation Attempt (11/7/2025, 6:15:41 PM):** Modifies the `QueryBuilder` to dynamically construct full URL paths for `pdf_pa` and `json_pa` fields using `CONCAT` and `process.env.UPLOAD_DOC_PATH`. Changes error logging from `logger.info` to `logger.error`.
    *   **Reversion (11/7/2025, 6:25:14 PM):** Reverts the column selection back to `["*"]` and switches error logging back to `logger.info` with `console.error`.
    *   **Direct SQL Path Generation (11/7/2025, 6:29:11 PM - 6:40:55 PM):** Abandons `QueryBuilder` for a direct SQL query to fetch data from `AI_Parse_Document`. It explicitly constructs URL paths for `pdf_pa` and `json_pa` using `CONCAT('/envosys_uploads/', ...)` or `CONCAT('http://localhost:8080/uploads/', ...)` and handles pagination directly in the query. It also updates the selected ID column from `id` to `ser_no` in this period.
    *   **Final Reversion (11/7/2025, 8:16:08 PM - 8:32:03 PM):** Reverts back to using the `QueryBuilder` approach, similar to the initial implementation, losing the direct SQL URL construction logic.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\constants\Paths.ts` (11/7/2025, 5:07:36 PM & 5:15:03 PM):**
    *   Defines various API routes, including those for Users, Auth, AutoComplete, Audit, UploadDocuments, Customer, Linebooking, CustomerBooking, Vessel, Voyage, Vendor, and Job.
    *   The `Document.GetPdf` path is initially `/get-pdf` and is later updated to `Document.GetPdfParse` as `/get-pdf-parse`.
    *   A new `Notes` module is introduced with base, getAll, and add paths.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\routes\documentUploadRoutes.ts` (11/7/2025, 5:08:07 PM):**
    Configures routes for document uploads, downloads, and the `getAllPdfParse` endpoint (which maps to `Paths.Document.GetPdf`). The path here would implicitly update with the change in `Paths.ts`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\linebookingService.ts` (11/7/2025, 5:14:34 PM & 5:14:48 PM):**
    Contains a `create` function for line bookings. This function handles:
    *   Transactional insertion of line booking details into `line_booking_master`.
    *   Insertion of associated equipment into `line_booking_equipments`.
    *   Deletion of old and insertion of new `other_services_master` entries.
    *   Logic to determine initial booking `status` (ASSIGNED, CONFIRMED, NEW) based on `do_number` and party details.
    *   A large `getAll` function remains commented out, indicating potential work in progress or a planned refactor.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\util\optionQuery.ts` (11/7/2025, 5:14:43 PM):**
    Introduces `buildOptionQuery` and `buildQueryOptions` utility functions, and an `OptionQuery` class. This class provides methods to generate SQL queries for fetching distinct options like ports, GST locations, users, vessel voyages, customer names, line names, vendors, and party details, primarily for autocomplete or dropdowns.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\vendorServices.ts` (11/7/2025, 5:59:15 PM):**
    *   **`getAll` function:** Similar to the `docsParseService.ts` function, it retrieves paginated vendor data, filters, fetches associated `document_upload` entries, and generates dynamic options for status and email. Commented-out code for fetching notes is present.
    *   **`addVendor` function:** Handles creating new vendors, including saving vendor details, performing a `simpleAudit`, processing and saving uploaded documents via `saveDoc`, and inserting new notes. There's a duplicated block of code for processing notes, which could be a copy-paste error.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\routes\index.ts` (11/7/2025, 6:34:36 PM & 8:32:17 PM):**
    The main API router. Registers all individual module routes (`AuthRoutes`, `CustomerRoutes`, `DocumentRoutes`, etc.) using the paths defined in `Paths.ts`. It also explicitly routes `Paths.AutoComplete.Base` to `getAll` from `searchOptions` service, `Paths.Audit.Base` to `getAllAudit`, and `Paths.Notes.Base` to `NotesRoutes`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\server.ts` (11/7/2025, 6:34:51 PM):**
    Configures the Express server:
    *   Serves static files from `/root/node/envosys/envosys_bucket/ai/upload` at the `/uploads` endpoint.
    *   Sets up CORS with broad permissions (`origin: "*"`, various methods and headers).
    *   Enables JSON and URL-encoded body parsing with a 10MB limit.
    *   Uses `morgan` for request logging.
    *   Includes login route for `/temp-auth/login` and a user addition route (`/api/users/add`) before the main authentication middleware.
    *   Registers the main API router under `/api`.
    *   Connects to a PostgreSQL database and logs connection status.

### Patterns and Recurring Elements:

*   **Consistent Timestamp:** All recorded changes occurred on November 7, 2025, indicating focused development activity on this particular day.
*   **QueryBuilder Usage:** The `QueryBuilder` utility is widely used across multiple services (`docsParseService.ts`, `pdfParseService.ts`, `vendorServices.ts`) for constructing dynamic SQL queries, demonstrating a standardized approach to database interactions.
*   **Pagination and Sorting:** `page`, `perPage`, `offset`, and `orderBy` parameters are consistently used in `getAll` functions for paginated and sortable data retrieval.
*   **Dynamic Options/Filters:** Services often include logic to extract distinct values (e.g., status, email, port names) from the database to provide dynamic filtering or autocomplete options in the UI.
*   **Document and Note Management:** There is a clear pattern of integrating document uploads (`saveDoc` function, `document_upload` table) and notes (`notes` table) with main entities like Vendors and Line Bookings.
*   **API Route Standardization:** The `Paths.ts` file acts as a central repository for API endpoints, ensuring consistency and ease of management for routing across the application.
*   **`pdfParseService.ts` Volatility:** This file shows a high frequency of changes and reversions, particularly concerning how file paths (`pdf_pa`, `json_pa`) are handled (direct paths, `CONCAT` with `env` variables, `localhost` URLs, and then back to `QueryBuilder`). This suggests ongoing experimentation or debugging related to serving parsed PDF content.
*   **Transactional Integrity:** The `linebookingService.ts` demonstrates the use of `await query("BEGIN")`, `await query("COMMIT")`, and `await query("ROLLBACK")` for maintaining data consistency during complex write operations.
*   **Error Handling:** Services consistently include `try...catch` blocks to handle errors, logging messages using `logger` and returning `HttpStatusCodes.INTERNAL_SERVER_ERROR`.