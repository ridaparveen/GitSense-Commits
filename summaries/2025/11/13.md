# Activity Summary for 11/13/2025

## 10:42:51 AM
The changes primarily affect three core frontend files: `planboard-page.tsx`, `notification-page.tsx`, and `sidebar.tsx`, along with its associated configuration file, `menu.ts`. The updates span from minor text corrections to significant logic adjustments for user role-based access and data fetching.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx`**
    *   **Timestamp: 11/13/2025, 9:46:03 AM & 9:46:25 AM**
    *   This component is responsible for displaying the booking planboard. It includes options for selecting a view (Year/Month) and a year, utilizing Redux for state management (`planboardBooking` slice). It dynamically renders `PlanboardCardView` and `MoreDetailsView` in a modal.
    *   A minor update was made to the fallback message displayed when no customer is selected. The text "Please select a customer to view booking data." was changed to "Please select a customer to view planboard data." for better accuracy.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx`**
    *   **Timestamp: 11/13/2025, 9:47:43 AM, 9:47:50 AM & 9:51:35 AM**
    *   This page displays user notifications, fetching data via `useFetchNotificationDataQuery`. It supports different notification types with corresponding icons and allows navigation to shipment details.
    *   Initially, a typo in the "no customer selected" fallback message was corrected from "notficat data" to "notfication data".
    *   A more significant change occurred on **11/13/2025, 9:51:35 AM**, where the logic for determining the `CompanyName` parameter in the notification data query was simplified. It was changed from `CompanyName: selectedCustomer || localUser?.companyname` to `CompanyName: selectedCustomer || ""`. This removes the reliance on `localUser?.companyname` as a fallback, making `selectedCustomer` (or an empty string if `selectedCustomer` is null) the sole source for the company name in the API request. Accompanying `console.log` statements for `selectedCustomer` and `localUser` were also removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`**
    *   **Timestamp: 11/13/2025, 10:20:29 AM, 10:20:38 AM, 10:29:48 AM, 10:30:26 AM & 10:32:57 AM**
    *   This component renders the application's sidebar navigation using configurations from `menu.ts`. It displays a logo, a customer selection panel (for `ADMIN_V2` roles), and various menu items.
    *   On **11/13/2025, 10:20:38 AM**, a minor typo was fixed: a superfluous "kk" suffix was removed from all `SidebarLabel` elements.
    *   Between **10:29:48 AM** and **10:32:57 AM**, there was an attempt to introduce logic for visually and functionally disabling sidebar items based on an `item.disabled` flag from `menu.ts`. This involved conditionally setting the `href` to `undefined`, preventing default navigation on click, and applying CSS classes for a disabled appearance. However, this change was subsequently **reverted** on **11/13/2025, 10:32:57 AM**, removing all `isDisabled` related logic and restoring the component to its previous state.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts`**
    *   **Timestamp: 11/13/2025, 10:22:41 AM - 10:42:13 AM**
    *   This file defines the `sidebarMenu` structure, including labels, hrefs, and icons for navigation items. It also contains logic for conditional menu item display.
    *   There were multiple, often conflicting, changes regarding the "Preferences" menu item's visibility based on the user's role (`ADMIN_V2`).
        *   Initially, "Preferences" was always visible.
        *   An attempt on **10:24:09 AM** introduced `disabled?: boolean;` to `SidebarItemType` and removed "Preferences" if `userRole === "admin_v2"`.
        *   This change was quickly reverted at **10:24:31 AM**.
        *   Conditional removal of "Preferences" for `ADMIN_V2` was re-added at **10:26:22 AM** (using `localUser.role`).
        *   A new approach at **10:28:35 AM** added a mandatory `disabled: boolean;` property to `SidebarItemType` and explicitly set `disabled: localUser?.role === "ADMIN_V2"` for "Preferences," intending to disable it rather than remove it.
        *   However, this `disabled` property mechanism was then **reverted** at **10:34:59 AM**, bringing back the conditional *removal* of the "Preferences" item for `ADMIN_V2` users.
        *   The `userRole` variable was formally reintroduced at **10:38:26 AM** for this conditional logic.
    *   A typo in "Planbaord" was briefly corrected to "Planboard" at **10:24:09 AM** but then reverted back to "Planbaord" by **10:24:31 AM**.
    *   The "Analytics" menu item under "Reports" was uncommented and made visible at **10:41:03 AM**, but then commented out again and hidden at **10:42:13 AM**.
    *   The "Dev" section remains conditionally rendered based on `import.meta.env.VITE_MODE === 'DEV'`.

**Patterns and Recurring Elements:**

*   **Role-Based Access Control Fluctuation:** The most prominent pattern is the persistent effort to implement role-based access for the "Preferences" menu item. The implementation frequently switched between *removing* the item entirely for `ADMIN_V2` users and *disabling* it, with quick reverts and re-attempts, suggesting ongoing refinement or indecision on the best approach. The final state in the log shows it's conditionally removed.
*   **Dependency on `selectedCustomer`:** Both `planboard-page.tsx` and `notification-page.tsx` exhibit a strong dependency on the `selectedCustomer` from the Redux global state, displaying placeholder messages when it's not present.
*   **Minor Typo Corrections and Reverts:** Several small textual corrections (e.g., "notficat" to "notification", "Planbaord" to "Planboard") were made, often followed by quick reverts, indicating iterative development and potential collaboration conflicts or rapid iteration.
*   **Conditional "Dev" Features:** The sidebar menu consistently includes a "Dev" section that is conditionally rendered based on the `VITE_MODE` environment variable, a common practice for internal development features.
*   **Temporary `console.log` for Debugging:** Debugging `console.log` statements were added and later removed in `notification-page.tsx` when adjusting data fetching logic.

## 11:42:10 AM
The log details code changes across two files related to report scheduling and history, all occurring on November 13, 2025.

**File-Specific Updates:**

1.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   **11/13/2025, 10:50:09 AM:** This version established the core functionalities for managing scheduled reports. It includes:
        *   `setReport`: A function to insert new scheduled report configurations into the `v2_user_reports` table, covering details like `reportName`, `columns`, `description`, `schedule`, `time`, `date`, `week_day`, `month_day`, `email_ids`, and `timezone`.
        *   `fetchScheduledReports`: Retrieves active scheduled reports for a user, with optional filtering by `id` and `CompanyName` (mapped to `account_name`). It also includes a `timeZoneConverter` utility to adjust date and time based on the user's timezone.
        *   `editReport`: Allows updating an existing scheduled report based on its `id` and `user_id`, modifying various report parameters.
    *   **11/13/2025, 11:03:19 AM:** A temporary change was introduced in `fetchScheduledReports`. The `companyName` variable, intended to filter by `req.query.CompanyName`, was mistakenly assigned `req.query.id`. A `console.log` statement (`"===jjhhhh"`) was also added.
    *   **11/13/2025, 11:06:07 AM:** This change reverted the accidental bug introduced in the previous timestamp. The `companyName` variable in `fetchScheduledReports` was corrected back to `req.query.CompanyName`, ensuring proper filtering by company name. The `console.log` statement remained. This indicates a quick fix after an immediate detection of a regression.

2.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   **11/13/2025, 11:21:33 AM:** This file was introduced, adding new functionalities for report history:
        *   `saveReportHistory`: A function to record the history of executed reports. It inserts comprehensive details into the `public.v2_report_history` table, including user ID, report ID, name, schedule parameters, timezone, email IDs, columns, date filters (`fromDate`, `toDate`), other filters (`filterByPeriod`, `filterByColumn`), sorting (`sortOrder`, `orderByColumn`), `accountName`, `includeZeroEta`, `status`, and `description`. It utilizes parameterized queries for secure database interaction.
        *   `getReportHistory`: A robust function to retrieve report history, supporting pagination (`page`, `limit`), sorting (`sort` by `sent_date`), and extensive filtering by `CompanyName` (mapped to `account_name`), `name`, `fromDate`, `toDate`, and `status`. It also employs parameterized queries to construct dynamic SQL queries safely.
    *   **11/13/2025, 11:22:34 AM:** A minor debugging `console.log` statement (`"====jhggggg@@@"`) was added within the `getReportHistory` function, likely for quick inspection of the `CompanyName` query parameter.

**Patterns and Recurring Elements:**

*   **Database Interaction:** Both files extensively use a `query` utility for interacting with a PostgreSQL database, executing `INSERT`, `UPDATE`, and `SELECT` statements.
*   **Logging:** `logger.info` and `logger.error` are consistently used for tracing execution flow, debugging parameters, and capturing errors, often serializing objects with `JSON.stringify`.
*   **Error Handling:** All main asynchronous functions are wrapped in `try...catch` blocks to handle potential errors during database operations or processing, returning `HttpStatusCodes.INTERNAL_SERVER_ERROR` in case of failure.
*   **Request/Response Handling:** The functions typically accept `IAuthReq` (authenticated request) and `IRes` (response) types, using `res.status().json()` or `res.status().send()` to send structured responses.
*   **Parameterized Queries:** `reportHistory.ts` specifically demonstrates the use of parameterized queries (`$1`, `$2`, etc.) for building dynamic SQL, which is a good practice for preventing SQL injection. While `scheduleReport.ts` uses string concatenation for query building, which is less secure, `reportHistory.ts` shows an improvement in this regard.
*   **Timestamps:** All recorded changes occurred on the same day (November 13, 2025) within a relatively short time frame, suggesting active development, refactoring, and debugging sessions.

## 11:43:09 AM
`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx` (between 11/13/2025, 9:46:03 AM and 9:46:25 AM): The page's placeholder text displayed when no customer is selected was updated for clarity, changing "view booking data" to "view planboard data".

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx` (between 11/13/2025, 9:47:43 AM and 9:51:35 AM): The `useFetchNotificationDataQuery` hook was refactored to consistently use `selectedCustomer` from the Redux global state for the `CompanyName` parameter, removing a previous fallback to `localStorage`'s `localUser?.companyname`. Debugging `console.log` statements were also removed. Minor text updates for the "no customer selected" message occurred.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx` (between 11/13/2025, 10:20:29 AM and 10:32:57 AM): A minor typo in a `SidebarLabel` was corrected. Functionality to dynamically disable sidebar menu items (by setting `href` to `undefined`, preventing default click behavior, and applying specific styling) was introduced, tested, and subsequently reverted. The component shows the `SelectCustomerPanel` only for `ADMIN_V2` roles.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts` (between 11/13/2025, 10:22:41 AM and 11:33:16 AM): This configuration file for the sidebar menu saw frequent modifications.
*   A typo in "Planbaord" was corrected to "Planboard".
*   The "Preferences" menu item's visibility was repeatedly adjusted: it was conditionally hidden for `ADMIN_V2` roles, then temporarily given a `disabled` property (which was later removed from the type definition), before settling back to being conditionally hidden (excluded from the array) for `ADMIN_V2`.
*   The "Analytics" menu item under "Reports" was consistently commented out and then uncommented, finally remaining uncommented and visible in the last change.
*   The `localUser` object is parsed from `localStorage` to determine user roles for conditional menu item rendering.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx` (between 11/13/2025, 10:52:47 AM and 11:31:18 AM): This page handles scheduling and viewing reports.
*   There were several attempts to modify how `useGetSavedReportsQuery` fetched data, oscillating between using `id`, `CompanyName`, or no specific parameters from `selectedCustomer`. It eventually stabilized to pass `CompanyName: selectedCustomer ?? undefined` to both `useGetSavedReportsQuery` and `useGetReportHistoryQuery`.
*   Conditional rendering was implemented to only display the "Recent Reports" section (or the entire page content) if a `selectedCustomer` is active, showing a "Please select a customer to view reports" message otherwise.
*   The placeholder text for the "no customer selected" message was updated from "booking" to "reports".

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\api\reports.api.ts` (between 11/13/2025, 11:00:52 AM and 11:15:55 AM): The RTK Query API slice for reports underwent significant churn specifically for the `getSavedReports` endpoint.
*   Initially, it could take `id` or `CompanyName`.
*   It was then restricted to primarily use an `id` parameter.
*   A more flexible query logic was introduced to handle `id`, `CompanyName`, or both, with URL parameter encoding.
*   This flexible logic was subsequently reverted, making the query once again dependent solely on the `id` parameter, despite `CompanyName` remaining in its type definition. This indicates an evolving and somewhat inconsistent approach to querying saved reports.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (at 11/13/2025, 11:34:25 AM): This file provides the analytics toolbar, including components for date range selection, dashboard view management, and a `downloadDashboardPDF` function. The PDF export function utilizes `jspdf` and `html2canvas-pro` to capture and generate a PDF of the dashboard, including a logo. It leverages a `useAccess` hook for permission checks on customer selection.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx` (at 11/13/2025, 11:35:56 AM): This component is responsible for arranging and managing metric boxes within the analytics dashboard using `react-dnd` for drag-and-drop. It includes functions to handle metric position (`moveItem`), size changes (`saveSize`), and view changes (`saveView`), persisting these updates via API calls. It fetches individual report data using `useLazyFetchReportQuery`.

`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx` (between 11/13/2025, 11:38:04 AM and 11:39:26 AM): This is the main analytics page.
*   The page title was corrected from "Analytics1" to "Analytics".
*   `useFetchDashboardsQuery` was updated to fetch dashboards based on the `selectedCustomer` from the global Redux state (`state.globalSlice.selectedCustomer`), rather than the component's internal `analyticSlice` state. However, subsequent calls to `fetchReport` within the `useEffect` still use `mainState.selectedCustomer`, creating a potential inconsistency in how the selected customer context is used for different API calls on this page.
*   The page displays a loader during data fetching and an alert if the user is an "ADMIN" and no customer is selected.

**Patterns and Recurring Elements:**

*   **Centralized Customer Selection**: A strong pattern observed is the continuous effort to integrate `selectedCustomer` from Redux's `globalSlice` across various pages and API calls, centralizing the customer context for data filtering and UI rendering.
*   **Conditional UI/Data Fetching**: Many components now include logic to conditionally render UI elements or trigger data fetches only when a `selectedCustomer` is available, displaying informative messages otherwise.
*   **API Endpoint Parameter Refinement**: There's a recurring theme of adjusting API query parameters (`id` vs. `CompanyName`) for different endpoints, suggesting ongoing development and alignment with backend API expectations.
*   **UI Text/Typo Corrections**: Several minor text corrections were made, indicating a focus on user experience and polish.
*   **Dynamic Menu Items**: The sidebar menu configuration frequently changes regarding the visibility and behavior of items like "Preferences" and "Analytics," often tied to user roles or development environment.
*   **Debugging via `console.log`**: Numerous `console.log` statements are present across files, indicating active debugging during these development iterations.

## 12:42:13 PM
The changes primarily involve two service files related to report management: `scheduleReport.ts` and `reportHistory.ts`.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**

*   **11/13/2025, 10:50:09 AM**: This timestamp represents the initial implementation or a significant update of functionalities for scheduling, fetching, and editing user reports.
    *   The file defines three core asynchronous functions: `setReport` (for inserting new scheduled reports into the `v2_user_reports` table), `fetchScheduledReports` (for retrieving active reports for a user, with optional filtering by ID or company name), and `editReport` (for updating existing scheduled reports).
    *   It includes a `timeZoneConverter` utility object with `getTimeByTimezone` and `getDateByTimezone` methods, demonstrating logic for converting UTC times and dates to a client's specified timezone.
    *   Database interactions are handled via direct SQL queries using string interpolation for `INSERT`, `SELECT`, and `UPDATE` operations.
*   **11/13/2025, 11:03:19 AM**: A minor modification was introduced in the `fetchScheduledReports` function. The variable `companyName` was incorrectly assigned `req.query.id` instead of `req.query.CompanyName`. A `console.log` statement was also added for debugging purposes.
*   **11/13/2025, 11:06:07 AM**: The incorrect assignment for `companyName` in `fetchScheduledReports` was promptly reverted, restoring `companyName` to `req.query.CompanyName`. The debugging `console.log` statement remained in the code.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**

*   **11/13/2025, 11:21:33 AM**: This marks the initial implementation or a major update of the report history management functionalities.
    *   The file introduces `saveReportHistory` for persisting details of executed reports into the `public.v2_report_history` table. This function uses parameterized queries (`$1`, `$2`, etc.) for safer database insertion, capturing a wide array of report parameters like user ID, report ID, name, schedule, dates, timezone, filters, and status.
    *   `getReportHistory` is defined to retrieve paginated report history for a specific user. It supports filtering by company name, report name, date range (`fromDate`, `toDate`), and status, along with sorting options. It also utilizes parameterized queries for secure data retrieval and constructs dynamic `WHERE` clauses based on provided filters.
*   **11/13/2025, 11:22:34 AM**: A debugging `console.log` statement was added within the `getReportHistory` function to output the `CompanyName` query parameter, with no functional changes to the report history logic.

**Patterns and Recurring Elements:**

*   **Database Interaction:** Both files heavily rely on direct PostgreSQL database interactions using a `query` utility. `scheduleReport.ts` primarily uses string interpolation for SQL queries, while `reportHistory.ts` adopts more secure parameterized queries, particularly for inserts and complex selects with filtering.
*   **Logging:** Extensive use of `logger.info` and `logger.error` is present across all functions for operational monitoring, debugging, and error tracking.
*   **Error Handling:** All exported functions include `try...catch` blocks, providing consistent error handling by logging the error and returning `HttpStatusCodes.INTERNAL_SERVER_ERROR`.
*   **Authentication Context:** Both services consistently access `req.user?.userid` to associate operations with the currently authenticated user.
*   **API Response Structure:** Functions generally return structured JSON responses containing `status` (e.g., 'success', 'error') and either a `message` or `data` payload, along with HTTP status codes.
*   **Debugging Statements:** The presence of `console.log` statements in multiple entries across both files suggests active development and debugging sessions.
*   **Timestamp-Based Changes:** The changes show focused modifications within short timeframes (e.g., the quick fix in `scheduleReport.ts`), indicating iterative development.

## 12:43:19 PM
The code changes primarily focus on enhancing role-based access control, refining customer-specific data filtering across various modules, and making minor UI adjustments and fixes.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\planboard\planboard-page.tsx`**
    *   **Timestamp: 11/13/2025, 9:46:03 AM & 9:46:25 AM:** A minor text change was made to the placeholder message, updating "Please select a customer to view booking data" to "Please select a customer to view planboard data" when no customer is selected. The component displays a booking planboard with year/month views, powered by Redux for selected year and view.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\notifications\notification-page.tsx`**
    *   **Timestamp: 11/13/2025, 9:47:43 AM & 9:47:50 AM:** The component handles fetching and displaying user notifications, with various icons based on notification type. It includes navigation to shipment details.
    *   **Timestamp: 11/13/2025, 9:51:35 AM:** The `useFetchNotificationDataQuery` was updated to fetch notifications based on the `selectedCustomer` from Redux or an empty string, removing reliance on `localUser?.companyname` for the API call. Debug `console.log` statements related to `localUser` were removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`**
    *   **Timestamp: 11/13/2025, 10:20:29 AM:** The sidebar displays navigation items, a logo, and a `UserCard`. It conditionally shows a `SelectCustomerPanel` for "ADMIN_V2" roles. A temporary `kk` suffix was present on a `SidebarLabel`.
    *   **Timestamp: 11/13/2025, 10:20:38 AM:** The temporary `kk` suffix from a `SidebarLabel` was removed.
    *   **Timestamp: 11/13/2025, 10:29:48 AM & 10:30:26 AM:** Functionality was added to disable sidebar items based on a `disabled` property, changing their `href` to `undefined`, preventing navigation, and applying `cursor-not-allowed opacity-50 pointer-events-none` styling. Icons and labels for disabled items were styled `text-gray-400`.
    *   **Timestamp: 11/13/2025, 10:32:57 AM:** The logic for disabling sidebar items was reverted, making all items appear as normal regardless of a `disabled` property.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts`**
    *   **Timestamp: 11/13/2025, 10:22:41 AM:** Defines the `sidebarMenu` structure, including sections for Dashboard, Shipments, Operations, Reports (with "Analytics" commented out), and Settings. A "Dev" section is conditionally added based on `VITE_MODE`.
    *   **Timestamp: 11/13/2025, 10:24:09 AM:** Introduced a `disabled` property type for sidebar items. The "Preferences" menu item was made conditional, hiding it for `admin_v2` users. The typo "Planbaord" was corrected to "Planboard".
    *   **Timestamp: 11/13/2025, 10:24:31 AM:** Reverted the conditional display of "Preferences" and the "Planboard" typo.
    *   **Timestamp: 11/13/2025, 10:26:22 AM to 10:27:09 AM:** Conditional display for "Preferences" (hiding for "ADMIN_V2" users) was re-introduced.
    *   **Timestamp: 11/13/2025, 10:28:35 AM:** The `SidebarItemType` now explicitly includes `disabled: boolean`. "Preferences" item's `disabled` flag is now set to `true` for "ADMIN_V2" roles, intending to disable it rather than hide it.
    *   **Timestamp: 11/13/2025, 10:34:59 AM to 10:38:26 AM:** The `disabled` property was removed from `SidebarItemType` and "Preferences" conditional rendering was reverted to hiding for "ADMIN_V2".
    *   **Timestamp: 11/13/2025, 10:41:03 AM:** The "Analytics" menu item under "Reports" was uncommented.
    *   **Timestamp: 11/13/2025, 10:42:13 AM:** The "Analytics" menu item was commented out again.
    *   **Timestamp: 11/13/2025, 10:50:39 AM:** The conditional display logic for "Preferences" was removed, making it always visible, and a `console.log` message was updated.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx`**
    *   **Timestamp: 11/13/2025, 10:52:47 AM:** The reports page displays saved and recent reports, supports downloading, multi-download, and editing. It filters data by `selectedCustomer`.
    *   **Timestamp: 11/13/2025, 11:02:51 AM:** The `useGetSavedReportsQuery` started filtering by `id` parameter (mapped from `selectedCustomer`).
    *   **Timestamp: 11/13/2025, 11:05:11 AM:** The `useGetSavedReportsQuery` reverted to filtering by `CompanyName`.
    *   **Timestamp: 11/13/2025, 11:10:43 AM:** The `useGetSavedReportsQuery` was temporarily called without parameters.
    *   **Timestamp: 11/13/2025, 11:11:35 AM:** The `useGetSavedReportsQuery` reverted to filtering by `CompanyName` again.
    *   **Timestamp: 11/13/2025, 11:16:50 AM:** The `params` state for `useGetReportHistoryQuery` now includes `CompanyName` for filtering.
    *   **Timestamp: 11/13/2025, 11:18:17 AM & 11:18:40 AM:** The parameters for `useGetReportHistoryQuery` were modified, initially wrapping `params` and then adding `CompanyName` directly.
    *   **Timestamp: 11/13/2025, 11:24:23 AM:** `useGetSavedReportsQuery` was again called without parameters, and `CompanyName` for `useGetReportHistoryQuery` was explicitly set using `selectedCustomer ?? undefined`.
    *   **Timestamp: 11/13/2025, 11:25:27 AM:** Temporary conditional rendering for "Recent Reports" using an `<h2>kkkkk</h2>` placeholder was introduced if no `selectedCustomer`.
    *   **Timestamp: 11/13/2025, 11:26:18 AM to 11:26:41 AM:** The temporary `<h2>kkkkk</h2>` was removed, and the entire "Recent Reports" card became conditionally rendered based on `selectedCustomer`.
    *   **Timestamp: 11/13/2025, 11:29:47 AM to 11:31:18 AM:** The main page content became conditionally rendered. If no `selectedCustomer` is present, a message "Please select a customer to view reports" is displayed, otherwise the full report page content loads. The exact wording of this message was refined multiple times.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\api\reports.api.ts`**
    *   **Timestamp: 11/13/2025, 11:00:52 AM:** The `getSavedReports` query initially supported both `id` and `CompanyName` parameters.
    *   **Timestamp: 11/13/2025, 11:01:33 AM & 11:05:32 AM:** The `getSavedReports` query logic was simplified to only use the `id` parameter, even though `CompanyName` was still defined in its type. A `console.log` was temporarily added for debugging.
    *   **Timestamp: 11/13/2025, 11:10:08 AM & 11:10:35 AM:** Debug `console.log` was added and then removed. The `CompanyName` type parameter was removed from `getSavedReports`.
    *   **Timestamp: 11/13/2025, 11:13:39 AM:** The `getSavedReports` query logic was comprehensively updated to handle `id` and `CompanyName` parameters (individually or together) for fetching saved reports.
    *   **Timestamp: 11/13/2025, 11:15:55 AM:** This complex logic was reverted, and `getSavedReports` went back to filtering only by `id`, while `CompanyName` was again present in the type definition but unused.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **Timestamp: 11/13/2025, 11:34:25 AM to 11:43:27 AM:** This component provides controls for analytics dashboards, including date filters and custom view management. It features a PDF download function for the dashboard (`#metric-board`) using `html2canvas-pro` and `jspdf`, including logo integration. `permission.selectCustomer` is logged. No significant code changes occurred within this time range.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx`**
    *   **Timestamp: 11/13/2025, 11:35:56 AM:** The component manages resizable and draggable metric boxes, saving size and order changes to the API. It fetches single report data with various filters. It uses `settingsState` from `state.settingSlice`.
    *   **Timestamp: 11/13/2025, 11:47:36 AM:** The Redux selector for `settingsState` was changed from `state.settingSlice` to `state.userSettings`.
    *   **Timestamp: 11/13/2025, 11:51:47 AM:** The Redux selector for `settingsState` was reverted from `state.userSettings` back to `state.settings`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 11/13/2025, 11:38:04 AM:** The main analytics page fetches dashboards, endpoints, and metrics. It shows an alert for "ADMIN" roles if no `mainState.selectedCustomer` is selected. The `h1` title was "Analytics1".
    *   **Timestamp: 11/13/2025, 11:38:14 AM:** The `h1` title was corrected from "Analytics1" to "Analytics".
    *   **Timestamp: 11/13/2025, 11:39:26 AM:** API calls (`useFetchDashboardsQuery`, `fetchEndpoints`, `fetchReport`) were updated to consistently use `selectedCustomer` from `globalSlice` for company-based filtering.
    *   **Timestamp: 11/13/2025, 11:45:05 AM:** The alert condition for missing customer was updated to specifically target "ADMIN_V2" roles, still using `!mainState.selectedCustomer`.
    *   **Timestamp: 11/13/2025, 11:45:16 AM & 11:46:42 AM:** The alert condition was further refined to use `!selectedCustomer` from `globalSlice`.
    *   **Timestamp: 11/13/2025, 12:31:26 PM:** `AnalyticsContainer` was temporarily commented out, and `AnalyticsToolbar` was rendered in its place (likely for debugging).
    *   **Timestamp: 11/13/2025, 12:34:20 PM & 12:34:40 PM:** API calls for `fetchReport` and `fetchEndpoints` were consistently updated to use `selectedCustomer` for company filtering, resolving potential inconsistencies.
    *   **Timestamp: 11/13/2025, 12:37:37 PM & 12:38:12 PM:** The temporary rendering of `AnalyticsToolbar` was reverted, and `AnalyticsContainer` was restored.
    *   **Timestamp: 11/13/2025, 12:42:07 PM:** A local `isLoading` state was introduced, although its updates are not shown in this log.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\hooks\useAccess.tsx`**
    *   **Timestamp: 11/13/2025, 12:00:13 PM:** This hook provides role-based permissions (`AGENT`, `CUSTOMER`, `ADMIN`, `ADMIN_V2`) by parsing the user role from `localStorage`. It explicitly defines various access flags for each role.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **Timestamp: 11/13/2025, 12:40:43 PM:** This Redux slice manages the `selectedCustomer` global state, persisting it to and loading it from `localStorage`.

**Patterns and Recurring Elements:**

*   **Customer Context:** A dominant pattern is the strong dependency on `selectedCustomer` (managed in `global-slice.ts` and persisted in `localStorage`). Components like `PlanboardPage`, `Notifications`, `ReportPage`, `AnalyticsScreen`, `AnalyticsToolbar`, and `AnalyticsContainer` all use `selectedCustomer` to filter data, enable features, or display conditional messages. There's a consistent effort to ensure API calls correctly pass this customer context.
*   **Role-Based Access Control (RBAC):** The `useAccess` hook explicitly defines permissions for different user roles (e.g., "ADMIN_V2", "CUSTOMER"). This RBAC is applied in `sidebar.tsx` for menu item visibility/interactivity and in `analytics-page.tsx` for displaying specific alerts.
*   **Redux for State Management:** All significant frontend components and API definitions (`reports.api.ts`) leverage Redux Toolkit for state management, demonstrating a centralized approach to application state.
*   **API Query Refinements:** There are numerous, iterative changes to the parameters passed to RTK Query hooks (e.g., `useGetSavedReportsQuery`, `useGetReportHistoryQuery`) for filtering by `id`, `CompanyName`, or other criteria, indicating active development and fine-tuning of API interactions.
*   **Minor UI/UX Adjustments:** Frequent small changes to placeholder texts, console logs, and temporary rendering choices (`kkkkk`, commented-out components) suggest ongoing debugging and iterative UI development.
*   **Timestamp Focus:** The timestamps indicate a period of active development and refinement across related frontend modules, with changes often cascading between component logic, Redux state, and API parameter handling.

## 3:05:18 PM
The provided logs detail a series of changes across several frontend application files, primarily focusing on user interface, data fetching, and state management related to reports and analytics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\menu.ts`** (Timestamps: 11/13/2025, 10:42:13 AM; 10:50:39 AM; 11:33:16 AM; 12:59:26 PM; 1:01:58 PM)
    *   **Initial Change (10:42:13 AM):** Introduced role-based rendering for sidebar menu items by checking `userRole === "ADMIN_V2"` to conditionally render "Preferences". It also added a "Dev" section for `VITE_MODE === 'DEV'`.
    *   **Refinement (10:50:39 AM):** The `userRole` condition for "Preferences" was removed, making it always visible. The `console.log` message for `localUser` was simplified.
    *   **Restoration and Expansion (11:33:16 AM, 12:59:26 PM):** The commented-out "Analytics" item under "Reports" was uncommented and re-added to the sidebar. There was no functional change between these two timestamps.
    *   **Adding `disabled` Property (1:01:58 PM):** A `disabled` property was added to `SidebarItemType`. The "Preferences" menu item's `disabled` status is now set based on `userRole === "ADMIN_V2"`, explicitly disabling it for admin users.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\reports\report-page.tsx`** (Timestamps: 11/13/2025, 10:52:47 AM; 11:01:17 AM; 11:02:51 AM; 11:05:11 AM; 11:05:38 AM; 11:10:43 AM; 11:11:35 AM; 11:16:50 AM; 11:18:17 AM; 11:18:40 AM; 11:24:23 AM; 11:25:27 AM; 11:26:18 AM; 11:26:25 AM; 11:26:41 AM; 11:29:47 AM; 11:30:50 AM; 11:31:18 AM)
    *   These changes predominantly revolve around integrating `selectedCustomer` from the Redux global slice into report fetching queries and refining UI rendering based on customer selection.
    *   **Initial Integration (10:52:47 AM):** `selectedCustomer` is retrieved from Redux state. The `useGetSavedReportsQuery` now takes `CompanyName: selectedCustomer` as a parameter.
    *   **Parameter Changes for `useGetSavedReportsQuery` (11:01:17 AM to 11:11:35 AM):** The query for `useGetSavedReportsQuery` was toggled between `{CompanyName: selectedCustomer}` and `{id: selectedCustomer ?? undefined}` and then back to `{CompanyName: selectedCustomer ?? undefined}`.
    *   **Updates to `useGetReportHistoryQuery` (11:16:50 AM to 11:24:23 AM):** The `params` for `useGetReportHistoryQuery` were updated to include `CompanyName: selectedCustomer ?? undefined`. Later, this was restructured to pass `params` and `CompanyName` as separate arguments.
    *   **Conditional Rendering for Recent Reports (11:25:27 AM - 11:31:18 AM):** Introduced conditional rendering for the "Recent Reports" table. It initially renders "No report created yet" or a placeholder if `selectedCustomer` is null/undefined. This evolved into displaying a message "Please select a customer to view booking" or "Please select a customer to view reports" within a `div` when `selectedCustomer` is not set for `ADMIN_V2` roles, otherwise rendering the `AnalyticsContainer`. The `isLoading` state was also used for conditional rendering of a `Loader` within this section.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\api\reports.api.ts`** (Timestamps: 11/13/2025, 11:00:52 AM; 11:01:33 AM; 11:05:32 AM; 11:10:08 AM; 11:10:35 AM; 11:13:39 AM; 11:15:55 AM)
    *   These logs show changes primarily to the `getSavedReports` query endpoint.
    *   **Flexible Query Parameters (11:00:52 AM - 11:13:39 AM):** The `getSavedReports` query initially supported `id` and `CompanyName` parameters, building a URL dynamically. This was then restricted to only `id` or no parameters, then back to allowing both `id` and `CompanyName`, with `CompanyName` being URL-encoded.
    *   **Reversion (11:15:55 AM):** The query for `getSavedReports` was reverted to only support an `id` parameter, or no parameters.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`** (Timestamps: 11/13/2025, 11:34:25 AM; 11:43:01 AM; 11:43:27 AM; 12:44:23 PM)
    *   Minor console log additions (`console.log("===permision", permission); console.log("===permision1234", permission.selectCustomer);`). No significant functional changes beyond this are visible in the provided diffs. The PDF download function remains consistent.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx`** (Timestamps: 11/13/2025, 11:35:56 AM; 11:47:36 AM; 11:51:47 AM)
    *   **State Access Change (11:47:36 AM):** The `settingsState` was updated to `state.userSettings` from `state.settingSlice`. This was then reverted back to `state.settings` in a subsequent commit.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`** (Timestamps: 11/13/2025, 11:38:04 AM to 2:16:50 PM)
    *   A large number of changes, all within the same page.
    *   **Customer Integration for API Calls (11:39:26 AM onwards):** `selectedCustomer` from `globalSlice` is now consistently used in `useFetchDashboardsQuery` and `fetchEndpoints` for API calls.
    *   **Conditional Rendering Logic (11:38:04 AM - 1:09:50 PM):** The page initially displayed an `Alert` for `ADMIN` roles if no customer was selected. This evolved to target `ADMIN_V2` roles specifically, showing a message "Please Select Any Customer" if `selectedCustomer` is not set. The rendering of `AnalyticsContainer` or `AnalyticsToolbar` (a temporary change) was conditional on `selectedCustomer` and `isLoading`.
    *   **Styling for Alert (1:05:12 PM - 2:09:50 PM):** The styling of the `Alert` component changed from generic `color="red"` or `color="black", background:"none"`, or `background:"gray"`, to using `BsInfoCircle` icon and a `h2` tag within a flex container for better visual presentation.
    *   **Loading State Refinement (2:15:36 PM - 2:16:50 PM):** The local `isLoading` state was integrated to control the display of a `Loader` component both when fetching reports (within `fetchAllReports`) and for the initial `ADMIN_V2` customer selection state.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\hooks\useAccess.tsx`** (Timestamp: 11/13/2025, 12:00:13 PM)
    *   Modified permission structure. Specifically, for `ADMIN` and `ADMIN_V2` roles, `selectCustomer` was added as a new permission and set to `true`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`** (Timestamp: 11/13/2025, 12:40:43 PM)
    *   Introduced a new Redux slice (`globalSlice`) to manage `selectedCustomer` in the application state. It includes reducers `setSelectedCustomer` (to update and persist to `localStorage`) and `initializeSelectedCustomer` (to load from `localStorage`).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`** (Timestamp: 11/13/2025, 1:02:29 PM; 2:38:33 PM)
    *   **Customer Selection Integration (1:02:29 PM):** Imported `SelectCustomerPanel` and integrated it into the sidebar for `ADMIN_V2` users, allowing them to select a customer which updates the `selectedCustomer` in the global state.
    *   The `SelectCustomerPanel` import path was simplified from `"SelectCustomer"` to the relative path `"../SelectCustomer"` likely indicating a file move or restructure, and then back to `"SelectCustomer"` implying the file is expected at the root of a common component directory or aliased.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`** (Timestamps: 11/13/2025, 2:21:09 PM to 2:54:42 PM)
    *   This is a new component `SelectCustomerPanel` responsible for customer selection.
    *   **Core Functionality:** Implements a dropdown with search and pagination for selecting customers. It debounces search input, fetches paginated customer options from an API (`ApiManager.getPaginatedCompanyOptions`), and dispatches the `setSelectedCustomer` action to update the Redux store.
    *   **Dropdown Closure Handling:** Multiple iterations focused on correctly closing the dropdown after selection or clear-all. Attempts included `document.body.click()`, explicitly managing `isOpen` state, and refining `stopPropagation` for various interactive elements within the dropdown to prevent unintended closures or actions. The final visible state (2:54:42 PM) has removed some `stopPropagation` calls from the outer dropdown content to rely on the default dropdown behavior or other explicit closing mechanisms.

**Patterns and Recurring Elements:**

1.  **Redux Integration (`react-redux`, `useSelector`, `useDispatch`):** A strong pattern of using Redux for state management is observed across multiple files, especially for `selectedCustomer` and analytics-related states. The `global-slice.ts` was introduced to centralize customer selection.
2.  **Role-Based Access Control:** Logic for user roles (e.g., `ADMIN_V2`, `CUSTOMER`) is prevalent, affecting UI elements (sidebar menu item `disabled` state, conditional display of customer selection panels) and API request parameters.
3.  **API Interaction (`@reduxjs/toolkit/query/react`, `useQuery`, `useMutation`, `useLazyQuery`):** RTK Query is consistently used for data fetching and mutations, with a `reportsApi` and `analytics-api`. Query parameters often include `companyname`, `access` (user role), and pagination (`page`, `limit`).
4.  **`selectedCustomer` Prop/State:** The `selectedCustomer` value, initially managed within analytics-page and then moved to a global Redux slice, is a critical piece of state that dictates data fetching and UI presentation across `ReportPage`, `AnalyticsScreen`, and `SelectCustomerPanel`.
5.  **Conditional UI Rendering:** Many components use conditional rendering based on `user.role` and the presence of `selectedCustomer` (e.g., showing an alert for `ADMIN_V2` if no customer is chosen, or enabling/disabling menu items).
6.  **UI Components & Styling:** Heavy reliance on custom components (`PageWrapper`, `AppTable`, `Card`, `Button`, `InputBox`, `Dropdown`) and utility libraries (`clsx`, `moment`, `lodash.debounce`) for UI structure and styling.
7.  **`console.log` for Debugging:** Numerous `console.log` statements with descriptive prefixes (e.g., `==localuser`, `==selectedCustomer`, `reportHistory-`) are present, indicating active debugging during development.
8.  **Excel/PDF Generation:** Functions for generating Excel (`generateExcel`, `headerFilter`) and PDF reports (`jsPDF`, `html2canvas-pro`) are present in `ReportPage` and `AnalyticsToolbar`, respectively, for data export.
9.  **Timestamp Recurrence:** The timestamp "11/13/2025" appears across all logs, suggesting all these changes occurred on the same day in a very active development session. The times span from 10:42 AM to 2:54 PM.

In summary, the changes highlight a concerted effort to introduce and refine customer-specific data views and reporting capabilities within the application, particularly for `ADMIN_V2` users, while also enhancing UI interactions and state management for improved user experience and data handling.

## 5:09:43 PM
The provided log details a series of code changes across several service files, all occurring on November 13, 2025, indicating a concentrated development effort.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\scheduleReport.ts`**
    *   **Timestamp:** 11/13/2025, 10:50:09 AM - Introduced functionality to schedule, fetch, and edit user-defined reports (`setReport`, `fetchScheduledReports`, `editReport`). Includes a `timeZoneConverter` utility. SQL queries are constructed using direct string concatenation.
    *   **Timestamp:** 11/13/2025, 11:03:19 AM - A bug was introduced in `fetchScheduledReports` where `companyName` was incorrectly assigned from `req.query.id`. A `console.log` was added for debugging.
    *   **Timestamp:** 11/13/2025, 11:06:07 AM - The bug in `fetchScheduledReports` was quickly reverted, restoring the correct assignment of `companyName` from `req.query.CompanyName`. The `console.log` remained.
    *   **Timestamp:** 11/13/2025, 3:14:00 PM - No functional code changes; likely a re-save.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\reportHistory.ts`**
    *   **Timestamp:** 11/13/2025, 11:21:33 AM - Implemented `saveReportHistory` and `getReportHistory` functions. `saveReportHistory` stores report execution details (e.g., user ID, report ID, filters, status). `getReportHistory` fetches historical report data with support for pagination, sorting, and filtering by user, company name, report name, date range, and status. Notably, this file uses parameterized SQL queries (`$1, $2, ...`) for database interactions.
    *   **Timestamp:** 11/13/2025, 11:22:34 AM - A `console.log` statement was temporarily added in `getReportHistory`.
    *   **Timestamp:** 11/13/2025, 3:13:42 PM - The temporary `console.log` statement in `getReportHistory` was removed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamp:** 11/13/2025, 2:56:24 PM - Initial version for `getDashboardCardInfo` (retrieves summary stats like pending departures, in-transit shipments, ETA within 1 week, out for delivery) and `getDeliveryData` (fetches delivery and vessel arrival details). Queries concatenate company name directly into SQL.
    *   **Timestamp:** 11/13/2025, 2:56:43 PM - Refinements were made to `getDeliveryData`, specifically to the `sqlQueryDelivery` for filtering and adding a user-specific `useWhere` condition.
    *   **Timestamp:** 11/13/2025, 2:58:05 PM - The logic for applying `companyFilter` in `getDeliveryData` was modified to conditionally use a specific `CompanyName` filter or the general `useWhere` user condition.
    *   **Timestamp:** 11/13/2025, 2:59:21 PM - The explicit `CompanyName` filter in `getDashboardCardInfo`'s `baseQuery` was removed.
    *   **Timestamp:** 11/13/2025, 3:04:35 PM - The `CompanyName` filter was re-introduced and improved in `getDashboardCardInfo`'s `conditions`, ensuring consistent application of user-specific conditions (`useWhere`). Logger information was also slightly adjusted.
    *   **Timestamp:** 11/13/2025, 3:05:15 PM - Removed a `console.log` statement.
    *   **Timestamp:** 11/13/2025, 3:05:33 PM - Removed a `console.log` statement from `getDeliveryData`'s error handling.
    *   **Timestamp:** 11/13/2025, 3:07:52 PM - Removed another `console.log` statement.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamp:** 11/13/2025, 3:06:59 PM - Introduced a `BookingQueryBuilder` class to modularize dynamic SQL query construction for booking data, supporting various filters, statuses, and pagination. User role-based filtering (`ADMIN`, `CUSTOMER`, `AGENT`) is applied. SQL queries are built using string concatenation.
    *   **Timestamp:** 11/13/2025, 4:46:10 PM - Changed `queryBuilder.addFilterClause` to `queryBuilder.addSearchClause` for `abe.customer` in `getAll`, altering `CompanyName` filtering from an exact match to a `LIKE` search.
    *   **Timestamp:** 11/13/2025, 4:59:17 PM - Refactored `BookingQueryBuilder` to include an optional `companyName` parameter in its constructor, enabling 'ADMIN' and 'ADMIN_V2' roles to fetch bookings for specific companies, overriding the default `1=1` condition.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\planbaordService.ts`**
    *   **Timestamp:** 11/13/2025, 3:08:39 PM - Added `getAllBookingPlanbaord` to retrieve and format booking data for a plan board view, allowing grouping by month or week, and sub-grouping points by `pod`. It incorporates user-specific company filtering. SQL queries use direct string concatenation.
    *   **Timestamp:** 11/13/2025, 3:09:00 PM - No functional code changes; likely a re-save.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp:** 11/13/2025, 3:57:57 PM - New file introduced, containing `bookingQueryBuilder`. This function generates complex SQL for analytics related to booking performance, such as time difference between booking and actual departure, often aggregated for charting. SQL queries are built via string concatenation.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp:** 11/13/2025, 3:10:59 PM - Major refactoring and introduction of a robust `SqlQueryBuilder` class for `shipmentService`. This class supports flexible filtering by transportation mode (ocean/air), various shipment statuses (pending, in-transit, ETA within 1 week, out for delivery), user roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT), date ranges, and specific shipment details. It employs parameterized queries (`$$` placeholders converted to `$N`) for enhanced security. Special conditions for "ZIGI USA, LLC" are hardcoded within user conditions.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\company-details-service.ts`**
    *   **Timestamp:** 11/13/2025, 3:12:03 PM - Reworked `getAllCompanyDetails` to fetch distinct company names based on user role (`AGENT` or `CUSTOMER`). For `CUSTOMER`, it adds pagination support and uses parameterized queries.
    *   **Timestamp:** 11/13/2025, 3:12:38 PM - Minor code style update, changing logical OR (`||`) to nullish coalescing (`??`) for assigning default pagination values.

**Patterns and Recurring Elements:**

*   **Unified Timestamp:** All changes are recorded on 11/13/2025, indicating a single concentrated development and commit window.
*   **Logging:** Extensive use of `logger.info` and `logger.error` is present across all files for debugging and tracing application flow and errors. Temporary `console.log` statements are frequently added and then removed, suggesting an active debugging process.
*   **SQL Query Construction:** A clear divergence in SQL query construction strategies is evident:
    *   Several services (`scheduleReport.ts`, `dashboardService.ts`, `planbaordService.ts`, `booking.query.ts`) rely heavily on **direct string concatenation** for building SQL queries, which is susceptible to SQL injection vulnerabilities.
    *   In contrast, `reportHistory.ts` and the refactored `shipmentService.ts` utilize **parameterized queries** (`$N` or `$$` placeholders), demonstrating a more secure approach to database interaction.
*   **Company-Specific Filtering:** Filtering data by `CompanyName` or `account_name` is a critical and recurring requirement across most services, often implemented with `LOWER(TRIM(...))` for case-insensitive matching. The application of these filters sometimes depends on the user's role or the presence of a specific query parameter.
*   **Pagination and Sorting:** Features for pagination and sorting of results are consistently implemented in services that retrieve lists of data, such as `reportHistory.ts`, `bookingService.ts`, and `company-details-service.ts`.
*   **Role-Based Access Control:** User roles (`ADMIN`, `CUSTOMER`, `AGENT`, `FRONTOFFICE`) play a significant role in determining data visibility and filtering logic, especially in `bookingService.ts` and `shipmentService.ts`.
*   **Code Refinements:** There are instances of quick bug fixes (e.g., in `scheduleReport.ts`) and iterative improvements to query logic (e.g., in `dashboardService.ts` and `bookingService.ts`), along with larger refactorings (e.g., `shipmentService.ts`).

## 6:40:05 PM
The codebase reflects recent development activity focused on enhancing user experience, data fetching, and state management, particularly around customer selection and dashboard functionalities.

### File-Specific Updates:

*   **`src\components\core\layout.tsx`**
    *   **Timestamp: 11/13/2025, 4:31:01 PM** - Introduced Redux `selectedCustomer` state. The main application content (`<Outlet />`) is now conditionally rendered: it appears only if a customer is selected. Otherwise, a "Please select a customer" message is displayed.
    *   **Timestamp: 11/13/2025, 4:38:13 PM** - Further refined the styling and message of the "Please select a customer" placeholder, including a `BsInfoCircle` icon.
    *   **Timestamp: 11/13/2025, 5:52:44 PM** - No functional changes.
    *   This component also handles user authentication by checking token expiry and redirecting to the login page if the token is invalid or expired.

*   **`src\components\core\sidebar.tsx`**
    *   **Timestamp: 11/13/2025, 4:26:07 PM** - Added conditional rendering for the sidebar menu: for `ADMIN_V2` users, the menu would be hidden if no customer was selected, showing a placeholder message.
    *   **Timestamp: 11/13/2025, 4:33:08 PM** - This conditional rendering logic was reverted, meaning the sidebar menu now always displays for `ADMIN_V2` users, even without a customer selected, alongside the `SelectCustomerPanel`.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **Timestamp: 11/13/2025, 3:16:47 PM** - Contains advanced PDF export functionality using `jspdf` and `html2canvas-pro`, including logic for image processing and centering content. It also manages date range filters and dashboard selections, integrating with Redux for state updates.

*   **`src\components\screen\booking\booking-dashboard.tsx`**
    *   **Timestamp: 11/13/2025, 4:27:00 PM** - Removed the top-level conditional rendering that previously hid the entire booking dashboard if no customer was selected.
    *   **Timestamp: 11/13/2025, 4:50:11 PM** - Modified the `CompanyName` parameter in the `useFetchBookingDashboardDataQuery` to use `selectedCustomer || ""`.
    *   **Timestamp: 11/13/2025, 5:53:52 PM** - Adjusted the `CompanyName` fallback in `useFetchBookingDashboardDataQuery` from `""` to `undefined`. This page now relies on the `Layout` component to handle the "select customer" message if `selectedCustomer` is null.

*   **`src\components\screen\planboard\PlanboardCardView.tsx`**
    *   **Timestamp: 11/13/2025, 3:18:22 PM** - Displays booking planboard data in either year or month view, with filtering and modal integration. No functional changes observed between the two log entries for this file.

*   **`src\config\menu.ts`**
    *   **Timestamp: 11/13/2025, 3:18:43 PM** - Defines the application's sidebar navigation structure. Notably, the "Preferences" menu item is disabled for users with the "ADMIN\_V2" role. A "Dev" section is conditionally included based on the `VITE_MODE` environment variable.

*   **`src\pages\dashboard\dashboard-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:54:28 PM** - Updated data fetching queries (`useFetchDeliveryDataQuery`) to use `CompanyName: selectedCustomer || undefined`. This change removes a direct reliance on `localUser?.companyname` fallback for these specific API calls. The `localUser` variable was also re-introduced.

*   **`src\pages\planboard\planboard-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:42:25 PM** - Removed the top-level conditional rendering that previously hid the entire planboard page if no customer was selected, allowing the layout to handle it.

*   **`src\pages\reports\report-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:41:46 PM** - Removed the top-level conditional rendering for displaying report content only if a customer is selected. The page now directly renders its structure, relying on parent components (like `Layout`) for customer selection messages.

*   **`src\pages\shipment\shipment-container-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:49:14 PM** - Adjusted `CompanyName` fallback in `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` to `selectedCustomer || undefined`, similar to other data fetching components. This also implies the page relies on the `Layout` to display a message if no customer is selected.

*   **`src\pages\shipment\shipment-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:48:09 PM** - Modified the `CompanyName` parameter in `useFetchShipmentDataQuery` and `useFetchShipmentCardDataQuery` to use `selectedCustomer || undefined`.

*   **`src\data\options\global.ts`**
    *   **Timestamp: 11/13/2025, 3:23:24 PM** - This file consistently defines various status types and filter options (e.g., `SHIPMENT_STATUS`, `BOOKING_DASHBOARD_STATUS`, `DATE_FILTER_OPTIONS`, `BOOKING_SORT_OPTIONS`) used across the application. No functional changes between the two log entries for this file.

*   **`src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:01:30 PM** - Introduced conditional rendering to display a "Please Select Any Customer" message specifically for "ADMIN\_V2" users if `selectedCustomer` is not set.
    *   **Timestamp: 11/13/2025, 5:03:22 PM** - Added `!selectedCustomer` to the dependency array for fetching reports, ensuring reports are only fetched when a customer is selected. Adjusted `companyname` in API queries to use `selectedCustomer`.
    *   **Timestamp: 11/13/2025, 5:06:27 PM** - Re-enabled loading dispatch calls within `fetchAllReports` and changed `setLoading` import to `global-slice`. Removed local `isLoading` state.
    *   **Timestamp: 11/13/2025, 5:19:33 PM** - Refined the conditional rendering for "ADMIN\_V2" users: if no customer is selected, a "Please select any customer" message is shown; otherwise, `AnalyticsContainer` (potentially with a loading spinner) is displayed.
    *   **Timestamp: 11/13/2025, 5:35:37 PM** - The data fetching `useEffect` now includes a more explicit guard condition: `if (!user?.userid || !mainState.selectedDashobard) return;`, omitting `!selectedCustomer` from the guard, indicating `selectedCustomer` is handled within the query or other conditions.

*   **`src\store\fretures\global-slice.ts`**
    *   **Timestamp: 11/13/2025, 5:05:40 PM** - Created a new Redux slice to manage global state, specifically `selectedCustomer` (persisted in `localStorage`) and a `loading` boolean flag. This provides a centralized mechanism for managing customer context across the application.

*   **`src\pages\notifications\notification-page.tsx`**
    *   **Timestamp: 11/13/2025, 5:38:36 PM** - Refactored the notification rendering logic into a dedicated function `renderNotificationList`. The loading placeholder count was adjusted from `limit` to `3`. Direct navigation using `useNavigate` replaced `Link` components.
    *   **Timestamp: 11/13/2025, 5:40:54 PM** - No functional changes.

### Patterns and Recurring Elements:

1.  **Centralized Customer Selection:** A dominant pattern is the management of `selectedCustomer` via a Redux `globalSlice`. This `selectedCustomer` state is consumed by almost all data-intensive components to filter API calls (`CompanyName: selectedCustomer || ...`) and is crucial for rendering relevant data.
2.  **Top-Level Conditional Rendering:** Many page components (`BookingDashboard`, `PlanboardPage`, `ReportPage`, `ShipmentContainerPage`, `ShipmentPage`) initially had their entire content conditionally rendered based on `selectedCustomer`. However, this was largely refactored. The `Layout.tsx` component now enforces this higher-level conditional rendering, displaying a generic "Please select a customer" message if `selectedCustomer` is null, effectively offloading this responsibility from individual pages, making them simpler.
3.  **Redux Integration:** Extensive use of `useSelector` and `useDispatch` is evident, indicating a strong adherence to Redux for global and feature-specific state management.
4.  **RTK Query for Data Fetching:** All listed pages utilize `useFetch...Query` or `useLazyFetch...Query` hooks from RTK Query for efficient and centralized data management, often including `selectedCustomer` in their query parameters.
5.  **Loading Indicators:** The use of `isLoading` and `isFetching` flags (from RTK Query and local states) to display `Loader` or `Spinner` components is widespread, improving user feedback during data retrieval.
6.  **UI Component Consistency:** Reusable UI components from `@components/common` and `@components/kit` (e.g., `PageWrapper`, `Card`, `Button`, `AppGrid`, `FilterSidebar`, `BaseModal`) are consistently used across different pages, ensuring a cohesive design.
7.  **Date and Filter Controls:** Components like `AnalyticsToolbar`, `DashboardPage`, `ShipmentPage`, and `ShipmentContainerPage` include sophisticated date period selectors and filter sidebars to refine data views.