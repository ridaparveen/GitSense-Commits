# Activity Summary for 11/27/2025

## 6:29:57 AM
The code changes primarily involve two files: `hblEntry.controller.ts` and `hblEntry.route.ts`, all occurring on 11/26/2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial State (12:21 PM - 1:00 PM):** The `createHblMasterBooking` function was primarily set up for inserting new HBL (House Bill of Lading) master bookings and related sub-entities (vessel, HBL details, routing, containers, POs) into a database, utilizing transactions (`BEGIN`, `COMMIT`, `ROLLBACK`). It included extensive data sanitization using `sanitizeString` and date formatting using `AppDateFormate`. A `bookingInsertQuery` object was created for `hbl_master` insertion, but initially contained a syntax error (`booking_id: payload.agent_booking_id,,`) and had `bookingdate` commented out. The `saveHblBooking` function was present, designed for updates, and included logic to fetch existing booking details, but its actual update implementation was truncated in the logs.
    *   **Functional Improvements (2:32 PM):** The syntax error in `booking_id` within `bookingInsertQuery` was corrected, and the `bookingdate` field was uncommented. A new field, `transport_mode`, was added to the `bookingInsertQuery` for `hbl_master` table.
    *   **Refactoring for Upsert Logic (4:41 PM - 6:04 PM):**
        *   The `createHblMasterBooking` function was significantly refactored to handle both creation and updating of HBL master records.
        *   Conditional logic was introduced to check for `serial_id` (initially from `req.query`, later changed to `req.body`). If `serial_id` is present, the function attempts to update existing records; otherwise, it inserts new ones.
        *   The `updateQuery` function was correctly applied to `hbl_master` and `agent_booking_vessel` tables when `serial_id` is provided, using `serial_id` or `hbl_master_id` for the update condition.
        *   A recurring pattern observed in this refactoring was that even within the `if (serial_id)` (update) block, the `agent_booking_hbl` details continued to use `insertQuery` rather than `updateQuery`, suggesting a potential ongoing bug or design choice for this specific sub-entity. Similarly, `insertMany` was consistently used for `routingList`, `containerList`, and `basicPoList` in both create and update paths, implying these lists are always new or replaced rather than updated incrementally.
        *   There was a brief regression (4:55:51 PM) where the `if (serial_id)` block became empty, causing all operations to default to insertions, but this was quickly corrected in subsequent commits.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **New Route Added (2:49 PM):** A new POST route, `"/create"`, was added, mapping to the `createHblMasterBooking` controller function. Existing routes for `saveHblBooking`, `fetchHblFormDetails`, and `getHbl` remained unchanged.

**Timestamps of Significant Changes:**

*   **11/26/2025, 2:32:34 PM:** Corrected minor syntax errors and added `transport_mode` in `hblEntry.controller.ts`.
*   **11/26/2025, 2:49:43 PM:** Introduced the new `"/create"` route in `hblEntry.route.ts`.
*   **11/26/2025, 4:41:31 PM:** First major attempt to implement upsert logic in `createHblMasterBooking` using `req.query.serial_id`.
*   **11/26/2025, 4:55:19 PM:** Fixed the `updateQuery` for `agent_booking_vessel` within the upsert logic.
*   **11/26/2025, 5:05:17 PM:** Corrected a temporary regression in the upsert logic, restoring the conditional update/insert flow.
*   **11/26/2025, 5:47:24 PM:** Changed `serial_id` retrieval from `req.query` to `req.body` in `createHblMasterBooking`.

**Patterns or Recurring Elements:**

*   **Consistent Data Handling:** The use of `sanitizeString` for almost all string inputs and `AppDateFormate` for dates is a recurring pattern, indicating an emphasis on data integrity and format consistency.
*   **Transactional Database Operations:** All database modifications are wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` commands, ensuring atomicity of operations.
*   **Modular Database Interactions:** The code consistently uses helper functions like `insertQuery`, `updateQuery`, and `insertMany` from `../config/database`, abstracting raw SQL queries.
*   **Error Handling:** `HttpError` and `logger.error` are consistently used within `try...catch` blocks for error management.
*   **Duplication in Logic:** There's a notable pattern of duplicating the `insertMany` calls for `routingList`, `containerList`, and `basicPoList` in both the "create" and "update" branches of the `createHblMasterBooking` function, suggesting these sub-lists might always be treated as new insertions rather than updates. Also, the `agent_booking_hbl` table consistently uses `insertQuery` even in the update path.

## 9:49:22 AM
The log details a concentrated period of development on November 26, 2025, primarily focused on enhancing the House Bill of Lading (HBL) feature and related booking functionalities within the T360_Api frontend.

### File-Specific Updates and Significant Changes:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
*   **11/26/2025, 2:53:21 PM:** This update significantly expands the `agentBookingApi` by introducing several new Redux Toolkit Query endpoints. Key additions include:
    *   `fetchBookingFormDetails` query.
    *   ISF (Importer Security Filing) XML-related mutations: `isfDescXmlCreate` and `isfDescXmlUpload`.
    *   Booking XML generation and upload mutations: `createBookingXml` and `uploadBookingXml`.
    *   HBL (House Bill of Lading) specific endpoints: `saveHblBooking` (POST), `fetchHblBookingFormDetails` (GET), and `getHblDashboard` (GET).
    *   `updateCarrierBooking` and `updateDo` mutations, likely for modifying booking details.
    *   An `exportSprReport` query.
    *   The `tagTypes` array was updated to include `'FormDetails'`, and the exported hooks were expanded to include all newly defined endpoints.
*   **11/26/2025, 5:48:11 PM:** A minor but specific change to the `saveHblBooking` mutation's URL, updated from `/hblEntry/create` to `/hblEntry`, streamlining the HBL creation API.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
*   **11/26/2025, 2:57:40 PM:** This file defines the `HblListDetails` component for displaying a list of HBLs. It integrates `useGetHblDashboardQuery`, uses `HBL_COLUMNS` for grid definition, and sets up navigation to `/app/booking/hbl_form` for adding new HBLs. Notably, at this point, the grid was using `isfDummyData`.
*   **11/26/2025, 2:58:49 PM:** A crucial update replaced the dummy data source (`isfDummyData`) with actual fetched data (`hblData?.data`) for the `ThemedGrid`. The `uniqueId` prop for the grid was also changed from `"agent_booking_id"` to `"serial_id"`, indicating a shift in the primary identifier used for HBLs.
*   **11/26/2025, 6:03:04 PM:** The `useGetHblDashboardQuery` hook call was modified to filter HBL data by `agent_booking_id` from the navigation state, ensuring that the displayed HBL list is relevant to a specific booking.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
*   **11/26/2025, 3:01:38 PM:** This entry shows a comprehensive definition of column configurations for various booking-related data grids, including `BOOKING_VESSEL_COLUMN`, `BOOKING_CARGO_COLUMN`, and dashboard columns for both grid and card views. Many columns include custom renderers for date formatting and status display (using MUI `Chip` components). "Action" columns were added with `AddCircleOutlined` icons for interactive elements.
*   **11/26/2025, 3:10:12 PM:** No functional changes were observed in this entry; the code content is identical to the previous timestamp, suggesting a re-save or minor, non-functional alteration.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
*   **11/26/2025, 3:13:47 PM:** This update represents a major refactoring of the action definitions. The previously commented-out `getBookingActions` function was activated and modularized into reusable action arrays (e.g., `bookingActions`, `isfActions`, `hblAction`). New actions were introduced for creating HBLs (`createHblAction`), viewing HBL details (`viewHblAction`), updating carrier bookings (`updateLineBookingAction`), and updating delivery orders (`updateDOAction`). The `getHblActions` function was also defined, initially for editing HBLs using `agent_booking_id`.
*   **11/26/2025, 5:33:49 PM:** The `getHblActions` function was modified to pass `serial_id` instead of `agent_booking_id` in the navigation state when editing an HBL, indicating `serial_id` became the primary identifier for HBL edits.
*   **11/26/2025, 5:35:42 PM:** The `getHblActions` was further refined to include *both* `agent_booking_id` and `serial_id` in the navigation state when editing an HBL, suggesting both identifiers are now necessary for context.

**5. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
*   **11/26/2025, 5:55:57 PM:** This file defines the `HBLForm` component, a complex form for HBL creation/editing. It utilizes `Formik` for state management, `useSaveHblBookingMutation` for data persistence, and Redux for managing party-related data across tabs. It includes extensive data transformation logic in `handleSave` to prepare the payload for the API, handling various fields, including `routingList`, `containerList`, and `basicPoList`. The component also features integrated keyboard shortcuts for improved usability and robust error/success feedback mechanisms.
*   **11/26/2025, 6:11:50 PM:** The `handleSave` function was updated to ensure that `serial_id` is always included in the payload if present in the `location.state`, regardless of the `formAction`. This change improves the robustness of HBL updates by ensuring the correct identifier is always passed.

### Patterns and Recurring Elements:

*   **HBL Feature Focus:** The overwhelming pattern is a significant push to implement and refine the HBL feature across multiple layers of the application (API, components, data structures, and actions). This suggests HBL management is a new or recently prioritized functionality.
*   **Redux Toolkit Query (RTK Query) for API Interaction:** The `agentBookingApi.js` consistently uses RTK Query, demonstrating a modern and structured approach to data fetching, caching, and state management for API calls.
*   **Formik for Form Management:** `HBLListDetails.jsx` and `HBLform.jsx` leverage Formik, indicating a consistent strategy for handling complex form state and validation within the application.
*   **Dynamic Data Grids:** The use of `ThemedGrid` with dynamic columns (`COLUMNS_GRID`) and data sourcing (`hblData?.data`) points to a standardized approach for displaying tabular data.
*   **Role-Based Access Control (RBAC):** The `actions.js` file clearly implements RBAC by defining different sets of actions based on user roles (`agentBookingMenu`, `customerBookingMenu`, `adminBookingMenu`).
*   **Standardized Navigation and State Transfer:** `react-router-dom`'s `useLocation` and `useNavigate` are used consistently to manage routes and pass `state` objects between components, often including `agent_booking_id`, `serial_id`, and `formAction`.
*   **Utility Functions for Dates and Data Processing:** `appDateFormat` is used for consistent date display, and functions like `recoverValue` in `HBLform.jsx` are used to parse combined string values, indicating a pattern of data transformation before API submission.
*   **Comprehensive User Feedback:** The pattern of using `react-hot-toast` for success/error messages and detailed `setAlertConfig` popups for validation errors suggests a focus on clear and informative user feedback.

## 9:49:26 AM
The provided log details changes primarily within two files: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts` and `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **11/26/2025, 12:21:43 PM - 12:30:44 PM**: The initial version of the `createHblMasterBooking` and `saveHblBooking` functions is present. `createHblMasterBooking` focuses on inserting new HBL data across multiple tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`). The `saveHblBooking` function, intended for updates, begins by fetching existing data but its update logic is truncated in the provided snippets. Both functions extensively use `sanitizeString` and `AppDateFormate` for data preparation and employ database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) for data integrity.
    *   **11/26/2025, 2:32:34 PM**: The `bookingInsertQuery` object within `createHblMasterBooking` is expanded to include `bookingdate` and `transport_mode` fields, indicating more data points are now being stored for the `hbl_master` table.
    *   **11/26/2025, 4:41:31 PM**: A significant architectural change introduces conditional logic within `createHblMasterBooking` to handle both "create" and "update" operations based on the presence of `req.query.serial_id`. If `serial_id` is found, an `updateQuery` is performed on `hbl_master`. However, the logic for related sub-tables (vessel, HBL details, routing, containers, POs) remains inconsistent, often attempting insertions even in an "update" path.
    *   **11/26/2025, 4:55:19 PM - 4:56:29 PM**: The update/insert logic within `createHblMasterBooking` appears to be in a state of flux, with some conditional blocks becoming empty or the insert operation being executed unconditionally, temporarily losing the intended update functionality.
    *   **11/26/2025, 5:05:17 PM**: The `createHblMasterBooking` function is refactored to properly distinguish between create and update operations. If `serial_id` (from `req.query`) is present, it executes `updateQuery` for `hbl_master` and `agent_booking_vessel` (targeting `hbl_master_id: serial_id` for vessel), otherwise, it performs `insertQuery` for all related tables. Database transactions are correctly applied to both conditional branches.
    *   **11/26/2025, 5:58:58 PM**: The `serial_id` for update operations in `createHblMasterBooking` is now expected from `req.body` instead of `req.query`. The `updateQuery` for `agent_booking_vessel` continues to use `hbl_master_id: serial_id` as its update condition.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **11/26/2025, 2:49:43 PM**: A new route `POST /create` is added, which directly maps to the `createHblMasterBooking` controller function. Existing routes include `POST /` for `saveHblBooking` and `GET /`, `GET /get-hbl` for fetching HBL details.

**Patterns and Recurring Elements:**

*   **Consistent Data Handling**: Throughout the changes in `hblEntry.controller.ts`, there's a consistent pattern of sanitizing all incoming string data using `sanitizeString` and formatting dates using `AppDateFormate` to `YYYY-MM-DD` before database interaction.
*   **Transactional Integrity**: Database operations are invariably wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` statements, indicating a strong emphasis on maintaining data consistency.
*   **Error Handling**: `HttpError` is consistently used to signal API errors when database operations fail, indicating standardized error responses.
*   **Dual-Purpose Controllers**: The `createHblMasterBooking` function evolves to handle both initial creation and subsequent updates, suggesting a consolidation of logic for HBL entry management. This mirrors the existing `saveHblBooking` which also had `EntryMode.ADD` and `EntryMode.UPDATE` logic, although it fetches current data rather than relying on a `serial_id` in the request body for distinction.
*   **Multi-Table Persistence**: Both `createHblMasterBooking` and `saveHblBooking` involve saving data across multiple related tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), indicating a complex data model for HBLs.
*   **Role-Based Logic**: The `locationByRole` variable, derived from `req.user.role`, is consistently used to determine a location value for database inserts, implying role-based data association.

## 10:49:27 AM
The log primarily details changes to two files: `hblEntry.controller.ts` and `hblEntry.route.ts`, indicating work on handling House Bill of Lading (HBL) entries.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial State (11/26/2025, 12:21:43 PM - 12:30:44 PM)**: The file defines `createHblMasterBooking` for inserting new HBL records across multiple tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`) within a database transaction. It also includes an incomplete `saveHblBooking` function, which appears to be intended for updating existing HBL records, including fetching current data before an update.
    *   **Minor Refinement (11/26/2025, 2:32:34 PM)**: The `bookingdate` field in `bookingInsertQuery` within `createHblMasterBooking` is uncommented, and `transport_mode` is added to the insert payload for `hbl_master`.
    *   **Attempted Update Integration (11/26/2025, 4:41:31 PM - 6:04:47 PM)**: Significant changes are introduced to `createHblMasterBooking` to handle both creation and updates. It attempts to conditionally perform an `updateQuery` on `hbl_master` (and `agent_booking_vessel`) if a `serial_id` is present in `req.query` (later changed to `req.body`). If no `serial_id` is found, it proceeds with insertions. This phase shows some intermediate states where logic might have been temporarily inconsistent (e.g., using `insertQuery` even when an `updateQuery` was intended). The sub-lists (`routingList`, `containerList`, `basicPoList`) are consistently processed via `insertMany`, suggesting an append-only or full replacement strategy for these details during updates, rather than granular item updates.
    *   **Reversion to Create-Only & `saveHblBooking` Deprecation (11/27/2025, 10:12:30 AM onwards)**: The most notable change is the complete removal of the update logic (`if (serial_id)` blocks) from `createHblMasterBooking`, making it solely responsible for creating new HBL entries again. Concurrently, the entire `saveHblBooking` function, which was designed for updates, is commented out, effectively disabling the update functionality from this controller.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **Initial State (11/26/2025, 2:49:43 PM)**: Defines routes for HBL operations, including a `POST /` route mapping to `saveHblBooking` and a `POST /create` route mapping to `createHblMasterBooking`.
    *   **Route Deprecation (11/27/2025, 10:18:23 AM)**: The `router.post("/",saveHblBooking);` line is commented out, aligning with the deprecation of the `saveHblBooking` function in the controller.

**Timestamps of Significant Changes:**

*   **11/26/2025, 2:32:34 PM**: `bookingdate` uncommented and `transport_mode` added to `hbl_master` payload in `createHblMasterBooking`.
*   **11/26/2025, 4:41:31 PM**: Introduction of conditional update/insert logic based on `serial_id` in `createHblMasterBooking`.
*   **11/26/2025, 5:05:17 PM**: Refinement of the update logic within `createHblMasterBooking`, correcting earlier temporary regressions by reintroducing `updateQuery` for `hbl_master` and `agent_booking_vessel`.
*   **11/27/2025, 10:12:30 AM**: Major change in `hblEntry.controller.ts`, reverting `createHblMasterBooking` to be create-only and commenting out `saveHblBooking`.
*   **11/27/2025, 10:18:23 AM**: Corresponding route change in `hblEntry.route.ts` where the POST route for `saveHblBooking` is commented out.

**Patterns and Recurring Elements:**

*   **Data Sanitization and Formatting:** The consistent use of `sanitizeString` for request body fields and `AppDateFormate` for date fields (formatted to 'YYYY-MM-DD') is a strong recurring pattern across both `createHblMasterBooking` and `saveHblBooking` (when active). This indicates a focus on data quality and consistency.
*   **Transactional Database Operations:** Both primary functions utilize explicit database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure atomicity for multi-table operations.
*   **Error Handling:** Robust error handling is present with `try...catch` blocks, `HttpError` for specific failures, and `logger.error` for logging issues, coupled with transaction rollbacks.
*   **Complex Payload Mapping:** A large `hblEntryPayloadTypes` object is consistently constructed from `req.body`, mapping numerous shipping-related fields, demonstrating a comprehensive data model for HBL entries.
*   **Conditional Sub-list Processing:** Routing, container, and PO lists are always processed via `insertMany` only if data exists, rather than attempting to update individual items within those lists.
*   **Role-Based Logic:** User roles (specifically 'AGENT') are used to determine the `locationByRole` value, which is then inserted into booking records.