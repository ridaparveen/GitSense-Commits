# Activity Summary for 11/27/2025

## 6:29:57 AM
The code changes primarily involve two files: `hblEntry.controller.ts` and `hblEntry.route.ts`, all occurring on 11/26/2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial State (12:21 PM - 1:00 PM):** The `createHblMasterBooking` function was primarily set up for inserting new HBL (House Bill of Lading) master bookings and related sub-entities (vessel, HBL details, routing, containers, POs) into a database, utilizing transactions (`BEGIN`, `COMMIT`, `ROLLBACK`). It included extensive data sanitization using `sanitizeString` and date formatting using `AppDateFormate`. A `bookingInsertQuery` object was created for `hbl_master` insertion, but initially contained a syntax error (`booking_id: payload.agent_booking_id,,`) and had `bookingdate` commented out. The `saveHblBooking` function was present, designed for updates, and included logic to fetch existing booking details, but its actual update implementation was truncated in the logs.
    *   **Functional Improvements (2:32 PM):** The syntax error in `booking_id` within `bookingInsertQuery` was corrected, and the `bookingdate` field was uncommented. A new field, `transport_mode`, was added to the `bookingInsertQuery` for `hbl_master` table.
    *   **Refactoring for Upsert Logic (4:41 PM - 6:04 PM):**
        *   The `createHblMasterBooking` function was significantly refactored to handle both creation and updating of HBL master records.
        *   Conditional logic was introduced to check for `serial_id` (initially from `req.query`, later changed to `req.body`). If `serial_id` is present, the function attempts to update existing records; otherwise, it inserts new ones.
        *   The `updateQuery` function was correctly applied to `hbl_master` and `agent_booking_vessel` tables when `serial_id` is provided, using `serial_id` or `hbl_master_id` for the update condition.
        *   A recurring pattern observed in this refactoring was that even within the `if (serial_id)` (update) block, the `agent_booking_hbl` details continued to use `insertQuery` rather than `updateQuery`, suggesting a potential ongoing bug or design choice for this specific sub-entity. Similarly, `insertMany` was consistently used for `routingList`, `containerList`, and `basicPoList` in both create and update paths, implying these lists are always new or replaced rather than updated incrementally.
        *   There was a brief regression (4:55:51 PM) where the `if (serial_id)` block became empty, causing all operations to default to insertions, but this was quickly corrected in subsequent commits.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **New Route Added (2:49 PM):** A new POST route, `"/create"`, was added, mapping to the `createHblMasterBooking` controller function. Existing routes for `saveHblBooking`, `fetchHblFormDetails`, and `getHbl` remained unchanged.

**Timestamps of Significant Changes:**

*   **11/26/2025, 2:32:34 PM:** Corrected minor syntax errors and added `transport_mode` in `hblEntry.controller.ts`.
*   **11/26/2025, 2:49:43 PM:** Introduced the new `"/create"` route in `hblEntry.route.ts`.
*   **11/26/2025, 4:41:31 PM:** First major attempt to implement upsert logic in `createHblMasterBooking` using `req.query.serial_id`.
*   **11/26/2025, 4:55:19 PM:** Fixed the `updateQuery` for `agent_booking_vessel` within the upsert logic.
*   **11/26/2025, 5:05:17 PM:** Corrected a temporary regression in the upsert logic, restoring the conditional update/insert flow.
*   **11/26/2025, 5:47:24 PM:** Changed `serial_id` retrieval from `req.query` to `req.body` in `createHblMasterBooking`.

**Patterns or Recurring Elements:**

*   **Consistent Data Handling:** The use of `sanitizeString` for almost all string inputs and `AppDateFormate` for dates is a recurring pattern, indicating an emphasis on data integrity and format consistency.
*   **Transactional Database Operations:** All database modifications are wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` commands, ensuring atomicity of operations.
*   **Modular Database Interactions:** The code consistently uses helper functions like `insertQuery`, `updateQuery`, and `insertMany` from `../config/database`, abstracting raw SQL queries.
*   **Error Handling:** `HttpError` and `logger.error` are consistently used within `try...catch` blocks for error management.
*   **Duplication in Logic:** There's a notable pattern of duplicating the `insertMany` calls for `routingList`, `containerList`, and `basicPoList` in both the "create" and "update" branches of the `createHblMasterBooking` function, suggesting these sub-lists might always be treated as new insertions rather than updates. Also, the `agent_booking_hbl` table consistently uses `insertQuery` even in the update path.

## 9:49:22 AM
The log details a concentrated period of development on November 26, 2025, primarily focused on enhancing the House Bill of Lading (HBL) feature and related booking functionalities within the T360_Api frontend.

### File-Specific Updates and Significant Changes:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
*   **11/26/2025, 2:53:21 PM:** This update significantly expands the `agentBookingApi` by introducing several new Redux Toolkit Query endpoints. Key additions include:
    *   `fetchBookingFormDetails` query.
    *   ISF (Importer Security Filing) XML-related mutations: `isfDescXmlCreate` and `isfDescXmlUpload`.
    *   Booking XML generation and upload mutations: `createBookingXml` and `uploadBookingXml`.
    *   HBL (House Bill of Lading) specific endpoints: `saveHblBooking` (POST), `fetchHblBookingFormDetails` (GET), and `getHblDashboard` (GET).
    *   `updateCarrierBooking` and `updateDo` mutations, likely for modifying booking details.
    *   An `exportSprReport` query.
    *   The `tagTypes` array was updated to include `'FormDetails'`, and the exported hooks were expanded to include all newly defined endpoints.
*   **11/26/2025, 5:48:11 PM:** A minor but specific change to the `saveHblBooking` mutation's URL, updated from `/hblEntry/create` to `/hblEntry`, streamlining the HBL creation API.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
*   **11/26/2025, 2:57:40 PM:** This file defines the `HblListDetails` component for displaying a list of HBLs. It integrates `useGetHblDashboardQuery`, uses `HBL_COLUMNS` for grid definition, and sets up navigation to `/app/booking/hbl_form` for adding new HBLs. Notably, at this point, the grid was using `isfDummyData`.
*   **11/26/2025, 2:58:49 PM:** A crucial update replaced the dummy data source (`isfDummyData`) with actual fetched data (`hblData?.data`) for the `ThemedGrid`. The `uniqueId` prop for the grid was also changed from `"agent_booking_id"` to `"serial_id"`, indicating a shift in the primary identifier used for HBLs.
*   **11/26/2025, 6:03:04 PM:** The `useGetHblDashboardQuery` hook call was modified to filter HBL data by `agent_booking_id` from the navigation state, ensuring that the displayed HBL list is relevant to a specific booking.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
*   **11/26/2025, 3:01:38 PM:** This entry shows a comprehensive definition of column configurations for various booking-related data grids, including `BOOKING_VESSEL_COLUMN`, `BOOKING_CARGO_COLUMN`, and dashboard columns for both grid and card views. Many columns include custom renderers for date formatting and status display (using MUI `Chip` components). "Action" columns were added with `AddCircleOutlined` icons for interactive elements.
*   **11/26/2025, 3:10:12 PM:** No functional changes were observed in this entry; the code content is identical to the previous timestamp, suggesting a re-save or minor, non-functional alteration.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
*   **11/26/2025, 3:13:47 PM:** This update represents a major refactoring of the action definitions. The previously commented-out `getBookingActions` function was activated and modularized into reusable action arrays (e.g., `bookingActions`, `isfActions`, `hblAction`). New actions were introduced for creating HBLs (`createHblAction`), viewing HBL details (`viewHblAction`), updating carrier bookings (`updateLineBookingAction`), and updating delivery orders (`updateDOAction`). The `getHblActions` function was also defined, initially for editing HBLs using `agent_booking_id`.
*   **11/26/2025, 5:33:49 PM:** The `getHblActions` function was modified to pass `serial_id` instead of `agent_booking_id` in the navigation state when editing an HBL, indicating `serial_id` became the primary identifier for HBL edits.
*   **11/26/2025, 5:35:42 PM:** The `getHblActions` was further refined to include *both* `agent_booking_id` and `serial_id` in the navigation state when editing an HBL, suggesting both identifiers are now necessary for context.

**5. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
*   **11/26/2025, 5:55:57 PM:** This file defines the `HBLForm` component, a complex form for HBL creation/editing. It utilizes `Formik` for state management, `useSaveHblBookingMutation` for data persistence, and Redux for managing party-related data across tabs. It includes extensive data transformation logic in `handleSave` to prepare the payload for the API, handling various fields, including `routingList`, `containerList`, and `basicPoList`. The component also features integrated keyboard shortcuts for improved usability and robust error/success feedback mechanisms.
*   **11/26/2025, 6:11:50 PM:** The `handleSave` function was updated to ensure that `serial_id` is always included in the payload if present in the `location.state`, regardless of the `formAction`. This change improves the robustness of HBL updates by ensuring the correct identifier is always passed.

### Patterns and Recurring Elements:

*   **HBL Feature Focus:** The overwhelming pattern is a significant push to implement and refine the HBL feature across multiple layers of the application (API, components, data structures, and actions). This suggests HBL management is a new or recently prioritized functionality.
*   **Redux Toolkit Query (RTK Query) for API Interaction:** The `agentBookingApi.js` consistently uses RTK Query, demonstrating a modern and structured approach to data fetching, caching, and state management for API calls.
*   **Formik for Form Management:** `HBLListDetails.jsx` and `HBLform.jsx` leverage Formik, indicating a consistent strategy for handling complex form state and validation within the application.
*   **Dynamic Data Grids:** The use of `ThemedGrid` with dynamic columns (`COLUMNS_GRID`) and data sourcing (`hblData?.data`) points to a standardized approach for displaying tabular data.
*   **Role-Based Access Control (RBAC):** The `actions.js` file clearly implements RBAC by defining different sets of actions based on user roles (`agentBookingMenu`, `customerBookingMenu`, `adminBookingMenu`).
*   **Standardized Navigation and State Transfer:** `react-router-dom`'s `useLocation` and `useNavigate` are used consistently to manage routes and pass `state` objects between components, often including `agent_booking_id`, `serial_id`, and `formAction`.
*   **Utility Functions for Dates and Data Processing:** `appDateFormat` is used for consistent date display, and functions like `recoverValue` in `HBLform.jsx` are used to parse combined string values, indicating a pattern of data transformation before API submission.
*   **Comprehensive User Feedback:** The pattern of using `react-hot-toast` for success/error messages and detailed `setAlertConfig` popups for validation errors suggests a focus on clear and informative user feedback.

## 9:49:26 AM
The provided log details changes primarily within two files: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts` and `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **11/26/2025, 12:21:43 PM - 12:30:44 PM**: The initial version of the `createHblMasterBooking` and `saveHblBooking` functions is present. `createHblMasterBooking` focuses on inserting new HBL data across multiple tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`). The `saveHblBooking` function, intended for updates, begins by fetching existing data but its update logic is truncated in the provided snippets. Both functions extensively use `sanitizeString` and `AppDateFormate` for data preparation and employ database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) for data integrity.
    *   **11/26/2025, 2:32:34 PM**: The `bookingInsertQuery` object within `createHblMasterBooking` is expanded to include `bookingdate` and `transport_mode` fields, indicating more data points are now being stored for the `hbl_master` table.
    *   **11/26/2025, 4:41:31 PM**: A significant architectural change introduces conditional logic within `createHblMasterBooking` to handle both "create" and "update" operations based on the presence of `req.query.serial_id`. If `serial_id` is found, an `updateQuery` is performed on `hbl_master`. However, the logic for related sub-tables (vessel, HBL details, routing, containers, POs) remains inconsistent, often attempting insertions even in an "update" path.
    *   **11/26/2025, 4:55:19 PM - 4:56:29 PM**: The update/insert logic within `createHblMasterBooking` appears to be in a state of flux, with some conditional blocks becoming empty or the insert operation being executed unconditionally, temporarily losing the intended update functionality.
    *   **11/26/2025, 5:05:17 PM**: The `createHblMasterBooking` function is refactored to properly distinguish between create and update operations. If `serial_id` (from `req.query`) is present, it executes `updateQuery` for `hbl_master` and `agent_booking_vessel` (targeting `hbl_master_id: serial_id` for vessel), otherwise, it performs `insertQuery` for all related tables. Database transactions are correctly applied to both conditional branches.
    *   **11/26/2025, 5:58:58 PM**: The `serial_id` for update operations in `createHblMasterBooking` is now expected from `req.body` instead of `req.query`. The `updateQuery` for `agent_booking_vessel` continues to use `hbl_master_id: serial_id` as its update condition.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **11/26/2025, 2:49:43 PM**: A new route `POST /create` is added, which directly maps to the `createHblMasterBooking` controller function. Existing routes include `POST /` for `saveHblBooking` and `GET /`, `GET /get-hbl` for fetching HBL details.

**Patterns and Recurring Elements:**

*   **Consistent Data Handling**: Throughout the changes in `hblEntry.controller.ts`, there's a consistent pattern of sanitizing all incoming string data using `sanitizeString` and formatting dates using `AppDateFormate` to `YYYY-MM-DD` before database interaction.
*   **Transactional Integrity**: Database operations are invariably wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` statements, indicating a strong emphasis on maintaining data consistency.
*   **Error Handling**: `HttpError` is consistently used to signal API errors when database operations fail, indicating standardized error responses.
*   **Dual-Purpose Controllers**: The `createHblMasterBooking` function evolves to handle both initial creation and subsequent updates, suggesting a consolidation of logic for HBL entry management. This mirrors the existing `saveHblBooking` which also had `EntryMode.ADD` and `EntryMode.UPDATE` logic, although it fetches current data rather than relying on a `serial_id` in the request body for distinction.
*   **Multi-Table Persistence**: Both `createHblMasterBooking` and `saveHblBooking` involve saving data across multiple related tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), indicating a complex data model for HBLs.
*   **Role-Based Logic**: The `locationByRole` variable, derived from `req.user.role`, is consistently used to determine a location value for database inserts, implying role-based data association.

## 10:49:27 AM
The log primarily details changes to two files: `hblEntry.controller.ts` and `hblEntry.route.ts`, indicating work on handling House Bill of Lading (HBL) entries.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**:
    *   **Initial State (11/26/2025, 12:21:43 PM - 12:30:44 PM)**: The file defines `createHblMasterBooking` for inserting new HBL records across multiple tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`) within a database transaction. It also includes an incomplete `saveHblBooking` function, which appears to be intended for updating existing HBL records, including fetching current data before an update.
    *   **Minor Refinement (11/26/2025, 2:32:34 PM)**: The `bookingdate` field in `bookingInsertQuery` within `createHblMasterBooking` is uncommented, and `transport_mode` is added to the insert payload for `hbl_master`.
    *   **Attempted Update Integration (11/26/2025, 4:41:31 PM - 6:04:47 PM)**: Significant changes are introduced to `createHblMasterBooking` to handle both creation and updates. It attempts to conditionally perform an `updateQuery` on `hbl_master` (and `agent_booking_vessel`) if a `serial_id` is present in `req.query` (later changed to `req.body`). If no `serial_id` is found, it proceeds with insertions. This phase shows some intermediate states where logic might have been temporarily inconsistent (e.g., using `insertQuery` even when an `updateQuery` was intended). The sub-lists (`routingList`, `containerList`, `basicPoList`) are consistently processed via `insertMany`, suggesting an append-only or full replacement strategy for these details during updates, rather than granular item updates.
    *   **Reversion to Create-Only & `saveHblBooking` Deprecation (11/27/2025, 10:12:30 AM onwards)**: The most notable change is the complete removal of the update logic (`if (serial_id)` blocks) from `createHblMasterBooking`, making it solely responsible for creating new HBL entries again. Concurrently, the entire `saveHblBooking` function, which was designed for updates, is commented out, effectively disabling the update functionality from this controller.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**:
    *   **Initial State (11/26/2025, 2:49:43 PM)**: Defines routes for HBL operations, including a `POST /` route mapping to `saveHblBooking` and a `POST /create` route mapping to `createHblMasterBooking`.
    *   **Route Deprecation (11/27/2025, 10:18:23 AM)**: The `router.post("/",saveHblBooking);` line is commented out, aligning with the deprecation of the `saveHblBooking` function in the controller.

**Timestamps of Significant Changes:**

*   **11/26/2025, 2:32:34 PM**: `bookingdate` uncommented and `transport_mode` added to `hbl_master` payload in `createHblMasterBooking`.
*   **11/26/2025, 4:41:31 PM**: Introduction of conditional update/insert logic based on `serial_id` in `createHblMasterBooking`.
*   **11/26/2025, 5:05:17 PM**: Refinement of the update logic within `createHblMasterBooking`, correcting earlier temporary regressions by reintroducing `updateQuery` for `hbl_master` and `agent_booking_vessel`.
*   **11/27/2025, 10:12:30 AM**: Major change in `hblEntry.controller.ts`, reverting `createHblMasterBooking` to be create-only and commenting out `saveHblBooking`.
*   **11/27/2025, 10:18:23 AM**: Corresponding route change in `hblEntry.route.ts` where the POST route for `saveHblBooking` is commented out.

**Patterns and Recurring Elements:**

*   **Data Sanitization and Formatting:** The consistent use of `sanitizeString` for request body fields and `AppDateFormate` for date fields (formatted to 'YYYY-MM-DD') is a strong recurring pattern across both `createHblMasterBooking` and `saveHblBooking` (when active). This indicates a focus on data quality and consistency.
*   **Transactional Database Operations:** Both primary functions utilize explicit database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure atomicity for multi-table operations.
*   **Error Handling:** Robust error handling is present with `try...catch` blocks, `HttpError` for specific failures, and `logger.error` for logging issues, coupled with transaction rollbacks.
*   **Complex Payload Mapping:** A large `hblEntryPayloadTypes` object is consistently constructed from `req.body`, mapping numerous shipping-related fields, demonstrating a comprehensive data model for HBL entries.
*   **Conditional Sub-list Processing:** Routing, container, and PO lists are always processed via `insertMany` only if data exists, rather than attempting to update individual items within those lists.
*   **Role-Based Logic:** User roles (specifically 'AGENT') are used to determine the `locationByRole` value, which is then inserted into booking records.

## 10:49:29 AM
The code changes primarily focus on enhancing the House Bill of Lading (HBL) functionality within the T360_Api frontend application, specifically related to booking management.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
    *   **Timestamp 11/26/2025, 2:53:21 PM:** The `agentBookingApi` Redux Toolkit Query definition was updated. Notably, the `saveHblBooking` mutation's URL was set to `/hblEntry/create`. New `tagTypes` like `'FormDetails'` were added, and an explicit `getHblDashboard` query was introduced, indicating a dedicated API for HBL listings.
    *   **Timestamp 11/26/2025, 5:48:11 PM:** The `saveHblBooking` mutation's URL was changed from `/hblEntry/create` to `/hblEntry`, suggesting a more generic HBL save endpoint.
    *   **Timestamp 11/27/2025, 10:17:24 AM:** The `saveHblBooking` mutation's URL was reverted back to `/hblEntry/create`, re-establishing a specific endpoint for HBL creation.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
    *   **Timestamp 11/26/2025, 2:57:40 PM:** This component was updated to display a list of HBLs. It initially used `isfDummyData` for the grid and fetched HBL dashboard data without specific query parameters. The "Add HBL" button was configured to navigate to `/app/booking/hbl_form` with `booking_serial_id`, `booking_id`, and `formAction: "add"`.
    *   **Timestamp 11/26/2025, 2:58:49 PM:** Significant changes were made to the `ThemedGrid` within this component. The `uniqueId` was updated from `agent_booking_id` to `serial_id`, and the data source was switched from `isfDummyData` to `hblData?.data`, indicating a move to display actual data fetched from the API.
    *   **Timestamp 11/26/2025, 6:03:04 PM:** The `useGetHblDashboardQuery` hook was updated to include `agent_booking_id : location.state.agent_booking_id || ""` as a parameter, enabling the fetching of HBLs specific to a booking.
    *   **Timestamp 11/27/2025, 10:25:36 AM:** A minor debugging change was observed with the addition of a `console.log` for the `location` object, but no functional updates.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
    *   **Timestamp 11/26/2025, 3:01:38 PM & 3:10:12 PM:** This file defines various column configurations for booking, vessel, and cargo details. It consistently uses `appDateFormat` for date fields and `Chip` components for status display. The column definitions include actions like adding vessels or displaying formatted weight/CBM. No functional changes between the two timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
    *   **Timestamp 11/26/2025, 3:13:47 PM:** The `getBookingActions` function was refactored significantly, breaking down actions into reusable arrays (`bookingActions`, `isfActions`, `hblAction`, `createHblAction`, etc.) and combining them based on user access roles. A new `getHblActions` function was introduced, specifically for HBL lists, including an "Edit HBL" action navigating to `/app/booking/hbl_form`. A `createHblAction` was added which navigates to `/app/booking/hbl_form_screen`.
    *   **Timestamp 11/26/2025, 5:33:49 PM:** The "Edit HBL" action within `getHblActions` was modified to pass `serial_id` as the primary identifier to the HBL form.
    *   **Timestamp 11/26/2025, 5:35:42 PM:** The "Edit HBL" action was further refined to pass both `agent_booking_id` and `serial_id` to the HBL form for comprehensive context.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
    *   **Timestamp 11/26/2025, 5:55:57 PM:** This is a major update introducing the `HBLForm` component for creating and editing HBLs. It integrates `Formik` for form management, utilizes `useSaveHblBookingMutation` for API calls, and constructs a detailed payload from form values and Redux state. Initial form values are derived from `initialValues` and `location.state`. It features a tabbed interface for various HBL details (parties, containers, routing) and includes keyboard shortcuts for common actions. On successful save, it navigated to `/app/booking`.
    *   **Timestamp 11/26/2025, 6:11:50 PM:** The `handleSave` function was updated to explicitly include `serial_id` in the payload, ensuring proper identification for HBL updates.
    *   **Timestamp 11/27/2025, 10:20:17 AM:** The post-save navigation was changed from `/app/booking` to `/app/booking/hbl_form_screen`, indicating a dedicated HBL listing or form screen. The `agent_booking_id` was temporarily removed from the navigation state.
    *   **Timestamp 11/27/2025, 10:23:28 AM:** Confirmed the removal of `agent_booking_id` from the navigation state upon successful save to `/app/booking/hbl_form_screen`.
    *   **Timestamp 11/27/2025, 10:29:45 AM:** The post-save navigation was adjusted again to ensure `agent_booking_id` (either from `location.state.booking_id` or `resp.data.agent_booking_id`) is passed to the `/app/booking/hbl_form_screen` for continuity.

**Patterns and Recurring Elements:**

*   **HBL Feature Focus:** There's a clear and consistent effort to build out the HBL (House Bill of Lading) module, including API endpoints, list views, and a complex form for data entry and editing.
*   **Redux Toolkit Query (RTK Query):** The `agentBookingApi.js` file demonstrates heavy use of RTK Query for defining API interactions (mutations and queries), managing cache tags (`invalidatesTags`, `providesTags`), and streamlining data fetching.
*   **React Router's `useLocation` for State:** Navigation between forms and lists consistently uses `location.state` to pass crucial context such as `agent_booking_id`, `booking_serial_id`, `serial_id`, and `formAction` (e.g., "add", "edit", "copy").
*   **Modular Action Definitions:** The `actions.js` file adopts a modular approach for defining grid actions, segregating them into reusable arrays and combining them based on user roles (`access?.agentBookingMenu`, `access?.customerBookingMenu`, `access?.adminBookingMenu`).
*   **Form Management with Formik:** `HBLForm.jsx` uses `Formik` for efficient form state management, validation (`HBLvalidationSchema`), and submission.
*   **User Interface Components:** A consistent use of Material-UI components (`Box`, `Card`, `Stack`, `Typography`, `ThemeButton`, `OutlinedButton`, `Chip`) for building the user interface, along with custom `ThemedGrid` and `ThemeTabs`.
*   **Data Transformation for Payload:** In `HBLForm.jsx`, there's a recurring pattern of `recoverValue` functions to parse combined string values (e.g., "Name~Code") back into separate fields for the API payload.
*   **Keyboard Shortcuts:** The `HBLForm` incorporates keyboard shortcuts (`ctrl+u`, `ctrl+d`, `ctrl+a`, `ctrl+s`, `ctrl+p`) to enhance user efficiency for common actions like editing parties or saving.
*   **API Endpoint Path Adjustments:** The URL for `saveHblBooking` (`/hblEntry` vs. `/hblEntry/create`) changed multiple times, indicating ongoing backend API refinement or frontend adaptation to evolving API structures.
*   **Post-Save Navigation Refinements:** The navigation logic after saving an HBL was iterated upon, first going to a general booking view, then an HBL-specific view without a booking ID, and finally ensuring the relevant `agent_booking_id` is always passed to the HBL-specific view.
*   **Standardized Date Formatting:** All date-related columns in `agent.booking.js` utilize `appDateFormat` for consistent display.
*   **Error and Success Feedback:** `toast.success` and `setAlertConfig` are used consistently to provide user feedback on API operation outcomes.

## 11:49:30 AM
The recent code changes primarily focus on the development and refinement of House Bill of Lading (HBL) functionality within the T360 API frontend. This involves updates to API integration, UI components for HBL listing and forms, and associated user actions.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
    *   **November 26, 2:53:21 PM**: Introduced new Redux Toolkit Query endpoints for HBL management, including `saveHblBooking` (POST to `/booking/hblEntry/create`), `fetchHblBookingFormDetails` (GET to `/hblEntry`), and `getHblDashboard` (GET to `/hblEntry/get-hbl`). The `HBL` tag type was added for caching and invalidation.
    *   **November 26, 5:48:11 PM**: The URL for `saveHblBooking` mutation was changed from `/hblEntry/create` to `/hblEntry`.
    *   **November 27, 10:17:24 AM**: The URL for `saveHblBooking` was reverted back to `/hblEntry/create`.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
    *   **November 26, 2:57:40 PM**: Initial setup of the `HblListDetails` component, using dummy data for the HBL grid.
    *   **November 26, 2:58:49 PM**: The `ThemedGrid` component was updated to display actual HBL data fetched from `hblData?.data` and its `uniqueId` was changed from "agent\_booking\_id" to "serial\_id".
    *   **November 26, 6:03:04 PM**: The `useGetHblDashboardQuery` now accepts `agent_booking_id` from the route's state, enabling filtered HBL lists.
    *   **November 27, 10:25:36 AM**: A minor console log was added.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
    *   **November 26, 3:01:38 PM**, **November 26, 3:10:12 PM**, **November 27, 11:03:09 AM**: These entries show the consistent structure of various booking-related column definitions, including date formatting and action buttons. No explicit changes to the `HBL_COLUMNS` definition are detailed in these logs, but its usage in `HBLListDetails.jsx` implies its existence and relevance.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
    *   **November 26, 3:13:47 PM**: New actions were introduced: `createHblAction` to navigate to the HBL form for adding, and `viewHblAction` to display HBL details in a modal. These actions were integrated into the `getBookingActions` based on user roles (`agentBookingMenu`, `adminBookingMenu`). The `getHblActions` function was introduced with an "Edit HBL" option.
    *   **November 26, 5:33:49 PM**: The "Edit HBL" action within `getHblActions` was modified to pass `serial_id` for navigation.
    *   **November 26, 5:35:42 PM**: The "Edit HBL" action was further refined to pass both `agent_booking_id` and `serial_id` for navigation.
*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
    *   **November 26, 5:55:57 PM**: Initial implementation of the `HBLForm` component. It uses `useSaveHblBookingMutation`, handles form submission, payload construction (parsing "name~code" values), Redux state integration for routing, containers, and POs, and defines navigation upon successful save. Conditional inclusion of `serial_id` for "edit" actions was added to the payload. Keyboard shortcuts for party management were also implemented.
    *   **November 26, 6:11:50 PM**: The `handleSave` function was updated to explicitly include `serial_id` in the payload if present in the `location.state`.
    *   **November 27, 10:20:17 AM**: The successful save navigation was changed from `/app/booking` to `/app/booking/hbl_form_screen`, passing the `agent_booking_id` from the API response.
    *   **November 27, 10:23:28 AM**: The `agent_booking_id` in the success navigation state was commented out.
    *   **November 27, 10:29:45 AM**: The `agent_booking_id` in the success navigation state was reactivated, using a fallback from `location.state.booking_id` or the API response.
    *   **November 27, 10:58:43 AM** and **10:59:07 AM**: `serial_id`, `booking_serial_id`, and `agent_booking_id` fields were commented out from the `handleSave` payload, suggesting a re-evaluation or simplification of the data sent to the backend for HBL saving.

**Patterns and Recurring Elements:**

*   **HBL Feature Development:** The overwhelming majority of changes are centered around introducing, integrating, and refining the House Bill of Lading (HBL) functionality, from API endpoints to UI forms and actions.
*   **Redux Toolkit Query (RTK Query):** The `agentBookingApi.js` file demonstrates heavy reliance on RTK Query for efficient data fetching and mutation, defining various endpoints (`saveBooking`, `fetchBookingDashboard`, `saveISF`, `saveHblBooking`, etc.) with associated tag types for cache invalidation (`add`, `Details`, `ISF`, `HBL`).
*   **Form Management with Formik:** The `HBLform.jsx` component consistently uses `Formik` for managing form state, validation (`HBLvalidationSchema`), and submission, showcasing best practices for complex forms in React.
*   **Client-Side Routing and State Management:** `react-router-dom`'s `useLocation` and `useNavigate` hooks are frequently used for navigation and passing state (e.g., `agent_booking_id`, `formAction`, `serial_id`) between screens. Redux (`useSelector`, `useDispatch`) is also utilized for global state management.
*   **UI Component Reusability:** Custom components like `ThemedGrid`, `ScreenToolbar`, `ThemedBreadcrumb`, `ThemeButton`, `OutlinedButton`, `ThemeTabs`, and `GridActions` are consistently imported and used, indicating a structured and modular UI architecture.
*   **Data Transformation:** A `recoverValue` utility function is used to parse combined "name~code" strings for various fields (shipper, POL, POD, etc.), highlighting a common pattern for handling select box data.
*   **Error Handling and User Feedback:** API call handlers frequently include `try-catch` blocks, status code checks (400, 500), and use `react-hot-toast` for success/error messages, often complemented by an `alertConfig` for displaying detailed validation errors.
*   **Access Control:** Actions are often conditionally rendered or enabled based on user roles (`access?.agentBookingMenu`, `access?.adminBookingMenu`), emphasizing role-based access control.
*   **Keyboard Shortcuts:** `HBLform.jsx` integrates `useKeyboardShortcut` for common actions, improving user experience and efficiency for power users.

## 11:49:45 AM
**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**

This file, `hblEntry.controller.ts`, is central to managing House Bill of Lading (HBL) master bookings. It primarily contains two asynchronous functions: `createHblMasterBooking` and `saveHblBooking`.

*   **Initial State (11/26/2025, 12:21:43 PM):**
    *   `createHblMasterBooking` was implemented to create new HBL entries. It extracts and sanitizes a comprehensive payload from the request body, including details for transportation, booking IDs, HBL numbers, shipper/consignee/notify party information, marks, descriptions, container/package details, vessel/voyage, origins, destinations, ETA, HBL date, client details, and contact information.
    *   Database operations (`insertQuery` and `insertMany`) were performed within a transaction (`BEGIN`/`COMMIT`/`ROLLBACK`) across multiple tables: `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po`. It included logic to insert routing, container, and PO lists if present in the payload.
    *   `saveHblBooking` was partially implemented, seemingly intended for updating existing bookings. It also parsed a similar payload and included logic to fetch current data before an update, but the update logic itself was truncated in the logs.

*   **Early Modifications (11/26/2025, 2:32:34 PM):**
    *   Both `createHblMasterBooking` and `saveHblBooking` were updated to explicitly include `bookingdate` and `transport_mode` in their respective `bookingInsertQuery` objects, moving them from commented-out lines to active fields for insertion/update.

*   **Attempted Unification/Confusion (11/26/2025, 2:49:21 PM - 11/26/2025, 5:58:58 PM):**
    *   `createHblMasterBooking` was modified to ambiguously handle both creation and update based on a `serial_id` query parameter.
    *   If `serial_id` was present, it attempted an `updateQuery` on `hbl_master`, but then incorrectly followed with `insertQuery` and `insertMany` operations for related tables (`agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, etc.), which should ideally also be updates or more nuanced upserts.
    *   This dual-purpose logic within `createHblMasterBooking` underwent several internal structural changes and apparent reverts during this period, indicating an uncertain approach to managing updates through this endpoint. At one point, the `serial_id` parameter was switched from `req.query` to `req.body` for conditional logic.

*   **Re-specialization and Refinement (11/27/2025, 10:12:30 AM - 11/27/2025, 11:28:22 AM):**
    *   The `serial_id` check and the conditional update/insert logic within `createHblMasterBooking` were entirely removed, making `createHblMasterBooking` exclusively an endpoint for **creating new HBL master bookings**.
    *   The `saveHblBooking` function was fully commented out (11/27/2025, 10:18:14 AM), signaling a temporary or permanent removal of its functionality from the controller.
    *   The `createHblMasterBooking` function was significantly refined to ensure proper data relationships:
        *   It now fetches the `serial_id` from the `agent_booking_entry` table (if `payload.agent_booking_id` exists) and uses it as `booking_serial_id` when inserting into `hbl_master`.
        *   Crucially, after inserting into `hbl_master`, it retrieves the newly generated `hbl_master_id` and explicitly links all subsequent insertions into related tables (`agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`) using this `hbl_master_id` foreign key. This ensures stronger data integrity and correct association of child records with their master HBL entry.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**

*   **Timestamp: 11/26/2025, 2:49:43 PM:**
    *   A new POST route `/create` was added, mapping to the `createHblMasterBooking` controller function.
    *   The existing POST route `/` was mapped to `saveHblBooking`.
    *   GET routes `/` (`fetchHblFormDetails`) and `/get-hbl` (`getHbl`) remained unchanged.
*   **Timestamp: 11/27/2025, 10:18:23 AM:**
    *   The `router.post("/",saveHblBooking);` route was commented out, aligning with the `saveHblBooking` function being commented out in the controller, effectively disabling the primary update endpoint for HBLs.

**Key Patterns and Recurring Elements:**

*   **Date Range:** All changes occurred within a concentrated period between November 26-27, 2025, indicating focused development on HBL entry and management.
*   **Data Sanitization:** A consistent pattern is the use of `sanitizeString()` on almost all incoming request body fields before processing, highlighting an emphasis on input validation and security.
*   **Database Transactions:** All significant database operations (`createHblMasterBooking`, and the initially `saveHblBooking`) are wrapped in explicit SQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure atomicity and data consistency.
*   **Modular Database Interactions:** The code relies on helper functions (`insertMany`, `insertQuery`, `updateQuery`, `query`) from `../config/database`, promoting modularity for database access.
*   **Structured HBL Data:** The HBL data is consistently broken down and stored across several related tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), indicating a normalized database design for complex HBL information.
*   **Role-Based Access Logic:** `locationByRole` is derived based on the authenticated user's `role` (AGENT vs. companyname), suggesting a distinction in data handling or permissions.
*   **Evolving API Design:** The shifts in `createHblMasterBooking` (from attempting update/create to being purely create) and the subsequent commenting out of `saveHblBooking` and its route suggest an evolution in how HBL creation and update operations are intended to be handled by the API, possibly simplifying `createHblMasterBooking` to be solely for initial entry and deferring or refactoring update logic.