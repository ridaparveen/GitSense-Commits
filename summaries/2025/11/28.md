# Activity Summary for 11/28/2025

## 4:30:48 AM
The recent changes focus on refining the HBL (House Bill of Lading) creation and update functionality within the `t360-backend` application.

**File-Specific Updates:**

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **11/26/2025, 12:21:43 PM - 12:30:44 PM:** The `createHblMasterBooking` function was primarily responsible for inserting a new HBL master record and its associated details (vessel, HBL-specific data, routing, containers, purchase orders) into various database tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`). It leveraged database transactions (BEGIN, COMMIT, ROLLBACK) for data integrity. A `saveHblBooking` function existed but its update logic was incomplete, mainly fetching data.
    *   **11/26/2025, 2:32:34 PM:** Minor adjustments were made to the `bookingInsertQuery` within `createHblMasterBooking` to explicitly include `bookingdate` and `transport_mode` fields.
    *   **11/26/2025, 4:41:31 PM - 6:04:47 PM:** An attempt was made to merge create and update logic into `createHblMasterBooking` by checking for `serial_id` (initially from `req.query`, then `req.body`). This interim state introduced a conditional flow where, if `serial_id` was present, it would try to update `hbl_master` and `agent_booking_vessel`, but incorrectly attempted to *insert* into other detail tables or had incorrect update conditions for `agent_booking_hbl`. This logic was inconsistent and likely buggy, leading to the next set of changes.
    *   **11/27/2025, 10:12:30 AM - 10:42:33 AM:** The problematic merged logic in `createHblMasterBooking` was removed, reverting it to solely handle the creation of new HBL records. The `saveHblBooking` function was commented out entirely, indicating a decision to separate creation and update operations.
    *   **11/27/2025, 10:54:16 AM:** A significant improvement was made to `createHblMasterBooking`. After inserting into `hbl_master`, the returned `serial_id` (aliased as `hbl_master_id`) is now correctly captured and used to link all subsequent related insertions (vessel, HBL details, routing, containers, POs) to this newly created master record. `booking_serial_id` was also introduced in `hbl_master` insert, retrieved from `agent_booking_entry` to link HBL to a main booking.
    *   **11/27/2025, 11:05:47 AM:** A new, dedicated function `updateHblMasterBooking` was introduced. This function explicitly handles updating an existing HBL record identified by `serial_id` (from `req.body`). It performs direct `UPDATE` queries for `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. For lists like `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po`, it adopts a "delete all, then insert new" strategy to manage changes effectively.
    *   **11/27/2025, 11:24:27 AM - 3:11:54 PM:** Continued refinement, ensuring `hbl_master_id` is consistently passed and used for all associated sub-records during creation. The `hbldate` in `bookingInsertQuery` and `hblDeatailsCount` was made nullable.
    *   **11/27/2025, 3:24:58 PM - 3:30:57 PM:** A brief regression occurred where `hbldate` and `marks` were removed from `updateHblMasterBooking`'s update queries, but this was quickly rectified in the following commit, restoring the ability to update these fields.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **11/27/2025, 10:18:23 AM:** The route `router.post("/",saveHblBooking)` was commented out, aligning with the removal of the `saveHblBooking` function from the controller.
    *   **11/27/2025, 12:21:23 PM:** A new route `router.post("/update",updateHblMasterBooking)` was added, explicitly mapping to the newly introduced update controller function.

**Timestamps of Significant Changes:**

*   **11/26/2025, 4:41:31 PM:** Initial attempt to merge create/update logic in `createHblMasterBooking`.
*   **11/27/2025, 10:12:30 AM:** `createHblMasterBooking` reverts to create-only, `saveHblBooking` commented out.
*   **11/27/2025, 10:54:16 AM:** Correct `hbl_master_id` linking established in `createHblMasterBooking`.
*   **11/27/2025, 11:05:47 AM:** Introduction of `updateHblMasterBooking` for dedicated update logic.
*   **11/27/2025, 12:21:23 PM:** Corresponding `/update` route added for `updateHblMasterBooking`.
*   **11/27/2025, 3:30:57 PM:** Final correction to `updateHblMasterBooking` to correctly include `hbldate` and `marks` in update queries.

**Patterns and Recurring Elements:**

*   **Data Sanitization:** All incoming string payload fields are consistently sanitized using `sanitizeString()`.
*   **Date Formatting:** Dates are formatted to `YYYY-MM-DD` using `AppDateFormate()` before database insertion/update, often allowing `null` values.
*   **Database Transactions:** All major write operations (`createHblMasterBooking`, `updateHblMasterBooking`) are wrapped in `BEGIN`, `COMMIT`, and `ROLLBACK` for transactional integrity.
*   **Complex Data Structures:** HBLs are complex entities, reflected in the large `hblEntryPayloadTypes` object and the need to interact with multiple related database tables (master, vessel, HBL details, routing, containers, POs).
*   **List Management Strategy:** For child lists, the update strategy involves a complete replacement: `DELETE` all existing related records, then `INSERT MANY` the new list items from the request payload.
*   **Error Handling:** Robust error checking is in place after each database operation (`if (!rowCount) throw new HttpError(...)`) to catch failures and trigger transaction rollbacks.
*   **API Refactoring:** There's a clear evolution from a potentially merged/confused create/update function (`saveHblBooking`) towards distinct, clearer API endpoints and controller functions (`createHblMasterBooking` and `updateHblMasterBooking`) for better maintainability and clarity.

## 5:30:45 AM
The changes primarily focus on the `hblEntry.controller.ts` file, responsible for managing House Bill of Lading (HBL) entries, and its corresponding route definitions in `hblEntry.route.ts`. The significant changes occurred across November 26-27, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**
    *   **November 26, 2025 (12:21 PM - 12:30 PM)**: Initial implementation and minor internal tweaks to `createHblMasterBooking` and `saveHblBooking`. `createHblMasterBooking` was designed for inserting new HBL records across several database tables (e.g., `hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`). `saveHblBooking` contained logic for fetching existing booking data, suggesting an update intent, though its implementation was incomplete or problematic.
    *   **November 26, 2025 (2:32 PM)**: The `bookingdate` field was uncommented and `transport_mode` was added to the `bookingInsertQuery` in `createHblMasterBooking`.
    *   **November 26, 2025 (4:41 PM - 6:04 PM)**: Multiple changes experimented with combining create and update logic within `createHblMasterBooking` by checking for a `serial_id` from either `req.query` or `req.body`. This resulted in confused logic where updates were attempted, but often followed by re-insertions into sub-tables, indicating an unstable implementation of the update flow.
    *   **November 27, 2025 (10:12 AM - 10:18 AM)**: The `if (serial_id)` and `else` blocks in `createHblMasterBooking` were removed, effectively reverting `createHblMasterBooking` to solely handle creation (insert operations). Crucially, the `saveHblBooking` function was entirely commented out, signifying a redesign of the update process.
    *   **November 27, 2025 (10:54 AM - 11:05 AM)**: `createHblMasterBooking` was refined to correctly retrieve the `serial_id` generated by the `hbl_master` insertion and use this `hbl_master_id` to link all related records (vessel, HBL details, routing, containers, POs), ensuring data integrity.
    *   **November 27, 2025 (11:24 AM)**: A query to find `booking_serial_id` from `agent_booking_entry` was added to `createHblMasterBooking`, and `hbl_master_id` linking was expanded to `agent_booking_routing`, `agent_booking_container`, and `agent_booking_po` during creation.
    *   **November 27, 2025 (12:19 PM)**: A new, dedicated `updateHblMasterBooking` function was introduced. This function takes `serial_id` from `req.body` to identify the HBL record. It performs direct `UPDATE` queries for `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. For associated lists (routing, containers, POs), it implements a "delete and insert" pattern: existing records linked to the `hbl_master_id` are deleted, and new ones from the request payload are inserted.
    *   **November 27, 2025 (12:22 PM - 12:26 PM)**: Minor corrections were made to the `updateHblMasterBooking` SQL update statements, specifically re-adding and ensuring correct parameter mapping for fields like `hbldate` and `marks`.
    *   **November 27, 2025 (3:12 PM)**: Defaulting for `bookingdate` and `hbldate` in the payload construction and database inserts was improved to explicitly allow `null` values instead of `'null'` strings.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**
    *   **November 26, 2025 (2:49 PM)**: Initial routes were defined for `POST /` (for `saveHblBooking`), `GET /` (for `fetchHblFormDetails`), `GET /get-hbl`, and `POST /create` (for `createHblMasterBooking`).
    *   **November 27, 2025 (10:18 AM)**: The `router.post("/",saveHblBooking);` route was commented out, and `saveHblBooking` was removed from the imports.
    *   **November 27, 2025 (12:21 PM)**: `updateHblMasterBooking` was imported, and a new route `router.post("/update",updateHblMasterBooking);` was added.

**Patterns and Recurring Elements:**

*   **Data Sanitization**: The `sanitizeString` utility is consistently applied to almost all string-based fields from the request body to prevent potential security vulnerabilities.
*   **Date Formatting**: The `AppDateFormate` utility is uniformly used to convert date strings from the request body into a `YYYY-MM-DD` database format, with explicit handling for `null` values.
*   **Database Transactions**: All significant database operations within both `createHblMasterBooking` and `updateHblMasterBooking` are wrapped in explicit SQL transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure data consistency and atomicity.
*   **Error Handling**: A custom `HttpError` is consistently used to signal specific issues (e.g., "Unable to save HBL.") during database operations, facilitating structured error responses.
*   **Multi-Table Persistence**: Both creation and update of HBL records involve interacting with a core `hbl_master` table and several associated detail tables (`agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), reflecting a normalized database schema.
*   **Update Strategy for Lists**: For one-to-many relationship lists (routing, containers, basic POs), the common update pattern is to delete all existing child records for a given `hbl_master_id` and then insert all the new child records provided in the request payload.

## 9:08:13 AM
The provided log details changes primarily focused on the "House Bill of Lading" (HBL) functionality within a frontend application, specifically concerning booking and HBL management.

### File-Specific Updates:

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**
*   **11/26/2025, 2:53:21 PM**: This file, responsible for Redux Toolkit Query API definitions related to agent bookings, saw significant expansion. New endpoints for HBL management were added: `saveHblBooking` (POST to `/hblEntry/create`) and `fetchHblBookingFormDetails` (GET to `/hblEntry`). It also included `getHblDashboard` (GET to `/hblEntry/get-hbl`). Existing endpoints for booking, ISF, and customer approval were also present, indicating a comprehensive API for booking-related operations.
*   **11/26/2025, 5:48:11 PM**: The `saveHblBooking` mutation's URL was changed from `/hblEntry/create` to `/hblEntry`, suggesting a potential simplification or consolidation of the HBL creation endpoint.
*   **11/27/2025, 10:17:24 AM**: The `saveHblBooking` mutation's URL was reverted back to `/hblEntry/create`.
*   **11/27/2025, 2:40:18 PM**: A new mutation `updateHblBooking` was added, pointing to `/hblEntry/update`, expanding the HBL API to support updates. The exported hooks were also updated to include `useUpdateHblBookingMutation`.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**
*   **11/26/2025, 2:57:40 PM**: Introduced the `HblListDetails` component, likely a dashboard or list view for HBLs. It imports `useGetHblDashboardQuery` to fetch data and `HBL_COLUMNS` for grid definitions. It includes an "Add HBL" button that navigates to `/app/booking/hbl_form`. The component initially used `isfDummyData`.
*   **11/26/2025, 2:58:49 PM**: The `ThemedGrid` component was updated to use `hblData?.data` instead of `isfDummyData` and changed the `uniqueId` prop from `agent_booking_id` to `serial_id`. This indicates the integration of live HBL data from the API.
*   **11/26/2025, 6:03:04 PM**: The `useGetHblDashboardQuery` hook was updated to accept `agent_booking_id` from the `location.state`, enabling filtering of HBLs specific to a particular booking.
*   **11/27/2025, 10:25:36 AM**: Added `console.log("dat=====location====", location);` for debugging purposes.
*   **11/27/2025, 2:56:44 PM**: The navigation state for "Add HBL" button was updated to explicitly pass `agent_booking_id` from `location.state`, ensuring consistency when creating new HBLs linked to an existing booking.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**
*   **11/26/2025, 3:01:38 PM**: The file defines column configurations for various booking-related grids, including `BOOKING_VESSEL_COLUMN`, `BOOKING_CARGO_COLUMN`, and `BOOKING_DASHBOARD_COLUMNS_GRID`. The `renderCell` functions frequently use `appDateFormat` for date formatting and `Chip` components for status display.
*   **11/27/2025, 11:03:09 AM**: No functional changes were observed, indicating consistent column definitions for booking-related displays.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**
*   **11/26/2025, 3:13:47 PM**: This file defines various actions (Edit, Copy, View) for booking, ISF, and HBL entities, dynamically generated based on user access roles (agent, customer, admin). It introduced `getHblActions` to specifically handle HBL-related actions, initially containing only an "Edit HBL" action which navigates to `/app/booking/hbl_form`.
*   **11/26/2025, 5:33:49 PM**: The `getHblActions` function was updated to pass `agent_booking_id` in the navigation state for "Edit HBL".
*   **11/26/2025, 5:35:42 PM**: The `getHblActions` function's "Edit HBL" navigation state was further refined to include `serial_id` alongside `agent_booking_id`. This implies that HBLs are uniquely identified by `serial_id`.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**
*   **11/26/2025, 5:55:57 PM**: This is the initial creation of the `HBLForm` component. It uses Formik for form management, Redux for state, and several internal components (`HblHeaderForms`, `HblContainerDetailsForm`, `HblRoutingForm`, `BasicPoForm`, party-related forms). It handles saving HBL data via `useSaveHblBookingMutation` and includes logic to process form values, especially parsing "name~code" strings for various parties and locations. It also incorporates keyboard shortcuts for common actions. Navigation after a successful save directs to `/app/booking`.
*   **11/26/2025, 6:11:50 PM**: Added `serial_id:location.state?.serial_id || "",` to the payload for `handleSave`, indicating that `serial_id` is now part of the HBL data being submitted.
*   **11/27/2025, 10:20:17 AM**: Modified the success navigation path from `/app/booking` to `/app/booking/hbl_form_screen` and removed `agent_booking_id` from the state object on success, which was likely a bug or an interim change.
*   **11/27/2025, 10:23:28 AM**: Re-added `agent_booking_id` to the success navigation state, drawing it from `resp.data.agent_booking_id`.
*   **11/27/2025, 10:29:45 AM**: Changed how `agent_booking_id` is determined in the success navigation, prioritizing `location.state.booking_id` if available, otherwise falling back to `resp.data.agent_booking_id`. This ensures the correct booking context is maintained after an HBL save.
*   **11/27/2025, 10:58:43 AM**: Commented out `serial_id:location.state?.serial_id || "",` from the payload, suggesting that `serial_id` might be passed differently or not directly in the payload for certain operations.
*   **11/27/2025, 10:59:07 AM**: Commented out both `booking_serial_id` and `serial_id` from the payload, implying these might be derived or passed via other means in the API calls. Also removed `agent_booking_id` from the payload for the save, which might be an oversight if it's needed for linking.
*   **11/27/2025, 2:44:36 PM**: Integrated `useUpdateHblBookingMutation` and implemented conditional logic within `handleSave` to call either `updateHblBooking` (if `formAction` is "edit" and `serial_id` exists in `location.state`) or `saveBooking`. This is a crucial change for enabling HBL editing. The payload for `saveBooking` was incorrectly left as an empty call (should have been `saveBooking(payload)`).
*   **11/27/2025, 2:44:56 PM**: Corrected the call to `saveBooking` to `saveBooking(payload)` when not in "edit" mode.
*   **11/27/2025, 2:52:40 PM**: Refined the `handleSave` logic:
    *   Explicitly defined `agent_booking_id` for the success navigation state, prioritizing `location.state.agent_booking_id` (if available from parent) or `resp?.data?.agent_booking_id`.
    *   Added error handling to explicitly check for a missing `agent_booking_id` after save.
    *   The `agent_booking_id` for the *payload* was also refined, using `location.state.agent_booking_id` primarily, but `booking_serial_id` was still commented out.
*   **11/27/2025, 2:56:53 PM**: In the `handleSave` function, the payload's `agent_booking_id` was again set, this time using `location.state.agent_booking_id || ""`, which is more consistent with how it's handled in the success navigation.
*   **11/27/2025, 3:26:27 PM**: Changed initial values for `hbldate` and `bookingdate` to `null` if undefined, instead of an empty string, likely for date picker compatibility.
*   **11/27/2025, 3:30:00 PM**: Adjusted how `agent_booking_id` is set in the payload during `handleSave`, now checking `location.state.booking_id || location.state.agent_booking_id || ""` to ensure the correct ID is passed for association.
*   **11/27/2025, 3:33:27 PM**: Reverted `agent_booking_id` logic in `handleSave` payload to `location.state.booking_id || ""` and updated success navigation to `location.state.agent_booking_id || resp.data.agent_booking_id`. This indicates an ongoing refinement of how booking IDs are passed between components and API calls.
*   **11/27/2025, 3:49:59 PM**: In `handleSave`, the `saveBooking` mutation for "add" now explicitly passes the payload including `agent_booking_id` from `location.state`. This fixes a previous potential issue where `agent_booking_id` was not being correctly associated with new HBLs.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\HblEntry.jsx`**
*   **11/27/2025, 12:05:38 PM**: This file imports and uses `HblEntryForm` (which is likely `HBLform` renamed or an alias). It fetches HBL details using `useFetchHblBookingFormDetailsQuery` based on `agent_booking_id` from `useLocation` state. It also includes `useEffect` hooks to initialize Redux lists (`containerList`, `routingList`) and reset state on unmount.
*   **11/27/2025, 12:07:36 PM**: No functional changes were observed.

**`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblEntryFormScreen.jsx`**
*   **11/27/2025, 12:07:51 PM**: This new component acts as a wrapper for `HBLForm`, handling the data fetching for HBL details based on `agent_booking_id` from `location.state`. It also manages modals for adding/viewing parties and error popups. It dispatches actions (`initializeLists`, `resetHblEntryForm`) to Redux store. There was a commented-out section for a `hblDetails` query, followed by an active one.
*   **11/27/2025, 12:08:00 PM**: No functional changes were observed.
*   **11/27/2025, 12:08:31 PM**: The `useFetchHblBookingFormDetailsQuery` was updated to fetch HBL details using `serial_id` instead of `agent_booking_id` when `state` is present, suggesting a shift to using `serial_id` as the primary identifier for fetching HBL forms.
*   **11/27/2025, 12:08:43 PM**: Corrected the variable name for fetched HBL data from `hblBbookingDetails` to `hblDetails`.
*   **11/27/2025, 3:11:16 PM**: The query for `useFetchHblBookingFormDetailsQuery` was changed back to use `state.booking_serial_id` when `isEdit` is true, but then immediately reverted this change in the next log entry. This indicates some back-and-forth or experimentation with the key used for fetching HBL details.
*   **11/27/2025, 3:12:29 PM**: The query for `useFetchHblBookingFormDetailsQuery` was changed back to use `state.serial_id` when `isEdit` is true. This confirms `serial_id` is the intended primary key for editing existing HBLs.
*   **11/27/2025, 3:20:00 PM**: The `useFetchHblBookingFormDetailsQuery` was further refined to explicitly check `isEdit && state?.serial_id` before attempting to fetch, ensuring the query is only made when an HBL is being edited.

### Timestamps of Significant Changes:

*   **11/26/2025, 2:53:21 PM**: Initial major update to `agentBookingApi.js` for HBL functionality.
*   **11/26/2025, 2:57:40 PM**: Introduction of `HBLListDetails.jsx`.
*   **11/26/2025, 2:58:49 PM**: `HBLListDetails.jsx` started using live HBL data.
*   **11/26/2025, 3:13:47 PM**: `actions.js` updated to include HBL-specific actions.
*   **11/26/2025, 5:55:57 PM**: Initial creation of `HBLform.jsx`, a core component for HBL entry.
*   **11/27/2025, 10:59:07 AM**: Significant changes in `HBLform.jsx` regarding payload structure.
*   **11/27/2025, 12:07:51 PM**: Introduction of `HblEntryFormScreen.jsx` to wrap `HBLForm` with data fetching and modal logic.
*   **11/27/2025, 2:40:18 PM**: `agentBookingApi.js` updated to include `updateHblBooking` mutation, enabling editing of HBLs.
*   **11/27/2025, 2:44:36 PM** and **2:44:56 PM**: `HBLform.jsx` integrated the `updateHblBooking` mutation, distinguishing between create and update operations.
*   **11/27/2025, 3:20:00 PM**: `HblEntryFormScreen.jsx` improved data fetching logic for HBL editing.
*   **11/27/2025, 3:49:59 PM**: Final refinement in `HBLform.jsx` for passing `agent_booking_id` during HBL creation.

### Patterns and Recurring Elements:

*   **HBL Feature Development**: The changes clearly indicate a concentrated effort to implement or refine the House Bill of Lading (HBL) feature, covering API endpoints, list views, and detailed forms.
*   **Redux Toolkit Query (RTK Query)**: All API interactions are handled using RTK Query (`createApi`, `fetchBaseQuery`, `builder.mutation`, `builder.query`, `invalidatesTags`, `providesTags`), demonstrating a consistent pattern for data fetching and state management in the frontend.
*   **`useLocation` for State Passing**: Navigation and data passing between components heavily rely on `useLocation().state`, especially for `agent_booking_id`, `serial_id`, and `formAction` (add/edit/copy). This pattern is used to maintain context across different screens.
*   **`formAction` Prop**: The `formAction` prop (values like "add", "edit", "copy") is a recurring pattern used to control the behavior and initial values of forms, like `HBLForm`.
*   **Data Transformation for Forms/APIs**: There's a consistent pattern of transforming data, especially for party and location fields (e.g., `recoverValue` function splitting "name~code" strings), before sending it to the API. Similarly, fetched data is transformed (`convertToArray`, remapping field names) for display in forms.
*   **Conditional Data Fetching with `skipToken`**: The `skipToken` from RTK Query is frequently used to prevent queries from firing when necessary parameters (like `agent_booking_id` or `serial_id`) are not yet available, optimizing network requests.
*   **Error Handling and User Feedback**: `toast` notifications and `setAlertConfig` for modal error messages are consistently used to provide user feedback on API call results.
*   **Keyboard Shortcuts**: The use of `useKeyboardShortcut` hook for actions like edit, view, add party, and save indicates an emphasis on improving user experience and efficiency.
*   **`serial_id` vs. `agent_booking_id`**: There's an evolving understanding and consistent refinement of whether `serial_id` or `agent_booking_id` is the primary identifier for HBL-related operations, particularly for fetching and updating HBL forms. `serial_id` seems to be becoming the specific identifier for an HBL record, while `agent_booking_id` links it to a broader booking context.
*   **Console Logging for Debugging**: Frequent `console.log` statements throughout the code changes suggest active debugging during development.

## 9:08:25 AM
The provided log details changes across two files related to HBL (House Bill of Lading) entry management.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\hblEntry.controller.ts`**

This file, central to HBL booking logic, saw extensive and iterative development between November 26 and 27, 2025.
Initially, it contained two main asynchronous functions: `createHblMasterBooking` for creating new HBL entries and `saveHblBooking` which seemed intended for a combined create/update flow, often commented out or partially implemented.

Significant changes to `createHblMasterBooking` include:

*   **11/26/2025, 2:32:34 PM**: The `bookingInsertQuery` for `hbl_master` was updated to explicitly include `bookingdate` (previously commented out) and a new `transport_mode` field.
*   **11/26/2025, 2:49:21 PM - 11/26/2025, 6:04:47 PM**: This period shows a fluctuating attempt to incorporate update logic directly into `createHblMasterBooking` using a `req.query.serial_id` or `req.body.serial_id` condition. This conditional logic led to inconsistent behavior, sometimes attempting updates for `hbl_master` and `agent_booking_vessel` but still inserting into `agent_booking_hbl` and associated lists (routing, container, PO). The `serial_id` source also shifted between `req.query` and `req.body`.
*   **11/27/2025, 10:12:30 AM**: The attempt to merge update logic into `createHblMasterBooking` was abandoned, and the function was refactored to focus solely on **creating** new HBL master bookings. The `serial_id` extraction from `req.body` became redundant and was later removed from being used in the insert call.
*   **11/27/2025, 10:37:01 AM - 11/27/2025, 11:05:47 AM**: The creation flow was refined to correctly obtain the `hbl_master_id` from the initial `hbl_master` insertion result and use it to link all subsequent related entries (vessel, HBL details, routing, containers, POs) into their respective tables, ensuring proper foreign key relationships. A `SELECT` query was also introduced to find an existing `booking_serial_id` from `agent_booking_entry` before inserting into `hbl_master`.
*   **11/27/2025, 12:19:04 PM**: A new, dedicated function `updateHblMasterBooking` was introduced. This function robustly handles updates for HBL records by performing direct `UPDATE` SQL queries for `hbl_master`, `agent_booking_vessel`, and `agent_booking_hbl`. For linked data (routing, containers, POs), it implements a "delete and insert" strategy: existing records are first deleted, and then new records are inserted from the request payload. The previously problematic `saveHblBooking` function was removed.
*   **11/27/2025, 12:26:39 PM - 11/27/2025, 3:09:00 PM**: There was a brief change to reduce the fields updated in `hbl_master` and `agent_booking_hbl` during an update, which was then reverted to include more comprehensive field updates in the `updateHblMasterBooking` function.
*   **11/27/2025, 3:24:58 PM**: Date fields (`bookingdate`, `hbldate`) in `createHblMasterBooking` were made more robust by explicitly handling `null` values using `payload.field || null`.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\hblEntry.route.ts`**

This file defines the API endpoints for HBL operations.

*   **11/26/2025, 2:49:43 PM**: A new POST route `/create` was added, mapping to the `createHblMasterBooking` controller function.
*   **11/27/2025, 10:18:23 AM**: The original root POST route (`/`) associated with `saveHblBooking` was commented out, reflecting the consolidation of creation logic into `createHblMasterBooking`.
*   **11/27/2025, 12:21:23 PM**: A new POST route `/update` was added, mapping to the newly introduced `updateHblMasterBooking` controller function.

**Patterns and Recurring Elements:**

*   **Modular Database Interactions**: The code consistently uses `insertMany`, `insertQuery`, `query`, and `updateQuery` from a `database` configuration, indicating a structured approach to database operations.
*   **Transactional Integrity**: Both creation and update operations are wrapped in database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) to ensure data consistency across multiple table modifications.
*   **Input Sanitization**: Almost all incoming request body parameters are sanitized using `sanitizeString`, demonstrating a strong emphasis on security.
*   **Date Formatting**: Dates from the request body are consistently formatted to a `YYYY-MM-DD` database format using `AppDateFormate`.
*   **Clear Separation of Concerns**: Over time, the logic evolved from a mixed create/update function (`saveHblBooking` and early `createHblMasterBooking`) to distinct functions (`createHblMasterBooking` and `updateHblMasterBooking`), improving code organization and maintainability.
*   **Multi-Table Operations**: HBL data is stored across several related tables (`hbl_master`, `agent_booking_vessel`, `agent_booking_hbl`, `agent_booking_routing`, `agent_booking_container`, `agent_booking_po`), and both create and update functions manage these interconnected records.

## 10:11:50 AM
The code changes primarily revolve around implementing and refining House Bill of Lading (HBL) functionality within a booking system, likely an agent-facing frontend application. This includes API integrations, UI components, and data handling.

### File-Specific Updates:

**1. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\store\api\agentBookingApi.js`**

*   **11/26/2025, 2:53:21 PM**: Introduction of HBL-related API endpoints.
    *   `saveHblBooking`: A new `POST` mutation endpoint for creating HBLs, hitting `/hblEntry/create`.
    *   `fetchHblBookingFormDetails`: A new `GET` query endpoint for fetching HBL form details, hitting `/hblEntry`.
    *   `getHblDashboard`: A new `GET` query endpoint for fetching HBL dashboard data, hitting `/hblEntry/get-hbl`.
    *   The `agentBookingApi` also supports existing booking, ISF, carrier booking, and DO update functionalities.
*   **11/26/2025, 5:48:11 PM**: The `saveHblBooking` endpoint's URL was changed from `/hblEntry/create` to `/hblEntry`. This suggests a potential simplification or consolidation of the HBL creation API.
*   **11/27/2025, 10:17:24 AM**: Reverted the `saveHblBooking` URL back to `/hblEntry/create`. This indicates the `/create` suffix was indeed intended or required.
*   **11/27/2025, 2:40:18 PM & 2:41:28 PM**: Introduction of a new mutation endpoint `updateHblBooking` (POST to `/hblEntry/update`) to handle updates for HBLs. This suggests a clear separation between create and update operations for HBLs. The exported hooks were also updated to include `useUpdateHblBookingMutation`.

**2. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLListDetails.jsx`**

*   **11/26/2025, 2:57:40 PM**: Initial creation of `HblListDetails` component.
    *   Imports `useGetHblDashboardQuery` for fetching HBL data and `HBL_COLUMNS` for grid definition.
    *   Includes an "Add HBL" button that navigates to `/app/booking/hbl_form` with `booking_serial_id`, `booking_id`, and `formAction: "add"` in the state.
    *   The `ThemedGrid` uses `isfDummyData` for display.
*   **11/26/2025, 2:58:49 PM**: Significant update to `HblListDetails`.
    *   The `ThemedGrid` now uses `hblData?.data` (fetched from `useGetHblDashboardQuery`) instead of `isfDummyData`.
    *   The `uniqueId` prop for `ThemedGrid` was changed from `agent_booking_id` to `serial_id`. This is crucial for correctly identifying rows in the HBL list.
*   **11/26/2025, 6:03:04 PM**: `useGetHblDashboardQuery` is updated to accept `agent_booking_id` from `location.state`, allowing the HBL list to display records specific to a particular booking.
*   **11/27/2025, 10:25:36 AM**: Added another `console.log` for `location`.
*   **11/27/2025, 2:56:44 PM**: The "Add HBL" button's `onClick` handler was updated to pass `agent_booking_id` from `location.state` when navigating to the HBL form, ensuring new HBLs are associated with the correct booking.

**3. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\data\columns\agent.booking.js`**

*   **11/26/2025, 3:01:38 PM & 11/26/2025, 3:10:12 PM**: No functional changes, identical content. This likely represents a re-save or formatting change. The file defines various column configurations for tables, including `BOOKING_VESSEL_COLUMN`, `BOOKING_CARGO_COLUMN`, and `BOOKING_DASHBOARD_COLUMNS_GRID`. The `HBL_COLUMNS` mentioned in `HBLListDetails.jsx` is implied to be defined within this file as well, though its specific content isn't fully logged.
*   **11/27/2025, 11:03:09 AM**: No functional changes, identical content.

**4. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\actions.js`**

*   **11/26/2025, 3:13:47 PM**: Introduction of `getHblActions` which defines an "Edit HBL" action. This action navigates to `/app/booking/hbl_form` with `agent_booking_id` and `formAction: "edit"`. Also, a new `createHblAction` is added to `getBookingActions` to navigate to `hbl_form_screen`.
*   **11/26/2025, 5:33:49 PM**: No functional change.
*   **11/26/2025, 5:35:42 PM**: The `getHblActions` for "Edit HBL" is updated to pass `serial_id` (from `params.row.serial_id`) instead of `agent_booking_id` to `/app/booking/hbl_form`. This implies that HBLs are uniquely identified by `serial_id` for editing. It also passes `agent_booking_id` along.

**5. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HBLform.jsx`**

*   **11/26/2025, 5:55:57 PM**: Initial creation of `HBLForm` component.
    *   Uses `Formik` for form management and `useSaveHblBookingMutation` to save HBL data.
    *   Handles various HBL details (parties, routing, containers, POs).
    *   Initial values are populated from `initialValues` and `location.state`.
    *   The `handleSave` function constructs a payload and calls `saveBooking`.
    *   Includes party management actions (Edit, View, Add New Party) with keyboard shortcuts.
    *   Navigation after successful save points to `/app/booking`.
*   **11/26/2025, 6:11:50 PM**: The `serial_id` is now explicitly added to the payload for `saveBooking` if the `formAction` is "edit". This confirms that `serial_id` is crucial for distinguishing between new and existing HBLs.
*   **11/27/2025, 10:20:17 AM**: The success navigation after saving an HBL is changed from `/app/booking` to `/app/booking/hbl_form_screen`, retaining `agent_booking_id` and `formAction: "edit"`. This suggests a workflow where saving an HBL might lead back to its parent booking's HBL list/view.
*   **11/27/2025, 10:23:28 AM**: Removed `agent_booking_id` from the navigation state upon successful save, keeping only `formAction: "edit"`.
*   **11/27/2025, 10:29:45 AM**: Reintroduced `agent_booking_id` to the navigation state upon successful save, conditionally using `location.state.booking_id` or `resp.data.agent_booking_id`. This implies the need to persist the context of the parent booking.
*   **11/27/2025, 10:58:43 AM & 11:03:09 AM**: The `serial_id` is removed from the payload of `saveBooking` (commented out), suggesting that for `saveBooking` it is not needed as it's a creation endpoint. However, this is immediately followed by a change that re-adds it.
*   **11/27/2025, 10:59:07 AM**: `booking_serial_id` and `agent_booking_id` are removed from the payload for `saveBooking`, relying on the parent `agent_booking_id` from `location.state` only for navigation.
*   **11/27/2025, 2:44:36 PM, 2:44:56 PM, 2:52:40 PM, 2:54:59 PM, 2:56:53 PM, 3:26:27 PM, 3:30:00 PM, 3:33:27 PM, 3:35:15 PM, 3:49:59 PM**: These changes specifically address the logic within `handleSave` to differentiate between "add" and "edit" modes for HBLs using the `formAction` from `location.state`.
    *   It now conditionally calls `updateHblBooking` if `formAction` is "edit" (passing `serial_id` in the payload) or `saveHblBooking` otherwise.
    *   There's also logic to ensure the correct `agent_booking_id` is used for navigation after a successful save, preferring `location.state.agent_booking_id` if available, or `resp.data.agent_booking_id`.
    *   The `hbldate` and `bookingdate` initial values are explicitly set to `null` if undefined, rather than an empty string, suggesting a type consistency improvement for date fields.

**6. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\HblEntry.jsx`**

*   **11/27/2025, 12:05:38 PM & 12:07:36 PM**: This file imports `HblEntryForm` (which seems to be an alias for `HBLForm` based on other logs). It handles fetching HBL booking details and initializing Redux lists (`containerList`, `routingList`) for the form.
    *   The `useFetchHblBookingFormDetailsQuery` is called with `agent_booking_id` from `location.state`.
    *   It sets `formAction` based on `location.state` (copy/edit).
    *   There's a significant refactoring of how `containerList` items are mapped and added to the Redux store, including renaming `container_type` to `containerType`, `no_of_container` to `containerno`, etc.

**7. `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\booking\hbl\HblEntryFormScreen.jsx`**

*   **11/27/2025, 12:07:51 PM, 12:08:00 PM, 12:08:31 PM, 12:08:43 PM, 3:11:16 PM, 3:12:29 PM, 3:20:00 PM**: This component acts as a wrapper for `HBLForm`, handling initial data fetching for HBL details.
    *   Initially, `useFetchHblBookingFormDetailsQuery` was called with `agent_booking_id`.
    *   **11/27/2025, 12:08:31 PM**: This query parameter for `useFetchHblBookingFormDetailsQuery` was changed from `agent_booking_id` to `serial_id`, suggesting that HBL details are primarily fetched using their unique `serial_id`, not the parent booking ID. The previous variable `hblBbookingDetails` was also renamed to `hblDetails` for consistency.
    *   **11/27/2025, 3:20:00 PM**: The query is made conditional: `isEdit && state?.serial_id ? { serial_id: state.serial_id } : skipToken`. This ensures that data is only fetched for existing HBLs when in "edit" mode and a `serial_id` is available. For new HBLs (`formAction: "add"`), the query is skipped.
    *   It initializes Redux lists (`containers`, `routing`, `po`) based on the fetched `hblDetails`.
    *   Provides functionality for party management (Export, Import, Add, View).

### Patterns and Recurring Elements:

*   **Redux Toolkit Query (RTK Query)**: The application heavily uses RTK Query for API interactions, defining `createApi`, `mutation` and `query` endpoints, `reducerPath`, `baseQuery`, `tagTypes`, `providesTags`, and `invalidatesTags`. This indicates a well-structured and performant data fetching and caching layer.
*   **HBL Focus**: A significant portion of the changes revolves around the "House Bill of Lading" (HBL) feature, including its API, UI components (`HBLListDetails`, `HBLForm`), data structures, and actions.
*   **Form Management**: `Formik` is consistently used for handling form state, validation (`HBLvalidationSchema`), and submission.
*   **Routing and State Management**: `react-router-dom`'s `useLocation` and `useNavigate` hooks are frequently used to pass `state` between routes, especially for `formAction` (add, edit, copy), `agent_booking_id`, and `serial_id`.
*   **Data Transformation**: The `recoverValue` helper function is used to parse string values (e.g., "name~code") into their constituent parts, indicating a common pattern for handling combined ID/name inputs.
*   **UI Components**: Consistent use of `@mui/material` components (Box, Card, Stack, Typography, Button, Chip) and custom components like `ThemedGrid`, `ScreenToolbar`, `ThemedBreadcrumb`, `ThemedModal`, and `AddMasterForm`.
*   **Loading and Error Handling**: `isLoading` and `isFetching` flags from RTK Query are used to display a `Loader` component, and `alertConfig` state is used to display error messages for API failures.
*   **Access Control**: The `useAccess` hook suggests a role-based access control system influencing available actions and UI elements.
*   **Keyboard Shortcuts**: `useKeyboardShortcut` is used to enhance user experience by providing quick access to common actions within forms.
*   **Console Logging**: Numerous `console.log` statements are present throughout the code, indicating active development and debugging. These often display `params`, `values`, `payload`, `resp`, `hblData`, and `location.state`.

In summary, the changes show a robust development effort to integrate and enhance HBL management within the T360 booking application. This involves defining API endpoints, building UI for listing and editing HBLs, handling complex form states, and ensuring proper data flow and error handling. The frequent adjustments to `agent_booking_id` and `serial_id` in navigation and API calls highlight the ongoing refinement of how HBLs are linked and managed relative to their parent bookings.

## 2:57:32 PM
The following log details changes to a single file: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\party\PartyForm.jsx`. All modifications occur within the `onSubmit` function, specifically targeting the post-submission logic when `formAction` is "add" and the `pathname` is `HBL_SCREEN`.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\party\PartyForm.jsx`**
    *   **Initial State (11/28/2025, 2:05:41 PM):** The `onSubmit` success block for `HBL_SCREEN` (when `formAction === "add"`) included calls to `setPartyPageModal` to close a modal and `partyDispatch(setCreatedPartyData)` to update the Redux store with the newly created party's data. This was consistent with the logic for `ISF_SCREEN`.
    *   **First Change (11/28/2025, 2:07:11 PM):** The logic for `HBL_SCREEN` (`formAction === "add"`) was altered to remove the `setPartyPageModal` and `partyDispatch` calls, replacing them with a simple `toast.success("Party Saved Successfully")` message.
    *   **Second Change (11/28/2025, 2:08:11 PM):** The previous changes were largely reverted. The `setPartyPageModal` and `partyDispatch` calls were re-introduced for `HBL_SCREEN` (`formAction === "add"`). Additionally, `onCloseForBooking()` was added, and the `toast.success` message was removed.
    *   **Final Change (11/28/2025, 2:08:52 PM):** The `onCloseForBooking()` call, which was added in the immediate previous commit, was removed from the `HBL_SCREEN` (`formAction === "add"`) block. The state of this specific code block returned to its initial configuration from the 2:05:41 PM timestamp, including `setPartyPageModal` and `partyDispatch(setCreatedPartyData)`.

**Timestamps of Significant Changes:**

*   **11/28/2025, 2:07:11 PM:** Introduction of a change that removed state management and dispatch calls, simplifying the success handling to just a toast message.
*   **11/28/2025, 2:08:11 PM:** Reversal of the previous change, bringing back state management and dispatch, and introducing `onCloseForBooking()`.
*   **11/28/2025, 2:08:52 PM:** A minor adjustment by removing `onCloseForBooking()`, effectively reverting the `HBL_SCREEN` "add" action success handling to its original implementation.

**Patterns or Recurring Elements:**

The changes demonstrate a rapid iteration and refinement process within a short timeframe (approximately 3 minutes). The focus was solely on the post-submission success handling for adding a new party from the `HBL_SCREEN`. There's a pattern of code being added, then removed, and then re-added (or slightly modified) in consecutive commits, indicating an active attempt to find the correct flow for this specific use case, ultimately returning to the initial implementation.