# Activity Summary for 11/21/2025

## 10:54:32 AM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts` was updated twice in quick succession on 11/21/2025.

**Key Changes:**
*   Between 10:07:54 AM and 10:08:08 AM, two `console.log` statements were removed from the `getAll` function.
*   These removed statements were located within the `CUSTOMER` role logic, specifically when pagination (`isPagination`) is enabled:
    *   `console.log("====totalResult",totalResult)`
    *   `console.log("====result",result)`
*   A third `console.log("====total",total)` statement in the same block remains present in both versions.

**File-specific Updates:**
The updates pertain solely to the `company_details.controller.ts` file, indicating a minor code refinement, likely a removal of debugging statements after testing the pagination logic for 'CUSTOMER' role.

**Timestamps of Significant Changes:**
The changes occurred very close together: 11/21/2025, 10:07:54 AM and 11/21/2025, 10:08:08 AM.

**Patterns or Recurring Elements:**
The primary pattern observed is the removal of debugging `console.log` statements, suggesting a quick cleanup after verifying functionality. The core business logic for fetching company names based on `AGENT` (from `agent_po_account_master` table) or `CUSTOMER` (from `mtr_tracking_data` table with pagination support) remains consistent across both timestamps. Both roles filter by a search query and map results to `{ value, label }` format.

## 10:57:15 AM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx` was updated on **11/21/2025, 10:15:47 AM**. The primary change involves a refactor of the `handleLogout` function. Previously, `localStorage` items were cleared after redirection for Auth0 users, or after navigation for normal users. The updated logic now clears `token` and `user` from `localStorage` *before* initiating the redirect for Auth0 users. Additionally, the Auth0 logout redirection target was changed from a `/logout` endpoint to a `/login` endpoint. For non-Auth0 users, the logout process remains similar: `token` and `user` are removed from `localStorage`, and the user is navigated to the root path. Both logout paths dispatch an `auth/logout` action. The component displays user's first name, last name, and role, pulling data from `useFetchUserPreferenceQuery` or `localStorage`, and uses `Dropdown` components for user interaction.

The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` was modified on **11/21/2025, 10:20:01 AM**. This update focuses on managing user authentication and customer selection. A new `isTokenExpired` function was introduced to validate `localUser` and `localToken` against an expiration timestamp. An `useEffect` hook now checks for token expiration on component mount; if expired, it clears `user` and `token` from `localStorage` and redirects to the root path. Otherwise, `initializeSelectedCustomer` is dispatched. Another `useEffect` manages the `selectedCustomer` state based on the user's role: "CUSTOMER" roles automatically have their `companyname` set as the `selectedCustomer` (and stored in `localStorage`), while "ADMIN_V2" roles have the `selectedCustomer` cleared from both Redux state and `localStorage`. The component conditionally renders an `Outlet` only when a `selectedCustomer` is present; if not and the user is an "ADMIN_V2", it displays a message prompting them to select a customer.

**Recurring Patterns:**
Across both files, there's a consistent reliance on `localStorage` for managing user authentication tokens, user details (like `firstname`, `lastname`, `role`), and application-specific states such as `selectedCustomer` and `authtype`. Both components extensively use `react-redux` for state management (`useDispatch`, `useSelector`) and `react-router-dom` for navigation (`useNavigate`, `Outlet`). User roles (e.g., "CUSTOMER", "ADMIN_V2") are a central theme, dictating access, data presentation, and application flow. There's also a clear pattern of clearing `localStorage` items related to user sessions (`token`, `user`) upon logout or session expiration.

## 12:59:39 PM
The `usercard.tsx` file, updated on 11/21/2025, 10:15:47 AM, primarily focuses on the user display and logout functionality. The most significant change is within the `handleLogout` function. Previously, the logic for clearing `localStorage` items (`token`, `user`) for Auth0 users occurred after a redirect, and for normal users, it happened after a `setTimeout`. The updated `handleLogout` now clears `token` and `user` from `localStorage` *before* the redirect for Auth0 users, and crucially, the Auth0 redirect URL has changed from `${link}/logout` to `${link}/login`. For normal users, the `localStorage` items are cleared immediately before navigating to the root path. Both logout paths dispatch an `auth/logout` action. The `localStorage.removeItem('authtype');` line remains commented out in both the old and new `handleLogout` implementations. The component renders user details (first name, last name, role) retrieved from either a `useFetchUserPreferenceQuery` or `localStorage`, and displays them within a dropdown alongside an avatar and a sign-out option.

The `layout.tsx` file, updated shortly after on 11/21/2025, 10:20:01 AM, manages the overall application layout and session control. It includes logic to check for token expiration: if the `user` or `token` is missing from `localStorage`, or if the token's expiration timestamp (`localUser.exp`) is in the past, it clears `localStorage` and redirects the user to the root path. Otherwise, it dispatches `initializeSelectedCustomer()`. A separate `useEffect` hook handles customer selection based on the user's role: "CUSTOMER" roles automatically set their company name as the `selectedCustomer` in both Redux state and `localStorage`, while "ADMIN_V2" roles clear any `selectedCustomer` data. The layout conditionally renders child routes (`<Outlet />`) only if a `selectedCustomer` is present; otherwise, for "ADMIN_V2" users, it displays a message prompting them to select a customer.

Common patterns across both files include:
*   Extensive use of `localStorage` for storing `user` information (including `firstname`, `lastname`, `role`, `companyname`, and `exp`) and `token`.
*   Integration with `react-redux` (`useDispatch`, `useSelector`) for global state management.
*   Navigation control using `react-router-dom` (`useNavigate`, `Outlet`).
*   The `localStorage.removeItem('authtype');` line being consistently commented out suggests this particular piece of logic is either deprecated or not currently in use.

## 12:59:42 PM
The `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts` file saw two updates on **11/21/2025**.
At **10:07:54 AM**, the `getAll` controller function was significantly modified to handle data retrieval based on user roles. For the 'AGENT' role, it fetches distinct company names (`cname`) from the `agent_po_account_master` table, applying a search filter and limiting results to 10. For the 'CUSTOMER' role, the logic was refactored to support conditional pagination. If pagination is enabled, it performs two database queries: one to count the total distinct `account_name`s and another to fetch paginated results from `mtr_tracking_data` using `LIMIT` and `OFFSET`. If pagination is disabled, it fetches 10 distinct `account_name`s. This update also included `console.log` statements for debugging `totalResult` and `result` within the paginated customer data retrieval.
A subsequent update at **10:08:08 AM** to the same file involved a minor cleanup, specifically removing the `console.log("====totalResult",totalResult)` and `console.log("====result",result)` debugging statements from the 'CUSTOMER' role's paginated logic, though `console.log("====total",total)` remained.

The `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts` file was updated on **11/21/2025, 11:40:37 AM**. This update primarily focused on expanding the OTM BOL (Bill of Lading) API endpoints. New routes were added for:
*   `POST /upload_save_edit`
*   `GET /fetch/:common_key`
*   `POST /generate_xml`
*   `POST /send_to_otm`
Additionally, an existing `POST /upload` route, which previously handled file uploads using `uploadMiddleware` and referenced an environment variable for the upload path, was commented out.

**Patterns and Recurring Elements:**
All changes occurred on the same date, **11/21/2025**, indicating a focused development session. The updates demonstrate an ongoing enhancement of a backend API: one file (`company_details.controller.ts`) is improving data retrieval logic, particularly with pagination and role-based access, while the other (`otm_bol.route.ts`) is expanding functionality related to OTM, adding new capabilities for data manipulation and integration. The use of `logger.info` and `logger.error` is consistent in the controller for application logging. SQL queries involving `DISTINCT`, `ILIKE`, `LIMIT`, and `OFFSET` are common patterns for data fetching and filtering.

## 12:59:44 PM
The `App.js` file, timestamped 11/21/2025, 11:31:13 AM and 11:34:00 AM, serves as the main routing configuration for a React frontend application. This file imports a vast number of page components, indicating a comprehensive application with many distinct sections. These sections include user management, various administrative masters (expense codes, destinations, vendors, city master, portmaster), packing lists, service invoices, purchase and sales orders, analytics, settings, commercial invoices, booking, detention, reporting, and a wide array of tracking features (FCL, LCL, Rail, Air, MTR, Trucking details, Shipment Tracking). The application leverages `react-router-dom` for navigation, `@mui/material` for UI theming, and `react-hot-toast` for notifications. A central pattern is the extensive use of `ProtectedRoute` and `AuthGuard` components to implement role-based access control, with a `UserRoleEnum` defining various roles such as ADMIN, CUSTOMER, AGENT, CSF, FRONTOFFICE, BACKOFFICE, SPR\_CUSTOMER, and ADMIN\_V2. The core difference between the two timestamps for `App.js` is a minor adjustment made at 11:34:00 AM, where the `UserRoleEnum.ADMIN_V2` role was specifically removed from the `allowedRoles` array for the "shipment\_tracking" and "booking" routes, although it remains an allowed role for the broader `/app` route.

The `MetricsBox.jsx` file, timestamped 11/21/2025, 11:36:28 AM, defines a React component responsible for displaying various types of charts within an analytics section. This component dynamically renders Bar, Pie, Line, Stacked Bar, and Gauge charts based on the `chartType` property passed to it. It manages its display state, including a `chartView` for different chart types and an `enlarge` state for a full-screen modal view of the charts, utilizing `useState`. `MetricsBox` integrates with Redux via `useSelector` to access analytics-related state. It includes sub-components like `MetricToolbar` for filtering/options and `MetricFooter` for actions, wrapping the charts in a `ThemedModal` for enlarged views. The component also handles cases where no data is available for charting.

**Patterns and Recurring Elements:**

*   **Extensive Routing and Role-Based Access Control:** The application demonstrates a highly granular routing structure with a strong emphasis on `ProtectedRoute` and `UserRoleEnum` for managing user permissions across numerous features.
*   **Modularity and Component-Based Development:** The sheer number of imported screen components in `App.js` and the structure of `MetricsBox.jsx` (which imports multiple chart components and utility components) highlight a modular, component-driven approach to frontend development.
*   **Focus on Logistics and Analytics:** Many routes and components indicate functionality tailored for logistics or supply chain management (e.g., packing lists, BOLs, POs, DSO, container reports, various tracking screens) coupled with robust analytics and reporting capabilities.
*   **Master Data Management:** The presence of "code" screens (Customer, Party, Agent) points to dedicated sections for managing core business entities.
*   **Debugging Artifacts:** The `console.log` statements in `App.js` and `MetricsBox.jsx` suggest that the logs might capture in-development or recently updated code, where debugging statements are still present.

## 2:02:29 PM
The log details recent updates to frontend components related to user authentication, session management, and layout. The changes occurred on **11/21/2025**, with updates at **10:15:47 AM** and **10:20:01 AM**, suggesting a coordinated set of modifications.

### `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx` (Timestamp: 11/21/2025, 10:15:47 AM)

This file, responsible for the user card component, saw significant changes to its logout handling logic. The `handleLogout` function was refactored to ensure `localStorage` items (`token`, `user`) are cleared *before* redirection, especially for Auth0 authenticated users. The Auth0 logout redirect URL was updated from `/logout` to `/login`. The `setTimeout` call previously used for clearing `localStorage` in the "normal" logout path was removed, streamlining the process. The component continues to display user details fetched from both Redux (`useFetchUserPreferenceQuery`) and `localStorage`, and provides a dropdown with a "Sign out" option.

### `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (Timestamp: 11/21/2025, 10:20:01 AM)

The `Layout` component received updates primarily focused on enforcing user authentication and managing customer selection based on user roles. A new `isTokenExpired` function was introduced to check for expired user tokens and `localStorage` user data, which, if found expired, triggers removal of user data and a redirection to the root path. This `useEffect` now also dispatches `initializeSelectedCustomer()` if the token is valid. Another `useEffect` was added to manage the `selectedCustomer` state: "CUSTOMER" roles automatically set their own `companyname` as the `selectedCustomer`, while "ADMIN_V2" roles clear any selected customer. The layout conditionally renders content based on whether a customer is selected, displaying a "Please select a customer" message for "ADMIN_V2" users if none is chosen.

### Recurring Elements and Patterns

Across both files, several patterns are evident:
*   **`localStorage` Usage**: Extensive use of `localStorage` for storing and retrieving user information (`user`, `token`, `authtype`) and user preferences (`selectedCustomer`).
*   **Redux Integration**: Both components leverage Redux for state management, using `useDispatch` to trigger actions and `useSelector` to access global state, and Redux Toolkit Query for data fetching (`useFetchUserPreferenceQuery`).
*   **React Router for Navigation**: `useNavigate` and `Outlet` from `react-router-dom` are used for programmatic navigation and rendering nested routes.
*   **Role-Based Logic**: Conditional logic frequently differentiates behavior based on user roles (e.g., "CUSTOMER" vs. "ADMIN_V2") for features like customer selection and logout redirects.
*   **Authentication Flow Management**: A strong focus on managing the user's authentication state, including token validation, logout procedures, and redirection after session expiry.