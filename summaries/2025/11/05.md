# Activity Summary for 11/5/2025

## 9:40:09 AM
The `src\routes\index.ts` file, updated at 11/4/2025, 7:35:07 PM, underwent significant expansion to consolidate and register a wide array of API routes for the backend. New routes were added for authentication, customer management, line bookings, customer bookings, document uploads, vessel management, vendor management, and job management. Additionally, dedicated endpoints for autocomplete search (`/autocomplete`) and audit logs (`/audit`) were integrated, utilizing `getAll` from `searchOptions` and `getAllAudit` from `auditService` respectively. A previously existing `EnquiryRoutes` section was commented out.

Following shortly after, at 11/4/2025, 7:43:53 PM, the `src\middleware\uploadMiddleware.ts` file was introduced or updated to implement a robust and flexible file upload mechanism. This file exports an `uploadMiddleware` factory function that leverages `multer` for disk storage. Key features include:
*   **Dynamic folder creation:** The middleware can create highly specific destination folders, optionally including `year/month/day/hour-minute-second` within a `mainFolder/subFolder` structure, ensuring unique and organized storage paths.
*   **Directory Management:** It automatically creates the necessary directories recursively if they don't exist.
*   **Unique Filenaming:** Files are renamed upon upload to include a timestamp-based unique suffix, preventing name collisions while retaining the original base name and extension.
*   **File Filtering and Limits:** It accepts all file types by default (though customizable) and enforces a 10MB file size limit.
*   **Versatile Handlers:** The factory function returns an object containing various `multer` handlers (`single`, `array`, `fields`, `any`) to support different file upload scenarios, making it highly adaptable for handling single files, multiple files, or files associated with specific form fields.

The changes indicate a focused development effort within a short timeframe on 11/4/2025, primarily enhancing the backend's routing capabilities to support core business logic and introducing a sophisticated file upload system, suggesting that document management is a critical component of the application.

## 9:41:05 AM
The codebase reflects a focused effort on implementing and refining a document upload feature, alongside a broader expansion of the Redux store.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\store\store.ts` (11/4/2025, 5:57:55 PM):** This file underwent a significant expansion, integrating numerous new Redux API slices and feature slices. Key additions include `customerDataApi`, `uploadDocumentApi`, `lineBookingApi`, `customerBookingApi`, `vesselAndVoyageDataApi`, `jobApi`, `vendorDataApi`, `auditDataApi`, and `enquiryDataApi`. Corresponding feature slices like `customerDashboardSlice`, `lineBookingSlice`, `voyageDashboardSlice`, `jobDashboardSlice`, and `customerBookingSlice` were also added, indicating a substantial increase in the application's data management capabilities.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\pages\upload-docs\uploadDocs.tsx`**: This file shows a clear evolution of the `UploadDocs` page component:
    *   **Initial Creation (11/4/2025, 6:01:03 PM - 6:01:47 PM):** Started as a simple placeholder React component, quickly renamed to `UploadDocs` (PascalCase).
    *   **Layout Integration (11/4/2025, 6:02:46 PM):** Incorporated a `PageWrapper` component for basic UI structure.
    *   **Feature Implementation (11/4/2025, 6:13:16 PM - 6:19:01 PM):** Transformed into a modal-like component with form management (`useFormik`), state for file uploads (`uploadedFile`, `isDragOver`), drag-and-drop functionality, and basic UI elements for a "Confirm Line Booking" action. It also shifted from a default to a named export.
    *   **Component Refactoring (11/4/2025, 6:24:18 PM - 6:29:14 PM):** The core form logic was extracted into a new component named `ConfirmLineBookingForm` (which was then moved to `components/screen/upload-docs/uploadDocs.tsx`). The `pages` file then became a wrapper, importing and rendering this new form component. The title was also updated from "Confirm Line Booking" to "Upload Documents".
    *   **Final Page Structure (11/4/2025, 7:21:01 PM - 7:22:21 PM):** The page component removed the `bg-gray-100` class and fully integrated `ConfirmLineBookingForm` within `PageWrapper.Content`, showcasing a structured layout.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`**: This new file was created as the destination for the refactored document upload component.
    *   **Initial Move (11/4/2025, 6:28:22 PM):** The `ConfirmLineBookingForm` component was moved here, retaining its functionality from the `pages` directory.
    *   **Form Simplification and Renaming (11/4/2025, 6:30:54 PM - 6:31:38 PM):** The "Delivery Order No." input was removed, and the component's internal title changed to "Upload Documents".
    *   **Multiple File Upload Capability (11/4/2025, 7:14:53 PM):** A significant enhancement was introduced, allowing multiple files to be uploaded. The state was updated to `uploadedFiles` (an array), and the file handling logic was modified to append unique files. The UI was adapted to list multiple uploaded files.
    *   **UI/UX Refinements (11/4/2025, 7:16:49 PM - 7:20:24 PM):** Improvements were made to the file input (resetting value after selection, z-index for button overlay), drag-and-drop styling, and overall component appearance (e.g., adding `bg-white`, `shadow-sm`, adjusting text colors).
    *   **Backend Integration (11/4/2025, 7:30:35 PM - 7:32:51 PM):** The component was integrated with `useUploadDocumentMutation` from Redux Toolkit Query to handle actual file uploads to a backend API. This involved processing each selected file in a loop, constructing `FormData`, and sending it to the `/uploadDocument` endpoint. Validation for empty uploads, loading states, and toast notifications for success/failure were added, making it a robust upload mechanism. The submit button text also changed from "Confirm" to "Save".

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\App.tsx`**: This file received updates to reflect the changes in the `uploadDocs` component.
    *   **Route Addition (11/4/2025, 6:01:52 PM):** A new route `/upload-docs` was added, pointing to the `UploadDocs` component.
    *   **Import Adjustments (11/4/2025, 6:15:23 PM - 6:29:36 PM):** The import statement for `UploadDocs` was updated to reflect its change from a default export to a named export.

**Patterns and Recurring Elements:**

*   **Component Refactoring and Organization:** There's a clear pattern of initial development within a `pages` directory, followed by refactoring the core logic into a dedicated component within a `components/screen` directory for better reusability and separation of concerns.
*   **Progressive Enhancement:** The document upload feature was developed incrementally, starting from a basic placeholder, then adding drag-and-drop, single file upload, multiple file upload, and finally backend API integration with comprehensive feedback.
*   **Styling Consistency:** Extensive use of Tailwind CSS classes for consistent styling across UI elements, including dynamic styling for drag-and-drop interactions.
*   **Form Management:** The `useFormik` hook is a recurring element for handling form state, validation, and submission logic.
*   **Redux Toolkit Query Integration:** The Redux store updates and the final implementation of the file upload component demonstrate a strong reliance on Redux Toolkit Query for managing asynchronous data operations and API interactions.
*   **Iconography:** Icons from `@mui/icons-material` (Upload, Close) and `react-icons/fi` (FiFileText, FiTrash2) are consistently used for visual cues, with a brief deviation to `react-icons/hi` before reverting.

## 10:40:50 AM
The log indicates a series of backend infrastructure updates, all occurring on November 4, 2025.

The following changes were observed in specific files:

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\routes\index.ts`** (Timestamp: 11/4/2025, 7:35:07 PM): This file, responsible for main API routing, was updated to include and register several new or existing route modules. These modules cover authentication (`AuthRoutes`), customer management (`CustomerRoutes`, `CustomerBookingRoutes`), line bookings (`LineBookingRoutes`), document handling (`DocumentRoutes`), vessel operations (`VesselRoutes`, `VesselAndVoyageRoutes`), vendor management (`VendorRoutes`), and job-related functionalities (`JobRoutes`). It also integrates `getAll` for autocomplete features and `getAllAudit` for audit services. An `EnquiryRoutes` import and usage were found commented out.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\middleware\uploadMiddleware.ts`** (Timestamp: 11/4/2025, 7:43:53 PM): A new `uploadMiddleware` factory function was introduced or modified. This middleware leverages `multer` to handle file uploads, allowing for dynamic folder creation based on `mainFolder`, `subFolder`, and an optional `dateFolder` parameter which creates a nested directory structure down to hour-minute-second for precise timestamping. It ensures target directories exist, configures disk storage to generate unique filenames by appending a timestamp, and sets a default file size limit of 10MB. The middleware returns various `multer` upload methods (single, array, fields, any) wrapped as Express `RequestHandler`s.

**Patterns and Recurring Elements:**
All significant code changes occurred on the same day, November 4, 2025, within a short span, indicating a focused development session on backend functionalities. The updates primarily involve setting up new API routes and enhancing file upload capabilities with dynamic folder structuring, suggesting work on expanding the system's core features and data management.

## 10:41:14 AM
The log primarily details significant frontend development activities, focusing on the expansion of Redux state management and the iterative development of a new document upload feature.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\store\store.ts`** (Timestamp: 11/4/2025, 5:57:55 PM)
    *   The Redux store configuration underwent a substantial expansion. Numerous new API slices (`vesseDataApi`, `uploadDocumentApi`, `customerDataApi`, `lineBookingApi`, `customerBookingApi`, `vesselAndVoyageDataApi`, `jobApi`, `vendorDataApi`, `auditDataApi`, `enquiryDataApi`) and feature slices (`userReducer`, `enquiryDetailsFormReducer`, `bookingDetailsFormReducer`, `mblDeatilsFormReducer`, `invoiceChargeDetailsReducer`, `vessalVoyageReducer`, `vendorDetailsFormReducer`, `boxPlanDetailsFormReducer`, `customerDetailsReducer`, `vesselDashboardSlice`, `customerDashboardSlice`, `customerFormSlice`, `lineBookingSlice`, `lineBookingDashboardSlice`, `voyageDashboardSlice`, `jobDashboardSlice`, `customerBookingSlice`, `vendorDashboardSlice`, `customerDashboardDataSlice`) were added to the `combineReducers` and `middleware`. This indicates a significant increase in the application's complexity and scope, with more data models and associated API interactions being integrated into the global state.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\pages\upload-docs\uploadDocs.tsx`**
    *   **Initial creation (11/4/2025, 6:01:03 PM - 6:01:47 PM)**: Started as a basic React functional component displaying "uploadDocs".
    *   **UI Structure Integration (11/4/2025, 6:02:46 PM)**: Wrapped in `PageWrapper` components for layout.
    *   **Functional Refactor to Modal (11/4/2025, 6:13:16 PM - 6:19:01 PM)**: Transformed into a `ConfirmLineBookingPopupProps` component, acting as a modal with drag-and-drop file upload capabilities using `useFormik`, `@mui/icons-material`, and `react-icons/fi`. It handled a single file upload with a "Delivery Order No." input. The export type changed from default to named (`export const UploadDocs`). Minor styling adjustments and icon changes (`X` to `Close`).
    *   **Component Relocation and Wrapper (11/4/2025, 6:28:52 PM - 6:29:14 PM)**: The core form logic was extracted into a new component `ConfirmLineBookingForm` located at `src\components\screen\upload-docs\uploadDocs.tsx`. This file then became a wrapper page, importing and rendering `ConfirmLineBookingForm`. The component was also renamed from `Home` to `UploadDocs`.
    *   **Layout Integration (11/4/2025, 7:22:21 PM)**: The `UploadDocs` page component was further integrated into the application's `PageWrapper` layout, featuring a left sidebar (`PageWrapper.Left`) and main content area (`PageWrapper.Content`).

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`**
    *   **Creation and Initial Form (11/4/2025, 6:24:18 PM)**: This file was created, initially named `ConfirmLineBookingForm`, and contained the detailed file upload form logic previously in `src\pages\upload-docs\uploadDocs.tsx`. It included input for "Delivery Order No." and single file upload with drag-and-drop. It utilized local UI components like `@components/kit/button`, `@components/kit/input`, `@mui/icons-material/Label`.
    *   **Feature Refinement & Multi-File Support (11/4/2025, 6:30:54 PM - 7:14:53 PM)**:
        *   The "Delivery Order No." input field was removed from the UI (though `formik.initialValues` retained it).
        *   The component title changed from "Confirm Line Booking" to "Upload Documents".
        *   **Crucially, it was refactored to support multiple file uploads** by changing `uploadedFile` state to `uploadedFiles: File[]`, modifying `handleFileUpload` to append unique files, and updating the UI to display a list of uploaded files with individual remove buttons. The file input was made `multiple`.
    *   **UI/UX Enhancements (11/4/2025, 7:16:49 PM - 7:20:24 PM)**: Improvements were made to the drag-and-drop area's styling, `z-index` for the file input overlay, and the default background color of the form and file list items. The `handleFileInputChange` was updated to clear the input value, allowing re-selection of the same file.
    *   **Backend Integration and Submission Logic (11/4/2025, 7:30:35 PM - 7:32:51 PM)**:
        *   Integrated `useUploadDocumentMutation` from `store/api/uploadDocumentApi` and `react-hot-toast` for user feedback.
        *   The component's logic was significantly overhauled. The `onSubmit` function now iterates through the `uploadedFiles`, constructs `FormData` for each, and calls the `uploadDocument` mutation. It includes loading states (`isUploading`), error handling, and success/error toasts.
        *   The form clears uploaded files and resets on successful submission or when "Cancel" is clicked.
        *   Despite the multi-file functionality being re-introduced, the `deliveryOrderNo` input is still not rendered, but its value from `formik.initialValues` is used as a "remark" in the `FormData`.
    *   **Minor Styling Adjustments (11/4/2025, 7:44:45 PM)**: No functional changes, only minor whitespace and code formatting.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\App.tsx`**
    *   **Integration of `UploadDocs` Route (11/4/2025, 6:01:52 PM)**: A new route `/upload-docs` was added, pointing to the `UploadDocs` page component, making the new feature accessible in the application.
    *   **Import Adjustments (11/4/2025, 6:15:23 PM - 6:29:36 PM)**: The import statement for `UploadDocs` was adjusted to reflect changes in its export type (named vs. default) in its respective file (`src\pages\upload-docs\uploadDocs.tsx`).

**Patterns and Recurring Elements:**

*   **Redux Toolkit for State Management and APIs:** The `store.ts` file shows extensive use of `@reduxjs/toolkit` for managing application state and integrating with various APIs (e.g., `vesseDataApi`, `customerDataApi`, `uploadDocumentApi`). This indicates a standardized approach to data fetching and state handling.
*   **Component-Based Development:** The document upload feature was developed iteratively, starting as a single component, then refactored into a parent page (`pages/upload-docs`) wrapping a dedicated, reusable form component (`components/screen/upload-docs`). This demonstrates a clear separation of concerns and reusability.
*   **Formik for Form Handling:** `useFormik` is consistently used for managing form state, initial values, and submission logic in the upload components.
*   **Drag-and-Drop File Upload:** The document upload feature heavily relies on drag-and-drop functionality, complemented by a traditional file input button, providing a user-friendly interface for file selection.
*   **Styling with Tailwind CSS:** The presence of utility classes like `bg-black/40`, `text-lg font-semibold text-gray-800`, `border-2 border-dashed`, `rounded-md px-3 py-2`, `space-y-4` across the UI components suggests the use of Tailwind CSS for styling.
*   **Icon Library Usage:** Icons from `@mui/icons-material` (Upload, X/Close, Label) and `react-icons/fi` (FiFileText, FiTrash2) are frequently used for visual cues.
*   **Progressive Enhancement/Refinement:** The document upload component underwent multiple stages of refinement, from a basic placeholder to a fully functional multi-file uploader with backend integration, error handling, and UI feedback.
*   **Frontend-Backend Integration:** The integration of `useUploadDocumentMutation` and `FormData` directly within the component's `onSubmit` logic highlights a direct coupling between the frontend form submission and the backend API for document uploads.

## 11:41:03 AM
The recent code changes primarily focus on enhancing document management functionalities, including file uploading, storage, and retrieval, along with updates to API routing.

**File-specific Updates:**

*   **`src\routes\index.ts` (11/4/2025, 7:35:07 PM):** An `Audit` route (`apiRouter.use(Paths.Audit.Base, getAllAudit)`) was introduced, integrating `getAllAudit` from `auditService`. Concurrently, `EnquiryRoutes` and its corresponding usage were commented out, indicating a temporary suspension or deprioritization of that feature.
*   **`src\middleware\uploadMiddleware.ts` (11/4/2025, 7:43:53 PM):** This file underwent a significant update, introducing a `uploadMiddleware` factory function. This new middleware allows for dynamic creation of upload directories, supporting a date-based folder structure (e.g., `mainFolder/subFolder/year/month/day/hour-minute-second`). It ensures that target directories exist (creating them recursively if not), assigns unique filenames, and sets a file size limit of 10MB. The function returns various Multer upload handlers (`single`, `array`, `fields`, `any`).
*   **`src\services\documentService.ts` (11/5/2025, 11:22:29 AM):** The `uploadDoc` function was updated to handle document uploads, requiring `ref_type` and `ref_id` parameters. More notably, the `downloadDoc` function was enhanced to search for files in a new, more structured date-based path (`basePath/ref_type/year/month/day/file_name`) before falling back to older path conventions (`basePath/ref_type/file_name` and `basePath/file_name`). Extensive `console.log` statements were added to assist in debugging the file path resolution.
*   **`src\common\util\globalUpload.ts` (Multiple timestamps on 11/5/2025, between 11:23:47 AM and 11:36:05 AM):** This file saw rapid, iterative changes focused on the `saveDoc` function.
    *   Initially (11:23:47 AM), the file saving logic shifted to create a target folder structure incorporating `ref_type`, `year`, `month`, and `day`.
    *   Subsequent updates (11:26:32 AM, 11:27:17 AM, 11:28:12 AM, 11:35:10 AM, 11:36:05 AM) show active experimentation with the exact format of the generated folder path. The directory creation evolved from `path.join(globalBasePath, ref_type, year, month, day)` to various concatenations like `globalBasePath, ref_type + year + month + day` and `globalBasePath, ref_type +'_' + year + month + day`. The final recorded change reverts to a structure similar to `globalBasePath, ref_type +'_' + year + month + day`.
    *   A consistent change across these iterations is that the `document_path` stored in the database is now just the `fileName`, simplifying from previous commented-out versions that stored a `relativePath`.
    *   The file contains substantial commented-out code, indicating previous iterations or experimental changes to the `saveDoc` logic.

**Patterns and Recurring Elements:**

*   **Focus on Document Management:** The most prominent pattern is the intensive development around file upload and download capabilities. This includes dedicated middleware for uploads, service functions, and a core utility for saving documents.
*   **Dynamic and Date-based Folder Structures:** There's a clear strategic decision to organize uploaded files into dynamic folders. These folders utilize `ref_type` (a reference type) and current date components (year, month, day, and even time in `uploadMiddleware`) to create a more organized and potentially scalable storage system.
*   **Debugging and Iteration:** The frequent, rapid updates to `globalUpload.ts` and the inclusion of numerous `console.log` statements in `documentService.ts` point to active debugging and refinement of the file storage and retrieval logic. This suggests the team is actively working to stabilize and optimize these new features.
*   **Database Interaction for Metadata:** The process consistently involves saving metadata about the uploaded documents (such as `ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, `uploaded_by`) into a `document_upload` database table, indicating a structured approach to tracking files.

## 11:41:30 AM
The development log primarily details the evolution of a file upload feature and significant updates to the application's Redux store. All changes occurred on 11/4/2025, indicating a focused development period.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\store\store.ts` (11/4/2025, 5:57:55 PM):**
    *   Underwent a major expansion to its Redux store configuration.
    *   Numerous new API endpoints (`customerDataApi`, `uploadDocumentApi`, `lineBookingApi`, `customerBookingApi`, `vesselAndVoyageDataApi`, `jobApi`, `vendorDataApi`, `auditDataApi`, `enquiryDataApi`) were imported and integrated into the `appReducer` and middleware.
    *   Many new Redux slices (`customerDetailsReducer`, `vesselDashboardSlice`, `customerDashboardSlice`, `customerFormSlice`, `lineBookingSlice`, `lineBookingDashboardSlice`, `voyageDashboardSlice`, `jobDashboardSlice`, `customerBookingSlice`, `vendorDashboardSlice`, `customerDashboardDataSlice`) were also added to the store, indicating significant feature development across various modules.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\pages\upload-docs\uploadDocs.tsx` and `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`:**
    *   **Initial Setup (11/4/2025, 6:01:03 PM - 6:02:46 PM):** The `uploadDocs.tsx` file was initially created as a placeholder page, then quickly renamed to `UploadDocs` (PascalCase) and integrated into a `PageWrapper` for basic layout.
    *   **Feature Development & Refactoring (11/4/2025, 6:13:16 PM - 6:31:38 PM):**
        *   The component was rapidly transformed into a functional modal/popup named `ConfirmLineBookingPopupProps`, incorporating `useFormik` for form management and supporting single file uploads with drag-and-drop.
        *   It then underwent a significant structural change, being moved from `src\pages` to `src\components\screen` (11/4/2025, 6:28:22 PM), signifying its evolution into a reusable component.
        *   The original `pages/upload-docs/uploadDocs.tsx` was subsequently re-established as a wrapper, importing and rendering the newly relocated component.
        *   The component's internal header title was changed from "Confirm Line Booking" to "Upload Documents" (11/4/2025, 6:31:38 PM), reflecting its true purpose.
    *   **Multiple File Uploads & Backend Integration (11/4/2025, 7:14:53 PM - 7:32:51 PM):**
        *   The component was enhanced to support multiple file uploads (11/4/2025, 7:14:53 PM), including logic to prevent duplicate files and display a list of uploaded items.
        *   Significant styling refinements were applied to the drag-and-drop area and overall form presentation (11/4/2025, 7:20:24 PM).
        *   Crucially, the component was integrated with the `useUploadDocumentMutation` RTK Query hook (11/4/2025, 7:32:51 PM) to handle actual file uploads to a backend API. This included implementing loading states, success/error toasts, and form reset logic. Each file is submitted as a `FormData` object with `document_type`, `ref_type`, `remark`, and `uploaded_by` fields.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\App.tsx` (11/4/2025, 6:01:52 PM - 6:29:36 PM):**
    *   Initially imported and added a route for the new `UploadDocs` page.
    *   Subsequent minor changes were made to align the `UploadDocs` import statement with changes in its export method within its source file.

**Patterns and Recurring Elements:**

*   **Modular Development:** A strong pattern of component refactoring and modularization is evident, as `uploadDocs.tsx` transitioned from a page-level component to a reusable "screen" component.
*   **Redux Toolkit and RTK Query:** The application consistently uses Redux Toolkit for state management and RTK Query for efficient data fetching and mutation, as seen in the extensive updates to `store.ts` and the integration of `useUploadDocumentMutation`.
*   **Form Management:** `Formik` is consistently used for handling form state and submissions, particularly within the file upload component.
*   **UI/UX Enhancements:** Frequent adjustments to Tailwind CSS classes and the integration of custom UI kit components (`Button`, `Input`, `Label`) indicate an ongoing focus on improving the user interface and experience.
*   **Iterative Development:** The `uploadDocs.tsx` component shows a highly iterative development process, with rapid changes to functionality, UI, and backend integration.
*   **Inconsistencies:** A notable inconsistency is present in the `ConfirmLineBookingForm` component: the `deliveryOrderNo` field remains in `formik.initialValues` and the `onConfirm` callback's interface, but the corresponding input element has been removed from the UI. This means `deliveryOrderNo` is likely an empty string when submitted. Additionally, the `pages/upload-docs/uploadDocs.tsx` `handleConfirm` callback has not been updated to reflect the `files: File[]` type expected by the `ConfirmLineBookingForm` component.

## 2:25:07 PM
The file `src/routes/AuthRoutes.ts` was updated on 11/5/2025, 12:54:56 PM. This update primarily introduces a new GET endpoint under `Paths.Auth.GetUserInfo`. This route is designed to retrieve and return information about the currently authenticated user. Specifically, it logs "User Info Requested:" along with the `req.user` object and then responds with the user's data in a JSON format with an HTTP status of OK. The file leverages Express Router for defining routes and imports common types, path constants, and HTTP status codes from internal `@src` modules.

## 2:25:18 PM
The `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx` file underwent several rapid and distinct transformations between a frontend React component and a backend utility function.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`**
    *   **Initial state (11/5/2025, 1:57:52 PM):** The file started as a React functional component `ConfirmLineBookingForm`. This component provides a UI for uploading documents, including drag-and-drop functionality, file selection, and displaying a list of selected files. It uses `formik` for form management, `react-hot-toast` for notifications, and interacts with a `useUploadDocumentMutation` API. In the `onSubmit` handler, it constructs `FormData` for each file, appending `document_type`, `remark`, `file`, `ref_id`, and `uploaded_by`. Notably, the `ref_type` field (`formData.append("ref_type", "upload_doc");`) was commented out, meaning this specific field was not being sent to the backend.
    *   **Minor Frontend Update (11/5/2025, 2:03:46 PM):** A small but significant change occurred in the frontend component. The previously commented-out line `formData.append("ref_type", "upload_doc");` was uncommented. This modification ensures that the `ref_type` field with the value "upload_doc" is now explicitly included in the `FormData` sent during file uploads.
    *   **Major Backend Logic Introduction (11/5/2025, 2:06:55 PM):** The file's content dramatically changed from a frontend React component to a backend utility function named `saveDoc`. This new implementation imports Node.js modules like `path`, `fs`, and `moment`. It defines an interface `SaveDocParams` that includes `ref_type`, `ref_id`, `document_type`, `remark`, `uploaded_by`, and `files` (typed as `Express.Multer.File[]`). The function's core logic involves determining target upload paths based on environment variables (`UPLOAD_DOC_PATH`, `GLOBAL_DOC_PATH`) and `ref_type`, creating directories if they don't exist, renaming uploaded files with a timestamp, moving files from temporary locations, and inserting document metadata into a `document_upload` database table.
    *   **Backend Type Adjustment (11/5/2025, 2:07:18 PM):** A slight modification was made to the `saveDoc` backend function. The `files` property in the `SaveDocParams` interface was changed from `Express.Multer.File[]` to `File[]`. The underlying implementation, however, still relied on file properties and `fs` operations typically associated with server-side file handling, suggesting this was a type definition change without a full re-evaluation of the `File` object structure in a Node.js context.
    *   **Reversion to Frontend (11/5/2025, 2:07:54 PM):** The file content reverted entirely back to the React component, specifically to the state from 11/5/2025, 2:03:46 PM. This means the frontend component was restored, and the `ref_type` field remained uncommented and active in the `FormData`.
    *   **Final Frontend Adjustment (11/5/2025, 2:08:32 PM):** The file content again reverted to an earlier state of the React component, specifically the initial version from 11/5/2025, 1:57:52 PM. This change re-comments the `formData.append("ref_type", "upload_doc");` line, making the `ref_type` field inactive once more.

**Timestamps of Significant Changes:**

*   **11/5/2025, 1:57:52 PM:** Initial frontend component version with `ref_type` commented out.
*   **11/5/2025, 2:06:55 PM:** Major shift to a backend file-saving utility function, replacing the entire frontend component.
*   **11/5/2025, 2:07:54 PM:** Complete reversion back to the frontend component, with `ref_type` uncommented.
*   **11/5/2025, 2:08:32 PM:** Final reversion to the initial frontend component state, with `ref_type` commented out again.

**Patterns or Recurring Elements:**

The most prominent pattern is the file `uploadDocs.tsx` oscillating between being a frontend React component and a backend Node.js utility function. This suggests a potential issue in file organization, temporary placement of backend logic in a frontend directory, or a rapid iteration/testing phase where different implementations were tried in the same file path. Within the frontend component, there's a recurring pattern of toggling the `formData.append("ref_type", "upload_doc");` line between commented and uncommented states, indicating an ongoing decision or experiment related to this specific data field in the API request.

## 2:48:40 PM
The `src\common\util\globalUpload.ts` file underwent several significant revisions over a short period, focused on enhancing document upload and storage logic. Initially (11/5/2025, 1:50:30 PM), the `saveDoc` function established a `globalBasePath` and created subfolders based on `ref_type`, storing original filenames in the `document_upload` database table alongside timestamped physical files.

A brief change (11/5/2025, 1:54:52 PM) attempted to simplify by primarily using a static `UPLOAD_DOC_PATH` and removing `ref_type` subfolder creation, with an ephemeral addition of `dotenv.config()`.

The file then evolved rapidly (starting 11/5/2025, 1:59:53 PM) to a more robust path determination strategy. Key changes include:
*   Making the `ref_type` parameter optional in the `SaveDocParams` interface.
*   Introducing both `uploadBasePath` (a default static path, e.g., `../../uploads` or from `UPLOAD_DOC_PATH` env) and `globalBasePath` (from `GLOBAL_DOC_PATH` env, or defaulting to `uploadBasePath`).
*   Implementing conditional logic to determine the `finalBasePath`: if `ref_type` is provided, it creates a subfolder (`globalBasePath/ref_type`); otherwise, it uses the static `uploadBasePath`.
*   The `ref_type` value stored in the database was initially allowed to be `null` (1:59:53 PM) but was later standardized (11/5/2025, 2:09:40 PM) to default to `"upload_doc"` if not explicitly provided, ensuring the database column is never null.
*   Consistency in creating target folders if they don't exist and renaming uploaded files with a `YYYYMMDD_HHmmss` timestamp, while storing only the original filename in the database (`document_path` field).
*   Added console logs for better debugging and clarity, including warning for missing file paths and using emojis for success/failure/info messages (visible in 2:08:03 PM, 2:09:40 PM, and 2:42:23 PM, though some emojis were later removed).
*   The logic for path determination and `ref_type` handling largely stabilized by 11/5/2025, 2:09:40 PM, with subsequent changes being minor refinements in comments or console output (2:11:31 PM, 2:12:13 PM, 2:15:55 PM, 2:22:33 PM, 2:23:07 PM, 2:42:23 PM, 2:45:57 PM).

Concurrently, the `src\services\vendorServices.ts` file (11/5/2025, 2:14:22 PM) demonstrates the integration of the `saveDoc` function.
*   In the `getAll` function, it now fetches associated `document_upload` records for vendors using `ref_type = 'vendor_doc'` and attaches them to the vendor data.
*   The `addVendor` function utilizes `saveDoc` to upload multiple documents related to a vendor, setting `ref_type` to `"vendor_doc"` and `ref_id` to the newly created vendor's `serial_id`.
*   The `updateVendor` function includes logic to delete existing `document_upload` records based on `serial_id` and `ref_type = 'vendor_doc'` if they are marked for deletion.

**Patterns and Recurring Elements:**
*   **Dynamic Path Handling:** A consistent effort to manage file upload paths dynamically based on environment variables (`UPLOAD_DOC_PATH`, `GLOBAL_DOC_PATH`) and the provided `ref_type`.
*   **Timestamping Files, Not DB Entries:** Physical files are always renamed with a `_timestamp` suffix for uniqueness, but the `document_path` in the database consistently stores the original filename.
*   **`document_upload` Table Interaction:** The `saveDoc` function reliably inserts metadata into `document_upload`, and `vendorServices` demonstrates both retrieval and deletion from this table using `ref_type` and `ref_id`.
*   **Error Handling:** All `saveDoc` iterations include a `try...catch` block to handle potential file system or database errors.
*   **Environment Variable Configuration:** The log shows repeated adjustments to `GLOBAL_DOC_PATH` and `UPLOAD_DOC_PATH` in `.env.development`, indicating ongoing configuration changes for file storage locations (e.g., switching between Windows and Linux paths).

## 3:25:08 PM
The file `src\routes\AuthRoutes.ts` was updated on 11/5/2025, 12:54:56 PM. This change introduces or modifies an authentication route designed to retrieve user information. Specifically, a GET endpoint mapped to `Paths.Auth.GetUserInfo` has been implemented. This endpoint logs the requested user information (from `req.user`) to the console and then responds with the user object in JSON format, using an `HttpStatusCodes.OK` (200) status. The file imports necessary modules like `express.Router`, custom types for request/response, and constants for paths and HTTP status codes.

## 3:25:12 PM
The changes observed across the log primarily focus on two files: `sidebar-layout.tsx` and `dashboard-page.tsx`, with a final update to `usercard.tsx`.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar-layout.tsx` (Timestamp: 11/5/2025, 2:54:04 PM)**
    *   This file defines the `AppSidebarLayout` component.
    *   It imports various UI components from `@components/kit` such as `Avatar`, `Dropdown`, `Navbar`, and `SidebarLayout`.
    *   It also imports icons from `@heroicons/react` (both 16/solid and 20/solid versions).
    *   The `AppSidebarLayout` component renders a `SidebarLayout` which includes a `Navbar` (with a `NavbarSpacer`) and a `SideBar` component, wrapping the `children` content. This suggests a foundational layout component for the application.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (Timestamps: 11/5/2025, 2:58:06 PM, 2:58:53 PM, 3:03:35 PM, 3:03:46 PM)**
    *   This file represents the main dashboard page.
    *   It imports a vast array of components, hooks, and utilities, indicating a feature-rich page:
        *   UI components: `PageWrapper`, `Card`, `AppGrid`, `DatePeriodSelector`, `Calendar`, `Dialog`, `Badge`, `Button`, `Spinner`, `GlobalSearch`.
        *   Icons: Many from `react-icons/fa6`, `react-icons/hi2`, `react-icons/bs`, `react-icons/fa`, `react-icons/io5`, `react-icons/rx`, `react-icons/md`.
        *   Data management: `useEffect`, `useMemo`, `useState`, `useDispatch`, `useSelector` (from `react-redux`), `useNavigate` (from `react-router-dom`).
        *   API interaction: `useFetchShipmentDataQuery`, `useFetchCartDataQuery`, `useFetchDeliveryDataQuery` (from `store/api`).
        *   State management: `dashboardSetFilters`, `dashboardSetPagination`, `dashboardSetSortModel`, `setCardFilter`, `setDateRange`, `setPeriod` (from `store/fretures/shipment-dashboard-slice`).
        *   Types and constants: `CalendarDay`, `NotificationItemValues`, `DeliveryType`, `FilterType`, `DashboardState`, `ShipmentStatusType`, `SHIPMENT_STATUS`, `SHIPMENT_STATUS_FILTERS`.
    *   Key functionalities implemented in the dashboard:
        *   Fetching shipment data, delivery data, and dashboard card data using Redux Toolkit Query.
        *   Managing dashboard filters (shipment\_id, fromDate, toDate, status), pagination, and sorting via Redux.
        *   Calendar logic to display deliveries and vessels, with a `determineDeliveryMode` function to categorize deliveries.
        *   Handlers for page changes (`handlePage`, `handlePageSizeChange`), filter changes (`handleFilterChange`, `handleClearFilters`), and card clicks (`handleCardClick`) which can scroll to a datagrid.
        *   A `getIcons` utility function to map icon types to corresponding React icons for recent updates.
        *   Retrieval of user data from `localStorage`.
    *   The repeated entries for this file show minor or no substantive code changes, suggesting frequent saves or minor internal modifications within the file. The content remains largely identical across these timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx` (Timestamp: 11/5/2025, 3:05:14 PM)**
    *   This file defines the `UserCard` component, likely used in a sidebar or header for user-related actions.
    *   It imports UI components like `Dropdown`, `DropdownButton`, `DropdownItem`, `DropdownLabel`, `DropdownMenu`, `SidebarItem`, `Avatar`.
    *   Icons: `MdOutlineKeyboardArrowDown`, `IoLogOut`.
    *   Data and navigation: `useFetchUserPreferenceQuery`, `useDispatch`, `useNavigate`.
    *   Includes a `getInitials` helper function to generate initials from a user's name.
    *   The `handleLogout` function is present, with logic to handle both "auth0" and "normal" logout scenarios, including clearing `localStorage` items (`token`, `user`) and dispatching a Redux logout action. It redirects the user based on the authentication type.
    *   The component displays the user's name and role, and provides a "Sign out" option in a dropdown menu.

**Timestamps of Significant Changes:**

*   **11/5/2025, 2:54:04 PM:** Initial definition or major update of `AppSidebarLayout`, establishing the core layout structure.
*   **11/5/2025, 2:58:06 PM:** First recorded substantial state for `DashboardPage`, detailing its complex functionality, data fetching, and state management.
*   **11/5/2025, 3:05:14 PM:** Update to `UserCard`, including the logout functionality and user display.

**Patterns or Recurring Elements:**

*   **Component-based Architecture:** The project heavily uses React components (e.g., `AppSidebarLayout`, `DashboardPage`, `UserCard`) and imports smaller, reusable UI components from a `@components/kit` or `@components/common` directory, indicating a modular design.
*   **Redux for State Management:** `react-redux` (`useDispatch`, `useSelector`) and Redux Toolkit Query (`useFetch...Query`) are consistently used for managing application state, fetching data, and handling mutations, particularly evident in the `dashboard-page.tsx`.
*   **Styling and Icons:** Extensive use of `react-icons` libraries (e.g., `react-icons/fa6`, `@heroicons/react`) for various UI elements across components.
*   **Date/Time Handling:** `moment` library is used for date manipulation, especially in `dashboard-page.tsx` for calendar logic.
*   **User Authentication/Session Management:** `localStorage` is used to store user information and authentication type (`authtype`, `user`, `token`), which is then accessed for displaying user details and handling logout logic. Console logs are used for debugging user information and logout processes.
*   **Frequent Saves/Minor Tweaks:** The `dashboard-page.tsx` file appears in consecutive log entries with very close timestamps and identical code, suggesting either automated saves, minor non-substantive changes, or a period of active development and refinement without significant functional additions between the logged states.
*   **Navigation:** `react-router-dom`'s `useNavigate` hook is used for programmatic navigation within the application.
*   **Separation of Concerns:** Data fetching logic, UI components, and state management logic are typically separated into distinct files and modules (e.g., `store/api`, `store/fretures`, `components/kit`).

## 3:25:16 PM
The log exclusively details changes to a single file: `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`.

Initially, at **11/5/2025, 1:57:52 PM**, the file contained a React functional component named `ConfirmLineBookingForm`. This component is responsible for handling document uploads, featuring:
*   State management for `uploadedFiles`, drag-and-drop (`isDragOver`), and upload status (`isUploading`).
*   Form submission logic using `formik` for a `deliveryOrderNo`.
*   Integration with a `useUploadDocumentMutation` API for backend uploads.
*   Client-side file handling including selection, drag-and-drop, and removal of files.
*   Visual feedback using `react-hot-toast` for success/error messages.
*   Styling using Tailwind CSS classes.
*   Crucially, the `ref_type` field in the `FormData` being appended for upload (`formData.append("ref_type", "upload_doc");`) was commented out.

A minor update at **11/5/2025, 2:03:46 PM** involved uncommenting the `formData.append("ref_type", "upload_doc");` line, ensuring "upload_doc" is sent as the `ref_type` with each file.

Significantly, the file's content was entirely replaced at **11/5/2025, 2:06:55 PM**. The React component was swapped out for a Node.js backend utility function named `saveDoc`. This utility function:
*   Manages server-side file saving, utilizing `path`, `fs`, and `moment` libraries.
*   Determines target upload paths based on `process.env.UPLOAD_DOC_PATH` and `process.env.GLOBAL_DOC_PATH`, supporting dynamic folder creation based on `ref_type`.
*   Renames files with a timestamp to prevent collisions.
*   Inserts document metadata (like `ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, `uploaded_by`) into a `document_upload` database table via a `query` function.
*   At **11/5/2025, 2:07:18 PM**, a small refinement was made to the `saveDoc` function's `SaveDocParams` interface, changing the type of `files` from `Express.Multer.File[]` to `File[]`.

The file then reverted back to its original React component content at **11/5/2025, 2:07:54 PM**. This version was identical to the state at 2:03:46 PM, with `formData.append("ref_type", "upload_doc");` being active.

However, almost immediately after, at **11/5/2025, 2:08:32 PM**, the `formData.append("ref_type", "upload_doc");` line was commented out again, reverting to the initial state regarding this specific parameter.

Finally, at **11/5/2025, 2:42:29 PM**, the `formData.append("ref_type", "upload_doc");` line was uncommented once more, bringing the file back to a state where "upload_doc" is actively sent as `ref_type`.

**Key Patterns:**
A prominent pattern observed is the repeated toggling (commenting/uncommenting) of the `formData.append("ref_type", "upload_doc");` line within the React component's `onSubmit` logic. This suggests ongoing indecision or experimentation regarding whether this specific `ref_type` parameter should be sent with the uploads. The brief interlude where the file's entire content changed to a backend utility is a significant, but temporary, anomaly in the log.

## 3:48:46 PM
**File: `src\common\util\globalUpload.ts`**

This file, primarily containing the `saveDoc` function, underwent significant evolution between 1:50 PM and 2:45 PM.

*   **Initial State (11/5/2025, 1:50:30 PM):** The `saveDoc` function was introduced, designed to save uploaded files. It determined a base path using `process.env.GLOBAL_DOC_PATH` or `process.env.UPLOAD_DOC_PATH`, or a default `uploads` folder. It created subfolders based on `ref_type`, renamed files with a timestamp for storage, and inserted document metadata (including the original filename as `document_name` and `document_path`) into a `document_upload` database table.
*   **Early Adjustments (11/5/2025, 1:54:52 PM - 2:01:26 PM):**
    *   Briefly (1:54:52 PM), `dotenv` was imported and configured locally, and the logic was simplified to save files directly into a static `UPLOAD_DOC_PATH` without `ref_type` subfolders.
    *   Soon after (1:59:53 PM), `dotenv` import was removed, `ref_type` in `SaveDocParams` was made optional, and the dynamic subfolder creation logic (using `globalBasePath/ref_type` if `ref_type` exists, else `uploadBasePath`) was reintroduced. This allowed `ref_type` to be `null` in the database.
    *   A minor revert (2:01:26 PM) temporarily made `ref_type` required again and simplified the folder pathing, similar to the initial version, while introducing a minor typo.
*   **Refinement of Pathing and `ref_type` Handling (11/5/2025, 2:08:03 PM - 2:09:40 PM):**
    *   A more robust conditional logic was established (2:08:03 PM) for `targetBasePath`: using `GLOBAL_DOC_PATH/ref_type` if `ref_type` is provided (and not empty), otherwise falling back to `UPLOAD_DOC_PATH`. `ref_type` was again made optional in `SaveDocParams`. Error handling for missing `file.path` was added, and console logs were enhanced with emojis.
    *   The most significant functional change in this period occurred at **11/5/2025, 2:09:40 PM**. `ref_type` was standardized by defaulting it to `"upload_doc"` if it was not provided or empty. This `finalRefType` was then consistently used to determine the `targetBasePath` (either `uploadDocPath` for `"upload_doc"` or `globalDocPath/finalRefType` for others) and for insertion into the `document_upload` table, ensuring `ref_type` is never `null` in the database.
*   **Subsequent Changes (11/5/2025, 2:11:31 PM - 2:45:57 PM):** The core logic from 2:09:40 PM remained largely stable. Minor changes included adding/removing console log messages and emoji decorations, indicating ongoing debugging and minor cleanup without altering functionality. The last change at 2:45:57 PM removed verbose comments and emojis from logs.

**File: `src\services\vendorServices.ts`**

This file received a major update at **11/5/2025, 2:14:22 PM**, integrating the `globalUpload.ts` utility for document management.

*   **`getAll` function:** This function was enhanced to retrieve `document_upload` records associated with vendors. It fetches all vendors, then queries the `document_upload` table for documents where `ref_id` matches a vendor's `serial_id` and `ref_type` is specifically `'vendor_doc'`. These documents are grouped by vendor and attached to the respective vendor objects in the response.
*   **`addVendor` function:** When adding a new vendor, this function now processes `uploadDocuments` (parsed from the request body) and uploaded `files`. It iterates through these, calling the `saveDoc` function (from `globalUpload.ts`) for each file. It explicitly passes `ref_type: "vendor_doc"` and the newly created `vendorSerialId`, along with other document details.
*   **`updateVendor` function:** This function was extended to handle updates to vendor documents. It distinguishes between existing, new, and deleted documents. For deleted documents, it contains logic to remove entries from the `document_upload` table based on `serial_id` and ensuring `ref_type` is `'vendor_doc'`. The change log for this function is truncated, but it clearly indicates robust document management capabilities.

**Patterns and Recurring Elements:**

*   **Document Management Focus:** The dominant theme across these changes is the robust implementation and refinement of a generic document upload and management system.
*   **`ref_type` for Categorization:** The `ref_type` parameter is consistently used to categorize documents (e.g., `'vendor_doc'` in `vendorServices.ts`, and the dynamic subfolder creation/defaulting to `"upload_doc"` in `globalUpload.ts`), indicating a structured approach to document storage.
*   **Separation of Concerns:** The `globalUpload.ts` utility is designed to handle the low-level file system and database insertion for documents, while `vendorServices.ts` consumes this utility to manage vendor-specific documents, demonstrating good modularity.
*   **Timestamped Filenames vs. Original Names in DB:** A consistent pattern is to rename physical files with a timestamp (`${baseName}_${timestamp}${ext}`) for uniqueness but store the original filename (`file.originalname`) in the `document_name` and `document_path` fields in the database.
*   **Environment Variable Dependence:** Both `globalUpload.ts` and `vendorServices.ts` rely on environment variables (`UPLOAD_DOC_PATH`, `GLOBAL_DOC_PATH`) for configuring upload locations.
*   **Database Schema:** The use of `document_upload` table with columns like `ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, `uploaded_by`, `uploaded_at`, `updated_at` is consistent.
*   **Iterative Refinement:** The `globalUpload.ts` file shows an iterative process of adding, removing, and re-adding logic (e.g., `dotenv` import, `ref_type` optionality, logging verbosity), suggesting an active development cycle to achieve the desired functionality and robustness.

## 4:25:07 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts` was updated on `11/5/2025, 12:54:56 PM`. This update primarily focuses on defining an authentication route.

Specifically, the `AuthRoutes.ts` file sets up an Express router. It defines a GET endpoint for `Paths.Auth.GetUserInfo` which is responsible for retrieving and returning user information. When this endpoint is hit, it logs "User Info Requested:" along with the user object from the request (`req.user`) to the console and then sends a 200 OK status with the user object in the JSON response. The file imports necessary modules like `express`, custom types (`IAuthReq`, `IRes`), and constants for paths and HTTP status codes, and exports the configured `AuthRoutes` router. Notably, while `login` from `UserService` is imported, it is not utilized in the provided snippet of code.

## 4:25:18 PM
The `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx` file undergoes several significant changes and a recurring pattern of modifications:

**File-Specific Updates & Timestamps:**

*   **11/5/2025, 1:57:52 PM:** The file initially contains a React functional component named `ConfirmLineBookingForm`. This component is responsible for a client-side document upload interface, utilizing `formik` for form management, React state for managing uploaded files and drag-and-drop interactions, and `useUploadDocumentMutation` for API calls. At this point, a `formData.append("ref_type", "upload_doc");` line within the `onSubmit` logic is commented out.
*   **11/5/2025, 2:03:46 PM:** A minor update occurs in the `ConfirmLineBookingForm` component. The previously commented-out line `formData.append("ref_type", "upload_doc");` is uncommented, meaning the `ref_type` field is now actively sent with the document upload form data.
*   **11/5/2025, 2:06:55 PM:** The content of the file completely changes. It transforms from a React component to a server-side utility function named `saveDoc`. This `saveDoc` function is designed for handling file system operations (creating directories, renaming files with timestamps using `moment`, and moving uploaded files) and inserting document metadata into a database (`document_upload` table). It uses `Express.Multer.File[]` for its `files` parameter, indicating a backend context despite being in a frontend `.tsx` file path.
*   **11/5/2025, 2:07:18 PM:** A minor refinement is made within the `saveDoc` function. The type definition for the `files` parameter in the `SaveDocParams` interface is changed from `Express.Multer.File[]` to `File[]`. The underlying server-side logic remains the same.
*   **11/5/2025, 2:07:54 PM:** The file content reverts back to the `ConfirmLineBookingForm` React component, specifically to the state where `formData.append("ref_type", "upload_doc");` is uncommented (matching the 2:03:46 PM version). This suggests the server-side `saveDoc` function was temporarily present or accidentally overwitten.
*   **11/5/2025, 2:08:32 PM:** Another small change in the `ConfirmLineBookingForm` component. The line `formData.append("ref_type", "upload_doc");` is once again commented out.
*   **11/5/2025, 2:42:29 PM:** The final recorded change reverts the `ConfirmLineBookingForm` component to the state where `formData.append("ref_type", "upload_doc");` is uncommented, matching the 2:03:46 PM and 2:07:54 PM versions.

**Patterns and Recurring Elements:**

The most prominent pattern is the frequent toggling of the comment status for the line `formData.append("ref_type", "upload_doc");` within the `ConfirmLineBookingForm` component. This field is commented, uncommented, commented again, and finally uncommented. This indicates an iterative process of testing or deciding whether to include this specific piece of data in the frontend-to-backend upload request.

Additionally, there's a notable, albeit temporary, change where a server-side file handling utility (`saveDoc`) completely replaced the frontend React component. This was quickly reverted, suggesting it was either a misplaced file, an error in the version control log, or a very brief experimental phase during development. The primary function of the file, as consistently seen in most entries, is to provide a user interface for document uploads.

## 4:25:29 PM
The code changes primarily focus on refining user interface components, enhancing dashboard functionality, and improving authentication/authorization mechanisms within the `t360-frontend-v2` application. All recorded changes occurred on 11/5/2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar-layout.tsx` (Timestamp: 11/5/2025, 2:54:04 PM)**
    *   This file defines the `AppSidebarLayout` component, a wrapper for the application's main content, integrating a navigation bar and a sidebar using custom `@components/kit` UI components and Heroicons. This appears to be an initial or standalone update for this layout structure.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (Timestamps: 11/5/2025, 2:58:06 PM; 2:58:53 PM; 3:03:35 PM; 3:03:46 PM)**
    *   This file outlines a complex `DashboardPage` component that integrates various UI elements (cards, data grids, calendar, date selectors, filter sidebar) and fetches shipment and delivery data.
    *   **2:58:06 PM:** Introduces extensive Redux state management for filters, pagination, sorting, and card-based filtering. It uses `useFetchShipmentDataQuery`, `useFetchCartDataQuery`, and `useFetchDeliveryDataQuery` for data retrieval. A `useMemo` hook is used to process calendar data, categorizing deliveries into "Rail", "Door", or "Port". It includes functions for handling pagination, filters, card clicks, and a `scrollTo` utility.
    *   **2:58:53 PM:** A minor cleanup was performed, removing an incorrect `import { console } from "inspector";`.
    *   **3:03:35 PM & 3:03:46 PM:** No discernible functional changes from the 2:58:53 PM version. The provided code for this file is consistently truncated at the same point, `const statusColor = firstStatus`, across all entries.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx` (Timestamps: 11/5/2025, 3:05:14 PM; 4:23:14 PM; 4:24:19 PM)**
    *   This file defines the `UserCard` component, responsible for displaying user details and providing a logout mechanism.
    *   **3:05:14 PM:** The `handleLogout` function was refined. For Auth0 authentication, `token` and `user` are now explicitly removed from `localStorage` *before* initiating the redirect to the Auth0 logout endpoint. This ensures local data is cleared promptly.
    *   **4:23:14 PM:** Significant structural changes were made. The component now imports `useSelector`, `useAccess`, and `SelectCustomerPanel`. A `SelectCustomerPanel` component is rendered within the dropdown, conditional on the user having `selectCustomer` permission, indicating a feature to allow users (likely ADMINs) to switch customer contexts directly from the user card area.
    *   **4:24:19 PM:** No discernible functional changes from the 4:23:14 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx` (Timestamps: 11/5/2025, 3:53:07 PM; 3:53:47 PM; 3:53:57 PM)**
    *   This component manages filters and views for an analytics dashboard, including a PDF export feature.
    *   **3:53:07 PM:** The `downloadDashboardPDF` function, which uses `jspdf` and `html2canvas-pro`, was enhanced for more robust logo handling. It now converts the logo image to a base64 string using `getBase64Image` within the `logoImg.onload` callback, and includes an `onerror` handler for the logo image. Earlier commented-out code suggests previous attempts at handling CSS styles for PDF generation.
    *   **3:53:47 PM & 3:53:57 PM:** No discernible functional changes from the 3:53:07 PM version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx` (Timestamps: 11/5/2025, 4:20:15 PM; 4:21:01 PM; 4:21:20 PM)**
    *   This file defines the main application layout, handling global concerns like authentication status and role-based content.
    *   **4:20:15 PM:** Introduced logic to check token expiration from `localStorage` using a `useEffect` hook. If the token is expired, `user` and `token` are cleared, and the user is redirected to the root path. It also implements role-based rendering, specifically showing an "Admin Dashboard" message for "ADMIN" users, prompting them to select a customer.
    *   **4:21:01 PM:** No discernible functional changes.
    *   **4:21:20 PM:** A clarifying comment, `// prevent access to the app if user is not logged in`, was added above the `isTokenExpired` function.

**Patterns and Recurring Elements:**

*   **Authentication and Authorization:** There is a strong recurring theme of user authentication and authorization. Both `usercard.tsx` (logout flow, customer selection based on permissions) and `layout.tsx` (token expiration, ADMIN role restriction) actively manage user access and state.
*   **Redux for State Management:** Multiple components (`dashboard-page.tsx`, `AnalyticsToolbar.tsx`, `usercard.tsx`) heavily rely on `react-redux` (`useDispatch`, `useSelector`) for managing application state and interacting with API services (RTK Query).
*   **Custom UI Components:** The project consistently uses custom UI components from `@components/kit` and `@components/common` directories, indicating a standardized component library.
*   **Date and Time Handling:** The dashboard components use `moment.js` extensively for date manipulation and display, especially for calendar and filter functionalities.
*   **Console Logging:** `console.log` statements are frequently used throughout the code, suggesting an active development and debugging phase.
*   **Iterative Development:** The presence of commented-out code in `AnalyticsToolbar.tsx` and the multiple minor timestamp updates for the same file suggest an iterative development approach, particularly for complex features like PDF export.

## 4:48:44 PM
The recent code changes primarily focus on refining the document upload mechanism within the Envosys backend, particularly around how files are stored on the file system and referenced in the database, along with its integration into vendor management.

**File: `src\common\util\globalUpload.ts`**
This file, containing the `saveDoc` function, underwent significant iterations to standardize document storage:
*   **Initial Implementation (11/5/2025, 1:50:30 PM):** The `saveDoc` function was introduced, allowing documents to be saved to a `globalBasePath` (derived from environment variables or a default local path). It would then create subfolders based on a required `ref_type` and store files with a timestamped name. The original filename was recorded in the database.
*   **Path Logic Revisions (11/5/2025, 1:54:52 PM - 2:08:03 PM):**
    *   A brief change (1:54:52 PM) removed the `ref_type` subfolder creation, opting to save all files directly in a main upload path.
    *   This was quickly reverted and refined (1:59:53 PM, 2:08:03 PM). The `ref_type` parameter was made optional, and a more robust logic was established: if `ref_type` is provided and non-empty, files are stored in a subfolder under `GLOBAL_DOC_PATH`; otherwise, they go to a static `UPLOAD_DOC_PATH`. Error handling for missing file paths and enhanced console logs were added.
*   **`ref_type` Standardization (11/5/2025, 2:09:40 PM onwards):** The `ref_type` handling was further refined. If `ref_type` is not provided or empty, it now defaults to the string `"upload_doc"`. This value then dictates the storage location: `"upload_doc"` directs files to `UPLOAD_DOC_PATH` (static folder), while any other `ref_type` creates a dedicated subfolder under `GLOBAL_DOC_PATH`. This ensures `ref_type` is always a meaningful string for database insertion, preventing null values.
*   **Documentation and Consistency (11/5/2025, 2:42:23 PM - 2:45:57 PM):** Comments were extensively added to explain the logic flow, clarifying that physical files are timestamped for uniqueness, but only the original filename is stored in the `document_upload` database table. The core logic for path determination, folder creation, file renaming, and database insertion remained consistent in these final revisions.

**File: `src\services\vendorServices.ts`**
*   **Integration of `globalUpload` (11/5/2025, 2:14:22 PM):** This file demonstrates the practical application of the `globalUpload.saveDoc` function.
    *   **`getAll` function:** It now fetches associated `document_upload` records for vendors using `ref_type = 'vendor_doc'` and attaches them to vendor data, providing a comprehensive view of vendor information including their uploaded documents. It also filters and formats vendor status and email options.
    *   **`addVendor` function:** When adding a new vendor, it processes `uploadDocuments` (parsed from the request body) and actual files (`req.files`). For each new document, it calls `saveDoc` with `ref_type: "vendor_doc"` and the newly created vendor's `serial_id`.
    *   **`updateVendor` function:** It includes logic to handle updates to vendor documents, distinguishing between new, existing, and deleted documents. It iterates through marked `deletedDocs` to remove corresponding entries from the `document_upload` table. The log entry for this function is truncated, but it clearly indicates an intention to manage the lifecycle of vendor-specific documents.
    *   **Audit Logging:** The `updateVendor` function also includes detailed audit logging for changes to vendor fields, recording old and new values in the `spr_vendor_master_audit` table.

**Patterns and Recurring Elements:**
*   **Modular Document Handling:** The `saveDoc` function serves as a centralized, reusable module for file uploads, integrated across different services like `vendorServices`.
*   **Environment Variable Dependency:** The file upload paths (`UPLOAD_DOC_PATH`, `GLOBAL_DOC_PATH`) are consistently read from environment variables, allowing flexible configuration for different deployment environments.
*   **Timestamped Physical Files vs. Original Name in DB:** A consistent pattern is observed where physical files are renamed with a `YYYYMMDD_HHmmss` timestamp for uniqueness, but the original filename is consistently stored in the `document_upload` table for user-friendliness and potentially easier retrieval/display.
*   **Database Schema:** The `document_upload` table consistently stores `ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, `uploaded_by`, and timestamps (`uploaded_at`, `updated_at`).
*   **Robust Folder Management:** The code repeatedly checks for and creates necessary directories (`fs.existsSync`, `fs.mkdirSync`) before saving files, ensuring a stable file system structure.
*   **Error Handling:** `try...catch` blocks are consistently used in `saveDoc` and service functions to catch and log errors during file operations and database interactions.

**Environment Configuration Changes:**
The `.env.development` file saw changes related to the document upload paths and database configuration. Specifically, `GLOBAL_DOC_PATH` and `UPLOAD_DOC_PATH` values were adjusted multiple times, reflecting shifts between local Windows paths and `/root/node` paths, suggesting different development or deployment targets. Later, database connection parameters (DB_USER, DB_PASSWORD, DB_NAME, PORT) were also updated, indicating a potential switch to a different database instance or a dedicated production-like setup within the development environment.

## 5:47:08 PM
**File: `src/routes/AuthRoutes.ts`**
*   **Timestamp:** 11/5/2025, 12:54:56 PM
*   **Update:** This file defines authentication-related routes using Express. It includes an import for a `login` service from `UserService` (though not used in the provided snippet). A GET endpoint for `Paths.Auth.GetUserInfo` is defined. This endpoint logs "User Info Requested:" along with the user object from the request (`req.user`) and then responds with an HTTP status `OK` (200) returning the `req.user` object as JSON. The route leverages predefined constants for paths and HTTP status codes.

## 5:47:21 PM
The provided log details changes exclusively within the file `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`.

The most significant pattern observed is a highly unusual, transient change in the file's entire purpose and content, alternating between a React frontend component and a Node.js backend utility, followed by repeated toggling of a specific line in the frontend component.

**File-Specific Updates for `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`:**

1.  **Initial Frontend Component (11/5/2025, 1:57:52 PM):** The file began as a React functional component named `ConfirmLineBookingForm`. This component provides a user interface for uploading documents, featuring:
    *   Drag-and-drop functionality for files, with visual feedback (`isDragOver`).
    *   A file input button to select files.
    *   Display of uploaded files with an option to remove them.
    *   Form handling using `formik` with an initial `deliveryOrderNo` field.
    *   Integration with `useUploadDocumentMutation` from `store/api/uploadDocumentApi` for backend interaction.
    *   Client-side validation to ensure at least one file is uploaded.
    *   Error and success notifications using `react-hot-toast`.
    *   The `onSubmit` logic constructs a `FormData` object, appending `document_type`, `remark`, `file`, `ref_id`, and `uploaded_by`. Notably, the `ref_type` field (`formData.append("ref_type", "upload_doc");`) was initially commented out.

2.  **Frontend: `ref_type` Uncommented (11/5/2025, 2:03:46 PM):** The commented line `formData.append("ref_type", "upload_doc");` within the `onSubmit` function was uncommented, activating this field in the upload request.

3.  **Abrupt Shift to Backend Utility (11/5/2025, 2:06:55 PM):** The entire content of the file drastically changed. Instead of the React component, it now defined an asynchronous `saveDoc` function. This function is characteristic of a Node.js backend utility, employing:
    *   Node.js core modules like `path` and `fs` for file system operations.
    *   `moment` for timestamp formatting.
    *   Environment variables (`process.env.UPLOAD_DOC_PATH`, `process.env.GLOBAL_DOC_PATH`) to determine file storage paths.
    *   Logic to create target directories if they don't exist.
    *   Renaming uploaded files with a timestamp prefix (`${baseName}_${timestamp}${ext}`) and moving them to the target directory.
    *   Database interaction via a `query` function (not defined in the snippet but implied), inserting document metadata (`ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, `uploaded_by`, `uploaded_at`, `updated_at`) into a `document_upload` table.
    *   The `SaveDocParams` interface defined `files` as `Express.Multer.File[]`.

4.  **Backend: `SaveDocParams` Type Adjustment (11/5/2025, 2:07:18 PM):** A minor but specific change occurred in the `saveDoc` utility. The type definition for the `files` parameter in the `SaveDocParams` interface was updated from `Express.Multer.File[]` to `File[]`.

5.  **Revert to Frontend Component (11/5/2025, 2:07:54 PM):** The file's content reverted entirely back to the `ConfirmLineBookingForm` React component, specifically to the state where the `ref_type` field was uncommented (as seen at 2:03:46 PM). This suggests either an accidental overwrite of the backend logic or a deliberate restoration of the frontend component.

6.  **Frontend: `ref_type` Commented Again (11/5/2025, 2:08:32 PM):** The `formData.append("ref_type", "upload_doc");` line in the `onSubmit` function of the React component was commented out again.

7.  **Frontend: `ref_type` Uncommented Again (11/5/2025, 2:42:29 PM):** Finally, the `formData.append("ref_type", "upload_doc");` line was uncommented once more, restoring its active status in the upload request.

**Patterns and Recurring Elements:**

*   **File Path Consistency:** All modifications were logged under the identical file path: `c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx`.
*   **`ref_type` Toggling:** The `formData.append("ref_type", "upload_doc");` line within the frontend `ConfirmLineBookingForm` was repeatedly commented and uncommented (commented -> uncommented -> commented -> uncommented).
*   **Frontend Component Stability:** When the file contained the `ConfirmLineBookingForm` component, its core structure, UI elements (drag-and-drop, file list), form logic (Formik), and API integration remained largely consistent, apart from the `ref_type` toggling.
*   **Backend Code Briefness:** The `saveDoc` backend utility appeared only briefly within the log, suggesting it was either a temporary addition, an erroneous log entry, or part of a refactoring that was quickly reverted or moved. Given the "frontend" in the file path, the presence of backend file system and database logic is highly unusual and stands out as a critical observation.

## 5:47:35 PM
The provided log details code changes primarily within the `t360-frontend-v2` project, focusing on UI layout, dashboard functionality, user authentication, and analytics features, all occurring on **November 5, 2025**.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar-layout.tsx`**
    *   **2:54:04 PM**: Initial setup of the `AppSidebarLayout` component, integrating core UI components like `Navbar` and `SideBar`. It imports various UI elements from `@components/kit` and icons from `@heroicons/react`.
    *   **4:33:08 PM & 4:33:15 PM**: Minor, seemingly temporary, text `kk` was added inside the `NavbarSpacer` component.

2.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`**
    *   **2:58:06 PM**: This file represents a comprehensive `DashboardPage` component. It incorporates extensive state management using React hooks (`useState`, `useMemo`, `useEffect`) and Redux (`useDispatch`, `useSelector`) for filtering, pagination, and sorting of shipment data. It integrates with Redux Toolkit Query APIs (`useFetchShipmentDataQuery`, `useFetchCartDataQuery`, `useFetchDeliveryDataQuery`). The component handles date range selections, displays calendar-based delivery/vessel data, and provides various filter and pagination controls. It includes utility functions for determining delivery modes and mapping icons. There are several `console.log` statements for debugging user data and shipment data.
    *   **2:58:53 PM, 3:03:35 PM, 3:03:46 PM**: These timestamps indicate saves without any significant code changes visible in the provided log snippet for this file, maintaining the same large dashboard implementation.

3.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx`**
    *   **3:05:14 PM**: Defines the `UserCard` component for displaying user information and managing logout. It fetches user preferences, retrieves user data from `localStorage`, and handles logout logic which clears local storage and dispatches a Redux action, supporting both standard and Auth0 authentication flows. The logout logic was previously commented out and then enabled/refined.
    *   **4:23:14 PM**: Introduced `useAccess` hook and integrated `SelectCustomerPanel`. The `SelectCustomerPanel` was conditionally rendered inside the `Dropdown` component based on `permission?.selectCustomer`, and `toolState` was added from Redux for `selectedCustomer`.
    *   **4:24:19 PM**: The `SelectCustomerPanel`'s placement within the `Dropdown` was slightly adjusted in the JSX structure, but its functionality remained the same.
    *   **4:30:28 PM & 4:30:34 PM**: The `useAccess` hook and `permission` variable were temporarily commented out, implying that `SelectCustomerPanel` would have been rendered unconditionally.
    *   **4:31:21 PM**: The `useAccess` hook and `permission` variable were uncommented, restoring the conditional rendering of `SelectCustomerPanel`.
    *   **4:32:38 PM**: The `SelectCustomerPanel` component was entirely removed from `UserCard`.

4.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **3:53:07 PM**: This file defines `AnalyticsToolbar`, a complex component for managing analytics dashboards. It uses Redux for global filter and dashboard selection. A key feature is the `downloadDashboardPDF` function, which uses `html2canvas` and `jsPDF` to export the dashboard as a PDF, including a logo. It supports custom date ranges and provides UI for managing custom views. `SelectCustomerPanel` is also conditionally rendered here based on user permissions.
    *   **3:53:47 PM & 3:53:57 PM**: These timestamps show saves without any visible code changes to the snippet provided.

5.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`**
    *   **4:20:15 PM**: Implemented a core `Layout` component that checks user token validity against an expiration timestamp stored in `localStorage`. If the token is expired, it clears user data from `localStorage` and redirects the user. It also restricts "ADMIN" users, displaying a message to select a customer, while other roles (`CUSTOMER`, `AGENT`) can proceed to the main `Outlet`.
    *   **4:21:01 PM**: No functional changes.
    *   **4:21:20 PM**: A clarifying comment was added to the `isTokenExpired` function.
    *   **4:41:20 PM**: An `useEffect` hook was added to check for `CUSTOMER` role and access `localUser?.companyname`, suggesting an intention to use this information, but `dispatch` was missing and no action was performed.
    *   **4:42:14 PM**: `useDispatch` and `setCustomer` (from `analytics-slice`) were imported. The `useEffect` was updated to correctly dispatch `setCustomer` with `localUser.companyname` if the user is a `CUSTOMER`, integrating the customer context into the Redux analytics state.

6.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`**
    *   **4:34:00 PM**: Initial implementation of the `SideBar` component, displaying a logo, mapping `sidebarMenu` items, and including the `UserCard` in its footer. It uses `useLocation` to highlight the current active link. A temporary `kk` was added to `SidebarLabel`s.
    *   **4:35:17 PM**: The `SelectCustomerPanel` was introduced and rendered within the first `SidebarSection`, and the `kk` text was removed from `SidebarLabel`s. The `useAccess` hook and Redux `toolState` were also imported.
    *   **4:35:58 PM**: `SelectCustomerPanel` was moved to be a direct child of `SidebarBody`, positioning it higher in the sidebar.
    *   **4:37:01 PM**: `SelectCustomerPanel` was made conditionally rendered based on `permission?.selectCustomer`, aligning with the permission-based rendering pattern seen elsewhere.

### Patterns and Recurring Elements:

*   **Consistent Timestamp**: All recorded changes occurred on the same date, November 5, 2025, suggesting a concentrated development effort.
*   **Redux for State Management**: The application heavily relies on Redux for global state management, with `useDispatch` and `useSelector` being frequently used across multiple components to interact with `shipment-dashboard-slice` and `analytics-slice`.
*   **`localStorage` for Authentication**: User authentication details (token, user object, auth type) are consistently stored and retrieved from `localStorage`, with robust logout procedures.
*   **Custom UI Component Library**: A consistent pattern of importing and utilizing custom UI components from `@components/kit` and `@components/common` is evident, pointing to a well-defined design system.
*   **Icon Diversity**: Multiple icon libraries (`@heroicons/react`, `react-icons`) are employed throughout the frontend for various UI elements.
*   **Permission-Based Rendering (`useAccess`)**: The `useAccess` hook is a recurring pattern for conditionally rendering components or features (`SelectCustomerPanel` in `AnalyticsToolbar` and `Sidebar`) based on user permissions.
*   **Dashboard and Analytics Focus**: Significant effort is dedicated to dashboard functionalities, including data fetching, filtering, pagination, and PDF export for analytics views, indicating these are central features of the application.
*   **Refactoring and UI Placement Iteration**: The `SelectCustomerPanel` component was repeatedly moved and its rendering logic adjusted (`usercard.tsx`, `sidebar.tsx`, `AnalyticsToolbar.tsx`), indicating ongoing design and architectural decisions regarding its optimal placement and visibility based on user roles and permissions.
*   **Debugging Artifacts**: Temporary additions like `kk` in UI elements and numerous `console.log` statements suggest active development and debugging.

## 5:48:41 PM
The log details modifications across two primary files: `src\common\util\globalUpload.ts` and `src\services\vendorServices.ts`.

**File: `src\common\util\globalUpload.ts`**

This file, responsible for handling document uploads, underwent several iterative refinements throughout the recorded changes.

*   **Initial Implementation (11/5/2025, 1:50:30 PM):** The `saveDoc` function was introduced, designed to store uploaded files. It determined a base path using `GLOBAL_DOC_PATH` or `UPLOAD_DOC_PATH`, created subfolders based on `ref_type` (e.g., `globalBasePath/ref_type`), and saved files with a timestamped name. The original filename was stored in the `document_upload` database table under `document_path`. The `ref_type` parameter was initially mandatory.

*   **Temporary Static Path & `dotenv` (11/5/2025, 1:54:52 PM):** A brief modification prioritized `UPLOAD_DOC_PATH` as a static base path, removing the dynamic `ref_type` subfolder creation. `dotenv.config()` was explicitly added to this file.

*   **Major Path Logic Refactor and `ref_type` Optionality (11/5/2025, 1:59:53 PM):** This update significantly changed the `saveDoc` function.
    *   The `ref_type` parameter in `SaveDocParams` was made optional (`ref_type?: string`).
    *   A more sophisticated logic for determining the `finalBasePath` was implemented: if `ref_type` was provided and not empty, files would go into `globalBasePath/ref_type`; otherwise, they would use a default `uploadBasePath`.
    *   The `ref_type` value inserted into the database was now `ref_type || null`, allowing for null values when `ref_type` was not provided.

*   **Refining `ref_type` Defaulting and Path Selection (11/5/2025, 2:09:40 PM):** This was another significant update to the path handling logic.
    *   `ref_type` was still optional, but if not provided or empty, it would now explicitly default to `"upload_doc"`, ensuring a non-null `ref_type` value is always stored in the database.
    *   The `targetBasePath` logic was clarified: if `finalRefType` was `"upload_doc"`, it used `uploadDocPath` (a static folder); otherwise, it created a subfolder `globalDocPath/finalRefType`.
    *   Console logs were enhanced with emojis (e.g., " Created folder:", " File saved at:").

*   **Subsequent Minor Refinements (11/5/2025, 2:11:31 PM - 2:45:57 PM):** Following the major refactor, numerous minor changes occurred, primarily focused on improving readability, adding comments, and refining console output (e.g., adding more descriptive messages and emojis like " Final ref_type:", " File path missing:", " Error saving document:"). The core logic for `ref_type` handling and path determination remained consistent after the 2:09:40 PM update. A check for `!file.path` was consistently present to handle missing file paths.

**File: `src\services\vendorServices.ts`**

This file demonstrates the integration of the `globalUpload.saveDoc` utility for managing vendor-related documents.

*   **Integration of `globalUpload` (11/5/2025, 2:14:22 PM):** The `saveDoc` function from `../common/util/globalUpload` was imported and used across vendor services.
    *   **`getAll` function:** Modified to fetch associated `document_upload` records for vendors using `ref_id = ANY($1) AND ref_type = 'vendor_doc'`. These documents are then grouped by `ref_id` and appended to each vendor object in the response under `uploadDocuments`. Filtering options for email and status were also enhanced, including filtering out empty emails and capitalizing status values.
    *   **`addVendor` function:** Updated to call `saveDoc` after a new vendor is created. It passes `ref_type: "vendor_doc"` and the newly generated `vendorSerialId` as `ref_id`, along with other document metadata parsed from `req.body`.
    *   **`updateVendor` function:** Expanded to manage `uploadDocuments` during vendor updates. It includes logic to process `deletedDocs` by issuing `DELETE` queries to the `document_upload` table based on `serial_id` and `ref_type = 'vendor_doc'`. The log entry for this function is truncated, but the intent to handle document lifecycle (add, delete) during updates is clear.

**Patterns and Recurring Elements:**

*   **Consistent Upload Mechanism:** The `saveDoc` function in `globalUpload.ts` consistently generates a timestamped filename for the physical file on disk (e.g., `basename_YYYYMMDD_HHmmss.ext`) while storing the *original* filename in the database (`document_upload.document_name` and `document_upload.document_path`).
*   **Environment Variable Dependence:** Both `GLOBAL_DOC_PATH` and `UPLOAD_DOC_PATH` environment variables are frequently referenced to configure upload directories, with fallback paths provided.
*   **Dynamic Folder Creation:** The code consistently checks if a target folder exists and creates it recursively if not, ensuring the upload path is always ready.
*   **Database Interaction:** All changes related to file uploads involve inserting metadata into a `document_upload` table with fields like `ref_type`, `ref_id`, `document_name`, `document_path`, `document_type`, `remark`, and `uploaded_by`.
*   **Console Logging for Debugging/Tracing:** Numerous `console.log`, `console.warn`, and `console.error` statements are added or refined throughout the `globalUpload.ts` file, often including emojis to quickly convey the status of operations (e.g., folder creation, file saving, errors, warnings).
*   **`ref_type` as a Categorization Tool:** The `ref_type` parameter is a central concept, used to logically categorize uploaded documents (e.g., `"vendor_doc"`) and to influence their physical storage location (either a general static folder or a subfolder under a global path).

## 8:38:00 PM
The project `t360-backend-v2` has seen updates across two core files.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   A new `GET` endpoint, `Paths.Auth.GetUserInfo`, was introduced. This endpoint is designed to retrieve the authenticated user's information. It logs the user object from the request and then responds with the user data in a JSON format with an HTTP status of 200 (OK).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** 11/5/2025, 6:04:50 PM; 11/5/2025, 6:05:15 PM; 11/5/2025, 6:05:28 PM; 11/5/2025, 6:06:01 PM
    *   This file defines two asynchronous functions for dashboard functionality:
        *   `getDashboardCardInfo`: This function retrieves key dashboard metrics related to shipment tracking. It calculates counts and TEU (Twenty-foot Equivalent Unit) for "Pending Departure", "In Transit", "ETA Within 1 Week", and "Out for Delivery" statuses. The data is fetched from `mtr_tracking_data` and can be filtered by `fromDate`, `toDate`, and `CompanyName`. It also applies user-specific conditions.
        *   `getDeliveryData`: This function fetches detailed delivery or vessel arrival data. It supports two main types: "delivery" (providing customer location, POD, MBL number, and ETA/delivery dates for incomplete shipments) and "vessel" (providing vessel arrival details, further filtered by modes like "ALL", "Rail Delivery", "Door Delivery", or "Port Delivery"). User-specific conditions are applied to filter the results.
    *   Both functions include comprehensive logging for request details and SQL queries, and implement error handling that returns an HTTP status 500 (INTERNAL_SERVER_ERROR) on failure.

**Timestamps of Significant Changes:**

*   The `AuthRoutes.ts` file had a distinct update around midday on 11/5/2025.
*   The `dashboardService.ts` file shows multiple log entries over a very short period (approximately 2 minutes) in the early evening of 11/5/2025. The content across these timestamps is identical, suggesting these logs might represent successive saves or automated rebuilds rather than distinct functional code changes within that specific timeframe.

**Patterns and Recurring Elements:**

*   Both updated files are written in TypeScript, using Express.js (`Router`) for routing and `async/await` for asynchronous operations.
*   They consistently use custom `IAuthReq` and `IRes` interfaces for request and response handling, and `HttpStatusCodes` for standardizing HTTP responses.
*   The application heavily relies on database queries (indicated by `@src/common/util/database` import and extensive SQL strings), particularly complex `SELECT` statements with `FILTER (WHERE ...)` clauses for conditional aggregation and `REGEXP_REPLACE` for data cleaning.
*   Error handling is standard, catching exceptions and returning a 500 status with an error message.
*   Logging (`logger.info`, `logger.error`, `console.log`) is a prominent feature, used for tracing execution flow, user actions, and SQL queries.
*   There's a recurring pattern of applying user-specific filters to data queries using `buildMtrUserCondition(req.user!)`, indicating a focus on data security and personalized data views.

## 8:38:46 PM
The provided code log details changes across several frontend components and a Redux slice, primarily focusing on user authentication, dashboard functionality, and UI layout.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar-layout.tsx`**
    *   **11/5/2025, 2:54:04 PM:** Initial setup of `AppSidebarLayout` which wraps children with a `SidebarLayout` component, including a `Navbar` and a `SideBar`.
    *   **11/5/2025, 4:33:08 PM & 4:33:15 PM:** A minor, likely temporary, "kk" string was added inside the `NavbarSpacer` component.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`**
    *   **11/5/2025, 2:58:06 PM - 3:03:46 PM (Multiple entries):** These entries show a comprehensive dashboard page component importing numerous UI elements, React hooks, Redux actions/selectors, and API query hooks. It manages local state for calendar, notifications, and filters, and fetches shipment, delivery, and card data. It also includes detailed logic for preparing calendar data, handling pagination, filters, and card clicks. No discernible changes between these specific timestamps.
    *   **11/5/2025, 6:07:06 PM - 6:09:52 PM (Multiple entries):** The `useFetchCartDataQuery` call was updated to conditionally include a `CompanyName` parameter, derived from `localUser?.companyname`, for filtering cart data. No discernible changes between these specific timestamps.
    *   **11/5/2025, 6:13:35 PM:** A new `useEffect` hook was added to dispatch the `setCustomer` action with `localUser.companyname` if the `localUser?.role` is "CUSTOMER", ensuring customer-specific data loading. The `setCustomer` action was also imported.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx`**
    *   **11/5/2025, 3:05:14 PM:** Introduced `UserCard` component for displaying user avatar, name, and role, along with a logout dropdown. It handles logout logic, clearing local storage and redirecting based on authentication type (Auth0 or normal).
    *   **11/5/2025, 4:23:14 PM:** Integrated the `useAccess` hook and `SelectCustomerPanel` component, with the panel being conditionally rendered based on user permissions.
    *   **11/5/2025, 4:24:19 PM:** The `SelectCustomerPanel` was moved to be rendered within the `Dropdown` component, potentially affecting its styling or position.
    *   **11/5/2025, 4:30:28 PM & 4:30:34 PM:** The `useAccess` hook import and declaration were commented out, making the `SelectCustomerPanel` always render, rather than conditionally.
    *   **11/5/2025, 4:31:21 PM:** The `useAccess` hook was uncommented, restoring the conditional rendering of `SelectCustomerPanel`.
    *   **11/5/2025, 4:32:38 PM:** The `SelectCustomerPanel` component was entirely removed from the `UserCard`'s render function.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **11/5/2025, 3:53:07 PM - 3:53:57 PM (Multiple entries):** These entries show a component responsible for dashboard analytics tools. It manages date filters, dashboard views, and includes a `downloadDashboardPDF` function that uses `jsPDF` and `html2canvas-pro` to export the current dashboard view to a PDF, embedding a logo. No discernible changes between these specific timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`**
    *   **11/5/2025, 4:20:15 PM - 4:21:01 PM:** Implemented a token expiration check upon component mount, redirecting to the root path if the token is invalid or expired. Introduced a conditional rendering block for "ADMIN" users, displaying an "Admin Dashboard" title and a prompt to select a customer.
    *   **11/5/2025, 4:21:20 PM:** Added a comment explaining the purpose of the `isTokenExpired` function.
    *   **11/5/2025, 4:41:20 PM:** Added a `useEffect` that checks if the `localUser?.role` is "CUSTOMER" and attempts to access `localUser?.companyname`, but without a dispatch or clear state update.
    *   **11/5/2025, 4:42:14 PM:** Refined the `useEffect` for "CUSTOMER" roles, now correctly dispatching the `setCustomer` action from the `analytics-slice` with the `companyname`.
    *   **11/5/2025, 6:10:32 PM:** Significantly refactored. The `PageWrapper` and its ADMIN-specific content were removed. The `useEffect` for dispatching customer information for "CUSTOMER" roles, along with its associated imports, was also removed, simplifying the overall layout for all users to just `Main` and `Outlet`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`**
    *   **11/5/2025, 4:34:00 PM:** Added temporary "kk" text to `SidebarLabel` items.
    *   **11/5/2025, 4:35:17 PM:** Removed the "kk" text. The `SelectCustomerPanel` component was moved into `SidebarSection` rendering.
    *   **11/5/2025, 4:35:58 PM:** Moved `SelectCustomerPanel` to render directly inside `SidebarBody`, before iterating through menu sections.
    *   **11/5/2025, 4:37:01 PM:** Added conditional rendering for `SelectCustomerPanel` based on `permission?.selectCustomer`, ensuring it only appears when allowed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\shipment-dashboard-slice.ts`**
    *   **11/5/2025, 6:12:29 PM:** Added `selectedCustomer` and `selectedDashobard` fields to the initial state. Implemented a `setCustomer` reducer to update these values, but it was not exported initially.
    *   **11/5/2025, 6:13:25 PM:** The `setCustomer` action was added to the exports, making it available for dispatch elsewhere.

**Timestamps of Significant Changes:**

*   **11/5/2025, 2:58:06 PM:** Introduction of the comprehensive `dashboard-page.tsx`.
*   **11/5/2025, 3:05:14 PM:** Creation of `usercard.tsx` with core user information and logout functionality.
*   **11/5/2025, 3:53:07 PM:** Implementation of PDF export in `AnalyticsToolbar.tsx`.
*   **11/5/2025, 4:20:15 PM:** Initial token validation and ADMIN role-specific UI in `layout.tsx`.
*   **11/5/2025, 4:32:38 PM:** Final removal of `SelectCustomerPanel` from `usercard.tsx`.
*   **11/5/2025, 4:37:01 PM:** `SelectCustomerPanel` is now conditionally rendered in `sidebar.tsx`.
*   **11/5/2025, 4:42:14 PM:** Refined Redux dispatch for customer data in `layout.tsx`.
*   **11/5/2025, 6:10:32 PM:** Major simplification of `layout.tsx`, removing ADMIN-specific views and the customer dispatch logic.
*   **11/5/2025, 6:12:29 PM - 6:13:25 PM:** Introduction and export of `setCustomer` action in `shipment-dashboard-slice.ts`.
*   **11/5/2025, 6:13:35 PM:** The `dashboard-page.tsx` now handles dispatching customer information for "CUSTOMER" roles, taking over a responsibility previously in `layout.tsx`.

**Patterns or Recurring Elements:**

*   **Redux for State Management:** All significant components (`dashboard-page`, `usercard`, `AnalyticsToolbar`, `layout`, `sidebar`) extensively use `react-redux` (`useDispatch`, `useSelector`) to interact with a centralized store, managing application state like filters, pagination, user data, and selected dashboards.
*   **API Integration with RTK Query:** Data fetching is consistently handled using RTK Query hooks (e.g., `useFetchShipmentDataQuery`, `useFetchDeliveryDataQuery`), indicating a standardized approach to API interactions.
*   **Local Storage for User Data:** `localStorage` is frequently used to store and retrieve user authentication details (`user`, `token`, `authtype`), particularly for login persistence and role-based access.
*   **Role-Based Logic and Access Control:** There's a recurring pattern of checking `localUser?.role` (e.g., "ADMIN", "CUSTOMER") and using a `useAccess` hook to implement conditional rendering or functionality, especially concerning customer selection and dashboard views. This logic was refactored and moved between `layout.tsx`, `usercard.tsx`, and `sidebar.tsx`.
*   **UI Component Library Usage:** The project consistently imports and utilizes components from a custom UI kit (`@components/kit`) for elements like `Dropdown`, `Avatar`, `SidebarLayout`, `Navbar`, `Button`, `Dialog`, and various `react-icons` for a unified look and feel.
*   **Debugging with `console.log`:** Numerous `console.log` statements are present across the files, indicating active development and debugging.
*   **Date Handling with Moment.js:** `moment` library is used for date parsing, formatting, and manipulation, particularly evident in `dashboard-page.tsx` for calendar logic.
*   **Dynamic Component Placement:** The `SelectCustomerPanel` component was introduced and repeatedly moved/repositioned across different parent components (`usercard.tsx`, `sidebar.tsx`), suggesting an evolving UI structure or a search for its optimal placement.

## 8:43:24 PM
The log details changes across two primary files: `AuthRoutes.ts` and `dashboardService.ts`, all occurring on 11/5/2025.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp: 11/5/2025, 12:54:56 PM**
    *   This file defines an authentication route. It creates a GET endpoint (`/Auth/UserInfo`) that logs the authenticated user's information (`req.user`) and returns it as a JSON response with an HTTP status code of 200 (OK). This is the only entry for this file, indicating its initial or most recent state in the provided log.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   This file underwent several iterative changes throughout the day, primarily impacting how company-specific data is retrieved.
    *   **Initial state (11/5/2025, 6:04:50 PM to 6:05:28 PM):** The `dashboardService.ts` file initially contained two main asynchronous functions:
        *   `getDashboardCardInfo`: This function retrieves key dashboard metrics (e.g., pending departure, in transit, ETA within 1 week, out for delivery, along with their respective TEU counts) for shipments. It applies filters based on `fromDate`, `toDate`, and `CompanyName` received directly from `req.query`, along with user-specific conditions.
        *   `getDeliveryData`: This function fetches either delivery-related data or vessel arrival data based on `type` and `mode` query parameters. It uses complex SQL queries with various conditional filters for "ALL", "Rail Delivery", "Door Delivery", or "Port Delivery" modes, also incorporating user-specific conditions.
        *   Between 6:04:50 PM and 6:05:28 PM, the file content remained identical, suggesting minor saves or rebuilds without functional changes.
    *   **Significant Update (11/5/2025, 8:41:51 PM):** A notable change occurred in the `getDashboardCardInfo` function. The `CompanyName` parameter is no longer directly extracted from `req.query`. Instead, it is now dynamically determined by calling a new utility function, `getUserObject`, imported from `@src/utils/analytics`. This `getUserObject` takes `req.user`, `req.query.companyname`, and `req.query.access` as inputs to derive the `CompanyName`. This change indicates a shift towards more robust or dynamic company context resolution for dashboard data. The `getDeliveryData` function remained unchanged.
    *   **Minor Update (11/5/2025, 8:42:22 PM):** A debugging `console.log("req.CompanyName", CompanyName);` statement was added in `getDashboardCardInfo` to output the dynamically resolved `CompanyName`, immediately after it is determined by `getUserObject`. The `getDeliveryData` function remained unchanged.

**Patterns and recurring elements:**

*   **Consistent Logging and Error Handling:** Both `AuthRoutes.ts` and `dashboardService.ts` employ logging (`console.log` and `logger.info`) for tracing request and execution flow, and implement `try...catch` blocks to handle errors, returning `HttpStatusCodes.INTERNAL_SERVER_ERROR` in case of failures.
*   **Database Interactions:** The `dashboardService.ts` heavily relies on direct SQL queries executed via a `query` utility, demonstrating a pattern of fetching data directly from `mtr_tracking_data` table based on complex conditions.
*   **User-specific Data Filtering:** The `buildMtrUserCondition(req.user!)` utility is consistently used across functions in `dashboardService.ts` to ensure data is filtered according to the authenticated user's context.
*   **Timestamp Chronology:** All changes occurred on the same day (11/5/2025), with timestamps indicating a clear progression of updates, from an initial setup to functional enhancements and minor debugging additions.

## 9:38:25 PM
The code changes primarily focus on refactoring customer selection state management, updating dashboard functionalities, and minor UI adjustments across several React components.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar-layout.tsx`**
    *   **11/5/2025, 2:54:04 PM:** Initializes a basic sidebar layout, importing various UI components like `Avatar`, `Dropdown`, `Navbar`, and `SidebarLayout`.
    *   **11/5/2025, 4:33:08 PM - 11/5/2025, 4:33:15 PM:** Temporarily added "kk" inside the `NavbarSpacer` for debugging or testing purposes.
    *   **11/5/2025, 9:14:23 PM:** The "kk" text was removed, reverting the `NavbarSpacer` to its original empty state.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx`**
    *   **11/5/2025, 2:58:06 PM:** Introduced significant dashboard functionality, including extensive imports for icons, common UI components (DatePeriodSelector, Calendar, Dialog), Redux state management (shipment-dashboard-slice, various actions), and API queries for shipment, delivery, and card data. It also defines helper functions for date manipulation (`getStartOfWeek`), icon mapping (`getIcons`), and event handlers for pagination, filtering, and card clicks. A `console` import from `inspector` was present, indicative of debugging.
    *   **11/5/2025, 2:58:53 PM:** Removed the `console` import from `inspector`, suggesting a cleanup after debugging.
    *   **11/5/2025, 6:07:06 PM:** Modified the `useFetchCartDataQuery` to include `CompanyName` from the `localUser` in its parameters, enabling company-specific data fetching for dashboard cards.
    *   **11/5/2025, 6:13:35 PM:** Introduced a new `useEffect` hook to dispatch `setCustomer` with the `localUser.companyname` if the user has a "CUSTOMER" role, explicitly setting the customer context in the Redux store.
    *   **11/5/2025, 9:01:12 PM:** Updated API queries (`useFetchShipmentDataQuery`, `useFetchCartDataQuery`) to dynamically use either `dashboardSelector.selectedCustomer` or `localUser.companyname` for the `CompanyName` parameter, allowing for filtering based on a globally selected customer.
    *   **11/5/2025, 9:11:03 PM:** Refactored the `selectedCustomer` retrieval from Redux, switching from `state.shipmentDashboardSlice` to `state.global` (later corrected to `state.globalSlice`). The `useEffect` for setting customer for "CUSTOMER" role was commented out, indicating a shift in responsibility for this action.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\usercard.tsx`**
    *   **11/5/2025, 3:05:14 PM:** Refactored the `handleLogout` function to ensure `localStorage` (token, user) is cleared and a Redux `auth/logout` action is dispatched *before* redirecting, especially for Auth0. The logout label was set to "Sign out1".
    *   **11/5/2025, 4:23:14 PM:** Integrated analytics-related features by importing `useAccess` and `SelectCustomerPanel`. The `SelectCustomerPanel` was conditionally rendered based on user permissions.
    *   **11/5/2025, 4:24:19 PM:** Changed `SelectCustomerPanel` to render unconditionally within the user card dropdown.
    *   **11/5/2025, 4:30:28 PM:** Temporarily commented out the `useAccess` hook.
    *   **11/5/2025, 4:31:21 PM:** Reinstated the `useAccess` hook.
    *   **11/5/2025, 4:32:38 PM:** Removed the `SelectCustomerPanel` from being rendered in `UserCard`.
    *   **11/5/2025, 8:45:40 PM:** Changed the dropdown label from "Sign out1" to "Sign out".

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **11/5/2025, 3:53:07 PM - 11/5/2025, 3:53:57 PM:** These entries show a consistent state of the `AnalyticsToolbar` component. It includes functionality for date filtering, custom views, and PDF export of dashboards using `html2canvas-pro` and `jspdf`. It utilizes Redux for state management and `useAccess` for permission checks. No functional changes occurred across these specific timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\layout.tsx`**
    *   **11/5/2025, 4:20:15 PM:** Implemented a `useEffect` to check token expiration and enforce logout if the token is invalid. It also introduced conditional rendering to display an "Admin Dashboard" message for users with an "ADMIN" role.
    *   **11/5/2025, 4:21:20 PM:** Added a comment to explain the token expiration logic.
    *   **11/5/2025, 4:41:20 PM:** Introduced an incomplete `useEffect` possibly intended for customer role-based actions.
    *   **11/5/2025, 4:42:14 PM:** Completed the `useEffect` from the previous step, making it dispatch `setCustomer` to the `analytics-slice` when a user has a "CUSTOMER" role.
    *   **11/5/2025, 6:10:32 PM:** Significantly refactored by removing the conditional rendering for "ADMIN" users and the `useEffect` that set the customer, suggesting a global shift in how admin views and customer context are managed.
    *   **11/5/2025, 9:12:02 PM:** Re-introduced the `useEffect` to set the customer for "CUSTOMER" roles, but now dispatching `setSelectedCustomer` to a new `global-slice` instead of `analytics-slice`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\core\sidebar.tsx`**
    *   **11/5/2025, 4:34:00 PM:** Implemented the `SideBar` component, using a logo, `UserCard` in the footer, and `sidebarMenu` for navigation. It included a temporary "kk" addition to sidebar labels.
    *   **11/5/2025, 4:35:17 PM:** Removed the temporary "kk" from sidebar labels and introduced the `SelectCustomerPanel` component, initially rendered unconditionally within a `SidebarSection`.
    *   **11/5/2025, 4:35:58 PM:** Moved the `SelectCustomerPanel` to be rendered directly within the `SidebarBody`.
    *   **11/5/2025, 4:37:01 PM:** Made the `SelectCustomerPanel` rendering conditional based on `permission?.selectCustomer`.
    *   **11/5/2025, 9:07:53 PM:** Underwent a significant refactoring: removed `useAccess` and `toolState`, introduced `useDispatch` and `setSelectedCustomer` from `global-slice`. `SelectCustomerPanel` is now conditionally rendered only for "ADMIN" roles, receiving its `initialValue` from the `globalSlice` and an `onSelect` callback. The logo div also received an `items-center` class.
    *   **11/5/2025, 9:15:46 PM:** Changed the import path for `SelectCustomerPanel` from an absolute path to a relative `SelectCustomer`, implying a file move or rename.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\shipment-dashboard-slice.ts`**
    *   **11/5/2025, 6:12:29 PM:** Added `selectedCustomer` and `selectedDashobard` to the initial state and a `setCustomer` reducer that updates these values, indicating an initial attempt to manage customer context within this slice.
    *   **11/5/2025, 6:13:25 PM:** Exported the new `setCustomer` action.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\types\shipment.types.ts`**
    *   **11/5/2025, 9:00:51 PM:** Updated the `DashboardState` interface to include `selectedCustomer: string;` and `selectedDashobard: string;`, reflecting the changes in the Redux slice.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **11/5/2025, 9:06:15 PM:** New file creating a `globalSlice` dedicated to managing a `selectedCustomer` state, along with `setSelectedCustomer` and `clearSelectedCustomer` reducers. This signifies a move to centralize global state variables.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\store.ts`**
    *   **11/5/2025, 9:07:08 PM:** Integrated the newly created `globalSlice` into the root Redux store.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\SelectCustomerPanel.tsx`**
    *   **11/5/2025, 9:08:52 PM:** New file defining a reusable `SelectCustomerPanel` component for selecting customers via a search-enabled, paginated popover. It dispatches `setCustomer` to the `analytics-slice`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\SelectCustomer.tsx`**
    *   **11/5/2025, 9:13:54 PM:** This component appears to be a refactored version of `SelectCustomerPanel`, renamed to `SelectCustomer`. The key change is that it now dispatches `setSelectedCustomer` to the new `global-slice` instead of `analytics-slice`, and it also includes an `onSelect` callback prop for parent communication. It adds a "No results found" message.
    *   **11/5/2025, 9:14:14 PM:** No functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **11/5/2025, 9:16:47 PM:** The `SelectCustomer` component was moved from `components/screen/analytics` to the root `src` directory.

**Patterns and Recurring Elements:**

1.  **Redux State Refactoring for `selectedCustomer`:** The most significant pattern is the evolution of how the "selected customer" state is managed. It initially started within the `shipment-dashboard-slice`, then `layout.tsx` tried to manage it for analytics, and finally, a dedicated `global-slice` was created for it, with all relevant components (`dashboard-page.tsx`, `sidebar.tsx`, `layout.tsx`, `SelectCustomerPanel`/`SelectCustomer.tsx`) updated to use this global state.
2.  **Debugging Practices:** Frequent use of `console.log` statements in various files, along with the temporary import of `console` from `inspector` and "kk" text additions in UI, indicates active development and debugging throughout the changes.
3.  **Logout Mechanism Consistency:** The `handleLogout` function in `usercard.tsx` maintains a consistent logic for clearing session data (`localStorage` and Redux `auth/logout` dispatch) before navigating away, accommodating both Auth0 and standard authentication flows.
4.  **UI Component Refactoring:** The `SelectCustomerPanel` component was introduced, renamed, and moved, suggesting an iterative process to create a reusable and globally accessible customer selection UI.
5.  **Role-Based Access Control:** Changes in `layout.tsx` and `sidebar.tsx` show logic for distinguishing between "ADMIN" and "CUSTOMER" roles, indicating an ongoing effort to implement role-based access and specialized UI elements for different user types.

## 9:43:27 PM
The provided log details changes across two core service files and one route file, all within the `t360-backend-v2` project, occurring on November 5, 2025.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
*   **Timestamp:** 11/5/2025, 12:54:56 PM
*   This file defines a single authentication route, `/api/auth/userinfo`, using an Express router. It imports `IAuthReq`, `IRes`, `Paths`, `HttpStatusCodes`, and `login` (though `login` is not used in this specific route). The route simply logs the `req.user` object and returns it as a JSON response with an HTTP 200 OK status, providing information about the authenticated user.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
*   **Initial State (11/5/2025, 6:04:50 PM - 6:06:01 PM):**
    *   This file provides two main functions: `getDashboardCardInfo` and `getDeliveryData`.
    *   `getDashboardCardInfo` is designed to fetch key shipment metrics for a dashboard, including "Pending Departure," "In Transit," "ETA within 1 Week," and "Out for Delivery," along with their respective TEU (Twenty-foot Equivalent Unit) counts. It applies filters based on `fromDate`, `toDate`, and `CompanyName` from the request query. The `CompanyName` was initially extracted directly from `req.query`. It uses complex SQL queries with `FILTER` clauses and `REGEXP_REPLACE` for data aggregation.
    *   `getDeliveryData` retrieves either delivery or vessel arrival data, filtered by `type` ("delivery" or "vessel") and an optional `mode` (e.g., "ALL", "Rail Delivery", "Door Delivery", "Port Delivery"). It constructs different SQL queries based on these parameters and applies user-specific conditions.
    *   Multiple entries (6:04 PM, 6:05 PM, 6:05 PM, 6:06 PM) show identical code for this file, suggesting a series of minor, non-functional saves or automated formatting operations during this period.

*   **Significant Update (11/5/2025, 8:41:51 PM):**
    *   The `getDashboardCardInfo` function was modified. The `CompanyName` parameter is no longer directly extracted from `req.query`. Instead, a new utility function `getUserObject` (imported from `@src/utils/analytics`) is used to derive the `CompanyName` based on `req.user`, `req.query.companyname`, and `req.query.access`. This change makes the `CompanyName` retrieval more dynamic and context-aware.

*   **Minor Debugging Update (11/5/2025, 8:42:22 PM):**
    *   A `console.log` statement (`console.log("req.CompanyName", CompanyName);`) was added in `getDashboardCardInfo` immediately after the `CompanyName` is determined, likely for debugging the newly implemented logic for company name resolution.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
*   **Initial State (11/5/2025, 8:51:00 PM - 8:51:46 PM):**
    *   This file provides a comprehensive suite of user management functions.
    *   The `login` function handles user authentication, validates credentials against `mtr_user_master`, checks account status, and generates a JWT token upon successful login.
    *   `saveUserPreferences` allows users to save or update various preferences (basic info, email/push notifications, event configurations like specific T49 dates) into the `v2_user_details` table, using an `ON CONFLICT DO UPDATE` clause.
    *   `fetchUserPreferences` retrieves user preferences, using `COALESCE` to provide default values from `mtr_user_master` if `v2_user_details` lacks specific settings.
    *   `saveInviteLog` records user invitations in `v2_user_invite_log` and triggers an email invitation.
    *   `fetchAllCompanyUser` fetches a combined list of active registered users and pending invited users for a given company.
    *   `userSettings` fetches specific user settings, primarily `date_format`, for a given user.
    *   All these functions are exported through an `all` object.
    *   Similar to `dashboardService.ts`, multiple entries (8:51:00 PM, 8:51:15 PM, 8:51:46 PM) show identical code, indicating minor non-functional saves or automated actions during this short interval.

**Patterns and Recurring Elements:**
*   **Timestamp Clustering:** All changes occurred on the same day (11/5/2025), with bursts of very close timestamps for both `dashboardService.ts` and `UserService.ts`. This pattern often suggests automated saves, code formatting tools, or rapid iterative development/debugging.
*   **Modular Architecture:** The use of `@src` aliases for imports (`@src/common/constants`, `@src/common/util`, `@src/models`, `@src/routes/common`, `@src/utils`) indicates a well-structured project with clear module separation.
*   **Database Interaction:** All service files heavily rely on a `query` utility function for interacting with a PostgreSQL database, often constructing dynamic SQL queries.
*   **Logging and Error Handling:** `logger.info` and `logger.error` are consistently used for application insights, and `try...catch` blocks are standard for error management, returning appropriate HTTP status codes (e.g., `HttpStatusCodes.INTERNAL_SERVER_ERROR`).
*   **User Context:** The `req.user` object is a crucial element, consistently used across services to fetch user-specific information for authorization, data filtering (`buildMtrUserCondition`), and personalization.
*   **Application Focus:** The changes indicate ongoing development for a tracking or logistics application (T360-V2), focusing on dashboard analytics, shipment tracking, user management, and personalization.