# Activity Summary for 11/4/2025

## 9:31:42 AM
**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`** (Timestamp: 11/3/2025, 3:44:37 PM)
This file defines the `getTableDataReports` controller function, which is responsible for fetching various analytics reports. It imports several specialized query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `departureQueryBuilder`, `containerQueryBuilder`, `generalQueryBuilder`). The controller dynamically constructs a SQL query based on a `type` parameter received in the request, categorizing reports into groups such as chassis, booking & cargo-ready, containers, departures, and general metrics. It handles default date ranges, user and company context, and executes the generated query, returning the results. A significant portion of the code is dedicated to a large `if-else if` block that maps the `type` parameter to the appropriate query builder.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`** (Timestamp: 11/3/2025, 5:05:37 PM)
This file sets up the API routes for operations related to OTM (Oracle Transportation Management) Bill of Lading (BOL). It exposes endpoints for: exporting excel data, fetching PLPO (Packing List/Proof of Delivery) by BOL, fetching payload, fetching by BOL number, editing OTM BOL, uploading and saving edits, fetching by a common key, generating XML, and sending data to OTM. A previously used file upload route (`/upload`) is commented out, suggesting a change in file upload handling or a temporary disablement.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`** (Timestamp: 11/3/2025, 6:57:38 PM)
This utility file provides a collection of functions essential for analytics and reporting. Key functionalities include:
*   `defaultDateRange`: Generates a default one-year date range.
*   `replaceValueInQuery`: A helper to conditionally modify column values in SQL queries, specifically for 'pod' or 'place_of_delivery'.
*   `getUserObject`: Retrieves user and company-specific information, including handling admin-level access for usercode overrides.
*   `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses for aggregating data by month, week, or quarter, based on the `displayBy` parameter.
*   `getExcelSelectedColumns`: Dynamically selects specific columns for Excel exports, with special handling for reports like "Cargo-Ready Date to ETD" (calculating network days) and "BL Release KPI" (adjusting release dates for weekends).
*   `isValidDate` and `dateFilterOnExport`: Functions to validate and format date strings for display and export, ensuring invalid dates are nullified and valid ones are formatted as "MM/DD/YYYY".
*   `EXCEL_EXPORT_COLUMNS`: A comprehensive array defining the key-name mapping for standard columns used in Excel exports, covering various shipment, container, and date-related fields.

**Summary of Key Information, Significant Changes, and Patterns:**

All logged changes occurred on **November 3, 2025**, indicating a focused period of development or updates.

*   **Analytics Feature Enhancement:** A major theme across `others.controller.ts` and `analytics.ts` is the expansion and refinement of analytics capabilities. This involves dynamic SQL query construction based on various report types, sophisticated date calculations (e.g., network days, weekend adjustments for BL release), and robust data preparation for Excel exports, including column selection and date formatting. The architecture uses a modular approach with dedicated query builders for different analytics categories.
*   **Date-Centric Operations:** There's a strong recurring pattern of handling dates for filtering, aggregation, and display. Functions for default date ranges, date validation, and date formatting are central to the analytics utilities.
*   **Dynamic Query Generation & Reporting:** The system extensively uses parameters like `type` and `displayBy` to dynamically build database queries and customize report outputs, specifically for different time granularities (month, week, quarter) and report names.
*   **OTM Integration:** `otm_bol.route.ts` highlights ongoing development related to OTM integration, covering data exchange (payload fetching, XML generation) and management of Bill of Lading information. The commented-out upload route suggests an evolving strategy for handling OTM-related file uploads.
*   **Logistics/Shipping Domain:** The terminology and types of reports (Chassis, Booking, Container, Departure KPIs, BOL, POL, POD, MBL, ETA, ETD) consistently point to an application heavily involved in logistics and shipping operations.

## 9:32:01 AM
The provided log details frequent iterative changes to UI components and the introduction of new analytics features.

**File-Specific Updates:**

*   **`src\components\common\chip-tabs-view.tsx` (Frequent updates between 11/3/2025, 2:50:09 PM and 11/3/2025, 6:04:54 PM):**
    *   This file underwent numerous styling adjustments for the `ChipsTabView` component. This included changes to:
        *   The overall `max-width` of the component, progressively increasing from `520px` to `1150px` (with some temporary larger values like `1200px`) and some relative positioning adjustments (`ml-[-4px]`, `ml-[-6px]`).
        *   The `gap` between chips, fluctuating between `gap-2` and `gap-3`.
        *   The appearance of individual chip buttons and the "New" button, specifically their `border-radius` (e.g., `rounded-full`, `rounded-lg`, `rounded-md`, `rounded-xl`), `padding` (`py-1.5` vs `py-2`), `width`, `min-width`, `height`, and `shadow` effects.
        *   Color schemes for active and inactive chips, including a temporary shift to a dark active background which was later reverted.
        *   The placement of icons within chip buttons (moving from `{icon} {label}` to `<span>{label}</span> <span className="text-gray-500">{icon}</span>`).
        *   The order of the "New" button relative to other options in the scrollable container was swapped.
        *   The size of the scroll Chevron icons (from `small` to `large`).
        *   Several `console.log` statements were added and modified to debug options and values passed to the component.
    *   The `Option` interface was updated to explicitly include `icon?: React.ReactNode;`.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx` (Updates between 11/3/2025, 2:56:23 PM and 11/3/2025, 5:11:25 PM):**
    *   This file primarily focuses on the `AnalyticsToolbar` component, which includes controls for the analytics dashboard.
    *   Significant additions include a robust PDF export functionality for the entire dashboard using `jspdf` and `html2canvas-pro`, complete with a `getBase64Image` utility for handling the logo.
    *   It integrates Redux (`useDispatch`, `useSelector`) to manage global filters, selected dashboards, and operation types.
    *   Imports for various icon libraries (`@mui/icons-material`, `@heroicons/react`, `react-icons`) were frequently added and adjusted, indicating an evolving set of UI icons. `MagnifyingGlassIcon`, `PlusIcon`, and `PresentationChartLineIcon` from `@heroicons` were added and/or repositioned in imports, alongside `HiPresentationChartLine` from `react-icons/hi2`.
    *   Numerous entries show no code changes, suggesting frequent saves or minor, undetailed edits.

*   **`src\components\screen\analytics\analyticsContainer.tsx` (Updates between 11/3/2025, 4:52:06 PM and 11/3/2025, 4:53:29 PM):**
    *   This file introduces the `AnalyticsContainer` component, which is responsible for rendering and managing individual metric widgets on a dashboard.
    *   It implements drag-and-drop functionality using `react-dnd` (`HTML5Backend`) to reorder metrics (`moveItem`).
    *   It supports resizing of metric widgets (`saveSize`) and changing their view type (chart/table) (`saveView`).
    *   API interactions (`useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`) are set up for fetching report data and persisting layout changes.
    *   `moment.js` is used for date formatting in API calls.
    *   Extensive Redux integration is present for managing metrics and filter states.

*   **`src\components\screen\analytics\MetricFooter.tsx` (Initial commit at 11/3/2025, 5:16:09 PM):**
    *   Introduced the `MetricFooter` component, providing actions and information at the bottom of individual metric boxes.
    *   Features include displaying calculated values with a `Badge`, showing detailed formulas via a `Tooltip`, exporting data to Excel (`FaFileExcel`) with column selection via a `ThemedModal` and `ColumnsSelector`, and exporting individual metric charts to PDF (`MdPictureAsPdf`) using `jspdf` and `html2canvas-pro`.
    *   A fullscreen option (`FullscreenOutlined`) to enlarge the metric is also included.

*   **`src\components\screen\analytics\Charts\GaugeChart.tsx` (Updates between 11/3/2025, 5:58:14 PM and 11/3/2025, 5:59:43 PM):**
    *   This file adds the `GaugeChart` component, which renders a radial bar chart using `react-apexcharts`.
    *   It dynamically sets the gradient fill color based on whether the `value` is below a certain limit (e.g., green/dark gray for < 3 days, orange otherwise).
    *   The chart's value formatter displays data in "Days".
    *   Initial color choices for the gauge were experimented with, moving from green/orange to dark gray/orange.

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx` (Initial commit at 11/3/2025, 6:05:49 PM):**
    *   Introduced `ViewContainer` for managing custom analytics dashboards (views).
    *   Allows users to create, edit, and delete views, specifying a title.
    *   Supports two types of views: "Container Wise" and "MBL Wise", selectable via a `RadioNav`.
    *   Metrics can be selected using a `TreeViewContainer`, with a limit of 9 metrics.
    *   Integrates API calls for fetching and saving dashboard configurations (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`).
    *   Includes a "Delete" option with a confirmation `PopupAlert` and an "Audit" feature displayed in an `AuditViewDrawer`.

**Patterns and Recurring Elements:**

*   **Iterative UI/UX Refinement:** A prominent pattern is the rapid and detailed iteration on UI elements, especially visible in `chip-tabs-view.tsx`. This suggests an active development phase focused on optimizing the look, feel, and responsiveness of user interface components, often involving micro-adjustments to CSS classes.
*   **Redux for State Management:** All major new or updated components (`AnalyticsToolbar`, `analyticsContainer`, `MetricFooter`, `ViewContainer`) leverage `react-redux` for managing complex application state, indicating a consistent architectural choice for state handling across the analytics section.
*   **API Integration with RTK Query:** The use of RTK Query hooks (e.g., `useLazyFetchReportQuery`, `useSaveDasboardMutation`) is consistent across components that interact with the backend, demonstrating a standardized approach to data fetching and mutations.
*   **PDF Generation:** The repeated use of `jspdf` and `html2canvas-pro` in both `AnalyticsToolbar.tsx` and `MetricFooter.tsx` for exporting content to PDF highlights a key feature and a shared utility pattern within the analytics module.
*   **Debugging Practices:** The presence of `console.log` statements throughout the code, often modified in subsequent commits, points to active debugging and verification during development.
*   **Modular Component Design:** The creation of distinct components like `ChipsTabView`, `AnalyticsToolbar`, `AnalyticsContainer`, `MetricFooter`, `GaugeChart`, and `ViewContainer` under the `analytics` and `common` directories reflects a modular and organized approach to frontend development.

## 9:32:22 AM
The code changes primarily focus on enhancing the analytics and reporting functionalities within the `t360-backend-v2` project, spanning various service files and a utility file. Key updates include the refinement of SQL query generation, improved type safety, and the addition of user-specific preferences and dashboard metric management.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analyticsExportService.ts`**:
    *   **11/3/2025, 11:51:04 AM**: Introduced the `getExportData` controller to handle dynamic SQL query generation for booking and non-booking reports, including a `replaceColumnHandler` for standardizing "LONG BEACH" to "LOS ANGELES" in `pod` and `place_of_delivery` fields. Logic for MBLwise TEU filtering was also present.
    *   **11/3/2025, 11:52:28 AM**: Experienced a brief, temporary change in the database import path from `@src/common/util/database` to `@src/common/db`, which was subsequently reverted. This version also contained duplicate code blocks and a typo (`co logger.error`).
    *   **11/3/2025, 11:52:44 AM**: Rectified the duplicate code and typo, restoring code cleanliness, while keeping the temporary database import path.
    *   **11/3/2025, 11:54:19 AM**: Reverted the database import path back to `@src/common/util/database`. Refactored `getUserObject` calls and added numerous `console.log` statements for debugging `req.query`, `userCode`, `mainQuery`, and `excelExportData`. Simplified MBLwise TEU filter logic and removed `NextFunction` from imports.
    *   **11/3/2025, 11:56:23 AM**: Final cleanup removing commented-out `replaceColumnHandler` code.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**:
    *   **11/3/2025, 11:58:36 AM**: Introduced a `getMonthValue` helper and the `bookingQuery` function responsible for generating complex, conditional SQL query fragments for various booking reports, including specialized logic for "Stacked Bar" reports based on date differences.
    *   **11/3/2025, 11:58:42 AM**: No functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**:
    *   **11/3/2025, 12:00:20 PM**: Defined `bookingQueryBuilder` to construct SQL queries for booking-related analytics, configuring `customizer` properties like `dateRange`, `calType`, and `dateColumns`. Queries involve calculating time differences, handling distinct entities, and grouping results for various report types.
    *   **11/3/2025, 1:22:57 PM - 1:29:32 PM**: Progressively refined the `QueryBuilderI` and `Customizer` interfaces, moving from generic `any` types to more specific `string[]`, then introducing new interfaces like `CalColumn` and `CalColumnConfig`. `Customizer` was extended to include properties like `calType`, `dateColumns`, `booking`, `calColumnConfig`, `mblwise`, and `chartType`, indicating a push for stronger type checking and clearer data structures for report configurations.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\tableService.ts`**:
    *   **11/3/2025, 12:02:23 PM**: Established `getTableDataReports` as a central dispatcher, importing various query builders (chassis, booking, container, departure, general) to dynamically construct queries based on the `type` parameter from the request.
    *   **11/3/2025, 12:08:25 PM**: Added a `console.log(error)` in the catch block for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\containerService.ts`**:
    *   **11/3/2025, 12:11:01 PM**: Implemented `getContainerReports` for container-specific analytics, dynamically generating queries grouped by various columns (e.g., `country_of_origin`, `trucker`). Queries involve calculating container counts and percentages, and include direct SQL `CASE` statements for port name normalization and handling null/empty values.
    *   **11/3/2025, 12:13:38 PM**: Refactored for improved type safety and readability by introducing explicit interfaces (`ContainerReportQuery`, `Customizer`, `AnalyticsRow`) and adding descriptive comments. Type-safe `query` invocation was implemented, and nullish coalescing was used for default values.
    *   **11/3/2025, 12:16:36 PM**: Added a `console.log("===reqquery",req.query);` for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\analyticsRoutes.ts`**:
    *   **11/3/2025, 12:21:34 PM**: Configured routing for various analytics reports (`GetExcelReport`, `GetTeu`, `GetCbm`, `GetKgs`, `GetContainers`, `GetTransit`, `GetTablesData`), integrating them into the `/analytics` base path.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**:
    *   **11/3/2025, 1:22:26 PM**: Centralized utility functions: `defaultDateRange`, `replaceValueInQuery` (for port name normalization), `getUserObject` (for user/company info), `getFilterQueryByDisplayValue` (for dynamic SQL clauses), `getExcelSelectedColumns` (for report-specific column selection), and `dateFilterOnExport` (for date cleanup and formatting). Also defined `EXCEL_EXPORT_COLUMNS` constant.
    *   **11/3/2025, 5:08:26 PM**: No functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**:
    *   **11/3/2025, 3:39:14 PM**: Implemented core user management functionalities, including `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. These functions handle user authentication, preferences (persisted with `ON CONFLICT DO UPDATE`), user invitations, and fetching user lists.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\index.ts`**:
    *   **11/3/2025, 3:39:25 PM**: Integrated `UserRoutes` into the main API router.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**:
    *   **11/3/2025, 4:32:00 PM**: Introduced `getTEUReports` for generating TEU-related analytics. Similar to container reports, it dynamically builds queries based on grouping columns, calculates TEU from container types, and includes logic for port name normalization and handling missing values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**:
    *   **11/3/2025, 4:32:31 PM**: Implemented services for managing dashboard metrics: `dashboardEndPointList` (fetches ordered and sized metrics), `getMetricList` (categorizes and preloads metrics), `saveSequence` (persists metric order), and `saveSize` (saves metric display sizes).
    *   **11/3/2025, 4:49:23 PM**: Added a `console.log` for debugging in the `saveSequence` catch block.

**Timestamps of Significant Changes:**

*   **11/3/2025, 11:51:04 AM**: Initial development/major update of `analyticsExportService.ts` for export data functionality.
*   **11/3/2025, 11:54:19 AM**: Refactoring and extensive debugging additions in `analyticsExportService.ts`.
*   **11/3/2025, 11:58:36 AM**: Introduction of dynamic query fragments for booking reports in `export.query.ts`.
*   **11/3/2025, 12:00:20 PM**: Initial implementation of `bookingQueryBuilder` in `booking.query.ts` for analytics reports.
*   **11/3/2025, 12:02:23 PM**: Creation of `tableService.ts` as a central report dispatcher.
*   **11/3/2025, 12:11:01 PM**: Initial implementation of `containerService.ts` for container-specific reports.
*   **11/3/2025, 12:13:38 PM**: Major refactoring in `containerService.ts` for type safety and code structure.
*   **11/3/2025, 1:22:26 PM**: Comprehensive utility functions introduced in `analytics.ts`.
*   **11/3/2025, 1:29:32 PM**: Final refinement of `Customizer` interface in `booking.query.ts` for advanced configuration.
*   **11/3/2025, 3:39:14 PM**: Introduction of `UserService.ts` with user authentication, preferences, and invitation management.
*   **11/3/2025, 4:32:00 PM**: Initial implementation of `teuService.ts` for TEU-specific reports.
*   **11/3/2025, 4:32:31 PM**: Initial implementation of `coreMetricService.ts` for dashboard metric management.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Generation**: A pervasive pattern across multiple services (`analyticsExportService`, `export.query.ts`, `booking.query.ts`, `containerService`, `teuService`) involves constructing SQL queries programmatically based on user input, report types, and company context.
*   **Port Name Normalization**: The transformation of "LONG BEACH" to "LOS ANGELES" is a consistent data cleansing rule, applied both in post-query processing and embedded directly into SQL queries.
*   **Date Handling**: All services consistently retrieve default date ranges and format dates for consistency and to filter out invalid entries.
*   **User and Company Context**: The `getUserObject` utility is repeatedly used to retrieve user and company-specific data, enabling personalized analytics and reports.
*   **Modular Query Builders**: The system utilizes distinct query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`) for different report categories, orchestrated by services like `tableService`.
*   **Type Safety and Interfaces**: There's an observable trend of progressively enhancing type definitions and introducing explicit interfaces (e.g., `QueryBuilderI`, `Customizer`, `AnalyticsRow`) for better code maintainability and error detection.
*   **Extensive Logging and Debugging**: `logger.info`, `logger.error`, and `console.log` statements are heavily used throughout the codebase, indicating an active development and debugging environment.
*   **Dashboard Customization**: Services like `coreMetricService` and `analyticsExportService` include logic for users to customize dashboard layouts, metric order, and display sizes, with a particular focus on "Stacked Bar" reports and MBL/Container-wise filtering.

## 10:38:48 AM
**File Path:** `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`
**Timestamp:** `11/3/2025, 3:47:35 PM`

This file, `methods.js`, serves as a central utility hub for analytics functionalities within the `t360-frontend` application. It includes functions for data processing, chart configuration, formula generation, date formatting, and crucially, Excel report generation.

**Key Updates and Functionality:**

*   **`TruncateText`:** A simple utility function to shorten text strings.
*   **`metricsPackageHandler`:** This is a core function for preparing metric data for display. It dynamically determines the chart type (e.g., `Count`, `StackedBar`, `Transit`, `General`) based on `customizer` settings. It also calculates aggregate values (Avg, Total, NA) for metrics and structures the output, including report name, column/row spans, and formatted data.
*   **Chart Configuration (`allChartOptions`, `chartOptionsByType`):** Defines the available chart types (bar, pie, line, stack, gauge) along with their corresponding Material-UI icons and categorizes them by chart behavior (General, StackBar, Transit, Count).
*   **`reportFormula`:** A function that generates dynamic formula strings based on the `reportName` and selected `dateColumns`. It handles specific cases like "Scheduled vs Actual Transit Time" and general date difference calculations.
*   **`weekDateFormater`:** Uses `moment.js` to format dates into a "D MMM" string.
*   **`downloadReportSpreadsheet`:** This extensive function handles the generation and download of Excel spreadsheets for various analytics reports using `exceljs` and `file-saver`.
    *   It meticulously constructs the report metadata, including metric name, client, and date ranges.
    *   Headers are dynamically adjusted based on `periodFilter` (month, week, quarter) for "StackedBar" charts, and additional "View" headers are added for "transitBar" charts.
    *   The function contains significant conditional logic to map and populate report data into the Excel sheet based on the `chartType` and specific `reportName`. This includes handling standard charts with average/total calculations, as well as several distinct `StackedBar` report types like "Cargo-Ready Date to ETD", "Containers Shipped", "Total Spend per Month", and "Average Transit Time per Month".
    *   Data transformation occurs during mapping, such as splitting entities or extracting month names.

**Patterns and Recurring Elements:**

*   **Extensive use of `moment.js`** for date parsing and formatting across multiple functions, particularly for displaying date ranges and formatting individual dates.
*   **Heavy reliance on conditional logic (`if/else if`)** based on `customizer.chartType`, `item.reportName`, and `periodFilter` to dictate data processing, chart rendering, and Excel export structure. This pattern is prominent in both `metricsPackageHandler` and `downloadReportSpreadsheet` to adapt to diverse report types and data layouts.
*   **Dynamic Data Mapping:** Data from the backend is frequently transformed and formatted on the frontend, often by extracting specific properties from objects (`d.entity.split(",")`, `d["month"].split(" ")`) or applying numerical formatting, especially when preparing data for Excel.
*   **Excel Export Detail:** The `downloadReportSpreadsheet` function demonstrates a highly granular approach to structuring Excel files, with specific column headers and data aggregation techniques tailored to each report type and period filter.
*   **Abrupt End:** The provided code snippet ends mid-way through a conditional block for the `downloadReportSpreadsheet` function, indicating further `StackedBar` report definitions or other export logic might follow.

## 10:38:54 AM
The code changes reflect a significant enhancement of the backend's analytics and OTM (Oracle Transportation Management) Bill of Lading functionalities, with a strong focus on data reporting and utility improvements.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 11/3/2025, 3:44:37 PM):**
    *   This file, responsible for analytics reports, has undergone substantial expansion. It now dynamically dispatches to various specialized query builders (chassis, booking, departure, container, general) based on the `type` of report requested.
    *   The `bookingQueryBuilder` section specifically has been greatly extended to handle a multitude of booking and cargo-ready related report types, including `*MblWise` and `*StackedBar` variations, `ContainerShippedMblWise`, `AverageTransitTimeMblWise`, and `TotalSpendPerMonth`, indicating a broad increase in detailed booking analytics.
    *   It now fetches user-specific `companyname` and `user_id` using `getUserObject` for personalized data access.
    *   Default date ranges are applied if not provided in the request.
    *   Queries are logged to the console before execution for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts` (Timestamp: 11/3/2025, 5:05:37 PM):**
    *   This routing file for OTM Bill of Lading operations has several new endpoints.
    *   New GET routes include `/excel_data` for export, `/fetch_payload`, and `/fetch/:common_key`.
    *   New POST routes include `/` for editing, `/upload_save_edit`, `/generate_xml`, and `/send_to_otm`.
    *   A previous `/upload` route using `uploadMiddleware` is commented out, suggesting a refactoring or temporary deactivation of that specific upload mechanism, potentially replaced by `upload_save_edit`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts` (Timestamp: 11/3/2025, 6:57:38 PM):**
    *   This utility file has received extensive new functionalities to support the enhanced analytics controller.
    *   `defaultDateRange` now calculates a date range of one year prior to the current date.
    *   `replaceValueInQuery` was refined for more robust column name handling.
    *   `getUserObject` was improved to handle company-specific user codes, especially for 'ADMIN' access, by querying the `mtr_user_master` table.
    *   `getFilterQueryByDisplayValue` is a new function for generating dynamic `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses based on time periods (month, week, quarter) for aggregation.
    *   `getExcelSelectedColumns` is a new function that dynamically selects columns for Excel exports based on the report name (e.g., "Cargo-Ready Date to ETD", "BL Release KPI") and a booking flag, including a network days calculation.
    *   New utility functions `isValidDate` and `dateFilterOnExport` were added to validate and format date fields within datasets before export, ensuring data integrity and presentation.
    *   A comprehensive `EXCEL_EXPORT_COLUMNS` constant array was introduced, detailing the key and display name for a wide array of shipment and container-related fields for exports.
    *   The `moment` library is now utilized for flexible date formatting.

**Patterns and Recurring Elements:**

*   **Analytics Expansion and Modularity:** There's a clear pattern of expanding analytics capabilities across the system, with a modular design using specialized query builders and utility functions for various report types and data processing tasks.
*   **Dynamic Query Generation:** Several new functions (e.g., `getFilterQueryByDisplayValue`, `getExcelSelectedColumns`) are designed to dynamically construct parts of database queries or select columns based on user input or report type.
*   **Robust Date Handling:** A strong emphasis on date management is evident, including default date ranges, date validation (`isValidDate`), date formatting for exports (`dateFilterOnExport` using `moment`), and date-based aggregations (`getFilterQueryByDisplayValue`).
*   **Enhanced Export Functionality:** The addition of `getExcelSelectedColumns`, `dateFilterOnExport`, and `EXCEL_EXPORT_COLUMNS` indicates a significant investment in improving the accuracy, completeness, and formatting of data exported to Excel.
*   **User Context and Access Control:** The `getUserObject` logic suggests a system that dynamically adjusts data access or query parameters based on user roles (e.g., 'ADMIN') and associated companies.
*   **OTM Integration:** The updates to the OTM BOL routes point to an ongoing effort to enhance integration with Oracle Transportation Management, including data exchange (XML generation) and process management (sending to OTM).

## 10:39:15 AM
The provided log details a series of iterative changes primarily focused on frontend UI components and analytics dashboard functionality.

**File-Specific Updates:**

*   **`src\components\common\chip-tabs-view.tsx`**: This file underwent extensive and frequent modifications, particularly between **11/3/2025, 2:50:09 PM** and **11/3/2025, 3:28:26 PM**, and then again with console logs around **6:03:52 PM - 6:04:54 PM**.
    *   Early changes involved minor adjustments to Tailwind CSS classes for spacing (`gap-2` to `gap-3`), button rounding (`rounded-full` to `rounded-lg`), text colors, and hover effects.
    *   A significant update around **11/3/2025, 2:54:13 PM** introduced fixed width (`w-[180px]`), height (`h-[40px]`), and shadow styling (`shadow-[0_4px_6px...]`) for the optional "New" button chip. This styling was temporarily applied to, then reverted from, the regular option buttons.
    *   Around **11/3/2025, 2:57:06 PM**, the rendering order of the "New" button and the option buttons was swapped.
    *   A major stylistic overhaul at **11/3/2025, 3:09:50 PM** standardized button appearance, introducing `icon` as a property for both regular options and the "New" button, changing rounding to `rounded-xl` (later to `rounded-md`), and simplifying shadow classes. Scroll button styling and icon sizes (`ChevronLeft`, `ChevronRight`) were also adjusted multiple times (e.g., `fontSize="small"` to `medium` to `large`).
    *   The `max-w` property of the main container `div` was frequently modified, expanding from `520px` to `1200px` and then settling around `1150px` by **11/3/2025, 3:28:26 PM**, often accompanied by `ml-[-6px]` adjustments for precise positioning.
    *   Console log statements for `options` and `value` were added and refined in the later timestamps.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**: The initial entry at **11/3/2025, 2:56:23 PM** marks a substantial update, introducing numerous imports for UI components, state management, and PDF generation libraries.
    *   A `downloadDashboardPDF` function was implemented using `jsPDF` and `html2canvas-pro` to export the analytics dashboard to PDF, including a logo. This functionality persisted throughout subsequent commits, with earlier commented-out versions visible.
    *   The component heavily relies on Redux (`useDispatch`, `useSelector`) to manage dashboard state, filters, and operation types.
    *   It integrates the `ChipsTabView` component, providing options for dashboard views and a "New" button.
    *   Minor import changes for icons from `@heroicons/react` and `react-icons/hi2` occurred intermittently (e.g., `MagnifyingGlassIcon`, `PlusIcon` removed, `PresentationChartLineIcon` changed size, `HiPresentationChartLine` added) between **11/3/2025, 3:05:04 PM** and **11/3/2025, 3:23:44 PM**.
    *   Many commits for this file show no functional code changes, suggesting frequent saves during development.

*   **`src\components\screen\analytics\analyticsContainer.tsx`**: The change at **11/3/2025, 4:52:06 PM** introduces the core analytics grid container.
    *   This component uses `react-dnd` for drag-and-drop functionality, allowing users to reorder and resize (`moveItem`, `saveSize`) metrics on the dashboard.
    *   It fetches and dispatches report data, integrating with a Redux slice and API mutation hooks (`useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`).
    *   It renders `ResizableGridItem` components, each encapsulating a `MetricsBox`.
    *   No significant changes were observed in the subsequent timestamp for this file.

*   **`src\components\screen\analytics\MetricFooter.tsx`**: At **11/3/2025, 5:16:09 PM**, this component was updated to provide actions for individual metric cards.
    *   It includes functionalities to enlarge metrics, export data to Excel (`handleExcel` using `downloadReportSpreadsheet`), and export individual metric charts to PDF (`handlePdf` utilizing `jsPDF` and `html2canvas-pro`).
    *   It also features column selection for Excel export via a modal (`ColumnsSelector`) and displays calculated values or formulas.

*   **`src\components\screen\analytics\Charts\GaugeChart.tsx`**: This chart component was introduced at **11/3/2025, 5:58:14 PM**.
    *   It uses `react-apexcharts` to render a radial bar chart (gauge) visualizing "Average Days".
    *   The fill color of the gauge is dynamically determined based on a `value < 3` condition.
    *   Subsequent minor adjustments were made to the gradient colors and shades of the chart's fill property between **11/3/2025, 5:58:58 PM** and **11/3/2025, 5:59:43 PM**.

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx`**: This component, introduced at **11/3/2025, 6:05:49 PM**, enables users to manage custom dashboard views.
    *   It supports adding, editing, and deleting views, categorized as "Container Wise" or "MBL Wise" via a `RadioNav`.
    *   Metrics can be selected through a `TreeViewContainer`, with a limit of 9 metrics per view.
    *   It interacts with the analytics API (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`) and Redux for persistence and state updates.
    *   Audit functionality for view changes is included through an `AuditViewDrawer`.

**Patterns and Recurring Elements:**

1.  **Frontend Focus:** The majority of changes involve UI components (`chip-tabs-view.tsx`, `AnalyticsToolbar.tsx`, `MetricFooter.tsx`, `GaugeChart.tsx`, `ViewContainer.tsx`), with significant attention to styling (primarily Tailwind CSS) and interactive elements.
2.  **Iterative UI/Styling Refinement:** `chip-tabs-view.tsx` demonstrates a pattern of rapid, incremental changes to visual properties like sizing, spacing, rounding, and shadows, indicating an active design and polish phase.
3.  **PDF Export Integration:** Both the global `AnalyticsToolbar.tsx` and individual `MetricFooter.tsx` components leverage `jspdf` and `html2canvas-pro` for client-side PDF generation, highlighting a key reporting feature.
4.  **Redux and API Integration:** All major components (`AnalyticsToolbar`, `AnalyticsContainer`, `MetricFooter`, `ViewContainer`) are integrated with Redux for state management and utilize RTK Query hooks for interacting with a backend API to fetch and persist data (e.g., dashboard configurations, metric sizes, report data).
5.  **Dynamic Dashboard Customization:** The combination of `AnalyticsToolbar` (for view selection/creation), `AnalyticsContainer` (for drag-and-drop metric management), and `ViewContainer` (for detailed view configuration) points to a robust system for user-defined analytics dashboards.
6.  **Debugging & Monitoring:** The presence of multiple `console.log` statements in `chip-tabs-view.tsx`, `AnalyticsToolbar.tsx`, and `ViewContainer.tsx` suggests ongoing development and debugging activities.
7.  **Consistent Timestamp Grouping:** Most changes occur within narrow timeframes (e.g., minute-by-minute updates for `chip-tabs-view.tsx`), reflecting focused work sessions on specific components.

## 10:39:33 AM
The code changes primarily focus on backend analytics and reporting functionalities, encompassing data export, dashboard metric management, and various data-driven reports for container, booking, and general statistics.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analyticsExportService.ts` (11/3/2025, 11:51:04 AM - 11:56:23 AM)**
    *   **Initial Functionality**: The `getExportData` controller handles requests for exporting analytics data, distinguishing between booking and non-booking reports. It applies date filtering, retrieves user and company information, constructs dynamic SQL queries, and includes a `replaceColumnHandler` to standardize "LONG BEACH" to "LOS ANGELES" in `pod` and `place_of_delivery` fields. A specific filter for MBLwise TEU reports is implemented.
    *   **Key Changes & Issues**:
        *   Between 11:52:28 AM and 11:54:19 AM, there were significant structural issues, including duplicate interface definitions (`AnalyticsControllerQuery`), duplicate `replaceColumnHandler` functions (one commented out), and temporary incorrect or missing imports for the `query` utility and `nonBookingQuery`.
        *   By 11:56:23 AM, critical import issues (like `query` and `nonBookingQuery`) were resolved, but some inconsistencies such as unused `NextFunction` import and the duplicated, commented-out helper function persisted.
        *   Numerous `console.log` statements were added throughout this period, indicating active debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts` (11/3/2025, 11:58:36 AM - 11:58:42 AM)**
    *   Introduced a `getMonthValue` helper for date conversion.
    *   Significantly expanded the `bookingQuery` function by adding complex SQL query strings for various report types, including "Booking Date to Actual Departure" (and its MBL Wise, Stacked Bar variations), "Booking Date to Estimated Departure", and "Booking Date to POD Arrival". These queries involve joining tracking and booking data, filtering by company name, date ranges, and handling specific date validation. Stacked bar queries include logic to categorize time differences into weeks (e.g., "Less than 1 week").
    *   The file content appeared truncated in the log at both timestamps.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` (11/3/2025, 12:00:20 PM - 1:29:32 PM)**
    *   **Core Functionality**: The `bookingQueryBuilder` function was introduced to dynamically generate SQL queries for various booking-related analytics reports. It utilizes helper functions like `getColumnsByCategory` and `getFilterQueryByDisplayValue` to customize the query.
    *   **Type Safety Improvements**: A series of changes from 1:22:57 PM to 1:29:32 PM focused on enhancing type safety by defining explicit TypeScript interfaces (`Customizer`, `QueryBuilderI`, `CalColumn`, `CalColumnConfig`) for the function's arguments and internal data structures, particularly for the `customizer` object. Properties like `mblwise` and `chartType` were added to `Customizer`.
    *   The SQL queries within this builder focus on calculating average day differences between booking dates and various event dates (e.g., actual departure) and generating data for stacked bar charts.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\tableService.ts` (11/3/2025, 12:02:23 PM - 12:08:25 PM)**
    *   The `getTableDataReports` controller acts as a central dispatcher, routing requests for different report types (chassis, booking, containers, departures, general) to their respective query builder functions.
    *   It handles default date ranges and retrieves user/company context.
    *   A massive `if-else if` block categorizes report `type` to call the appropriate `QueryBuilder` (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`).
    *   Includes `console.log` statements for debugging generated SQL queries.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\containerService.ts` (11/3/2025, 12:11:01 PM - 12:16:36 PM)**
    *   **Core Functionality**: The `getContainerReports` controller generates container-related analytics, grouping data by a specified column (e.g., `country_of_origin`, `trucker`).
    *   **Query Logic**: Dynamically constructs SQL queries, joining with `portmaster` for country-based grouping or applying specific conditions for `trucker` (filtering `type_of_move`). It includes the "LONG BEACH" to "LOS ANGELES" replacement logic.
    *   **Refactoring**: From 12:13:38 PM, the code was refactored with explicit interfaces (`ContainerReportQuery`, `Customizer`, `AnalyticsRow`) and descriptive comments to improve readability and maintainability.
    *   A `console.log("===reqquery",req.query);` was added for debugging at 12:16:36 PM.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\analyticsRoutes.ts` (11/3/2025, 12:21:34 PM)**
    *   Defined API routes for analytics, including general views, dashboard metrics (list, save sequence, save size), and specific reports like Excel export, TEU, CBM, KGS, Containers, Transit, and Tables Data.
    *   Includes a redundant `AnalyticsRoutes.get(Paths.Analytics.Get,getAll);` entry.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts` (11/3/2025, 1:22:26 PM - 5:08:26 PM)**
    *   This utility file centralizes helper functions for analytics:
        *   `defaultDateRange`: Provides a default 365-day date range.
        *   `replaceValueInQuery`: Replaces "LONG BEACH" with "LOS ANGELES" for specific columns.
        *   `getUserObject`: Retrieves user and company details, with admin override logic.
        *   `getFilterQueryByDisplayValue`: Generates SQL clauses for grouping and ordering by month, week, or quarter.
        *   `getExcelSelectedColumns`: Dynamically selects columns for Excel exports based on report name and booking status, with special logic for "Cargo-Ready Date to ETD" and "BL Release KPI".
        *   `dateFilterOnExport`: Filters and formats date values in data rows, handling invalid/default dates.
        *   `EXCEL_EXPORT_COLUMNS`: Defines a static mapping of keys to display names for Excel export columns.
    *   Includes `console.log` statements for debugging `getUserObject` and `userSettings`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts` (11/3/2025, 3:39:14 PM)**
    *   Implemented `login` functionality with user authentication, status checks, and JWT token generation.
    *   `saveUserPreferences` and `fetchUserPreferences` for managing user settings, using `ON CONFLICT DO UPDATE` for saving.
    *   `saveInviteLog` for tracking user invitations and sending emails.
    *   `fetchAllCompanyUser` to retrieve all active and pending users for a given company.
    *   `userSettings` to fetch specific user configurations like date format.
    *   Extensive use of `logger.info` and `logger.error` for operational and debugging messages.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\index.ts` (11/3/2025, 3:39:25 PM)**
    *   The main `apiRouter` aggregates all sub-routes (`AuthRoutes`, `ShipmentRoutes`, `AnalyticsRoutes`, etc.), providing a top-level routing structure for the application.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts` (11/3/2025, 4:32:00 PM)**
    *   The `getTEUReports` controller calculates and returns TEU (Twenty-foot Equivalent Unit) reports, grouped by dynamic columns.
    *   It handles default date ranges, retrieves user context, and builds dynamic SQL queries.
    *   Queries involve calculating `total_volume` from container types and converting it to TEU by dividing by 20. Similar to other services, it includes logic for 'LONG BEACH' replacement and 'OTHERS' categorization for null/empty grouping columns.
    *   `mblwiseCondition` object is defined but its `select`, `condition`, `groupBy` properties are not explicitly integrated into the main query logic shown, which could indicate an incomplete feature or refactoring.
    *   Includes `logger.info` for the query and `console.log` for errors.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts` (11/3/2025, 4:32:31 PM - 4:49:23 PM)**
    *   Manages dashboard metrics:
        *   `dashboardEndPointList`: Fetches and sorts dashboard metrics for a user and a specific dashboard.
        *   `getMetricList`: Retrieves and categorizes all available metrics into container-wise and MBL-wise groups, with an option to pre-select metrics based on an existing dashboard.
        *   `saveSequence`: Updates the display order of metrics on a dashboard.
        *   `saveSize`: Updates the `columnSpan` and `rowSpan` for individual metrics on a dashboard.
    *   Uses `logger` for information and error reporting, with additional `console.log` for debugging.
    *   A minor `console.log` was added in the `saveSequence` catch block at 4:49:23 PM.

**Recurring Elements and Patterns:**

*   **Consistent Date Handling**: The `defaultDateRange` function is a recurring utility to ensure date filters are always applied, even if not explicitly provided in the request.
*   **User and Company Context**: `getUserObject` is a central function across multiple services to establish the user's context (user code, company name) for data filtering and access control.
*   **Dynamic SQL Query Generation**: A strong pattern of building flexible SQL queries based on request parameters (`reportName`, `columnName`, `type`, `displayBy`) is evident, often utilizing `WITH` clauses and conditional logic.
*   **Standardized Port Names**: The replacement of "LONG BEACH" with "LOS ANGELES" is a common data sanitization or standardization requirement seen in `analyticsExportService.ts`, `containerService.ts`, `teuService.ts`, and `analytics.ts`.
*   **Comprehensive Error Handling and Logging**: All service functions consistently implement `try...catch` blocks for robust error handling and extensively use a `logger` utility (`logger.info`, `logger.error`) for debugging, monitoring, and tracing application flow.
*   **Type Safety Evolution**: The repeated introduction and refinement of TypeScript interfaces (e.g., in `booking.query.ts` and `containerService.ts`) indicate an ongoing effort to improve code quality, readability, and maintainability.
*   **Debugging Statements**: The presence of numerous `console.log` statements throughout the code base suggests an active development environment where specific values and execution paths are frequently inspected.
*   **Database Interaction Layer**: All data retrieval and manipulation consistently use a single `query` utility, indicating a centralized database interaction layer.

## 11:38:49 AM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js` was updated on 11/3/2025, 3:47:35 PM. This file contains a collection of utility functions and handlers primarily focused on processing, displaying, and exporting analytics data within a frontend application.

Key updates and functionalities include:

*   **Utility Functions:**
    *   `TruncateText`: A simple utility to shorten text strings and append an ellipsis.
    *   `weekDateFormater`: Formats a given date into a "D MMM" string using `moment.js`.
*   **Analytics Data Processing (`metricsPackageHandler`):**
    *   This function is central to preparing analytics data for display. It determines the appropriate chart type (e.g., `Count`, `Stackbar`, `Transit`, `General`) based on metric customizer settings.
    *   It calculates summary values (Average, Total, or N/A) based on the `calType` specified in the metric's customizer, handling cases where certain chart types are not allowed for calculations.
    *   It also determines the correct formatting settings (e.g., "days", "t360volume") for the data.
*   **Chart Configuration:**
    *   `allChartOptions`: An array defining available chart types (bar, pie, line, stack, gauge) with corresponding Material-UI icons.
    *   `chartOptionsByType`: An object mapping broader chart categories (`General`, `StackBar`, `Transit`, `Count`) to specific chart keys from `allChartOptions`.
*   **Report Formula Generation (`reportFormula`):**
    *   Dynamically generates mathematical formulas based on the `reportName` and `dateColumns` provided in the customizer. It includes specific logic for "Scheduled vs Actual Transit Time" and a general case for two date columns.
*   **Excel Report Export (`downloadReportSpreadsheet`):**
    *   This asynchronous function handles the generation and download of detailed Excel spreadsheets for analytics reports using `exceljs` and `file-saver`.
    *   It populates report metadata (Metric, Client, Dates) and dynamically adjusts headers based on `periodFilter` (month, week, quarter) and `chartType` (specifically for "StackedBar" and "transitBar").
    *   The function contains extensive conditional logic to populate data rows differently based on the `chartType` and specific `reportName`. For "StackedBar" reports, it accounts for various period filters (month, week, quarter) and report-specific data structures like "Cargo-Ready Date to ETD", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)", extracting relevant columns like "Less than 1 week", "This Quarter", "Less than 10 days", etc.
    *   It also appends summary rows (Average, Total, or N/A) based on the calculated `calType` and `calValue`.

**Patterns and Recurring Elements:**

*   **Conditional Logic based on Chart/Report Type:** A significant pattern is the frequent use of `item?.customizer?.chartType` and `item.reportName` to drive conditional logic, especially for data processing and Excel report generation. This indicates a highly configurable analytics system with tailored handling for different visual and data representations.
*   **Date and Period Filtering:** `moment.js` is consistently used for date formatting. `periodFilter` (month, week, quarter) is a recurring variable used to structure data and headers differently for time-series reports.
*   **Calculation Types:** The concept of `calType` (Avg, NA, Total) and `calValue` is used across both data preparation (`metricsPackageHandler`) and report export (`downloadReportSpreadsheet`) for consistent summary calculations.
*   **ExcelJS for Dynamic Reports:** The `downloadReportSpreadsheet` function exemplifies a robust use of `exceljs` to programmatically construct complex spreadsheets, adapting headers and data content based on various report parameters.

## 11:38:52 AM
The `t360-backend` project has undergone significant enhancements across its analytics and OTM integration modules.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 11/3/2025, 3:44:37 PM):**
    The `getTableDataReports` function has been substantially expanded to handle a much wider array of analytics report types. It now incorporates a more sophisticated `getUserObject` to retrieve user and company-specific data for query building. The controller uses dedicated query builders (`chassisQueryBuilder`, `bookingQueryBuilder`, `containerQueryBuilder`, `departureQueryBuilder`, `generalQueryBuilder`) to construct database queries based on the requested report `type`. Numerous new report types have been added, particularly focusing on 'booking & cargo-ready' metrics such as `BookingDatetoActualDeparture`, `CargoReadyDatetoEstDepartureDate`, `ContainerShippedMblWise`, and `TotalSpendPerMonth`, indicating a deep dive into logistics performance analysis. A `codeCustomization` flag was introduced, suggesting some reports might involve direct data processing logic instead of standard query execution.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts` (Timestamp: 11/3/2025, 5:05:37 PM):**
    New API endpoints have been added to support OTM (Oracle Transportation Management or similar) Bill of Lading (BOL) functionalities. These include routes for exporting Excel data (`/excel_data`), fetching payloads (`/fetch_payload`), fetching by common key (`/fetch/:common_key`), uploading and saving edits (`/upload_save_edit`), generating XML (`/generate_xml`), and sending data to OTM (`/send_to_otm`). An existing `"/upload"` route remains commented out, possibly for future use or an alternative upload method.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts` (Timestamp: 11/3/2025, 6:57:38 PM):**
    This utility file has been significantly augmented to support the extended analytics capabilities.
    *   `defaultDateRange`: A function was added to provide a default one-year date range for reports.
    *   `replaceValueInQuery`: A helper function was refined to handle specific column name replacements for 'pod' and 'place_of_delivery'.
    *   `getUserObject`: Introduced to build a user context object, fetching `usercode` based on `companyname` and `access` level.
    *   `getFilterQueryByDisplayValue`: A function was added to generate `groupBy`, `orderBy`, `dateTrunc`, and `select` clauses based on time granularities like month, week, or quarter.
    *   `getExcelSelectedColumns`: A crucial function was added to dynamically select relevant columns for Excel exports based on the specific `reportName` and whether it's a booking-related report, defining common, booking, and other columns. Specific logic for "Cargo-Ready Date to ETD (Stacked Bar /- 10 Days)" and "BL Release KPI" is present.
    *   `isValidDate`: A utility function to validate date strings, ensuring they are not invalid JavaScript dates, too old (pre-1973), or a specific '0000-01-01T00:00:00.000Z' value.
    *   `dateFilterOnExport`: A function to process data arrays, filtering out invalid dates from a comprehensive list of date-related keys and optionally formatting valid dates for display.
    *   `EXCEL_EXPORT_COLUMNS`: A large constant array was defined, mapping keys to user-friendly column names for comprehensive Excel export functionality, covering a wide range of logistics data points from file details to container and booking specifics.

**Patterns and Recurring Elements:**

The changes reveal a strong focus on enhancing the application's analytical reporting capabilities and integrating with external systems like OTM.

1.  **Analytics Deep Dive:** There's a clear pattern of expanding the variety and depth of analytics reports, moving from general metrics to highly specific logistics KPIs like "Chassis PU date Vs Final Delivery Date Mbl Wise" or "Booking Date to Est Departure Date Stacked Bar".
2.  **Date and Time Granularity:** Extensive work has been done on handling dates and time, including default ranges, specific date validation, and dynamic filtering/grouping by month, week, or quarter, indicating a robust approach to time-series data analysis.
3.  **Dynamic Query and Column Generation:** The introduction of query builders and functions like `getExcelSelectedColumns` and `getFilterQueryByDisplayValue` demonstrates a pattern of dynamically constructing database queries and selecting data columns based on user input and report type, making the reporting system flexible and scalable.
4.  **Data Export Focus:** The detailed `EXCEL_EXPORT_COLUMNS` and `dateFilterOnExport` functions highlight a significant effort to provide clean, comprehensive, and well-formatted data exports for users.
5.  **Modularity and Reusability:** The logic is being abstracted into dedicated utility functions (e.g., `analytics.ts`) and specific controller actions, promoting code reusability and maintaining a clear separation of concerns.
6.  **OTM Integration:** The new routes for BOL processing indicate an active development phase for interacting with an OTM system, likely for automating logistics processes and data exchange.

## 11:39:17 AM
The provided log details code changes across several frontend React components, primarily focusing on UI/UX adjustments and component integration. The timestamps indicate a period of active development and refinement on November 3, 2025.

**File-Specific Updates:**

*   **`src\components\common\chip-tabs-view.tsx`**: This file underwent extensive iterative styling changes and minor structural refactoring throughout the day, particularly between 2:50 PM and 3:18 PM, then again in shorter bursts from 3:26 PM to 3:28 PM, and finally around 6:00 PM.
    *   **Layout and Responsiveness**: The `max-w` (max-width) property of the main container was repeatedly adjusted, ranging from `520px` to `1200px`, eventually settling around `1150px` with a `ml-[-6px]` offset. This indicates fine-tuning for different display sizes.
    *   **Button Styling**: Both the main option buttons and the "New" button chip saw numerous updates to their Tailwind CSS classes. This included changes to fixed `width` and `height` (e.g., `w-[180px] h-[40px]`, `min-w-[160px] h-[42px]`), border-radius (`rounded-full`, `rounded-lg`, `rounded-xl`, `rounded-md`), shadow effects (`shadow-[0_4px_6px...]`, `shadow-[0_1px_3px...]`), content alignment (`justify-between`, `justify-center`), background colors (`bg-blue-600`, `bg-gray-100`, `bg-white`, `var(--Background-backgroundHoverOverlay...)`), text colors, and hover states.
    *   **Icon Integration**: The `Option` interface was extended to support `icon` props, allowing icons to be displayed within the tab buttons. The placement and styling of these icons within the buttons were also refined (e.g., `ml-3`, `mr-2`, `ml-4`).
    *   **Scroll Button Icons**: The `ChevronLeft` and `ChevronRight` icons used for horizontal scrolling had their `fontSize` property gradually increased from `small` to `large` and their color classes adjusted (e.g., from `text-gray-600 hover:text-black` to `text-gray-500 hover:text-gray-700`).
    *   **Structural Reorder**: At 2:57:06 PM, the order of the optional button chip and the regular options map within the scrollable container was swapped.
    *   **Debugging**: `console.log` statements were added (6:03 PM - 6:04 PM) to inspect the component's `options` and `value` props.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**:
    *   **ChipsTabView Integration**: At 2:56:23 PM, the `ChipsTabView` component was integrated to manage dashboard views. This involved mapping dashboard items to `label`/`value` for the `ChipsTabView` and configuring a "New" button with an `AddCircleOutlineOutlined` icon.
    *   **Icon Imports**: There were several minor changes related to importing various icons (e.g., `MagnifyingGlassIcon`, `PlusIcon`, `PresentationChartLineIcon`, `ShowChart`, `HiPresentationChartLine`) from different UI libraries (`@heroicons/react`, `@mui/icons-material`, `react-icons/bs`, `react-icons/fa6`, `react-icons/md`, `react-icons/hi2`). Some icons were imported, then removed, and later re-imported from different variants or libraries (e.g., `PresentationChartLineIcon` from `@heroicons/react/16/solid` to `@heroicons/react/24/solid`).

*   **`src\components\screen\analytics\analyticsContainer.tsx`**: No significant code changes were logged within the provided snippets for this file. It maintains its functionality for drag-and-drop metric management, resizing, and fetching report data.

*   **`src\components\screen\analytics\MetricFooter.tsx`**: No code changes were logged within the provided snippets for this file. It remains responsible for PDF/Excel exports, displaying calculated values, and managing the enlarge state of metrics.

*   **`src\components\screen\analytics\Charts\GaugeChart.tsx`**: This file saw focused changes between 5:58 PM and 5:59 PM.
    *   **Color Scheme Adjustment**: The `fill` gradient `colors` and `gradientToColors` for the `GaugeChart` were modified. Specifically, the color for when `isValueBelowLimit` (value < 3) transitioned from various shades of green (`#008000`, `#32f63b`) to darker gray/black tones (`#09090B`, `#595959`).

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx`**: No significant code changes were logged within the provided snippets for this file. It continues to manage custom dashboard views (add/edit/delete), metric selection via tabs and checkboxes, and interaction with an analytics API. Debugging `console.log` statements were present for `viewTitle` and `viewOptions`.

**Patterns and Recurring Elements:**

*   **Iterative UI/UX Development**: The numerous, rapid changes in `chip-tabs-view.tsx` underscore a highly iterative process for refining the visual design and user experience of a single component. This includes frequent adjustments to dimensions, spacing, colors, and interactive states using Tailwind CSS classes.
*   **Component Reusability and Integration**: The `ChipsTabView` component, once refined, was integrated into `AnalyticsToolbar.tsx`, demonstrating a modular approach to frontend development.
*   **State Management**: Redux is consistently used across analytics-related components (`AnalyticsToolbar`, `analyticsContainer`) for managing application state.
*   **API Interaction**: RTK Query hooks are employed for efficient data fetching and mutation operations with the backend, evident in `analyticsContainer` and `ViewContainer`.
*   **PDF Generation**: Functionality for generating PDF reports using `jspdf` and `html2canvas-pro` is a recurring theme in `AnalyticsToolbar` and `MetricFooter`.
*   **Debugging**: The presence of `console.log` statements in various components suggests an active debugging phase during development.
*   **Icon Diversity**: The use of icons from multiple libraries indicates a preference for specific icon styles or availability, or perhaps a transition between different icon sets.

## 11:39:31 AM
The codebase underwent a series of focused updates on November 3, 2025, primarily affecting analytics reporting services and user management functionalities. Key themes include the refinement of SQL query generation, a push towards improved type safety with new interfaces, and consistent logging for debugging and operational insights.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analyticsExportService.ts`**:
    *   **Initial state (11:51:04 AM):** Defined `getExportData` to handle booking and non-booking reports, including date handling, user/company object retrieval, dynamic column selection, and a `replaceColumnHandler` to normalize port names (e.g., "LONG BEACH" to "LOS ANGELES"). It also included specific logic for MBL-wise TEU filtering.
    *   **Brief Regression/Debugging (11:52:28 AM - 11:52:44 AM):** Temporarily changed the database `query` import path from `@src/common/util/database` to `@src/common/db`, added `NextFunction` to express imports, and duplicated or re-introduced an older `AnalyticsControllerQuery` interface. Debugging `console.log` statements were added in the catch block.
    *   **Refinement/Correction (11:54:19 AM - 11:56:23 AM):** The database `query` import path was corrected back to `@src/common/util/database`. The `AnalyticsControllerQuery` interface was simplified by removing `companyname` and `access` fields (suggesting they are now accessed directly from `req.query`). The `ExportDataRow` interface was removed from this file. The `replaceColumnHandler` function's type signature was adjusted to use `any` for item properties. Extensive `console.log` statements were added for various request parameters, user codes, and generated SQL queries, indicating active debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**:
    *   **Consistent Structure (11:58:36 AM - 11:58:42 AM):** This file defines `getMonthValue` and `bookingQuery`, which generates dynamic SQL snippets for various booking-related analytics reports. It includes conditional logic for "Stacked Bar" reports based on `displayBy` (month, week, quarter) and `stackedGroup`. A filter `m.t49_vessel_actualdeparted_date IS NOT NULL` was added to "Booking Date to POD Arrival (Stacked Bar)".

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**:
    *   **Type Safety Evolution (12:00:20 PM - 1:29:32 PM):** The `bookingQueryBuilder` function was consistently present, generating complex SQL for various booking and cargo-ready reports. However, between **1:22:57 PM** and **1:29:32 PM**, significant improvements were made to its type definitions. New interfaces like `Customizer`, `QueryBuilderI`, `CalColumn`, and `CalColumnConfig` were introduced and progressively refined. This enhanced type safety and code clarity without changing the core query generation logic.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\tableService.ts`**:
    *   **Centralized Reporting (12:02:23 PM):** Introduced `getTableDataReports` as a central service to dispatch to various query builders (chassis, booking, container, departure, general) based on the `type` of report requested. This service handles default date ranges, retrieves user/company info, and logs the final SQL query before execution.
    *   **Debugging (12:08:25 PM):** Added `console.log(error)` in the catch block for error visibility.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\containerService.ts`**:
    *   **Query Building and Refactoring (12:11:01 PM - 12:16:36 PM):** The `getContainerReports` function dynamically builds SQL queries for container-related reports, grouping by different columns (e.g., country, trucker). It applies port name normalization using `replaceValueInQuery`.
    *   **Type Safety and Readability (12:13:38 PM):** Introduced `ContainerReportQuery`, `Customizer`, and `AnalyticsRow` interfaces for better type enforcement and organized the logic into clearer sections ("Case 1: Group by Country", "Case 2: Other columns").
    *   **Debugging (12:16:36 PM):** Added `console.log("===reqquery",req.query);` for immediate inspection of incoming request parameters.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\analyticsRoutes.ts`**:
    *   **Expanded Analytics Endpoints (12:21:34 PM):** Registered a comprehensive set of GET and POST endpoints for various analytics features, including core view management, metric lists, sequence/size saving, Excel exports, and specific reports for TEU, CBM, KGS, containers, and transit times. This shows a significant expansion of the analytics module.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**:
    *   **User Management (3:39:14 PM):** A substantial update or introduction of a service encompassing user `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. This service handles user authentication, JWT token creation, and database interactions for user profile and invitation management. It uses `ON CONFLICT DO UPDATE` for preferences and invites.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\index.ts`**:
    *   **Route Integration (3:39:25 PM):** The main application router was updated to include the newly defined `UserRoutes` and `AnalyticsRoutes`, signifying the integration of these features into the application's API.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**:
    *   **TEU Reporting (4:32:00 PM):** Introduced `getTEUReports` to calculate and report Twenty-foot Equivalent Units. It dynamically generates SQL queries for TEU based on grouping columns, including complex logic for extracting numeric container types and normalizing port names (e.g., handling "LONG BEACH" to "LOS ANGELES" within the query itself).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**:
    *   **Dashboard Configuration (4:32:31 PM - 4:49:23 PM):** This service was introduced to manage dashboard metrics. It provides `dashboardEndPointList` (fetches ordered metrics for a dashboard), `getMetricList` (categorizes available metrics and handles preloading selected ones), `saveSequence` (saves the order of metrics), and `saveSize` (saves column/row spans for metrics). This centralizes the backend logic for analytics dashboard customization. Debugging `console.log`s were added in catch blocks.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**:
    *   **Core Utilities (1:22:26 PM - 5:08:26 PM):** This utility file remained stable during the observed period, providing common functions such as `defaultDateRange`, `replaceValueInQuery` (for port name normalization in queries), `getUserObject` (for user/company data), `getFilterQueryByDisplayValue` (for date-based SQL filtering), `getExcelSelectedColumns` (dynamic column selection for exports), and `dateFilterOnExport` (date validation and formatting for exports). It also defines `EXCEL_EXPORT_COLUMNS`.

**Patterns and Recurring Elements:**

*   **Dynamic Query Generation:** A consistent pattern across multiple services (`analyticsExportService`, `booking.query`, `containerService`, `teuService`) is the dynamic construction of complex SQL queries based on various request parameters to support flexible analytics reporting.
*   **Port Name Normalization:** The replacement of "LONG BEACH" with "LOS ANGELES" is a recurring data cleansing step, appearing in `analyticsExportService`, `containerService`, and `teuService` either as a post-query handler or directly within the SQL query.
*   **Type Safety Enhancements:** There's a clear and continuous effort, particularly evident in `booking.query.ts` and `containerService.ts`, to introduce and refine TypeScript interfaces for function parameters and data structures. This significantly improves code maintainability and reduces potential bugs.
*   **Extensive Logging:** `logger.info` and `logger.error` are widely used for debugging, tracing execution flow, and error reporting across almost all modified files. `console.log` is also frequently used for immediate debugging during development.
*   **Default Date Range:** The `defaultDateRange` utility is consistently applied in reporting services when date parameters are missing.
*   **User Context Retrieval:** The `getUserObject` utility is repeatedly called to extract user-specific and company-specific information required for database queries.
*   **Database Interaction:** All services interact with a PostgreSQL database using a shared `query` utility, applying parameters to construct SQL queries.

## 12:38:50 PM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js` was updated on `11/3/2025, 3:47:35 PM`. This file primarily contains utility functions and logic for handling analytics data, chart configurations, and generating reports, specifically Excel spreadsheets.

**File-Specific Updates:**

*   **Imports:** The file imports various libraries and modules including `moment` for date handling, UI components from `@mui/icons-material`, enums for `AnalyticsChartType`, configuration constants like `ANALYTICS_REPORT_HEADER`, `ExcelJS` for Excel generation, `file-saver` for downloading files, and `ApiManager` for API interactions.
*   **`TruncateText`:** A utility function was introduced to shorten text strings and append an ellipsis.
*   **`metricsPackageHandler`:** This core function processes raw metric data, dynamically determining the chart type (`Count`, `StackedBar`, `Transit`, `General`), calculating aggregate values (Average, Total) based on customizer settings, and formatting data for presentation. It integrates report names, column/row spans, and applies specific header configurations.
*   **Chart Configuration:**
    *   `allChartOptions`: An array listing available chart types (bar, pie, line, stack, gauge) with their respective Material-UI icons.
    *   `chartOptionsByType`: An object mapping broader chart categories (e.g., `General`, `StackBar`) to the specific chart options they support.
*   **`reportFormula`:** A function for constructing mathematical formulas based on report names and selected date columns, with specific logic for "Scheduled vs Actual Transit Time".
*   **`weekDateFormater`:** A simple utility to format dates into "D MMM" using `moment`.
*   **`downloadReportSpreadsheet`:** An extensive asynchronous function responsible for generating and downloading Excel reports.
    *   It meticulously constructs the report array, including report metadata (Metric, Client, Dates) and headers.
    *   Headers are adjusted based on `periodFilter` (month, week, quarter) and `chartType`.
    *   Data population logic is highly conditional, differentiating based on `chartType` and specific `reportName`. For non-stacked bar charts, it includes average/total calculations.
    *   For `StackedBar` charts, it has distinct handling for reports like "Cargo-Ready Date to ETD", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)", "Average Transit Time per Month (Days)", and "Cargo-Ready Date to ETD (Stacked Bar +/- 10 Days)", mapping data fields according to the chosen period filter (month, week, quarter). The provided log ends mid-way through the conditional logic for `StackedBar` reports.

**Patterns and Recurring Elements:**

*   **Dynamic Customization:** A strong pattern of using a `customizer` object to drive the behavior and appearance of analytics reports and charts, including chart types, calculation methods, and date columns.
*   **Chart Type-Specific Logic:** Extensive use of conditional statements (`if/else if`) throughout the code to adapt data processing, formatting, and report generation based on the `chartType` (e.g., `StackedBar`, `Transit`, `Count`, `General`).
*   **Period Filtering:** The concept of `periodFilter` (month, week, quarter) is a recurring theme, particularly in `downloadReportSpreadsheet` where it dictates how data is grouped and presented in stacked bar charts.
*   **Excel Report Generation:** The `downloadReportSpreadsheet` function demonstrates a highly structured and repetitive approach to building Excel worksheets, populating cells based on various report types and data structures.
*   **Moment.js Integration:** `moment` is consistently used for date formatting and manipulation across different functions.
*   **Modular Design:** The file is composed of multiple exported functions, indicating a modular approach to organizing analytics-related functionalities.

## 12:39:02 PM
The recent code changes, primarily occurring on November 3rd and 4th, 2025, focus heavily on expanding and refining analytics and data handling capabilities within the `t360-backend` system, alongside updates to OTM (Oracle Transportation Management) Bill of Lading routes.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (11/3/2025, 3:44:37 PM):**
    This file, `others.controller.ts`, acts as a central dispatcher for various analytics reports. It was updated to handle a significantly expanded range of report types, including those related to chassis, booking, containers, departures, and general shipments. The controller dynamically selects the appropriate query builder (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`) based on the `type` parameter from the request. It also includes logic for setting default date ranges and retrieving user-specific context like company name and user ID, and logs the generated SQL queries for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts` (11/3/2025, 5:05:37 PM):**
    The OTM Bill of Lading routes file was updated to include a comprehensive set of API endpoints. New routes were added for fetching payload data (`/fetch_payload`), handling "upload save edit" operations (`/upload_save_edit`), fetching by a common key (`/fetch/:common_key`), generating XML (`/generate_xml`), and sending data to OTM (`/send_to_otm`). An existing file upload route (`/upload`) is commented out, suggesting a potential change or deprecation in favor of `upload_save_edit`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts` (11/3/2025, 6:57:38 PM):**
    This utility file for analytics received substantial additions. It now contains functions for:
    *   `defaultDateRange()`: To provide a standard 365-day range.
    *   `replaceValueInQuery()`: To dynamically modify column values (e.g., `pod`) in SQL queries.
    *   `getUserObject()`: To construct a user context, potentially adjusting `usercode` for ADMIN access.
    *   `getFilterQueryByDisplayValue()`: To generate SQL `GROUP BY`, `ORDER BY`, `DATE_TRUNC`, and `SELECT` clauses based on how data should be displayed (month, week, quarter).
    *   `getExcelSelectedColumns()`: A robust function to dynamically select columns for Excel exports based on the specific `reportName` and whether it's a booking report, including special handling for "Cargo-Ready Date to ETD" and "BL Release KPI" reports.
    *   `dateFilterOnExport()`: To validate and format date columns in data for export, converting them to `MM/DD/YYYY` using `moment.js` and handling invalid date values.
    *   A large `EXCEL_EXPORT_COLUMNS` array was defined, specifying keys and display names for a wide array of exportable data columns related to shipping and tracking.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (11/4/2025, 12:07:25 PM; 11/4/2025, 12:11:21 PM; 11/4/2025, 12:12:32 PM):**
    The `booking.query.ts` file, shown with three identical log entries within minutes, defines the `bookingQueryBuilder` function. This function is responsible for constructing highly specific SQL queries for various booking-related analytics reports. It processes different report `type` values (e.g., `BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`) and configures a `customizer` object with metadata like `dateRange`, `calType`, `dateColumns`, and `chartType`. The SQL queries involve complex joins, filtering by company name and date ranges, calculating day differences between booking and actual departure dates, and aggregating data for stacked bar charts into categories like "Less than 1 week", "1 - 2 weeks", etc.

### Patterns and Recurring Elements:

*   **Analytics Deep Dive:** A strong recurring theme is the in-depth development of analytics features. This includes a modular approach to query generation (controllers dispatch to specific query builders), comprehensive utility functions for data manipulation, and detailed report types covering various aspects of shipping and logistics.
*   **Dynamic Query Construction:** SQL queries are dynamically constructed based on user-defined parameters such as report type, date ranges, display aggregation (month, week, quarter), and company context. This allows for flexible and customizable reporting.
*   **Extensive Date Handling:** Date validation, formatting, and calculation (e.g., `EXTRACT(DAY FROM ... - ...)`, `DATE_TRUNC`) are prevalent across the analytics modules, indicating a critical need for precise temporal data analysis. Invalid dates (like '0001-01-01 00:00:00 BC') are explicitly handled in queries.
*   **MBL-wise and Stacked Bar Variations:** Many analytics reports support "MblWise" (Master Bill of Lading-wise) and "StackedBar" chart variations, suggesting requirements for both detailed and aggregated visualizations.
*   **Data Export Focus:** The `analytics.ts` utility file's detailed `EXCEL_EXPORT_COLUMNS` and `dateFilterOnExport` function highlight a significant effort to ensure data is correctly prepared and formatted for export purposes.
*   **Modular Architecture:** The use of separate query builder files (e.g., `booking.query.ts`) keeps the main controller (`others.controller.ts`) cleaner and promotes better organization and maintainability of complex SQL logic.
*   **Focused Development Period:** All changes occurred on two consecutive days, November 3rd and 4th, 2025, indicating a concentrated effort on these specific backend functionalities. The identical `booking.query.ts` entries suggest frequent saving during development or minor non-functional changes that were not captured as distinct.

## 12:39:17 PM
The provided log details code changes across several frontend components related to an analytics dashboard, primarily focusing on UI refinement and feature integration.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\common\chip-tabs-view.tsx`**
    *   **Initial Structure (11/3/2025, 2:50:09 PM):** Introduced `ChipsTabView` component for displaying scrollable "chip" buttons with optional "new" button. It used a `max-w-[520px]` container and basic Tailwind CSS for styling. Scrollbar hiding was implemented with inline styles.
    *   **Frequent Styling Iterations (11/3/2025, 2:53:12 PM - 3:18:40 PM):** This file saw extensive and rapid changes, often involving minor adjustments, reverts, and re-applications of Tailwind CSS classes.
        *   **Chip Sizing & Shape:** Sizes of individual option chips and the "new" button chip fluctuated (e.g., `px-4 py-1.5` vs. `px-4 py-2`, `rounded-full` vs. `rounded-lg` vs. `rounded-xl` vs. `rounded-md`), and later settled on `min-w-[160px] h-[42px] rounded-md` for consistency, but then saw further back-and-forth between `w-[180px] h-[40px] rounded-lg` and `min-w-[160px] h-[42px] rounded-md` for the options.
        *   **Shadows and Borders:** Introduction and modification of `shadow` classes (e.g., `shadow-[0_4px_6px_-1px_rgba(0,0,0,0.1)]` and `shadow-[0_1px_3px_rgba(0,0,0,0.1)]`) and border colors (`border-blue-600`, `border-gray-300`, `border-gray-400`).
        *   **Color States:** Refinements to active/inactive chip background and text colors, including `bg-blue-600`, `bg-gray-100`, `bg-white`, and `bg-[var(--Background-backgroundHoverOverlay,#00000006)]`.
        *   **Layout and Icons:** Changes in `gap` between chips (from `gap-2` to `gap-3`), reordering of the optional button chip and main options within the JSX, and modifications to how icons are displayed within buttons (wrapping in `span`s and applying specific text colors like `text-gray-500` or `text-gray-600`).
        *   **Container Width:** The `max-w` property of the main container was frequently adjusted, ranging from `520px` to `1200px`, `800px`, `900px`, `950px`, `1000px`, `1100px`, and finally to `1150px`, sometimes including a negative left margin (`ml-[-6px]`).
        *   **Scroll Button Icons:** `ChevronLeft` and `ChevronRight` icon sizes were progressively increased from `small` to `medium` and then `large`, and their color/hover states were adjusted (`text-gray-600 hover:text-black disabled:opacity-40` to `text-gray-500 hover:text-gray-700`).
    *   **Interface and Logging Updates (11/3/2025, 3:09:50 PM, 6:03:52 PM, 6:04:25 PM, 6:04:54 PM):** The `Option` interface was updated to include an optional `icon`. Multiple `console.log` statements were added and tweaked for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **Initial Setup (11/3/2025, 2:56:23 PM):** Implemented a toolbar for analytics, utilizing Redux for state management (dashboard selection, global filters) and various UI components like `ChipsTabView`, `SelectCustomerPanel`, and date range filters. A key feature is the `downloadDashboardPDF` function using `jspdf` and `html2canvas-pro` to export the dashboard, including a logo.
    *   **Import Adjustments (11/3/2025, 3:05:04 PM - 3:23:44 PM):** Minor changes in icon imports from `@heroicons/react` (e.g., `PlusIcon` added, then `MagnifyingGlassIcon, PlusIcon` removed, `PresentationChartLineIcon` changed size, and `HiPresentationChartLine` imported).
    *   **Repetitive Saves:** This file shows many timestamps with identical code, suggesting frequent saves during development without significant code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx`**
    *   **Core Analytics Logic (11/3/2025, 4:52:06 PM):** Established the main container for analytics, enabling drag-and-drop (`react-dnd`) for `ResizableGridItem`s (metrics). It integrates with Redux to manage metric data and views, and with an API to save metric sequences and sizes. Includes logic for fetching individual reports and handling data formatting.
    *   **Repetitive Save (11/3/2025, 4:53:29 PM):** One identical entry.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\MetricFooter.tsx`**
    *   **Metric Actions (11/3/2025, 5:16:09 PM):** Introduced a footer component for individual metrics, providing actions like enlarging the metric, exporting to Excel (with column selection via `ColumnsSelector` in a `ThemedModal`), and exporting to PDF. Displays calculation types and formulas.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\Charts\GaugeChart.tsx`**
    *   **Gauge Chart Implementation (11/3/2025, 5:58:14 PM):** Implemented a `GaugeChart` using `react-apexcharts`. It calculates a series value and conditionally applies fill colors based on whether the value is below a certain limit (e.g., green for good, orange for bad). Displays "Days" as a formatted value.
    *   **Color Theme Adjustments (11/3/2025, 5:58:58 PM - 5:59:43 PM):** The conditional fill colors were changed from `#008000` (green) to various shades of dark gray (`#09090B`, `#595959`), suggesting a shift in design preference for the "good" state color. The gradient color was also adjusted.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`**
    *   **Custom View Management (11/3/2025, 6:05:49 PM):** Created a `ViewContainer` for adding, editing, and deleting custom dashboard views. It features tabbed navigation (`RadioNav`) for different view types (Container Wise, MBL Wise), a `TreeViewContainer` for metric selection, and interaction with the analytics API to persist view configurations. Includes audit functionality via `AuditViewDrawer`.

### Timestamps of Significant Changes:

*   **11/3/2025, 2:53:12 PM:** First major styling overhaul for `chip-tabs-view.tsx` (gap, flex, padding, hover states).
*   **11/3/2025, 2:54:13 PM:** `chip-tabs-view.tsx` introduces fixed dimensions and shadow for the "new" button.
*   **11/3/2025, 2:55:02 PM:** `chip-tabs-view.tsx` applies fixed dimensions and shadow to main option chips, aiming for visual consistency.
*   **11/3/2025, 2:58:24 PM:** `chip-tabs-view.tsx` undergoes a significant refactor for chip styling, introducing consistent `w`, `h`, `rounded-lg`, and shadow, and changes in active/inactive colors. Also, `max-w` increases.
*   **11/3/2025, 3:09:50 PM:** `chip-tabs-view.tsx` has a broad styling and structural refactor, including `rounded-xl`, different shadows, and explicit icon support for options.
*   **11/3/2025, 3:12:19 PM:** `chip-tabs-view.tsx` introduces dynamic CSS variables (`var(--Background-backgroundHoverOverlay,#00000006)`) for background, indicating a more advanced theming approach.
*   **11/3/2025, 3:13:36 PM:** `chip-tabs-view.tsx` finalizes large icons for scroll controls.
*   **11/3/2025, 3:16:11 PM - 3:17:57 PM:** `chip-tabs-view.tsx` shows further iterative styling for option chips, focusing on subtle shadow and border adjustments, and color refinement.
*   **11/3/2025, 3:23:44 PM:** `AnalyticsToolbar.tsx` imports `HiPresentationChartLine`, suggesting a potential future icon integration.
*   **11/3/2025, 4:52:06 PM:** `analyticsContainer.tsx` is introduced, demonstrating core interactivity for the dashboard (drag-and-drop, resize, API integration).
*   **11/3/2025, 5:16:09 PM:** `MetricFooter.tsx` is added, providing specific actions for individual metrics.
*   **11/3/2025, 5:58:58 PM - 5:59:43 PM:** `GaugeChart.tsx` changes the color scheme for the gauge chart, notably altering the 'good' value's visual representation.
*   **11/3/2025, 6:05:49 PM:** `ViewContainer.tsx` is implemented, enabling user-defined dashboard views with metric selection and persistence.

### Patterns and Recurring Elements:

*   **UI Component Iteration:** There's a strong pattern of rapid, iterative changes to UI components, especially `chip-tabs-view.tsx`. This suggests a focus on perfecting the visual design and user experience of these elements.
*   **Redux for State Management:** All major analytics-related components (`AnalyticsToolbar`, `AnalyticsContainer`, `ViewContainer`) consistently use Redux (`useDispatch`, `useSelector`) for managing global and component-specific states.
*   **API Integration with RTK Query:** The use of `useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`, `useFetchDashboardOptionsQuery`, and `useSaveDasboardMutation` from an `analytics-api` indicates a consistent approach to data fetching and modification using RTK Query.
*   **PDF Export Functionality:** Both the global `AnalyticsToolbar` and individual `MetricFooter` components implement PDF export features using `jspdf` and `html2canvas-pro`, showing a recurring need for report generation.
*   **Console Logging for Debugging:** Frequent additions and modifications of `console.log` statements across multiple files highlight an active debugging process during development.
*   **Tailwind CSS:** The consistent use of utility classes like `flex`, `items-center`, `justify-between`, `w-`, `h-`, `px-`, `py-`, `rounded-`, `border`, `text-`, `bg-`, `shadow-`, `transition`, `hover:`, `max-w-`, `mx-auto`, `ml-` points to Tailwind CSS as the primary styling framework.
*   **Icon Library Usage:** Multiple icon libraries are used, including `@mui/icons-material`, `@heroicons/react`, and `react-icons/bs`, `react-icons/fa6`, `react-icons/md`, `react-icons/ri`, `react-icons/hi2`, indicating a broad range of visual assets.
*   **Metric Management:** `analyticsContainer.tsx` and `ViewContainer.tsx` demonstrate a core functionality around managing individual metrics (ordering, resizing, selecting for custom views) within a dashboard.

## 12:39:29 PM
The code changes primarily focus on enhancing the analytics and reporting features of a backend application, all occurring on November 3, 2025, indicating a concentrated development effort.

**File-Specific Updates:**

*   **`src\services\analyticsExportService.ts`**: This file underwent significant churn. Initially, it implemented `getExportData` for generating booking and non-booking reports with date filtering, column value replacement (Long Beach to Los Angeles), and MBL-wise TEU filtering. Shortly after, a series of commits (11:52:28 AM, 11:52:44 AM) introduced issues like duplicated imports, interface definitions, and a typo, suggesting an incomplete merge or problematic save. This was followed by a major cleanup and refactoring (11:54:19 AM, 11:56:23 AM) that resolved these duplications, streamlined imports, adjusted parameter extraction, and added/removed debugging `console.log` statements.
*   **`src\common\util\export.query.ts`**: At 11:58:36 AM, the `bookingQuery` function was introduced. It centralizes the generation of complex SQL query strings for various booking reports, including logic for stacked bar charts and dynamic date-based filtering (month, week, quarter), which appear to be key analytical views.
*   **`src\common\util\booking.query.ts`**: Starting at 12:00:20 PM, the `bookingQueryBuilder` was implemented to dynamically construct SQL queries for booking and cargo-ready reports. Subsequent updates (1:22:57 PM, 1:23:26 PM, 1:26:32 PM, 1:29:32 PM) progressively enhanced type safety by introducing detailed TypeScript interfaces (`Customizer`, `CalColumn`, `CalColumnConfig`, `QueryBuilderI`) to better define the structure and expected parameters for query building.
*   **`src\services\tableService.ts`**: The `getTableDataReports` function was added at 12:02:23 PM. It acts as a central handler for various table-based analytics, delegating query generation to specialized builder functions (chassis, booking, container, departure, general). A debugging `console.log(error)` was added at 12:08:25 PM.
*   **`src\services\containerService.ts`**: The `getContainerReports` service was introduced at 12:11:01 PM to provide reports grouped by container attributes (e.g., country of origin/discharge, trucker). A substantial refactoring (12:13:38 PM) followed, improving type safety with new interfaces (`ContainerReportQuery`, `Customizer`, `AnalyticsRow`) and structuring the code with comments. A debugging `console.log("===reqquery",req.query);` was added at 12:16:36 PM.
*   **`src\routes\analyticsRoutes.ts`**: At 12:21:34 PM, new API endpoints were added to handle TEU, CBM, KGS, Container, Transit, and Table Data reports, reflecting the expansion of analytics capabilities.
*   **`src\services\UserService.ts`**: At 3:39:14 PM, new user management features were added, including `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, and `fetchAllCompanyUser`, demonstrating a broader update beyond just analytics.
*   **`src\routes\index.ts`**: The main application router was updated at 3:39:25 PM to include the new `UserRoutes`.
*   **`src\services\analytics\teuService.ts`**: The `getTEUReports` service was added at 4:32:00 PM. It calculates TEU data, including complex SQL for volume extraction from container types and percentage distribution, with specific handling for geographical data and dynamic column mapping. It also includes commented-out alternative query structures.
*   **`src\services\analytics\coreMetricService.ts`**: At 4:32:31 PM, core services for dashboard management were introduced. These include `dashboardEndPointList` for fetching and sorting metrics, `getMetricList` for categorizing and preloading metrics, `saveSequence` for updating dashboard layout order, and `saveSize` for adjusting metric widget dimensions. Type interfaces were also added to this file, and a debugging `console.log` was added at 4:49:23 PM.
*   **`src\utils\analytics.ts`**: This utility file remained stable across the observed timestamps (1:22:26 PM - 5:08:26 PM). It provides essential functions for analytics, such as generating default date ranges, replacing values in query strings (e.g., "LONG BEACH" to "LOS ANGELES"), retrieving user and company objects (with admin access logic), generating dynamic SQL filter clauses, selecting columns for Excel exports, and robustly filtering and formatting dates in data.

**Patterns and Recurring Elements:**

*   **Analytics Expansion**: The dominant theme is the extensive development and refinement of analytics and reporting features across multiple services.
*   **Dynamic SQL Generation**: A consistent pattern involves generating complex PostgreSQL queries dynamically based on user inputs and report types. These queries frequently utilize `DISTINCT ON`, `EXTRACT`, `CASE WHEN`, and specific date range filtering.
*   **Type Safety**: There's a clear trend of progressively introducing and refining TypeScript interfaces (e.g., `Customizer`, `QueryBuilderI`) to improve type safety, code readability, and maintainability, particularly noticeable in query builder and report service files.
*   **Data Transformation**: Repeated logic to transform data, such as mapping "LONG BEACH" to "LOS ANGELES" and handling invalid date values, is present across several services and encapsulated in utility functions.
*   **User Context**: The `getUserObject` utility is widely used to incorporate user and company-specific filtering, including special handling for admin users.
*   **Debugging Practices**: Extensive use of `logger.info` and `logger.error` for structured logging is common, often supplemented by `console.log` statements for ad-hoc debugging of request parameters and generated SQL queries during development.

## 1:39:01 PM
The changes log details updates across the frontend of a T360 application, primarily focusing on analytics features and API key management.

In **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`** (Timestamp: 11/3/2025, 3:47:35 PM), a comprehensive set of utility functions and constants for analytics reporting was introduced or updated. Key additions include `TruncateText` for display, `metricsPackageHandler` for processing raw metric data into a structured format suitable for charts (determining chart type, calculating total/average, applying formatting), and `reportFormula` for generating formula strings based on date columns. The file also defines `allChartOptions` and `chartOptionsByType` to manage different visualization types. A significant part of the update is the `downloadReportSpreadsheet` asynchronous function, which handles the complex logic for exporting various analytics reports to Excel using `ExcelJS`. This function dynamically structures the spreadsheet based on report name, chart type (especially for `StackedBar` reports like "Cargo-Ready Date to ETD", "Containers Shipped", "Total Spend per Month", "Average Transit Time per Month"), period filters (month, week, quarter), and calculation types (Average, Total).

For **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\settings\apikeys\ApikeyForm.jsx`**, two entries are present. The initial version (Timestamp: 11/4/2025, 1:13:07 PM) introduces an `ApikeyForm` React component responsible for creating and updating API keys. It utilizes `formik` for form management, integrates Redux Toolkit Query for `createApiKey` and `updateApiKey` mutations, and uses `ApiManager` to fetch company options for an autocomplete field. The form allows input for Key Name, Company Name, and Expiry Date. In 'edit' mode, a 'Status' select box is also available. A special display is rendered upon successful creation to show the `newApiKey` with a warning to copy it immediately. The subsequent change to the same file (Timestamp: 11/4/2025, 1:13:48 PM) is a minor cosmetic update, correcting the label for the company autocomplete field from "Company Name1" to "Company Name".

Similarly, **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\SelectCustomerPanel.jsx`** also has two entries. The first entry (Timestamp: 11/4/2025, 1:15:50 PM) introduces a `SelectCustomerPanel` component. This component provides a UI element that, when clicked, opens a `Popover` to allow users to search and select a customer. It features debounced search functionality against the `ApiManager`'s paginated company options, displays results in a list, and includes pagination for large datasets. The selected customer is dispatched to the Redux store. The text initially displayed in the panel is "Select Customer1" if no `initialValue` is provided. The second change (Timestamp: 11/4/2025, 1:16:03 PM) corrects this display text from "Select Customer1" to "Select Customer".

**Patterns and Recurring Elements:**
*   **Timestamps indicate rapid development:** All changes occurred on November 3rd and 4th, 2025, with multiple minor updates on the same day, suggesting active development and quick refinement cycles.
*   **Focus on UI/UX Refinement:** Minor textual corrections in `ApikeyForm.jsx` and `SelectCustomerPanel.jsx` (removing "1" from labels) highlight an attention to detail in user interface text.
*   **Centralized API Management:** The `ApiManager` service is consistently used across different features (`ApikeyForm` and `SelectCustomerPanel`) for data fetching and interactions.
*   **Robust State and Form Management:** `useState`, Redux `useDispatch`, and `formik` are standard practices for managing component state and form data.
*   **Comprehensive Analytics Features:** The `methods.js` file demonstrates a sophisticated analytics module capable of handling various chart types, calculations, and detailed Excel exports, indicating a feature-rich reporting capability.

## 1:39:02 PM
**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts` (Timestamp: 11/3/2025, 3:44:37 PM):** This file, part of the analytics controller, implements the `getTableDataReports` function. It acts as a central dispatcher for various analytics report types (chassis, booking, container, departure, general). It dynamically selects and executes specific query builders (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`) based on the requested `type`. It handles initial date range setup, user object retrieval, and logs the generated SQL query before execution.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts` (Timestamp: 11/3/2025, 5:05:37 PM):** This file defines the API routes for OTM (Oracle Transportation Management) Bill of Lading (BOL) operations. It exposes endpoints for functions such as exporting excel data, fetching PLPO (Packing List / Purchase Order) by BOL, retrieving payload information, fetching by specific BOL numbers or common keys, editing BOLs, handling excel uploads (with a commented-out middleware section), generating XML, and sending data to OTM.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts` (Timestamp: 11/3/2025, 6:57:38 PM):** This utility file provides a suite of functions to support the analytics system. Key additions include `defaultDateRange` for standard date filtering, `replaceValueInQuery` for dynamic SQL column value replacement (specifically for `pod` or `place_of_delivery`), `getUserObject` for handling user and company context, and `getFilterQueryByDisplayValue` for generating SQL `GROUP BY`, `ORDER BY`, `DATE_TRUNC`, and `SELECT` clauses based on time display preferences (month, week, quarter). It also contains `getExcelSelectedColumns` to customize columns for report exports based on report name and type, `dateFilterOnExport` for standardizing date formats and handling invalid dates in exported data, and a detailed `EXCEL_EXPORT_COLUMNS` array defining the structure for Excel exports.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Timestamps: 11/4/2025, 12:07:25 PM; 11/4/2025, 12:11:21 PM; 11/4/2025, 12:12:32 PM):** This file defines the `bookingQueryBuilder` function, which is responsible for constructing complex SQL queries related to booking analytics. It handles multiple report types like 'BookingDatetoActualDeparture' and its MBL-wise and stacked bar variants. The queries involve calculating average day differences between booking and actual departure dates, joining tracking and booking data, and categorizing results into time ranges (e.g., 'Less than 1 week', '1 - 2 weeks') for stacked bar charts. The content across these three timestamps is identical, suggesting minor re-saves without functional code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts` (Timestamps: 11/4/2025, 1:18:10 PM - 11/4/2025, 1:34:30 PM):** This controller manages fetching company details via the `getAll` function. It distinguishes between 'AGENT' and 'CUSTOMER' roles, retrieving distinct company names (`cname`) for agents and distinct `account_name` for customers. For 'CUSTOMER' roles, it now supports pagination (`LIMIT`, `OFFSET`) and case-insensitive search (`ILIKE`). Between 1:19:18 PM and 1:21:09 PM, the count query for 'CUSTOMER' was updated from `LIKE` to `ILIKE` for consistency. The version at 1:33:19 PM adds `ORDER BY account_name` for sorted results and explicitly trims search input. Several timestamps show the addition and removal of `console.log` statements for debugging `totalResult` and `countQuery`, indicating an iterative refinement process for the pagination and search logic.

**Timestamps of Significant Changes:**

*   **11/3/2025, 3:44:37 PM:** Introduction of the analytics report dispatcher (`others.controller.ts`).
*   **11/3/2025, 5:05:37 PM:** Definition of OTM BOL related API routes (`otm_bol.route.ts`).
*   **11/3/2025, 6:57:38 PM:** Comprehensive update to analytics utility functions, including date range, query value replacement, user object handling, flexible display filtering, and advanced Excel export column selection/date formatting.
*   **11/4/2025, 12:07:25 PM:** Initial significant update to the booking analytics query builder, with subsequent saves at 12:11:21 PM and 12:12:32 PM showing no functional changes.
*   **11/4/2025, 1:33:19 PM:** Refinement of company details retrieval for 'CUSTOMER' role in `company_details.controller.ts`, adding sorting and explicit search term trimming, following a series of minor changes and debugging efforts throughout the hour.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Query Generation:** A prominent pattern across the analytics controllers and query builders is the dynamic construction of SQL queries based on user-provided parameters (e.g., report type, date ranges, display preferences).
*   **Date-Centric Logic:** Extensive date manipulation, formatting, and filtering are crucial, especially within the analytics utilities and query builders, including calculating time differences, handling invalid date values, and truncating dates for aggregation.
*   **Role-Based Access/Data Retrieval:** The `company_details.controller.ts` demonstrates retrieving different data sets and applying different logic based on user roles ('AGENT' vs. 'CUSTOMER').
*   **Pagination and Search Implementation:** Iterative development in `company_details.controller.ts` shows a clear focus on implementing robust pagination and case-insensitive search functionalities for data retrieval.
*   **Modular Architecture:** The analytics features are organized into a controller, utility functions, and dedicated query builders, indicating a modular design approach.
*   **Iterative Refinement and Debugging:** The numerous timestamps for `company_details.controller.ts` and the identical saves for `booking.query.ts` suggest an active development process involving frequent saves, minor adjustments, and debugging (indicated by temporary `console.log` statements).

## 1:39:50 PM
The provided logs indicate focused development activities within the frontend of a T360-V2 application, specifically concerning analytics and common UI components. All recorded changes occurred on **November 3, 2025**, spanning from **2:50:09 PM to 6:05:49 PM**.

### File-Specific Updates:

*   **`src\components\common\chip-tabs-view.tsx`**: This file underwent extensive and frequent styling adjustments throughout the logged period.
    *   **Initial Setup & Iterative Styling (2:50 PM - 3:08 PM)**: The component started as a horizontally scrollable chip tab view with left/right Chevron buttons and an optional "New" button. Early changes involved rapid iterations on Tailwind CSS classes, modifying `gap` spacing, chip padding (`px`, `py`), border radius (`rounded-full` vs `rounded-lg`), text size, font weight, hover effects (`hover:bg-gray-100` to `hover:bg-gray-50`), and the active tab's background/text color (initially `bg-blue-600` for active, then shifting to various `gray` shades). Dimensions (`w`, `h`) were added to buttons and later to individual option chips, along with shadows. The `max-w` property of the main container was frequently changed (from `520px` to `1200px` and back to `800px`, then to `900px`). The order of rendering the "New" button and the dynamic options also swapped.
    *   **Refined Styling & Functionality (3:08 PM - 3:18 PM)**: The `Option` interface was updated to include an `icon?: React.ReactNode;` property, allowing icons within regular option chips. Further styling changes refined the button and chip appearances, standardizing them to `min-w-[160px] h-[42px] rounded-md` with `shadow-[0_1px_3px_rgba(0,0,0,0.1)]` or `shadow-[0_4px_6px...]`. Scroll button colors were softened (`text-gray-500 hover:text-gray-700`), and their `fontSize` was increased to `large`. Max width adjustments continued, eventually settling around `max-w-[1100px]`.
    *   **Layout and Debugging (3:27 PM - 6:04 PM)**: Minor pixel-level adjustments were made to the horizontal positioning of the main container (`ml-[-4px]` then `ml-[-6px]`). Debugging `console.log` statements for `options` and `value` were added and slightly modified towards the end of the log.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**: This file primarily handles the analytics dashboard's toolbar functionalities, including view management and PDF export.
    *   **Initial Setup & PDF Export Logic (2:56 PM)**: The file uses Redux for state management, imports numerous UI components and icons (MUI, React-Icons, Heroicons), and implements a `downloadDashboardPDF` function using `jsPDF` and `html2canvas-pro` to export the dashboard. It also includes commented-out alternative implementations of the PDF function.
    *   **Icon Imports & Minor Saves (3:05 PM - 5:11 PM)**: A series of minor changes involved adding or adjusting imports for specific icons (`PlusIcon`, `ShowChart`, `PresentationChartLineIcon` from different Heroicon versions, `HiPresentationChartLine`). Many entries show no functional code changes, suggesting frequent saves or minor formatting adjustments.

*   **`src\components\screen\analytics\analyticsContainer.tsx`**: This component manages the layout and interactions within the analytics dashboard.
    *   **Initial Setup & Drag-and-Drop (4:52 PM)**: The component uses `react-dnd` for drag-and-drop metric reordering (`moveItem`). It also supports resizing grid items (`saveSize`) and changing metric views (`saveView`). Data fetching for individual reports (`fetchSingleReport`) is implemented, using `moment.js` for date formatting and Redux for state updates.
    *   **Minor Save (4:53 PM)**: A single subsequent entry shows no visible code change.

*   **`src\components\screen\analytics\MetricFooter.tsx`**: This component provides actions for individual metric boxes within the dashboard.
    *   **Initial Setup & Export Functionality (5:16 PM)**: Implements "enlarge" functionality, "export to Excel" (with a column selector modal), and "export to PDF" for individual metrics. The PDF export reuses `jsPDF` and `html2canvas` by dynamically rendering a `PdfRenderer` component into a hidden container. It also displays calculated metric values with badges and tooltip for formulas.

*   **`src\components\screen\analytics\Charts\GaugeChart.tsx`**: This file defines a specific chart component.
    *   **Initial Setup & Color Adjustments (5:58 PM - 5:59 PM)**: Implements a radial bar chart using `react-apexcharts` to display "Average Days". It dynamically sets the chart's fill color based on whether a `value` is below a threshold (`value < 3`). Initially, this was green/orange, then changed to various shades of gray/dark gray, including gradient adjustments.

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx`**: This component manages custom dashboard views.
    *   **Initial Setup & Dashboard Management (6:05 PM)**: Provides functionality for creating, editing, deleting, and auditing custom dashboard views. Users can select metrics from "Container Wise" or "MBL Wise" categories, with a limit of 9 metrics. Redux and RTK Query are used for data management and persistence. Includes input for view name, radio navigation for tab selection, and a popup alert for confirmations.

### Patterns and Recurring Elements:

*   **Frontend Technologies:** Consistent use of React (functional components, `useRef`, `useState`, `useEffect`), Redux (`useDispatch`, `useSelector`), and RTK Query for state and data management.
*   **Styling:** Heavy reliance on Tailwind CSS for utility-first styling across UI components, particularly evident in `chip-tabs-view.tsx` with its numerous class updates.
*   **Iconography:** Icons are sourced from both `@mui/icons-material` (e.g., `ChevronLeft`, `SettingsOutlined`) and `react-icons` (e.g., `FaFileExcel`, `MdPictureAsPdf`, `HiPresentationChartLine`), and `@heroicons/react`.
*   **PDF Generation:** `jsPDF` and `html2canvas-pro` are a recurring pattern for generating PDF exports, seen in both the `AnalyticsToolbar` (global dashboard) and `MetricFooter` (individual metric) components.
*   **User Feedback:** `react-hot-toast` is used to provide consistent success/error messages to the user.
*   **Modular Component Design:** The codebase uses many custom-named components (`AppAutocomplete`, `SelectBox`, `SwitchTab`, `ChipsTabView`, `AppDrawer`, `PopoverPanel`, `ThemedModal`, `IconButton`, `Button`, `InputBox`, `RadioNav`, etc.), indicating a modular approach to UI development.
*   **Rapid Iteration on UI:** The `chip-tabs-view.tsx` file saw a very high frequency of commits with small, incremental changes to styling, suggesting active UI/UX refinement.
*   **Debugging:** `console.log` statements are temporarily added for debugging state and props in `chip-tabs-view.tsx`, `AnalyticsToolbar.tsx`, and `ViewContainer.tsx`.

## 2:38:58 PM
**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\methods.js`**
*   **Timestamp:** 11/3/2025, 3:47:35 PM
*   **Updates:** This file, a core part of the analytics module, was significantly updated. It introduces utility functions for data processing and export.
    *   `TruncateText` provides text shortening functionality.
    *   `metricsPackageHandler` transforms raw metric data into a structured format for charts, including dynamic determination of chart types (`Count`, `StackedBar`, `Transit`, `General`) and calculation of aggregate values (total, average) based on customizer settings.
    *   `allChartOptions` and `chartOptionsByType` define available chart types and map them to specific display options (e.g., 'bar', 'pie', 'line', 'stack', 'gauge').
    *   `reportFormula` generates dynamic formulas based on report names and selected date columns, especially for transit time calculations.
    *   `weekDateFormater` formats dates into a "D MMM" string.
    *   A comprehensive `downloadReportSpreadsheet` function was implemented to export analytics data to an Excel spreadsheet. This function dynamically builds the report header and populates data based on the selected report, chart type (e.g., "Cargo-Ready Date to ETD (Stacked Bar)", "Containers Shipped (Mbl Wise)", "Total Spend per Month ($)"), and period filters (month, week, quarter), including calculation rows for averages or totals. The provided log entry for this file appears to be truncated.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\settings\apikeys\ApikeyForm.jsx`**
*   **Timestamp:** 11/4/2025, 1:13:07 PM
*   **Updates:** This React component facilitates the creation and updating of API keys. It utilizes `formik` for form management and RTK Query hooks (`useCreateApiKeyMutation`, `useUpdateApiKeyMutation`) for API interactions. Users can input a key name, select a company (via an autocomplete that fetches options from `ApiManager`), and set an expiration date. For existing keys, the status can be changed. After creating a new API key, the component displays the generated key with a copy-to-clipboard option and warns the user that the key will not be shown again.
*   **Timestamp:** 11/4/2025, 1:13:48 PM
*   **Updates:** A very quick subsequent change to the same file involved a minor UI correction: the label for the company selection autocomplete was changed from "Company Name1" to "Company Name".

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\analytics\SelectCustomerPanel.jsx`**
*   **Timestamp:** 11/4/2025, 1:15:50 PM
*   **Updates:** This component provides a searchable and paginated customer selection interface for the analytics dashboard. It uses a `Popover` to display a list of customers fetched from `ApiManager.getPaginatedCompanyOptions` with debouncing for search queries. Selected customers are dispatched to the Redux store (`setCustomer`). The initial placeholder text for the selection was "Select Customer1".
*   **Timestamp:** 11/4/2025, 1:16:03 PM
*   **Updates:** Similar to the `ApikeyForm.jsx` update, a rapid correction was made. The default placeholder text within the `SelectCustomerPanel` was changed from "Select Customer1" to "Select Customer" for improved clarity.

**Patterns and Recurring Elements:**
*   **Rapid UI Refinements:** There were immediate, minor label corrections within minutes for both `ApikeyForm.jsx` and `SelectCustomerPanel.jsx` on 11/4/2025, suggesting active development and quick iteration on user interface text.
*   **Analytics Focus:** A significant portion of the changes (in `methods.js`) indicates robust development around analytics, including complex data processing, chart configuration, and export functionalities.
*   **API and State Management Integration:** Both `ApikeyForm.jsx` and `SelectCustomerPanel.jsx` demonstrate a consistent pattern of interacting with `ApiManager` for data fetching and utilizing Redux (either directly via `useDispatch` or through RTK Query hooks) for state management.
*   **Modular Component Design:** The use of common UI components like `InputBox`, `AppAutocomplete`, `AppDatePicker`, and `SelectBox` across different features points to a modular and reusable component library.
*   **Date Handling:** The presence of `moment` for date formatting in analytics and `AppDatePicker` in form submissions highlights a recurring need for date manipulation and display.

## 2:39:05 PM
The code changes primarily focus on enhancing analytics capabilities, refining API routes for OTM (Oracle Transportation Management) Bill of Lading, and improving company details fetching with pagination and search. The changes span from November 3rd to November 4th, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`** (Timestamp: 11/3/2025, 3:44:37 PM)
    This controller was significantly expanded to handle a wider array of analytics reports. It now dynamically dispatches requests to specialized query builders (chassis, booking, container, departure, general) based on the `type` parameter. Key updates include:
    *   Initialization of `customizer` object for query configuration.
    *   Integration of a `getUserObject` utility to fetch user-specific company details, supporting admin access roles.
    *   A vastly extended `if-else if` block to categorize and route over 50 different report `type` values, especially for booking and cargo-ready related metrics, to `bookingQueryBuilder`.
    *   Introduction of a `codeCustomization` flag to handle `generalQueryBuilder` responses directly, bypassing the generic `query` execution.
    *   Added console logging for executed SQL queries during development/debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`** (Timestamp: 11/3/2025, 5:05:37 PM)
    The OTM Bill of Lading routing was updated to include several new endpoints:
    *   Added `POST /upload_save_edit` for saving edited uploads.
    *   Introduced `GET /fetch/:common_key` to retrieve data by a common key.
    *   New `POST /generate_xml` and `POST /send_to_otm` endpoints for XML generation and sending data to OTM, respectively.
    *   The previous `/upload` route, which used `uploadMiddleware`, was commented out.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`** (Timestamp: 11/3/2025, 6:57:38 PM)
    This utility file for analytics received substantial additions and refinements:
    *   `defaultDateRange`: A function to provide a default date range of the last 365 days up to the current date.
    *   `replaceValueInQuery`: A utility to dynamically replace values in a query, specifically for `pod` or `place_of_delivery` columns.
    *   `getUserObject`: Enhanced to retrieve `usercode` for 'ADMIN' roles from `mtr_user_master` based on `companyname`.
    *   `getFilterQueryByDisplayValue`: A new function to generate SQL `GROUP BY`, `ORDER BY`, `DATE_TRUNC`, and `SELECT` clauses based on `displayBy` (e.g., 'month', 'week', 'quarter').
    *   `getExcelSelectedColumns`: Logic to dynamically select columns for Excel exports based on the `reportName` and whether it's a booking report, including specific handling for "Cargo-Ready Date to ETD" and "BL Release KPI".
    *   `dateFilterOnExport`: A function to filter and format date fields in data items for export, handling invalid date values by setting them to `null` and formatting valid dates to `MM/DD/YYYY` using `moment.js`.
    *   `EXCEL_EXPORT_COLUMNS`: A comprehensive array defining the key and display name for a wide range of columns relevant for Excel exports.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts`** (Timestamps: 11/4/2025, 12:07:25 PM, 12:11:21 PM, 12:12:32 PM)
    This file, which appears identical across these three timestamps, provides the SQL query building logic for booking-related analytics:
    *   The `bookingQueryBuilder` function generates specific SQL queries based on the `type` parameter (e.g., 'BookingDatetoActualDeparture', 'BookingDatetoActualDepartureMblWise', 'BookingDatetoActualDepartureStackedBar').
    *   Queries involve calculating average day differences between booking dates and actual departure dates, either per container (`fileno || ',' || contno`) or MBL-wise (`fileno || ',' || mblno`).
    *   Includes logic for stacked bar charts, categorizing day differences into 'Less than 1 week', '1 - 2 weeks', etc., and using `getFilterQueryByDisplayValue` for dynamic grouping.
    *   All queries join `mtr_tracking_data` and `agent_booking_entry` tables, filter by `account_name` and `departure_date` range, and handle `NULL` or invalid date values.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\company_details.controller.ts`** (Timestamps: 11/4/2025, 1:18:10 PM to 2:27:52 PM)
    This controller handles fetching company details for either 'AGENT' or 'CUSTOMER' roles, with significant iteration on search and pagination:
    *   **Initial (1:18:10 PM):** Introduced logic to fetch company names (`cname`) for 'AGENT' from `agent_po_account_master` and `account_name` for 'CUSTOMER' from `mtr_tracking_data`, with initial support for pagination and `ILIKE` search.
    *   **Minor Adjustments (1:19:18 PM, 1:21:09 PM):** A brief change from `ILIKE` to `LIKE` in the customer count query, which was quickly reverted back to `ILIKE` to maintain case-insensitivity. Subsequent entries (up to 2:17:16 PM) show identical code, indicating minor saves or debugging checks.
    *   **Search and Ordering Refinement (1:33:19 PM):** Improved the customer search logic by trimming and lowercasing the search string and adding `ORDER BY account_name` to paginated results.
    *   **Partial Reversion/Debugging (1:34:30 PM):** The search logic for customers reverted partially to an earlier form (`%${req.query.search}%`) and `ORDER BY` was removed from the paginated query, with added console logs for debugging query results.
    *   **Final Search Logic (2:27:52 PM):** The customer search was updated to perform a "starts with" search (`${rawSearch}%`) when a `rawSearch` string is present, otherwise using `"%"` for all results. Debugging `console.log` statements remain.

**Patterns and Recurring Elements:**

*   **Consistent Date Handling:** Use of `::timestamp` casting in SQL queries and explicit checks for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` to validate dates in analytics queries. The `utils/analytics.ts` file consolidates date range defaults and formatting.
*   **Role-Based Data Access:** The `company_details.controller.ts` explicitly differentiates data fetching based on `req.query.role` ('AGENT' vs. 'CUSTOMER'), querying different database tables accordingly.
*   **Parameterized SQL Queries:** SQL queries generally use `$1`, `$2`, etc., for parameters to prevent SQL injection, especially evident in `company_details.controller.ts`.
*   **Dynamic Query Building:** The analytics controllers heavily rely on constructing SQL queries dynamically based on request parameters (`type`, `displayBy`, `CompanyName`, date ranges).
*   **Debugging Practices:** Frequent use of `logger.info`, `logger.error`, and `console.log` statements across multiple files and timestamps, indicating active development and troubleshooting.
*   **Common Utility Imports:** Functions like `query` from `../../config/database` are consistently imported and used for all database interactions. `AuthenticatedRequest` and `Response` from `express` are standard for controller signatures.

## 2:39:32 PM
Throughout the provided logs, a core set of frontend components in a `T360-V2` project are undergoing iterative development and refinement, primarily focusing on UI/UX and data presentation for an analytics dashboard.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\common\chip-tabs-view.tsx`**
    *   **Timestamp Range:** `11/3/2025, 2:50:09 PM` to `11/3/2025, 6:04:54 PM`
    *   **Key Changes:** This component, a tab-like navigation using "chips," saw extensive styling updates using Tailwind CSS.
        *   **Layout & Sizing:** Frequent adjustments to `max-w` (maximum width) of the main container, varying from `520px` up to `1200px` and back. Margin adjustments (`ml-[-6px]`) were also applied.
        *   **Chip Styling:** Continuous refinement of chip appearance, including changes to `gap` between chips (e.g., `gap-2` to `gap-3`), `rounded-full` to `rounded-lg` then `rounded-md` for borders, and fixed `width`/`height` (`w-[180px] h-[40px]`) for both standard options and the "New" button chip.
        *   **Visual Cues:** Evolution of `shadow` properties, `transition` effects, and `hover` states. Active and inactive chip backgrounds and text colors (`bg-blue-600` vs. `bg-gray-100`, `text-white` vs. `text-black`/`text-gray-900`) were repeatedly tweaked.
        *   **Functionality & Content:** The `Option` interface was extended to include an `icon` property, and the display logic for both regular option chips and the "New" button chip was updated to accommodate icons alongside labels, with specific spacing (`ml-4`, `mr-2`, `ml-3`) for these icons. The order of the "New" button within the scrollable container was also changed.
        *   **Scroll Controls:** The `fontSize` of the `ChevronLeft`/`ChevronRight` scroll icons was increased from `small` to `large`.
        *   **Debugging:** Console log statements were added and later modified (`console.log("===options",options,value);`) to inspect component props during development.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **Timestamp Range:** `11/3/2025, 2:56:23 PM` to `11/3/2025, 5:11:25 PM`
    *   **Key Changes:** This file primarily involved adjustments to icon imports for the analytics toolbar.
        *   **Icon Imports:**
            *   `ShowChart` from `@mui/icons-material` was added (`3:19:30 PM`).
            *   `PresentationChartLineIcon` from `@heroicons/react/16/solid` was introduced (`3:21:27 PM`), alongside removals of `MagnifyingGlassIcon` and `PlusIcon`.
            *   The import path for `PresentationChartLineIcon` was updated to `@heroicons/react/24/solid` (`3:22:18 PM`), likely changing its default size.
            *   `HiPresentationChartLine` from `react-icons/hi2` was added (`3:23:44 PM`), indicating the introduction of another icon from a different library.
        *   Many log entries for this file show identical code, suggesting frequent saves without functional alterations after the initial icon changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\analyticsContainer.tsx`**
    *   **Timestamp Range:** `11/3/2025, 4:52:06 PM` to `11/3/2025, 4:53:29 PM`
    *   **Key Changes:** The provided log entries show no functional changes to this file. It defines the `AnalyticsContainer` component, which manages the drag-and-drop (`react-dnd`) and resizing (`ResizableGridItem`) of metric boxes on a grid. It integrates with Redux (`analyticSlice`, `settingSlice`) for state, and uses RTK Query hooks (`useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`) for API interactions (fetching reports, saving layout/size changes).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\MetricFooter.tsx`**
    *   **Timestamp:** `11/3/2025, 5:16:09 PM`
    *   **Key Changes:** This single entry details a component that provides a footer for individual metric boxes. It offers:
        *   **Data Export:** Functionality to export data to Excel (with a column selector modal) and generate PDF versions of the metric's chart/content (`jsPDF`, `html2canvas-pro`).
        *   **Information Display:** Shows calculated values (`calType`, `calValue`) and tooltips for report formulas.
        *   **View Options:** An enlarge button (`FullscreenOutlined`) to expand the metric view.
        *   **State Management:** Uses Redux (`useSelector`, `useDispatch`) to access analytics state and update selected columns.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\Charts\GaugeChart.tsx`**
    *   **Timestamp Range:** `11/3/2025, 5:58:14 PM` to `11/3/2025, 5:59:43 PM`
    *   **Key Changes:** This component, responsible for rendering a radial bar (gauge) chart, saw specific color palette adjustments.
        *   **Color Scheme:** The `fill` gradient colors for the gauge chart were modified. Specifically, the color for `isValueBelowLimit` transitioned from green (`#008000`) to dark gray (`#09090B`), and then to a slightly lighter gray (`#595959`). The `gradientToColors` was also aligned with the dark gray. These changes suggest a refinement of the chart's visual branding or emphasis.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`**
    *   **Timestamp:** `11/3/2025, 6:05:49 PM`
    *   **Key Changes:** This single entry describes a component for managing custom analytics dashboards. It allows users to:
        *   **Create/Edit Views:** Supports "add" or "edit" actions for dashboards, with state for `viewName` and a `checkBoxManager` for metric selection.
        *   **Metric Selection:** Uses a `TreeViewContainer` for selecting metrics, with a limit of 9 metrics enforced and toasts for feedback.
        *   **Persistence:** Interacts with an API (`useSaveDasboardMutation`) to save changes, handling different HTTP methods (POST/PUT/DELETE).
        *   **User Interface:** Includes a `RadioNav` for tab selection (e.g., "Container Wise", "MBL Wise"), an `InputBox` for the view title, and buttons for "Save", "Cancel", "Delete", and "Audit".
        *   **Alerts & Audit:** Features `PopupAlert` for confirmations (e.g., delete) and an `AuditViewDrawer` for viewing audit logs of views.

**Patterns and Recurring Elements:**

*   **Iterative Design (UI/UX):** The frequent, granular changes in `chip-tabs-view.tsx` highlight an iterative design process, constantly tweaking visual elements like spacing, sizing, shadows, and color states.
*   **Tailwind CSS:** Heavy reliance on Tailwind CSS for utility-first styling across components, allowing for rapid and precise UI adjustments directly in the JSX.
*   **Redux Toolkit (RTK) & RTK Query:** Consistent use of `react-redux` (`useDispatch`, `useSelector`) for global state management and RTK Query hooks for efficient API interaction, indicating a modern and centralized approach to data handling.
*   **Icon Library Diversity:** The project uses multiple icon libraries (`@mui/icons-material`, `@heroicons/react`, `react-icons/bs`, `react-icons/fa6`, `react-icons/md`, `react-icons/ri`, `react-icons/hi2`), which could lead to a diverse but potentially inconsistent iconographic style.
*   **PDF Export Functionality:** A recurring theme is the ability to export UI elements to PDF using `jspdf` and `html2canvas-pro`, suggesting a business requirement for reporting and document generation from the dashboard.
*   **Debugging Practices:** The presence of `console.log` statements in various files indicates active development and debugging.
*   **Modular Component Architecture:** The codebase is structured with clear, specialized React components (e.g., `ChipsTabView`, `AnalyticsToolbar`, `MetricFooter`, `GaugeChart`, `ViewContainer`), promoting reusability and maintainability.

## 2:39:39 PM
The code changes primarily focus on enhancing the analytics and reporting functionalities of the T360-V2 backend. Several services were updated or introduced to support dynamic query generation, data normalization, and dashboard customization.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analyticsExportService.ts`**
    *   **Timestamp: 11/3/2025, 11:51:04 AM & 11:52:09 AM**: Initial implementation of `getExportData` which generates Excel reports for booking and non-booking data. It includes a `replaceColumnHandler` to standardize "LONG BEACH" to "LOS ANGELES" for `pod` and `place_of_delivery` fields, and logic to filter TEU for MBL-wise reports.
    *   **Timestamp: 11/3/2025, 11:52:28 AM & 11:52:44 AM**: Temporary code issues were introduced, such as duplicate imports, incorrect DB utility path (`@src/common/db`), and redundant function definitions. Debugging `console.log` statements were added to catch blocks.
    *   **Timestamp: 11/3/2025, 11:54:19 AM & 11:56:23 AM**: These issues were resolved. Redundant code was removed, the DB utility path was corrected to `@src/common/util/database`, and more comprehensive `console.log` statements were added for debugging query parameters, user codes, generated SQL, and export data.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Timestamp: 11/3/2025, 11:58:36 AM & 11:58:42 AM**: Introduces the `getMonthValue` helper and the `bookingQuery` function. This function constructs dynamic SQL `WHERE` clauses and column selections for various booking-related reports, including handling stacked bar charts based on month, week, or quarter, and specific conditions for MBL-wise reports.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp: 11/3/2025, 12:00:20 PM - 1:18:17 PM**: Defines `bookingQueryBuilder` which generates complex SQL queries for various booking-related metrics like "Booking Date to Actual Departure" and "Stacked Bar" variations, incorporating a `customizer` object to configure report properties.
    *   **Timestamp: 11/3/2025, 1:22:57 PM - 1:29:32 PM**: Significant type definition refinements were made, specifically to the `Customizer` interface and `QueryBuilderI`, adding fields like `mblwise`, `chartType`, and more detailed `calColumnConfig` to improve type safety and code clarity.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\tableService.ts`**
    *   **Timestamp: 11/3/2025, 12:02:23 PM**: Implements `getTableDataReports`, a dispatcher function that routes requests to specific query builders (`chassisQueryBuilder`, `bookingQueryBuilder`, etc.) based on the report `type` parameter. It handles default date ranges and user context.
    *   **Timestamp: 11/3/2025, 12:08:25 PM**: Added a `console.log` statement to the error handling block.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\containerService.ts`**
    *   **Timestamp: 11/3/2025, 12:11:01 PM**: Initial version of `getContainerReports` to fetch container analytics. It dynamically builds SQL queries based on grouping columns, including country of origin/discharge, and uses `replaceValueInQuery` for location normalization.
    *   **Timestamp: 11/3/2025, 12:13:38 PM**: Refactored for improved type safety with new interfaces (`ContainerReportQuery`, `Customizer`, `AnalyticsRow`). The query logic was clearly separated for country-based vs. other column-based grouping. Unused imports and commented-out code were removed.
    *   **Timestamp: 11/3/2025, 12:16:36 PM**: Added a `console.log` statement to inspect `req.query` at the function's start.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\analyticsRoutes.ts`**
    *   **Timestamp: 11/3/2025, 12:21:34 PM**: This file was updated to significantly expand the analytics API. New GET routes were added for `getTEUReports`, `getCBMReports`, `getKGSReports`, `getContainerReports`, `getTransitReports`, and `getTableDataReports`, indicating a major expansion of analytics capabilities.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Timestamp: 11/3/2025, 1:22:26 PM & 5:08:26 PM**: This core utility file defines several helper functions: `defaultDateRange` for date initialization, `replaceValueInQuery` for data normalization (e.g., "LONG BEACH" to "LOS ANGELES"), `getUserObject` for fetching user/company context, `getFilterQueryByDisplayValue` for generating dynamic SQL filters, `getExcelSelectedColumns` for selecting columns based on report type, and `dateFilterOnExport` for standardizing date formats and handling invalid dates in exported data. It also includes a comprehensive `EXCEL_EXPORT_COLUMNS` list.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamp: 11/3/2025, 3:39:14 PM**: A debugging `logger.info` statement was added to the `userSettings` function.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\index.ts`**
    *   **Timestamp: 11/3/2025, 3:39:25 PM**: A new route `apiRouter.use(Paths.Company.Base, getAllCompanyDetails);` was added, indicating the integration of company details functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**
    *   **Timestamp: 11/3/2025, 4:32:00 PM**: A new service `getTEUReports` was introduced to calculate and report Twenty-foot Equivalent Unit (TEU) data. It dynamically builds SQL queries, groups data by various columns (including countries), handles `trucker` specific conditions, and includes logic for calculating TEU values and handling null/empty column values by assigning 'OTHERS'. Debugging `logger.info` statements were added.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**
    *   **Timestamp: 11/3/2025, 4:32:31 PM & 4:49:23 PM**: This service manages analytics dashboard configurations. It provides endpoints to retrieve dashboard metrics, list available metrics grouped by container-wise and MBL-wise categories (with preload functionality), save the display sequence of reports, and update their `columnSpan` and `rowSpan` properties on a dashboard. Debugging `console.log` statements were added in error handling.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Query Generation**: A pervasive pattern involves constructing SQL queries dynamically based on user inputs, report types, date ranges, and grouping criteria. This is evident across `analyticsExportService`, `export.query`, `booking.query`, `containerService`, `tableService`, and `teuService`.
*   **Data Normalization**: Consistent handling of location names, specifically replacing "LONG BEACH" with "LOS ANGELES", is implemented via `replaceColumnHandler` and `replaceValueInQuery`.
*   **User and Company Context**: The `getUserObject` utility is frequently used to retrieve user-specific information (user code, company name) which is then used to filter and personalize queries.
*   **Date Range Management**: The `defaultDateRange` utility is widely adopted to ensure consistent date filtering, defaulting to a one-year range when not specified.
*   **Error Handling and Logging**: `try-catch` blocks are used consistently for robust error handling, with `logger.error` for logging errors and `res.status(500).json` for returning generic internal server errors. Debugging `console.log` statements appear often, suggesting active development and troubleshooting.
*   **Type Safety**: There's a clear effort to improve code quality through the introduction and refinement of TypeScript interfaces (e.g., `AnalyticsControllerQuery`, `ExportDataRow`, `QueryBuilderI`, `Customizer`, `ContainerReportQuery`), enhancing readability and maintainability.
*   **Analytics Feature Expansion**: The addition of new services (`teuService`) and routes (`analyticsRoutes`) indicates a significant expansion of the analytics reporting capabilities, covering various aspects like TEU, CBM, KGS, container, and transit data, alongside dashboard customization features.

## 5:11:27 PM
The codebase underwent a series of focused updates between November 3rd and November 4th, 2025, primarily affecting analytics reporting, OTM Bill of Lading (BOL) routing, and company details retrieval with search and pagination.

**File-Specific Updates:**

*   **`src\controllers\analytics\others.controller.ts` (Timestamp: 11/3/2025, 3:44:37 PM)**
    *   This controller, `getTableDataReports`, was updated to serve various analytics reports by dynamically constructing SQL queries based on the `type` parameter (e.g., 'Averagechassisuseddays', 'BookingDatetoActualDeparture', 'ContainerDischargevsContainerAvailable', 'BLReleaseKPI', 'TotalShipments').
    *   It imports and utilizes multiple query builder modules (chassis, booking, departure, container, general) to handle the specific logic for each report type.
    *   Date range defaults are applied if not provided in the request, and user-specific company and access information are used to scope queries.
    *   Queries are logged to the console before execution, and results are returned with a `customizer` object containing report metadata.

*   **`src\routes\otm_bol.route.ts` (Timestamp: 11/3/2025, 5:05:37 PM)**
    *   This file defines API routes related to Oracle Transportation Management (OTM) Bill of Lading (BOL).
    *   New routes were added or confirmed for fetching Excel data, retrieving PLPO by BOL, fetching payload, fetching by a specific BOL number, editing OTM BOLs, uploading/saving/editing BOL Excel data, fetching by a common key, generating XML, and sending data to OTM.
    *   A previously existing `upload` route, likely for file uploads, is commented out.

*   **`src\utils\analytics.ts` (Timestamp: 11/3/2025, 6:57:38 PM)**
    *   This utility file for analytics was updated with several helper functions:
        *   `defaultDateRange`: Provides a default date range (current date back 365 days).
        *   `replaceValueInQuery`: A SQL utility to conditionally replace values for `pod` or `place_of_delivery` columns.
        *   `getUserObject`: Retrieves user and company context, potentially overriding `usercode` for ADMIN access.
        *   `getFilterQueryByDisplayValue`: Generates SQL clauses for grouping, ordering, and selecting data based on `displayBy` values like 'month', 'week', or 'quarter'.
        *   `getExcelSelectedColumns`: Dynamically selects specific columns for Excel exports based on the report name and whether it's a booking report, defining common, booking, and other data columns.
        *   `dateFilterOnExport`: A function to filter and format date strings within data objects for export, ensuring valid dates are formatted to `MM/DD/YYYY` using `moment.js` and invalid ones are set to null.
    *   A comprehensive `EXCEL_EXPORT_COLUMNS` array was defined, mapping data keys to human-readable names for various tracking and booking related fields.

*   **`src\controllers\analytics\query\booking.query.ts` (Multiple timestamps on 11/4/2025 from 12:07:25 PM to 4:11:53 PM)**
    *   This file, responsible for building booking-related analytics queries, underwent several rapid iterations.
    *   The core functionality involves constructing SQL queries for various booking analytics types (e.g., 'BookingDatetoActualDeparture', 'BookingDatetoActualDepartureMblWise', 'BookingDatetoActualDepartureStackedBar'). These queries often calculate day differences between dates and categorize them for stacked bar charts.
    *   A significant change occurred around **11/4/2025, 3:22:50 PM to 3:25:31 PM** for the `BookingDatetoActualDeparture` report type. The calculation of `max_value` was changed from `MAX(value)` to `SUM(value)` (aliased as `total_sum`), and the final `SELECT` statement was modified to directly include this `total_sum` as `total_count`, removing a previous percentage calculation based on the maximum value. This change involved minor syntax errors (like a misplaced semicolon) that were likely quickly resolved in subsequent commits.
    *   The overall structure of determining `customizer` properties (e.g., `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `calColumnConfig`) and generating the specific SQL based on `type` remained consistent.

*   **`src\controllers\company_details.controller.ts` (Multiple timestamps on 11/4/2025 from 1:18:10 PM to 3:08:55 PM)**
    *   This controller, `getAll`, fetches company names based on `role` ('AGENT' or 'CUSTOMER'), supporting search and pagination.
    *   For the 'AGENT' role, it fetches `cname` from `agent_po_account_master` using `ILIKE` for search. This logic remained mostly stable.
    *   For the 'CUSTOMER' role, the implementation saw substantial changes and reversals:
        *   Initial implementations used simple `ILIKE` queries for `account_name` from `mtr_tracking_data`, with optional pagination.
        *   Around **11/4/2025, 2:46:39 PM**, an attempt was made to optimize search using `LOWER(TRIM(account_name)) LIKE rawSearch%` for better index usage and to count/fetch distinct normalized company names, also including `MIN(customer_id)`.
        *   This optimization was then partially rolled back in subsequent commits (e.g., **11/4/2025, 2:47:14 PM, 2:48:50 PM, 2:49:58 PM**), where `customer_id` was removed from the selected columns, and the more complex distinct logic was simplified.
        *   A further optimization attempt at **11/4/2025, 3:02:50 PM** explicitly changed search patterns for both 'AGENT' and 'CUSTOMER' roles to `search%` (prefix matching) and used `LOWER(column_name) LIKE LOWER($1)` for 'CUSTOMER' to align with an existing database index. This update also included detailed comments about recommended database indexes and performance tips.
        *   However, these specific optimization efforts were quickly reverted in the final two logs for this file (**11/4/2025, 3:07:41 PM and 3:08:55 PM**), returning to `ILIKE %${req.query.search}%` for both pagination and non-pagination scenarios for 'CUSTOMER' roles, suggesting a preference for simpler query syntax or issues with the optimization.
    *   Throughout these changes, pagination logic (`page`, `perPage`, `offset`) remained consistent, as did the mapping of results to `{ value, label }` objects.

**Patterns and Recurring Elements:**

*   **Date-Based Analytics:** A strong pattern emerges in the analytics files (`others.controller.ts`, `booking.query.ts`, `analytics.ts`) around calculating time differences between dates, categorizing these differences, and aggregating data over various time intervals (month, week, quarter). The use of `t49_vessel_actualdeparted_date` and `bookingdate` is prominent.
*   **Dynamic SQL Query Generation:** Controllers frequently construct SQL queries based on request parameters (`type`, `displayBy`, `CompanyName`, `fromDate`, `toDate`), indicating a flexible reporting system.
*   **Role-Based Access/Logic:** The `company_details.controller.ts` clearly demonstrates logic segregation based on user roles ('AGENT', 'CUSTOMER'), fetching data from different tables and applying different query strategies.
*   **Search and Pagination:** `company_details.controller.ts` consistently implements search (using `ILIKE`) and pagination logic across different roles, though the specifics of the search pattern for 'CUSTOMER' accounts saw multiple iterations and reversals.
*   **Database Interaction:** All code changes involve direct interaction with a PostgreSQL database (implied by `ILIKE`, `LOWER()`, `TRIM()`, `DATE_TRUNC`, `EXTRACT(DAY FROM...)`, `INTERVAL`) through a shared `query` function.
*   **Iterative Development:** The rapid sequence of timestamps, particularly for `company_details.controller.ts` and `booking.query.ts` on November 4th, suggests active and iterative development, testing, and refinement of specific features, including performance optimizations that were introduced and then partially rolled back or adjusted.