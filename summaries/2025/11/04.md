# Activity Summary for 11/4/2025

## 9:31:42 AM
**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\others.controller.ts`** (Timestamp: 11/3/2025, 3:44:37 PM)
This file defines the `getTableDataReports` controller function, which is responsible for fetching various analytics reports. It imports several specialized query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`, `departureQueryBuilder`, `containerQueryBuilder`, `generalQueryBuilder`). The controller dynamically constructs a SQL query based on a `type` parameter received in the request, categorizing reports into groups such as chassis, booking & cargo-ready, containers, departures, and general metrics. It handles default date ranges, user and company context, and executes the generated query, returning the results. A significant portion of the code is dedicated to a large `if-else if` block that maps the `type` parameter to the appropriate query builder.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\otm_bol.route.ts`** (Timestamp: 11/3/2025, 5:05:37 PM)
This file sets up the API routes for operations related to OTM (Oracle Transportation Management) Bill of Lading (BOL). It exposes endpoints for: exporting excel data, fetching PLPO (Packing List/Proof of Delivery) by BOL, fetching payload, fetching by BOL number, editing OTM BOL, uploading and saving edits, fetching by a common key, generating XML, and sending data to OTM. A previously used file upload route (`/upload`) is commented out, suggesting a change in file upload handling or a temporary disablement.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\analytics.ts`** (Timestamp: 11/3/2025, 6:57:38 PM)
This utility file provides a collection of functions essential for analytics and reporting. Key functionalities include:
*   `defaultDateRange`: Generates a default one-year date range.
*   `replaceValueInQuery`: A helper to conditionally modify column values in SQL queries, specifically for 'pod' or 'place_of_delivery'.
*   `getUserObject`: Retrieves user and company-specific information, including handling admin-level access for usercode overrides.
*   `getFilterQueryByDisplayValue`: Generates SQL `GROUP BY`, `ORDER BY`, `date_trunc`, and `SELECT` clauses for aggregating data by month, week, or quarter, based on the `displayBy` parameter.
*   `getExcelSelectedColumns`: Dynamically selects specific columns for Excel exports, with special handling for reports like "Cargo-Ready Date to ETD" (calculating network days) and "BL Release KPI" (adjusting release dates for weekends).
*   `isValidDate` and `dateFilterOnExport`: Functions to validate and format date strings for display and export, ensuring invalid dates are nullified and valid ones are formatted as "MM/DD/YYYY".
*   `EXCEL_EXPORT_COLUMNS`: A comprehensive array defining the key-name mapping for standard columns used in Excel exports, covering various shipment, container, and date-related fields.

**Summary of Key Information, Significant Changes, and Patterns:**

All logged changes occurred on **November 3, 2025**, indicating a focused period of development or updates.

*   **Analytics Feature Enhancement:** A major theme across `others.controller.ts` and `analytics.ts` is the expansion and refinement of analytics capabilities. This involves dynamic SQL query construction based on various report types, sophisticated date calculations (e.g., network days, weekend adjustments for BL release), and robust data preparation for Excel exports, including column selection and date formatting. The architecture uses a modular approach with dedicated query builders for different analytics categories.
*   **Date-Centric Operations:** There's a strong recurring pattern of handling dates for filtering, aggregation, and display. Functions for default date ranges, date validation, and date formatting are central to the analytics utilities.
*   **Dynamic Query Generation & Reporting:** The system extensively uses parameters like `type` and `displayBy` to dynamically build database queries and customize report outputs, specifically for different time granularities (month, week, quarter) and report names.
*   **OTM Integration:** `otm_bol.route.ts` highlights ongoing development related to OTM integration, covering data exchange (payload fetching, XML generation) and management of Bill of Lading information. The commented-out upload route suggests an evolving strategy for handling OTM-related file uploads.
*   **Logistics/Shipping Domain:** The terminology and types of reports (Chassis, Booking, Container, Departure KPIs, BOL, POL, POD, MBL, ETA, ETD) consistently point to an application heavily involved in logistics and shipping operations.

## 9:32:01 AM
The provided log details frequent iterative changes to UI components and the introduction of new analytics features.

**File-Specific Updates:**

*   **`src\components\common\chip-tabs-view.tsx` (Frequent updates between 11/3/2025, 2:50:09 PM and 11/3/2025, 6:04:54 PM):**
    *   This file underwent numerous styling adjustments for the `ChipsTabView` component. This included changes to:
        *   The overall `max-width` of the component, progressively increasing from `520px` to `1150px` (with some temporary larger values like `1200px`) and some relative positioning adjustments (`ml-[-4px]`, `ml-[-6px]`).
        *   The `gap` between chips, fluctuating between `gap-2` and `gap-3`.
        *   The appearance of individual chip buttons and the "New" button, specifically their `border-radius` (e.g., `rounded-full`, `rounded-lg`, `rounded-md`, `rounded-xl`), `padding` (`py-1.5` vs `py-2`), `width`, `min-width`, `height`, and `shadow` effects.
        *   Color schemes for active and inactive chips, including a temporary shift to a dark active background which was later reverted.
        *   The placement of icons within chip buttons (moving from `{icon} {label}` to `<span>{label}</span> <span className="text-gray-500">{icon}</span>`).
        *   The order of the "New" button relative to other options in the scrollable container was swapped.
        *   The size of the scroll Chevron icons (from `small` to `large`).
        *   Several `console.log` statements were added and modified to debug options and values passed to the component.
    *   The `Option` interface was updated to explicitly include `icon?: React.ReactNode;`.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx` (Updates between 11/3/2025, 2:56:23 PM and 11/3/2025, 5:11:25 PM):**
    *   This file primarily focuses on the `AnalyticsToolbar` component, which includes controls for the analytics dashboard.
    *   Significant additions include a robust PDF export functionality for the entire dashboard using `jspdf` and `html2canvas-pro`, complete with a `getBase64Image` utility for handling the logo.
    *   It integrates Redux (`useDispatch`, `useSelector`) to manage global filters, selected dashboards, and operation types.
    *   Imports for various icon libraries (`@mui/icons-material`, `@heroicons/react`, `react-icons`) were frequently added and adjusted, indicating an evolving set of UI icons. `MagnifyingGlassIcon`, `PlusIcon`, and `PresentationChartLineIcon` from `@heroicons` were added and/or repositioned in imports, alongside `HiPresentationChartLine` from `react-icons/hi2`.
    *   Numerous entries show no code changes, suggesting frequent saves or minor, undetailed edits.

*   **`src\components\screen\analytics\analyticsContainer.tsx` (Updates between 11/3/2025, 4:52:06 PM and 11/3/2025, 4:53:29 PM):**
    *   This file introduces the `AnalyticsContainer` component, which is responsible for rendering and managing individual metric widgets on a dashboard.
    *   It implements drag-and-drop functionality using `react-dnd` (`HTML5Backend`) to reorder metrics (`moveItem`).
    *   It supports resizing of metric widgets (`saveSize`) and changing their view type (chart/table) (`saveView`).
    *   API interactions (`useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation`) are set up for fetching report data and persisting layout changes.
    *   `moment.js` is used for date formatting in API calls.
    *   Extensive Redux integration is present for managing metrics and filter states.

*   **`src\components\screen\analytics\MetricFooter.tsx` (Initial commit at 11/3/2025, 5:16:09 PM):**
    *   Introduced the `MetricFooter` component, providing actions and information at the bottom of individual metric boxes.
    *   Features include displaying calculated values with a `Badge`, showing detailed formulas via a `Tooltip`, exporting data to Excel (`FaFileExcel`) with column selection via a `ThemedModal` and `ColumnsSelector`, and exporting individual metric charts to PDF (`MdPictureAsPdf`) using `jspdf` and `html2canvas-pro`.
    *   A fullscreen option (`FullscreenOutlined`) to enlarge the metric is also included.

*   **`src\components\screen\analytics\Charts\GaugeChart.tsx` (Updates between 11/3/2025, 5:58:14 PM and 11/3/2025, 5:59:43 PM):**
    *   This file adds the `GaugeChart` component, which renders a radial bar chart using `react-apexcharts`.
    *   It dynamically sets the gradient fill color based on whether the `value` is below a certain limit (e.g., green/dark gray for < 3 days, orange otherwise).
    *   The chart's value formatter displays data in "Days".
    *   Initial color choices for the gauge were experimented with, moving from green/orange to dark gray/orange.

*   **`src\components\screen\analytics\custom-view\ViewContainer.tsx` (Initial commit at 11/3/2025, 6:05:49 PM):**
    *   Introduced `ViewContainer` for managing custom analytics dashboards (views).
    *   Allows users to create, edit, and delete views, specifying a title.
    *   Supports two types of views: "Container Wise" and "MBL Wise", selectable via a `RadioNav`.
    *   Metrics can be selected using a `TreeViewContainer`, with a limit of 9 metrics.
    *   Integrates API calls for fetching and saving dashboard configurations (`useFetchDashboardOptionsQuery`, `useSaveDasboardMutation`).
    *   Includes a "Delete" option with a confirmation `PopupAlert` and an "Audit" feature displayed in an `AuditViewDrawer`.

**Patterns and Recurring Elements:**

*   **Iterative UI/UX Refinement:** A prominent pattern is the rapid and detailed iteration on UI elements, especially visible in `chip-tabs-view.tsx`. This suggests an active development phase focused on optimizing the look, feel, and responsiveness of user interface components, often involving micro-adjustments to CSS classes.
*   **Redux for State Management:** All major new or updated components (`AnalyticsToolbar`, `analyticsContainer`, `MetricFooter`, `ViewContainer`) leverage `react-redux` for managing complex application state, indicating a consistent architectural choice for state handling across the analytics section.
*   **API Integration with RTK Query:** The use of RTK Query hooks (e.g., `useLazyFetchReportQuery`, `useSaveDasboardMutation`) is consistent across components that interact with the backend, demonstrating a standardized approach to data fetching and mutations.
*   **PDF Generation:** The repeated use of `jspdf` and `html2canvas-pro` in both `AnalyticsToolbar.tsx` and `MetricFooter.tsx` for exporting content to PDF highlights a key feature and a shared utility pattern within the analytics module.
*   **Debugging Practices:** The presence of `console.log` statements throughout the code, often modified in subsequent commits, points to active debugging and verification during development.
*   **Modular Component Design:** The creation of distinct components like `ChipsTabView`, `AnalyticsToolbar`, `AnalyticsContainer`, `MetricFooter`, `GaugeChart`, and `ViewContainer` under the `analytics` and `common` directories reflects a modular and organized approach to frontend development.

## 9:32:22 AM
The code changes primarily focus on enhancing the analytics and reporting functionalities within the `t360-backend-v2` project, spanning various service files and a utility file. Key updates include the refinement of SQL query generation, improved type safety, and the addition of user-specific preferences and dashboard metric management.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analyticsExportService.ts`**:
    *   **11/3/2025, 11:51:04 AM**: Introduced the `getExportData` controller to handle dynamic SQL query generation for booking and non-booking reports, including a `replaceColumnHandler` for standardizing "LONG BEACH" to "LOS ANGELES" in `pod` and `place_of_delivery` fields. Logic for MBLwise TEU filtering was also present.
    *   **11/3/2025, 11:52:28 AM**: Experienced a brief, temporary change in the database import path from `@src/common/util/database` to `@src/common/db`, which was subsequently reverted. This version also contained duplicate code blocks and a typo (`co logger.error`).
    *   **11/3/2025, 11:52:44 AM**: Rectified the duplicate code and typo, restoring code cleanliness, while keeping the temporary database import path.
    *   **11/3/2025, 11:54:19 AM**: Reverted the database import path back to `@src/common/util/database`. Refactored `getUserObject` calls and added numerous `console.log` statements for debugging `req.query`, `userCode`, `mainQuery`, and `excelExportData`. Simplified MBLwise TEU filter logic and removed `NextFunction` from imports.
    *   **11/3/2025, 11:56:23 AM**: Final cleanup removing commented-out `replaceColumnHandler` code.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**:
    *   **11/3/2025, 11:58:36 AM**: Introduced a `getMonthValue` helper and the `bookingQuery` function responsible for generating complex, conditional SQL query fragments for various booking reports, including specialized logic for "Stacked Bar" reports based on date differences.
    *   **11/3/2025, 11:58:42 AM**: No functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**:
    *   **11/3/2025, 12:00:20 PM**: Defined `bookingQueryBuilder` to construct SQL queries for booking-related analytics, configuring `customizer` properties like `dateRange`, `calType`, and `dateColumns`. Queries involve calculating time differences, handling distinct entities, and grouping results for various report types.
    *   **11/3/2025, 1:22:57 PM - 1:29:32 PM**: Progressively refined the `QueryBuilderI` and `Customizer` interfaces, moving from generic `any` types to more specific `string[]`, then introducing new interfaces like `CalColumn` and `CalColumnConfig`. `Customizer` was extended to include properties like `calType`, `dateColumns`, `booking`, `calColumnConfig`, `mblwise`, and `chartType`, indicating a push for stronger type checking and clearer data structures for report configurations.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\tableService.ts`**:
    *   **11/3/2025, 12:02:23 PM**: Established `getTableDataReports` as a central dispatcher, importing various query builders (chassis, booking, container, departure, general) to dynamically construct queries based on the `type` parameter from the request.
    *   **11/3/2025, 12:08:25 PM**: Added a `console.log(error)` in the catch block for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\containerService.ts`**:
    *   **11/3/2025, 12:11:01 PM**: Implemented `getContainerReports` for container-specific analytics, dynamically generating queries grouped by various columns (e.g., `country_of_origin`, `trucker`). Queries involve calculating container counts and percentages, and include direct SQL `CASE` statements for port name normalization and handling null/empty values.
    *   **11/3/2025, 12:13:38 PM**: Refactored for improved type safety and readability by introducing explicit interfaces (`ContainerReportQuery`, `Customizer`, `AnalyticsRow`) and adding descriptive comments. Type-safe `query` invocation was implemented, and nullish coalescing was used for default values.
    *   **11/3/2025, 12:16:36 PM**: Added a `console.log("===reqquery",req.query);` for debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\analyticsRoutes.ts`**:
    *   **11/3/2025, 12:21:34 PM**: Configured routing for various analytics reports (`GetExcelReport`, `GetTeu`, `GetCbm`, `GetKgs`, `GetContainers`, `GetTransit`, `GetTablesData`), integrating them into the `/analytics` base path.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**:
    *   **11/3/2025, 1:22:26 PM**: Centralized utility functions: `defaultDateRange`, `replaceValueInQuery` (for port name normalization), `getUserObject` (for user/company info), `getFilterQueryByDisplayValue` (for dynamic SQL clauses), `getExcelSelectedColumns` (for report-specific column selection), and `dateFilterOnExport` (for date cleanup and formatting). Also defined `EXCEL_EXPORT_COLUMNS` constant.
    *   **11/3/2025, 5:08:26 PM**: No functional changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**:
    *   **11/3/2025, 3:39:14 PM**: Implemented core user management functionalities, including `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. These functions handle user authentication, preferences (persisted with `ON CONFLICT DO UPDATE`), user invitations, and fetching user lists.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\index.ts`**:
    *   **11/3/2025, 3:39:25 PM**: Integrated `UserRoutes` into the main API router.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**:
    *   **11/3/2025, 4:32:00 PM**: Introduced `getTEUReports` for generating TEU-related analytics. Similar to container reports, it dynamically builds queries based on grouping columns, calculates TEU from container types, and includes logic for port name normalization and handling missing values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**:
    *   **11/3/2025, 4:32:31 PM**: Implemented services for managing dashboard metrics: `dashboardEndPointList` (fetches ordered and sized metrics), `getMetricList` (categorizes and preloads metrics), `saveSequence` (persists metric order), and `saveSize` (saves metric display sizes).
    *   **11/3/2025, 4:49:23 PM**: Added a `console.log` for debugging in the `saveSequence` catch block.

**Timestamps of Significant Changes:**

*   **11/3/2025, 11:51:04 AM**: Initial development/major update of `analyticsExportService.ts` for export data functionality.
*   **11/3/2025, 11:54:19 AM**: Refactoring and extensive debugging additions in `analyticsExportService.ts`.
*   **11/3/2025, 11:58:36 AM**: Introduction of dynamic query fragments for booking reports in `export.query.ts`.
*   **11/3/2025, 12:00:20 PM**: Initial implementation of `bookingQueryBuilder` in `booking.query.ts` for analytics reports.
*   **11/3/2025, 12:02:23 PM**: Creation of `tableService.ts` as a central report dispatcher.
*   **11/3/2025, 12:11:01 PM**: Initial implementation of `containerService.ts` for container-specific reports.
*   **11/3/2025, 12:13:38 PM**: Major refactoring in `containerService.ts` for type safety and code structure.
*   **11/3/2025, 1:22:26 PM**: Comprehensive utility functions introduced in `analytics.ts`.
*   **11/3/2025, 1:29:32 PM**: Final refinement of `Customizer` interface in `booking.query.ts` for advanced configuration.
*   **11/3/2025, 3:39:14 PM**: Introduction of `UserService.ts` with user authentication, preferences, and invitation management.
*   **11/3/2025, 4:32:00 PM**: Initial implementation of `teuService.ts` for TEU-specific reports.
*   **11/3/2025, 4:32:31 PM**: Initial implementation of `coreMetricService.ts` for dashboard metric management.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Generation**: A pervasive pattern across multiple services (`analyticsExportService`, `export.query.ts`, `booking.query.ts`, `containerService`, `teuService`) involves constructing SQL queries programmatically based on user input, report types, and company context.
*   **Port Name Normalization**: The transformation of "LONG BEACH" to "LOS ANGELES" is a consistent data cleansing rule, applied both in post-query processing and embedded directly into SQL queries.
*   **Date Handling**: All services consistently retrieve default date ranges and format dates for consistency and to filter out invalid entries.
*   **User and Company Context**: The `getUserObject` utility is repeatedly used to retrieve user and company-specific data, enabling personalized analytics and reports.
*   **Modular Query Builders**: The system utilizes distinct query builder functions (e.g., `chassisQueryBuilder`, `bookingQueryBuilder`) for different report categories, orchestrated by services like `tableService`.
*   **Type Safety and Interfaces**: There's an observable trend of progressively enhancing type definitions and introducing explicit interfaces (e.g., `QueryBuilderI`, `Customizer`, `AnalyticsRow`) for better code maintainability and error detection.
*   **Extensive Logging and Debugging**: `logger.info`, `logger.error`, and `console.log` statements are heavily used throughout the codebase, indicating an active development and debugging environment.
*   **Dashboard Customization**: Services like `coreMetricService` and `analyticsExportService` include logic for users to customize dashboard layouts, metric order, and display sizes, with a particular focus on "Stacked Bar" reports and MBL/Container-wise filtering.