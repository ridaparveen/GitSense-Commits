# Activity Summary for 11/7/2025

## 10:44:21 AM
The provided log details code changes across three primary files: `AuthRoutes.ts`, `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`, and `Paths.ts`.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   **Updates:** This file defines authentication routes. The provided log entry shows a `GET` endpoint for `Paths.Auth.GetUserInfo` which logs the `req.user` and returns it with an `OK` status. This appears to be an existing or early definition of a user information retrieval route.

2.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 6:04:50 PM and 11:23:11 PM.
    *   **Updates:**
        *   **Initial Structure (6:04:50 PM):** Introduced `getDashboardCardInfo` and `getDeliveryData` functions.
            *   `getDashboardCardInfo`: Fetches aggregated shipment data (Pending Departure, In Transit, ETA within 1 Week, Out for Delivery) with filters for `fromDate`, `toDate`, and `CompanyName`. It calculates TEU (Twenty-foot Equivalent Unit) values and applies user-specific conditions using `buildMtrUserCondition`.
            *   `getDeliveryData`: Fetches delivery or vessel arrival data, supporting filtering by `type` (delivery/vessel) and `mode` (ALL, Rail Delivery, Door Delivery, Port Delivery). It also applies user-specific conditions.
        *   **Minor Edits (6:05:15 PM, 6:05:28 PM, 6:06:01 PM):** These seem to be minor saving events without significant functional changes. The code remains largely identical to the initial structure.
        *   **Refinement of CompanyName Handling in `getDashboardCardInfo` (8:41:51 PM):** The `CompanyName` variable is now dynamically retrieved using `getUserObject` based on `req.user`, `req.query.companyname`, and `req.query.access`. The `CompanyName` query parameter is removed from the destructuring of `req.query`. A new import `getUserObject` from `@src/utils/analytics` is added.
        *   **Logging Addition (8:42:22 PM):** Added a `console.log("req.CompanyName", CompanyName);` line after retrieving `CompanyName` in `getDashboardCardInfo`.
        *   **Query Parameter Refinement (10:41:50 PM):** The `CompanyName` parameter is removed from the `req.query` destructuring for `getDashboardCardInfo`, reinforcing that `CompanyName` is now determined via `getUserObject`.
        *   **Commented out `useWhere` (10:43:59 PM):** The line `if(useWhere) conditions.push(useWhere);` is commented out in `getDashboardCardInfo`, suggesting a change in how user-specific conditions might be applied, possibly relying on `CompanyName` in the final query string directly.
        *   **Added `console.log` for Result (10:44:51 PM):** A `console.log("result[0]", result[0]);` is added in `getDashboardCardInfo` to inspect the fetched data.
        *   **`getDeliveryData` CompanyName Logic Change (10:46:26 PM):** In `getDeliveryData`, the `CompanyName` is now retrieved using `getUserObject` (similar to `getDashboardCardInfo`) and used to construct a `companyFilter` which is then applied directly to the SQL queries for both delivery and vessel arrival. The original `useWhere` variable is still present but not explicitly used for `CompanyName` filtering.
        *   **Added `console.log` for Error in `getDeliveryData` (10:49:15 PM):** A `console.log(error);` is added within the catch block of `getDeliveryData`.
        *   **Refactored `getDeliveryData` CompanyName Filtering (10:51:27 PM):** The `CompanyName` retrieval in `getDeliveryData` is explicitly commented out (`// const CompanyName = (...)`) and replaced with a `CompanyName` parameter directly from `req.query`. A safer `companyFilter` is introduced using `LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')` to prevent SQL injection and ensure case-insensitive matching. The `useWhere` for `getDeliveryData` is still there.
        *   **Removed `CompanyName` retrieval in `getDashboardCardInfo` (11:06:35 PM):** The dynamic `CompanyName` retrieval using `getUserObject` in `getDashboardCardInfo` is commented out, reverting it to directly use `CompanyName` from `req.query`.
        *   **Logging SQL query for `getDashboardCardInfo` (11:10:55 PM):** Changed `logger.info(`sql query :: ${baseQuery}`);` to `logger.info(`sql query :: 1234${baseQuery}`);` to make the log entry more distinct. This change is repeated in the next commit.
        *   **Logging `companyFilter` in `getDeliveryData` (11:11:09 PM):** Added `console.log("companyFilter", companyFilter);` in `getDeliveryData`.
        *   **Safe Handling of `CompanyName` in `getDashboardCardInfo` (11:13:53 PM):** The `CompanyName` in the `getDashboardCardInfo` query is now handled more robustly by allowing it to be an empty string if not present and applying `.replace(/'/g, "''")` for SQL injection prevention.
        *   **Minor change in `getDeliveryData` `console.log` (11:23:11 PM):** No significant functional change, likely just a re-save.

3.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 8:51:00 PM and 8:51:46 PM.
    *   **Updates:**
        *   **Initial Functions (8:51:00 PM):** Defines `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`.
            *   `login`: Handles user authentication, queries `mtr_user_master`, validates credentials and user status, creates a JWT token, and returns user data.
            *   `saveUserPreferences`: Inserts or updates user preferences in `v2_user_details`, including basic info, email/push configs, and event configs.
            *   `fetchUserPreferences`: Retrieves user preferences by joining `mtr_user_master` and `v2_user_details`.
            *   `saveInviteLog`: Records user invitation details in `v2_user_invite_log` and sends an invitation email.
            *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company.
            *   `userSettings`: Fetches user-specific settings, primarily `date_format`.
        *   **Minor Edits (8:51:15 PM, 8:51:46 PM):** These appear to be minor saving events without significant functional changes. The code remains largely identical.

4.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp:** 11/6/2025, 1:27:09 PM
    *   **Updates:**
        *   Introduced `getAll` function for retrieving shipment data with various filters (pagination, POL, POD, shipment ID, status, date range, `orderBy`, `cardFilter`, `contno`, `viewType`).
        *   Implemented `SqlQueryBuilder` class to dynamically construct SQL queries based on user roles and filters, including specific conditions for "ADMIN", "CUSTOMER", "FRONTOFFICE", and "AGENT" roles.
        *   Added `buildCardFilterCondition` to filter shipments based on dashboard card types (pending departure, in transit, ETA within 1 week, out for delivery).
        *   Logic to determine shipment status (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields from `mtr_tracking_data`.

5.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 between 2:02:45 PM and 7:11:07 PM, and on 11/7/2025 between 9:51:09 AM and 9:51:33 AM.
    *   **Updates:**
        *   **Initial Structure (2:02:45 PM):** Introduced `BookingQueryBuilder` class and `getAll`, `saveBooking` functions.
            *   `BookingQueryBuilder`: A class to construct SQL queries for booking data, handling pagination, ordering, user-specific conditions (ADMIN, CUSTOMER, SPR_CUSTOMER based on `companyname`/`location`), and various search/filter clauses for booking status, POL, POD, shipper, etc.
            *   `getAll`: Fetches booking records using `BookingQueryBuilder`, provides counts for different booking statuses (ALL, PENDING, APPROVED, CANCELLED, NEW), and retrieves unique options for filters like POL, POD, shipper, booking type, and status.
            *   `saveBooking`: Handles saving new booking records, sanitizes input, and uses `AppDateFormate` for date fields.
        *   **Added `est_cargo_ready_date` (2:05:16 PM):** `abe.est_cargo_ready_date` was added to `selectedColumns` in `BookingQueryBuilder`.
        *   **Added `CargoReadyFromDate` and `CargoReadyToDate` (2:16:39 PM):** New properties `CargoReadyFromDate` and `CargoReadyToDate` were added to `BookingQueryBuilder`, and the `setDateRange` method was updated to include filtering by `abe.est_cargo_ready_date`.
        *   **Refactored `whereClauses` and `addDateRangeClause` (2:26:13 PM):** `whereClauses` in `BookingQueryBuilder` was changed from a single string to an array (`string[]`), and the `addDateRangeClause` was made a private method, handling date ranges more flexibly (e.g., `fromDate` only, `toDate` only, or both). The way `finalWhere` is constructed was updated to join the `whereClauses` array.
        *   **Reverted `whereClauses` (2:27:15 PM):** The `whereClauses` property was reverted back to a single `string` type, undoing the array change from the previous commit. The `addDateRangeClause` method was also reverted to its previous public single-date-range form. This indicates a quick rollback or refactoring.
        *   **Minor change to `getAll` parameters (5:05:22 PM):** Added `NextFunction, Response` imports to `bookingService.ts` but not used in the provided code snippets. This seems like a preparatory or leftover import.
        *   **Minor change (5:05:30 PM):** No significant functional changes compared to the previous state.
        *   **Correction in `buildCountQuery` (5:57:33 PM):** The `SELECT COUNT(DISTINCT abe.agent_booking_id)` in `buildCountQuery` was accidentally truncated to `SELECT COUNTabe.agent_booking_id)`.
        *   **Fixed `buildCountQuery` (5:57:41 PM):** The truncation in `buildCountQuery` was corrected back to `SELECT COUNT(abe.agent_booking_id)`.
        *   **Added `CONFIRMED` Booking Status (6:03:28 PM, 6:03:51 PM, 7:11:07 PM):** The `BookingStatus` enum and the `setWhereClause` method in `BookingQueryBuilder` were updated to include a `CONFIRMED` status. The `getAll` function also started calculating counts for the new `CONFIRMED` status.
        *   **Renamed `CargoReadyFromDate` to `cargoReadyFromDate` (9:51:09 AM, 9:51:33 AM):** The public properties `CargoReadyFromDate` and `CargoReadyToDate` in `BookingQueryBuilder` were renamed to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase `c` for `cargo`).

6.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:22 PM, 5:13:57 PM, 7:20:31 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` (5:06:22 PM):** A new path `Booking.getBookingApproveDetails` was added, pointing to `/booking_approve/:agent_booking_id`.
        *   **Added `createBookingApproveDetails` (5:13:57 PM):** Another path `Booking.createBookingApproveDetails` was added, also pointing to `/booking_approve/:agent_booking_id`. This suggests an intent for both GET and POST operations on the same URL.
        *   **Minor formatting/resave (7:20:31 PM):** No functional changes observed.

7.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:41 PM, 5:15:38 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` route (5:06:41 PM):** A `GET` route for `Paths.Booking.getBookingApproveDetails` was added, mapped to the `getBookingApproveDetails` service function.
        *   **Added `updateBookingApproveDetails` route (5:15:38 PM):** A `POST` route for `Paths.Booking.createBookingApproveDetails` was added, mapped to a new `updateBookingApproveDetails` service function.

### Patterns and Recurring Elements:

*   **Date-related filters:** Both `dashboardService.ts` and `bookingService.ts` extensively use `fromDate`, `toDate`, and in some cases `cargoReadyFromDate`, `cargoReadyToDate` for filtering data by date ranges.
*   **User-specific conditions:** Most data retrieval functions (`getDashboardCardInfo`, `getDeliveryData`, `getAll` in `shipmentService` and `bookingService`) incorporate logic (`buildMtrUserCondition`, `userWhere`) to filter data based on the authenticated user's role (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/location.
*   **SQL Query Builders:** The `shipmentService.ts` and `bookingService.ts` files utilize dedicated `SqlQueryBuilder` and `BookingQueryBuilder` classes, respectively, to construct complex SQL queries dynamically. This pattern promotes code organization, reusability, and parameterization of queries.
*   **Pagination and Ordering:** Both `shipmentService.ts` and `bookingService.ts` implement pagination (`page`, `pageSize`/`perPage`, `offset`) and sorting (`orderBy`) for their `getAll` functions.
*   **Error Handling and Logging:** All service functions consistently include `try-catch` blocks for error handling, returning `HttpStatusCodes.INTERNAL_SERVER_ERROR` on failure, and frequently log information and errors using `logger.info` and `logger.error`.
*   **HTTP Status Codes:** `HttpStatusCodes` from `@src/common/constants/HttpStatusCodes` are consistently used for setting response statuses.
*   **SQL Injection Prevention:** In `dashboardService.ts`, the `CompanyName` in SQL queries is now handled with `.replace(/'/g, "''")` to escape single quotes, indicating an improvement in security practices.
*   **Consistent File Paths:** All files follow a structured path convention (`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\...`).
*   **Redundant Saves:** Several entries for `dashboardService.ts` and `UserService.ts` show identical code content with slightly different timestamps, indicating frequent saves during development.
*   **Evolution of Query Parameters:** There's an observable pattern of refining how query parameters, especially `CompanyName` and date ranges, are extracted and applied to SQL queries for both safety and flexibility.

## 11:44:46 AM
Overall, the code changes indicate active development and refinement across several core backend functionalities, primarily focusing on data retrieval, filtering, and user management. There is a strong emphasis on implementing role-based access control and dynamic query construction. Recurring patterns include frequent saves (resulting in near-identical code logs), iterative debugging via `console.log` statements, and continuous improvement in SQL query handling, including addressing potential injection vulnerabilities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **(11/5/2025, 12:54:56 PM)**: An `AuthRoutes` router was established with a `GET /auth/verify-token` endpoint. This endpoint is responsible for returning authenticated user information (`req.user`) after token verification.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **(11/5/2025, 6:04:50 PM - 6:06:01 PM)**: Initial implementation of `getDashboardCardInfo` and `getDeliveryData`. `getDashboardCardInfo` calculates shipment metrics (pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents using complex SQL queries with date, company name, and user role-based filtering. `getDeliveryData` fetches delivery/vessel arrival data with mode-specific filtering.
    *   **(11/5/2025, 8:41:51 PM)**: `getDashboardCardInfo` was updated to dynamically derive `CompanyName` using `getUserObject` (from `@src/utils/analytics`) instead of directly from `req.query`, enhancing user-specific data access.
    *   **(11/5/2025, 8:42:22 PM)**: A debugging `console.log` for `req.CompanyName` was added in `getDashboardCardInfo`.
    *   **(11/5/2025, 10:41:50 PM)**: `CompanyName` was removed from direct destructuring in `req.query` for `getDashboardCardInfo`, confirming its derivation from `getUserObject`.
    *   **(11/5/2025, 10:43:59 PM)**: The user-specific condition (`useWhere`) was commented out for `getDashboardCardInfo`, potentially broadening the scope of the dashboard card data or temporarily disabling granular user-level filtering.
    *   **(11/5/2025, 10:44:51 PM)**: A debugging `console.log` for the `result[0]` was added after fetching dashboard card info.
    *   **(11/5/2025, 10:46:26 PM)**: `getDeliveryData` introduced logic to fetch `CompanyName` via `getUserObject` and attempted to apply it as a filter in its SQL queries. However, the direct string concatenation for `CompanyName` in the SQL made it vulnerable to SQL injection.
    *   **(11/5/2025, 10:49:15 PM)**: A `console.log` for error objects was added in the `getDeliveryData` catch block.
    *   **(11/5/2025, 10:51:27 PM)**: Crucially, `getDeliveryData` was refactored for safer SQL query construction. The `CompanyName` was reintroduced to `req.query` destructuring, and a `companyFilter` variable was implemented to properly sanitize and case-insensitively apply the company name to the SQL queries (`LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')`), mitigating the SQL injection vulnerability.
    *   **(11/5/2025, 11:06:35 PM)**: `getDeliveryData` reverted `CompanyName` to be derived from `getUserObject` (commenting out the `req.query` destructuring for `CompanyName`), but kept the safe `companyFilter` logic.
    *   **(11/5/2025, 11:07:02 PM)**: `getDashboardCardInfo` reverted to directly destructuring `CompanyName` from `req.query`, undoing the `getUserObject` derivation for this function.
    *   **(11/5/2025, 11:10:55 PM)**: A debugging `logger.info` with a prefix "1234" was added to log the `baseQuery` in `getDashboardCardInfo`.
    *   **(11/5/2025, 11:11:09 PM)**: A debugging `console.log` for `companyFilter` was added in `getDeliveryData`.
    *   **(11/5/2025, 11:13:53 PM)**: In `getDashboardCardInfo`, the `CompanyName` parameter within the SQL query was further enhanced for safety by using `LOWER(account_name) = LOWER('${CompanyName?.replace(/'/g, "''") || ""}')`, ensuring it handles null/undefined values and escapes quotes.
    *   **(11/5/2025, 11:23:11 PM)**: No functional changes from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **(11/5/2025, 8:51:00 PM - 8:51:46 PM)**: This file defines a suite of user management services including `login` (which has a SQL injection vulnerability due to direct string concatenation), `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. Most of these methods use parameterized queries for safer database interaction, except for `login`. Consecutive entries are identical.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **(11/6/2025, 1:27:09 PM)**: Introduced an `getAll` function and a `SqlQueryBuilder` class for managing shipment data. The `SqlQueryBuilder` dynamically constructs SQL queries with pagination, various filters (POL, POD, status, date range, container number), and implements extensive user role-based access control (ADMIN, CUSTOMER, FRONTOFFICE, AGENT). It also includes detailed logic for determining `ShipmentStatus` based on tracking data and adds a `buildCardFilterCondition` method to support dashboard-specific filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **(11/6/2025, 2:02:45 PM)**: Introduced a `BookingQueryBuilder` class and `getAll` function for fetching and filtering booking data. It supports various query parameters and user role-based conditions. An outline for `saveBooking` was also present.
    *   **(11/6/2025, 2:05:16 PM)**: Added `est_cargo_ready_date` to the selected columns in `BookingQueryBuilder`, indicating new data fetching requirements.
    *   **(11/6/2025, 2:16:39 PM)**: Enhanced `BookingQueryBuilder` to support filtering by `CargoReadyFromDate` and `CargoReadyToDate` for estimated cargo ready dates.
    *   **(11/6/2025, 2:26:13 PM)**: Attempted to refactor `whereClauses` to an array for more flexible query construction, but this introduced a potential bug by mixing string and array assignments.
    *   **(11/6/2025, 2:27:15 PM)**: The `whereClauses` refactoring was reverted, restoring it to a single string property and fixing the introduced bug.
    *   **(11/6/2025, 5:05:22 PM - 5:05:30 PM)**: Minor import changes without functional impact.
    *   **(11/6/2025, 5:57:33 PM)**: Introduced a counting inaccuracy in `buildCountQuery` by removing `DISTINCT`.
    *   **(11/6/2025, 5:57:41 PM)**: The counting inaccuracy in `buildCountQuery` was immediately corrected by restoring `DISTINCT`.
    *   **(11/6/2025, 6:03:28 PM - 6:03:51 PM)**: Added a `CONFIRMED` status to the `BookingStatus` enum and updated `setWhereClause` to handle this new status.
    *   **(11/7/2025, 9:51:09 AM - 11:43:35 AM)**: Renamed `CargoReadyFromDate`/`CargoReadyToDate` properties to `cargoReadyFromDate`/`cargoReadyToDate` (camelCase) for consistency.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **(11/6/2025, 6:02:57 PM)**: Expanded the `BookingStatus` enum to include `CONFIRMED` and added `blno` to `BookingQueryType`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **(11/6/2025, 5:06:22 PM)**: Added a new `getBookingApproveDetails` path under `/booking`.
    *   **(11/6/2025, 5:13:57 PM)**: Added a `createBookingApproveDetails` path, reusing the same endpoint as `getBookingApproveDetails`, suggesting a POST route for updates.
    *   **(11/6/2025, 7:20:31 PM)**: No functional changes from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **(11/6/2025, 5:06:41 PM)**: Defined a `GET` route for `getBookingApproveDetails`.
    *   **(11/6/2025, 5:15:38 PM)**: Defined a `POST` route for `createBookingApproveDetails`, mapping it to an `updateBookingApproveDetails` handler in the booking service.

**Key Patterns and Recurring Elements:**

1.  **Iterative Development and Debugging:** The numerous identical timestamps or very close timestamps (e.g., in `dashboardService.ts` and `UserService.ts` on 11/5, and `bookingService.ts` on 11/6) suggest frequent saving, possibly auto-formatting, or rapid minor changes/debugging. The addition and removal of `console.log` statements are clear indicators of active debugging.
2.  **Dashboard & Booking Service Refinements:** A significant portion of the changes centers around improving the dashboard data and booking management features. This includes expanding filtering capabilities (date ranges, company names, specific statuses) and enhancing how data is retrieved and presented.
3.  **Dynamic SQL Query Construction:** Both `dashboardService` and `bookingService` employ builder patterns (`SqlQueryBuilder`, `BookingQueryBuilder`) to construct complex SQL queries dynamically based on user inputs and roles. This is a recurring architectural pattern for data access.
4.  **Security Improvements (SQL Injection):** There's a noticeable evolution in `dashboardService.ts` from direct, vulnerable string concatenation for `CompanyName` in SQL queries to a safer, sanitized approach using `replace(/'/g, "''")` and `LOWER()`. This indicates a conscious effort to improve security posture, though the `login` function in `UserService.ts` still uses direct concatenation.
5.  **Role-Based Access Control (RBAC):** Both `shipmentService` and `bookingService` explicitly implement logic to filter data based on the authenticated user's role (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT), ensuring users only see relevant data for their permissions.
6.  **Feature Expansion:** The addition of `est_cargo_ready_date` in booking details, the introduction of a `CONFIRMED` booking status, and new routes for booking approval details indicate ongoing feature development to enhance the booking workflow.
7.  **Minor Refactoring and Consistency:** Changes like renaming `CargoReadyFromDate` to `cargoReadyFromDate` (camelCase) show efforts towards code style consistency. Reverting problematic refactoring (e.g., `whereClauses` to an array in `bookingService`) demonstrates a quick response to code issues.

## 12:45:07 PM
The log details recent development and refinement of several backend services for the T360-V2 application. Key updates span authentication, dashboard data presentation, user management, shipment tracking, and booking functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **(11/5/2025, 12:54:56 PM):** Initial setup of a `/verify-token` GET endpoint. This route is designed to log and return authenticated user information, confirming token validity.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **(11/5/2025, 6:04:50 PM):** Introduced `getDashboardCardInfo` and `getDeliveryData` functions.
        *   `getDashboardCardInfo` dynamically generates SQL queries to retrieve shipment statistics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) based on `fromDate`, `toDate`, and `CompanyName` from the request query. It includes a `buildMtrUserCondition` for user-specific data filtering.
        *   `getDeliveryData` fetches either delivery or vessel arrival data, applying various mode-specific filters ('ALL', 'Rail Delivery', 'Door Delivery', 'Port Delivery').
    *   **(11/5/2025, 8:41:51 PM):** Modified `getDashboardCardInfo` to derive `CompanyName` using an asynchronous `getUserObject` utility instead of directly from `req.query`, enhancing user-specific data access logic. An import for `getUserObject` was added.
    *   **(11/5/2025, 8:42:22 PM):** Added a `console.log` for the derived `CompanyName` in `getDashboardCardInfo` for debugging purposes.
    *   **(11/5/2025, 10:41:50 PM):** Refined the type assertion for `req.query` in `getDashboardCardInfo`, removing `CompanyName` as a direct query parameter type, reflecting its new derivation.
    *   **(11/5/2025, 10:43:59 PM):** Commented out the application of `buildMtrUserCondition` (`useWhere`) to the `cardQuery` in `getDashboardCardInfo`, indicating a temporary or intentional change in how user-specific conditions affect dashboard card data.
    *   **(11/5/2025, 10:46:26 PM):** Introduced `CompanyName` derivation via `getUserObject` into `getDeliveryData` and applied it as a filter in the SQL queries (`sqlQueryDelivery`, `SqlQueryVesselArrival`). This change, however, initially involved direct string concatenation (`'AND '+CompanyName`), raising potential SQL injection concerns.
    *   **(11/5/2025, 10:51:27 PM):** Implemented a safer SQL injection prevention mechanism in `getDeliveryData`. The `CompanyName` is now escaped using `replace(/'/g, "''")` within a `companyFilter` variable before being used in SQL query strings.
    *   **(11/5/2025, 11:06:35 PM) & (11/5/2025, 11:07:02 PM):** Reverted the `CompanyName` derivation from `getUserObject` in both `getDeliveryData` and `getDashboardCardInfo`, making it directly sourced from `req.query` parameters again.
    *   **(11/5/2025, 11:13:53 PM):** Re-introduced proper sanitization for `CompanyName` in `getDashboardCardInfo`'s `baseQuery`, using `LOWER(account_name) = LOWER('${CompanyName?.replace(/'/g, "''") || ""}')` for safer and case-insensitive filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **(11/5/2025, 8:51:00 PM):** Initial implementation of core user management functions:
        *   `login`: Handles user authentication, validates credentials, checks account status, and generates a JWT token.
        *   `saveUserPreferences`: Allows users to save or update personal preferences and notification settings.
        *   `fetchUserPreferences`: Retrieves user preferences, potentially combining data from multiple tables.
        *   `saveInviteLog`: Logs user invitations and sends invite emails.
        *   `fetchAllCompanyUser`: Fetches a list of active and pending users for a given company.
        *   `userSettings`: Retrieves specific user settings like `date_format`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **(11/6/2025, 1:27:09 PM):** Introduced `getAll` function for retrieving shipment data. It utilizes a `SqlQueryBuilder` class to construct dynamic SQL queries based on various filters (POL, POD, status, date range, card filters) and user roles, including complex logic for determining shipment status (Pending, Loading, In_Transit, Arrived, Delivered, Custom_Hold) from `mtr_tracking_data`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **(11/6/2025, 2:02:45 PM):** Initial implementation of booking management with `getAll` and `saveBooking`.
        *   A `BookingQueryBuilder` class was introduced for dynamic SQL generation, supporting pagination, sorting, searching, and filtering by `BookingStatus` (PENDING, APPROVED, CANCELLED, NEW, ALL) and user role.
        *   `saveBooking` handles creating and updating booking records, including data sanitization.
    *   **(11/6/2025, 2:05:16 PM):** Added `abe.est_cargo_ready_date` to the selected columns in `BookingQueryBuilder`.
    *   **(11/6/2025, 2:16:39 PM):** Expanded `BookingQueryBuilder` to include `CargoReadyFromDate` and `CargoReadyToDate` for filtering, and updated `setDateRange` to incorporate these new date ranges.
    *   **(11/6/2025, 2:26:13 PM):** Attempted a refactoring where the `addDateRangeClause` in `BookingQueryBuilder` was modified. The prior public `addDateRangeClause` (which added to `extraConditions`) was commented out, and a new *private* `addDateRangeClause` was introduced which *attempted* to add conditions to `this.whereClauses`. This change likely introduced a bug as `this.whereClauses` is a string, not an array.
    *   **(11/6/2025, 2:27:15 PM):** The problematic refactoring from the previous commit was reverted, restoring the `BookingQueryBuilder` to its prior functional state.
    *   **(11/6/2025, 5:57:33 PM):** Introduced a SQL syntax error in `BookingQueryBuilder`'s `buildCountQuery` by truncating `COUNT(DISTINCT abe.agent_booking_id)` to `COUNTabe.agent_booking_id)`.
    *   **(11/6/2025, 5:57:41 PM):** Corrected the SQL syntax error in `buildCountQuery` but removed the `DISTINCT` keyword, changing `COUNT(DISTINCT abe.agent_booking_id)` to `COUNT(abe.agent_booking_id)`.
    *   **(11/6/2025, 6:03:28 PM):** Integrated the new `CONFIRMED` booking status into `BookingQueryBuilder`'s `setWhereClause` and `getAll`'s status counts.
    *   **(11/7/2025, 9:51:09 AM):** Performed a minor refactoring in `BookingQueryBuilder`, renaming `CargoReadyFromDate` and `CargoReadyToDate` properties and parameters to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase 'c').

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **(11/6/2025, 6:02:57 PM):** Added `CONFIRMED` status to the `BookingStatus` enum. Included `blno: string` in `BookingQueryType` and `companyname: string` in `AuthReqUser`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **(11/6/2025, 5:06:22 PM):** Initial comprehensive definition of application API paths across various modules. Specific booking paths include `/get-booking`, `/save-booking`, `/aprox-transit`, and `/booking_approve/:agent_booking_id`.
    *   **(11/6/2025, 5:13:57 PM):** Added `createBookingApproveDetails: "/booking_approve/:agent_booking_id"`, which uses the same path as `getBookingApproveDetails`.
    *   **(11/7/2025, 12:17:18 PM):** Introduced `vesselAdd: "/vessel/:agent_booking_id"` to the `Booking` paths.
    *   **(11/7/2025, 12:24:55 PM):** Modified `vesselAdd` path from `"/vessel/:agent_booking_id"` to `"/vessel"`, removing the `agent_booking_id` from the URL parameter.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **(11/6/2025, 5:06:41 PM):** Configured Express routes for booking functionality, mapping `GET /get-booking`, `POST /save-booking`, `GET /aprox-transit`, and `GET /booking_approve/:agent_booking_id` to respective service functions.
    *   **(11/6/2025, 5:15:38 PM):** Added a new `POST` route for `Paths.Booking.createBookingApproveDetails` which maps to `updateBookingApproveDetails` service function.
    *   **(11/7/2025, 12:17:36 PM):** Added a new `POST` route for `Paths.Booking.vesselAdd`, mapping to the `addBookingVessel` service function.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Query Building:** A consistent pattern across `dashboardService`, `shipmentService`, and `bookingService` is the extensive use of dedicated builder classes (`SqlQueryBuilder`, `BookingQueryBuilder`) to construct complex SQL queries. These builders handle pagination, sorting, and various filtering criteria dynamically.
*   **User-Role Based Access Control (RBAC):** Data retrieval and filtering logic frequently incorporate `req.user.role` (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/location information to ensure appropriate data visibility and security.
*   **Query Parameter-Driven Filtering:** Functions across services heavily rely on `req.query` for filtering, searching, and date range specification, indicating a flexible API design.
*   **SQL Injection Prevention Evolution:** There's an observable progression in `dashboardService` towards safer SQL query construction. Initial direct string concatenations for `CompanyName` were replaced with methods that sanitize input by escaping single quotes (`.replace(/'/g, "''")`), though this was subject to temporary reverts and re-implementations.
*   **Comprehensive Logging:** `logger.info` and `logger.error` are widely used across the services for debugging, tracking request parameters, and reporting execution flow and errors.
*   **Date Range Filtering:** The ability to filter data using `fromDate` and `toDate` (and `cargoReadyFromDate`/`cargoReadyToDate` for bookings) is a recurring requirement, implemented with dedicated helper methods.
*   **Endpoint Definition and Routing:** `Paths.ts` serves as a central registry for all API endpoints, which are then wired up to service functions in corresponding route files (e.g., `BookingRoutes.ts`), showcasing a structured approach to API management.
*   **Iterative Development:** The multiple identical code entries (e.g., in `dashboardService.ts` and `bookingService.ts` on consecutive timestamps) suggest an iterative development process with frequent saves or minor cosmetic changes. There are also instances of introducing and then quickly correcting errors, such as the SQL syntax error in `bookingService.ts`.

## 1:44:49 PM
The changes log shows concentrated development activity primarily on the `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, and `bookingService.ts` files, alongside updates to routing definitions in `Paths.ts` and `BookingRoutes.ts`. All timestamps fall within November 5th to 7th, 2025, indicating focused work over a few days.

**File-Specific Updates:**

*   **`src\routes\AuthRoutes.ts` (11/5/2025, 12:54:56 PM):** This file defines a basic authentication route `/auth/verify-token` that simply returns the authenticated user's information from `req.user`.

*   **`src\services\dashboardService.ts` (Multiple updates from 11/5/2025, 6:04:50 PM to 11:23:11 PM):**
    *   **Initial Implementation & Refinement (6:04:50 PM - 6:06:01 PM):** Introduced `getDashboardCardInfo` (fetching shipment stats like Pending Departure, In Transit, ETA within 1 week, Out for Delivery, along with TEU calculations) and `getDeliveryData` (fetching delivery or vessel arrival data). Both functions use dynamic SQL queries, apply user-specific conditions (`buildMtrUserCondition`), and filter by date range and company name.
    *   **Dynamic CompanyName Resolution (8:41:51 PM - 8:42:22 PM):** The `getDashboardCardInfo` function was updated to dynamically fetch `CompanyName` using a `getUserObject` utility, rather than relying solely on query parameters, suggesting enhanced user-specific data fetching. Debugging `console.log` statements were added.
    *   **Conditional Filtering Change (10:43:59 PM):** The `getDashboardCardInfo` function's `useWhere` condition (from `buildMtrUserCondition`) was commented out, effectively disabling user-specific MTR conditions for dashboard card information.
    *   **Company Filtering Logic Evolution (10:46:26 PM - 11:13:53 PM):**
        *   `getDeliveryData` initially introduced a direct (and potentially insecure) method of filtering by `CompanyName` by concatenating `CompanyName` into the SQL query string.
        *   This was quickly corrected (10:51:27 PM) to implement safer SQL filtering using `LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')`, addressing potential SQL injection vulnerabilities and ensuring proper case-insensitive matching.
        *   `CompanyName` parameter handling in `getDeliveryData` was adjusted to be passed directly in the query parameters for `getDashboardCardInfo` as well.
        *   Minor debugging logs (`console.log`, `logger.info`) were added throughout these updates.
        *   The SQL query for `getDashboardCardInfo` was refined to handle potentially undefined `CompanyName` more gracefully and safely escape single quotes within the company name (11:13:53 PM).

*   **`src\services\UserService.ts` (Multiple updates from 11/5/2025, 8:51:00 PM to 8:51:46 PM):**
    *   **New User Management Features (8:51:00 PM):** This file received significant additions, introducing several new functionalities:
        *   `saveUserPreferences`: Allows users to save/update basic information, contact details, time zone, language, date format, and various notification preferences (shipment updates, delivery alerts, weekly reports, critical alerts, status changes, marketing updates, two-factor authentication, and specific T49 event configurations) into a `v2_user_details` table using an upsert mechanism.
        *   `fetchUserPreferences`: Retrieves the saved user preferences, falling back to `mtr_user_master` for basic info if `v2_user_details` is empty.
        *   `saveInviteLog`: Records user invitation details, including username, email, role, company name, status, and creator, into a `v2_user_invite_log` table with upsert logic, and triggers an invite email.
        *   `fetchAllCompanyUser`: Gathers a list of both active registered users (`mtr_user_master`) and pending invited users (`v2_user_invite_log`) for the requesting user's company.
        *   `userSettings`: Fetches specific user settings like `date_format` from `v2_user_details`.
    *   The `login` function for user authentication and JWT creation remained unchanged in content during these updates.
    *   Subsequent entries (8:51:15 PM, 8:51:46 PM) show identical code, suggesting saves without further modifications.

*   **`src\services\shipmentService.ts` (11/6/2025, 1:27:09 PM):**
    *   A comprehensive `getAll` function was added to fetch shipment data with extensive filtering capabilities.
    *   Introduced a `SqlQueryBuilder` class to dynamically construct SQL queries for shipment data, including filtering by `pol`, `pod`, `shipment_id`, status, date range, and special "card filters" (e.g., `pending_departure`, `in_transit`).
    *   The `getAll` function dynamically assigns a `status` label (e.g., Pending, Loading, In-Transit, Delivered) to shipments based on various date and hold information from `mtr_tracking_data`.
    *   Implemented detailed role-based access control within `SqlQueryBuilder.buildUserCondition` for 'ADMIN', 'CUSTOMER', 'FRONTOFFICE', and 'AGENT' users, including a special condition for "ZIGI USA, LLC" customers.

*   **`src\services\bookingService.ts` (Multiple updates from 11/6/2025, 2:02:45 PM to 11/7/2025, 1:14:19 PM):**
    *   **Initial Booking Management (11/6/2025, 2:02:45 PM):** Introduced `getAll` to fetch booking records and `saveBooking` (partially shown). A `BookingQueryBuilder` class was created to handle pagination, sorting, search, filter, and date range conditions for booking queries, including role-based data access. It also provides counts for different booking statuses and options for various filter fields.
    *   **Cargo Ready Date Filter (11/6/2025, 2:05:16 PM - 2:16:39 PM):** `est_cargo_ready_date` was added to the selected columns and new query parameters (`CargoReadyFromDate`, `CargoReadyToDate`) were introduced to filter bookings by cargo ready date.
    *   **Temporary Refactoring & Rollback (11/6/2025, 2:26:13 PM - 2:27:15 PM):** A brief attempt to refactor `whereClauses` into an array and modify `addDateRangeClause` was introduced but then reverted almost immediately, suggesting it was deemed problematic or unnecessary.
    *   **Count Query Correction (11/6/2025, 5:57:33 PM - 5:57:41 PM):** A minor bug in `buildCountQuery` that removed `COUNT(DISTINCT ...)` was introduced and then corrected to `COUNT(...)`, removing the `DISTINCT` keyword.
    *   **New Booking Status (11/6/2025, 6:03:28 PM):** A `CONFIRMED` booking status was added to `BookingStatus` enum, and the `BookingQueryBuilder` and `getAll` function were updated to support filtering and counting bookings by this new status.
    *   **Property Name Consistency (11/7/2025, 9:51:09 AM):** Class properties `CargoReadyFromDate` and `CargoReadyToDate` were renamed to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase).
    *   Many subsequent timestamps (11/7/2025, 9:51:33 AM to 1:14:19 PM) show no functional changes, indicating either repeated saves or debugging steps.

*   **`src\common\constants\Paths.ts` (Multiple updates from 11/6/2025, 5:06:22 PM to 11/7/2025, 12:24:55 PM):**
    *   **Booking Approval Endpoints (11/6/2025, 5:06:22 PM - 5:13:57 PM):** Added new paths `Booking.getBookingApproveDetails` and `Booking.createBookingApproveDetails`, both pointing to `/booking_approve/:agent_booking_id`.
    *   **Booking Vessel Endpoint (11/7/2025, 12:17:18 PM - 12:24:55 PM):** A new path `Booking.vesselAdd` was added, initially with a path parameter (`/vessel/:agent_booking_id`), but then changed to a non-parameterized route (`/vessel`).

*   **`src\routes\BookingRoutes.ts` (Multiple updates from 11/6/2025, 5:06:41 PM to 11/7/2025, 1:14:50 PM):**
    *   **Booking Approval Routes (11/6/2025, 5:06:41 PM - 5:15:38 PM):** Corresponding GET and POST routes were added for booking approval details, mapping to `getBookingApproveDetails` and `updateBookingApproveDetails` from `bookingService`.
    *   **Booking Vessel Route (11/7/2025, 12:17:36 PM - 1:14:50 PM):** A POST route for `Paths.Booking.vesselAdd` was added, initially mapping to `addBookingVessel` and later updated to `addOrUpdateBookingVessel` from `bookingService`.

**Patterns and Recurring Elements:**

*   **Query Building Classes:** The use of `SqlQueryBuilder` (for shipments) and `BookingQueryBuilder` (for bookings) is a strong pattern, centralizing SQL generation, filtering, pagination, and sorting logic. This indicates an effort towards maintainable and extensible data access layers.
*   **Role-Based Data Access:** Filtering data based on user roles (`ADMIN`, `CUSTOMER`, `FRONTOFFICE`, `AGENT`) is consistently applied across `dashboardService`, `shipmentService`, and `bookingService`, ensuring data visibility adheres to user permissions.
*   **Dynamic Filtering:** All `getAll` functions leverage query parameters for dynamic filtering, searching, and sorting of data.
*   **Timestamp-Based Status Calculation:** Shipment status in `shipmentService` is dynamically determined based on a series of date comparisons, reflecting a business logic for tracking shipment progress.
*   **Emphasis on Logging:** `logger.info` and `logger.error` are frequently used across all modified services for debugging, operational monitoring, and error handling.
*   **Iterative Development:** The multiple identical or subtly different code entries for `dashboardService.ts` and `bookingService.ts` within short timeframes suggest an iterative development process, possibly involving frequent saves or small-step refactoring/debugging.
*   **Endpoint Expansion:** The `Paths.ts` file consistently evolves to include new API endpoints, such as those for booking approvals and vessel additions, reflecting the growth of backend functionalities.
*   **SQL Injection Prevention:** Explicit `replace(/'/g, "''")` for sanitizing company names in SQL queries was added, indicating a focus on security for dynamic query construction.

## 3:05:49 PM
The provided log details changes across several core backend files, primarily focusing on `AuthRoutes.ts`, `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`, and `Paths.ts`. All changes occurred on November 5th and 6th, 2025.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   **Update:** This file, responsible for authentication routes, has a `GET` endpoint (`/verify-token`) to retrieve user information (`req.user`) and return it with an `OK` status. The `login` service function is imported but not used in this specific endpoint.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Significant Changes:** Multiple timestamps between 11/5/2025, 6:04:50 PM and 11/5/2025, 11:13:53 PM.
    *   **Updates:** This service handles dashboard data, including `getDashboardCardInfo` and `getDeliveryData`.
        *   **`getDashboardCardInfo`**: Initially, `CompanyName` was directly taken from `req.query`. Later, a significant change was introduced (around 11/5/2025, 8:41:51 PM) to fetch `CompanyName` dynamically using `getUserObject` based on `req.user`, `req.query.companyname`, and `req.query.access`. This indicates an enhanced and more secure way of determining the company context for data retrieval. Further minor adjustments were made, including commenting out the `useWhere` condition related to user-specific filters for the `cardQuery` (from 11/5/2025, 10:43:59 PM onwards) and adding `console.log` statements for debugging. The `baseQuery` also evolved to explicitly use `LOWER(account_name) = '${CompanyName}'`.
        *   **`getDeliveryData`**: Similar to `getDashboardCardInfo`, the `CompanyName` retrieval logic was updated to use `getUserObject`. A "safe filter" `companyFilter` was introduced (around 11/5/2025, 10:51:27 PM) to prevent SQL injection by replacing single quotes in `CompanyName`. The `useWhere` condition was replaced with `companyFilter` in the `sqlQueryDelivery` and `SqlQueryVesselArrival` queries. There was also a temporary comment-out of the `getUserObject` call, indicating testing or a brief reversion, but it was re-instated and refined.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Significant Changes:** Multiple timestamps between 11/5/2025, 8:51:00 PM and 11/5/2025, 8:51:46 PM.
    *   **Updates:** This service manages user-related operations. The code snippets provided for this file are identical across all timestamps, showing no functional changes during this period. It includes `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings` functions. The `login` function handles user authentication and token generation, while `saveUserPreferences` and `fetchUserPreferences` manage user settings with `ON CONFLICT DO UPDATE` for upserting preferences. `saveInviteLog` records user invitation details, and `fetchAllCompanyUser` retrieves users based on company and invitation status.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp:** 11/6/2025, 1:27:09 PM
    *   **Update:** The `getAll` function in this service fetches shipment data. A new `SqlQueryBuilder` class was introduced to construct SQL queries based on user roles and various filters (e.g., `pol`, `pod`, `shipment_id`, `status`, `dateRange`, `cardFilter`, `contno`, `viewType`). The `buildCardFilterCondition` method now supports specific dashboard card filters like `pending_departure`, `in_transit`, `eta_within_1_week`, and `out_for_delivery`. The logic for determining `shipment.status` based on `mtr_tracking_data` fields has been refined. User-specific conditions are applied in `buildUserCondition` based on roles (ADMIN, CUSTOMER, FRONTOFFICE, AGENT), including specific handling for "ZIGI USA, LLC" customers.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Significant Changes:** Many timestamps between 11/6/2025, 2:02:45 PM and 11/7/2025, 2:19:28 PM.
    *   **Updates:** This service manages booking-related operations.
        *   **`BookingQueryBuilder` class**:
            *   **Initial change (11/6/2025, 2:05:16 PM)**: `est_cargo_ready_date` was added to `selectedColumns`.
            *   **Date Range Filters (11/6/2025, 2:16:39 PM)**: New properties `CargoReadyFromDate` and `CargoReadyToDate` were added to the class, and the `setDateRange` method was updated to handle these new cargo-ready date filters.
            *   **`whereClauses` type change (11/6/2025, 2:26:13 PM)**: `whereClauses` was changed from a string to a string array, and a new `addDateRangeClause` helper method was introduced to dynamically push conditions to this array, allowing for more flexible date range filtering. However, this change was immediately reverted back to a single string `whereClauses` in subsequent commits (e.g., 11/6/2025, 2:27:15 PM). This indicates a brief experimental change or a revert due to issues.
            *   **`buildCountQuery` fix (11/6/2025, 5:57:33 PM)**: The `COUNT(*)` in `buildCountQuery` was briefly changed to `COUNT(abe.agent_booking_id)`, then immediately corrected to `COUNT(DISTINCT abe.agent_booking_id)` in the very next commit (11/6/2025, 5:57:41 PM) to ensure distinct counts.
            *   **New Booking Status (11/6/2025, 6:03:28 PM)**: A `CONFIRMED` status was added to the `BookingStatus` enum and handled in the `setWhereClause` logic.
        *   **`getAll` function**: Updated to include new `cargoReadyFromDate` and `cargoReadyToDate` parameters for filtering. The `counts` object was also updated to include a count for the new `CONFIRMED` status.
        *   **`saveBooking` function**: No significant changes observed in the provided snippets for this function beyond what was already present.
        *   **`addBookingVessel` / `addOrUpdateBookingVessel`**: New function imports and routes indicate new functionality for adding or updating vessel details related to bookings.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Significant Changes:** Multiple timestamps between 11/6/2025, 5:06:22 PM and 11/7/2025, 12:24:55 PM.
    *   **Updates:** This file defines API paths.
        *   **Booking Route Expansion**: New routes `createBookingApproveDetails` (`POST`) and `vesselAdd` (`POST`, with a path change from `vessel/:agent_booking_id` to `vessel`) were added under the `Booking` base path. These additions reflect new functionality for booking approval details creation/update and vessel information management.
        *   **Redundant import removal (11/6/2025, 7:20:31 PM)**: The import `{ getBookingApproveDetails } from "@src/services/bookingService"` was removed from the top of the file, suggesting it was no longer needed directly in `Paths.ts`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Significant Changes:** Multiple timestamps between 11/6/2025, 5:06:41 PM and 11/7/2025, 1:14:50 PM.
    *   **Updates:** This file defines express routes for booking operations.
        *   **New Route for Booking Approval Details**: A `POST` route for `createBookingApproveDetails` was added, mapping to `updateBookingApproveDetails` service function. This indicates the creation/update logic for booking approvals.
        *   **New Route for Vessel Addition**: A `POST` route for `vesselAdd` was added. Initially mapped to `addBookingVessel`, it was quickly updated to `addOrUpdateBookingVessel`, suggesting a change in the service function's name or its combined create/update functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **Timestamp:** 11/6/2025, 6:02:57 PM
    *   **Update:** A new enum member `CONFIRMED = "CONFIRMED"` was added to the `BookingStatus` enum, reflecting a new state for booking requests. `cargoReadyFromDate` and `cargoReadyToDate` were added to `BookingQueryType` to support filtering bookings by cargo readiness dates.

**Patterns and Recurring Elements:**

*   **Date-related filters:** A consistent pattern of adding `fromDate`, `toDate`, `cargoReadyFromDate`, and `cargoReadyToDate` query parameters is observed across `dashboardService.ts` and `bookingService.ts`. This indicates a strong emphasis on time-based data filtering for both dashboard insights and booking management.
*   **User-centric filtering:** Both `dashboardService.ts` and `shipmentService.ts` implement `buildMtrUserCondition` and `buildUserCondition` respectively, which dynamically adjust query conditions based on the authenticated user's role (Admin, Customer, Front Office, Agent) and company/location. This ensures data access control and personalized views.
*   **Query Builder classes:** The use of `SqlQueryBuilder` (in `shipmentService.ts`) and `BookingQueryBuilder` (in `bookingService.ts`) demonstrates a pattern of encapsulating complex SQL query construction logic. These classes manage pagination, ordering, and various filtering conditions, improving code organization and reusability.
*   **Logging:** Extensive use of `logger.info` and `logger.error` throughout the services (`dashboardService.ts`, `UserService.ts`, `bookingService.ts`, `shipmentService.ts`) indicates a robust logging strategy for monitoring application flow, debugging, and error tracking.
*   **Error Handling:** All service functions consistently wrap their logic in `try-catch` blocks and return `HttpStatusCodes.INTERNAL_SERVER_ERROR` with a descriptive message on exceptions, ensuring graceful error handling.
*   **New `BookingStatus`:** The introduction of `CONFIRMED` booking status suggests an expansion of the booking workflow to include more granular states.
*   **Dashboard Logic Refinement:** The dashboard services show a progressive refinement in how `CompanyName` is determined (moving from direct query param to `getUserObject`) and how SQL queries are constructed (e.g., adding `LOWER()` for case-insensitive matching and explicit `CompanyName` filtering, along with SQL injection prevention for `CompanyName`).
*   **API Route Expansion:** The `Paths.ts` and `BookingRoutes.ts` files consistently show additions of new routes and their corresponding service functions, indicating continuous development and expansion of the API's capabilities, particularly around booking approval and vessel management.
*   **Minor Fixes/Refinements:** There are several instances of very close timestamps (e.g., within seconds or minutes) for the same file, suggesting quick iterations, debugging, or minor syntax adjustments. For example, the `buildCountQuery` correction in `bookingService.ts`.

## 4:16:03 PM
The provided log shows changes across three files, primarily focusing on booking-related functionalities in a React frontend application.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\coulmns\booking-coulmns.tsx` (Multiple Timestamps: 11/7/2025, 10:44:40 AM - 1:59:05 PM)**
    *   **Initial Changes (10:44 AM - 10:46 AM):** The `GET_BOOKING_COULMN` function, which defines columns for a booking data grid, underwent minor adjustments to the "Action" column. Specifically, its `minWidth` was changed from 170px to 150px, then to 120px, then 100px. Its `headerAlign` was also shifted from "left" to "right" and finally to "center".
    *   **Major Refactoring for `BOOKING_VESSEL_COLUMN_CUSTOMER` (10:49 AM - 11:13 AM):**
        *   The `BOOKING_VESSEL_COLUMN_CUSTOMER` array was converted into a function that accepts `onAdd`, `onEdit`, `editingRowId`, `onSave` as parameters. This change introduces dynamic behavior, allowing for adding, editing, and saving vessel details directly within the table.
        *   An "Action" column was added to `BOOKING_VESSEL_COLUMN_CUSTOMER`, featuring "Add Vessel" functionality (using `IoIosAddCircle`) and "Edit" buttons (using `MdEdit`).
        *   The `renderCell` for each column (e.g., `mother_feeder`, `vessel`, `etd`, `eta`, `cy_cutoff`, `docs_cutoff`) was updated to conditionally render an `InputBox` or a simple display of the value, based on whether the row is currently being edited (`editingRowId`).
        *   The `InputBox` component was imported.
    *   **Introducing `bookingStatus` parameter and Read-Only Logic (11:21 AM):** The `BOOKING_VESSEL_COLUMN_CUSTOMER` function was updated to accept `bookingStatus` as a new parameter. A `isLocked` variable was introduced to determine if the booking is "Approved" or "Cancelled". Input fields and action buttons within the vessel table are now disabled if `isLocked` is true, preventing further edits on approved/cancelled bookings. The "Add Vessel" icon's appearance and clickability are also conditional on `isLocked`.
    *   **Minor Adjustments and Console Logs (12:32 PM - 1:03 PM):** Several console logs were added for debugging the `editingRowId` and `params` within the `renderCell` of the action column.
    *   **Refining Button Labels and Styling (1:19 PM - 2:11 PM):**
        *   The "Update" button in the "Action" column of `BOOKING_VESSEL_COLUMN_CUSTOMER` dynamically changes its text to "Add Vessel" if the row is new (lacks a `serial_id`).
        *   Minor styling adjustments (`className="my-2"`) were added to `InputBox` components.
        *   The "Action" button in `GET_BOOKING_COULMN` for the main dashboard was renamed from "Action" to "Approved/Rejected" and its `minWidth` adjusted to 160px.
        *   The color of the "Add Vessel" icon was changed to `text-gray-500 hover:text-gray-700`.
        *   A `color="dark"` attribute was added to the "Add Vessel" / "Update Vessel" button within `BOOKING_VESSEL_COLUMN_CUSTOMER`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\booking\booking-view.tsx` (Multiple Timestamps: 11/7/2025, 10:46:47 AM - 2:15:25 PM)**
    *   **Initial Structure and UI Elements (10:46 AM):** This file defines the `BookingApproveContainer` component, which renders a form with PO, Inventory, Vessel, and Routing details using `Formik`. It includes `DynamicEditableTable`, `RadioSelectTable`, `AppTable`, `InputBox`, `Card`, and `Button` components. A `LocationPath` component visualizes POL/POD with icons.
    *   **Vessel Data Management and Editing Logic (11:05 AM - 1:22 PM):**
        *   State variables `vesselData` (for local vessel details) and `editingRowId` were introduced to manage the editable state of vessel rows.
        *   `useEffect` hook was added to initialize `vesselData` from `bookingData?.vessel_details`, adding `is_existing` and a unique `id` to each vessel for local management.
        *   `handleAddVessel`, `handleEditField`, `handleSaveRow`, and `handleDeleteRow` functions were implemented to manage the client-side editing of vessel data.
        *   The `BOOKING_VESSEL_COLUMN_CUSTOMER` component is now dynamically rendered with these new handler functions as props.
        *   The `isReadOnly` flag was introduced, derived from `bookingData?.booking_status`, to disable editing functionality when a booking is "Approved" or "Cancelled".
        *   Integration with Redux Toolkit Query: `useAddVesselMutation` was imported and used within `handleSaveRow` to persist new vessel data to the backend. The payload for `addNewVessel` was carefully constructed.
    *   **Formik Integration and State Sync (1:16 PM):** `handleSaveRow` was further refined to ensure `formikSetFieldValue` (`setFieldValue`) is called correctly after local `vesselData` is updated and a new vessel is added via API, ensuring Formik's state reflects the latest changes. It also differentiates between adding new vessels and updating existing ones.
    *   **Console Logging for Debugging (12:30 PM - 1:34 PM):** Frequent `console.log` statements were added in `handleSaveRow` to inspect `currentRow` and `updatedRow` states, indicating active debugging efforts during development.
    *   **`LocationPath` Component Update (1:54 PM):** The `LocationPath` component was slightly adjusted to remove the `bg-white p-4` styling, but later reverted, and then it was removed from the main form rendering, as it appears to be a separate component outside the scrollable area.
    *   **Calling `ROUTING_COLUMNS` as a Function (2:05 PM):** `ROUTING_COLUMNS` was changed from being accessed as an array to being called as a function (e.g., `ROUTING_COLUMNS()`) in the `AppTable` component. This indicates a potential change in how `ROUTING_COLUMNS` might be expected to receive parameters in the future, although in the provided log, `ROUTING_COLUMNS` itself is still defined as a constant array.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\api\booking-api.ts` (Multiple Timestamps: 11/7/2025, 12:18:36 PM - 12:27:45 PM)**
    *   **API Endpoint Additions (12:18 PM - 12:27 PM):**
        *   A new mutation endpoint `addVessel` was added to handle POST requests for adding vessel details, invalidating `CUSTOMER_APPROVE` and `add` tags.
        *   The `useAddVesselMutation` hook was exported from the API slice.
        *   The URL for `addVessel` mutation was modified from `/booking/vessels/${params.agent_booking_id}` to `/booking/vessels/${params}` and then to `/booking/vessel`. The last change suggests a simplified endpoint for adding a single vessel, possibly indicating that the `agent_booking_id` is now expected within the `params` body rather than the URL.

**Timestamps of Significant Changes:**

*   **11/7/2025, 10:49:19 AM:** Introduction of dynamic `BOOKING_VESSEL_COLUMN_CUSTOMER` function with `onAdd` and `onEdit` parameters, and new action icons. This marks a shift towards interactive vessel management.
*   **11/7/2025, 11:01:00 AM:** Full implementation of inline editing for vessel columns using `InputBox` and conditional rendering, along with "Save" functionality. This is a significant feature addition.
*   **11/7/2025, 11:21:16 AM:** Introduction of the `isLocked` logic based on `bookingStatus` for read-only mode, directly impacting user interaction with the vessel table.
*   **11/7/2025, 12:18:36 PM:** Addition of the `addVessel` mutation endpoint in the Redux API slice.
*   **11/7/2025, 12:20:34 PM:** Integration of `useAddVesselMutation` into `booking-view.tsx` to handle adding new vessels to the backend.
*   **11/7/2025, 1:16:53 PM:** Major refactor of `handleSaveRow` in `booking-view.tsx` to correctly handle both new vessel creation (via API) and existing vessel updates (locally), and to ensure Formik state consistency.
*   **11/7/2025, 1:28:37 PM:** Renaming `onEdit` to `onFieldEdit` in `BOOKING_VESSEL_COLUMN_CUSTOMER` and introducing `onRowEdit` as a distinct callback for initiating row editing.
*   **11/7/2025, 1:36:50 PM - 1:44:13 PM:** Further refinements to button labels, styling, and conditional rendering logic within `BOOKING_VESSEL_COLUMN_CUSTOMER` related to edit/save states.

**Patterns and Recurring Elements:**

*   **Component-Based Development:** The changes consistently show a React component structure, with clear separation of concerns (e.g., column definitions in `booking-coulmns.tsx`, UI logic in `booking-view.tsx`, API interactions in `booking-api.ts`).
*   **Data Grid/Table Management:** A significant portion of the changes revolves around enhancing tables with editing, adding, and status-based read-only functionalities. This indicates a focus on interactive data presentation and modification.
*   **Form Management with Formik:** The `BookingApproveContainer` heavily relies on `Formik` for form state management, including `initialValues`, `onSubmit`, and `setFieldValue`.
*   **Redux Toolkit Query (RTK Query):** The application uses RTK Query for data fetching and mutations, with `useFetch...Query` and `useSave...Mutation` hooks being prominent. Tag invalidation (`invalidatesTags`) is used to manage cache updates after mutations.
*   **Conditional Rendering:** Many UI elements, especially buttons and input fields within tables, use conditional rendering based on state variables like `editingRowId` and `isLocked` to control user interaction.
*   **Date Formatting:** The `appDateFormat` and `useDateFormate` utilities are consistently used for displaying and handling dates across different columns.
*   **Error Handling and User Feedback:** The use of `react-hot-toast` for showing success and error messages indicates attention to user experience. `console.error` is also frequently used for debugging.
*   **Iterative Refinement:** The log shows an iterative process, particularly in `booking-coulmns.tsx` and `booking-view.tsx`, where functionalities are introduced, then refined (e.g., action column width, header alignment, `onEdit` parameters, payload construction for API calls).
*   **Commenting out Code:** There are several instances of commented-out code blocks (e.g., the `pono` column in `GET_BOOKING_COULMN`, or alternative `renderCell` implementations for "Action"). This suggests exploration of different implementations or temporary disabling of features.

## 5:16:24 PM
No summary generated from AI

## 5:58:42 PM
**Summary of Code Changes**

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\docsParseService.ts` (11/7/2025, 5:03:25 PM):** The `getAllPdfParse` function, which manages vendor data, was significantly enhanced. It now supports advanced pagination, sorting, and filtering by vendor name, status, and email. A notable improvement is the efficient fetching and attachment of associated upload documents for all vendors using a single query, which are then grouped and mapped to individual vendors. The function also dynamically extracts and formats unique status and email options for filtering.
*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\pdfParseService.ts` (11/7/2025, 5:06:48 PM - 5:07:04 PM):** A new `getAllPdfParse` function was introduced, specifically for retrieving data from the `AI_Parse_Document` table. This service includes pagination and sorting by `process_date_time`. A subsequent update at 5:06:59 PM refined the response to include a total `count` of records, essential for client-side pagination.
*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\constants\Paths.ts` (11/7/2025, 5:07:36 PM & 5:15:03 PM):** Initially, a `Document.GetPdf` path (`/get-pdf`) was added. This was later refined and renamed to `Document.GetPdf: "/get-pdf-parse"` for better clarity. Additionally, a new `Notes` route group (`/notes/getAll`, `/notes/add`) was introduced, indicating the development of a new feature for handling notes.
*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\routes\documentUploadRoutes.ts` (11/7/2025, 5:08:07 PM):** This file was updated to integrate the new PDF parsing functionality by adding a GET endpoint (`Paths.Document.GetPdf`) that maps to the `getAllPdfParse` function from `pdfParseService`.
*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\linebookingService.ts` (11/7/2025, 5:14:34 PM & 5:14:48 PM):** The `create` function for line bookings was enhanced to manage "other services" by deleting existing records and inserting new ones within a database transaction, ensuring data consistency. A substantial `getAll` function, which contained complex filtering and sorting logic for line bookings, was found commented out in the provided log, suggesting it is either under active development, temporarily disabled, or deprecated. The entry at 5:14:48 PM is functionally identical to the previous one.
*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\util\optionQuery.ts` (11/7/2025, 5:14:43 PM):** The `OptionQuery` utility class was extended with two new methods: `port()` and `lineName()`. These methods provide keyword-based search functionalities for fetching distinct port, POL/POD, and line details from `line_booking_master` and `line_master` tables respectively, likely for autocomplete features.

**Timestamps of Significant Changes:**

*   **11/7/2025, 5:03:25 PM:** Major update to vendor data retrieval, incorporating related document fetching and dynamic filter options.
*   **11/7/2025, 5:06:48 PM - 5:06:59 PM:** Introduction and immediate refinement of the PDF parsing service, including the addition of total record counts.
*   **11/7/2025, 5:08:07 PM:** Integration of the new PDF parsing endpoint into the application's routing.
*   **11/7/2025, 5:14:34 PM:** Enhancement of the line booking creation process to handle associated services transactionally.
*   **11/7/2025, 5:14:43 PM:** Expansion of autocomplete query capabilities with new methods for ports and line names.
*   **11/7/2025, 5:15:03 PM:** Finalization of the PDF parsing route name and the addition of new API paths for notes.

**Patterns or Recurring Elements:**

*   **Consistent Query Building:** The `QueryBuilder` utility is consistently used across multiple services (`docsParseService`, `pdfParseService`) for constructing parameterized and flexible SQL queries, demonstrating a standardized approach to database interactions.
*   **Standardized Pagination and Sorting:** Both newly introduced and updated listing endpoints uniformly implement pagination (`page`, `perPage`, `offset`) and sorting logic (`orderBy`, `orderField`, `orderDirection`), indicating a global standard for data retrieval.
*   **Robust Error Handling:** All service functions adhere to a consistent error handling pattern, utilizing `try...catch` blocks with `logger.info`, `console.error`, and returning `HttpStatusCodes.INTERNAL_SERVER_ERROR`, ensuring graceful degradation and logging of issues.
*   **Transaction Management:** Critical operations like `linebookingService.create` employ explicit `BEGIN`, `COMMIT`, and `ROLLBACK` commands, ensuring data integrity for multi-step database operations.
*   **Enhanced User Experience through Dynamic Options:** There's a recurring focus on improving the user interface by providing dynamic filtering options (e.g., vendor status/email) and autocomplete suggestions (e.g., for ports and line names), reducing manual input and potential errors.
*   **Route Clarity and Modularity:** The renaming of `Document.GetPdf` to `Document.GetPdfParse` and the introduction of a new `Notes` route group suggest an ongoing effort to maintain clear, descriptive, and modular API endpoints.
*   **Feature Development/Refactoring:** The commented-out `getAll` function in `linebookingService.ts` indicates active development, testing, or a temporary hold on complex features.

## 6:16:13 PM
The code changes primarily focus on the implementation and refinement of a document upload and display feature within a frontend application. All modifications occurred on November 7, 2025, between 5:20 PM and 6:05 PM, indicating active development during this period.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\store\api\uploadDocumentApi.ts` (Timestamp: 11/7/2025, 5:20:16 PM)**
    *   This file introduces the `uploadDocumentApi` using Redux Toolkit Query.
    *   It defines three API endpoints:
        *   `uploadDocument`: A mutation for `POST` requests to `/api/documents/upload`, handling `FormData` with dynamic `Authorization` and `authtype` headers from `localStorage`.
        *   `downloadDocument`: A mutation for `GET` requests to `/api/documents/download/{refType}/{documentName}`, also using dynamic authentication headers and designed to return a `Blob`.
        *   `getPdfParseData`: A query for `GET` requests to `/api/documents/get-pdf-parse` with dynamic query parameters, using `getAppHeaders()`.
    *   This initial commit establishes the core API communication layer for document management.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\components\screen\upload-docs\uploadDocs.tsx` (Timestamp: 11/7/2025, 5:21:15 PM, 5:23:29 PM, 5:24:08 PM, 6:00:45 PM, 6:01:08 PM)**
    *   **Initial Implementation (5:21:15 PM):** Introduced the `ConfirmLineBookingForm` component, which includes a drag-and-drop area for file uploads, form handling with Formik, and integration with `useUploadDocumentMutation` and `useGetPdfParseDataQuery`. It initially displayed uploaded document data using static `tableDummyData`. The upload process appends `document_type`, `ref_type`, `remark`, `file`, `ref_id`, and `uploaded_by` to `FormData`.
    *   **Minor Saves (5:23:29 PM, 5:24:08 PM):** These timestamps reflect saves without functional code changes.
    *   **Dynamic Data Integration (6:00:45 PM):** A significant update changed the `AppGrid` component to display actual data from `getPdfParseData?.data` instead of `tableDummyData`, and `count` was updated to `getPdfParseData?.total`. A minor, likely accidental, string "kk" was added to the displayed file name in the uploaded files list.
    *   **Typo Fix (6:01:08 PM):** The "kk" typo was corrected, reverting the file name display to `{file.name}`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-frontend\src\data\coulms\upload-doc-coulmn.tsx` (Timestamp: 11/7/2025, 5:23:08 PM, 5:28:58 PM, 5:32:50 PM, 5:33:56 PM, 6:05:35 PM)**
    *   **Initial Column Definition (5:23:08 PM):** Defined `UPLOAD_TAB_COLUMNS` for an `AppGrid`.
        *   The `pdf_pa` column rendered a direct download link.
        *   The `json_pa` column displayed a summarized text of JSON data and allowed downloading the data as a `.json` file by generating a blob from the in-row data.
    *   **Debugging (5:28:58 PM):** Added a `console.log("JSON Data:", data);` within the `json_pa` column's `renderCell` for debugging purposes.
    *   **Attempt at Remote JSON Fetch (5:32:50 PM):** The `json_pa` column's `renderCell` logic was completely rewritten to *fetch* JSON data from a URL (either absolute or relative to `/uploads/json/`) and then trigger its download.
    *   **Revert Remote JSON Fetch (5:33:56 PM):** The changes made at 5:32:50 PM were reverted, returning the `json_pa` column's functionality to displaying a summary and generating a blob from local `data`. The `console.log` from 5:28:58 PM remained.
    *   **Refined File Download Logic (6:05:35 PM):** The `pdf_pa` column's `renderCell` was significantly enhanced. It now features a `handleClick` function that intelligently handles downloads:
        *   If the file name ends with `.json`, it fetches the JSON content, pretty-prints it, and then downloads it as a `.json` blob.
        *   For other file types, it creates a link to open the file in a new tab, triggering a download.

### Patterns and Recurring Elements:

*   **Redux Toolkit Query:** The application consistently uses RTK Query for all API interactions, centralizing state management and data fetching.
*   **Document Management Focus:** The overall pattern revolves around handling document uploads (with drag-and-drop support), processing (implicitly via `getPdfParseData`), and displaying/downloading various document types (PDFs, JSONs).
*   **UI Component-Driven:** The use of `AppGrid` and `Card` components from `@components/common/tailwind_common` suggests a structured UI approach, likely with a design system.
*   **Authentication:** API requests consistently retrieve `Authorization` and `authtype` headers from `localStorage`, indicating a token-based authentication mechanism.
*   **Iterative Development for Data Display:** There's a clear pattern of refining the table display logic, particularly for handling `pdf_pa` and `json_pa` fields, including an initial attempt to fetch JSON data remotely which was later reverted, and then a more robust approach applied to `pdf_pa` to handle different file types.
*   **From Dummy to Dynamic Data:** The `uploadDocs.tsx` component initially used static dummy data for its display table, but quickly transitioned to fetching and rendering live data from the `getPdfParseData` API call.

## 6:16:35 PM
The code change log details development across `AuthRoutes.ts`, `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`, and `Paths.ts` from November 5th to November 7th, 2025.

**Key Information by File Path:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp: 11/5/2025, 12:54:56 PM**
    *   An initial route for `/auth/verify-token` was added. This GET endpoint is responsible for returning authenticated user information (`req.user`). It imports necessary types and constants, and uses `HttpStatusCodes.OK` for a successful response.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps: 11/5/2025, 6:04:50 PM - 11/5/2025, 6:06:01 PM**
        *   The `getDashboardCardInfo` function was implemented to retrieve aggregated shipment data (Pending Departure, In Transit, ETA within 1 week, Out for delivery) with TEU calculations. It supports filtering by `fromDate`, `toDate`, and `CompanyName`, and applies user-specific conditions (`buildMtrUserCondition`).
        *   The `getDeliveryData` function was added to fetch delivery or vessel arrival data based on `type` and `mode` (ALL, Rail, Door, Port Delivery). It includes specific SQL queries for each type and applies user-specific conditions.
    *   **Timestamp: 11/5/2025, 8:41:51 PM**
        *   `getDashboardCardInfo` was updated to dynamically obtain `CompanyName` using a `getUserObject` utility, instead of directly from query parameters. The `getUserObject` utility was imported.
    *   **Timestamp: 11/5/2025, 8:42:22 PM**
        *   A `console.log` statement was added to `getDashboardCardInfo` for debugging the retrieved `CompanyName`.
    *   **Timestamp: 11/5/2025, 10:41:50 PM**
        *   The `CompanyName` parameter was explicitly removed from the destructuring of `req.query` in `getDashboardCardInfo`, confirming its new dynamic retrieval method.
    *   **Timestamp: 11/5/2025, 10:43:59 PM**
        *   The `useWhere` condition (generated by `buildMtrUserCondition`) was commented out in `getDashboardCardInfo`, removing a user-specific filter from the card data query.
    *   **Timestamp: 11/5/2025, 10:44:51 PM**
        *   A `console.log` statement was added to `getDashboardCardInfo` for debugging the query result.
    *   **Timestamp: 11/5/2025, 10:46:26 PM**
        *   `getDeliveryData` was updated to dynamically fetch `CompanyName` using `getUserObject`, similar to `getDashboardCardInfo`. This `CompanyName` was then used to filter `sqlQueryDelivery` and `SqlQueryVesselArrival`, introducing a potentially unsafe direct string interpolation into the SQL query.
    *   **Timestamp: 11/5/2025, 10:51:27 PM**
        *   The `getDeliveryData` function was refactored for safer `CompanyName` handling. It introduced a `companyFilter` variable that uses `LOWER()` for case-insensitive matching and `replace(/'/g, "''")` to escape single quotes, mitigating SQL injection risks when directly embedding `CompanyName` into SQL. The `useWhere` condition was removed from `getDeliveryData`'s queries.
    *   **Timestamp: 11/5/2025, 11:06:35 PM**
        *   The dynamic `CompanyName` retrieval using `getUserObject` in `getDeliveryData` was commented out, reverting to directly using `CompanyName` from `req.query` for filtering, losing the `getUserObject` logic.
    *   **Timestamp: 11/5/2025, 11:07:02 PM**
        *   The dynamic `CompanyName` retrieval using `getUserObject` in `getDashboardCardInfo` was also commented out, making it consistent with `getDeliveryData` in relying on `CompanyName` directly from `req.query`.
    *   **Timestamp: 11/5/2025, 11:13:53 PM**
        *   `getDashboardCardInfo` improved the `CompanyName` filter in its `baseQuery` to handle undefined `CompanyName` gracefully and re-applied the `replace(/'/g, "''")` for SQL injection protection.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps: 11/5/2025, 8:51:00 PM - 11/5/2025, 8:51:46 PM**
    *   This file provides a suite of user management functionalities:
        *   `login`: Authenticates users, checks account status, and generates JWTs. Noteworthy for using direct string interpolation in SQL for username/password, which is a significant security risk (SQL injection).
        *   `saveUserPreferences`: Stores detailed user settings (`first_name`, `email`, `time_zone`, `notification_settings`, `event_configs`) in `v2_user_details` with `ON CONFLICT DO UPDATE` for upsert.
        *   `fetchUserPreferences`: Retrieves user preferences, using `COALESCE` to fallback to `mtr_user_master` details if `v2_user_details` is incomplete.
        *   `saveInviteLog`: Records user invitation details to `v2_user_invite_log`, also with `ON CONFLICT DO UPDATE`, and sends an invite email.
        *   `fetchAllCompanyUser`: Gathers active users and pending invited users for a given company.
        *   `userSettings`: Fetches specific user settings like `date_format`.
    *   Across these timestamps, no functional changes are observed for `UserService.ts`, indicating saves without alterations.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp: 11/6/2025, 1:27:09 PM**
    *   The `getAll` function, used to retrieve shipments, was implemented. It uses a `SqlQueryBuilder` class to construct dynamic SQL queries based on various filters (pagination, POL, POD, status, dates, etc.).
    *   The `SqlQueryBuilder` supports applying user-specific permissions (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and filtering by different dashboard card states. It dynamically categorizes shipment statuses (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on MTR data.
    *   Both `SqlQueryBuilder.buildUserCondition` and `buildCardFilterCondition` contain direct string interpolation for values like `companyname`, `location`, and dates, making them vulnerable to SQL injection.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamps: 11/6/2025, 2:02:45 PM - 11/6/2025, 2:02:45 PM**
        *   The `BookingQueryBuilder` class was introduced to generate dynamic SQL queries for booking data, supporting pagination, sorting, search, and filtering by various fields (POL, POD, shipper, status, booking type). It also implements user-specific filtering.
        *   The `getAll` function leverages `BookingQueryBuilder` to retrieve bookings, total counts, and filter options.
        *   A `saveBooking` function was partially defined to handle booking creation/updates.
    *   **Timestamp: 11/6/2025, 2:05:16 PM**
        *   `abe.est_cargo_ready_date` was added to `BookingQueryBuilder.selectedColumns`, indicating a new field to be retrieved.
    *   **Timestamp: 11/6/2025, 2:16:39 PM**
        *   Date range filtering for `est_cargo_ready_date` was added to `BookingQueryBuilder` by introducing `cargoReadyFromDate` and `cargoReadyToDate` properties and updating the `setDateRange` method and `getAll` function to use them.
    *   **Timestamp: 11/6/2025, 2:26:13 PM**
        *   An attempt was made to refactor `BookingQueryBuilder.whereClauses` to be an array of strings, and a new private `addDateRangeClause` was introduced for more flexible date filtering. However, this introduced a logical inconsistency where `setWhereClause` still assigned a single string to the array.
    *   **Timestamp: 11/6/2025, 2:27:15 PM**
        *   The `whereClauses` property in `BookingQueryBuilder` was reverted to a single `string`, undoing the previous refactoring attempt and associated date range flexibility.
    *   **Timestamp: 11/6/2025, 5:57:33 PM**
        *   A typo in `BookingQueryBuilder.buildCountQuery` (`COUNTabe`) was introduced.
    *   **Timestamp: 11/6/2025, 5:57:41 PM**
        *   The typo in `BookingQueryBuilder.buildCountQuery` was corrected (`COUNT(abe.agent_booking_id)`).
    *   **Timestamp: 11/6/2025, 6:03:28 PM**
        *   The `BookingStatus` enum and related `BookingQueryBuilder` logic were updated to include a `CONFIRMED` status.
    *   **Timestamp: 11/7/2025, 9:51:09 AM**
        *   Renaming of `CargoReadyFromDate` and `CargoReadyToDate` properties to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase initial) in `BookingQueryBuilder` occurred, indicating a style change.
    *   **Timestamp: 11/7/2025, 1:14:19 PM**
        *   An `InventoryI` interface was added, suggesting upcoming changes related to container inventory or cargo details within bookings.
    *   **Timestamps from 11/6/2025, 5:05:22 PM to 11/7/2025, 4:19:40 PM (excluding specific changes mentioned above):** Numerous entries show identical code, primarily reflecting frequent saves without functional alterations.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **Timestamp: 11/6/2025, 6:02:57 PM**
    *   The `BookingStatus` enum was updated to include a `CONFIRMED` status, reflecting new states in the booking workflow.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamp: 11/6/2025, 5:06:22 PM**
        *   New paths were added for booking approval details (`/booking_approve/:agent_booking_id`), fetching company users (`/fetch-company-users`), and user settings (`/get-user-settings`).
    *   **Timestamp: 11/6/2025, 5:13:57 PM**
        *   A `createBookingApproveDetails` path was added which is identical to `getBookingApproveDetails`, suggesting a POST route to the same URI.
    *   **Timestamp: 11/7/2025, 12:17:18 PM**
        *   A `vesselAdd` path was introduced as `/vessel/:agent_booking_id` under `Booking`.
    *   **Timestamp: 11/7/2025, 12:24:55 PM**
        *   The `vesselAdd` path was changed from `"/vessel/:agent_booking_id"` to `"/vessel"`, removing the ID from the path.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamp: 11/6/2025, 5:06:41 PM**
        *   A GET route for fetching booking approval details (`Paths.Booking.getBookingApproveDetails`) was added, handled by `getBookingApproveDetails`.
    *   **Timestamp: 11/6/2025, 5:15:38 PM**
        *   A POST route for updating booking approval details (`Paths.Booking.createBookingApproveDetails`) was added, handled by `updateBookingApproveDetails`. This uses the same URI pattern as the GET route.
    *   **Timestamp: 11/7/2025, 12:17:36 PM**
        *   A POST route for adding booking vessel details (`Paths.Booking.vesselAdd`) was added, handled by `addBookingVessel`.
    *   **Timestamp: 11/7/2025, 1:14:41 PM**
        *   The handler for the `vesselAdd` POST route was changed from `addBookingVessel` to `addOrUpdateBookingVessel`, indicating a change in the underlying service logic.
    *   **Timestamp: 11/7/2025, 1:14:50 PM**
        *   The unused `addBookingVessel` import was removed.

**Patterns and Recurring Elements:**

*   **SQL Query Construction:** A consistent pattern of using dedicated `SqlQueryBuilder` or `BookingQueryBuilder` classes to construct dynamic SQL queries for various filters (pagination, date ranges, search, status, user roles) is observed across `shipmentService.ts` and `bookingService.ts`.
*   **SQL Injection Vulnerability:** A significant recurring pattern is the direct string interpolation of user-provided or dynamically constructed values (like `CompanyName`, `account_name`, `location`, `fromDate`, `toDate`) directly into SQL queries without proper parameterization or robust escaping (e.g., in `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`). While some attempts at escaping are made (`replace(/'/g, "''")`), these might not cover all edge cases or be consistently applied, posing a security risk.
*   **Logging and Debugging:** Extensive use of `logger.info`, `logger.error`, and `console.log` for debugging and tracking execution flow is prevalent across all service files. Debugging `console.log` statements are frequently added and sometimes removed across successive changes.
*   **API Endpoint Design:** Routes often follow a REST-like structure with GET for retrieval and POST for creation/updates. Identical URI patterns for different HTTP methods (e.g., GET and POST on `/booking_approve/:agent_booking_id`) are used.
*   **User Role-Based Access:** Filtering data based on `req.user.role` (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated `companyname` or `location` is a consistent authorization mechanism.
*   **Frequent Commits/Saves:** Many consecutive log entries for the same file path show identical code, indicating a pattern of frequent saves during development, possibly after minor, non-functional changes or just saving progress.
*   **Date Handling:** Date range filtering is a common requirement, handled by `BETWEEN` clauses in SQL, often with `fromDate` and `toDate` query parameters.
*   **Status Management:** Both shipments and bookings have defined status lifecycles, which are used for filtering and presenting aggregated counts. The `BookingStatus` enum in `booking.ts` was explicitly extended during this period.