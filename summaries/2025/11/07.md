# Activity Summary for 11/7/2025

## 10:44:21 AM
The provided log details code changes across three primary files: `AuthRoutes.ts`, `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`, and `Paths.ts`.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   **Updates:** This file defines authentication routes. The provided log entry shows a `GET` endpoint for `Paths.Auth.GetUserInfo` which logs the `req.user` and returns it with an `OK` status. This appears to be an existing or early definition of a user information retrieval route.

2.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 6:04:50 PM and 11:23:11 PM.
    *   **Updates:**
        *   **Initial Structure (6:04:50 PM):** Introduced `getDashboardCardInfo` and `getDeliveryData` functions.
            *   `getDashboardCardInfo`: Fetches aggregated shipment data (Pending Departure, In Transit, ETA within 1 Week, Out for Delivery) with filters for `fromDate`, `toDate`, and `CompanyName`. It calculates TEU (Twenty-foot Equivalent Unit) values and applies user-specific conditions using `buildMtrUserCondition`.
            *   `getDeliveryData`: Fetches delivery or vessel arrival data, supporting filtering by `type` (delivery/vessel) and `mode` (ALL, Rail Delivery, Door Delivery, Port Delivery). It also applies user-specific conditions.
        *   **Minor Edits (6:05:15 PM, 6:05:28 PM, 6:06:01 PM):** These seem to be minor saving events without significant functional changes. The code remains largely identical to the initial structure.
        *   **Refinement of CompanyName Handling in `getDashboardCardInfo` (8:41:51 PM):** The `CompanyName` variable is now dynamically retrieved using `getUserObject` based on `req.user`, `req.query.companyname`, and `req.query.access`. The `CompanyName` query parameter is removed from the destructuring of `req.query`. A new import `getUserObject` from `@src/utils/analytics` is added.
        *   **Logging Addition (8:42:22 PM):** Added a `console.log("req.CompanyName", CompanyName);` line after retrieving `CompanyName` in `getDashboardCardInfo`.
        *   **Query Parameter Refinement (10:41:50 PM):** The `CompanyName` parameter is removed from the `req.query` destructuring for `getDashboardCardInfo`, reinforcing that `CompanyName` is now determined via `getUserObject`.
        *   **Commented out `useWhere` (10:43:59 PM):** The line `if(useWhere) conditions.push(useWhere);` is commented out in `getDashboardCardInfo`, suggesting a change in how user-specific conditions might be applied, possibly relying on `CompanyName` in the final query string directly.
        *   **Added `console.log` for Result (10:44:51 PM):** A `console.log("result[0]", result[0]);` is added in `getDashboardCardInfo` to inspect the fetched data.
        *   **`getDeliveryData` CompanyName Logic Change (10:46:26 PM):** In `getDeliveryData`, the `CompanyName` is now retrieved using `getUserObject` (similar to `getDashboardCardInfo`) and used to construct a `companyFilter` which is then applied directly to the SQL queries for both delivery and vessel arrival. The original `useWhere` variable is still present but not explicitly used for `CompanyName` filtering.
        *   **Added `console.log` for Error in `getDeliveryData` (10:49:15 PM):** A `console.log(error);` is added within the catch block of `getDeliveryData`.
        *   **Refactored `getDeliveryData` CompanyName Filtering (10:51:27 PM):** The `CompanyName` retrieval in `getDeliveryData` is explicitly commented out (`// const CompanyName = (...)`) and replaced with a `CompanyName` parameter directly from `req.query`. A safer `companyFilter` is introduced using `LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')` to prevent SQL injection and ensure case-insensitive matching. The `useWhere` for `getDeliveryData` is still there.
        *   **Removed `CompanyName` retrieval in `getDashboardCardInfo` (11:06:35 PM):** The dynamic `CompanyName` retrieval using `getUserObject` in `getDashboardCardInfo` is commented out, reverting it to directly use `CompanyName` from `req.query`.
        *   **Logging SQL query for `getDashboardCardInfo` (11:10:55 PM):** Changed `logger.info(`sql query :: ${baseQuery}`);` to `logger.info(`sql query :: 1234${baseQuery}`);` to make the log entry more distinct. This change is repeated in the next commit.
        *   **Logging `companyFilter` in `getDeliveryData` (11:11:09 PM):** Added `console.log("companyFilter", companyFilter);` in `getDeliveryData`.
        *   **Safe Handling of `CompanyName` in `getDashboardCardInfo` (11:13:53 PM):** The `CompanyName` in the `getDashboardCardInfo` query is now handled more robustly by allowing it to be an empty string if not present and applying `.replace(/'/g, "''")` for SQL injection prevention.
        *   **Minor change in `getDeliveryData` `console.log` (11:23:11 PM):** No significant functional change, likely just a re-save.

3.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 8:51:00 PM and 8:51:46 PM.
    *   **Updates:**
        *   **Initial Functions (8:51:00 PM):** Defines `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`.
            *   `login`: Handles user authentication, queries `mtr_user_master`, validates credentials and user status, creates a JWT token, and returns user data.
            *   `saveUserPreferences`: Inserts or updates user preferences in `v2_user_details`, including basic info, email/push configs, and event configs.
            *   `fetchUserPreferences`: Retrieves user preferences by joining `mtr_user_master` and `v2_user_details`.
            *   `saveInviteLog`: Records user invitation details in `v2_user_invite_log` and sends an invitation email.
            *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company.
            *   `userSettings`: Fetches user-specific settings, primarily `date_format`.
        *   **Minor Edits (8:51:15 PM, 8:51:46 PM):** These appear to be minor saving events without significant functional changes. The code remains largely identical.

4.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp:** 11/6/2025, 1:27:09 PM
    *   **Updates:**
        *   Introduced `getAll` function for retrieving shipment data with various filters (pagination, POL, POD, shipment ID, status, date range, `orderBy`, `cardFilter`, `contno`, `viewType`).
        *   Implemented `SqlQueryBuilder` class to dynamically construct SQL queries based on user roles and filters, including specific conditions for "ADMIN", "CUSTOMER", "FRONTOFFICE", and "AGENT" roles.
        *   Added `buildCardFilterCondition` to filter shipments based on dashboard card types (pending departure, in transit, ETA within 1 week, out for delivery).
        *   Logic to determine shipment status (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields from `mtr_tracking_data`.

5.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 between 2:02:45 PM and 7:11:07 PM, and on 11/7/2025 between 9:51:09 AM and 9:51:33 AM.
    *   **Updates:**
        *   **Initial Structure (2:02:45 PM):** Introduced `BookingQueryBuilder` class and `getAll`, `saveBooking` functions.
            *   `BookingQueryBuilder`: A class to construct SQL queries for booking data, handling pagination, ordering, user-specific conditions (ADMIN, CUSTOMER, SPR_CUSTOMER based on `companyname`/`location`), and various search/filter clauses for booking status, POL, POD, shipper, etc.
            *   `getAll`: Fetches booking records using `BookingQueryBuilder`, provides counts for different booking statuses (ALL, PENDING, APPROVED, CANCELLED, NEW), and retrieves unique options for filters like POL, POD, shipper, booking type, and status.
            *   `saveBooking`: Handles saving new booking records, sanitizes input, and uses `AppDateFormate` for date fields.
        *   **Added `est_cargo_ready_date` (2:05:16 PM):** `abe.est_cargo_ready_date` was added to `selectedColumns` in `BookingQueryBuilder`.
        *   **Added `CargoReadyFromDate` and `CargoReadyToDate` (2:16:39 PM):** New properties `CargoReadyFromDate` and `CargoReadyToDate` were added to `BookingQueryBuilder`, and the `setDateRange` method was updated to include filtering by `abe.est_cargo_ready_date`.
        *   **Refactored `whereClauses` and `addDateRangeClause` (2:26:13 PM):** `whereClauses` in `BookingQueryBuilder` was changed from a single string to an array (`string[]`), and the `addDateRangeClause` was made a private method, handling date ranges more flexibly (e.g., `fromDate` only, `toDate` only, or both). The way `finalWhere` is constructed was updated to join the `whereClauses` array.
        *   **Reverted `whereClauses` (2:27:15 PM):** The `whereClauses` property was reverted back to a single `string` type, undoing the array change from the previous commit. The `addDateRangeClause` method was also reverted to its previous public single-date-range form. This indicates a quick rollback or refactoring.
        *   **Minor change to `getAll` parameters (5:05:22 PM):** Added `NextFunction, Response` imports to `bookingService.ts` but not used in the provided code snippets. This seems like a preparatory or leftover import.
        *   **Minor change (5:05:30 PM):** No significant functional changes compared to the previous state.
        *   **Correction in `buildCountQuery` (5:57:33 PM):** The `SELECT COUNT(DISTINCT abe.agent_booking_id)` in `buildCountQuery` was accidentally truncated to `SELECT COUNTabe.agent_booking_id)`.
        *   **Fixed `buildCountQuery` (5:57:41 PM):** The truncation in `buildCountQuery` was corrected back to `SELECT COUNT(abe.agent_booking_id)`.
        *   **Added `CONFIRMED` Booking Status (6:03:28 PM, 6:03:51 PM, 7:11:07 PM):** The `BookingStatus` enum and the `setWhereClause` method in `BookingQueryBuilder` were updated to include a `CONFIRMED` status. The `getAll` function also started calculating counts for the new `CONFIRMED` status.
        *   **Renamed `CargoReadyFromDate` to `cargoReadyFromDate` (9:51:09 AM, 9:51:33 AM):** The public properties `CargoReadyFromDate` and `CargoReadyToDate` in `BookingQueryBuilder` were renamed to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase `c` for `cargo`).

6.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:22 PM, 5:13:57 PM, 7:20:31 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` (5:06:22 PM):** A new path `Booking.getBookingApproveDetails` was added, pointing to `/booking_approve/:agent_booking_id`.
        *   **Added `createBookingApproveDetails` (5:13:57 PM):** Another path `Booking.createBookingApproveDetails` was added, also pointing to `/booking_approve/:agent_booking_id`. This suggests an intent for both GET and POST operations on the same URL.
        *   **Minor formatting/resave (7:20:31 PM):** No functional changes observed.

7.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:41 PM, 5:15:38 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` route (5:06:41 PM):** A `GET` route for `Paths.Booking.getBookingApproveDetails` was added, mapped to the `getBookingApproveDetails` service function.
        *   **Added `updateBookingApproveDetails` route (5:15:38 PM):** A `POST` route for `Paths.Booking.createBookingApproveDetails` was added, mapped to a new `updateBookingApproveDetails` service function.

### Patterns and Recurring Elements:

*   **Date-related filters:** Both `dashboardService.ts` and `bookingService.ts` extensively use `fromDate`, `toDate`, and in some cases `cargoReadyFromDate`, `cargoReadyToDate` for filtering data by date ranges.
*   **User-specific conditions:** Most data retrieval functions (`getDashboardCardInfo`, `getDeliveryData`, `getAll` in `shipmentService` and `bookingService`) incorporate logic (`buildMtrUserCondition`, `userWhere`) to filter data based on the authenticated user's role (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/location.
*   **SQL Query Builders:** The `shipmentService.ts` and `bookingService.ts` files utilize dedicated `SqlQueryBuilder` and `BookingQueryBuilder` classes, respectively, to construct complex SQL queries dynamically. This pattern promotes code organization, reusability, and parameterization of queries.
*   **Pagination and Ordering:** Both `shipmentService.ts` and `bookingService.ts` implement pagination (`page`, `pageSize`/`perPage`, `offset`) and sorting (`orderBy`) for their `getAll` functions.
*   **Error Handling and Logging:** All service functions consistently include `try-catch` blocks for error handling, returning `HttpStatusCodes.INTERNAL_SERVER_ERROR` on failure, and frequently log information and errors using `logger.info` and `logger.error`.
*   **HTTP Status Codes:** `HttpStatusCodes` from `@src/common/constants/HttpStatusCodes` are consistently used for setting response statuses.
*   **SQL Injection Prevention:** In `dashboardService.ts`, the `CompanyName` in SQL queries is now handled with `.replace(/'/g, "''")` to escape single quotes, indicating an improvement in security practices.
*   **Consistent File Paths:** All files follow a structured path convention (`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\...`).
*   **Redundant Saves:** Several entries for `dashboardService.ts` and `UserService.ts` show identical code content with slightly different timestamps, indicating frequent saves during development.
*   **Evolution of Query Parameters:** There's an observable pattern of refining how query parameters, especially `CompanyName` and date ranges, are extracted and applied to SQL queries for both safety and flexibility.