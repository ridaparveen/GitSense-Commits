# Activity Summary for 11/7/2025

## 10:44:21 AM
The provided log details code changes across three primary files: `AuthRoutes.ts`, `dashboardService.ts`, `UserService.ts`, `shipmentService.ts`, `bookingService.ts`, and `Paths.ts`.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **Timestamp:** 11/5/2025, 12:54:56 PM
    *   **Updates:** This file defines authentication routes. The provided log entry shows a `GET` endpoint for `Paths.Auth.GetUserInfo` which logs the `req.user` and returns it with an `OK` status. This appears to be an existing or early definition of a user information retrieval route.

2.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 6:04:50 PM and 11:23:11 PM.
    *   **Updates:**
        *   **Initial Structure (6:04:50 PM):** Introduced `getDashboardCardInfo` and `getDeliveryData` functions.
            *   `getDashboardCardInfo`: Fetches aggregated shipment data (Pending Departure, In Transit, ETA within 1 Week, Out for Delivery) with filters for `fromDate`, `toDate`, and `CompanyName`. It calculates TEU (Twenty-foot Equivalent Unit) values and applies user-specific conditions using `buildMtrUserCondition`.
            *   `getDeliveryData`: Fetches delivery or vessel arrival data, supporting filtering by `type` (delivery/vessel) and `mode` (ALL, Rail Delivery, Door Delivery, Port Delivery). It also applies user-specific conditions.
        *   **Minor Edits (6:05:15 PM, 6:05:28 PM, 6:06:01 PM):** These seem to be minor saving events without significant functional changes. The code remains largely identical to the initial structure.
        *   **Refinement of CompanyName Handling in `getDashboardCardInfo` (8:41:51 PM):** The `CompanyName` variable is now dynamically retrieved using `getUserObject` based on `req.user`, `req.query.companyname`, and `req.query.access`. The `CompanyName` query parameter is removed from the destructuring of `req.query`. A new import `getUserObject` from `@src/utils/analytics` is added.
        *   **Logging Addition (8:42:22 PM):** Added a `console.log("req.CompanyName", CompanyName);` line after retrieving `CompanyName` in `getDashboardCardInfo`.
        *   **Query Parameter Refinement (10:41:50 PM):** The `CompanyName` parameter is removed from the `req.query` destructuring for `getDashboardCardInfo`, reinforcing that `CompanyName` is now determined via `getUserObject`.
        *   **Commented out `useWhere` (10:43:59 PM):** The line `if(useWhere) conditions.push(useWhere);` is commented out in `getDashboardCardInfo`, suggesting a change in how user-specific conditions might be applied, possibly relying on `CompanyName` in the final query string directly.
        *   **Added `console.log` for Result (10:44:51 PM):** A `console.log("result[0]", result[0]);` is added in `getDashboardCardInfo` to inspect the fetched data.
        *   **`getDeliveryData` CompanyName Logic Change (10:46:26 PM):** In `getDeliveryData`, the `CompanyName` is now retrieved using `getUserObject` (similar to `getDashboardCardInfo`) and used to construct a `companyFilter` which is then applied directly to the SQL queries for both delivery and vessel arrival. The original `useWhere` variable is still present but not explicitly used for `CompanyName` filtering.
        *   **Added `console.log` for Error in `getDeliveryData` (10:49:15 PM):** A `console.log(error);` is added within the catch block of `getDeliveryData`.
        *   **Refactored `getDeliveryData` CompanyName Filtering (10:51:27 PM):** The `CompanyName` retrieval in `getDeliveryData` is explicitly commented out (`// const CompanyName = (...)`) and replaced with a `CompanyName` parameter directly from `req.query`. A safer `companyFilter` is introduced using `LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')` to prevent SQL injection and ensure case-insensitive matching. The `useWhere` for `getDeliveryData` is still there.
        *   **Removed `CompanyName` retrieval in `getDashboardCardInfo` (11:06:35 PM):** The dynamic `CompanyName` retrieval using `getUserObject` in `getDashboardCardInfo` is commented out, reverting it to directly use `CompanyName` from `req.query`.
        *   **Logging SQL query for `getDashboardCardInfo` (11:10:55 PM):** Changed `logger.info(`sql query :: ${baseQuery}`);` to `logger.info(`sql query :: 1234${baseQuery}`);` to make the log entry more distinct. This change is repeated in the next commit.
        *   **Logging `companyFilter` in `getDeliveryData` (11:11:09 PM):** Added `console.log("companyFilter", companyFilter);` in `getDeliveryData`.
        *   **Safe Handling of `CompanyName` in `getDashboardCardInfo` (11:13:53 PM):** The `CompanyName` in the `getDashboardCardInfo` query is now handled more robustly by allowing it to be an empty string if not present and applying `.replace(/'/g, "''")` for SQL injection prevention.
        *   **Minor change in `getDeliveryData` `console.log` (11:23:11 PM):** No significant functional change, likely just a re-save.

3.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **Timestamps:** Multiple changes occurred on 11/5/2025 between 8:51:00 PM and 8:51:46 PM.
    *   **Updates:**
        *   **Initial Functions (8:51:00 PM):** Defines `login`, `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`.
            *   `login`: Handles user authentication, queries `mtr_user_master`, validates credentials and user status, creates a JWT token, and returns user data.
            *   `saveUserPreferences`: Inserts or updates user preferences in `v2_user_details`, including basic info, email/push configs, and event configs.
            *   `fetchUserPreferences`: Retrieves user preferences by joining `mtr_user_master` and `v2_user_details`.
            *   `saveInviteLog`: Records user invitation details in `v2_user_invite_log` and sends an invitation email.
            *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company.
            *   `userSettings`: Fetches user-specific settings, primarily `date_format`.
        *   **Minor Edits (8:51:15 PM, 8:51:46 PM):** These appear to be minor saving events without significant functional changes. The code remains largely identical.

4.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **Timestamp:** 11/6/2025, 1:27:09 PM
    *   **Updates:**
        *   Introduced `getAll` function for retrieving shipment data with various filters (pagination, POL, POD, shipment ID, status, date range, `orderBy`, `cardFilter`, `contno`, `viewType`).
        *   Implemented `SqlQueryBuilder` class to dynamically construct SQL queries based on user roles and filters, including specific conditions for "ADMIN", "CUSTOMER", "FRONTOFFICE", and "AGENT" roles.
        *   Added `buildCardFilterCondition` to filter shipments based on dashboard card types (pending departure, in transit, ETA within 1 week, out for delivery).
        *   Logic to determine shipment status (Pending, Loading, Departed, In-Transit, Custom Hold, Arrived, Delivered) based on various date fields from `mtr_tracking_data`.

5.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **Timestamps:** Multiple changes on 11/6/2025 between 2:02:45 PM and 7:11:07 PM, and on 11/7/2025 between 9:51:09 AM and 9:51:33 AM.
    *   **Updates:**
        *   **Initial Structure (2:02:45 PM):** Introduced `BookingQueryBuilder` class and `getAll`, `saveBooking` functions.
            *   `BookingQueryBuilder`: A class to construct SQL queries for booking data, handling pagination, ordering, user-specific conditions (ADMIN, CUSTOMER, SPR_CUSTOMER based on `companyname`/`location`), and various search/filter clauses for booking status, POL, POD, shipper, etc.
            *   `getAll`: Fetches booking records using `BookingQueryBuilder`, provides counts for different booking statuses (ALL, PENDING, APPROVED, CANCELLED, NEW), and retrieves unique options for filters like POL, POD, shipper, booking type, and status.
            *   `saveBooking`: Handles saving new booking records, sanitizes input, and uses `AppDateFormate` for date fields.
        *   **Added `est_cargo_ready_date` (2:05:16 PM):** `abe.est_cargo_ready_date` was added to `selectedColumns` in `BookingQueryBuilder`.
        *   **Added `CargoReadyFromDate` and `CargoReadyToDate` (2:16:39 PM):** New properties `CargoReadyFromDate` and `CargoReadyToDate` were added to `BookingQueryBuilder`, and the `setDateRange` method was updated to include filtering by `abe.est_cargo_ready_date`.
        *   **Refactored `whereClauses` and `addDateRangeClause` (2:26:13 PM):** `whereClauses` in `BookingQueryBuilder` was changed from a single string to an array (`string[]`), and the `addDateRangeClause` was made a private method, handling date ranges more flexibly (e.g., `fromDate` only, `toDate` only, or both). The way `finalWhere` is constructed was updated to join the `whereClauses` array.
        *   **Reverted `whereClauses` (2:27:15 PM):** The `whereClauses` property was reverted back to a single `string` type, undoing the array change from the previous commit. The `addDateRangeClause` method was also reverted to its previous public single-date-range form. This indicates a quick rollback or refactoring.
        *   **Minor change to `getAll` parameters (5:05:22 PM):** Added `NextFunction, Response` imports to `bookingService.ts` but not used in the provided code snippets. This seems like a preparatory or leftover import.
        *   **Minor change (5:05:30 PM):** No significant functional changes compared to the previous state.
        *   **Correction in `buildCountQuery` (5:57:33 PM):** The `SELECT COUNT(DISTINCT abe.agent_booking_id)` in `buildCountQuery` was accidentally truncated to `SELECT COUNTabe.agent_booking_id)`.
        *   **Fixed `buildCountQuery` (5:57:41 PM):** The truncation in `buildCountQuery` was corrected back to `SELECT COUNT(abe.agent_booking_id)`.
        *   **Added `CONFIRMED` Booking Status (6:03:28 PM, 6:03:51 PM, 7:11:07 PM):** The `BookingStatus` enum and the `setWhereClause` method in `BookingQueryBuilder` were updated to include a `CONFIRMED` status. The `getAll` function also started calculating counts for the new `CONFIRMED` status.
        *   **Renamed `CargoReadyFromDate` to `cargoReadyFromDate` (9:51:09 AM, 9:51:33 AM):** The public properties `CargoReadyFromDate` and `CargoReadyToDate` in `BookingQueryBuilder` were renamed to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase `c` for `cargo`).

6.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:22 PM, 5:13:57 PM, 7:20:31 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` (5:06:22 PM):** A new path `Booking.getBookingApproveDetails` was added, pointing to `/booking_approve/:agent_booking_id`.
        *   **Added `createBookingApproveDetails` (5:13:57 PM):** Another path `Booking.createBookingApproveDetails` was added, also pointing to `/booking_approve/:agent_booking_id`. This suggests an intent for both GET and POST operations on the same URL.
        *   **Minor formatting/resave (7:20:31 PM):** No functional changes observed.

7.  **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **Timestamps:** 11/6/2025, 5:06:41 PM, 5:15:38 PM
    *   **Updates:**
        *   **Added `getBookingApproveDetails` route (5:06:41 PM):** A `GET` route for `Paths.Booking.getBookingApproveDetails` was added, mapped to the `getBookingApproveDetails` service function.
        *   **Added `updateBookingApproveDetails` route (5:15:38 PM):** A `POST` route for `Paths.Booking.createBookingApproveDetails` was added, mapped to a new `updateBookingApproveDetails` service function.

### Patterns and Recurring Elements:

*   **Date-related filters:** Both `dashboardService.ts` and `bookingService.ts` extensively use `fromDate`, `toDate`, and in some cases `cargoReadyFromDate`, `cargoReadyToDate` for filtering data by date ranges.
*   **User-specific conditions:** Most data retrieval functions (`getDashboardCardInfo`, `getDeliveryData`, `getAll` in `shipmentService` and `bookingService`) incorporate logic (`buildMtrUserCondition`, `userWhere`) to filter data based on the authenticated user's role (ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/location.
*   **SQL Query Builders:** The `shipmentService.ts` and `bookingService.ts` files utilize dedicated `SqlQueryBuilder` and `BookingQueryBuilder` classes, respectively, to construct complex SQL queries dynamically. This pattern promotes code organization, reusability, and parameterization of queries.
*   **Pagination and Ordering:** Both `shipmentService.ts` and `bookingService.ts` implement pagination (`page`, `pageSize`/`perPage`, `offset`) and sorting (`orderBy`) for their `getAll` functions.
*   **Error Handling and Logging:** All service functions consistently include `try-catch` blocks for error handling, returning `HttpStatusCodes.INTERNAL_SERVER_ERROR` on failure, and frequently log information and errors using `logger.info` and `logger.error`.
*   **HTTP Status Codes:** `HttpStatusCodes` from `@src/common/constants/HttpStatusCodes` are consistently used for setting response statuses.
*   **SQL Injection Prevention:** In `dashboardService.ts`, the `CompanyName` in SQL queries is now handled with `.replace(/'/g, "''")` to escape single quotes, indicating an improvement in security practices.
*   **Consistent File Paths:** All files follow a structured path convention (`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\...`).
*   **Redundant Saves:** Several entries for `dashboardService.ts` and `UserService.ts` show identical code content with slightly different timestamps, indicating frequent saves during development.
*   **Evolution of Query Parameters:** There's an observable pattern of refining how query parameters, especially `CompanyName` and date ranges, are extracted and applied to SQL queries for both safety and flexibility.

## 11:44:46 AM
Overall, the code changes indicate active development and refinement across several core backend functionalities, primarily focusing on data retrieval, filtering, and user management. There is a strong emphasis on implementing role-based access control and dynamic query construction. Recurring patterns include frequent saves (resulting in near-identical code logs), iterative debugging via `console.log` statements, and continuous improvement in SQL query handling, including addressing potential injection vulnerabilities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **(11/5/2025, 12:54:56 PM)**: An `AuthRoutes` router was established with a `GET /auth/verify-token` endpoint. This endpoint is responsible for returning authenticated user information (`req.user`) after token verification.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **(11/5/2025, 6:04:50 PM - 6:06:01 PM)**: Initial implementation of `getDashboardCardInfo` and `getDeliveryData`. `getDashboardCardInfo` calculates shipment metrics (pending departure, in transit, ETA within 1 week, out for delivery) and their TEU equivalents using complex SQL queries with date, company name, and user role-based filtering. `getDeliveryData` fetches delivery/vessel arrival data with mode-specific filtering.
    *   **(11/5/2025, 8:41:51 PM)**: `getDashboardCardInfo` was updated to dynamically derive `CompanyName` using `getUserObject` (from `@src/utils/analytics`) instead of directly from `req.query`, enhancing user-specific data access.
    *   **(11/5/2025, 8:42:22 PM)**: A debugging `console.log` for `req.CompanyName` was added in `getDashboardCardInfo`.
    *   **(11/5/2025, 10:41:50 PM)**: `CompanyName` was removed from direct destructuring in `req.query` for `getDashboardCardInfo`, confirming its derivation from `getUserObject`.
    *   **(11/5/2025, 10:43:59 PM)**: The user-specific condition (`useWhere`) was commented out for `getDashboardCardInfo`, potentially broadening the scope of the dashboard card data or temporarily disabling granular user-level filtering.
    *   **(11/5/2025, 10:44:51 PM)**: A debugging `console.log` for the `result[0]` was added after fetching dashboard card info.
    *   **(11/5/2025, 10:46:26 PM)**: `getDeliveryData` introduced logic to fetch `CompanyName` via `getUserObject` and attempted to apply it as a filter in its SQL queries. However, the direct string concatenation for `CompanyName` in the SQL made it vulnerable to SQL injection.
    *   **(11/5/2025, 10:49:15 PM)**: A `console.log` for error objects was added in the `getDeliveryData` catch block.
    *   **(11/5/2025, 10:51:27 PM)**: Crucially, `getDeliveryData` was refactored for safer SQL query construction. The `CompanyName` was reintroduced to `req.query` destructuring, and a `companyFilter` variable was implemented to properly sanitize and case-insensitively apply the company name to the SQL queries (`LOWER(account_name) = LOWER('${CompanyName.replace(/'/g, "''")}')`), mitigating the SQL injection vulnerability.
    *   **(11/5/2025, 11:06:35 PM)**: `getDeliveryData` reverted `CompanyName` to be derived from `getUserObject` (commenting out the `req.query` destructuring for `CompanyName`), but kept the safe `companyFilter` logic.
    *   **(11/5/2025, 11:07:02 PM)**: `getDashboardCardInfo` reverted to directly destructuring `CompanyName` from `req.query`, undoing the `getUserObject` derivation for this function.
    *   **(11/5/2025, 11:10:55 PM)**: A debugging `logger.info` with a prefix "1234" was added to log the `baseQuery` in `getDashboardCardInfo`.
    *   **(11/5/2025, 11:11:09 PM)**: A debugging `console.log` for `companyFilter` was added in `getDeliveryData`.
    *   **(11/5/2025, 11:13:53 PM)**: In `getDashboardCardInfo`, the `CompanyName` parameter within the SQL query was further enhanced for safety by using `LOWER(account_name) = LOWER('${CompanyName?.replace(/'/g, "''") || ""}')`, ensuring it handles null/undefined values and escapes quotes.
    *   **(11/5/2025, 11:23:11 PM)**: No functional changes from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **(11/5/2025, 8:51:00 PM - 8:51:46 PM)**: This file defines a suite of user management services including `login` (which has a SQL injection vulnerability due to direct string concatenation), `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. Most of these methods use parameterized queries for safer database interaction, except for `login`. Consecutive entries are identical.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **(11/6/2025, 1:27:09 PM)**: Introduced an `getAll` function and a `SqlQueryBuilder` class for managing shipment data. The `SqlQueryBuilder` dynamically constructs SQL queries with pagination, various filters (POL, POD, status, date range, container number), and implements extensive user role-based access control (ADMIN, CUSTOMER, FRONTOFFICE, AGENT). It also includes detailed logic for determining `ShipmentStatus` based on tracking data and adds a `buildCardFilterCondition` method to support dashboard-specific filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **(11/6/2025, 2:02:45 PM)**: Introduced a `BookingQueryBuilder` class and `getAll` function for fetching and filtering booking data. It supports various query parameters and user role-based conditions. An outline for `saveBooking` was also present.
    *   **(11/6/2025, 2:05:16 PM)**: Added `est_cargo_ready_date` to the selected columns in `BookingQueryBuilder`, indicating new data fetching requirements.
    *   **(11/6/2025, 2:16:39 PM)**: Enhanced `BookingQueryBuilder` to support filtering by `CargoReadyFromDate` and `CargoReadyToDate` for estimated cargo ready dates.
    *   **(11/6/2025, 2:26:13 PM)**: Attempted to refactor `whereClauses` to an array for more flexible query construction, but this introduced a potential bug by mixing string and array assignments.
    *   **(11/6/2025, 2:27:15 PM)**: The `whereClauses` refactoring was reverted, restoring it to a single string property and fixing the introduced bug.
    *   **(11/6/2025, 5:05:22 PM - 5:05:30 PM)**: Minor import changes without functional impact.
    *   **(11/6/2025, 5:57:33 PM)**: Introduced a counting inaccuracy in `buildCountQuery` by removing `DISTINCT`.
    *   **(11/6/2025, 5:57:41 PM)**: The counting inaccuracy in `buildCountQuery` was immediately corrected by restoring `DISTINCT`.
    *   **(11/6/2025, 6:03:28 PM - 6:03:51 PM)**: Added a `CONFIRMED` status to the `BookingStatus` enum and updated `setWhereClause` to handle this new status.
    *   **(11/7/2025, 9:51:09 AM - 11:43:35 AM)**: Renamed `CargoReadyFromDate`/`CargoReadyToDate` properties to `cargoReadyFromDate`/`cargoReadyToDate` (camelCase) for consistency.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **(11/6/2025, 6:02:57 PM)**: Expanded the `BookingStatus` enum to include `CONFIRMED` and added `blno` to `BookingQueryType`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **(11/6/2025, 5:06:22 PM)**: Added a new `getBookingApproveDetails` path under `/booking`.
    *   **(11/6/2025, 5:13:57 PM)**: Added a `createBookingApproveDetails` path, reusing the same endpoint as `getBookingApproveDetails`, suggesting a POST route for updates.
    *   **(11/6/2025, 7:20:31 PM)**: No functional changes from the previous timestamp.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **(11/6/2025, 5:06:41 PM)**: Defined a `GET` route for `getBookingApproveDetails`.
    *   **(11/6/2025, 5:15:38 PM)**: Defined a `POST` route for `createBookingApproveDetails`, mapping it to an `updateBookingApproveDetails` handler in the booking service.

**Key Patterns and Recurring Elements:**

1.  **Iterative Development and Debugging:** The numerous identical timestamps or very close timestamps (e.g., in `dashboardService.ts` and `UserService.ts` on 11/5, and `bookingService.ts` on 11/6) suggest frequent saving, possibly auto-formatting, or rapid minor changes/debugging. The addition and removal of `console.log` statements are clear indicators of active debugging.
2.  **Dashboard & Booking Service Refinements:** A significant portion of the changes centers around improving the dashboard data and booking management features. This includes expanding filtering capabilities (date ranges, company names, specific statuses) and enhancing how data is retrieved and presented.
3.  **Dynamic SQL Query Construction:** Both `dashboardService` and `bookingService` employ builder patterns (`SqlQueryBuilder`, `BookingQueryBuilder`) to construct complex SQL queries dynamically based on user inputs and roles. This is a recurring architectural pattern for data access.
4.  **Security Improvements (SQL Injection):** There's a noticeable evolution in `dashboardService.ts` from direct, vulnerable string concatenation for `CompanyName` in SQL queries to a safer, sanitized approach using `replace(/'/g, "''")` and `LOWER()`. This indicates a conscious effort to improve security posture, though the `login` function in `UserService.ts` still uses direct concatenation.
5.  **Role-Based Access Control (RBAC):** Both `shipmentService` and `bookingService` explicitly implement logic to filter data based on the authenticated user's role (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT), ensuring users only see relevant data for their permissions.
6.  **Feature Expansion:** The addition of `est_cargo_ready_date` in booking details, the introduction of a `CONFIRMED` booking status, and new routes for booking approval details indicate ongoing feature development to enhance the booking workflow.
7.  **Minor Refactoring and Consistency:** Changes like renaming `CargoReadyFromDate` to `cargoReadyFromDate` (camelCase) show efforts towards code style consistency. Reverting problematic refactoring (e.g., `whereClauses` to an array in `bookingService`) demonstrates a quick response to code issues.

## 12:45:07 PM
The log details recent development and refinement of several backend services for the T360-V2 application. Key updates span authentication, dashboard data presentation, user management, shipment tracking, and booking functionalities.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\AuthRoutes.ts`**
    *   **(11/5/2025, 12:54:56 PM):** Initial setup of a `/verify-token` GET endpoint. This route is designed to log and return authenticated user information, confirming token validity.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
    *   **(11/5/2025, 6:04:50 PM):** Introduced `getDashboardCardInfo` and `getDeliveryData` functions.
        *   `getDashboardCardInfo` dynamically generates SQL queries to retrieve shipment statistics (e.g., pending departure, in transit, ETA within 1 week, out for delivery) based on `fromDate`, `toDate`, and `CompanyName` from the request query. It includes a `buildMtrUserCondition` for user-specific data filtering.
        *   `getDeliveryData` fetches either delivery or vessel arrival data, applying various mode-specific filters ('ALL', 'Rail Delivery', 'Door Delivery', 'Port Delivery').
    *   **(11/5/2025, 8:41:51 PM):** Modified `getDashboardCardInfo` to derive `CompanyName` using an asynchronous `getUserObject` utility instead of directly from `req.query`, enhancing user-specific data access logic. An import for `getUserObject` was added.
    *   **(11/5/2025, 8:42:22 PM):** Added a `console.log` for the derived `CompanyName` in `getDashboardCardInfo` for debugging purposes.
    *   **(11/5/2025, 10:41:50 PM):** Refined the type assertion for `req.query` in `getDashboardCardInfo`, removing `CompanyName` as a direct query parameter type, reflecting its new derivation.
    *   **(11/5/2025, 10:43:59 PM):** Commented out the application of `buildMtrUserCondition` (`useWhere`) to the `cardQuery` in `getDashboardCardInfo`, indicating a temporary or intentional change in how user-specific conditions affect dashboard card data.
    *   **(11/5/2025, 10:46:26 PM):** Introduced `CompanyName` derivation via `getUserObject` into `getDeliveryData` and applied it as a filter in the SQL queries (`sqlQueryDelivery`, `SqlQueryVesselArrival`). This change, however, initially involved direct string concatenation (`'AND '+CompanyName`), raising potential SQL injection concerns.
    *   **(11/5/2025, 10:51:27 PM):** Implemented a safer SQL injection prevention mechanism in `getDeliveryData`. The `CompanyName` is now escaped using `replace(/'/g, "''")` within a `companyFilter` variable before being used in SQL query strings.
    *   **(11/5/2025, 11:06:35 PM) & (11/5/2025, 11:07:02 PM):** Reverted the `CompanyName` derivation from `getUserObject` in both `getDeliveryData` and `getDashboardCardInfo`, making it directly sourced from `req.query` parameters again.
    *   **(11/5/2025, 11:13:53 PM):** Re-introduced proper sanitization for `CompanyName` in `getDashboardCardInfo`'s `baseQuery`, using `LOWER(account_name) = LOWER('${CompanyName?.replace(/'/g, "''") || ""}')` for safer and case-insensitive filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **(11/5/2025, 8:51:00 PM):** Initial implementation of core user management functions:
        *   `login`: Handles user authentication, validates credentials, checks account status, and generates a JWT token.
        *   `saveUserPreferences`: Allows users to save or update personal preferences and notification settings.
        *   `fetchUserPreferences`: Retrieves user preferences, potentially combining data from multiple tables.
        *   `saveInviteLog`: Logs user invitations and sends invite emails.
        *   `fetchAllCompanyUser`: Fetches a list of active and pending users for a given company.
        *   `userSettings`: Retrieves specific user settings like `date_format`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\shipmentService.ts`**
    *   **(11/6/2025, 1:27:09 PM):** Introduced `getAll` function for retrieving shipment data. It utilizes a `SqlQueryBuilder` class to construct dynamic SQL queries based on various filters (POL, POD, status, date range, card filters) and user roles, including complex logic for determining shipment status (Pending, Loading, In_Transit, Arrived, Delivered, Custom_Hold) from `mtr_tracking_data`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\bookingService.ts`**
    *   **(11/6/2025, 2:02:45 PM):** Initial implementation of booking management with `getAll` and `saveBooking`.
        *   A `BookingQueryBuilder` class was introduced for dynamic SQL generation, supporting pagination, sorting, searching, and filtering by `BookingStatus` (PENDING, APPROVED, CANCELLED, NEW, ALL) and user role.
        *   `saveBooking` handles creating and updating booking records, including data sanitization.
    *   **(11/6/2025, 2:05:16 PM):** Added `abe.est_cargo_ready_date` to the selected columns in `BookingQueryBuilder`.
    *   **(11/6/2025, 2:16:39 PM):** Expanded `BookingQueryBuilder` to include `CargoReadyFromDate` and `CargoReadyToDate` for filtering, and updated `setDateRange` to incorporate these new date ranges.
    *   **(11/6/2025, 2:26:13 PM):** Attempted a refactoring where the `addDateRangeClause` in `BookingQueryBuilder` was modified. The prior public `addDateRangeClause` (which added to `extraConditions`) was commented out, and a new *private* `addDateRangeClause` was introduced which *attempted* to add conditions to `this.whereClauses`. This change likely introduced a bug as `this.whereClauses` is a string, not an array.
    *   **(11/6/2025, 2:27:15 PM):** The problematic refactoring from the previous commit was reverted, restoring the `BookingQueryBuilder` to its prior functional state.
    *   **(11/6/2025, 5:57:33 PM):** Introduced a SQL syntax error in `BookingQueryBuilder`'s `buildCountQuery` by truncating `COUNT(DISTINCT abe.agent_booking_id)` to `COUNTabe.agent_booking_id)`.
    *   **(11/6/2025, 5:57:41 PM):** Corrected the SQL syntax error in `buildCountQuery` but removed the `DISTINCT` keyword, changing `COUNT(DISTINCT abe.agent_booking_id)` to `COUNT(abe.agent_booking_id)`.
    *   **(11/6/2025, 6:03:28 PM):** Integrated the new `CONFIRMED` booking status into `BookingQueryBuilder`'s `setWhereClause` and `getAll`'s status counts.
    *   **(11/7/2025, 9:51:09 AM):** Performed a minor refactoring in `BookingQueryBuilder`, renaming `CargoReadyFromDate` and `CargoReadyToDate` properties and parameters to `cargoReadyFromDate` and `cargoReadyToDate` (lowercase 'c').

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\common\types\booking.ts`**
    *   **(11/6/2025, 6:02:57 PM):** Added `CONFIRMED` status to the `BookingStatus` enum. Included `blno: string` in `BookingQueryType` and `companyname: string` in `AuthReqUser`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **(11/6/2025, 5:06:22 PM):** Initial comprehensive definition of application API paths across various modules. Specific booking paths include `/get-booking`, `/save-booking`, `/aprox-transit`, and `/booking_approve/:agent_booking_id`.
    *   **(11/6/2025, 5:13:57 PM):** Added `createBookingApproveDetails: "/booking_approve/:agent_booking_id"`, which uses the same path as `getBookingApproveDetails`.
    *   **(11/7/2025, 12:17:18 PM):** Introduced `vesselAdd: "/vessel/:agent_booking_id"` to the `Booking` paths.
    *   **(11/7/2025, 12:24:55 PM):** Modified `vesselAdd` path from `"/vessel/:agent_booking_id"` to `"/vessel"`, removing the `agent_booking_id` from the URL parameter.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\routes\BookingRoutes.ts`**
    *   **(11/6/2025, 5:06:41 PM):** Configured Express routes for booking functionality, mapping `GET /get-booking`, `POST /save-booking`, `GET /aprox-transit`, and `GET /booking_approve/:agent_booking_id` to respective service functions.
    *   **(11/6/2025, 5:15:38 PM):** Added a new `POST` route for `Paths.Booking.createBookingApproveDetails` which maps to `updateBookingApproveDetails` service function.
    *   **(11/7/2025, 12:17:36 PM):** Added a new `POST` route for `Paths.Booking.vesselAdd`, mapping to the `addBookingVessel` service function.

**Patterns and Recurring Elements:**

*   **Dynamic SQL Query Building:** A consistent pattern across `dashboardService`, `shipmentService`, and `bookingService` is the extensive use of dedicated builder classes (`SqlQueryBuilder`, `BookingQueryBuilder`) to construct complex SQL queries. These builders handle pagination, sorting, and various filtering criteria dynamically.
*   **User-Role Based Access Control (RBAC):** Data retrieval and filtering logic frequently incorporate `req.user.role` (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT) and associated company/location information to ensure appropriate data visibility and security.
*   **Query Parameter-Driven Filtering:** Functions across services heavily rely on `req.query` for filtering, searching, and date range specification, indicating a flexible API design.
*   **SQL Injection Prevention Evolution:** There's an observable progression in `dashboardService` towards safer SQL query construction. Initial direct string concatenations for `CompanyName` were replaced with methods that sanitize input by escaping single quotes (`.replace(/'/g, "''")`), though this was subject to temporary reverts and re-implementations.
*   **Comprehensive Logging:** `logger.info` and `logger.error` are widely used across the services for debugging, tracking request parameters, and reporting execution flow and errors.
*   **Date Range Filtering:** The ability to filter data using `fromDate` and `toDate` (and `cargoReadyFromDate`/`cargoReadyToDate` for bookings) is a recurring requirement, implemented with dedicated helper methods.
*   **Endpoint Definition and Routing:** `Paths.ts` serves as a central registry for all API endpoints, which are then wired up to service functions in corresponding route files (e.g., `BookingRoutes.ts`), showcasing a structured approach to API management.
*   **Iterative Development:** The multiple identical code entries (e.g., in `dashboardService.ts` and `bookingService.ts` on consecutive timestamps) suggest an iterative development process with frequent saves or minor cosmetic changes. There are also instances of introducing and then quickly correcting errors, such as the SQL syntax error in `bookingService.ts`.