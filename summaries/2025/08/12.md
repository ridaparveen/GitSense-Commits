# Activity Summary for 8/12/2025

## 9:28:20 AM
The log shows updates to two files within the `t360-backend-v2` project on August 11th, 2025.

`dashboardService.ts` (6:57:56 PM): This file contains two API endpoints: `getDashboardCardInfo` and `getDeliveryData`.  `getDashboardCardInfo` retrieves dashboard card information using a complex SQL query that counts shipments based on several conditions (pending departure, in transit, ETA within a week, out for delivery).  These conditions heavily utilize the `mtr_tracking_data` table and columns like `vessel_actualdeparted_date`, `t49_vessel_actualdeparted_date`, `t49_eta`, etc., and filter based on the user's role and a provided date range. `getDeliveryData` fetches delivery and vessel arrival data, again using distinct SQL queries based on the request type ('delivery' or 'vessel'). Both functions use the `query` function from the common utility library to interact with the database and return results as JSON responses.

`shipmentService.ts` (6:58:36 PM): This file contains the `getAll` endpoint, which retrieves all shipments with extensive filtering and pagination capabilities.  The endpoint uses a custom `SqlQueryBuilder` class to construct dynamic SQL queries based on various filter parameters (POL, POD, shipment ID, status, dates, etc.).  A significant portion of the code iterates through the results to enrich each shipment with status information derived from the `mtr_tracking_data` table and its various date fields.  The logic for determining the shipment status (Pending, Loading, Departed, In Transit, Custom Hold, Arrived, Delivered) is complex and relies on multiple date comparisons and conditions from the MTR data.  The `SqlQueryBuilder` class builds conditions based on user roles (Admin, Customer, FrontOffice, Agent), applying appropriate access restrictions to the data.  The code also incorporates error handling and logging using `logger` and `HttpStatusCodes`.


## 1:28:21 PM
The log shows several code changes related to data grids and pagination components in a React application.  The primary focus is on styling and functionality improvements to data grids and the creation of a custom pagination component.

**`datagrid.tsx` (8/11/2025, 6:48:19 PM & 8/11/2025, 6:49:30 PM):** This file contains the main data grid component (`AppGrid`).  The two commits show minor differences, the second commit adds `onPageSizeChange` to the `declare module` and  `FooterPropsOverrides` interface. The component uses `@mui/x-data-grid` and `@mui/x-data-grid-pro` for data grid rendering, and applies custom styling using styled-components and Tailwind CSS.  Significant changes involve enhancing pagination functionality and integrating a custom pagination component (`CustomNewPagination`).  The data grid supports sorting, pagination, and custom row IDs.

**`pagination.tsx` (8/11/2025, 6:52:36 PM & 8/11/2025, 6:52:42 PM):** This file defines two pagination components: `CustomPagination` and `CustomNewPagination`. The first is a simpler version, while the second is more advanced, using a component library (`@components/kit/pagination`) for improved rendering and features like page size selection.  The two commits show the two components being created at nearly the same time.  The `CustomNewPagination` component provides better visual presentation and more robust pagination logic, handling cases like "gaps" in page numbers for better user experience.

**`booking-dashboard.tsx` (8/11/2025, 6:53:12 PM):** This file implements a booking dashboard. It fetches data using `useFetchBookingDashboardDataQuery`, displays booking counts categorized by status (new, pending, completed, cancelled), and uses `AppGrid` to render a booking list with filtering and sorting capabilities.   The component uses Redux for state management and React Router for navigation.

**`shipment-coulmns.tsx` (8/11/2025, 6:53:35 PM):** This file defines several reusable functions to generate column definitions for data grids related to shipments.  `useShipmentCoulmns`, `useShipmentContainersCoulmns`, and `useOverviewDashboardColumns` create different column configurations for various views. They utilize custom components for rendering cells (like progress bars for status) and include actions like tracking shipment details.

**`shipment-container-page.tsx` (8/11/2025, 6:54:56 PM):**  This file shows a page displaying shipment container data.  It leverages `AppGrid`, `FilterSidebar`, and custom hooks from `shipment-coulmns.tsx` for data display and filtering. It uses Redux and custom reducers to handle state and options fetching, with an emphasis on filtering and pagination.  The component also includes autocompletion for fields like POL and POD.

In summary, the changes reflect a concerted effort to improve the data presentation and user interaction within the application.  The development involved creating reusable components for data grids and pagination, integrating these with Redux for state management, and using external libraries for styling and UI elements.  The emphasis on custom components and styling points to a desire for consistent UI throughout the application.  The use of React Router enables navigation between different views.


## 1:30:00 PM
The log shows multiple revisions of the `isf.shipdateupdate.js` file between 11:43 AM and 1:26 PM on August 12, 2025.  The core functionality remains consistent throughout: updating Estimated Time of Departure (ETD) and Estimated Time of Arrival (ETA) fields in an `agent_booking_routing` table based on data from an `mtr_tracking_data` table.  The updates primarily focus on refining the data retrieval and update logic, along with improved logging and error handling.

**Specific File Updates:**

* **Initial Version (11:43 AM):**  This version retrieves ETD and ETA from `agent_booking_routing`. If they don't exist, it attempts to fetch them from `mtr_tracking_data` using `mblno` and updates `agent_booking_routing`. An audit log is created for each updated field.  The initial version has a bug in the `mtr_tracking_data` query (a trailing comma).  It also lacks a check for the `rowCount` of the update query.

* **Subsequent Revisions (12:22 PM - 12:34 PM):** These revisions primarily correct the SQL query in `mtr_tracking_data` fetch.  There were several commits  correcting syntax and field selection  within the  `mtr_tracking_data` query.  Additionally, a check was added to verify that the `UPDATE` statement actually modified a row, adding logging if no rows were updated. The `blno` field is added to the initial query.

* **Revision Focusing on MTR Data and ATA (12:48 PM - 1:26 PM):** A significant change occurs around 12:48 PM. This revision removes reliance on pre-existing ETD/ETA in `agent_booking_routing`. Instead, it directly uses `mtr_tracking_data` data, prioritizing `t49_vessel_actualarrived_date` and `vessel_actualarrived_date` as indicators of ATA activity.  Updates only happen if  ATA data (`t49_vessel_actualarrived_date` or `vessel_actualarrived_date`) is present.  The logic for audit logging is enhanced to compare old and new values before logging.  Several logging messages are improved for clarity.  The `created_by` field in the audit log is set to "SYSTEM".  A requirement that both `mblno` and `blno` exist to proceed is removed, allowing the process to continue if either is present.


**Recurring Elements:**

* Consistent use of `pool.query` for database interactions.
* Extensive logging using `logger.info`, `logger.warn`, and `logger.error`.
* Error handling with `try...catch` blocks, including email notifications using a `gmail.sendEmail` function.
* The `insertAudit` function is consistently used to log database changes.

**Significant Timestamps:**

* **11:43 AM:** Initial version of the code.
* **12:48 PM:** Major restructuring to prioritize `mtr_tracking_data` and ATA activity.
* **1:01 PM & 1:03 PM:**  Further refinement of logic, and removal of redundant check for mblno and blno.
* **1:17 PM & 1:18 PM:**  Minor changes to logging.
* **1:22 PM & 1:26 PM:**  Final adjustments to logging and conditional update logic.

The overall pattern shows an iterative development process, starting with a basic implementation, progressing through bug fixes and logic refinements, and culminating in a more robust and efficient version focused on using  ATA data from `mtr_tracking_data` to determine ETD and ETA updates.


## 2:29:54 PM
The `isf.shipdateupdate.js` file, last modified on August 12th, 2025 at 1:56:28 PM, contains a class `IsfShipDateUpdate` that updates ETD and ETA values in an `agent_booking_routing` table.  It retrieves data from `mtr_tracking_data` based on `mblno` or `blno`, only updating if `t49_vessel_actualarrived_date` or `vessel_actualarrived_date` indicate ATA is active.  An audit log (`isf_audit_log`) is updated for each change using an `insertAudit` function.  The script includes robust error handling with logging and email notifications sent to addresses specified in `config.email.execptionMailList` in case of failure.  The update process iterates through bookings, checking for the existence of necessary data before proceeding with updates.  If no changes are made for a given booking, it logs a warning.  The primary function is `updateEtdAndEta()`.  The code uses PostgreSQL's `pool.query` extensively for database interaction.


## 3:29:58 PM
The log shows a series of modifications to the `isf.shipdateupdate.js` file between 2:33 PM and 3:20 PM on August 12, 2025.  The primary function of this JavaScript file is to update Estimated Time of Departure (ETD) and Estimated Time of Arrival (ETA) data for ISF (Import Security Filing) shipments.  It interacts with a database (`agent_booking_entry`, `mtr_tracking_data`, `agent_booking_routing`) and uses an audit log (`isf_audit_log`) to track changes.  Email notifications are sent in case of errors.

The initial versions of the code (2:33 PM and 2:34 PM) lacked comprehensive error handling and skip conditions, resulting in less efficient processing and potential issues when data was missing or conditions weren’t met.


Significant changes occurred around 2:40 PM, 2:48 PM, and 3:04 PM.  The update at approximately 2:40 PM introduced a more robust definition of an "active shipment", correcting a flaw in how it handled active shipment conditions. The change at 2:48 PM involved a complete restructuring of the `updateEtdAndEta` function.  This refactoring introduced detailed counters to track the number of processed and skipped shipments, categorizing the reasons for skipping.  This is a major improvement in monitoring the script's performance and identifying bottlenecks. The changes at 3:04 PM and later focused on refining the counter names and the clarity of log messages to improve reporting.  Additional skip conditions were added to check for missing routing records and database update failures. The `created_by` field in the audit log was also initially absent and later added with the value "system".

The final version (3:20 PM) includes comprehensive logging and statistics reporting at the end of the process, enhancing the script's usability and maintainability.  It also uses `existingRouting.etd` and `existingRouting.eta` conditions within the `if` statements when updating and logging the audit, resulting in more precise logging and updates.

The `run.UpdateShipDate.js` script, updated at 3:20:52 PM, simply calls the `updateEtdAndEta` function from `isf.shipdateupdate.js` and provides basic logging for the batch process execution time.
