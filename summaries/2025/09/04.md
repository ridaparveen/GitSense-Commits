# Activity Summary for 9/4/2025

## 11:33:25 AM
The log shows several revisions to `GstCustomerLocation.tsx` and `CustomerDetailsForm.tsx` components between 11:01 AM and 11:22 AM on September 4th, 2025.  The main focus is on managing GST locations for customers.

`GstCustomerLocation.tsx`:  The component renders a form to manage GST locations.  Changes include:

* **11:01 AM:** Initial version.  The component fetches customer details, handles adding, editing, and deleting GST locations using Formik. It displays customer information and a table of GST locations.
* **11:02 AM:** Added a `handleDropdownChange` function to handle changes in a select box (initially named "transportaion_mode", later changed to "status").  The select box is for managing the status of the GST locations (Active/Inactive).
* **11:03 AM:**  Minor UI change - removing `<form>` tag from the root and adding `onClick` to the Submit button in order to trigger the `formik.handleSubmit()` function.  This was likely a fix to ensure form submission worked correctly.
* **11:03 AM (second revision):** The `SelectBox`'s `name` attribute was changed from `"transportaion_mode"` to `"status"`.
* **11:09 AM:**  The `formik` `initialValues` are updated to include an initial `status` for GST locations, defaulting to "active" if no locations exist. The `SelectBox` for status is updated to use `formik.values.status` for its value.


`CustomerDetailsForm.tsx`: This component, added later in the log, is a form for managing customer details (not just GST).

* **11:20 AM:** Initial version. This component handles the creation and updating of customer details. It uses Formik, various input components and fetches customer details using `useGetCustomerDetailsQuery`.  It also includes a navigation mechanism to go back to the GST location page.  Importantly, it handles adding new GST locations and updating existing ones by interacting with the `existingGstLocations` passed from the navigation state. A `saveGstLoaction` mutation is used to persist data.
* **11:21 AM:** Minor correction in `initialValues` within `useFormik`, specifically setting the `serial_id` to either the value from the location state or a newly generated timestamp using `Date.now()`.
* **11:22 AM:**  Further minor adjustment of `serial_id` handling in the `initialValues` of `useFormik`.  The unnecessary comma was removed.


`CustomerDetailsPage.tsx`: This page uses `CustomerDetailsForm`. It initializes a `customerData` state with default values for various customer attributes, including arrays for related details like GST registration. The creation of default values implies this is a form for creating new customer records.

`customer.types.ts`: This file defines TypeScript interfaces for customer data and related entities, used by both `GstCustomerLocation` and `CustomerDetailsForm`.  It shows a comprehensive data model for customers.


Recurring patterns:  The code uses a consistent structure for UI components (`PageWrapper`, `InputBox`, `SelectBox`, `Button`), Formik for form management, and React Router for navigation.  The use of `state` in React Router's navigation is consistent to pass data between components. There is extensive use of `console.log` statements for debugging purposes.  The code heavily relies on TypeScript interfaces for type safety.  The application seems to be making API calls to a backend (`customerDataApi`).


## 12:58:41 PM
The log shows modifications to the backend API routes (`otm_bol.route.ts`) and controllers (`otm_bol.controller.ts`) for handling OTM BOL data.

**`otm_bol.controller.ts` (9/4/2025, 12:06:18 PM):** This file contains multiple asynchronous functions (`getPLPOByBOL`, `fetchPayload`, `fetchByBOLNo`, `editOtmBol`, `uploadBolExcel`)  for interacting with a database (likely PostgreSQL, judging by the SQL queries).  The code performs CRUD operations (Create, Read, Update, Delete) on `spr_otm_bol` and `spr_otm_bol_details` tables.  `uploadBolExcel` processes Excel files using the `xlsx` library, cleaning and matching data based on supplier names using Levenshtein distance.  It uses a `common_key` for data association and includes error handling using a custom `HttpError` class.

**`otm_bol.route.ts` (9/4/2025, 12:46:39 PM & 9/4/2025, 12:47:00 PM):** This file defines Express.js routes.  The first commit adds routes for GET requests (`/`, `/fetch_payload`, `/:bol`, `/fetch/:common_key`) and POST requests (`/`, `/upload`, `/upload_save_edit`).  The second commit removes the `/upload` route, which suggests a potential change in how excel uploads are handled. The `/upload` route uses the `uploadMiddleware` to handle file uploads, specifically for files named "plFile" and originally also "dutyFile" (removed in the second commit).  All routes are mapped to functions within `otm_bolController`.

In summary, the code implements an API endpoint to manage OTM BOL data, including database interaction, Excel file processing, and route definitions. The changes show the evolution of the API, particularly with respect to file upload handling and route management. The use of a `common_key` suggests an attempt at managing multiple related data pieces.  The second commit to `otm_bol.route.ts` indicates a removal of the dutyFile handling from the upload route, potentially signifying a refactoring or simplification of the upload process.


## 2:01:44 PM
The log shows development of an API, with significant changes focused on authentication and database configuration.

Initially, `external.routes.ts` (1:09:36 PM) defined API endpoints for `/test`, `/tracking`, `/booking`, and `/invoice`.  A test endpoint returns a protected message including the `req.companyname`.

The `apiAuth.middleware.ts` file underwent several revisions between 1:20:13 PM and 1:22:28 PM.  These revisions added logging of database configuration details (1:22:02 PM), but the core authentication logic, involving API key verification against a `api_keys_master` database table using SHA256 hashing and updating the `last_used_at` timestamp, remained consistent.  The middleware also extends the Express request object to include `companyname` and `api_key_id`.

The `env.ts` file was modified multiple times (1:17:18 PM, 1:23:07 PM, 1:23:28 PM, 1:24:19 PM, 1:27:20 PM, 1:32:16 PM) to define environment variables, primarily focusing on database credentials (`DB_USER`, `DB_HOST`, `DB_NAME`, `DB_PASSWORD`, `DB_PORT`).  The initial version had several missing `!` for non nullable variables, later versions added default values and changed `DB_PASSWORD` default multiple times.  The final version has default values for all database variables.

The `db.ts` file (1:30:56 PM and 1:34:46 PM) establishes a PostgreSQL database connection pool using the environment variables defined in `env.ts`.  It also includes functions for standard query, insert, insertMany, and update operations.  The `insertMany` function correctly handles empty arrays.  The `updateQuery` function handles condition object correctly.  No code changes occurred between the two timestamps for this file, only a log statement was removed.

In summary, the most significant changes involved refining the API authentication (`apiAuth.middleware.ts`) and stabilizing the database configuration (`env.ts`, `db.ts`). The `external.routes.ts` file remained largely unchanged after initial creation.  The multiple edits to `env.ts` suggest iterative refinement of the database connection settings.


## 3:01:44 PM
The log shows multiple revisions to the `invoiceController.ts` file between 2:16 PM and 3:00 PM on September 4th, 2025,  with several minor changes to `external.routes.ts` at 2:16:31 PM.  The primary focus of the revisions is enhancing the `getAll` function within `invoiceController.ts` to improve its functionality and error handling.

**`external.routes.ts` (9/4/2025, 2:16:31 PM):** This file was updated to include a new route `/invoice` that uses the `getAll` function from the `invoiceController`.  Other routes for `/test`, `/tracking`, and `/booking` were already present.

**`invoiceController.ts` (Multiple Revisions):**  This file underwent extensive modification across several commits.  The key improvements include:

* **Dynamic Query Building:** The initial version contained a company filter but lacked dynamic filtering based on other query parameters. Subsequent commits added dynamic filtering, enabling searches based on various columns in the `cng_invoice` table (later generalized to `mainTable`).

* **Database Table Selection:** A significant change introduced at 2:49:46 PM allows the API to fetch data from either the `cng_invoice` or `spr_invoice` tables based on the `type` query parameter.  Corresponding changes were made to related tables and join conditions to accommodate this.

* **Date Filtering:**  The ability to filter invoices by a date range (`fromDate` and `toDate`) was consistently present, but its implementation was refined throughout the revisions.

* **Error Handling:** The error handling was upgraded at 2:25:37 PM to catch specific `syntax error` exceptions and return a 400 bad request, providing more granular error responses to the client. Generic errors result in a 500 internal server error.

* **Removal of Redundant Queries:** A redundant query to fetch all records for a specific company was removed at 2:40:12 PM.

* **Logging:** The `logApiUsage` function was consistently used to log API usage, regardless of success or failure of the request.

* **Query parameter changes**: The query parameters gradually changed with additional parameters like `invoice_no` and `mblno` being added for filtering.

* **Debugging Statements:** Several `console.log` statements were added and modified throughout the revisions, showing a debugging process to inspect query parameters, confirming functionality and resolving issues.  These logs were eventually removed or refined.

The final version of `invoiceController.ts` features a robust and flexible API endpoint to retrieve invoice data with various filtering options and error handling, supporting two different invoice types. The most significant changes occurred around 2:49:46 PM, when table selection based on invoice type was introduced, making the endpoint much more versatile.


## 4:01:42 PM
The log shows three revisions of the `invoiceController.ts` file, all on September 4th, 2025.  The core functionality remains consistent throughout:  a function `getAll` retrieves and returns invoice data based on various query parameters (page, perPage, orderBy, fromDate, toDate, invoice_no, mblno, type). The data is fetched from either "cng_invoice" or "spr_invoice" tables depending on the 'type' parameter, dynamically constructing SQL queries.  The response includes pagination information and total record counts.  Error handling is implemented using `HttpError`.  API usage is logged using `logApiUsage`.

The key differences between revisions lie in the date format within the SQL query:

* **3:02:08 PM:** The `fromDate` and `toDate` parameters are used with 'MM/DD/YYYY' date format in the SQL `TO_DATE` function.
* **3:13:02 PM and 3:23:13 PM:** The date format is updated to 'YYYY-MM-DD' in the same `TO_DATE` function.  The third revision is identical to the second.  This suggests a quick correction to ensure proper date parsing within the SQL query.  No other code changes are apparent between these two revisions.


## 5:01:43 PM
The log shows modifications to an API's routes and invoice controller.

Initially (4:24 PM), `external.routes.ts` defined routes for `/test`, `/tracking`, `/booking`, and `/invoice`,  linking to respective controllers.  The `/test` route returns a message including `req.companyname`.

Between 4:28 PM and 4:35 PM, `invoiceController.ts` underwent several revisions. The `getAll` function, fetching invoice data, was refined.  Key changes include:

*   The initial version (4:28 PM)  used the `type` query parameter ("cng" or otherwise) to dynamically select tables ("cng_invoice" vs. "spr_invoice") and associated details tables. It also included sophisticated query building with parameters for pagination, ordering, and filtering (fromDate, toDate, invoice_no, mblno).  API usage was logged using `logApiUsage`.  Error handling included a specific check for SQL syntax errors.

*   A subsequent revision (4:31 PM) made a minor change: replacing `console.log(req.companyname);` with `console.log("----",req.companyname);`.

*   The final revision (4:35 PM) replaced the `type` based logic with a check  `const is = req.companyname === "SP RICHARDS COMPANY";` for selecting the appropriate tables, suggesting a simplification of the logic based on the company name.


Around 4:39 PM and 4:40 PM, `external.routes.ts` was adjusted. A brief, temporary change at 4:39 PM incorrectly referenced the invoice controller, omitting `.getAll`. This was swiftly corrected in the final revision at 4:40 PM.

In summary, the key updates centered around the `invoiceController`, which evolved from a generic type-based table selection to a company-name based one.  The routing remained largely consistent, primarily involving GET requests for different API functionalities.  The changes demonstrate iterative development, refining both the data fetching logic and error handling.
