# Activity Summary for 2/3/2026

## 1:47:10 PM
The changes primarily focus on enhancing data querying and export functionalities related to booking and tracking reports within the `t360-backend-v2` project. The modifications center around generating dynamic SQL queries and preparing data for export, particularly for analytical reports showing time differences in the shipping lifecycle.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp: 2/2/2026, 4:51:42 PM**
    *   This file introduces the `bookingQueryBuilder` function, which is responsible for constructing dynamic PostgreSQL queries for various booking analytics. It defines interfaces for `CalColumn`, `CalColumnConfig`, `Customizer`, and `QueryBuilderI`.
    *   The `bookingQueryBuilder` supports different report `type`s, including:
        *   "BookingDatetoActualDeparture": Calculates the average day difference between `t49_vessel_actualdeparted_date` and `bookingdate` for file and container numbers.
        *   "BookingDatetoActualDepartureMblWise": Similar to the above, but aggregated by MBL number instead of container.
        *   "BookingDatetoActualDepartureStackedBar" and "BookingDatetoActualDepartureMblWiseStackedBar": These generate queries for stacked bar charts, categorizing day differences into predefined weekly buckets (e.g., 'Less than 1 week', '1 - 2 weeks') and grouping by time periods (month, week, quarter).
    *   Queries incorporate filtering by `account_name` (derived from `CompanyName`), date range, and exclude invalid date entries (`'0001-01-01 00:00:00 BC'`). It also dynamically fetches `selectedColumns` based on user ID and report name.
    *   Subsequent log entries for this file on **2/2/2026** (4:52:50 PM, 5:24:53 PM) and **2/3/2026** (10:11:53 AM, 10:48:41 AM, 1:39:21 PM, 1:43:50 PM, 1:46:23 PM) show identical content, indicating no further code changes in these specific revisions but rather repeated logs of the same file state.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Timestamp: 2/3/2026, 10:39:44 AM**
    *   This file was introduced to provide SQL query fragments specifically for exporting data based on different report names.
    *   It includes a `getMonthValue` helper function to convert textual month names or numbers to integer month values.
    *   The `bookingQuery` function returns a dictionary of SQL string fragments keyed by `reportName`. These fragments define the `SELECT` and `WHERE` clauses for various booking-related reports, similar to `booking.query.ts` but tailored for export.
    *   Supported report names include "Booking Date to Actual Departure" (and its MBL Wise and Stacked Bar variants), "Booking Date to Estimated Departure" (and MBL Wise variant), and "Booking Date to POD Arrival" (and its MBL Wise and Stacked Bar variants).
    *   Conditional logic is applied for `stackedExport` to filter by `displayBy` (month, week, quarter) and `stackedGroup` (e.g., 'Less than 1 week'), allowing for detailed data export from stacked charts.
    *   Similar to `booking.query.ts`, all subsequent log entries for this file on **2/3/2026** (10:42:00 AM, 10:50:18 AM, 10:56:20 AM, 11:51:25 AM, 11:56:13 AM, 12:02:32 PM, 12:10:05 PM, 12:53:02 PM, 12:53:49 PM, 12:54:46 PM, 1:18:51 PM, 1:21:54 PM, 1:28:11 PM, 1:39:47 PM, 1:40:24 PM) show identical content, implying no functional code changes were made after the initial introduction.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Timestamp: 2/3/2026, 10:51:20 AM**
    *   This utility file provides several functions to support analytics and data export:
        *   `defaultDateRange`: Supplies a default date range (last 365 days).
        *   `replaceValueInQuery`: A helper to conditionally replace values in specific columns (`pod`, `place_of_delivery`).
        *   `getUserObject`: Fetches or constructs a user object, handling admin-level company data.
        *   `getFilterQueryByDisplayValue`: Generates SQL `groupBy`, `orderBy`, `dateTrunc`, and `select` clauses based on how data should be displayed (month, week, quarter).
        *   `getExcelSelectedColumns`: Dynamically selects a set of columns for Excel export based on the report name and whether it's a booking report, including special handling for "Cargo-Ready Date to ETD" (calculates `networkdays`) and "BL Release KPI" (calculates `bl_release_date`).
        *   `isValidDate`: Validates date strings to ensure they are parsed correctly and are not '0000-01-01T00:00:00.000Z'.
        *   `dateFilterOnExport`: Processes data items to filter and format specific date fields for export, replacing invalid dates with `null`.
        *   `EXCEL_EXPORT_COLUMNS`: A large, static array defining key-name pairs for all columns intended for Excel export, covering comprehensive tracking and booking details.
    *   Subsequent log entries for this file on **2/3/2026** (11:00:58 AM, 11:46:21 AM) also show identical content.

**Timestamps of Significant Changes:**

*   **2/2/2026, 4:51:42 PM**: Initial introduction of the `bookingQueryBuilder` logic in `booking.query.ts`.
*   **2/3/2026, 10:39:44 AM**: Initial introduction of `getMonthValue` and `bookingQuery` export logic in `export.query.ts`.
*   **2/3/2026, 10:51:20 AM**: Initial introduction of various analytics utility functions and Excel export column definitions in `analytics.ts`.

**Patterns or Recurring Elements:**

*   **Focus on Date Differences and KPIs**: A primary theme across `booking.query.ts` and `export.query.ts` is the calculation and analysis of time differences between key booking/tracking dates (e.g., booking date to actual departure, booking date to POD arrival). This is often presented as averages or categorized into weekly buckets for stacked bar charts.
*   **Dynamic SQL Query Generation**: Both `booking.query.ts` and `export.query.ts` extensively generate dynamic SQL, incorporating company-specific filtering, date range constraints, and conditional clauses for different report types and display preferences.
*   **Robust Date Handling**: There's a consistent pattern of handling dates, including:
    *   `EXTRACT(DAY FROM ...)` and `DATE_PART('day', ...)` for calculating day differences.
    *   `DATE_TRUNC` for grouping by month, week, or quarter.
    *   Explicit checks for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` to filter out default/invalid date entries in database queries.
    *   Specific date validation (`isValidDate`) and formatting (`moment().format("MM/DD/YYYY")`) for data export.
*   **Customization and Configurability**: The use of `customizer` objects in `bookingQueryBuilder` and parameters like `displayBy`, `stackedMonth`, `startWeek`, `endWeek`, `quarter`, `stackedGroup`, and `stackedExport` indicate a design favoring customizable reports and export options.
*   **Repeated Log Entries with Identical Content**: A noticeable pattern is the frequent logging of files (`booking.query.ts`, `export.query.ts`, `analytics.ts`) with identical content across multiple timestamps within the same day. This suggests either frequent, minor (unlogged) saves, automated backup processes, or a version control system logging every save operation, rather than substantive code changes in each instance. The actual code evolution is captured at the first timestamp where new content for a file appears.