# Activity Summary for 2/4/2026

## 2:26:40 PM
The provided log details changes across two main files related to an Anchor Ingredients shipment data processing batch.

**File-Specific Updates:**

*   **`c:\Users\ridap\Documents\Office\cng-batches\cng-batches\scripts\run.AnchorJsonData.js` (Timestamp: 2/4/2026, 1:18:36 PM)**
    This script serves as the main entry point for the batch process. It initializes a logger, records the batch start time, invokes the `anchorJsonData.moveAnchorJsonFileToSftp()` function to perform the core logic, logs the result, and calculates the total execution time of the batch. It uses `dotenv` for environment configuration and `moment` for time handling.

*   **`c:\Users\ridap\Documents\Office\cng-batches\cng-batches\modules\anchor\anchorJsonUploadToSftp.js`**
    This file defines the `AnchorJsonData` class, which handles the complex logic of fetching data, generating a JSON file, and uploading it to an SFTP server.

    *   **Core Functionality:**
        *   **State Management:** It uses a `anchor_json_run.json` file to store and retrieve the `last_run_timestamp`, allowing it to fetch data incrementally (either for the last 24 hours initially or from the last successful run to the current time).
        *   **Data Fetching:** It connects to a PostgreSQL database, executing a comprehensive SQL query to retrieve `mtr_tracking_data` joined with `agent_booking_entry`, `t49_tracking_details`, and `po_details`. The data is filtered for `shipment_completed <> 'Yes'`, `account_name ilike '%Anchor Ingredients%'`, and `lastmodifieddate` within the calculated time window.
        *   **Data Transformation:** The raw database rows are then transformed into a structured JSON format, consolidating shipment details, container numbers, and their respective milestone events (e.g., "Empty Out", "Full In", "Vessel Loaded", "Vessel Arrived").
        *   **File Generation & Upload:** It creates a unique JSON file named `Anchor_Ingredients_Shipment_YYYY-MM-DD_HH-mm-ss.json` in a configured local path and then uploads this file to a specified SFTP server directory (`/IN/`).
        *   **Archiving:** After successful upload, the local JSON file is moved to an archive directory.
        *   **Error Handling:** In case of errors during the upload process, it sends an exception email to a configured list of recipients with details of the error.
        *   **Utilities:** It leverages `fs` and `path` for file system operations, `ssh2-sftp-client` for SFTP connectivity, `moment` for date handling, and custom `gmailSender.utils` and `common.utils` for email and file movement.

    *   **Significant Changes & Timestamps:**
        *   **2/4/2026, 1:23:58 PM:** This timestamp represents the initial detailed version of the `anchorJsonUploadToSftp.js` file, containing all the core functionalities described above. It logs the SQL query using `console.log(sql, "sqldata===");`.
        *   **2/4/2026, 1:25:07 PM:** A minor change was introduced by adding `console.log(rows, "rows===");` after the database query execution. This indicates a temporary debug statement to view the raw results fetched from the database directly in the console.
        *   **2/4/2026, 1:25:37 PM:** The previously added `console.log(rows, "rows===");` was updated to `logger.info(rows, "rows===");`. This change signifies a transition from direct console debugging to integrating the output of raw database rows into the application's structured logging system.

**Patterns and Recurring Elements:**

*   **Date/Time Management:** Consistent and extensive use of the `moment.js` library for formatting, comparing, and manipulating dates and times (e.g., calculating time windows, formatting timestamps for filenames and database queries).
*   **Logging:** Widespread use of a custom `logger` object (`logger.info`, `logger.error`) throughout both files for tracing batch progress, debugging, and reporting errors, indicating a focus on observability.
*   **Configuration Dependency:** The code relies heavily on a `config` object (likely sourced from `../../config/config`) for database connection details, SFTP credentials, file paths (e.g., `anchorJsonFilePath`, `anchorJsonArcFilePath`), and email distribution lists.
*   **Modular Design:** The project employs a modular structure, separating the batch runner (`run.AnchorJsonData.js`) from the core logic (`anchorJsonUploadToSftp.js`) and utilizing shared utility modules (e.g., `gmailSender.utils`, `common.utils`).
*   **Robust Error Handling:** A recurring pattern in `anchorJsonUploadToSftp.js` is the use of `try...catch` blocks to gracefully handle potential issues, logging errors, and sending email notifications to alert administrators.
*   **Debugging Evolution:** The rapid succession of changes in `anchorJsonUploadToSftp.js` (from `console.log` to `logger.info` for database rows) suggests an active debugging phase where temporary console outputs were quickly integrated into the established logging framework.