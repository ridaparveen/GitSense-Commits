# Activity Summary for 2/28/2026

## 1:54:26 PM
The log details recent changes across two core areas of the frontend application: a logout hook and a form for adding carting entries, along with its underlying option service.

**File: `c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\hook\performLogout.ts`**
- **Timestamps:** 2/27/2026, 3:50:41 PM and 2/27/2026, 3:50:51 PM
- **Key Updates:** Both entries for this file show identical code. The `performLogout` asynchronous function handles user logout, distinguishing between "manual" and "auto" reasons. It prevents duplicate logout calls using an `isLoggingOut` flag. It attempts an API call to `/api/users/logout` with the stored token and authentication type. Regardless of API success, it consistently clears user-related data from `localStorage` (token, user, authtype, lastAllowedRoute) and dispatches a Redux action to clear user state. For automatic logouts, it displays a "Session expired" toast, preventing repeat messages. Manual logouts show a "Logged out." toast and redirect to the homepage. A large, identical commented-out block of code is present at the end of the file, suggesting a previous state or a backup during development.

**File: `c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\components\screen\operation\carting\AddCartingForm.tsx`**
- **Timestamps:** 2/27/2026, 5:29:15 PM, 2/27/2026, 6:05:21 PM, 2/27/2026, 6:09:54 PM, 2/27/2026, 6:35:28 PM, 2/27/2026, 6:51:56 PM, 2/27/2026, 6:52:06 PM, 2/27/2026, 6:55:53 PM
- **Key Updates:** This file underwent several iterative enhancements for the `AddCartingForm` component.
    - **Initial (5:29:15 PM):** The form was set up using Formik with fields for shipping details, dates, customer, cargo type, packages, weight, volume, and routing information. `AutocompleteSearch` was implemented for "Vessel/Voyage" and "Customer", with the former auto-filling "POL" and "POD". Date fields were configured to send `null` for empty values to the backend.
    - **6:05:21 PM:** Introduced an `AutocompleteSearch` for "Shipper" (`shipperDisplay`), adding `shipperDisplay` to the form's state interface and initial values. Initially, there was a minor error where it was setting `customer_id` instead of `shipper_id`.
    - **6:09:54 PM:** Corrected the "Shipper" `AutocompleteSearch` to set `shipper_id`. An `AutocompleteSearch` for "Consignee" (`consigneeDisplay`) was added, completing the transition for key party fields to use autocomplete.
    - **6:35:28 PM:** No functional changes, likely a save operation.
    - **6:51:56 PM:** The "Package Type" input field was converted from a standard `InputBox` to a `SelectBox`, populated by a predefined `packageTypeOptions` array listing various units (e.g., FEET, CBM, KGS).
    - **6:52:06 PM:** No functional changes, likely a save operation.
    - **6:55:53 PM:** Both "Routing" and "FPD" fields were upgraded from simple `InputBox` components to `AutocompleteSearch` components, using the "port" endpoint for dynamic suggestions. The selection logic for these fields extracts the port name from a `PORT_NAME~PORT_CODE` format.
- **Patterns:** A clear pattern emerges of replacing static `InputBox` components with dynamic `AutocompleteSearch` or `SelectBox` components for critical data entry fields (Vessel/Voyage, Customer, Shipper, Consignee, Package Type, Routing, FPD). This indicates a move towards improved user experience, data validation, and integration with backend lookup services. Old `InputBox` elements were often commented out rather than removed immediately.

**File: `c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\optionService.ts`**
- **Timestamps:** 2/27/2026, 5:36:25 PM, 2/27/2026, 5:37:49 PM, 2/27/2026, 5:38:26 PM, 2/27/2026, 5:38:32 PM, 2/27/2026, 5:38:57 PM, 2/27/2026, 5:42:24 PM
- **Key Updates:** This service manages static and API-fetched options for various autocomplete and select components.
    - **Initial (5:36:25 PM):** The file defines `staticOptions` for fallback values and a crucial `normalizeOption` function that transforms raw API responses into a consistent `{ value, label, serial_id, raw }` structure based on the `endpointKey`. It handles numerous specific keys like `vessel-voyage`, `port-data`, `sales-export`, and `customer-master`. The `fetchOptions` function integrates with `ApiManager` and can target different backend services (e.g., "accounts" backend).
    - **5:37:49 PM:** A `console.log` statement was added specifically for "customer-master" normalization for debugging purposes.
    - **5:38:26 PM, 5:38:32 PM, 5:38:57 PM:** The `customer-master` normalization logic in `normalizeOption` underwent rapid changes. It first attempted to use `item.nam` for the `value`, then `item.name`, and finally reverted to `item.value`. These rapid changes suggest an iterative debugging process to correctly identify the field containing the value for "customer-master" items from the backend.
    - **5:42:24 PM:** The `customer-master` normalization was finalized to be more resilient, using `item.label || item.name || ""` for the `label` and `item.value || item.name || ""` for the `value`. This flexible approach ensures that the label and value are correctly extracted even if the backend response fields vary slightly.
- **Patterns:** The `normalizeOption` function is a central utility for handling diverse API response structures, applying specific transformations based on the `endpointKey`. The multiple, quick changes to the `customer-master` normalization indicate an active debugging effort to ensure data consistency. Frequent `console.log` statements throughout `fetchOptions` and `normalizeOption` suggest a strong focus on observing and verifying data flow.

## 1:55:01 PM
The code changes reflect a significant ongoing migration and refactoring effort, primarily centered around transitioning from raw SQL queries to Prisma ORM for database interactions, standardizing environment variable loading, and enhancing server startup robustness.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\server.ts`**:
    *   **(2/27/2026, 1:31 PM - 2:01 PM):** Minor adjustments and reversions of `console.log` statements.
    *   **(2/27/2026, 2:06 PM):** A major refactor was introduced, ensuring `config.ts` is imported first, moving file download paths to use `CONFIG` variables, and encapsulating server startup logic within an `async startServer` function. The direct `pool` import was temporarily removed, implying a shift in DB connection strategy.
    *   **(2/27/2026, 2:07 PM - 2:11 PM):** `pool` and a new `testConnection` utility function were reintroduced, and the `startServer` function was updated to use `testConnection` for a robust DB check before starting. Debugging `console.log` statements were added.
    *   **(2/27/2026, 3:04 PM - 3:19 PM):** A partial revert occurred, with the `server.ts` code returning to an earlier state, using `process.env` for file paths and `pool.connect().then().catch()` directly. `process.exit(1)` was added to terminate on DB connection failure.
    *   **(2/27/2026, 3:20 PM - 3:23 PM):** The file content became highly unstable, oscillating between a minimal server setup (just listening to port and basic DB connect) and a fully configured Express app with all routes and middleware. At 3:22 PM, a clean structure with `config.ts` first import, `testConnection`, and structured `try/catch` for server startup was reinstated.
    *   **(2/27/2026, 3:25 PM - 3:31 PM):** Debugging `console.log` statements were extensively added and removed, including logging imported modules directly. Middleware and route configurations were briefly moved *inside* the `startServer` function (an unusual pattern) before being corrected. The file download route was repeatedly commented out and uncommented.
    *   **(2/27/2026, 3:37 PM - 3:53 PM):** Continued fluctuating between simplified and complete versions of the `server.ts` file, with frequent additions/removals of debug logs and inconsistent presence of core middleware and route definitions. The most recent version (3:53 PM) matches a complete setup with all middleware, public/private routes, and direct `pool.connect()` DB check.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\util\database.ts`**:
    *   **(2/27/2026, 1:32 PM - 1:56 PM):** Initial setup with `pg.Pool` using `process.env`. `dotenv.config` was explicitly added at 1:56 PM to ensure environment variables are loaded.
    *   **(2/27/2026, 2:03 PM):** Significant refactoring to use the centralized `CONFIG` object for database connection details instead of direct `process.env` access. Minor syntax changes in query functions.
    *   **(2/27/2026, 2:07 PM):** Introduced an `export const testConnection` function to standardize and improve database connection checks.
    *   **(2/27/2026, 2:49 PM - 3:04 PM):** Reverted back to using `process.env` directly for pool configuration and removed the `testConnection` function. A `console.log` statement for pool configuration was briefly added then commented out.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\routes\index.ts`**:
    *   **(2/27/2026, 1:32 PM):** Added `UserRoutes` and `MenuPermissionRoutes` imports and their respective `apiRouter.use` statements. Initial `console.log` and process error handlers were present.
    *   **(2/27/2026, 2:32 PM):** Debugging console logs and process error handlers were removed.
    *   **(2/27/2026, 2:34 PM):** Briefly added `pool` and `logger` imports along with `pool.connect()` logic directly into the router file, then quickly reverted.
    *   **(2/27/2026, 3:40 PM - 5:02 PM):** Repeatedly commented out and uncommented various API routes (e.g., `PortRoutes`, `HblRoutes`, `CartingRoutes`, `StuffingRoutes`), indicating active development, testing, or conditional deployment of these modules.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\common\util\prisma.ts`**:
    *   **(2/27/2026, 2:01 PM):** Initial creation of the Prisma client setup, using `PrismaPg` adapter and `CONFIG.DATABASE_URL`.
    *   **(2/27/2026, 2:05 PM - 3:32 PM):** Minor refactoring of how `connectionString` is passed to the `PrismaPg` adapter, including the addition and removal of a non-null assertion operator `!`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\config\config.ts`**:
    *   **(2/27/2026, 1:58 PM):** Defined a `CONFIG` object to centralize environment variables. `dotenv.config` was hardcoded to a development environment file. `JWT_REFRESH_SECRET` was incorrectly assigned.
    *   **(2/27/2026, 2:04 PM):** Improved environment variable loading to be environment-aware (`.env.${env}`). `DB_PORT` and `DB_SCHEMA` received default values. `JWT_REFRESH_SECRET` was corrected, and new file path configurations (`UPLOAD_DOC_PATH`, etc.) were added to the `CONFIG` object.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\prisma\models\customer.prisma`**:
    *   **(2/27/2026, 3:35 PM):** Defined `customer` model with basic fields and relations.
    *   **(2/27/2026, 5:22 PM):** Added `@@index` directives for `tenant_id` and `loc_code` and an `@@map("customer_master")` to explicitly define the table name.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\prisma\models\tanent.prisma`**:
    *   **(2/27/2026, 3:36 PM):** Defined the `tenants` model, detailing its numerous one-to-many relationships with other core application models, including `users`, `roles`, `companies`, `JobMaster`, `VesselMaster`, `carting`, and `customer`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\prisma\models\core.prisma`**:
    *   **(2/27/2026, 3:36 PM):** Defined core authentication and organizational models, including `users`, `roles`, `companies`, `company_locations`, `user_menu`, `permissions`, and their audit tables. These models consistently incorporate multi-tenancy fields (`tenant_id`) and audit trails.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\UserService.ts`**:
    *   **(27/2/2026, 3:54 PM):** Significant refactoring of user authentication logic (`login`, `fetchUserWithDetails`, `validateUserPassword`, `updateUserLoginStatus`, `fetchUserMenus`) to use Prisma ORM instead of raw SQL queries. This involved importing `prisma` and rewriting key database access patterns. Functions like `saveNewUser`, `resetPassword`, and `setNewPassword` still largely rely on raw SQL at this stage.
    *   **(27/2/2026, 3:55 PM - 3:59 PM):** Minor additions of `console.log` for debugging within the `login` function.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\cartingService.ts`**:
    *   **(2/27/2026, 5:02 PM):** New file created, implementing a service for Carting records. It uses Prisma extensively for `getAllCarting` (with pagination, search, filters), `getCartingByBillno`, `getPODAnalytics` (using `groupBy`), and `saveCarting`. It defines a `serializeCarting` helper for BigInt handling and includes multi-tenancy filters. A placeholder for `sendCartingEmail` exists.
    *   **(2/27/2026, 6:44 PM):** An interface `SaveCartingBody` was added for type safety, and a `toBigInt` helper function was introduced for converting string IDs to BigInt. Debugging `console.log` was added to `saveCarting`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\vesselAndVoyageService.ts`**:
    *   **(2/27/2026, 5:11 PM):** New file created, implementing a service for Vessel and Voyage data. It primarily uses Prisma for fetching and creating records (`getAll`, `CreateVesselAndVoyage`), including complex filters, pagination, and nested relations. It still uses raw SQL `query` for fetching `document_upload` and `notes`. A `stringifyBigInts` helper is included. Multi-tenancy is applied.
    *   **(2/27/2026, 5:12 PM - 5:13 PM):** Minor adjustment to vessel ID validation in `CreateVesselAndVoyage`.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\prisma\schema.prisma`**:
    *   **(2/27/2026, 5:20 PM):** This file defines core application labels (`notes`, `Sequence`, `port_master`) and notably contains many commented-out model definitions (e.g., `carting`, `customer`, `consignee_master`). This indicates a work-in-progress database schema definition, likely being broken down into smaller, module-specific Prisma schema files (as seen with `operations.prisma`).

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\src\services\searchOptions.ts`**:
    *   **(2/27/2026, 5:20 PM):** Implemented an extensive autocomplete API using a mix of raw SQL (`OptionQuery` helper) and Prisma. It provides search options for various entities like customers, sales persons, employees, ports, vessels, voyages, vendors, commodities, and line bookings.
    *   **(2/27/2026, 5:24 PM):** The "party" search logic (`shipper`, `consignee`, etc.) was migrated from raw SQL to `prisma.partyMaster.findMany`, improving type safety and leveraging Prisma's capabilities.
    *   **(2/27/2026, 6:03 PM - 6:08 PM):** Minor variable name changes within the Prisma-based party search logic.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\envosys-backend\prisma\models\operations.prisma`**:
    *   **(2/27/2026, 5:57 PM):** New file created, defining models related to operations: `JobMaster`, `VesselMaster`, `VesselVoyageMaster`, `VesselRouting`, and their corresponding enums. It also introduces `partyMaster` and `partyType` models, including multi-tenancy fields and relations. This modular schema approach helps manage the growing database definitions.

**Patterns and Recurring Elements:**

*   **Prisma Adoption:** The most prominent pattern is the ongoing migration from raw SQL to Prisma ORM. Many services are being rewritten to use Prisma's client, indicating a strategic shift towards a more type-safe and efficient database access layer. However, some services still retain raw SQL, suggesting a gradual transition.
*   **Multi-tenancy Implementation:** Virtually all new and updated models in Prisma schema files (e.g., `customer`, `tenants`, `core`, `operations`) include `tenant_id` and `loc_code` fields. Corresponding service logic consistently filters data based on `req.user?.tenant_id` and `req.user?.current_location_code`, highlighting a strong architectural focus on multi-tenancy and location-based data isolation.
*   **Environment Variable Standardization:** The `config.ts` file has been improved to load environment variables reliably based on `NODE_ENV` and to provide them through a single `CONFIG` object, which `server.ts` and `database.ts` now consume. This centralizes configuration management.
*   **Server Startup Robustness:** There's a recurring theme of improving the server's initialization, particularly ensuring the database connection is established and tested before the server starts listening, with explicit error handling and application termination on failure (`process.exit(1)`). The frequent changes in `server.ts` demonstrate iterative refinement in achieving this stability.
*   **BigInt Serialization:** The consistent use of helper functions like `serializeCarting` and `stringifyBigInts` indicates that PostgreSQL's `BigInt` type is used for IDs, requiring explicit conversion to string when returned in JSON responses to prevent serialization errors.
*   **Active Development & Debugging:** The numerous `console.log` statements, especially in `server.ts` and `UserService.ts`, and the frequent commenting/uncommenting of code blocks and routes in `index.ts` and `server.ts`, strongly suggest a highly active development phase with frequent testing and debugging. The "chaotic" state of `server.ts` at certain timestamps further supports this.
*   **Modular Prisma Schemas:** The introduction of `prisma/models/operations.prisma` alongside `prisma/schema.prisma` indicates a move towards modular organization of Prisma models, possibly to manage a large and complex schema more effectively.

## 2:54:32 PM
The log details recent development focusing on a frontend application, specifically related to user logout functionality and the implementation of a new "Add Carting" form, alongside enhancements to a shared option service for autocomplete and select inputs.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\hook\performLogout.ts`**
    *   **Timestamps:** 2/27/2026, 3:50:41 PM and 2/27/2026, 3:50:51 PM.
    *   **Updates:** The `performLogout` function handles both manual and automatic logouts. It clears user-related data from `localStorage` and Redux (`userSlice`), attempts to call a backend logout API, and displays toast messages. A mechanism prevents duplicate "Session expired" toasts for auto-logout if a manual logout has already occurred. Between the two timestamps, there was no functional change to the active code; a minor cleanup involved removing an `alert("hiiiii")` statement from a commented-out block of older code within the file.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\components\screen\operation\carting\AddCartingForm.tsx`**
    *   **Timestamps:** Numerous changes between 2/27/2026, 5:29:15 PM and 2/27/2026, 6:55:53 PM.
    *   **Updates:** This component for adding carting entries underwent significant evolution, primarily replacing simple text inputs with advanced `AutocompleteSearch` and `SelectBox` components.
        *   **Initial form setup** (5:29:15 PM) included fields like shipping bill details, dates, customer, cargo type (radio group), vessel/voyage, POL, POD, FPD, routing, packages, gross weight, and volume. `AutocompleteSearch` was initially implemented for "Vessel/Voyage" (autofilling POL/POD) and "Customer".
        *   **Shipper and Consignee Autocomplete:** The form was updated to use `AutocompleteSearch` for "Shipper" (6:05:21 PM) and "Consignee" (6:09:54 PM), enabling dynamic search and selection of these entities, and storing their respective `serial_id`s (`shipper_id`, `consignee_id`).
        *   **Routing Autocomplete:** The "Routing" input was converted to an `AutocompleteSearch` using a "port" endpoint (6:35:28 PM), also capturing a `routing_code`.
        *   **Package Type Select:** A predefined list of `packageTypeOptions` (e.g., FEET, METER, CBM, KGS) was introduced, and the "Package Type" input was replaced with a `SelectBox` (6:51:56 PM). A minor formatting fix to the options array followed (6:52:06 PM).
        *   **FPD Autocomplete:** The "FPD" (Final Place of Discharge) input was also converted to an `AutocompleteSearch` using the "port" endpoint (6:55:53 PM), similar to "Routing", and captures an `fpd_code`.
    *   **Content Patterns:** The form consistently uses `formik` for state management, converts empty date fields to `null` before submission, and provides user feedback via `react-hot-toast`. The transition from basic inputs to autocompletes indicates a move towards richer, more validated data entry.

*   **`c:\Users\ridap\OneDrive\Documents\Envosyes\frontend\envosys-frontend\src\optionService.ts`**
    *   **Timestamps:** Rapid changes occurred between 2/27/2026, 5:36:25 PM and 2/27/2026, 5:42:24 PM.
    *   **Updates:** This service is crucial for transforming raw API data into a standardized `{ value, label, serial_id, raw }` format for UI components.
        *   **Initial Setup** (5:36:25 PM) established `staticOptions` and an extensive `normalizeOption` function with specific logic for various `endpointKey`s, including `vessel-voyage`, `port-data`, sales/CS roles, and `customer-master`. It also introduced `fetchOptions` to retrieve and normalize data, with special handling for "accounts backend" keys.
        *   **Customer Master Normalization Adjustments:** The `customer-master` normalization logic within `normalizeOption` saw several quick modifications in close succession (5:37:49 PM, 5:38:26 PM, 5:38:32 PM, 5:38:57 PM). These were iterative attempts to correctly extract the `value` and `label` from incoming `item` objects, reflecting backend data structure nuances.
        *   **Robust Customer Master Normalization:** The final update (5:42:24 PM) refined the `customer-master` normalization to prioritize `item.label` and `item.value` but included fallbacks to `item.name` for both `label` and `value`, making the parsing more resilient to varied backend responses.
    *   **Content Patterns:** The `normalizeOption` function is a central dispatcher with `else if` blocks for different endpoint keys, demonstrating a modular approach to data transformation. Frequent `console.log` statements indicate active debugging.

### Overall Patterns and Recurring Elements:

*   **Shift to Dynamic Inputs:** There's a clear and consistent pattern of replacing static input fields with dynamic, autocomplete-enabled search boxes (`AutocompleteSearch`) for entities like Customer, Shipper, Consignee, Vessel/Voyage, Routing, and FPD. This improves data quality and user experience by leveraging searchable lists from the backend.
*   **Centralized Option Handling:** The `optionService.ts` acts as a crucial layer for normalizing diverse data structures from various API endpoints into a consistent format expected by frontend components. This abstraction allows frontend components to interact with options uniformly.
*   **Iterative Development:** The rapid sequence of commits, particularly for the `AddCartingForm.tsx` and `optionService.ts`, suggests an active and iterative development or debugging process, with immediate adjustments based on testing or evolving requirements.
*   **Debugging Practices:** The presence of `console.log` statements throughout the `optionService.ts` code indicates ongoing debugging and verification of data flow and transformation.
*   **Frontend-Backend Integration:** Both the logout hook and the carting form directly interact with backend APIs, indicating a full-stack development effort. Specific attention is given to data format consistency (e.g., date to null conversion) and authentication headers.