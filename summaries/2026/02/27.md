# Activity Summary for 2/27/2026

## 1:44:56 PM
The log details changes across several backend files, primarily focusing on database connection, configuration loading, and route management.

**File: `src\common\util\database.ts`**
This file manages the PostgreSQL database connection using `pg.Pool` and provides utility functions for queries.
*   **Initial Setup (2/27/2026, 12:58:09 PM)**: Configured a PostgreSQL `Pool` using environment variables. It included `query`, `insertQuery`, `updateQuery`, and `insertMany` functions, and initially attempted to log database connection status with password masking, along with commented-out Prisma connection logic.
*   **Logging Refinements (2/27/2026, 12:58:17 PM - 1:07:53 PM)**: There were several minor adjustments to `console.log` statements. Initially, password masking was removed from a database config log (12:58:17 PM), then connection promise handling was removed (12:58:28 PM). A detailed pool configuration log was added (1:00:52 PM), and later, this log included `password: process.env.DB_PASSWORD` with a comment indicating an intention to hide it (1:07:53 PM), though the code would expose it.
*   **Global Pool Implementation (2/27/2026, 1:27:07 PM)**: A significant change introduced a global `pgPool` variable to ensure that only a single instance of `pg.Pool` is created, which is beneficial for development environments with hot-reloading.
*   **Log Cleanup (2/27/2026, 1:32:16 PM - 1:32:58 PM)**: Most of the detailed `console.log` statements related to database connection initialization and pool configuration were commented out, leaving only a basic "Initializing database connection..." message active.

**File: `src\routes\index.ts`**
This file serves as the main router for the Express application, integrating various feature-specific route modules.
*   **Route Expansion (2/27/2026, 1:01:06 PM)**: New routes for `UserRoutes` and `MenuPermissionRoutes` were imported and registered with the `apiRouter`.
*   **Debugging Logs (2/27/2026, 1:32:39 PM - 1:32:51 PM)**: A `console.log` statement was added at the top of the file for debugging purposes, initially "Middleware configured successfully" and then briefly "Middleware configured successfully1234".

**File: `config\config.ts`**
This file handles the loading and management of environment variables.
*   **Initial Configuration (2/27/2026, 1:03:52 PM)**: Set up `dotenv` to load environment variables from a specific `.env` file based on `NODE_ENV`. It defined the `CONFIG` object, including database details and JWT secrets, with an initial correction for `JWT_REFRESH_SECRET`.
*   **Refinement and Reversions (2/27/2026, 1:04:32 PM - 1:14:48 PM)**: Error handling and success logging for `.env` loading were temporarily removed (1:04:32 PM). `JWT_REFRESH_SECRET` frequently toggled between using `process.env.JWT_SECRET` and `process.env.JWT_REFRESH_SECRET` (e.g., reverted at 1:04:32 PM, corrected at 1:13:51 PM, reverted again at 1:13:59 PM). The `DB_SCHEMA` was added to the `CONFIG` object (1:13:51 PM).

**File: `src\server.ts`**
This is the main entry point for the backend application, setting up the Express server and its middleware.
*   **Server Setup (2/27/2026, 1:11:35 PM)**: Configured the Express app with JSON/URL-encoded body parsers, CORS, and `morgan` for logging. It defined public routes for user authentication, port/party management, and a migration endpoint. File download routes were also implemented. Authentication middleware (`authenticate`, `attachUser`) was applied before the main `BaseRouter`. Initial database connection was handled using `pool.connect().then().catch()`. `dotenv.config` was also called here.
*   **Database Connection Refactoring (2/27/2026, 1:11:57 AM - 1:26:14 PM)**: The database connection logic was first changed to an immediately invoked async function (IIFE) with a test query (1:11:57 AM) and then refactored into an `async startServer` function that would exit if the DB connection failed (1:26:14 PM).
*   **Environment Variable Loading Consistency (2/27/2026, 1:13:07 PM - 1:30:26 PM)**: The `dotenv.config` call was temporarily removed (1:13:07 PM), then reintroduced (1:27:47 PM), and finally moved to the very top of the file to ensure early loading of environment variables (1:30:06 PM).
*   **Server Startup Reversion and Debugging (2/27/2026, 1:31:30 PM - 1:35:37 PM)**: The `startServer` async function with fail-fast logic was reverted, going back to the simpler `pool.connect().then().catch()` pattern for database connection and server startup (1:31:30 PM). Several `console.log` statements were added or modified for debugging server middleware and the `pool` object itself.

**Recurring Patterns and Significant Changes:**
*   **Database Connection and Configuration**: There's a persistent effort to refine how the PostgreSQL database pool is initialized, logged, and connected. This included making the pool globally accessible for development (hot-reloading) and experimenting with different patterns for ensuring database connectivity upon server start (e.g., fail-fast vs. simple logging). Logging of sensitive information like passwords was also inconsistently handled, with attempts to mask or explicitly log it.
*   **Environment Variable Management**: The placement and handling of `dotenv.config` calls across `config.ts` and `server.ts` indicates an evolving strategy to ensure environment variables are loaded correctly and consistently at the earliest possible point in the application lifecycle. The repeated corrections and reversions of `JWT_REFRESH_SECRET` in `config.ts` suggest debugging or clarifying secret management.
*   **Debugging Practices**: Frequent addition, modification, and commenting out of `console.log` statements across `database.ts`, `index.ts`, and `server.ts` indicate active debugging and a desire for clearer visibility into initialization and middleware execution.
*   **Route Expansion**: New routes for user authentication and permissions were added to the main router, indicating the introduction or expansion of user management features.