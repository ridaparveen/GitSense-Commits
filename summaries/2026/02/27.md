# Activity Summary for 2/27/2026

## 1:44:56 PM
The log details changes across several backend files, primarily focusing on database connection, configuration loading, and route management.

**File: `src\common\util\database.ts`**
This file manages the PostgreSQL database connection using `pg.Pool` and provides utility functions for queries.
*   **Initial Setup (2/27/2026, 12:58:09 PM)**: Configured a PostgreSQL `Pool` using environment variables. It included `query`, `insertQuery`, `updateQuery`, and `insertMany` functions, and initially attempted to log database connection status with password masking, along with commented-out Prisma connection logic.
*   **Logging Refinements (2/27/2026, 12:58:17 PM - 1:07:53 PM)**: There were several minor adjustments to `console.log` statements. Initially, password masking was removed from a database config log (12:58:17 PM), then connection promise handling was removed (12:58:28 PM). A detailed pool configuration log was added (1:00:52 PM), and later, this log included `password: process.env.DB_PASSWORD` with a comment indicating an intention to hide it (1:07:53 PM), though the code would expose it.
*   **Global Pool Implementation (2/27/2026, 1:27:07 PM)**: A significant change introduced a global `pgPool` variable to ensure that only a single instance of `pg.Pool` is created, which is beneficial for development environments with hot-reloading.
*   **Log Cleanup (2/27/2026, 1:32:16 PM - 1:32:58 PM)**: Most of the detailed `console.log` statements related to database connection initialization and pool configuration were commented out, leaving only a basic "Initializing database connection..." message active.

**File: `src\routes\index.ts`**
This file serves as the main router for the Express application, integrating various feature-specific route modules.
*   **Route Expansion (2/27/2026, 1:01:06 PM)**: New routes for `UserRoutes` and `MenuPermissionRoutes` were imported and registered with the `apiRouter`.
*   **Debugging Logs (2/27/2026, 1:32:39 PM - 1:32:51 PM)**: A `console.log` statement was added at the top of the file for debugging purposes, initially "Middleware configured successfully" and then briefly "Middleware configured successfully1234".

**File: `config\config.ts`**
This file handles the loading and management of environment variables.
*   **Initial Configuration (2/27/2026, 1:03:52 PM)**: Set up `dotenv` to load environment variables from a specific `.env` file based on `NODE_ENV`. It defined the `CONFIG` object, including database details and JWT secrets, with an initial correction for `JWT_REFRESH_SECRET`.
*   **Refinement and Reversions (2/27/2026, 1:04:32 PM - 1:14:48 PM)**: Error handling and success logging for `.env` loading were temporarily removed (1:04:32 PM). `JWT_REFRESH_SECRET` frequently toggled between using `process.env.JWT_SECRET` and `process.env.JWT_REFRESH_SECRET` (e.g., reverted at 1:04:32 PM, corrected at 1:13:51 PM, reverted again at 1:13:59 PM). The `DB_SCHEMA` was added to the `CONFIG` object (1:13:51 PM).

**File: `src\server.ts`**
This is the main entry point for the backend application, setting up the Express server and its middleware.
*   **Server Setup (2/27/2026, 1:11:35 PM)**: Configured the Express app with JSON/URL-encoded body parsers, CORS, and `morgan` for logging. It defined public routes for user authentication, port/party management, and a migration endpoint. File download routes were also implemented. Authentication middleware (`authenticate`, `attachUser`) was applied before the main `BaseRouter`. Initial database connection was handled using `pool.connect().then().catch()`. `dotenv.config` was also called here.
*   **Database Connection Refactoring (2/27/2026, 1:11:57 AM - 1:26:14 PM)**: The database connection logic was first changed to an immediately invoked async function (IIFE) with a test query (1:11:57 AM) and then refactored into an `async startServer` function that would exit if the DB connection failed (1:26:14 PM).
*   **Environment Variable Loading Consistency (2/27/2026, 1:13:07 PM - 1:30:26 PM)**: The `dotenv.config` call was temporarily removed (1:13:07 PM), then reintroduced (1:27:47 PM), and finally moved to the very top of the file to ensure early loading of environment variables (1:30:06 PM).
*   **Server Startup Reversion and Debugging (2/27/2026, 1:31:30 PM - 1:35:37 PM)**: The `startServer` async function with fail-fast logic was reverted, going back to the simpler `pool.connect().then().catch()` pattern for database connection and server startup (1:31:30 PM). Several `console.log` statements were added or modified for debugging server middleware and the `pool` object itself.

**Recurring Patterns and Significant Changes:**
*   **Database Connection and Configuration**: There's a persistent effort to refine how the PostgreSQL database pool is initialized, logged, and connected. This included making the pool globally accessible for development (hot-reloading) and experimenting with different patterns for ensuring database connectivity upon server start (e.g., fail-fast vs. simple logging). Logging of sensitive information like passwords was also inconsistently handled, with attempts to mask or explicitly log it.
*   **Environment Variable Management**: The placement and handling of `dotenv.config` calls across `config.ts` and `server.ts` indicates an evolving strategy to ensure environment variables are loaded correctly and consistently at the earliest possible point in the application lifecycle. The repeated corrections and reversions of `JWT_REFRESH_SECRET` in `config.ts` suggest debugging or clarifying secret management.
*   **Debugging Practices**: Frequent addition, modification, and commenting out of `console.log` statements across `database.ts`, `index.ts`, and `server.ts` indicate active debugging and a desire for clearer visibility into initialization and middleware execution.
*   **Route Expansion**: New routes for user authentication and permissions were added to the main router, indicating the introduction or expansion of user management features.

## 2:45:56 PM
The changes log primarily details updates across three core files: `database.ts` (handling PostgreSQL connections), `config.ts` (managing application configuration and environment variables), and `server.ts` (the main Express application setup). There are also changes in `index.ts` (route definitions) and `prisma.ts` (Prisma client setup).

**File-Specific Updates:**

*   **`src\common\util\database.ts`**:
    *   **Early Changes (12:58 PM - 1:07 PM)**: Initially, detailed database connection logging was present, including explicit connection attempts (`pool.connect`). A minor change occurred with password logging, initially masked with `****`, then briefly unmasked, before detailed config logging was mostly commented out. A significant change involved introducing a new `console.log` to show the database pool configuration.
    *   **Singleton Pattern & Cleanup (1:27 PM - 1:32 PM)**: A global singleton pattern was implemented for the PostgreSQL connection pool using `global.pgPool` to prevent multiple instances. Most verbose connection initialization `console.log` statements were commented out.
    *   **Environment Loading and Refactor (1:56 PM - 2:07 PM)**: An explicit `dotenv.config` call was temporarily added to this file, suggesting issues with environment variable loading. This was later removed in a major refactor (2:03:07 PM) where the database configuration shifted from direct `process.env` access to using a centralized `CONFIG` object imported from `config/config.ts`. Query parameter naming conventions (`index` to `i`, `key` to `k`) were also updated.
    *   **Connection Testing (2:07 PM)**: A `testConnection` function was introduced to perform a simple `SELECT 1` query, verifying PostgreSQL connectivity with comprehensive error logging.

*   **`src\routes\index.ts`**:
    *   **New Routes and Debugging (1:01 PM - 1:32 PM)**: New `UserRoutes` and `MenuPermissionRoutes` were imported and registered. Debugging `console.log` statements related to "Middleware configured successfully" were added and modified, along with global `uncaughtException` and `unhandledRejection` handlers.
    *   **Cleanup and Logger Introduction (2:32 PM - 2:35 PM)**: Debugging `console.log`s and global error handlers were removed. A brief attempt was made to import a `logger` and use it for database connection logging, but this was quickly reverted, returning the file to a state without explicit database connection logging or `logger` import.

*   **`config\config.ts`**:
    *   **`dotenv` Management and `CONFIG` Setup (1:03 PM - 1:14 PM)**: The file was enhanced to load environment variables dynamically based on `NODE_ENV` using `dotenv.config`, including initial error handling which was later removed. A `CONFIG` object was defined to centralize environment variables. There were recurring adjustments to `JWT_REFRESH_SECRET`, sometimes mistakenly pointing to `JWT_SECRET`. `DB_SCHEMA` was added to `CONFIG`.
    *   **Hardcoded `dotenv` Path & `CONFIG` Expansion (1:58 PM - 2:04 PM)**: The `dotenv.config` path was temporarily hardcoded to `config/.env.development`. Subsequently, the `CONFIG` object was further refined by explicitly parsing `PORT` and `DB_PORT` as numbers, providing default values for `DB_PORT` and `DB_SCHEMA`, and including paths for document uploads and downloads.

*   **`src\server.ts`**:
    *   **Initial Setup & DB Connection (1:11 PM)**: The Express server was set up with standard middleware (JSON, URL-encoded, CORS, Morgan). Public routes, a migration endpoint, and a dynamic file download endpoint were defined. Authentication middleware was applied, followed by the main API router. Initial PostgreSQL connection logging was implemented using `pool.connect`.
    *   **Robust DB Connection & `dotenv` Re-evaluation (1:11 PM - 1:35 PM)**: The database connection logic was made more robust by moving it into an IIFE and then into a `startServer` async function, which included a test query and exited the process on connection failure. There were several changes regarding `dotenv` import and `dotenv.config` placement, attempting to ensure environment variables were loaded early and consistently, with some reintroductions and removals of the `dotenv` call within `server.ts`. Various `console.log` statements were added for debugging server startup and middleware configuration.
    *   **Configuration Centralization & Refactoring (2:01 PM - 2:11 PM)**: A crucial change was adding `import "../config/config";` as the very first line to ensure `CONFIG` is loaded early. `dotenv` imports and calls were removed from `server.ts` itself. Directory paths for file downloads were updated to use values from the `CONFIG` object. The explicit `pool.connect()` was removed, and `testConnection` (from `database.ts`) was reinvoked to ensure DB connectivity before server startup, along with additional console logs for tracking server load and startup.

*   **`src\common\util\prisma.ts`**:
    *   **Prisma Client Initialization (2:01 PM - 2:05 PM)**: This file was introduced to set up the Prisma client, utilizing the `@prisma/adapter-pg` and the `DATABASE_URL` from the centralized `CONFIG` object. A non-null assertion `!` was added to `CONFIG.DATABASE_URL`.

**Patterns and Recurring Elements:**

*   **Environment Variable Loading Strategy**: There's a clear, evolving pattern of trying to standardize and centralize environment variable loading. Initially, `dotenv.config` was called in `config.ts` with error handling, then removed, and later brought back. `database.ts` and `server.ts` also independently tried loading `dotenv` at different points, indicating difficulty in establishing a reliable single source. The final pattern in `server.ts` is to explicitly `import "../config/config";` as the very first line, which relies on `config.ts` to handle `dotenv.config` once.
*   **Database Connection Initialization**: Multiple iterations are observed in `database.ts` and `server.ts` concerning how the PostgreSQL connection pool is created, logged, and tested. This includes masking passwords in logs, commenting out verbose logging, implementing a global singleton for the pool, and finally integrating a `testConnection` function to ensure readiness before the server starts.
*   **Configuration Centralization**: There's a strong trend towards moving database and other application-wide configurations from direct `process.env` access to a structured `CONFIG` object defined in `config.ts`, making these settings more manageable and consistent across the application.
*   **Debugging and Logging**: Frequent additions and removals of `console.log` statements across `database.ts`, `index.ts`, and `server.ts` highlight active debugging efforts, particularly around middleware setup, database connections, and server startup.
*   **Route Expansion**: `src/routes/index.ts` consistently shows the addition of new routes related to user management, permissions, container types, and party masters, indicating ongoing feature development.
*   **Database Name Changes**: The development environment file (`config/.env.development`) shows repeated changes to the `DB_NAME` variable (e.g., `prisma_db`, `envo_old`, `neon_db`, `main_envo`), suggesting frequent database setup or migration testing. Changes to document path variables also occurred, along with commenting/uncommenting of entire production sections.