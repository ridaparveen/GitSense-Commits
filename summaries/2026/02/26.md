# Activity Summary for 2/26/2026

## 1:32:35 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` was last updated on 2/26/2026, 12:43:16 PM. This file defines the `bookingQueryBuilder` function, which is responsible for constructing dynamic SQL queries for various booking-related analytics and reports.

The `bookingQueryBuilder` function takes a set of parameters including `type`, `customizer` (which configures reporting options like date ranges, column configurations, and chart types), `CompanyName`, `fromDate`, `toDate`, `displayBy`, `user_id`, and `reportName`.

Key functionalities based on the `type` parameter include:

*   **`BookingDatetoActualDeparture`**: Calculates the average difference in days between `t49_vessel_actualdeparted_date` and `bookingdate` per unique `fileno` and `contno`. It then determines the percentage of each entity's average relative to the maximum average, ordering results in descending order. The `customizer` is configured for date range analysis, average calculation (`avg`), and specific date columns.
*   **`BookingDatetoActualDepartureMblWise`**: Similar to the above, but the calculation and grouping are performed per `fileno` and `mblno`, focusing on Master Bill of Lading (MBL) wise analysis. The `customizer` is also set to `mblwise: true`.
*   **`BookingDatetoActualDepartureStackedBar`**: Categorizes the day difference between `t49_vessel_actualdeparted_date` and `bookingdate` into predefined time buckets (e.g., "Less than 1 week", "1 - 2 weeks", "Above 5 weeks"). It then aggregates these counts, grouping by categories derived from the `displayBy` parameter using the `getFilterQueryByDisplayValue` utility. The `customizer` is set to `chartType: "StackedBar"`.
*   **`BookingDatetoActualDepartureMblWiseStackedBar`**: This type follows the pattern of the `StackedBar` query but applies the difference calculation and categorization on an MBL-wise basis (`fileno` and `mblno`), similar to `BookingDatetoActualDepartureMblWise`. The `customizer` is also set to `mblwise: true` and `chartType: "StackedBar"`.

**Recurring patterns and elements:**

*   All queries involve joining `mtr_tracking_data` with `agent_booking_entry` tables on `LOWER(mblno)`.
*   A consistent filtering mechanism is applied across all queries, using `CompanyName`, `departure_date` within a specified `fromDate` and `toDate` range.
*   Date fields (`t49_vessel_actualdeparted_date`, `bookingdate`) are checked for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` to ensure valid date calculations.
*   The `customizer` object is frequently updated to reflect the analytical and display requirements for each query type, including setting `dateRange`, `calType` (e.g., "avg"), `dateColumns`, `booking`, `mblwise`, and `chartType`.
*   Utility functions like `getColumnsByCategory` and `getFilterQueryByDisplayValue` are used to dynamically determine selected columns and construct filtering/grouping clauses for queries, enhancing flexibility.
*   The core calculation in most queries involves `EXTRACT(DAY FROM t49_vessel_actualdeparted_date - bookingdate)` to find the day difference between actual departure and booking dates.