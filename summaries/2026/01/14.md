# Activity Summary for 1/14/2026

## 2:30:23 PM
The code changes log reveals recent updates focused on frontend functionality, particularly around user authentication, dashboard features, and a new UI component. All modifications occurred on January 14, 2026.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\services\ApiService.ts` (Timestamp: 1/14/2026, 9:49:53 AM)**
    *   An interception logic was added to the global `window.fetch` mechanism. This logic now detects `401 Unauthorized` responses for requests targeting the application's API base URL. Upon detecting a 401, it logs a message to the console, clears `localStorage`, and redirects the user. The redirection path depends on the `authtype` stored in `localStorage`: "auth0" users are sent to `VITE_UI_V1_BASE_URL`, while others are redirected to `/login`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\dashboard\dashboard-page.tsx` (Multiple Timestamps)**
    *   **Initial Major Update (1/14/2026, 10:47:02 AM):** This file received extensive updates, significantly enhancing the dashboard page.
        *   **Imports:** Numerous UI components (e.g., `PageWrapper`, `Card`, `AppGrid`, `Calendar`, `Dialog`, `FilterSidebar`), React icons, and utility libraries (`moment`) were imported.
        *   **State Management:** New `useState` hooks were introduced to manage UI elements like calendar date, notification dialog visibility, sidebar state, calendar type (vessel/delivery), dialog content, and selected notifications. A `deliveryMode` state was also added.
        *   **Data Fetching:** The page now uses Redux Toolkit Query (`useFetchShipmentDataQuery`, `useFetchDeliveryDataQuery`, `useFetchCartDataQuery`) to fetch various dashboard data. These queries incorporate complex filtering logic based on user roles (`ADMIN_V2`), selected customers, date ranges, and card filters.
        *   **Calendar Logic:** A `useMemo` hook, `weekData`, was implemented to process delivery and vessel data, preparing it for display in a calendar. This includes a `determineDeliveryMode` function to categorize deliveries (Rail, Door, Port).
        *   **Filter & Pagination Handlers:** Functions like `handlePage`, `handlePageSizeChange`, `handleFilterChange`, `handleClearFilters`, and `handleTransportModeChange` were added to manage the dashboard's interactive data grid and filters. `handleClearFilters` now specifically clears `airstatus` and `transpot_mode` filters.
    *   **Minor Adjustment (1/14/2026, 10:48:27 AM):** The `CompanyName` parameter in the `useFetchCartDataQuery` for non-"ADMIN_V2" users was changed from `localUser?.companyname` to an empty string.
    *   **Cosmetic Change & Revert (1/14/2026, 10:48:39 AM & 1/14/2026, 11:04:54 AM):** A duplicate `console.log` statement was temporarily added and then removed, indicating a small, non-functional change that was quickly reverted.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\common\chip-tabs-view.tsx` (Timestamp: 1/14/2026, 11:10:44 AM)**
    *   A new reusable React component, `ChipsTabView`, was created. This component displays a horizontally scrollable row of customizable chip-style tabs, optionally including a "New" button. It handles scrolling with `ChevronLeft` and `ChevronRight` icons and applies conditional styling based on the currently selected tab.

**Patterns and Recurring Elements:**

*   **Focused Development:** All changes occurred on the same day, 1/14/2026, suggesting a concentrated effort on these frontend areas.
*   **Redux/RTK Query Integration:** The dashboard (`dashboard-page.tsx`) heavily leverages Redux for global state management and Redux Toolkit Query for efficient data fetching, demonstrating a consistent architectural pattern.
*   **Component-Driven UI:** The creation of `ChipsTabView` and the extensive use of existing common UI components (e.g., `PageWrapper`, `Card`) in the dashboard indicate a strong component-driven approach to frontend development.
*   **Debugging Practices:** Several `console.log` statements are present across the dashboard code, indicating active debugging during its development.
*   **Comprehensive Filtering:** The dashboard features robust filtering capabilities, including date ranges, card filters, and status filters, with special handling for admin users and different transport modes.
*   **Moment.js for Date Handling:** The `moment` library is consistently used for date and time manipulations, particularly within the calendar display logic.

## 2:30:31 PM
The changes log primarily details development and refactoring within a batch processing system, focusing on a customer master data migration script and its associated configurations.

### File-Specific Updates:

*   **`c:\Users\ridap\Documents\Office\cng-batches\cng-batches\customer_master\customerMaster.js`**
    *   **1/13/2026, 11:26:49 AM - 11:30:03 AM**: The file initially implemented an asynchronous `migrate` method within a `MigrateAccountNames` class. This method fetches distinct `account_name` data from `mtr_tracking_data` and inserts it into `po_accountmaster_customer_master`'s `cname` column, avoiding duplicates based on `cname` and utilizing a transaction (BEGIN/COMMIT/ROLLBACK). It used CommonJS `require` and a custom `logger`.
    *   **1/13/2026, 11:31:49 AM - 11:34:14 AM**: The module system was refactored to use ES Modules (`import`/`export`), and the logger was updated to use named imports (`info`, `error`). The import path for `db.js` was also adjusted.
    *   **1/13/2026, 11:49:49 AM**: Custom logger imports were removed, and logging reverted to direct `console.log` and `console.error`.
    *   **1/13/2026, 11:58:19 AM - 12:09:11 PM**: The core SQL migration logic underwent significant evolution:
        *   Initially, it started inserting `customer_code` into an `acode` column alongside `cname`.
        *   The duplicate checking mechanism (`NOT EXISTS` clause) was refined multiple times, moving from checking `cname` only, to `cname` and `acode`, then to `acode` only.
        *   A more efficient `ON CONFLICT (acode) DO NOTHING;` clause was introduced to handle unique constraint violations for `acode`.
    *   **1/13/2026, 12:37:15 PM**: The target table name in the SQL query was updated to `PO_AccountMaster_Customer_Master` (case change).
    *   **1/13/2026, 2:24:55 PM - 5:15:02 PM**: The duplicate handling logic was further altered. It first reverted to a `NOT EXISTS` clause checking only `cname` and then combined it with `ON CONFLICT (acode) DO NOTHING;`, implying a dual-level uniqueness requirement. Minor adjustments were made to logging the inserted row count.
    *   **1/13/2026, 6:32:33 PM - 6:32:52 PM**: The module system was switched back to CommonJS (`require`/`module.exports`), and the export method was corrected.

*   **`c:\Users\ridap\Documents\Office\cng-batches\cng-batches\scripts\run.customerMaster.js`**
    *   **1/13/2026, 11:30:29 AM**: An initial script was created to execute the `customerMaster.migrate()` function. It included batch start/end logging and execution time tracking. The batch was initially described as "Exception Date Validation Batch Started".
    *   **1/13/2026, 5:15:45 PM**: The import statement for `customerMaster` was updated to `require(...).default` to match the `export default` syntax previously used in `customerMaster.js`. The batch start message was updated to "Customer Master Batch Started".
    *   **1/13/2026, 6:35:19 PM**: The import statement reverted to a direct `require(...)` after `customerMaster.js` switched back to CommonJS `module.exports`.

*   **`c:\Users\ridap\Documents\Office\cng-batches\cng-batches\config\config.js`**
    *   **1/13/2026, 11:32:56 AM**: This configuration file defines settings for development and production environments, including database connection parameters, file system paths for various batch processes (XML, Excel, CSV), API credentials (CNG Integration), email distribution lists for reports and notifications, SFTP connection details, and other application-specific settings like T360 URLs and validation flags.
    *   **1/14/2026, 10:09:10 AM**: Significant expansion of configurations:
        *   Several new email distribution lists were added for specific reports (e.g., `isfNotAcceptedReport`, `co2EmissionEmail`, `shipmentAddedT49Check`, `sprBokingReport`, `bookingStatusReport`).
        *   New top-level configuration objects were introduced for `co2_emission_config`, `t49` (with an authentication token), `geolocation` (with URL and API key), and Lune API settings (`lune_client_account_ids`, `lune_api_key`) for both development and production.
        *   The `anchorSftpConfigJSON` now includes a `passphrase` for SFTP connections.
        *   A minor path update for `cngInvExcel` in the development environment.

### Patterns and Recurring Elements:

*   **Module System Instability**: The `customerMaster.js` file and its corresponding `run.customerMaster.js` script frequently switched between ES Modules (`import`/`export`) and CommonJS (`require`/`module.exports`) syntax. This suggests an ongoing effort to standardize or test module loading.
*   **Evolving SQL Logic**: The SQL query within `customerMaster.js` for inserting and handling duplicate `customer_master` entries underwent continuous refinement throughout the day, indicating active development and tuning of data migration rules, particularly around what constitutes a unique customer record.
*   **Configuration Growth**: The `config.js` file consistently expanded, especially with new email notification categories and new external API integrations (T49, Geolocation, Lune API). This reflects an expanding feature set or reporting requirements for the batch system.
*   **Transactional Integrity**: All database migration operations consistently wrap in `BEGIN`, `COMMIT`, and `ROLLBACK` to ensure data consistency in case of errors.
*   **Batch Automation**: The `run.customerMaster.js` script exemplifies a pattern for running batch jobs, including logging start/end times, execution duration, and graceful exit handling.

## 2:30:36 PM
The code changes detail significant updates across two primary files: `getCustomerOptions.ts` and `code.controller.ts`, with an additional new file `isfCodePartyCreateXml.ts` introduced.

### File-Specific Updates:

1.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\getCustomerOptions.ts`**
    *   **Timestamp:** 1/13/2026, 12:32:05 PM
    *   **Updates:** The `getAllCustomerOptions` function was substantially refactored. The previous implementation, which included extensive commented-out code for role-based logic (AGENT, CUSTOMER) and pagination, was removed. The new version simplifies the customer option retrieval to a single query that searches `po_accountmaster_customer_master` for distinct customer names (`cname`), allows for case-insensitive search via a `search` query parameter, and limits results to 10. The results are formatted into `{value: cname, label: cname}` pairs.
    *   A new function, `deleteCustomerOption`, was added to handle the deletion of a customer mapping from the `Account_Master_Customer_MAP` table, requiring a `customer_id` from the request parameters. It includes basic validation and error handling.

2.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts`**
    *   **Timestamps:** 1/13/2026, 12:46:32 PM, 12:49:54 PM, 12:52:41 PM, 12:57:16 PM, 12:58:58 PM, 2:10:39 PM, 2:32:23 PM, 5:10:48 PM, 5:12:31 PM
    *   **Updates (Iterative `getAllCustomer` function):**
        *   **Initial version (12:46 PM):** Implemented pagination, dynamic column search, and sorting for fetching customer data from `PO_AccountMaster_Customer_Master`. It included sub-queries to fetch related shipper and document data. The `shipperQuery` used direct string concatenation for `acode`, posing a potential security risk.
        *   **Minor logging (12:49 PM):** Added `console.log(error, "error--======");` in the error block.
        *   **SQL clause fix (12:52 PM):** Modified the `countQuery`'s `WHERE` clause to ensure it's always valid, even if `searchCondition` is empty, by using `${searchCondition || "WHERE 1=1"}`.
        *   **Major refactoring and security enhancements (12:58 PM):** The `getAllCustomer` function was extensively restructured with numbered steps for clarity (e.g., "STEP 1: Fetch table columns dynamically"). Crucially, the SQL queries for fetching shipper and document data were updated to use parameterized queries (`$1`) for `acode` (e.g., `WHERE acode = $1`), mitigating SQL injection vulnerabilities. Error logging in the catch block was updated to `console.error(error)`.
        *   **Distinct customer handling (2:10 PM):** The `dataQuery` was changed to `SELECT DISTINCT ON (p.cname)` to retrieve only one record per distinct customer name, and the `countQuery` was adjusted to accurately count these distinct customers for pagination.
        *   **Logging adjustments (2:32 PM, 5:10 PM, 5:12 PM):** There were several changes related to logging, with `logger.info` calls being removed and then partially reintroduced, and error logging switching between `console.error` and `logger.error`. This indicates ongoing debugging and refinement of logging practices.
    *   **Updates (`createCustomer` function):** This function remained largely stable across these timestamps. It handles customer creation or modification, including file uploads, sanitizing the customer name (`cname`), parsing customer mappings, and managing database transactions. It checks for existing customers by `acode`; if found, it deletes existing associated records (types, shipper maps, pics) before re-inserting, effectively performing an update. It also generates unique `acode` and `subcode` values.

3.  **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\utils\isfCodePartyCreateXml.ts`**
    *   **Timestamp:** 1/14/2026, 9:50:27 AM
    *   **Updates:** A new class `IsfCodePartyUpload` was introduced to handle the process of fetching data, generating XML files, and uploading them to an external "DESC" service.
    *   It defines methods for `upload()`, `fetchData()`, `uploadFile()`, and `updateStatus()`.
    *   `fetchData()` retrieves all records from `agent_po_account_master`.
    *   `uploadFile()` reads XML content, constructs Basic Authentication headers using environment variables (containing sensitive information, details of which are omitted as per instructions), sends an HTTP POST request to the external service's URL (also from environment variables), parses the XML response, determines the status (SENT, FAILED_TO_SEND, NEW), and records the outcome.
    *   `updateStatus()` updates `cng_xml_batchlog` with the processing status, reference numbers, and error messages, and conditionally updates the `isf_status` in `agent_booking_entry`.
    *   Extensive `logger.info` and `logger.warn` calls are used for tracing the execution flow of the upload process.

### Patterns and Recurring Elements:

*   **Database Interaction:** All files heavily rely on the `query` function from `../config/database` for executing SQL commands, indicating a centralized database access layer.
*   **Error Handling and Logging:** A consistent `try...catch` block pattern is used for robust error handling, often returning `500 Internal Server Error`. `logger.info`, `logger.warn`, and `logger.error` are frequently utilized for detailed operational logging and debugging, though `console.log` and `console.error` also appear.
*   **Data Transformation:** The `chkStr` utility is repeatedly used to sanitize or normalize string values from database results, ensuring data consistency.
*   **Request-Response Flow:** Express.js `AuthenticatedRequest` and `Response` objects are standard across the controller files for handling HTTP requests and sending structured JSON responses.
*   **Dynamic SQL Construction:** Controllers build dynamic `WHERE` and `ORDER BY` clauses based on incoming query parameters, enabling flexible search and sorting.
*   **Pagination:** The `getAllCustomer` function consistently implements pagination using `page`, `perPage`, and `offset`.
*   **Customer-Centric Operations:** A significant portion of the changes revolves around managing customer master data, including retrieval, creation/modification, and mapping to other entities (shippers, documents).
*   **Security Improvements:** A notable pattern in `code.controller.ts` is the shift from string concatenation to parameterized queries for SQL, enhancing protection against SQL injection.
*   **External Service Integration:** The `isfCodePartyCreateXml.ts` file introduces a pattern for integrating with external services, including fetching data, transforming it (implied XML generation), sending it via HTTP, processing responses, and updating internal records based on the external service's feedback.

## 2:30:57 PM
The code changes primarily occurred across three files: `customerAutosearchOptions.ts`, `export.query.ts`, and `booking.query.ts`, with significant updates to `dashboardService.ts` and `analytics.ts` utilities.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`**
- **Timestamp: 1/13/2026, 1:06:31 PM:** The `getAllCustomerOptions` function was substantially refactored. It introduced a `search` query parameter.
    - For the **AGENT** role, the SQL query was updated to include fuzzy searching (`ILIKE`) on the `cname` field from `agent_po_account_master`.
    - For the **CUSTOMER** role, a major overhaul occurred: previous distinct account name queries with pagination from `mtr_tracking_data` were commented out. A new, more complex SQL query was introduced targeting `PO_AccountMaster_Customer_Master`. This query fetches a `customer_name` and a `customer_array` (which includes the `cname` and any associated `customer_map` entries). A crucial addition was a `NOT EXISTS` subquery to ensure only top-level (unmapped) customer names are returned.
- **Timestamp: 1/13/2026, 2:12:28 PM:** A minor but important refinement was made to the **CUSTOMER** role's SQL query by adding `DISTINCT ON (p.cname)` to ensure uniqueness of customer names in the result set, paired with `ORDER BY p.cname`.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
- **Timestamp: 1/13/2026, 2:51:27 PM:** This file was introduced or significantly updated. It defines a `getMonthValue` helper and the core `bookingQuery` function.
    - The `bookingQuery` acts as a factory, generating various SQL query strings based on a `reportName` (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival (Stacked Bar)").
    - All queries consistently join `mtr_tracking_data` and `agent_booking_entry` tables and apply company-specific filtering (`LOWER(account_name) IN (...)`) and date validity checks (e.g., `IS NOT NULL`, `!= '0001-01-01 00:00:00 BC'`).
    - Queries for "Stacked Bar" reports include conditional logic to filter by month, week, or quarter and categorize date differences into predefined week-based buckets (e.g., 'Less than 1 week', '1 - 2 weeks').
- **Subsequent timestamps (from 1/13/2026, 3:10:10 PM to 5:07:53 PM):** The content of this file remained unchanged, suggesting no further functional modifications after the initial update.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
- **Timestamp: 1/13/2026, 2:57:29 PM:** This file was introduced or significantly updated, containing the `bookingQueryBuilder` function.
    - `bookingQueryBuilder` constructs complex SQL queries for analytics reports. It uses injected `customizer` object properties and external utility functions (`getColumnsByCategory`, `getFilterQueryByDisplayValue`) to define report-specific columns, date ranges, and chart types.
    - It generates distinct SQL for:
        - Calculating average day differences between booking and actual departure dates (both container-wise and MBL-wise), including percentage calculations.
        - Producing data for stacked bar charts, where `day_diff` categories are pivoted into columns and aggregated by dynamic date truncations (month, week, quarter).
- **Subsequent timestamps (from 1/13/2026, 3:18:18 PM to 4:20:22 PM):** The content of this file remained unchanged, indicating no further functional modifications after its initial detailed entry.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
- **Timestamp: 1/13/2026, 4:06:21 PM:** This utility file was introduced or extensively updated.
    - It provides `defaultDateRange` for date calculations, `replaceValueInQuery` for SQL transformations, and `getUserObject` for handling user-specific company access, especially for ADMIN roles.
    - Crucially, `getFilterQueryByDisplayValue` dynamically generates SQL clauses (GROUP BY, ORDER BY, DATE_TRUNC, SELECT) based on whether data should be displayed by month, week, or quarter.
    - It includes `getExcelSelectedColumns` for tailoring exported columns by report name and `dateFilterOnExport` to clean invalid date values and format valid ones for export.
    - A large `EXCEL_EXPORT_COLUMNS` array defines standard export columns.
- **Subsequent timestamps (1/13/2026, 4:20:51 PM):** No functional changes were recorded.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\dashboardService.ts`**
- **Timestamp: 1/14/2026, 10:26:30 AM:** This file defines `getDashboardCardInfo` and `getDeliveryData`.
    - `getDashboardCardInfo` initially constructed a `companyList` for filtering and calculated dashboard metrics (pending departure, in transit, ETA within 1 week, out for delivery, and their TEU equivalents) using `COUNT(*) FILTER` and `SUM(...) FILTER` clauses.
    - `getDeliveryData` fetched delivery or vessel arrival data, using `ROW_NUMBER()` for distinct MBLs, and applied conditional filters based on `type` (delivery/vessel) and `mode` (ALL, Rail, Door, Port Delivery). Both functions integrated user-specific filtering via `buildMtrUserCondition`.
- **Timestamp: 1/14/2026, 10:28:56 AM:** The explicit `CompanyName` parsing logic for building `IN` clauses within `getDashboardCardInfo` was commented out, indicating a shift towards centralizing this filter. `getDeliveryData`'s `companyFilter` logic was slightly adjusted but still used.
- **Timestamp: 1/14/2026, 10:29:57 AM:** The company filtering logic was further centralized and standardized.
    - The `CompanyName` query parameter is now used to construct a `multipleUser` object which, along with the user's role, is passed to `buildMtrUserCondition`. This function now handles all company-specific filtering.
    - The previously explicit or commented-out `CompanyName` parsing and `IN` clause construction within both `getDashboardCardInfo` and `getDeliveryData` were removed or replaced.
    - SQL queries in `getDeliveryData` now directly use the `useWhere` string generated by `buildMtrUserCondition`.
- **Subsequent timestamps (from 1/14/2026, 10:31:25 AM to 11:03:33 AM):** No further functional changes were recorded. A minor `console.log` was added at 10:43:38 AM.

**Overall Patterns and Recurring Elements:**
- **Dynamic SQL Generation:** A dominant pattern across `export.query.ts`, `booking.query.ts`, and `dashboardService.ts` is the dynamic construction of complex PostgreSQL queries based on various input parameters.
- **Centralized Filtering:** There's a clear trend towards centralizing company and user-specific filtering logic into a utility function (`buildMtrUserCondition` in `src\utils\common`), which then provides a `WHERE` clause component. This improves modularity and maintainability.
- **Date Handling:** Consistent handling of date fields, including parsing, validation (e.g., ignoring '0001-01-01 BC' dates), formatting, and calculating differences (`EXTRACT(DAY FROM ...)`), is present in analytics and dashboard services.
- **Table Joins:** The `mtr_tracking_data` and `agent_booking_entry` tables are frequently joined in analytics queries, indicating their central role in the application's data model.
- **Pagination and Search:** Explicit implementation of search functionality using `ILIKE` and mentions of pagination (even if commented out) suggest standard practices for handling large datasets in API endpoints.
- **Iterative Development:** The presence of extensive commented-out code segments, particularly in `customerAutosearchOptions.ts`, highlights an iterative development process where old logic is preserved during new feature implementation.
- **Debugging:** `console.log` statements are occasionally added in services, indicating active debugging during development.
- **TEU Calculation:** The consistent division by 20 for TEU calculation points to a standard unit conversion within the application.
- **Frequent Saves:** Many consecutive timestamps show identical code, implying numerous saves during development rather than distinct code changes.