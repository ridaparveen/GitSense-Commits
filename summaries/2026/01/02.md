# Activity Summary for 1/2/2026

## 10:35:10 AM
**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
    *   **1/2/2026, 9:50:21 AM:** The component initializes `mapping` from `formik.values.customer_mapping` defaulting to `[{ customer: "" }]`. An `AppAutocomplete` component uses `onInputChange={(val) => handleOptionChange(val)}`, explicitly marked with a `// ✅ FIXED` comment.
    *   **1/2/2026, 9:51:10 AM:** The default initialization for `mapping` was altered to `|| [{ customer: "" }] || []`, adding an additional fallback to an empty array.
    *   **1/2/2026, 9:51:29 AM:** The `mapping` initialization reverted to `|| [{ customer: "" }]`.
    *   **1/2/2026, 9:51:40 AM:** The `mapping` initialization was changed to a simpler `|| []`, meaning it would default to an empty array if `formik.values.customer_mapping` was falsy.
    *   **1/2/2026, 9:51:58 AM:** The `mapping` initialization again reverted to `|| [{ customer: "" }]`.
    *   **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were modified to include `|| []` as a fallback, specifically `value={row.customer || []}` and `options={optionsCustomer || []}`.
    *   **1/2/2026, 9:58:08 AM:** The changes to `AppAutocomplete` props were reverted, setting them back to `value={row.customer}` and `options={optionsCustomer}`. The `// ✅ FIXED` comment next to `onInputChange` was removed.
    *   **1/2/2026, 9:58:13 AM:** No discernible code changes from the previous entry.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`**
    *   Multiple entries between **1/2/2026, 10:18:40 AM** and **1/2/2026, 10:26:07 AM** show the exact same code content. No actual code changes were detected in this file across these timestamps. This indicates multiple saves without modifications or reverts to the same state. The file imports various React hooks, MUI components, formik, redux, and API management utilities to handle booking confirmation, including XML generation and upload.

**Timestamps of Significant Changes:**

*   **1/2/2026, 9:50 AM - 9:58 AM:** A rapid succession of changes and reverts occurred in `CustomerMapping.jsx`, particularly concerning how initial customer mapping data is handled and how `AppAutocomplete` props are defined.
*   **1/2/2026, 9:54:29 AM:** A specific change in `CustomerMapping.jsx` added `|| []` fallbacks to `AppAutocomplete`'s `value` and `options` props, which was then quickly reverted.

**Patterns and Recurring Elements:**

*   **Trial-and-error development:** The frequent changes and immediate reverts in `CustomerMapping.jsx` suggest an iterative development process, possibly debugging or refining how empty states or initial values are handled for form fields.
*   **Consistent project structure:** Both files are part of a `t360-frontend` project, deeply nested within `src/components/screen/code/customer` and `src/pages/booking` respectively, indicating modular component organization.
*   **React and Material-UI usage:** Both components are React functional components that extensively use `@mui/material` components for UI, `useState`, `useEffect`, and `useCallback` hooks for state and lifecycle management.
*   **Formik integration:** Both components utilize `formik` for form state management and validation.
*   **API Service interaction:** Both components interact with an `ApiManager` for data fetching, reflecting a service-oriented architecture.
*   **Logging:** Console logs (`console.log`, `console.error`, `console.warn`) are frequently used for debugging and tracking component behavior, especially in `AgentBookingConfirmation.jsx` during form submission, file selection, and API call outcomes.

## 10:36:04 AM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts` defines an asynchronous function `getAllCustomerOptions` responsible for fetching customer or agent options based on a `role` query parameter. This function consistently incorporates query parameters for pagination (`page`, `perPage`), a search term (`search`), and handles database interactions using `@src/common/util/database` while logging errors with `@src/common/util/logger`.

**Timestamp: 1/2/2026, 10:12:16 AM**
At this timestamp, the code implements distinct logic for `AGENT` and `CUSTOMER` roles.
- For the `AGENT` role, it queries `agent_po_account_master` to retrieve distinct `cname` values, applying a `LIMIT 10` and now incorporating a `WHERE` clause to filter results using `cname ILIKE` based on the provided `search` parameter.
- For the `CUSTOMER` role, a new, active implementation is present. This logic specifically checks if a `search` term is provided. If `search` exists, it queries `Account_Master_Customer_MAP` to retrieve `customer_name` and an aggregated array (`customer_array`) containing both the `customer_name` and `DISTINCT customer_map` values. This array is intended to serve as the `value` for the response, while `customer_name` is the `label`. If no `search` term is provided, it returns an empty array.
- A significant amount of previous implementation code for the `CUSTOMER` role, which handled pagination and distinct `account_name` selection from `mtr_tracking_data` (both with and without search, and using different counting methods), is extensively commented out, indicating prior iterations or considered alternatives.

**Timestamp: 1/2/2026, 10:12:28 AM**
The code at this timestamp is identical to the entry at 10:12:16 AM, suggesting a non-substantive save or minor formatting change.

**Timestamp: 1/2/2026, 10:31:18 AM**
This timestamp marks a significant change in the `CUSTOMER` role's active logic.
- The previously active code for the `CUSTOMER` role (which utilized `Account_Master_Customer_MAP` and `array_cat` for search-based mapping) is now **commented out**.
- A block of code previously commented out for the `CUSTOMER` role has been **re-activated**. This re-activated logic:
    - Queries `mtr_tracking_data` for distinct `account_name` values.
    - Incorporates a flexible `whereClause` to apply `account_name ILIKE` filtering based on the `search` parameter for both paginated and non-paginated requests.
    - For paginated requests, it performs a `COUNT(DISTINCT account_name)` query to get the total, followed by a data query with `LIMIT` and `OFFSET`.
    - For non-paginated requests, it defaults to a `LIMIT 10`.
This indicates a strategic shift back to a more traditional distinct account name retrieval with pagination and search from `mtr_tracking_data`, moving away from the more complex customer mapping array generation.

**Timestamp: 1/2/2026, 10:32:29 AM**
The code at this timestamp is identical to the entry at 10:31:18 AM, again indicating a non-substantive save.

**Patterns and Recurring Elements:**
- **Iterative Development:** The repeated commenting out and re-activation of large code blocks, particularly for the `CUSTOMER` role, highlights an iterative development process where different approaches were tested and revised.
- **Search Functionality:** The consistent integration of a `search` query parameter and its application using `ILIKE` in SQL queries is a recurring pattern across both `AGENT` and `CUSTOMER` roles throughout the changes.
- **Role-Based Logic:** The function consistently separates logic based on `role` (AGENT vs. CUSTOMER), demonstrating clear modularity.
- **Database Interaction and Error Handling:** The use of `query` for database operations and `logger.error` within a `try-catch` block for error handling is standard practice across all versions.
- **Frequent Saves:** The timestamps show very close save times (e.g., 10:12:16 AM, 10:12:28 AM, 10:31:18 AM, 10:32:29 AM), with some entries being identical, which can indicate frequent saves during development.
- **Data Formatting:** The consistent output format of `[{ label: string, value: any }]` for dropdown or auto-search options is maintained.

## 10:36:24 AM
The `SelectCustomer.tsx` file, last modified on 1/2/2026, at 10:35:28 AM, introduces a React component named `SelectCustomerPanel`. This component provides a robust customer selection interface, designed to allow users to select, search for, and persist a customer choice.

Key functionalities and details include:
*   **Customer Selection and Persistence:** The component displays a selected customer and allows users to change it via a dropdown. The selected customer is stored and retrieved from `localStorage` using the key "selectedCustomer" to maintain state across sessions.
*   **Search and API Integration:** It features an input field for searching customers. As the user types or when the dropdown opens, customer options are dynamically fetched from an API (`ApiManager.getCustomerOptions`). The API call supports a search keyword, a "CUSTOMER" role, and pagination (`perPage: 5`).
*   **Dropdown UI:** The component renders a compact display of the selected customer which, when clicked, expands into a dropdown. This dropdown includes a search bar, a list of customer options (with loading and "no results" indicators), and "Cancel" and "Add" buttons.
*   **State Management and Side Effects:** React hooks are extensively used:
    *   `useState` manages the dropdown's open/closed state, the selected customer, options, search input, and loading status.
    *   `useEffect` hooks handle initial loading of the stored customer from `localStorage`, fetching customer options based on search/dropdown state, and attaching/detaching a global `mousedown` event listener for click-away functionality to close the dropdown.
    *   `useRef` is employed for referencing the anchor and dropdown elements to implement the click-away logic accurately.
*   **User Interaction:**
    *   Users can type in the search box to filter customer options.
    *   Clicking an option sets it as the temporarily selected customer.
    *   The "Add" button saves the temporary selection to `localStorage` and triggers the `onSelect` prop.
    *   The "Cancel" button discards any unsaved changes and reverts to the previously stored customer.
    *   A "Clear" button is available within the dropdown to clear the search input.
*   **Styling and Components:** The component heavily utilizes Tailwind CSS classes for styling. It integrates external UI components such as `Button` (from `@components/kit/button`), `PencilIcon` (from `@heroicons/react/16/solid`), and `FiSearch` (from `react-icons/fi`) for visual elements.

The component follows a common pattern for interactive selection elements in React, combining local state, API interactions, and local storage for data persistence, all while providing a user-friendly interface with search capabilities and clear state indicators.

## 11:35:17 AM
In `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`:
- **1/2/2026, 9:50:21 AM:** The component was initialized. It handles customer mapping using `formik`, fetches customer options, and allows adding/deleting/updating customer rows in a `Grid` using `AppAutocomplete` and `IconButton`s. The `mapping` array defaults to `[{ customer: "" }]`.
- **1/2/2026, 9:51:10 AM:** The default value for the `mapping` array was slightly modified, adding an extra `|| []` (`[{ customer: "" }] || []`), which appears redundant.
- **1/2/2026, 9:51:29 AM:** The redundant `|| []` was reverted, restoring `mapping`'s default to `[{ customer: "" }]`.
- **1/2/2026, 9:51:40 AM:** The `mapping` initialization was changed to `formik.values.customer_mapping || []`, removing the default empty customer object.
- **1/2/2026, 9:51:58 AM:** This change was reverted, bringing the `mapping` initialization back to `formik.values.customer_mapping || [{ customer: "" }]`.
- **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were updated to include a fallback to an empty array (e.g., `value={row.customer || []}`), ensuring they always receive an array.
- **1/2/2026, 9:58:08 AM:** The `value` and `options` props of `AppAutocomplete` were reverted to their original state (without the `|| []` fallback). Additionally, the `onInputChange` prop, which was previously commented out with `// ✅ FIXED`, was uncommented and made active, indicating a functional fix or activation.
- **1/2/2026, 9:58:13 AM:** No functional changes were recorded from the previous timestamp.

In `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`:
- **1/2/2026, 10:18:40 AM:** This timestamp marks the initial appearance or a major commit for a complex `AgentBookingConfirmation` page component. It integrates Material-UI, `formik` for validation, Redux (`useSelector`) for state, and RTK Query for API interactions (fetching booking details, packing lists, updating DOs, and generating/uploading XML). The component handles file uploads, manages selected/deselected packing lists (`selectedPl`, `deselectedPl`), and provides responsive design. The `onSubmit` logic is robust, managing different user actions ("save_and_next", "send-to-otm") and providing user feedback via `react-hot-toast` for success, errors, and warnings.
- **1/2/2026, 10:19:36 AM**, **1/2/2026, 10:19:54 AM**, **1/2/2026, 10:22:10 AM**, **1/2/2026, 10:26:07 AM:** The code content for these timestamps is identical to the first entry for this file. This suggests either multiple saves without functional changes or very minor, uncaptured alterations.

**Patterns and Recurring Elements:**
- All changes occurred on **1/2/2026**.
- **Rapid Iteration/Debugging:** The `CustomerMapping.jsx` file saw numerous small changes and reverts within a short timeframe (9:50 AM to 9:58 AM) concerning initial state values and component prop handling, indicative of active debugging or refinement.
- **Form Management:** Both files extensively use the `formik` library for managing form state and validation.
- **API Interaction:** Both components rely on `ApiManager` or RTK Query hooks to fetch and update data, centralizing backend communication.
- **UI Framework:** Material-UI components (`Grid`, `IconButton`, `AppAutocomplete`) are a common dependency across the codebase.
- **Logging and User Feedback:** The `AgentBookingConfirmation.jsx` component makes significant use of `console.log` for debugging and `react-hot-toast` for user notifications, including a custom `WarningToast` for handling non-critical issues.

## 11:36:03 AM
The provided log details changes exclusively within the file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`. This file contains the `getAllCustomerOptions` asynchronous function, which is responsible for fetching customer options based on roles and search criteria.

**File-Specific Updates:**

*   **Timestamp 1/2/2026, 10:12:16 AM:**
    *   A `search` query parameter was introduced to the function.
    *   For the `AGENT` role, the SQL query was updated to include a `WHERE` clause that filters `cname` using `ILIKE` with the new `search` parameter, maintaining a `LIMIT 10`.
    *   The previous logic for the `CUSTOMER` role (which handled pagination and distinct `account_name` from `mtr_tracking_data`) was entirely commented out.
    *   A new, uncommented `CUSTOMER` role logic was introduced. This new logic, active only if a `search` query is present, queries `Account_Master_Customer_MAP`. It fetches `customer_name` and an aggregated `customer_array` (which includes `customer_name` and distinct `customer_map` values), filtering by `customer_name ILIKE` the search term and applying a `LIMIT 10`. If no search term is provided for the `CUSTOMER` role, it returns an empty array.

*   **Timestamp 1/2/2026, 10:12:28 AM:**
    *   No functional code changes were introduced compared to the previous entry. This appears to be a save operation or a minor, non-functional edit.

*   **Timestamp 1/2/2026, 10:31:18 AM:**
    *   The `CUSTOMER` role logic underwent a significant reversal. The newer logic that queried `Account_Master_Customer_MAP` was commented out.
    *   The older `CUSTOMER` role logic (which retrieved distinct `account_name` from `mtr_tracking_data` and included pagination support) was uncommented and reactivated. This re-enabled pagination and search capabilities on `account_name` for customers.

*   **Timestamp 1/2/2026, 10:32:29 AM:**
    *   This entry effectively reverts the change made at 10:31:18 AM. The `CUSTOMER` role logic that queried `mtr_tracking_data` was commented out again.
    *   The `CUSTOMER` role logic that queries `Account_Master_Customer_MAP` and constructs the `customer_array` (active when a search term is present) was uncommented and reactivated.

**Patterns and Recurring Elements:**

*   **Role-based logic:** The function consistently segregates data fetching logic based on `role` (AGENT or CUSTOMER).
*   **Search functionality:** The introduction of a `search` parameter and its integration into SQL queries using `ILIKE` for case-insensitive matching is a recurring theme.
*   **Dynamic querying:** SQL queries are constructed dynamically based on query parameters like `role`, `pagination`, and `search`.
*   **Data transformation:** Results from database queries are consistently mapped to objects with `label` and `value` properties.
*   **Database interaction:** All changes involve interacting with a PostgreSQL database using a `query` utility.
*   **Error handling:** A consistent `try-catch` block is used to log errors and return a 500 status code for internal server errors.
*   **Iterative Development/Experimentation:** The frequent commenting and uncommenting of entire code blocks, particularly for the `CUSTOMER` role, suggests an ongoing process of refining or experimenting with different data retrieval strategies for customer options. There's a clear back-and-forth between two distinct approaches for customer data.

## 11:36:37 AM
The code changes primarily revolve around customer selection functionality and its integration with a global state management system.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **Timestamp Range: 1/2/2026, 10:35:28 AM - 11:27:52 AM**
    *   This React component, `SelectCustomerPanel`, manages customer selection through a dropdown with search capabilities.
    *   **Initial Changes (10:35 AM - 11:16 AM):** There was repeated modification of whether the `onSelect` callback should use `selectedCustomer.value` or `selectedCustomer.label`. Similarly, the `getDisplayText` function was adjusted to prioritize `selectedCustomer?.label` over `selectedCustomer?.value` for display. The `CustomerOption` interface's `value` property was also made optional.
    *   **Minor Adjustment (11:22:49 AM):** A brief attempt was made to use `selectedCustomer.value[0]` for the `onSelect` callback, suggesting an anticipation of `value` potentially being an array. This was quickly reverted in the subsequent commit (11:23:09 AM).
    *   **Significant Update (11:27:21 AM):** The component's rendering logic for customer options was refined. The `key` for mapped options changed from `opt.value` to `opt.label`. Crucially, the `onClick` handler for selecting an option and the display logic within the dropdown were updated to explicitly handle cases where `opt.value` might be an array. If `opt.value` is an array, `opt.label` is used as the selected customer's `value` property, and `opt.value[0]` is used for display if `opt.label` is missing. This indicates a clarification or adaptation to the expected data structure of `CustomerOption`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **Timestamp Range: 1/2/2026, 11:18:39 AM - 11:22:40 AM**
    *   This Redux slice manages global application state, including the `selectedCustomer` and a `loading` indicator.
    *   **Initial Implementation (11:18:39 AM):** The `setSelectedCustomer` reducer was designed to store only the `label` property of a `CustomerOption` object (both in the Redux state and `localStorage`), along with a comment indicating this intention.
    *   **Refinement (11:21:20 AM):** The `setSelectedCustomer` reducer was updated to directly accept a `string | null` payload for `selectedCustomer`, simplifying the logic to store this string directly without needing to extract a `label` property. It also added a check for non-empty strings (`value.trim() !== ""`) before storing.
    *   **Debugging (11:21:42 AM):** A `console.log` statement was temporarily added within the `setSelectedCustomer` reducer to output the payload value, likely for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 1/2/2026, 11:30:27 AM**
    *   This analytics screen component was updated to integrate with the global `selectedCustomer` state.
    *   It now consumes the `selectedCustomer` and `loading` states from the `globalSlice`.
    *   If the authenticated user has a "CUSTOMER" role, their `companyname` is automatically dispatched and set as the global `selectedCustomer`.
    *   Crucially, API calls for fetching dashboards (`useFetchDashboardsQuery`) and analytics endpoints (`useLazyFetchEndpointsQuery`, `useLazyFetchReportQuery`) are now made conditional on `selectedCustomer` being present and utilize it as the `companyname` parameter for fetching relevant data. This ensures analytics data is loaded in the context of the globally selected customer.

**Patterns and Recurring Elements:**

*   **Evolving `selectedCustomer` Management:** There's a clear pattern of refining how the "selected customer" is managed. Initially, it involved local state and `localStorage` in `SelectCustomer.tsx`, then a Redux slice was introduced to centralize this state, impacting other components like `analytics-page.tsx`.
*   **`label` vs. `value` Handling:** A recurring theme in `SelectCustomer.tsx` is the back-and-forth decision-making on whether to use `customer.label` or `customer.value` for display and callback purposes, suggesting an ambiguity or evolving requirement for customer identification. This eventually led to explicit array handling for `opt.value`.
*   **Local Storage Usage:** Both `SelectCustomer.tsx` (using `STORAGE_KEY`) and `global-slice.ts` consistently use `localStorage` to persist the selected customer, allowing the selection to persist across sessions or page reloads.
*   **Rapid Iteration:** The close timestamps of many changes, particularly within `SelectCustomer.tsx` and `global-slice.ts`, indicate a period of rapid iteration, development, and debugging. The temporary `console.log` further supports this.
*   **Dependency on `selectedCustomer`:** The `analytics-page.tsx` clearly demonstrates a new dependency on the `selectedCustomer` state, indicating that much of the analytics data loading is now scoped to the currently selected customer.

## 12:35:12 PM
`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`
This file, a React component named `CustomerMapping`, underwent several rapid changes between 1/2/2026, 9:50:21 AM and 9:58:13 AM. The primary focus of these changes was the initialization of the `mapping` array (derived from `formik.values.customer_mapping`) and the props passed to the `AppAutocomplete` component.

Initially, `mapping` defaulted to `[{ customer: "" }]`. This default was briefly changed to `|| [{ customer: "" }] || []` at 9:51:10 AM, then reverted at 9:51:29 AM, changed again to `|| []` at 9:51:40 AM, and finally reverted back to `|| [{ customer: "" }]` at 9:51:58 AM, indicating an iterative process to determine the desired default state for the customer mapping list.

Similarly, at 9:54:29 AM, `|| []` was added to the `value` and `options` props of `AppAutocomplete` (i.e., `value={row.customer || []}` and `options={optionsCustomer || []}`) to ensure they always received an array, but these additions were removed at 9:58:08 AM. The `// ✅ FIXED` comment on the `onInputChange` prop was also removed at 9:58:08 AM, suggesting that the underlying fix was confirmed. The final entry at 9:58:13 AM shows no functional change, likely a mere save operation.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`
This file saw multiple consecutive save operations between 1/2/2026, 10:18:40 AM and 10:26:07 AM, with the provided snippets showing identical code content across these timestamps. The component, `AgentBookingConfirmation`, handles the confirmation process for agent bookings.

The key functionalities observed in the provided code snippet (specifically the `onSubmit` handler of the `formik` instance) include:
-   **Form Submission**: Submitting booking data, including a `do_document` file and a JSON payload.
-   **Data Management**: The payload includes `agent_booking_id`, arrays of `selectedPl` (Packing Lists) and `deselectedPl`, and `vesselList`.
-   **API Interaction**: Uses Redux Toolkit Query mutations (`useUpdateDoMutation`, `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`) to update booking details, generate XML, and upload XML.
-   **User Feedback**: Leverages `react-hot-toast` for loading, success, and error messages.
-   **Warning Handling**: Implements a mechanism to display warnings returned from the API using a `WarningToast` component and can throw a custom error to trigger a `PopupAlert` for warnings.
-   **Workflow Control**: Based on `userAction`, it either proceeds to the next step (`setActiveStep(2)`) or triggers XML generation and upload to OTM (Oracle Transportation Management).
-   **Error Handling**: Catches general errors and specific custom warning errors to display appropriate alerts.

**Patterns and Recurring Elements:**
-   **Frequent Saves**: Both files show a pattern of multiple saves within a short timeframe, often without functional changes, which is common during active development or debugging.
-   **React Hooks and Formik**: Both components extensively use React hooks (`useState`, `useEffect`, `useCallback`, `useMemo`) for state and lifecycle management, and `useFormik` for robust form handling, including validation schemas and submission logic.
-   **MUI Integration**: Both utilize Material-UI (`@mui/material`) components like `Grid`, `IconButton`, and various others, indicating a consistent UI library choice.
-   **API Interaction**: Both components interact with backend APIs, either directly via `ApiManager` or through Redux Toolkit Query, to manage data.
-   **Debugging and Logging**: There is consistent use of `console.log` and `console.error` throughout the `AgentBookingConfirmation` component's `onSubmit` logic, suggesting active debugging and traceability.

## 12:36:23 PM
The code changes primarily focus on enhancing analytics reporting and customer search functionalities within the `t360-backend-v2` project. Key updates include refinements in SQL query generation, improved handling of dynamic parameters, and a move towards more secure and flexible data retrieval methods.

**File: `src\services\analytics\customerAutosearchOptions.ts`**

*   **Initial Update (1/2/2026, 10:12:16 AM):** The `getAllCustomerOptions` function was significantly refactored. A `search` query parameter was introduced. For the 'AGENT' role, search functionality using `ILIKE` on `cname` was added. For the 'CUSTOMER' role, the logic was dramatically changed: if a `search` term is provided, it now queries `Account_Master_Customer_MAP` to retrieve `customer_name` and an aggregated array of `customer_map` values, combining them into a single `customer_array` for the `value` field. If no search term is present, an empty array is returned.
*   **Minor Save (1/2/2026, 10:12:28 AM):** No functional changes were observed; the code remained identical to the previous timestamp.
*   **Temporary Revert (1/2/2026, 10:31:18 AM):** The newly introduced `Account_Master_Customer_MAP` based logic for the 'CUSTOMER' role was commented out, and the older `mtr_tracking_data` based logic (which supported pagination and basic search on `account_name`) was reactivated.
*   **Re-Revert (1/2/2026, 10:32:29 AM):** The `Account_Master_Customer_MAP` based logic was uncommented and re-activated for the 'CUSTOMER' role, while the `mtr_tracking_data` logic was commented out again. This suggests an active development or testing phase for these distinct customer search strategies.

**File: `src\services\analytics\teuService.ts`**

*   **Refinement of Query Logic (1/2/2026, 11:41:32 AM):** The `getTEUReports` function's SQL query generation was updated. For non-country-based groupings, a `CASE` statement was introduced to categorize `NULL` or empty grouping column values as 'OTHERS'. Additionally, a specific mapping was added to treat 'LONG BEACH' as 'LOS ANGELES' for `pod` or `place_of_delivery` columns. The `account_name` filtering still used direct string interpolation.
*   **Minor Save (1/2/2026, 11:41:37 AM):** No functional changes were observed; the code remained identical.
*   **Multi-Company Filtering (1/2/2026, 11:47:41 AM):** A significant improvement was made to the `WHERE` clause for `account_name` in all `mainQuery` variations. It transitioned from direct string interpolation of a single company name to using `LOWER(m.account_name) = ANY ( regexp_split_to_array(LOWER($1), '\s*,\s*') )`, allowing the query to filter by multiple comma-separated company names passed as a single parameter.
*   **Regex Escaping Fix (1/2/2026, 11:51:49 AM):** A minor but important fix was applied to the `regexp_split_to_array` pattern within the SQL queries. The backslashes for whitespace (`\s`) were double-escaped to `\\\\s` to ensure correct interpretation within the SQL string literal.
*   **Parameterized Queries and Refactoring (1/2/2026, 11:54:08 AM):** A major refactoring occurred to implement parameterized queries for `CompanyName`, `fromDate`, and `toDate` (using `$1`, `$2`, `$3` in the SQL). This significantly enhances security by preventing SQL injection. The `customizer` object initialization was streamlined, and `WHERE` clause conditions for null/empty checks were simplified.

**File: `src\common\util\booking.query.ts`**

*   **Initial Implementation (1/2/2026, 11:58:30 AM):** This new file introduced `bookingQueryBuilder` to generate SQL queries for various booking-related analytics reports. It supports different report types such as "BookingDatetoActualDeparture" and "StackedBar" versions. Queries primarily calculate date differences between `t49_vessel_actualdeparted_date` and `bookingdate`, grouping by `fileno` and `contno` or `mblno`. Initial versions used direct string interpolation for `CompanyName`, `fromDate`, `toDate`.
*   **Multi-Company Filtering (1/2/2026, 12:10:52 PM):** Similar to `teuService.ts`, the `account_name` filtering in all booking queries was updated to `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` to support filtering by multiple company names.
*   **Minor Saves (1/2/2026, 12:13:21 PM & 1/2/2026, 12:23:19 PM):** No functional changes were observed in these consecutive updates; the code remained identical.

**File: `src\common\util\transit.query.ts`**

*   **Initial Implementation (1/2/2026, 12:24:34 PM):** This new file introduced `transitQueryBuilder` and a helper `queryGenerator` function. It's designed to build complex SQL queries for transit reports, comparing actual vs. estimated transit times. It populates `customizer.additionalData` with estimated, actual, and estimated-actual transit values. The `account_name` filtering within `queryGenerator` also adopted the `regexp_split_to_array` pattern for `CompanyName`. Note that the `regexp_split_to_array` uses single backslashes `\s*,\s*` in this context, similar to the `booking.query.ts` prior to its double-escaping fix.

**File: `src\services\analytics\transitService.ts`**

*   **Initial Implementation (1/2/2026, 12:26:55 PM):** This new service consumes the `transitQueryBuilder` to generate and execute transit analytics reports. It handles default date ranges, retrieves user and company information, and dynamically sets `mblwiseCondition` based on query parameters before passing control to the query builder.

**Patterns and Recurring Elements:**

*   **Dynamic Query Generation:** All `*_query.ts` files are dedicated to constructing complex SQL queries based on user-provided parameters like `role`, `type`, `columnName`, `fromDate`, `toDate`, and `CompanyName`.
*   **Evolution of Company Name Filtering:** A prominent pattern is the shift from direct string interpolation of `CompanyName` to a more robust and flexible approach using `regexp_split_to_array` with `ANY` for `account_name` filtering, allowing multiple company names. `teuService.ts` further progressed to full parameterized queries for `CompanyName` and dates.
*   **Date Range Management:** Multiple services handle date range parameters, with `teuService.ts` and `transitService.ts` providing `defaultDateRange` fallback.
*   **Container Type Parsing:** SQL queries frequently parse container types (`t49_cont_type`, `cont_type`) using `REGEXP_REPLACE` to extract numeric values for TEU calculations.
*   **NULL/Empty Value Handling:** `CASE` statements are commonly used in SQL queries to handle `NULL` or empty string values in grouping columns, often defaulting them to 'OTHERS'.
*   **Analytics Customizer Object:** A `customizer` object is consistently used across analytics services to configure report characteristics like `dateRange`, `calType`, `selectedColumns`, `chartType`, and `calColumnConfig`.
*   **Error Handling:** All service endpoints include `try...catch` blocks and use a `logger` for error reporting, returning `500 Internal Server Error` on failure.

## 12:36:39 PM
The code change log primarily details updates to components and Redux state management related to customer selection within a frontend application.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **Timestamp: 1/2/2026, 10:35:28 AM - 11:23:09 AM:** This period shows a series of rapid, minor adjustments and reversions.
        *   Initial implementation and several small changes in the `handleAdd` function's `onSelect` call, toggling between passing `selectedCustomer.value` and `selectedCustomer.label`.
        *   Similarly, the `getDisplayText` function frequently switched between displaying `selectedCustomer?.value` and `selectedCustomer?.label`.
        *   An attempt to access `selectedCustomer.value[0]` was briefly introduced (11:22:49 AM), hinting at an upcoming change to handle array values.
        *   The `CustomerOption` interface was initially `value: string;` and later changed to `value?: string;` (10:37:50 AM).
    *   **Timestamp: 1/2/2026, 11:27:21 AM - 11:27:52 AM:**
        *   Significant changes were made to how customer options are rendered and selected within the dropdown. The `key` for mapped options was changed from `opt.value` to `opt.label`.
        *   The `setSelectedCustomer` logic was updated to explicitly handle `opt.value` potentially being an array, attempting to set `selectedCustomer.value` based on `opt.label` or `opt.value`. This change foreshadowed a more formal type definition.
    *   **Timestamp: 1/2/2026, 11:38:05 AM - 11:38:33 AM:** This marks a major refactor to support multi-value customer selection.
        *   The `CustomerOption` interface was updated to `value?: string | string[];` allowing customer values to be either a single string or an array of strings.
        *   The `handleAdd` function was completely re-written to consistently store the `selectedCustomer.value` as an array (even if it was initially a single string) in `localStorage`.
        *   The `onSelect` prop now receives a comma-separated string of values (`values.join(",")`) to its parent component/Redux.
        *   The `onClick` logic for selecting an option in the dropdown was simplified to directly assign `opt.value` (which can now be an array) to `selectedCustomer.value`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **Timestamp: 1/2/2026, 11:18:39 AM - 11:19:30 AM:**
        *   Initially, the `selectedCustomer` in the Redux state was `string | null`.
        *   The `setSelectedCustomer` reducer expected a `CustomerOption` payload and stored only the `customer.label` as a string in both Redux state and `localStorage`.
    *   **Timestamp: 1/2/2026, 11:21:20 AM - 11:22:40 AM:**
        *   The `setSelectedCustomer` reducer was updated to expect a `PayloadAction<string | null>`, directly storing the provided string value in Redux state and `localStorage`.
        *   A `console.log` statement was added for debugging (`11:21:42 AM`).
    *   **Timestamp: 1/2/2026, 11:39:20 AM:** This update aligns with the `SelectCustomer.tsx` changes to support multiple customer values.
        *   The `selectedCustomer` in the `GlobalState` interface was changed from `string | null` to `string[] | null`.
        *   The `setSelectedCustomer` reducer now expects a `PayloadAction<string[] | null>` and stores the array as a JSON string in `localStorage` using `JSON.stringify(value)`.
        *   The `initializeSelectedCustomer` reducer still directly uses `localStorage.getItem` to assign the value, which may lead to a type mismatch if the stored item is expected to be an array (it would need `JSON.parse` to convert the string back to an array).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 1/2/2026, 11:30:27 AM:**
        *   This page was updated to consume the `selectedCustomer` state from the `globalSlice` to conditionally fetch dashboard data.
        *   It dispatches `setSelectedCustomer(user.companyname)` when a user with the role "CUSTOMER" logs in, implying `user.companyname` is a single string. This action would later need to adapt to the `global-slice.ts` change expecting `string[]` for `selectedCustomer`.

### Patterns and Recurring Elements:

*   **Evolution of Customer Selection:** The most prominent pattern is the continuous refinement of how a "selected customer" is represented and managed. It started as a single string `value` or `label`, evolved through implicit array handling, and finally became an explicit `string | string[]` type in the UI component, and `string[] | null` in the Redux store.
*   **LocalStorage as Persistence Layer:** `localStorage` is consistently used across `SelectCustomer.tsx` and `global-slice.ts` to persist the selected customer, though the format of storage (raw string vs. JSON stringified object/array) changes with the evolving data structure.
*   **Redux for Global State:** The `global-slice.ts` demonstrates the use of Redux Toolkit to manage the `selectedCustomer` and `loading` states globally, allowing components like `AnalyticsScreen` to subscribe to these changes.
*   **Debugging and Iteration:** The frequent, small changes and the inclusion of `console.log` statements suggest an iterative development process with active debugging.
*   **API Interaction:** Both `SelectCustomer.tsx` and `analytics-page.tsx` interact with `ApiManager` to fetch customer options and analytics data, respectively.
*   **Type System Adjustments:** The TypeScript interfaces were updated to reflect the changing data structures, particularly `CustomerOption` in `SelectCustomer.tsx` and `GlobalState` in `global-slice.ts`.

## 1:35:13 PM
The log primarily details changes within two React component files, `CustomerMapping.jsx` and `AgentBookingConfirmation.jsx`, both located within a `t360-frontend` project.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
This file, a React component named `CustomerMapping`, deals with customer mapping functionality, likely involving a dynamic list of customer selection fields. Over a short period on 1/2/2026, there were several rapid modifications and reverts:

*   **1/2/2026, 9:50:21 AM:** The component initialized `mapping` from `formik.values.customer_mapping`, defaulting to `[{ customer: "" }]` if empty. It used `AppAutocomplete` with props `handleOptionChange` and `onInputChange={(val) => handleOptionChange(val)}`.
*   **1/2/2026, 9:51:10 AM:** An attempt was made to change the `mapping` initialization to `formik.values.customer_mapping || [{ customer: "" }] || []`, adding a redundant `|| []` to the default.
*   **1/2/2026, 9:51:29 AM:** The `mapping` initialization was reverted to its original state: `formik.values.customer_mapping || [{ customer: "" }]`.
*   **1/2/2026, 9:51:40 AM:** The `mapping` initialization was modified again to `formik.values.customer_mapping || []`, which would initialize with an empty array rather than a single empty customer object.
*   **1/2/2026, 9:51:58 AM:** This change was also reverted, restoring the `mapping` initialization to `formik.values.customer_mapping || [{ customer: "" }]`.
*   **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were updated to `value={row.customer || []}` and `options={optionsCustomer || []}` respectively, ensuring they always receive an array.
*   **1/2/2026, 9:58:08 AM:** The `AppAutocomplete` props for `value` and `options` were reverted to `value={row.customer}` and `options={optionsCustomer}`, removing the `|| []` fallback.
*   **1/2/2026, 9:58:13 AM:** No functional code change was observed at this timestamp; the content is identical to the previous entry, suggesting a minor save or re-save operation.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`**
This file, `AgentBookingConfirmation.jsx`, is a comprehensive React component responsible for managing the booking confirmation process. All entries for this file across several timestamps on 1/2/2026 show identical content. This suggests that no functional code changes were committed or logged during these specific timestamps, or the changes were minimal (e.g., whitespace) and not captured in the provided log snippets.

The component's core functionality includes:
*   **UI and State Management:** Utilizes Material-UI components for layout, `formik` for form handling with `bookingConfirmationValidation`, and various `useState` hooks for managing UI state (e.g., `selectedFile`, `selectedPl`, `deselectedPl`, `pagination`, `alertConfig`, modal visibility). It also uses `useSelector` from `react-redux` to access vessel list data.
*   **Data Fetching and Manipulation:** Employs RTK Query hooks (`useGetBookingConfirmQuery`, `useFetchBookingPlListQuery`, `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`, `useUpdateDoMutation`) to interact with a backend API for booking details, packing lists, and document updates.
*   **Form Submission Logic:** The `onSubmit` handler processes form data, including file uploads (`do_document`), and prepares a payload with selected and deselected packing list items. It handles success/error messages using `react-hot-toast` and conditional logic for XML generation and upload (e.g., for "send-to-otm" action). It also features a `WarningToast` for specific API warnings.
*   **Responsiveness:** Dynamically adjusts table page size (`responsivePageSize`) based on screen breakpoints.
*   **Modals and Sub-components:** Integrates `ThemedModalExtend` for `AddVesselForm` and `ScacCodeForm`, and includes `SingleFileDropzone` and `UploadFile` for document handling.

**Patterns and Recurring Elements:**
*   **Rapid Iteration/Reversion:** The `CustomerMapping.jsx` file shows a pattern of quick, small changes to variable initialization logic, often followed by immediate reverts within minutes, indicating experimentation or debugging around edge cases for initial component state.
*   **Consistent File Structure:** Both files demonstrate a modern React development approach, utilizing functional components, hooks (`useState`, `useEffect`, `useCallback`, `useMemo`), form libraries (`formik`), and dedicated API interaction layers (RTK Query, `ApiManager`).
*   **Detailed Console Logging:** Throughout the `AgentBookingConfirmation.jsx` code (and implicitly in `CustomerMapping.jsx`'s `fetchCustomers`), there's a strong emphasis on `console.log` and `console.error` for debugging and tracing application flow, especially during API interactions and form submissions.
*   **Standardized Error/Success Handling:** The use of `react-hot-toast` for user feedback and `PopupAlert`/`WarningToast` for more critical messages is consistent across the application.

## 1:36:23 PM
The code changes, all occurring on January 2, 2026, primarily focus on enhancing analytics services within the `t360-backend-v2` project. A strong pattern of improving SQL query handling, particularly for filtering and security, is evident across multiple files.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`**
    *   **Timestamps:** 1/2/2026, 10:12:16 AM; 10:12:28 AM; 10:31:18 AM; 10:32:29 AM; 1:28:30 PM; 1:32:19 PM.
    *   **Key Updates:** This file shows a recurring pattern of toggling between two distinct implementations for the `getAllCustomerOptions` function for the "CUSTOMER" role.
        *   One implementation queries `mtr_tracking_data` for distinct `account_name` values, supporting pagination and an `ILIKE` search.
        *   The other implementation, introduced and repeatedly reverted/re-enabled, queries `Account_Master_Customer_MAP`. This version aggregates `customer_map` values into an array associated with `customer_name` when a search is present, allowing a `customer_name` to map to an array of related values.
    *   The "AGENT" role's logic, which queries `agent_po_account_master` for `cname` with an `ILIKE` search, remained consistent throughout these changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**
    *   **Timestamps:** 1/2/2026, 11:41:32 AM; 11:41:37 AM; 11:47:41 AM; 11:51:49 AM; 11:54:08 AM.
    *   **Key Updates:** The `getTEUReports` function underwent several improvements:
        *   **11:41:32 AM:** Introduced dynamic column handling in SQL queries, including `CASE` statements to default `NULL` or empty grouping columns to 'OTHERS' and a specific rule to map 'LONG BEACH' to 'LOS ANGELES' for certain columns (`pod`, `place_of_delivery`).
        *   **11:47:41 AM:** Modified SQL queries to support filtering by multiple `account_name` values by using `regexp_split_to_array` and `ANY` in the `WHERE` clause.
        *   **11:51:49 AM:** A minor but important fix was made to the `regexp_split_to_array` regex to correctly escape backslashes within the JavaScript string.
        *   **11:54:08 AM:** Implemented proper parameterized queries, passing `CompanyName`, `fromDate`, and `toDate` as bind parameters (`$1`, `$2`, `$3`) instead of string interpolation, significantly improving security and maintainability. Also refactored the `customizer` configuration and query generation logic to potentially delegate it to a separate utility. Simplified some `WHERE` clause conditions for brevity.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamps:** 1/2/2026, 11:58:30 AM; 12:10:52 PM; 12:13:21 PM; 12:23:19 PM.
    *   **Key Updates:** This file defines the `bookingQueryBuilder` function, responsible for generating various booking reports.
        *   **11:58:30 AM:** Established the initial structure for different booking report types, all calculating day differences between booking and actual departure dates, and including stacked bar chart visualizations based on these differences. Queries initially used direct string interpolation for dynamic values.
        *   **12:10:52 PM:** Updated all defined booking report queries to support multi-company filtering using `regexp_split_to_array` and `ANY` for `account_name`, consistent with changes in `teuService.ts`, although still using string interpolation for the parameter itself.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts`**
    *   **Timestamp:** 1/2/2026, 12:24:34 PM.
    *   **Key Updates:** This file was introduced or heavily refactored to contain `transitQueryBuilder` and `queryGenerator` functions. It now generates complex SQL queries for transit reports, including calculations for estimated, actual, and estimated-actual transit times. Importantly, it uses proper parameterized queries (`$1`, `$2`, `$3`) for `CompanyName`, `fromDate`, and `toDate` in the generated SQL, and also employs the `regexp_split_to_array` pattern for multi-company filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\transitService.ts`**
    *   **Timestamp:** 1/2/2026, 12:26:55 PM.
    *   **Key Updates:** The `getTransitReports` function was updated to integrate and utilize the newly created `transitQueryBuilder` from `src\common\util\transit.query.ts`. This change delegates the complex SQL query generation to the builder function, improving modularity and separation of concerns.

**Patterns and Recurring Elements:**

*   **Intense Development Period:** All recorded changes occurred on the same day, January 2, 2026, suggesting a focused sprint on analytics features.
*   **Enhanced SQL Security and Flexibility:** A major recurring theme is the improvement of SQL query generation:
    *   Transition from direct string interpolation to **parameterized queries** for dynamic values (`CompanyName`, `fromDate`, `toDate`) in `teuService.ts` and `transit.query.ts`, significantly reducing SQL injection risks.
    *   Implementation of **multi-company filtering** in SQL using `regexp_split_to_array` and `ANY` clauses to allow `account_name` to match against multiple comma-separated company names. This pattern is seen across `teuService.ts`, `booking.query.ts`, and `transit.query.ts`.
*   **Code Modularity:** There is a clear effort to refactor and modularize complex SQL query building logic into dedicated utility functions (`bookingQueryBuilder`, `transitQueryBuilder`, `queryGenerator`), abstracting this complexity away from the main service handlers.
*   **Dynamic Data Handling:** SQL queries frequently use `CASE WHEN` statements to handle `NULL` or empty data intelligently, such as categorizing them as 'OTHERS' or performing specific data remappings (e.g., 'LONG BEACH' to 'LOS ANGELES').
*   **Consistent Logging:** The use of `logger.info` and `logger.error` is prevalent across all services for operational monitoring and error handling.

## 1:36:42 PM
The provided logs detail a series of concentrated changes on **1/2/2026**, primarily affecting how customer selection is managed and stored in a frontend application.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **Evolution of `CustomerOption` Interface and `onSelect` Callback (10:35 AM - 11:38 AM, then 1:29 PM - 1:32 PM):**
        *   Initially, `CustomerOption.value` was a required string, and the `onSelect` callback passed `selectedCustomer.value`.
        *   There were multiple toggles between passing `selectedCustomer.value` and `selectedCustomer.label` to the `onSelect` callback in the `handleAdd` function.
        *   The `CustomerOption.value` type was made optional (`value?: string`) at 10:37 AM.
        *   A significant update at 11:38:05 AM changed `CustomerOption.value` to allow `string | string[]`, indicating an intention to support multiple customer values. Correspondingly, a new `handleAdd` implementation was introduced that would store `value` as an array in `localStorage` and pass a comma-separated string to `onSelect`.
        *   The logic for rendering options also changed, with keys moving from `opt.value` to `opt.label`, and the `setSelectedCustomer` logic adapting to potentially handle `value` as an array.
        *   However, these changes were largely reverted or commented out in a series of commits around 1:29 PM, bringing `CustomerOption.value` back to a single string (and even a required string briefly).
        *   The final change at 1:32:47 PM seemingly re-instated the `value?: string | string[]` type and the more complex `handleAdd` function designed to handle array values.
    *   **Local Storage Management:** The component consistently uses `localStorage.setItem(STORAGE_KEY, JSON.stringify(selection))` to persist the selected customer, and `localStorage.getItem(STORAGE_KEY)` for initialization.
    *   **UI/UX:** The component features a dropdown for customer selection with search capabilities, loading indicators, and buttons to "Add" (select) or "Cancel" the selection. It also handles click-away events to close the dropdown.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **`selectedCustomer` State Type Evolution (11:18 AM - 11:39 AM):**
        *   Initially, the global state stored `selectedCustomer` as a `string | null` (specifically, `customer.label`). `localStorage` also stored a single string.
        *   At 11:21:20 AM, the `setSelectedCustomer` reducer was simplified to directly accept and store a `string | null` payload.
        *   A crucial change at 11:39:20 AM modified the `GlobalState` interface to store `selectedCustomer` as `string[] | null`. The `setSelectedCustomer` reducer was updated to accept `string[] | null` and store it as a JSON string in `localStorage`. The `initializeSelectedCustomer` reducer was also updated to parse this JSON string from `localStorage`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Integration with Global State (11:30:27 AM):** This file demonstrates the consumption of the `selectedCustomer` state from the Redux `globalSlice`.
    *   The `AnalyticsScreen` component retrieves `selectedCustomer` using `useSelector`.
    *   It uses `selectedCustomer` to conditionally fetch dashboards and reports, skipping queries if no customer is selected.
    *   If the logged-in user has a "CUSTOMER" role, `setSelectedCustomer` is dispatched to automatically set the customer based on `user.companyname`.
    *   A `console.log` statement was added for debugging the `selectedCustomer` value.

### Timestamps of Significant Changes:

*   **1/2/2026, 10:37:50 AM - 11:23:09 AM:** Frequent, back-and-forth adjustments in `SelectCustomer.tsx` regarding whether to pass `value` or `label` to `onSelect`, and minor type changes for `CustomerOption.value`. This indicates initial uncertainty or testing of different approaches.
*   **1/2/2026, 11:27:21 AM:** `SelectCustomer.tsx` begins to show changes for handling `CustomerOption.value` as a potentially complex type (e.g., array), with `key` and `onClick` logic being updated.
*   **1/2/2026, 11:30:27 AM:** Introduction of `analytics-page.tsx`, showcasing the integration of `selectedCustomer` from the global state into a functional page.
*   **1/2/2026, 11:38:05 AM:** `SelectCustomer.tsx` officially updates `CustomerOption.value` to `string | string[]` and introduces a refactored `handleAdd` to handle and store array values.
*   **1/2/2026, 11:39:20 AM:** `global-slice.ts` fully updates its `selectedCustomer` state to `string[] | null`, solidifying the decision to handle customer selection as an array of values, and changes how it's stored in `localStorage` (JSON stringification).
*   **1/2/2026, 1:29:13 PM - 1:29:41 PM:** A period of significant reverts in `SelectCustomer.tsx`, moving back to simpler string handling for `CustomerOption.value` and `handleAdd`.
*   **1/2/2026, 1:32:47 PM:** A final major revert in `SelectCustomer.tsx` that brings back the `string | string[]` type for `CustomerOption.value` and the `handleAdd` logic designed for array values.

### Patterns and Recurring Elements:

*   **Customer Selection Complexity:** There's a recurring pattern of evolving requirements or understanding of how a "selected customer" should be represented. It repeatedly shifts between a single string (label or value) and an array of strings, leading to corresponding changes in type definitions, state management, and interaction logic.
*   **Local Storage for Persistence:** Both `SelectCustomer.tsx` and `global-slice.ts` consistently use `localStorage` with the key `"selectedCustomer"` to persist the user's choice across sessions, demonstrating a common pattern for frontend state hydration.
*   **Active Debugging:** The presence of `console.log` statements in various versions of `SelectCustomer.tsx` and `global-slice.ts` indicates active debugging efforts during these development phases.
*   **Iterative Development and Reversions:** The frequent changes, including several direct reverts or commenting out of code blocks, suggest an iterative development process with trial-and-error, as the optimal way to handle customer selection (especially regarding single vs. multiple values) was being determined.
*   **Redux Toolkit Usage:** The `global-slice.ts` file consistently uses Redux Toolkit's `createSlice` for state management, demonstrating modern Redux patterns.

## 2:15:47 PM
The changes, all timestamped on 1/2/2026 within an 8-minute window (2:07 PM - 2:15 PM), signify a focused development session primarily enhancing the backend for an analytics dashboard system.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\get_auto_complete.route.ts` (Timestamp: 1/2/2026, 2:07:58 PM):**
    *   A new Express route (`/`) was established to serve auto-complete functionality, delegating the request handling to `getAutoComplete.getAll`. This indicates the introduction or exposure of an auto-complete feature for the API.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.metric.controller.ts` (Timestamp: 1/2/2026, 2:13:07 PM):**
    *   This file underwent significant expansion, introducing several key functions for metric management within the analytics dashboard:
        *   `getMetricList`: Retrieves and categorizes metrics from the `metrics` table into 'Container_Wise' and 'MBL_Wise' groups. It also includes logic to preload and mark metrics as "checked" if they are part of an existing dashboard configuration.
        *   `dashboardEndPointList`: Fetches specific metric endpoints for a user's dashboard based on a menu title. It also retrieves and incorporates layout details like `rowSpan` and `columnSpan` for each metric, sorting them according to a predefined order.
        *   `saveSequence`: Allows users to save a custom sequence (order) of reports/metrics for a given dashboard (`menu_title`) by updating the `dashboard_metrics` array in the `dashboards` table. It includes special handling for creating a 'Default' dashboard if it doesn't exist for a user.
        *   `saveSize`: Implements functionality to save customized display sizes (`columnSpan`, `rowSpan`) for individual metrics within a dashboard, updating the `size` JSON field in the `dashboards` table.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\core.view.controller.ts` (Timestamp: 1/2/2026, 2:15:10 PM):**
    *   This file was updated to provide comprehensive CRUD (Create, Read, Update, Delete) operations for managing user-defined analytics dashboard views:
        *   `getAll`: Retrieves a list of all existing dashboard `menu_title`s associated with a specific user from the `dashboards` table.
        *   `create`: Facilitates the creation of new dashboard views, preventing duplicates, and associating a list of `metricsId`s with the new view. This action is logged.
        *   `update`: Allows modification of an existing dashboard view, including changing its `menu_title` and updating its associated `dashboard_metrics`. This update is also logged with both previous and new values.
        *   `deleteView`: Handles the deletion of a specified dashboard view, with the action being logged.
        *   A new helper function, `logAudit`, was introduced to centralize the logging of all dashboard view-related actions (CREATE, UPDATE, DELETE) into a dedicated `analytics_view_log` table, capturing user, action, menu title, and value changes.

**Patterns and Recurring Elements:**

*   **Timestamp Consistency:** All changes occurred on the same date (January 2, 2026) within a very short timeframe, indicating a concentrated burst of development activity.
*   **Database Interaction:** A strong pattern of direct SQL query usage via `config/database` is evident across all controller files for all data manipulation (SELECT, INSERT, UPDATE, DELETE). Key tables frequently accessed are `metrics` and `dashboards`, with the introduction of `analytics_view_log` for auditing.
*   **User Authentication and Context:** All controller functions utilize `AuthenticatedRequest`, ensuring that operations are performed in the context of an authenticated user (`req.user`) and user-specific data is managed.
*   **Robust Error Handling and Logging:** Every asynchronous function includes `try...catch` blocks for error management. Errors are consistently logged using `logger.error`, informational messages with `logger.info`, and standard 500 "Internal Server Error" responses are returned.
*   **Dashboard Customization and Management:** The overarching theme is the enhanced ability to manage, customize, and audit user-specific analytics dashboards, covering metric selection, ordering, layout, and overall view management.

## 4:49:55 PM
This log details a series of changes focused on refining customer-related functionalities and API integrations within a React frontend application, specifically in the `t360-frontend` project.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`** (1/2/2026, 2:26:45 PM and 1/2/2026, 2:26:51 PM):
    *   Both entries show a nearly identical, extensive list of `import` statements and `React Router` configurations.
    *   The primary visible change between these two timestamps is the uncommenting and modification of the root route:
        *   Previously commented out: `<Route path="/" element={ <AuthGuard> <Auth0Login /> </AuthGuard> } />`
        *   Changed to: `<Route path="/" element={ <AuthGuard> <LoginScreen /> </AuthGuard> } />`
        *   This indicates a shift from using `Auth0Login` directly on the root path to using `LoginScreen` for the default authenticated root path.
    *   A `console.log("🚀 ~ file: App.js:2 ~ TEST on Flow");` statement is present in both versions, likely for debugging or tracking.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`** (1/2/2026, 2:59:06 PM):
    *   This file details a comprehensive `AgentBookingConfirmation` component.
    *   It handles form submissions, file uploads (`do_document`), XML generation (`createBookingXmlMutation`), and XML upload (`uploadBookingXmlMutation`).
    *   Error handling and toast notifications (success, error, warning) are prominently featured, including a custom `WarningToast` for displaying multiple warnings.
    *   The component uses `formik` for form management, `Redux` (`useSelector`) for state, and several MUI components for the UI.
    *   It manages selected and deselected packing lists (`selectedPl`, `deselectedPl`) and includes logic for fetching PL data based on keywords and status.
    *   It also features modals for adding vessels (`AddVesselForm`) and SCAC codes (`ScacCodeForm`).

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerForm.jsx`** (Multiple timestamps: 1/2/2026, 3:46:26 PM, 1/2/2026, 3:48:00 PM, 1/2/2026, 3:48:14 PM, 1/2/2026, 3:54:30 PM, 1/2/2026, 4:36:47 PM):
    *   This component (`CustomerForm`) manages the creation/editing of customer details.
    *   It utilizes `formik` for validation and submission, `AppAutocomplete` for various lookup fields (Sales Rep, Descartes Customer Mapping, ISF Party Mapping, City), and `InputBox` and `SelectBox` for standard inputs.
    *   File upload logic is present (though commented out for `useDropzone`).
    *   The `customer_mapping` field is initialized, indicating a sub-form or nested data structure for customer-to-customer relationships.
    *   Submission involves sending form data, including stringified JSON for `mapping` and `customer_mapping`, as `FormData`.
    *   Toast notifications are used for feedback on save operations.
    *   A minor change at 3:48:00 PM simplified the `formik` `initialValues` spread, assuming `initialValues` already contains all necessary fields without explicit `customer_mapping` initialization. This was reverted at 3:48:14 PM to explicitly ensure `customer_mapping` is an array.
    *   At 3:54:30 PM, a `console.log("initialValues123456", initialValues);` was added, likely for debugging purposes related to the `initialValues` for `customer_mapping`.
    *   The final entry at 4:36:47 PM is identical to the 3:48:14 PM entry for this file, implying the debugging log was removed, or the file reverted to that state.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`** (Multiple timestamps: 1/2/2026, 3:47:04 PM, 1/2/2026, 4:03:31 PM, 1/2/2026, 4:04:17 PM, 1/2/2026, 4:09:07 PM, 1/2/2026, 4:21:23 PM, 1/2/2026, 4:21:38 PM, 1/2/2026, 4:34:47 PM, 1/2/2026, 4:35:01 PM, 1/2/2026, 4:35:58 PM):
    *   This component manages a list of customer mappings, allowing users to add and delete rows.
    *   It uses `AppAutocomplete` for selecting customer options fetched via `ApiManager.getCustomerOptions`.
    *   It ensures that `customer_mapping` always has at least one row upon initialization.
    *   **Significant changes revolve around the `deleteRow` function:**
        *   Initially (3:47:04 PM), `deleteRow` only removed a row from the formik state locally.
        *   At 4:03:31 PM, logic was added to call `ApiManager.deleteCustomerOption(rowToDelete.customer)` if `rowToDelete.customer` existed, with error handling. This was a backend integration for deletion.
        *   At 4:04:17 PM, `ApiManager.deleteCustomerOption` was renamed to `deleteCustomerOptions` in the call.
        *   At 4:09:07 PM, the backend deletion logic was entirely removed from `deleteRow`, reverting it to only modify local formik state. This suggests an architectural change or a temporary rollback.
        *   At 4:21:23 PM, the backend deletion logic was re-introduced, but now checking `row.customer_id` and calling `ApiManager.deleteCustomerOption(row.customer_id)`.
        *   At 4:21:38 PM, a `console.log(row, "rowdata====");` was added for debugging the `row` object before deletion.
        *   At 4:34:47 PM, `toast` notifications (success/info/error) were added to the `deleteRow` function to provide user feedback on the deletion outcome.
        *   The entry at 4:35:01 PM is identical to the previous, indicating no change.
        *   The entry at 4:35:58 PM removes the comments around the `fetchCustomers` function for better readability.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\Endpoints.js`** (Multiple timestamps: 1/2/2026, 4:01:34 PM, 1/2/2026, 4:08:51 PM, 1/2/2026, 4:20:10 PM, 1/2/2026, 4:20:25 PM, 1/2/2026, 4:25:35 PM, 1/2/2026, 4:32:00 PM, 1/2/2026, 4:36:10 PM):
    *   This file defines API endpoints.
    *   **Key changes are focused on customer deletion endpoints:**
        *   Initially (4:01:34 PM), `DELETE_CUSTOMER_OPTION` was `(accountName) => `/deleteCustomerOption?account_name=${encodeURIComponent(accountName)}``. This was a GET request.
        *   At 4:08:51 PM, this endpoint was removed entirely.
        *   At 4:20:10 PM, `DELETE_CUSTOMER_OPTION` was re-added but duplicated `GET_CUSTOMER_OPTIONS` endpoint: `(search = "") => `/getCustomerOptions${search ? `?search=${encodeURIComponent(search)}` : ""}`. This was an error.
        *   At 4:20:25 PM, `DELETE_CUSTOMER_OPTION` was corrected to `(customerId) => `/deleteCustomerOption/${customerId}``. This suggests a RESTful DELETE approach by ID.
        *   At 4:25:35 PM, the endpoint was changed to `(customerId) => `/delete/${customerId}``. This is a more generic path.
        *   At 4:32:00 PM, it was reverted to `(customerId) => `/getCustomerOptions/delete/${customerId}``.
        *   The entry at 4:36:10 PM is identical to the previous, indicating no change.
    *   Also, the `GET_MENU` endpoint gained new optional parameters `v2_menu` and `ismenudrawer` for more flexible menu fetching.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\ApiManager.js`** (Multiple timestamps: 1/2/2026, 4:01:42 PM, 1/2/2026, 4:01:51 PM, 1/2/2026, 4:06:54 PM, 1/2/2026, 4:08:09 PM, 1/2/2026, 4:19:58 PM, 1/2/2026, 4:36:34 PM):
    *   This file manages API calls using the `ENDPOINTS` definitions.
    *   **Changes are related to customer deletion:**
        *   Initially (4:01:42 PM), `deleteCustomerOptions` was a `GET` request, duplicating the `getCustomerOptions` definition.
        *   At 4:01:51 PM, `getCustomerOptions` was split into two separate static methods: `getCustomerOptions` (for GET) and `deleteCustomerOptions` (for DELETE, but still incorrectly using `ApiMethods.get`).
        *   At 4:06:54 PM, `deleteCustomerOptions` was correctly updated to use `ApiMethods.delete(url)`. The parameter name was also changed from `search` to `accountName`.
        *   At 4:08:09 PM, the `deleteCustomerOptions` method was removed entirely from `ApiManager`.
        *   At 4:19:58 PM, the `deleteCustomerOption` method was re-added, using `ApiMethods.delete` and taking `customerId` as a parameter. This aligns with the `Endpoints.js` change at the same time.
        *   The entry at 4:36:34 PM is identical to the previous, indicating no change.

**Timestamps of Significant Changes:**

*   **1/2/2026, 2:26 PM:** General application routing updates in `App.js`.
*   **1/2/2026, 2:59 PM:** Introduction or significant update to `AgentBookingConfirmation.jsx`, implementing booking workflow, file uploads, XML generation/upload, and extensive error handling.
*   **1/2/2026, 3:46 PM - 3:54 PM:** Iterative refinements in `CustomerForm.jsx` focusing on `initialValues` handling and debugging.
*   **1/2/2026, 3:47 PM - 4:35 PM:** Continuous evolution and back-and-forth on the `deleteRow` logic in `CustomerMapping.jsx` and corresponding endpoint definitions in `Endpoints.js` and `ApiManager.js`. This highlights a complex or debated implementation of customer mapping deletion, involving decisions on whether to integrate API calls directly, what endpoint to use, and how to handle user feedback.
*   **1/2/2026, 4:01 PM - 4:36 PM:** The most dynamic period, characterized by rapid changes to the `DELETE_CUSTOMER_OPTION` endpoint definition across `Endpoints.js` and `ApiManager.js`, and the `deleteRow` functionality in `CustomerMapping.jsx`. This suggests active development and troubleshooting related to customer deletion functionality.

**Patterns and Recurring Elements:**

*   **Formik and MUI:** Consistent use of `formik` for form management and `@mui/material` components for UI across multiple form-related files (`AgentBookingConfirmation.jsx`, `CustomerForm.jsx`, `CustomerMapping.jsx`).
*   **API Manager & Endpoints:** A clear separation of API endpoint definitions (`Endpoints.js`) and API call logic (`ApiManager.js`). Changes in one often necessitate changes in the other.
*   **Toast Notifications:** Frequent use of `react-hot-toast` for user feedback (success, error, warning messages).
*   **Autocomplete for Lookups:** `AppAutocomplete` is a recurring component for searching and selecting options (e.g., Sales Rep, Cities, Customers, Parties).
*   **Role-Based Access Control:** `ProtectedRoute` and `UserRoleEnum` are heavily used in `App.js` to define access for various routes based on user roles (ADMIN, CUSTOMER, AGENT, CSF, FRONTOFFICE, BACKOFFICE, SPR_CUSTOMER, ADMIN_V2). This indicates a robust security model.
*   **Debugging with `console.log`:** Several `console.log` statements (e.g., "TEST on Flow", "initialValues123456", "rowdata====") appear in the logs, indicating active development and debugging.
*   **Iterative Refinement of Deletion Logic:** The customer deletion process, especially for `CustomerMapping`, shows multiple attempts and revisions to ensure correct API integration and local state management. This suggests a complex or critical feature under active development.
*   **Modals:** Use of `ThemedModalExtend` (in `AgentBookingConfirmation.jsx`) for secondary forms or actions.

## 4:50:01 PM
The code changes primarily involve enhancements to analytics query generation, customer master data management, and customer options API endpoints.

**File-specific updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (1/2/2026, 2:35:49 PM):**
    *   Introduced `bookingQueryBuilder`, a new function designed to construct dynamic SQL queries for various booking analytics reports.
    *   This builder supports different report types such as 'BookingDatetoActualDeparture' (container-wise and MBL-wise) and their 'StackedBar' chart variations.
    *   It dynamically sets properties on a `customizer` object, including selected columns (with certain columns ignored or mandatory), date ranges, calculation types (e.g., 'avg'), and chart configurations.
    *   The generated SQL queries are complex, utilizing `WITH` clauses to calculate average day differences between `t49_vessel_actualdeparted_date` and `bookingdate`, and then determine percentages or categorize these differences into weekly time buckets for stacked bar visualizations.
    *   Queries include filtering by `CompanyName`, `fromDate`, and `toDate`.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\getCustomerOptions.ts` (Multiple timestamps):**
    *   **1/2/2026, 3:58:49 PM:** The `getAllCustomerOptions` function was streamlined to fetch distinct trimmed `account_name` values from `mtr_tracking_data`, supporting search via `ILIKE`. A `deleteCustomerOption` function was added, initially expecting `account_name` from the request body to delete entries from `mtr_tracking_data`.
    *   **1/2/2026, 4:17:54 PM:** `deleteCustomerOption` was refactored to accept `customer_id` from `req.params` (URL parameters) instead of `account_name` from the request body, and the SQL query was updated to `DELETE FROM mtr_tracking_data WHERE customer_id = $1`.
    *   **1/2/2026, 4:22:36 PM:** A correction was made in `deleteCustomerOption` to use `id` instead of `customer_id` in the `DELETE` query's `WHERE` clause for `mtr_tracking_data`, indicating `id` is the correct primary key for deletion in that table.
    *   **1/2/2026, 4:28:41 PM, 4:28:50 PM, 4:29:40 PM:** Debugging `console.log` statements were added to `deleteCustomerOption` to inspect `customer_id` and `req.params`.
    *   **1/2/2026, 4:31:23 PM:** A significant change occurred in `deleteCustomerOption`, where the `DELETE` operation was shifted from the `mtr_tracking_data` table to the `Account_Master_Customer_MAP` table, still using `id = $1` as the deletion criterion. This implies the "customer option" refers to a customer mapping rather than the raw tracking data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\getCustomerOptionsRoute.ts` (Multiple timestamps):**
    *   **1/2/2026, 3:59:33 PM:** Initial setup of routes: `GET /` for fetching customer options and `DELETE /` for deleting.
    *   **1/2/2026, 3:59:43 PM:** The `DELETE` route was adjusted to `/delete`.
    *   **1/2/2026, 4:18:20 PM:** The `DELETE` route was further refined to `/delete/:customer_id` to pass the `customer_id` as a URL parameter, aligning with the `deleteCustomerOption` controller's updated signature.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts` (Multiple timestamps):**
    *   **1/2/2026, 4:12:38 PM:** Implemented `getAllCustomer` and `createCustomer` functions for comprehensive customer master data management. `getAllCustomer` supports pagination, dynamic search based on query parameters, sorting, and retrieves related shipper mappings, document uploads, and customer mappings. `createCustomer` handles both new customer creation and modification (upsert logic) within a database transaction. It generates unique account codes, sanitizes customer names, inserts/updates records across multiple tables (`PO_AccountMaster_Customer_Master`, `agent_po_account_master_type`, `Account_Master_Shipper_MAP`), and processes file uploads.
    *   **1/2/2026, 4:14:13 PM:** `getAllCustomer` was enhanced to include `customer_id` in the returned `customer_mapping` data.

**Timestamps of significant changes:**

*   **1/2/2026, 2:35:49 PM:** Introduction of dynamic SQL generation for analytics.
*   **1/2/2026, 3:58:49 PM:** Initial implementation of basic customer options API.
*   **1/2/2026, 4:12:38 PM:** Addition of full-fledged customer master CRUD logic, including complex data relationships and transaction management.
*   **1/2/2026, 4:17:54 PM to 4:31:23 PM:** An iterative series of changes refactoring the `deleteCustomerOption` endpoint, moving from request body to URL parameters, adjusting the target column for deletion (`customer_id` to `id`), and finally changing the target table for deletion from `mtr_tracking_data` to `Account_Master_Customer_MAP`.

**Patterns or recurring elements:**

*   **Extensive Database Interaction:** The code heavily relies on direct SQL queries (`query` function) for all data operations (SELECT, INSERT, DELETE). Queries often involve joins, complex filtering, grouping, and ordering.
*   **Dynamic Query Construction:** SQL queries are frequently built dynamically based on user input (e.g., search parameters, report types, date ranges), indicating flexibility in data retrieval and reporting.
*   **API Endpoint Development:** Standard Express.js patterns are used for defining API routes and controller functions, handling request parameters, and sending JSON responses.
*   **Error Handling:** `try...catch` blocks with logging and appropriate HTTP error responses (e.g., 400 for bad request, 500 for internal server error) are consistently used.
*   **Data Sanitization and Transformation:** Utility functions like `chkStr` are used to process data before use or display, and string manipulation is applied (e.g., `cname` sanitization).
*   **Logging for Debugging:** Numerous `console.log` and `logger.info` statements are interspersed, particularly around request parameters and data processing steps, suggesting an emphasis on debugging and operational insights.
*   **Customer Data Centrality:** A recurring theme across multiple files is the management and querying of customer-related data, including master records, linked entities, and analytics.

## 8:05:31 PM
The code changes primarily involve updates to a React frontend application, focusing on route definitions and customer management forms.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`**
    *   **Timestamp: 1/2/2026, 2:26:45 PM and 1/2/2026, 2:26:51 PM**
        *   These two changes are almost identical. The core update is the uncommenting and modification of the root route (`/`) to point to `LoginScreen` wrapped in `AuthGuard`, replacing a previously commented-out `Auth0Login` route.
        *   A new route for `/logout` pointing to `Auth0LogoutHandler` was added.
        *   The `App.js` file exhibits a substantial list of imports and route definitions, indicating a large-scale application. Many `ProtectedRoute` components are used to restrict access based on `UserRoleEnum` (e.g., `ADMIN`, `CUSTOMER`, `AGENT`).
        *   Several new screens and components have been imported and routed, including `BookingDashbaordScreenExtend`, `AgentBookingFormScreenExtend`, `AgentPoFormExtend`, `CngBookingScreen`, `CngBookingFormScreen`, `CngBookingScreenExtend`, `CityMaster`, `UploadOTMBOL`, `PortmasterScreen`, `AirTrackingScreen`, `Auth0LogoutHandler`, and `HblListDetails`. This suggests an expansion of booking, tracking, and master data functionalities.
        *   A console log `console.log("🚀 ~ file: App.js:2 ~ TEST on Flow");` is present.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`**
    *   **Timestamp: 1/2/2026, 2:59:06 PM**
        *   This file introduces a new `AgentBookingConfirmation` component. It uses `formik` for form management and integrates with an API (`agentBookingApi`) to create/upload booking XMLs and update DO (Delivery Order) information.
        *   It handles file uploads (`SingleFileDropzone`), manages selected and deselected packing lists (`selectedPl`, `deselectedPl`), and implements responsive page sizing for data grids.
        *   Features include a multi-step process for booking, toast notifications for success/failure/warnings, and modals for adding vessels and SCAC codes.
        *   Extensive `console.log` statements are used for debugging the component's lifecycle and data.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerForm.jsx`**
    *   **Timestamps: 1/2/2026, 3:46:26 PM, 1/2/2026, 3:48:00 PM, 1/2/2026, 3:48:14 PM, 1/2/2026, 3:54:30 PM, 1/2/2026, 4:36:47 PM**
        *   This component manages a form for customer details, including `iesclientcode`, `cname`, `email`, `addressl1`, `city`, `state`, `zipcode`, `country`, `status`, `salesrep`, `descartes_customer_map`, and `isf_party_map`.
        *   It uses `formik` for form handling, `AppAutocomplete` for various lookups (Sales Rep, City, Descartes Customer, ISF Party), and `ApiManager` for data fetching (e.g., `getSalesOptions`, `getCityOptions`, `getCommonOptions`).
        *   The form submits data as `FormData`, including files and stringified JSON for `mapping` and `customer_mapping` arrays.
        *   A `CustomerMapping` component is included, suggesting a sub-form for managing customer-specific mappings.
        *   A `console.log("initialValues123456", initialValues);` was temporarily added and then removed (last timestamp doesn't include it).
        *   The `initialValues` for `customer_mapping` were explicitly set to an empty array if undefined or null, ensuring it's always an array.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
    *   **Timestamps: 1/2/2026, 3:47:04 PM, 1/2/2026, 4:03:31 PM, 1/2/2026, 4:04:17 PM, 1/2/2026, 4:09:07 PM, 1/2/2026, 4:21:23 PM, 1/2/2026, 4:21:38 PM, 1/2/2026, 4:34:47 PM, 1/2/2026, 4:35:01 PM, 1/2/2026, 4:35:58 PM**
        *   This component allows users to add and remove "customer mapping" rows, each containing an `AppAutocomplete` for selecting a customer.
        *   It dynamically adds/deletes rows in the formik state.
        *   A significant change pattern emerges here: The `deleteRow` function was modified multiple times. Initially, it only removed the row from the UI. Then, logic was added to call `ApiManager.deleteCustomerOption` if a `customer` value existed in the row. This was refined to use `customer_id` for deletion and to display toast messages for success/failure/info. The `ApiManager.deleteCustomerOptions` call was briefly introduced, then reverted to `ApiManager.deleteCustomerOption`, clarifying the intended API call.
        *   `toast` notifications were explicitly added for delete operations.
        *   `console.log("rowdata====", row);` was added for debugging the deletion process.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\Endpoints.js`**
    *   **Timestamps: 1/2/2026, 4:01:34 PM, 1/2/2026, 4:08:51 PM, 1/2/2026, 4:20:10 PM, 1/2/2026, 4:20:25 PM, 1/2/2026, 4:25:35 PM, 1/2/2026, 4:32:00 PM, 1/2/2026, 4:36:10 PM**
        *   This file defines API endpoints for the application.
        *   The `DELETE_CUSTOMER_OPTION` endpoint definition underwent multiple changes:
            *   Initially defined as `/deleteCustomerOption?account_name=${encodeURIComponent(accountName)}`.
            *   Then changed to simply `/getCustomerOptions${search ? `?search=${encodeURIComponent(search)}` : ""}` (a copy-paste error).
            *   Corrected to `/deleteCustomerOption/${customerId}`.
            *   Briefly changed to `/delete/${customerId}`.
            *   Finally settled on `/getCustomerOptions/delete/${customerId}`.
        *   The `GET_CUSTOMER_OPTIONS` endpoint also appeared to have a duplicate definition at one point. This indicates a refactoring or correction of API endpoint paths related to customer management.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\ApiManager.js`**
    *   **Timestamps: 1/2/2026, 4:01:42 PM, 1/2/2026, 4:01:51 PM, 1/2/2026, 4:06:54 PM, 1/2/2026, 4:08:09 PM, 1/2/2026, 4:19:58 PM, 1/2/2026, 4:36:34 PM**
        *   This file provides a static class `ApiManager` with methods to interact with the API endpoints.
        *   The `deleteCustomerOptions` method (which was `deleteCustomerOption` in `CustomerMapping.jsx`) was repeatedly modified:
            *   Initially, it duplicated `getCustomerOptions`.
            *   Then it correctly used `ApiMethods.get` with `DELETE_CUSTOMER_OPTION` but still as a GET request.
            *   It was later corrected to use `ApiMethods.delete` to reflect a proper DELETE HTTP method.
            *   The parameter name also changed from `search` to `accountName` to `customerId` to match the evolving endpoint definition.
        *   The `getCustomerOptions` method was also duplicated in one of the commits (`4:01:42 PM`). This was corrected in subsequent changes.

### Patterns and Recurring Elements:

1.  **React Component Development:** The changes are entirely within a React frontend application, with frequent use of `useState`, `useEffect`, `useCallback`, `useFormik`, and `useSelector`/`useDispatch` (though not explicitly shown for `useDispatch`).
2.  **MUI (Material-UI) Usage:** Components from `@mui/material` (e.g., `Grid`, `Box`, `IconButton`, `AppAutocomplete`, `InputBox`, `SelectBox`) are extensively used for UI layout and elements.
3.  **Form Management:** `formik` is consistently used for handling form state, validation (`validationSchema`), and submission (`onSubmit`).
4.  **API Interaction:** `ApiManager` class is central for calling backend endpoints, with common methods like `get` and `post`, and specific handlers for file uploads (`formData`) and blob downloads (`postBlob`).
5.  **State Management:** Redux (implied by `useSelector`) and local component state (`useState`) are used to manage data.
6.  **Navigation and Routing:** `react-router-dom` (`Route`, `Routes`, `useNavigate`) is used for application routing, with `ProtectedRoute` and `AuthGuard` for access control based on `UserRoleEnum`.
7.  **Toast Notifications:** `react-hot-toast` is used for displaying user feedback (success, error, loading, warnings).
8.  **Debugging:** Frequent `console.log` statements are observed across different files, indicating active development and debugging.
9.  **Customer Management Focus:** A recurring theme is the development and refinement of customer-related features, specifically customer forms and customer mapping functionalities, including API endpoint adjustments for these features.
10. **Endpoint and API Manager Refinement:** There's a clear pattern of iterative refinement in the `Endpoints.js` and `ApiManager.js` files, particularly concerning the `deleteCustomerOption` functionality. This involved correcting endpoint paths and ensuring the correct HTTP method (`DELETE`) was used.

## 8:05:35 PM
The changes log details updates across three main files, primarily focusing on customer management features and an analytics query builder, all occurring within a concentrated period on January 2, 2026.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Timestamp: 1/2/2026, 2:35:49 PM)**
    *   This file introduces an interface `QueryBuilderI` and an asynchronous function `bookingQueryBuilder`.
    *   It dynamically constructs complex SQL queries and customizer configurations for various analytics reports related to booking data.
    *   The queries calculate the average day difference between booking date and actual departure date, providing both container-wise (`BookingDatetoActualDeparture`) and MBL-wise (`BookingDatetoActualDepartureMblWise`) breakdowns.
    *   It also supports 'StackedBar' chart visualizations (`BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`) by categorizing date differences into time ranges (e.g., "Less than 1 week", "1 - 2 weeks") and pivoting the results.
    *   It utilizes utility functions `getColumnsByCategory` and `getFilterQueryByDisplayValue` for dynamic column selection and filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\getCustomerOptions.ts` (Timestamps: 1/2/2026, 3:58:49 PM to 4:31:23 PM)**
    *   **Initial Update (3:58:49 PM):** Introduced `getAllCustomerOptions` to fetch distinct customer names with search and limit functionality, and `deleteCustomerOption` to delete customers by `account_name` from `mtr_tracking_data`.
    *   **Significant Refinement (4:17:54 PM):** The `deleteCustomerOption` function was updated to accept `customer_id` from `req.params` instead of `account_name` from `req.body`, and the deletion SQL targeted `mtr_tracking_data` using `customer_id`.
    *   **Further Refinement (4:22:36 PM):** The `deleteCustomerOption` SQL was changed to `DELETE FROM mtr_tracking_data WHERE id = $1`, indicating that `customer_id` maps to an `id` column.
    *   **Final Major Change (4:31:23 PM):** The `deleteCustomerOption` SQL was modified to `DELETE FROM Account_Master_Customer_MAP WHERE id = $1`, shifting the deletion target to a customer mapping table.
    *   Several minor changes involved adding `console.log` statements for debugging `customer_id` within the `deleteCustomerOption` function.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\getCustomerOptionsRoute.ts` (Timestamps: 1/2/2026, 3:59:33 PM to 4:28:07 PM)**
    *   **Initial Update (3:59:33 PM):** Defined routes for `GET /` (to `getAllCustomerOptions`) and `DELETE /` (to `deleteCustomerOption`).
    *   **Refinement (3:59:43 PM):** Changed the `DELETE` route from `/` to `/delete`.
    *   **Major Refinement (4:18:20 PM):** The `DELETE` route was further changed to `/delete/:customer_id`, introducing a URL parameter for the customer ID, directly reflecting the controller's update to use `req.params.customer_id`.
    *   The last entry (4:28:07 PM) shows no functional change, likely a re-save.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts` (Timestamps: 1/2/2026, 4:12:38 PM to 4:14:13 PM)**
    *   This file includes `getAllCustomer` and `createCustomer` functions for comprehensive customer master data management.
    *   `getAllCustomer` retrieves customer details from `PO_AccountMaster_Customer_Master` with pagination, ordering, and search. It also fetches associated shipper and document data, and customer mapping.
    *   **Significant Change (4:14:13 PM):** The `getAllCustomer` function's `customerMapData` mapping was updated to explicitly include a `customer_id` field from the `id` column of the `Account_Master_Customer_MAP` table.
    *   `createCustomer` handles both creation and modification of customer records within a database transaction. It generates `acode` and `subcode` if new, deletes old records for modifications, inserts into `PO_AccountMaster_Customer_Master`, handles customer types, and processes shipper mapping by retrieving codes and inserting into `Account_Master_Shipper_MAP`.

**Patterns and Recurring Elements:**

*   **Rapid Iteration and Debugging:** The clustered timestamps on January 2, 2026, especially for `getCustomerOptions.ts` and its route file, suggest intense development and debugging efforts, evidenced by multiple quick saves and `console.log` additions.
*   **Focus on Customer Data Management:** A primary theme is the enhancement and refinement of customer-related functionalities, including fetching customer lists, managing customer master data, and handling customer deletion.
*   **API Design Evolution:** The `getCustomerOptionsRoute.ts` illustrates an evolution in API design, moving towards more specific and RESTful endpoints by introducing parameterized paths for delete operations.
*   **Standardization of Customer Identifiers:** There's a clear shift from identifying customers by `account_name` to using a unique `customer_id` (mapped to an `id` column) for deletion and data retrieval, indicating a move towards more robust data management.
*   **Database-Centric Operations:** All controllers heavily rely on direct SQL queries for data interaction, employing PostgreSQL-specific features like `TRIM`, `ILIKE`, `DATE_TRUNC`, and parameterized queries (`$1`, `$2`).
*   **Complex Analytics:** The `booking.query.ts` demonstrates the need for sophisticated SQL queries to derive analytical insights from operational data, including date calculations, data aggregation, and conditional logic for reporting.
*   **Error Handling and Logging:** `try-catch` blocks are consistently used for error handling in asynchronous operations, and `logger.error`/`console.log` are present for logging and debugging.