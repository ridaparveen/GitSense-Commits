# Activity Summary for 1/2/2026

## 10:35:10 AM
**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
    *   **1/2/2026, 9:50:21 AM:** The component initializes `mapping` from `formik.values.customer_mapping` defaulting to `[{ customer: "" }]`. An `AppAutocomplete` component uses `onInputChange={(val) => handleOptionChange(val)}`, explicitly marked with a `// ✅ FIXED` comment.
    *   **1/2/2026, 9:51:10 AM:** The default initialization for `mapping` was altered to `|| [{ customer: "" }] || []`, adding an additional fallback to an empty array.
    *   **1/2/2026, 9:51:29 AM:** The `mapping` initialization reverted to `|| [{ customer: "" }]`.
    *   **1/2/2026, 9:51:40 AM:** The `mapping` initialization was changed to a simpler `|| []`, meaning it would default to an empty array if `formik.values.customer_mapping` was falsy.
    *   **1/2/2026, 9:51:58 AM:** The `mapping` initialization again reverted to `|| [{ customer: "" }]`.
    *   **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were modified to include `|| []` as a fallback, specifically `value={row.customer || []}` and `options={optionsCustomer || []}`.
    *   **1/2/2026, 9:58:08 AM:** The changes to `AppAutocomplete` props were reverted, setting them back to `value={row.customer}` and `options={optionsCustomer}`. The `// ✅ FIXED` comment next to `onInputChange` was removed.
    *   **1/2/2026, 9:58:13 AM:** No discernible code changes from the previous entry.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`**
    *   Multiple entries between **1/2/2026, 10:18:40 AM** and **1/2/2026, 10:26:07 AM** show the exact same code content. No actual code changes were detected in this file across these timestamps. This indicates multiple saves without modifications or reverts to the same state. The file imports various React hooks, MUI components, formik, redux, and API management utilities to handle booking confirmation, including XML generation and upload.

**Timestamps of Significant Changes:**

*   **1/2/2026, 9:50 AM - 9:58 AM:** A rapid succession of changes and reverts occurred in `CustomerMapping.jsx`, particularly concerning how initial customer mapping data is handled and how `AppAutocomplete` props are defined.
*   **1/2/2026, 9:54:29 AM:** A specific change in `CustomerMapping.jsx` added `|| []` fallbacks to `AppAutocomplete`'s `value` and `options` props, which was then quickly reverted.

**Patterns and Recurring Elements:**

*   **Trial-and-error development:** The frequent changes and immediate reverts in `CustomerMapping.jsx` suggest an iterative development process, possibly debugging or refining how empty states or initial values are handled for form fields.
*   **Consistent project structure:** Both files are part of a `t360-frontend` project, deeply nested within `src/components/screen/code/customer` and `src/pages/booking` respectively, indicating modular component organization.
*   **React and Material-UI usage:** Both components are React functional components that extensively use `@mui/material` components for UI, `useState`, `useEffect`, and `useCallback` hooks for state and lifecycle management.
*   **Formik integration:** Both components utilize `formik` for form state management and validation.
*   **API Service interaction:** Both components interact with an `ApiManager` for data fetching, reflecting a service-oriented architecture.
*   **Logging:** Console logs (`console.log`, `console.error`, `console.warn`) are frequently used for debugging and tracking component behavior, especially in `AgentBookingConfirmation.jsx` during form submission, file selection, and API call outcomes.

## 10:36:04 AM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts` defines an asynchronous function `getAllCustomerOptions` responsible for fetching customer or agent options based on a `role` query parameter. This function consistently incorporates query parameters for pagination (`page`, `perPage`), a search term (`search`), and handles database interactions using `@src/common/util/database` while logging errors with `@src/common/util/logger`.

**Timestamp: 1/2/2026, 10:12:16 AM**
At this timestamp, the code implements distinct logic for `AGENT` and `CUSTOMER` roles.
- For the `AGENT` role, it queries `agent_po_account_master` to retrieve distinct `cname` values, applying a `LIMIT 10` and now incorporating a `WHERE` clause to filter results using `cname ILIKE` based on the provided `search` parameter.
- For the `CUSTOMER` role, a new, active implementation is present. This logic specifically checks if a `search` term is provided. If `search` exists, it queries `Account_Master_Customer_MAP` to retrieve `customer_name` and an aggregated array (`customer_array`) containing both the `customer_name` and `DISTINCT customer_map` values. This array is intended to serve as the `value` for the response, while `customer_name` is the `label`. If no `search` term is provided, it returns an empty array.
- A significant amount of previous implementation code for the `CUSTOMER` role, which handled pagination and distinct `account_name` selection from `mtr_tracking_data` (both with and without search, and using different counting methods), is extensively commented out, indicating prior iterations or considered alternatives.

**Timestamp: 1/2/2026, 10:12:28 AM**
The code at this timestamp is identical to the entry at 10:12:16 AM, suggesting a non-substantive save or minor formatting change.

**Timestamp: 1/2/2026, 10:31:18 AM**
This timestamp marks a significant change in the `CUSTOMER` role's active logic.
- The previously active code for the `CUSTOMER` role (which utilized `Account_Master_Customer_MAP` and `array_cat` for search-based mapping) is now **commented out**.
- A block of code previously commented out for the `CUSTOMER` role has been **re-activated**. This re-activated logic:
    - Queries `mtr_tracking_data` for distinct `account_name` values.
    - Incorporates a flexible `whereClause` to apply `account_name ILIKE` filtering based on the `search` parameter for both paginated and non-paginated requests.
    - For paginated requests, it performs a `COUNT(DISTINCT account_name)` query to get the total, followed by a data query with `LIMIT` and `OFFSET`.
    - For non-paginated requests, it defaults to a `LIMIT 10`.
This indicates a strategic shift back to a more traditional distinct account name retrieval with pagination and search from `mtr_tracking_data`, moving away from the more complex customer mapping array generation.

**Timestamp: 1/2/2026, 10:32:29 AM**
The code at this timestamp is identical to the entry at 10:31:18 AM, again indicating a non-substantive save.

**Patterns and Recurring Elements:**
- **Iterative Development:** The repeated commenting out and re-activation of large code blocks, particularly for the `CUSTOMER` role, highlights an iterative development process where different approaches were tested and revised.
- **Search Functionality:** The consistent integration of a `search` query parameter and its application using `ILIKE` in SQL queries is a recurring pattern across both `AGENT` and `CUSTOMER` roles throughout the changes.
- **Role-Based Logic:** The function consistently separates logic based on `role` (AGENT vs. CUSTOMER), demonstrating clear modularity.
- **Database Interaction and Error Handling:** The use of `query` for database operations and `logger.error` within a `try-catch` block for error handling is standard practice across all versions.
- **Frequent Saves:** The timestamps show very close save times (e.g., 10:12:16 AM, 10:12:28 AM, 10:31:18 AM, 10:32:29 AM), with some entries being identical, which can indicate frequent saves during development.
- **Data Formatting:** The consistent output format of `[{ label: string, value: any }]` for dropdown or auto-search options is maintained.

## 10:36:24 AM
The `SelectCustomer.tsx` file, last modified on 1/2/2026, at 10:35:28 AM, introduces a React component named `SelectCustomerPanel`. This component provides a robust customer selection interface, designed to allow users to select, search for, and persist a customer choice.

Key functionalities and details include:
*   **Customer Selection and Persistence:** The component displays a selected customer and allows users to change it via a dropdown. The selected customer is stored and retrieved from `localStorage` using the key "selectedCustomer" to maintain state across sessions.
*   **Search and API Integration:** It features an input field for searching customers. As the user types or when the dropdown opens, customer options are dynamically fetched from an API (`ApiManager.getCustomerOptions`). The API call supports a search keyword, a "CUSTOMER" role, and pagination (`perPage: 5`).
*   **Dropdown UI:** The component renders a compact display of the selected customer which, when clicked, expands into a dropdown. This dropdown includes a search bar, a list of customer options (with loading and "no results" indicators), and "Cancel" and "Add" buttons.
*   **State Management and Side Effects:** React hooks are extensively used:
    *   `useState` manages the dropdown's open/closed state, the selected customer, options, search input, and loading status.
    *   `useEffect` hooks handle initial loading of the stored customer from `localStorage`, fetching customer options based on search/dropdown state, and attaching/detaching a global `mousedown` event listener for click-away functionality to close the dropdown.
    *   `useRef` is employed for referencing the anchor and dropdown elements to implement the click-away logic accurately.
*   **User Interaction:**
    *   Users can type in the search box to filter customer options.
    *   Clicking an option sets it as the temporarily selected customer.
    *   The "Add" button saves the temporary selection to `localStorage` and triggers the `onSelect` prop.
    *   The "Cancel" button discards any unsaved changes and reverts to the previously stored customer.
    *   A "Clear" button is available within the dropdown to clear the search input.
*   **Styling and Components:** The component heavily utilizes Tailwind CSS classes for styling. It integrates external UI components such as `Button` (from `@components/kit/button`), `PencilIcon` (from `@heroicons/react/16/solid`), and `FiSearch` (from `react-icons/fi`) for visual elements.

The component follows a common pattern for interactive selection elements in React, combining local state, API interactions, and local storage for data persistence, all while providing a user-friendly interface with search capabilities and clear state indicators.

## 11:35:17 AM
In `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`:
- **1/2/2026, 9:50:21 AM:** The component was initialized. It handles customer mapping using `formik`, fetches customer options, and allows adding/deleting/updating customer rows in a `Grid` using `AppAutocomplete` and `IconButton`s. The `mapping` array defaults to `[{ customer: "" }]`.
- **1/2/2026, 9:51:10 AM:** The default value for the `mapping` array was slightly modified, adding an extra `|| []` (`[{ customer: "" }] || []`), which appears redundant.
- **1/2/2026, 9:51:29 AM:** The redundant `|| []` was reverted, restoring `mapping`'s default to `[{ customer: "" }]`.
- **1/2/2026, 9:51:40 AM:** The `mapping` initialization was changed to `formik.values.customer_mapping || []`, removing the default empty customer object.
- **1/2/2026, 9:51:58 AM:** This change was reverted, bringing the `mapping` initialization back to `formik.values.customer_mapping || [{ customer: "" }]`.
- **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were updated to include a fallback to an empty array (e.g., `value={row.customer || []}`), ensuring they always receive an array.
- **1/2/2026, 9:58:08 AM:** The `value` and `options` props of `AppAutocomplete` were reverted to their original state (without the `|| []` fallback). Additionally, the `onInputChange` prop, which was previously commented out with `// ✅ FIXED`, was uncommented and made active, indicating a functional fix or activation.
- **1/2/2026, 9:58:13 AM:** No functional changes were recorded from the previous timestamp.

In `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`:
- **1/2/2026, 10:18:40 AM:** This timestamp marks the initial appearance or a major commit for a complex `AgentBookingConfirmation` page component. It integrates Material-UI, `formik` for validation, Redux (`useSelector`) for state, and RTK Query for API interactions (fetching booking details, packing lists, updating DOs, and generating/uploading XML). The component handles file uploads, manages selected/deselected packing lists (`selectedPl`, `deselectedPl`), and provides responsive design. The `onSubmit` logic is robust, managing different user actions ("save_and_next", "send-to-otm") and providing user feedback via `react-hot-toast` for success, errors, and warnings.
- **1/2/2026, 10:19:36 AM**, **1/2/2026, 10:19:54 AM**, **1/2/2026, 10:22:10 AM**, **1/2/2026, 10:26:07 AM:** The code content for these timestamps is identical to the first entry for this file. This suggests either multiple saves without functional changes or very minor, uncaptured alterations.

**Patterns and Recurring Elements:**
- All changes occurred on **1/2/2026**.
- **Rapid Iteration/Debugging:** The `CustomerMapping.jsx` file saw numerous small changes and reverts within a short timeframe (9:50 AM to 9:58 AM) concerning initial state values and component prop handling, indicative of active debugging or refinement.
- **Form Management:** Both files extensively use the `formik` library for managing form state and validation.
- **API Interaction:** Both components rely on `ApiManager` or RTK Query hooks to fetch and update data, centralizing backend communication.
- **UI Framework:** Material-UI components (`Grid`, `IconButton`, `AppAutocomplete`) are a common dependency across the codebase.
- **Logging and User Feedback:** The `AgentBookingConfirmation.jsx` component makes significant use of `console.log` for debugging and `react-hot-toast` for user notifications, including a custom `WarningToast` for handling non-critical issues.

## 11:36:03 AM
The provided log details changes exclusively within the file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`. This file contains the `getAllCustomerOptions` asynchronous function, which is responsible for fetching customer options based on roles and search criteria.

**File-Specific Updates:**

*   **Timestamp 1/2/2026, 10:12:16 AM:**
    *   A `search` query parameter was introduced to the function.
    *   For the `AGENT` role, the SQL query was updated to include a `WHERE` clause that filters `cname` using `ILIKE` with the new `search` parameter, maintaining a `LIMIT 10`.
    *   The previous logic for the `CUSTOMER` role (which handled pagination and distinct `account_name` from `mtr_tracking_data`) was entirely commented out.
    *   A new, uncommented `CUSTOMER` role logic was introduced. This new logic, active only if a `search` query is present, queries `Account_Master_Customer_MAP`. It fetches `customer_name` and an aggregated `customer_array` (which includes `customer_name` and distinct `customer_map` values), filtering by `customer_name ILIKE` the search term and applying a `LIMIT 10`. If no search term is provided for the `CUSTOMER` role, it returns an empty array.

*   **Timestamp 1/2/2026, 10:12:28 AM:**
    *   No functional code changes were introduced compared to the previous entry. This appears to be a save operation or a minor, non-functional edit.

*   **Timestamp 1/2/2026, 10:31:18 AM:**
    *   The `CUSTOMER` role logic underwent a significant reversal. The newer logic that queried `Account_Master_Customer_MAP` was commented out.
    *   The older `CUSTOMER` role logic (which retrieved distinct `account_name` from `mtr_tracking_data` and included pagination support) was uncommented and reactivated. This re-enabled pagination and search capabilities on `account_name` for customers.

*   **Timestamp 1/2/2026, 10:32:29 AM:**
    *   This entry effectively reverts the change made at 10:31:18 AM. The `CUSTOMER` role logic that queried `mtr_tracking_data` was commented out again.
    *   The `CUSTOMER` role logic that queries `Account_Master_Customer_MAP` and constructs the `customer_array` (active when a search term is present) was uncommented and reactivated.

**Patterns and Recurring Elements:**

*   **Role-based logic:** The function consistently segregates data fetching logic based on `role` (AGENT or CUSTOMER).
*   **Search functionality:** The introduction of a `search` parameter and its integration into SQL queries using `ILIKE` for case-insensitive matching is a recurring theme.
*   **Dynamic querying:** SQL queries are constructed dynamically based on query parameters like `role`, `pagination`, and `search`.
*   **Data transformation:** Results from database queries are consistently mapped to objects with `label` and `value` properties.
*   **Database interaction:** All changes involve interacting with a PostgreSQL database using a `query` utility.
*   **Error handling:** A consistent `try-catch` block is used to log errors and return a 500 status code for internal server errors.
*   **Iterative Development/Experimentation:** The frequent commenting and uncommenting of entire code blocks, particularly for the `CUSTOMER` role, suggests an ongoing process of refining or experimenting with different data retrieval strategies for customer options. There's a clear back-and-forth between two distinct approaches for customer data.

## 11:36:37 AM
The code changes primarily revolve around customer selection functionality and its integration with a global state management system.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **Timestamp Range: 1/2/2026, 10:35:28 AM - 11:27:52 AM**
    *   This React component, `SelectCustomerPanel`, manages customer selection through a dropdown with search capabilities.
    *   **Initial Changes (10:35 AM - 11:16 AM):** There was repeated modification of whether the `onSelect` callback should use `selectedCustomer.value` or `selectedCustomer.label`. Similarly, the `getDisplayText` function was adjusted to prioritize `selectedCustomer?.label` over `selectedCustomer?.value` for display. The `CustomerOption` interface's `value` property was also made optional.
    *   **Minor Adjustment (11:22:49 AM):** A brief attempt was made to use `selectedCustomer.value[0]` for the `onSelect` callback, suggesting an anticipation of `value` potentially being an array. This was quickly reverted in the subsequent commit (11:23:09 AM).
    *   **Significant Update (11:27:21 AM):** The component's rendering logic for customer options was refined. The `key` for mapped options changed from `opt.value` to `opt.label`. Crucially, the `onClick` handler for selecting an option and the display logic within the dropdown were updated to explicitly handle cases where `opt.value` might be an array. If `opt.value` is an array, `opt.label` is used as the selected customer's `value` property, and `opt.value[0]` is used for display if `opt.label` is missing. This indicates a clarification or adaptation to the expected data structure of `CustomerOption`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **Timestamp Range: 1/2/2026, 11:18:39 AM - 11:22:40 AM**
    *   This Redux slice manages global application state, including the `selectedCustomer` and a `loading` indicator.
    *   **Initial Implementation (11:18:39 AM):** The `setSelectedCustomer` reducer was designed to store only the `label` property of a `CustomerOption` object (both in the Redux state and `localStorage`), along with a comment indicating this intention.
    *   **Refinement (11:21:20 AM):** The `setSelectedCustomer` reducer was updated to directly accept a `string | null` payload for `selectedCustomer`, simplifying the logic to store this string directly without needing to extract a `label` property. It also added a check for non-empty strings (`value.trim() !== ""`) before storing.
    *   **Debugging (11:21:42 AM):** A `console.log` statement was temporarily added within the `setSelectedCustomer` reducer to output the payload value, likely for debugging purposes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 1/2/2026, 11:30:27 AM**
    *   This analytics screen component was updated to integrate with the global `selectedCustomer` state.
    *   It now consumes the `selectedCustomer` and `loading` states from the `globalSlice`.
    *   If the authenticated user has a "CUSTOMER" role, their `companyname` is automatically dispatched and set as the global `selectedCustomer`.
    *   Crucially, API calls for fetching dashboards (`useFetchDashboardsQuery`) and analytics endpoints (`useLazyFetchEndpointsQuery`, `useLazyFetchReportQuery`) are now made conditional on `selectedCustomer` being present and utilize it as the `companyname` parameter for fetching relevant data. This ensures analytics data is loaded in the context of the globally selected customer.

**Patterns and Recurring Elements:**

*   **Evolving `selectedCustomer` Management:** There's a clear pattern of refining how the "selected customer" is managed. Initially, it involved local state and `localStorage` in `SelectCustomer.tsx`, then a Redux slice was introduced to centralize this state, impacting other components like `analytics-page.tsx`.
*   **`label` vs. `value` Handling:** A recurring theme in `SelectCustomer.tsx` is the back-and-forth decision-making on whether to use `customer.label` or `customer.value` for display and callback purposes, suggesting an ambiguity or evolving requirement for customer identification. This eventually led to explicit array handling for `opt.value`.
*   **Local Storage Usage:** Both `SelectCustomer.tsx` (using `STORAGE_KEY`) and `global-slice.ts` consistently use `localStorage` to persist the selected customer, allowing the selection to persist across sessions or page reloads.
*   **Rapid Iteration:** The close timestamps of many changes, particularly within `SelectCustomer.tsx` and `global-slice.ts`, indicate a period of rapid iteration, development, and debugging. The temporary `console.log` further supports this.
*   **Dependency on `selectedCustomer`:** The `analytics-page.tsx` clearly demonstrates a new dependency on the `selectedCustomer` state, indicating that much of the analytics data loading is now scoped to the currently selected customer.

## 12:35:12 PM
`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`
This file, a React component named `CustomerMapping`, underwent several rapid changes between 1/2/2026, 9:50:21 AM and 9:58:13 AM. The primary focus of these changes was the initialization of the `mapping` array (derived from `formik.values.customer_mapping`) and the props passed to the `AppAutocomplete` component.

Initially, `mapping` defaulted to `[{ customer: "" }]`. This default was briefly changed to `|| [{ customer: "" }] || []` at 9:51:10 AM, then reverted at 9:51:29 AM, changed again to `|| []` at 9:51:40 AM, and finally reverted back to `|| [{ customer: "" }]` at 9:51:58 AM, indicating an iterative process to determine the desired default state for the customer mapping list.

Similarly, at 9:54:29 AM, `|| []` was added to the `value` and `options` props of `AppAutocomplete` (i.e., `value={row.customer || []}` and `options={optionsCustomer || []}`) to ensure they always received an array, but these additions were removed at 9:58:08 AM. The `// ✅ FIXED` comment on the `onInputChange` prop was also removed at 9:58:08 AM, suggesting that the underlying fix was confirmed. The final entry at 9:58:13 AM shows no functional change, likely a mere save operation.

`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`
This file saw multiple consecutive save operations between 1/2/2026, 10:18:40 AM and 10:26:07 AM, with the provided snippets showing identical code content across these timestamps. The component, `AgentBookingConfirmation`, handles the confirmation process for agent bookings.

The key functionalities observed in the provided code snippet (specifically the `onSubmit` handler of the `formik` instance) include:
-   **Form Submission**: Submitting booking data, including a `do_document` file and a JSON payload.
-   **Data Management**: The payload includes `agent_booking_id`, arrays of `selectedPl` (Packing Lists) and `deselectedPl`, and `vesselList`.
-   **API Interaction**: Uses Redux Toolkit Query mutations (`useUpdateDoMutation`, `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`) to update booking details, generate XML, and upload XML.
-   **User Feedback**: Leverages `react-hot-toast` for loading, success, and error messages.
-   **Warning Handling**: Implements a mechanism to display warnings returned from the API using a `WarningToast` component and can throw a custom error to trigger a `PopupAlert` for warnings.
-   **Workflow Control**: Based on `userAction`, it either proceeds to the next step (`setActiveStep(2)`) or triggers XML generation and upload to OTM (Oracle Transportation Management).
-   **Error Handling**: Catches general errors and specific custom warning errors to display appropriate alerts.

**Patterns and Recurring Elements:**
-   **Frequent Saves**: Both files show a pattern of multiple saves within a short timeframe, often without functional changes, which is common during active development or debugging.
-   **React Hooks and Formik**: Both components extensively use React hooks (`useState`, `useEffect`, `useCallback`, `useMemo`) for state and lifecycle management, and `useFormik` for robust form handling, including validation schemas and submission logic.
-   **MUI Integration**: Both utilize Material-UI (`@mui/material`) components like `Grid`, `IconButton`, and various others, indicating a consistent UI library choice.
-   **API Interaction**: Both components interact with backend APIs, either directly via `ApiManager` or through Redux Toolkit Query, to manage data.
-   **Debugging and Logging**: There is consistent use of `console.log` and `console.error` throughout the `AgentBookingConfirmation` component's `onSubmit` logic, suggesting active debugging and traceability.

## 12:36:23 PM
The code changes primarily focus on enhancing analytics reporting and customer search functionalities within the `t360-backend-v2` project. Key updates include refinements in SQL query generation, improved handling of dynamic parameters, and a move towards more secure and flexible data retrieval methods.

**File: `src\services\analytics\customerAutosearchOptions.ts`**

*   **Initial Update (1/2/2026, 10:12:16 AM):** The `getAllCustomerOptions` function was significantly refactored. A `search` query parameter was introduced. For the 'AGENT' role, search functionality using `ILIKE` on `cname` was added. For the 'CUSTOMER' role, the logic was dramatically changed: if a `search` term is provided, it now queries `Account_Master_Customer_MAP` to retrieve `customer_name` and an aggregated array of `customer_map` values, combining them into a single `customer_array` for the `value` field. If no search term is present, an empty array is returned.
*   **Minor Save (1/2/2026, 10:12:28 AM):** No functional changes were observed; the code remained identical to the previous timestamp.
*   **Temporary Revert (1/2/2026, 10:31:18 AM):** The newly introduced `Account_Master_Customer_MAP` based logic for the 'CUSTOMER' role was commented out, and the older `mtr_tracking_data` based logic (which supported pagination and basic search on `account_name`) was reactivated.
*   **Re-Revert (1/2/2026, 10:32:29 AM):** The `Account_Master_Customer_MAP` based logic was uncommented and re-activated for the 'CUSTOMER' role, while the `mtr_tracking_data` logic was commented out again. This suggests an active development or testing phase for these distinct customer search strategies.

**File: `src\services\analytics\teuService.ts`**

*   **Refinement of Query Logic (1/2/2026, 11:41:32 AM):** The `getTEUReports` function's SQL query generation was updated. For non-country-based groupings, a `CASE` statement was introduced to categorize `NULL` or empty grouping column values as 'OTHERS'. Additionally, a specific mapping was added to treat 'LONG BEACH' as 'LOS ANGELES' for `pod` or `place_of_delivery` columns. The `account_name` filtering still used direct string interpolation.
*   **Minor Save (1/2/2026, 11:41:37 AM):** No functional changes were observed; the code remained identical.
*   **Multi-Company Filtering (1/2/2026, 11:47:41 AM):** A significant improvement was made to the `WHERE` clause for `account_name` in all `mainQuery` variations. It transitioned from direct string interpolation of a single company name to using `LOWER(m.account_name) = ANY ( regexp_split_to_array(LOWER($1), '\s*,\s*') )`, allowing the query to filter by multiple comma-separated company names passed as a single parameter.
*   **Regex Escaping Fix (1/2/2026, 11:51:49 AM):** A minor but important fix was applied to the `regexp_split_to_array` pattern within the SQL queries. The backslashes for whitespace (`\s`) were double-escaped to `\\\\s` to ensure correct interpretation within the SQL string literal.
*   **Parameterized Queries and Refactoring (1/2/2026, 11:54:08 AM):** A major refactoring occurred to implement parameterized queries for `CompanyName`, `fromDate`, and `toDate` (using `$1`, `$2`, `$3` in the SQL). This significantly enhances security by preventing SQL injection. The `customizer` object initialization was streamlined, and `WHERE` clause conditions for null/empty checks were simplified.

**File: `src\common\util\booking.query.ts`**

*   **Initial Implementation (1/2/2026, 11:58:30 AM):** This new file introduced `bookingQueryBuilder` to generate SQL queries for various booking-related analytics reports. It supports different report types such as "BookingDatetoActualDeparture" and "StackedBar" versions. Queries primarily calculate date differences between `t49_vessel_actualdeparted_date` and `bookingdate`, grouping by `fileno` and `contno` or `mblno`. Initial versions used direct string interpolation for `CompanyName`, `fromDate`, `toDate`.
*   **Multi-Company Filtering (1/2/2026, 12:10:52 PM):** Similar to `teuService.ts`, the `account_name` filtering in all booking queries was updated to `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` to support filtering by multiple company names.
*   **Minor Saves (1/2/2026, 12:13:21 PM & 1/2/2026, 12:23:19 PM):** No functional changes were observed in these consecutive updates; the code remained identical.

**File: `src\common\util\transit.query.ts`**

*   **Initial Implementation (1/2/2026, 12:24:34 PM):** This new file introduced `transitQueryBuilder` and a helper `queryGenerator` function. It's designed to build complex SQL queries for transit reports, comparing actual vs. estimated transit times. It populates `customizer.additionalData` with estimated, actual, and estimated-actual transit values. The `account_name` filtering within `queryGenerator` also adopted the `regexp_split_to_array` pattern for `CompanyName`. Note that the `regexp_split_to_array` uses single backslashes `\s*,\s*` in this context, similar to the `booking.query.ts` prior to its double-escaping fix.

**File: `src\services\analytics\transitService.ts`**

*   **Initial Implementation (1/2/2026, 12:26:55 PM):** This new service consumes the `transitQueryBuilder` to generate and execute transit analytics reports. It handles default date ranges, retrieves user and company information, and dynamically sets `mblwiseCondition` based on query parameters before passing control to the query builder.

**Patterns and Recurring Elements:**

*   **Dynamic Query Generation:** All `*_query.ts` files are dedicated to constructing complex SQL queries based on user-provided parameters like `role`, `type`, `columnName`, `fromDate`, `toDate`, and `CompanyName`.
*   **Evolution of Company Name Filtering:** A prominent pattern is the shift from direct string interpolation of `CompanyName` to a more robust and flexible approach using `regexp_split_to_array` with `ANY` for `account_name` filtering, allowing multiple company names. `teuService.ts` further progressed to full parameterized queries for `CompanyName` and dates.
*   **Date Range Management:** Multiple services handle date range parameters, with `teuService.ts` and `transitService.ts` providing `defaultDateRange` fallback.
*   **Container Type Parsing:** SQL queries frequently parse container types (`t49_cont_type`, `cont_type`) using `REGEXP_REPLACE` to extract numeric values for TEU calculations.
*   **NULL/Empty Value Handling:** `CASE` statements are commonly used in SQL queries to handle `NULL` or empty string values in grouping columns, often defaulting them to 'OTHERS'.
*   **Analytics Customizer Object:** A `customizer` object is consistently used across analytics services to configure report characteristics like `dateRange`, `calType`, `selectedColumns`, `chartType`, and `calColumnConfig`.
*   **Error Handling:** All service endpoints include `try...catch` blocks and use a `logger` for error reporting, returning `500 Internal Server Error` on failure.

## 12:36:39 PM
The code change log primarily details updates to components and Redux state management related to customer selection within a frontend application.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\SelectCustomer.tsx`**
    *   **Timestamp: 1/2/2026, 10:35:28 AM - 11:23:09 AM:** This period shows a series of rapid, minor adjustments and reversions.
        *   Initial implementation and several small changes in the `handleAdd` function's `onSelect` call, toggling between passing `selectedCustomer.value` and `selectedCustomer.label`.
        *   Similarly, the `getDisplayText` function frequently switched between displaying `selectedCustomer?.value` and `selectedCustomer?.label`.
        *   An attempt to access `selectedCustomer.value[0]` was briefly introduced (11:22:49 AM), hinting at an upcoming change to handle array values.
        *   The `CustomerOption` interface was initially `value: string;` and later changed to `value?: string;` (10:37:50 AM).
    *   **Timestamp: 1/2/2026, 11:27:21 AM - 11:27:52 AM:**
        *   Significant changes were made to how customer options are rendered and selected within the dropdown. The `key` for mapped options was changed from `opt.value` to `opt.label`.
        *   The `setSelectedCustomer` logic was updated to explicitly handle `opt.value` potentially being an array, attempting to set `selectedCustomer.value` based on `opt.label` or `opt.value`. This change foreshadowed a more formal type definition.
    *   **Timestamp: 1/2/2026, 11:38:05 AM - 11:38:33 AM:** This marks a major refactor to support multi-value customer selection.
        *   The `CustomerOption` interface was updated to `value?: string | string[];` allowing customer values to be either a single string or an array of strings.
        *   The `handleAdd` function was completely re-written to consistently store the `selectedCustomer.value` as an array (even if it was initially a single string) in `localStorage`.
        *   The `onSelect` prop now receives a comma-separated string of values (`values.join(",")`) to its parent component/Redux.
        *   The `onClick` logic for selecting an option in the dropdown was simplified to directly assign `opt.value` (which can now be an array) to `selectedCustomer.value`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\global-slice.ts`**
    *   **Timestamp: 1/2/2026, 11:18:39 AM - 11:19:30 AM:**
        *   Initially, the `selectedCustomer` in the Redux state was `string | null`.
        *   The `setSelectedCustomer` reducer expected a `CustomerOption` payload and stored only the `customer.label` as a string in both Redux state and `localStorage`.
    *   **Timestamp: 1/2/2026, 11:21:20 AM - 11:22:40 AM:**
        *   The `setSelectedCustomer` reducer was updated to expect a `PayloadAction<string | null>`, directly storing the provided string value in Redux state and `localStorage`.
        *   A `console.log` statement was added for debugging (`11:21:42 AM`).
    *   **Timestamp: 1/2/2026, 11:39:20 AM:** This update aligns with the `SelectCustomer.tsx` changes to support multiple customer values.
        *   The `selectedCustomer` in the `GlobalState` interface was changed from `string | null` to `string[] | null`.
        *   The `setSelectedCustomer` reducer now expects a `PayloadAction<string[] | null>` and stores the array as a JSON string in `localStorage` using `JSON.stringify(value)`.
        *   The `initializeSelectedCustomer` reducer still directly uses `localStorage.getItem` to assign the value, which may lead to a type mismatch if the stored item is expected to be an array (it would need `JSON.parse` to convert the string back to an array).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\pages\analytics\analytics-page.tsx`**
    *   **Timestamp: 1/2/2026, 11:30:27 AM:**
        *   This page was updated to consume the `selectedCustomer` state from the `globalSlice` to conditionally fetch dashboard data.
        *   It dispatches `setSelectedCustomer(user.companyname)` when a user with the role "CUSTOMER" logs in, implying `user.companyname` is a single string. This action would later need to adapt to the `global-slice.ts` change expecting `string[]` for `selectedCustomer`.

### Patterns and Recurring Elements:

*   **Evolution of Customer Selection:** The most prominent pattern is the continuous refinement of how a "selected customer" is represented and managed. It started as a single string `value` or `label`, evolved through implicit array handling, and finally became an explicit `string | string[]` type in the UI component, and `string[] | null` in the Redux store.
*   **LocalStorage as Persistence Layer:** `localStorage` is consistently used across `SelectCustomer.tsx` and `global-slice.ts` to persist the selected customer, though the format of storage (raw string vs. JSON stringified object/array) changes with the evolving data structure.
*   **Redux for Global State:** The `global-slice.ts` demonstrates the use of Redux Toolkit to manage the `selectedCustomer` and `loading` states globally, allowing components like `AnalyticsScreen` to subscribe to these changes.
*   **Debugging and Iteration:** The frequent, small changes and the inclusion of `console.log` statements suggest an iterative development process with active debugging.
*   **API Interaction:** Both `SelectCustomer.tsx` and `analytics-page.tsx` interact with `ApiManager` to fetch customer options and analytics data, respectively.
*   **Type System Adjustments:** The TypeScript interfaces were updated to reflect the changing data structures, particularly `CustomerOption` in `SelectCustomer.tsx` and `GlobalState` in `global-slice.ts`.

## 1:35:13 PM
The log primarily details changes within two React component files, `CustomerMapping.jsx` and `AgentBookingConfirmation.jsx`, both located within a `t360-frontend` project.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`**
This file, a React component named `CustomerMapping`, deals with customer mapping functionality, likely involving a dynamic list of customer selection fields. Over a short period on 1/2/2026, there were several rapid modifications and reverts:

*   **1/2/2026, 9:50:21 AM:** The component initialized `mapping` from `formik.values.customer_mapping`, defaulting to `[{ customer: "" }]` if empty. It used `AppAutocomplete` with props `handleOptionChange` and `onInputChange={(val) => handleOptionChange(val)}`.
*   **1/2/2026, 9:51:10 AM:** An attempt was made to change the `mapping` initialization to `formik.values.customer_mapping || [{ customer: "" }] || []`, adding a redundant `|| []` to the default.
*   **1/2/2026, 9:51:29 AM:** The `mapping` initialization was reverted to its original state: `formik.values.customer_mapping || [{ customer: "" }]`.
*   **1/2/2026, 9:51:40 AM:** The `mapping` initialization was modified again to `formik.values.customer_mapping || []`, which would initialize with an empty array rather than a single empty customer object.
*   **1/2/2026, 9:51:58 AM:** This change was also reverted, restoring the `mapping` initialization to `formik.values.customer_mapping || [{ customer: "" }]`.
*   **1/2/2026, 9:54:29 AM:** The `AppAutocomplete` component's `value` and `options` props were updated to `value={row.customer || []}` and `options={optionsCustomer || []}` respectively, ensuring they always receive an array.
*   **1/2/2026, 9:58:08 AM:** The `AppAutocomplete` props for `value` and `options` were reverted to `value={row.customer}` and `options={optionsCustomer}`, removing the `|| []` fallback.
*   **1/2/2026, 9:58:13 AM:** No functional code change was observed at this timestamp; the content is identical to the previous entry, suggesting a minor save or re-save operation.

**File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`**
This file, `AgentBookingConfirmation.jsx`, is a comprehensive React component responsible for managing the booking confirmation process. All entries for this file across several timestamps on 1/2/2026 show identical content. This suggests that no functional code changes were committed or logged during these specific timestamps, or the changes were minimal (e.g., whitespace) and not captured in the provided log snippets.

The component's core functionality includes:
*   **UI and State Management:** Utilizes Material-UI components for layout, `formik` for form handling with `bookingConfirmationValidation`, and various `useState` hooks for managing UI state (e.g., `selectedFile`, `selectedPl`, `deselectedPl`, `pagination`, `alertConfig`, modal visibility). It also uses `useSelector` from `react-redux` to access vessel list data.
*   **Data Fetching and Manipulation:** Employs RTK Query hooks (`useGetBookingConfirmQuery`, `useFetchBookingPlListQuery`, `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`, `useUpdateDoMutation`) to interact with a backend API for booking details, packing lists, and document updates.
*   **Form Submission Logic:** The `onSubmit` handler processes form data, including file uploads (`do_document`), and prepares a payload with selected and deselected packing list items. It handles success/error messages using `react-hot-toast` and conditional logic for XML generation and upload (e.g., for "send-to-otm" action). It also features a `WarningToast` for specific API warnings.
*   **Responsiveness:** Dynamically adjusts table page size (`responsivePageSize`) based on screen breakpoints.
*   **Modals and Sub-components:** Integrates `ThemedModalExtend` for `AddVesselForm` and `ScacCodeForm`, and includes `SingleFileDropzone` and `UploadFile` for document handling.

**Patterns and Recurring Elements:**
*   **Rapid Iteration/Reversion:** The `CustomerMapping.jsx` file shows a pattern of quick, small changes to variable initialization logic, often followed by immediate reverts within minutes, indicating experimentation or debugging around edge cases for initial component state.
*   **Consistent File Structure:** Both files demonstrate a modern React development approach, utilizing functional components, hooks (`useState`, `useEffect`, `useCallback`, `useMemo`), form libraries (`formik`), and dedicated API interaction layers (RTK Query, `ApiManager`).
*   **Detailed Console Logging:** Throughout the `AgentBookingConfirmation.jsx` code (and implicitly in `CustomerMapping.jsx`'s `fetchCustomers`), there's a strong emphasis on `console.log` and `console.error` for debugging and tracing application flow, especially during API interactions and form submissions.
*   **Standardized Error/Success Handling:** The use of `react-hot-toast` for user feedback and `PopupAlert`/`WarningToast` for more critical messages is consistent across the application.