# Activity Summary for 1/5/2026

## 1:43:10 PM
Changes occurred across two files within a `javascript-learning` directory.

**File: `c:\Users\ridap\OneDrive\Documents\javascript-learning\index.html`**
*   **Initial setup (1/4/2026, 3:18:32 PM):** An basic HTML document was created, including a `<h1>Hello world!</h1>` and an empty `<button>` element with an `onclick` event that displays "welcome to my js tutorials".
*   **Minor UI refinement (1/4/2026, 3:18:41 PM):** The previously empty `<button>` element was given the visible text "Click me".

**File: `c:\Users\ridap\OneDrive\Documents\javascript-learning\0_variables.js`**
*   **Initial JavaScript code (1/4/2026, 3:36:06 PM):** A `console.log` statement was added with the text "Hello my first js code!". It initially contained a syntax error (semicolon inside the string).
*   **Syntax correction (1/4/2026, 3:36:47 PM):** The syntax error in the `console.log` statement was fixed by moving the semicolon outside the string.
*   **Introduction of variables (1/4/2026, 3:38:49 PM):** A comment `// camel` was added, and a `var` variable `myAge` was declared with a value of 25, followed by its `console.log`.
*   **Comment refinement (1/4/2026, 3:38:57 PM):** The comment was slightly expanded from `// camel` to `// camel case`.
*   **Variable naming examples (1/4/2026, 3:45:07 PM):** The file was significantly updated to include more examples of variable declarations using `var`, such as `my_firtsName`, `_lastName`, and `$myAge`, all followed by `console.log`. Additionally, examples of *invalid* variable names (`123data`, `my@email`) were included, also with `console.log` statements.
*   **Commenting out invalid code (1/4/2026, 3:45:32 PM):** The lines demonstrating invalid variable declarations (`123data`, `my@email`) and their `console.log` calls were commented out, likely to prevent errors or indicate they are illustrative examples of what *not* to do.
*   **No functional change (1/4/2026, 3:45:41 PM):** The last entry for this file shows no change in content from the previous timestamp.

**Patterns and Recurring Elements:**
*   **Educational Context:** The file names (`javascript-learning`, `0_variables.js`) and the content (basic HTML elements, `onclick` alerts, `console.log`, variable declarations, variable naming conventions) strongly suggest these changes are part of a learning or tutorial process for JavaScript.
*   **Incremental Development:** Changes progress from basic setup to introducing core concepts, fixing syntax errors, and demonstrating valid/invalid practices.
*   **Focus on Fundamentals:** The JavaScript file specifically delves into variable declaration and naming conventions, indicating a focus on foundational JS concepts.

## 1:43:26 PM
The provided code changes primarily focus on refining and expanding the query generation logic for various analytics reports and enhancing the customer autosearch functionality.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts`** (Timestamp: 1/2/2026, 4:59:40 PM):
    *   Introduced a new `transitQueryI` interface for better type safety in query parameters.
    *   Expanded `transitQueryBuilder` to handle `country_of_origin` as a `columnName` with specific `getColumnsByCategory` and `calColumnConfig` settings. This path also performs multiple sub-queries for `estimated`, `actual`, and `estimated_actual` transit times and stores them in `customizer.additionalData`.
    *   Added two new `type` conditions: `"ScheduledTransitVsActualTransit"` and `"ScheduledTransitVsActualTransitMblWise"`. Both generate complex `WITH` clause SQL queries to calculate the difference between actual and scheduled transit times, grouped by `fileno` and `contno` (or `mblno` for `MblWise`), and calculate percentages relative to the maximum value.
    *   The `else` block (default) now specifically handles `port_pair` reports, fetching `estimated`, `actual`, and `estimated_actual` data similarly to `country_of_origin`.
    *   The `queryGenerator` function was updated to support `country_of_origin` reports, including `mblwiseCondition` for dynamic `SELECT` and `GROUP BY` clauses, and a new `WHERE` clause `AND foo.value >= -60`. A `CASE` statement was added to `percentage` calculation to handle `max_value.max_total = 0` and negative `t.value`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`** (Timestamp: 1/2/2026, 5:00:42 PM and 1/2/2026, 5:00:53 PM):
    *   Refined the `getTEUReports` function.
    *   Added `mblwiseCondition` object to dynamically modify `SELECT`, `CONDITION`, and `GROUP BY` clauses in SQL queries.
    *   Improved the logic for handling `country_of_origin` or `country_of_discharge` as `columnName`, specifically joining with `portmaster` and calculating `total_volume` based on `t49_cont_type` or `cont_type`.
    *   The general `else` block for other `columnName` values now includes a `CASE` statement to map 'LONG BEACH' to 'LOS ANGELES' for 'pod' or 'place_of_delivery' columns and to replace `NULL` or empty strings with 'OTHERS'.
    *   The SQL queries use `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` for multi-company filtering, replacing the previous single-company `account_name = '${CompanyName}'`.
    *   The repeated timestamp indicates no functional change between these two commits, likely a minor save or formatting change.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\departure.query.ts`** (Timestamp: 1/2/2026, 5:01:49 PM):
    *   Expanded `departureQueryBuilder` to support new report types.
    *   **`BLReleaseKPI`**: Implemented for stacked bar charts, calculating `day_diff` between "Vessel Actual Departure Date" and "Batch Run Date", categorizing into "Equal/Less than 3 days" and "More than 3 days". Uses `DISTINCT ON` for `voyage`, `contno`, and container type to avoid duplicate entries.
    *   **`DelayedPOLDepartures`**: Calculates `day_diff` between "Live Actual Departed Date" and "Departure Date" per `fileno` and `contno`, filtering for positive delays and values within a reasonable range (>= -60 days).
    *   **`DelayedPOLDeparturesMblWise`**: Similar to `DelayedPOLDepartures` but aggregates by `fileno` and `mblno`.
    *   **`OriginalETAvsActualETA`**: Calculates `day_diff` between "Updated ETA Port Date" and "ETA POD" per `fileno` and `contno`. Includes handling for division by zero and negative `value` in percentage calculation.
    *   **`OriginalETAvsActualETAMblWise`**: Declared but the code block is truncated. It likely mirrors `OriginalETAvsActualETA` but aggregates by `fileno` and `mblno`.
    *   All new queries incorporate `DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL AND TRIM(m.t49_cont_type) <> '' AND TRIM(m.t49_cont_type) != '0' THEN m.t49_cont_type ELSE m.cont_type END )` to handle unique container tracking records.
    *   Date checks (`is not null` and `!= '0001-01-01 00:00:00 BC'`) are consistently applied.
    *   Company filtering uses `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\general.query.ts`** (Timestamp: 1/2/2026, 5:03:05 PM):
    *   Updated `generalQueryBuilder` for "Total Shipments" and "Total Shipments Mbl Wise".
    *   Both now consistently use `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` for `CompanyName` filtering.
    *   The `TotalShipments` query counts `fileno` and `voyage` (aliased as "Container Count").
    *   The `TotalShipmentsMblWise` query counts `fileno` and `mblno` (aliased as "Mbl Count").
    *   Both reports now process query results to calculate `percentage` based on the maximum value found.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\container.query.ts`** (Timestamp: 1/2/2026, 5:03:44 PM):
    *   Expanded `containerQueryBuilder` with new report types, all using `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` for filtering.
    *   **`ContainerDischargevsContainerAvailable`**: Calculates `day_diff` between `available_date` (prioritizing `t49_cont_available_date`) and `cont_discharge_date`.
    *   **`ContainerDischargeVsFinalDeliveryDate`**: Calculates `day_diff` between `delivery_customer_date` and `cont_discharge_date`, specifically for `type_of_move` in ('FDC','FDN').
    *   **`ContainerGateOutVsGateIn`**: Calculates `day_diff` between `final_empty_return_date` (prioritizing `t49_empty_return_date`) and `final_contno_out_gated` (prioritizing `t49_contno_out_gated`), adding 1 day to the difference.
    *   **`ContainerOrVesselDischargeVsGateOut`**: Calculates `day_diff` between `final_contno_out_gated` (prioritizing `t49_contno_out_gated`) and `cont_discharge_date`.
    *   All these queries also apply `DISTINCT ON` for unique container tracking, similar to `departure.query.ts`, and filter out invalid date values. Percentage calculations include safeguards for division by zero and negative values.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`** (Timestamps: 1/2/2026, 5:09:05 PM, 5:09:30 PM, 5:11:03 PM, 5:46:22 PM, 5:47:08 PM):
    *   Introduced new report types to `bookingQueryBuilder`.
    *   **`BookingDatetoActualDeparture`**: Calculates average `day_diff` between "Live Actual Departed Date" (`t49_vessel_actualdeparted_date`) and "Booking Date" per `fileno` and `contno`. Joins `mtr_tracking_data` with `agent_booking_entry` on `mblno`.
    *   **`BookingDatetoActualDepartureMblWise`**: Similar to the above, but aggregates by `fileno` and `mblno`.
    *   **`BookingDatetoActualDepartureStackedBar`**: Implements a stacked bar chart view, categorizing `day_diff` (Booking Date to Actual Departure) into "Less than 1 week", "1 - 2 weeks", "2 - 3 weeks", "3 - 5 weeks", and "Above 5 weeks".
    *   **`BookingDatetoActualDepartureMblWiseStackedBar`**: Similar stacked bar chart, but aggregated by `mblno`.
    *   All these booking queries consistently use `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )` for company filtering, join `mtr_tracking_data` with `agent_booking_entry`, and filter for valid non-null dates.
    *   The repeated timestamps (5:09:05 PM to 5:47:08 PM) indicate no functional change across these entries for this file, suggesting minor saves or reformatting.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`** (Timestamps: 1/5/2026, 10:14:20 AM to 1/5/2026, 12:43:34 PM):
    *   This file undergoes significant refactoring for customer search functionality.
    *   **Initial change (10:14:20 AM)**: The previous commented-out logic for `CUSTOMER` role that used `mtr_tracking_data` is replaced. A new approach uses `Account_Master_Customer_MAP` to find `customer_name` and `customer_map` (an array of mapped customers). It uses `array_cat` and `array_agg` to combine the main customer name and its mapped aliases for search results.
    *   **Intermediate changes (10:38:03 AM, 11:27:01 AM)**: No functional changes, likely minor saves.
    *   **Shift in logic (11:32:39 AM, 11:35:07 AM, 11:35:15 AM, 11:37:50 AM, 11:38:56 AM)**: The `CUSTOMER` role search logic is commented out and replaced with an attempt to use `PO_AccountMaster_Customer_Master`. This new query tries to find `cname` or any `unnest(customer_map)` entry that matches the search term. The client-side post-processing attempts to flatten these into unique `label`/`value` pairs.
    *   **Refinement of `PO_AccountMaster_Customer_Master` query (11:59:52 AM, 12:10:43 PM, 12:13:07 PM)**: The SQL query for `CUSTOMER` role using `PO_AccountMaster_Customer_Master` is further modified to select `cname` as `main_customer` and `customer_map` as `mapped_customers`. The client-side logic is expanded to handle `customer_map` being an array or a PostgreSQL array string (e.g., `"{A,B}"`), extract individual customers, and then consolidate them into unique `label:value` pairs. The queries attempt to `UNION` results where the main customer matches OR a mapped customer matches.
    *   **Reversion (12:42:32 PM, 12:43:34 PM)**: The `CUSTOMER` role search logic reverts to an earlier implementation that queries `mtr_tracking_data` for `account_name` (with pagination support) and the original `Account_Master_Customer_MAP` search logic. The complex `PO_AccountMaster_Customer_Master` logic is commented out again. This suggests a re-evaluation or temporary rollback of the `PO_AccountMaster_Customer_Master` based search.

### Patterns and Recurring Elements:

*   **Date Filtering**: All analytical queries consistently filter data by `departure_date` within a `fromDate` and `toDate` range using `'${fromDate}'::timestamp` and `'${toDate}'::timestamp + INTERVAL '1 day'`.
*   **Invalid Date Handling**: There's a strong pattern of explicitly checking for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` for relevant date columns (e.g., `t49_vessel_actualdeparted_date`, `bookingdate`, `eta_pod`, `batch_run_date`, etc.) to ensure data quality in calculations.
*   **Company Filtering**: All queries use a robust method for filtering by `CompanyName`: `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )`. This allows for searching by multiple company names if provided as a comma-separated string.
*   **`DISTINCT ON` Clause**: Many queries, especially in `transit.query.ts`, `departure.query.ts`, and `container.query.ts`, utilize `DISTINCT ON (voyage, contno, CASE WHEN t49_cont_type IS NOT NULL AND TRIM(t49_cont_type) <> '' AND TRIM(t49_cont_type) != '0' THEN t49_cont_type ELSE cont_type END )` to ensure uniqueness per container tracking record, preventing duplicate calculations for the same container within a voyage or based on container type.
*   **Customizer Object**: A `customizer` object is universally used across query builders to configure chart types, calculation types (`avg`, `total`), date columns, and `selectedColumns` for UI rendering and data processing. `getColumnsByCategory` is frequently called to populate `selectedColumns` based on ignored and required columns.
*   **Percentage Calculation**: Many report types calculate a `percentage` based on a value relative to the `MAX(ABS(value))` or `MAX(value)` within the result set. There are also safeguards against division by zero and negative values in percentage calculations.
*   **`mblwiseCondition`**: This object is used to dynamically adjust `SELECT`, `WHERE`, and `GROUP BY` clauses for queries that need to differentiate between container-level (`contno`) and master bill of lading-level (`mblno`) aggregation.
*   **Autosearch Query Evolution**: The `customerAutosearchOptions.ts` file shows a clear evolution of the customer search logic, moving from simple `DISTINCT` queries on `mtr_tracking_data` or `agent_po_account_master` to more complex scenarios involving `Account_Master_Customer_MAP` and `PO_AccountMaster_Customer_Master` to include mapped customer names in search results, often involving PostgreSQL array functions like `unnest` and `array_cat`. The frequent commenting and re-implementing of logic suggest an iterative development process or difficulty in finding the optimal query for mapped customer search.