# Activity Summary for 1/13/2026

## 2:06:50 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts` underwent significant refactoring and enhancement, with the latest update occurring on **1/13/2026, 1:06:31 PM**.

The core functionality revolves around the `getAllCustomerOptions` function, which retrieves customer or agent options based on the `role` query parameter, now supporting a `search` filter.

Key changes include:

*   **Introduction of Search Functionality:** A `search` query parameter has been added, and the database queries for both `AGENT` and `CUSTOMER` roles now incorporate `ILIKE` clauses to filter results based on this search term.
*   **AGENT Role Updates:** The SQL query for the `AGENT` role (`agent_po_account_master` table) was updated to include the `cname ILIKE` search filter.
*   **CUSTOMER Role Refactoring:**
    *   The data source for the `CUSTOMER` role has shifted from `mtr_tracking_data` to a new table, `PO_AccountMaster_Customer_Master`.
    *   The logic for `CUSTOMER` role is now more complex, designed to retrieve a `customer_name` and a `customer_array`. This `customer_array` combines the primary customer name (`p.cname`) with other mapped customers from `p.customer_map`.
    *   A `NOT EXISTS` clause has been introduced to filter out customers whose `cname` is already listed within another customer's `customer_map`, suggesting an effort to manage hierarchical or linked customer accounts and prevent duplicates in the primary list.
    *   The pagination logic that was present in earlier commented-out `CUSTOMER` role implementations has been removed from the active `CUSTOMER` role code.
    *   The data mapping for `CUSTOMER` results now explicitly handles parsing the `customer_array` which might be returned as a string or array, ensuring the `value` property contains an array of mapped customers.
*   **Code Evolution Indication:** Extensive commented-out code blocks suggest an iterative development process, with multiple previous approaches (e.g., different pagination strategies, different table usages for `CUSTOMER` role) being explored before settling on the current implementation.
*   **Error Handling:** The function includes robust error handling, logging errors using `logger.error` and returning a `500 Internal server error` response.

**Patterns/Recurring Elements:**

*   Consistent use of the `@src/common/util/database` `query` function for all database interactions.
*   Standardized response format returning JSON objects with a `data` array, and in some cases, `total` for pagination (though pagination is no longer active for the `CUSTOMER` role).
*   Frequent mapping of SQL query results to an array of objects with `label` and `value` properties, suitable for dropdowns or selection components in a front-end application.
*   The `LIMIT 10` clause is commonly applied across different role queries when not handling pagination, indicating a default fetch size.

## 3:06:57 PM
The provided log details recent changes across three backend service files, primarily focusing on data retrieval and query construction for analytics.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\customerAutosearchOptions.ts`**

*   **Timestamp: 1/13/2026, 1:06:31 PM**
    *   The `getAllCustomerOptions` function was significantly updated.
    *   For the "AGENT" role, the query was modified to include a search filter (`cname ILIKE '%' || $1 || '%'`).
    *   For the "CUSTOMER" role, the entire query logic was rewritten. It now fetches customer names and their mapped customers from `PO_AccountMaster_Customer_Master`.
        *   The new query selects `cname` as `customer_name` and constructs an `ARRAY` called `customer_array` which includes the `cname` itself and any values from the `customer_map` column.
        *   It filters by `cname ILIKE` for search functionality and includes a `NOT EXISTS` clause to prevent customers from appearing if their `cname` is already part of another customer's `customer_map`.
        *   The response data mapping extracts `label` from `customer_name` and `value` from the `customer_array`, handling string-to-array parsing.
    *   Numerous previous implementations for both AGENT and CUSTOMER roles, including pagination logic using `mtr_tracking_data`, were commented out.

*   **Timestamp: 1/13/2026, 2:12:28 PM**
    *   A minor but important refinement was made to the "CUSTOMER" role's SQL query within the `getAllCustomerOptions` function.
    *   The query now includes `SELECT DISTINCT ON (p.cname)` to ensure that each customer name (`p.cname`) appears only once in the results, even if it has multiple mappings, while still aggregating all associated mapped customers into `customer_array`. This likely aims to improve the uniqueness of the primary customer options displayed.
    *   No other substantial changes were made in this update compared to the previous timestamp.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**

*   **Timestamp: 1/13/2026, 2:51:27 PM**
    *   This file introduces a `getMonthValue` helper function to convert month names (e.g., "Jan") or numbers into a numeric month value.
    *   It defines and exports the `bookingQuery` function, which dynamically generates SQL query fragments based on various report names and parameters.
    *   The file contains a large object mapping specific `reportName` strings to corresponding SQL `FROM` and `WHERE` clauses.
    *   Common query types include calculations for `day_diff` between different date fields (e.g., "Booking Date to Actual Departure", "Booking Date to POD Arrival").
    *   Queries consistently join `mtr_tracking_data` and `agent_booking_entry` tables on `mblno`.
    *   Date validation (`IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'`) is prevalent.
    *   Several entries are for "Stacked Bar" reports, which include complex `CASE` statements to categorize `day_diff` into predefined week ranges ('Less than 1 week', '1 - 2 weeks', etc.) and conditional `WHERE` clauses based on `displayBy` (month, week, quarter) and `stackedExport` status.

**File: `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**

*   **Timestamp: 1/13/2026, 2:57:29 PM**
    *   This file exports `bookingQueryBuilder`, a function designed for structured query generation based on a `type` parameter and a `customizer` object.
    *   The `customizer` object is dynamically populated with details like `dateRange`, `calType`, `dateColumns`, and `chartType`.
    *   `selectedColumns` are fetched using `getColumnsByCategory` based on `user_id` and `reportName`.
    *   Four main query types are implemented:
        *   `BookingDatetoActualDeparture`: Calculates average day difference between actual departed date and booking date, grouped by `fileno || ',' || contno`, including a percentage of the maximum value. It uses a `DISTINCT ON` clause for uniqueness based on voyage, container number, and container type.
        *   `BookingDatetoActualDepartureMblWise`: Similar to the above, but groups by `fileno || ',' || mblno` and is marked as `mblwise`.
        *   `BookingDatetoActualDepartureStackedBar`: Generates a query for a stacked bar chart. It categorizes the day difference into week ranges and pivots these counts, using `DATE_TRUNC` and `GROUP BY` based on `displayBy` (e.g., month, week). It also uses a `DISTINCT ON` clause for uniqueness similar to `BookingDatetoActualDeparture`.
        *   `BookingDatetoActualDepartureMblWiseStackedBar`: Provides stacked bar chart data specifically for MBL-wise booking differences, again using the `DISTINCT ON` clause for uniqueness.
    *   All queries apply date range filtering using `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.

**Patterns and Recurring Elements:**

*   **Database Interactions:** All files heavily rely on SQL queries, primarily interacting with `mtr_tracking_data` and `agent_booking_entry` tables, often joining them on `mblno`.
*   **Company Filtering:** A common pattern across the booking query files (`export.query.ts` and `booking.query.ts`) is the use of `LOWER(account_name) IN (${companyList})` for filtering data by company.
*   **Date Handling and Validation:** Consistent checks for non-null and valid date values (e.g., `!= '0001-01-01 00:00:00 BC'`) are present. Date functions like `EXTRACT(DAY FROM ...)`, `EXTRACT(MONTH FROM ...)`, and `DATE_TRUNC` are frequently used for calculations and grouping.
*   **Role-Based Logic:** The `customerAutosearchOptions.ts` file clearly segregates data retrieval logic based on user roles ("AGENT" vs. "CUSTOMER").
*   **Search and Pagination:** `customerAutosearchOptions.ts` incorporates `search` parameters for filtering and `page`/`perPage`/`offset` for pagination control.
*   **Stacked Bar Chart Logic:** Both `export.query.ts` and `booking.query.ts` implement similar logic for categorizing day differences into week-based ranges (e.g., 'Less than 1 week', '1 - 2 weeks') for stacked bar visualizations.
*   **Modularity and Utility Functions:** The use of `@src/common/util/database`, `@src/common/util/logger`, and custom utility functions like `getColumnsByCategory` and `getFilterQueryByDisplayValue` indicates a modular approach to backend development.
*   **Query Generation Approaches:** There appear to be two different, yet related, approaches to generating booking queries (`export.query.ts` uses a direct report-name-to-SQL mapping, while `booking.query.ts` employs a more programmatic `bookingQueryBuilder` with a `customizer` object), potentially indicating different use cases or an ongoing refactoring effort.
*   **`DISTINCT ON` Usage:** The `customerAutosearchOptions.ts` file and some queries in `booking.query.ts` utilize `DISTINCT ON` clauses, suggesting a focus on ensuring uniqueness of results based on specific columns while still retrieving associated data.