# Activity Summary for 1/16/2026

## 2:21:54 PM
The file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\transit.controller.ts` underwent a minor change within a short span on January 15, 2026.

**File-Specific Update:**
The primary change in `transit.controller.ts` is an alteration to a `console.log` statement within the `getTransitReports` asynchronous function.

*   At **1/15/2026, 10:56:41 AM**, the code included `console.log("mainQuery--",mainQuery);`.
*   By **1/15/2026, 10:57:03 AM**, this line was modified to `console.log("mainQuery--@@@@@@",mainQuery);`.

The change solely involves adding "@@@@@@" to the string literal used for logging the `mainQuery` variable, likely for debugging purposes to distinguish different log outputs. No functional logic of the `getTransitReports` controller was altered.

## 2:22:33 PM
The changes log details updates across several files related to analytics and data export functionalities, all occurring on January 15th and 16th, 2026.

**File: `src\common\util\transit.query.ts`**
This file is central to building complex SQL queries for transit analytics reports.
*   **January 15, 10:50:11 AM:** The initial state defines the `transitQueryBuilder` and `queryGenerator` functions. `transitQueryBuilder` handles different report types like "country_of_origin", "ScheduledTransitVsActualTransit", and "ScheduledTransitVsActualTransitMblWise". It dynamically sets `customizer` properties, selects columns using `getColumnsByCategory`, and generates multiple queries (main, estimated, actual) using `queryGenerator`. SQL queries are generated to calculate day differences between various date columns (e.g., `t49_vessel_actualarrived_date - t49_vessel_actualdeparted_date`). The `queryGenerator` constructs elaborate SQL with `WITH` clauses and joins `mtr_tracking_data` with `portmaster` for "country_of_origin" reports, including dynamic conditions based on `mblwiseCondition`. A `companyList` is derived from `CompanyName` to filter by multiple companies.
*   **January 15, 1:54:10 PM:** A temporary change was introduced where multi-company filtering (`IN (${companyList})`) was replaced with single-company filtering (`= '${CompanyName}'`) for "ScheduledTransitVsActualTransit" and "country_of_origin" reports. The `companyList` derivation was also moved, suggesting a potential regression in multi-company support.
*   **January 15, 1:59:44 PM:** This change reverts the previous regression, restoring multi-company filtering by re-introducing the `companyList` parsing and `IN (${companyList})` clause for all relevant queries in both `transitQueryBuilder` and `queryGenerator`.
*   **January 15, 3:33:13 PM - 3:35:39 PM:** Minor logging additions (`console.log("kkkkkkk@@@@",mainQuery);`) for debugging purposes.
*   **January 16, 11:17:41 AM:** The `mblwiseCondition.groupBy` was briefly removed from the `GROUP BY` clause in `queryGenerator` for "country_of_origin" reports.
*   **January 16, 11:18:52 AM:** This change quickly reverts the previous one, adding `mblwiseCondition.groupBy` back to the `GROUP BY` clause.
*   **January 16, 11:21:49 AM:** The `${mblwiseCondition.select}` part was removed from the inner `SELECT` statement of the "country_of_origin" query in `queryGenerator`.
*   **January 16, 11:24:41 AM:** The `${mblwiseCondition.select}` part is restored to the "country_of_origin" query.
*   **January 16, 11:25:57 AM:** A syntax error was introduced in the `queryGenerator` for "country_of_origin" by changing the `GROUP BY` clause to `GROUP BY portmaster.country_name OR ${mblwiseCondition.groupBy}`, which is invalid SQL.
*   **January 16, 11:26:52 AM:** The syntax error in the `GROUP BY` clause is corrected, restoring it to `GROUP BY portmaster.country_name ${mblwiseCondition.groupBy}`.

**File: `src\services\analytics\transitService.ts`**
This file handles API requests for transit reports, acting as an orchestrator.
*   **January 15, 10:52:34 AM:** The initial version defines the `getTransitReports` function, which extracts query parameters, sets default date ranges, retrieves user/company context using `getUserObject`, constructs `mblwiseCondition` (grouping by `mblno` or `voyage`), calls `transitQueryBuilder` to get the SQL query, executes it, and returns the results.
*   **January 15, 1:51:15 PM - 1:52:03 PM:** Brief changes removed the explicit `UserType` import and type assertion for `req.user`, along with minor console logging message adjustments.
*   **January 15, 1:52:30 PM - 1:52:43 PM:** The `UserType` import and type assertion for `req.user` are restored.
*   **January 16, 1:10:32 PM:** No functional changes from the previous timestamp.
*   **January 16, 2:17:42 PM:** A functional change modified the default `mblwiseCondition` when `mblwise` is false. The grouping/distinct strategy for these non-MBL-wise reports changed from `DISTINCT ON (m.voyage)` to `DISTINCT ON (m.contno)`, impacting aggregation by container number instead of voyage.

**File: `src\services\analytics\analyticsExportService.ts`**
This file provides functionality for exporting analytics data.
*   **January 15, 4:55:50 PM:** The initial implementation of `getExportData` handles various export parameters. It fetches user and company data, generates SQL queries conditionally for "booking" or "non-booking" reports by calling `bookingQuery` or `nonBookingQuery`. It includes logic for `mblWiseQuery` based on `mblwise` and specific filtering for MBL-wise TEU reports (marking duplicates with `teu: "-"`). A `replaceColumnHandler` is used to standardize port names, specifically changing "LONG BEACH" to "LOS ANGELES".
*   **January 15, 4:56:31 PM:** A `console.log` statement was added to display the `mainQuery` for non-booking reports.
*   **January 16, 12:52:49 PM - 12:54:08 PM:** Another `console.log` statement was added to display `excelExportData.rows` for non-booking reports.

**File: `src\common\util\export.query.ts`**
This file contains helper functions for generating specific SQL query fragments for the export service.
*   **January 15, 6:18:55 PM:** The `getMonthValue` helper function is defined. The `bookingQuery` function contains a map of report names to complex SQL query fragments. These fragments consistently join `mtr_tracking_data` with `agent_booking_entry` to calculate day differences between booking and departure/arrival dates. They include company filtering (`LOWER(account_name) IN (${companyList})`), null/invalid date checks, and conditional logic for stacked bar reports to filter by month, week, or quarter, as well as by duration groups (e.g., 'Less than 1 week', '1 - 2 weeks').
*   **January 16, 10:53:59 AM - 2:17:49 PM:** No functional code changes were logged for this file during these timestamps, only updates to the modification timestamp.

**Key Patterns and Recurring Elements:**

*   **Date Handling and Filtering:** All analytics queries consistently process `fromDate` and `toDate` parameters, often defaulting to a `defaultDateRange` if not provided. SQL queries systematically include date range filters and checks for `NULL` or invalid date values (`!= '0001-01-01 00:00:00 BC'`) to ensure data integrity and prevent calculation errors.
*   **Multi-Company Support:** The `CompanyName` parameter is consistently processed to support filtering data for multiple companies. This involves splitting the input string by "||", converting to lowercase, trimming, and joining into a comma-separated list suitable for SQL `IN` clauses.
*   **Dynamic SQL Generation:** A primary pattern across all changed files is the dynamic construction of SQL queries based on various runtime parameters, report types, and user preferences. This allows for flexible reporting and data extraction.
*   **Conditional Logic:** Extensive use of conditional statements (e.g., `if/else if`, ternary operators in SQL string templates) to tailor queries and data processing based on report names, `mblwise` flags, and display/grouping options.
*   **Console Logging for Debugging:** Numerous `console.log` statements are present across the files, often with repetitive identifiers (e.g., `"mainQuery--@@@@@@"`, `"mblwiseConditionmblwiseConditionmblwiseCondition"`) indicating ongoing development and debugging efforts.
*   **Data Transformation:** The `analyticsExportService.ts` specifically includes a `replaceColumnHandler` to standardize data, such as mapping "LONG BEACH" to "LOS ANGELES" for consistency in reports.
*   **Report-Specific Query Fragments:** The `export.query.ts` file exemplifies a pattern of defining reusable, parameterized SQL query fragments for various specific report types, particularly for booking data analytics.