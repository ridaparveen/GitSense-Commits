# Activity Summary for 1/8/2026

## 10:23:53 AM
The `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js` file, last modified on 1/8/2026, 10:14:42 AM, defines the core routing and structure of a comprehensive React frontend application.

The file contains an extensive list of imports, indicating a wide range of features and modules. These imports can be broadly categorized into:
*   **Core UI and Theming**: `ThemeProvider`, `mainTheme` from `@mui/material`, `Toaster` for notifications.
*   **Routing and Authentication**: `react-router-dom` components (`Route`, `Routes`), `Layout`, `ProtectedRoute`, `AuthGuard`, `Auth0Login`, `Auth0LogoutHandler`, `HandleAuthCallback`, `RegistrationScreen`. This highlights a sophisticated authentication and authorization system.
*   **User Management**: `UserManagementScreen`, `UserFormScreen`, `NewRegisteredUserScreen`.
*   **Business Process Screens**: A multitude of screens covering various aspects like packing lists (`PackingListScreen`, `PLFormScreen`), service invoices (`ServiceInvoiceScreen`, `ServiceInvoiceFormScreen`), PO and DSO orders (`PoOrderScreen`, `PoOrderFormScreen`, `DsoOrderScreen`), OTM BOL (`OtmBolScreen`, `AddOtmBolScreen`, `EditOtmBolScreen`, `UploadOTMBOL`), commercial invoices (`CIScreen`, `CIFormScreen`), ALC (various `AlcScreen` variants), shipping orders, container reports, and SPR invoices.
*   **Master Data / Code Screens**: `ExpenseCodeScreen`, `DestinationScreen`, `VendorScreen`, `CustomerScreen`, `PartyScreen`, `AgentScreen`, `CityMaster`, `PortmasterScreen`.
*   **Booking and ISF Management**: A complex set of booking-related screens, including extended versions (`BookingDashbaordScreenExtend`, `AgentBookingFormScreenExtend`, `AgentPoFormExtend`), `ISFEntryFormScreen`, `HblEntryFormScreen`, `HblListDetails`, and `ISFDashboardScreen`.
*   **Tracking**: Dedicated screens for FCL, LCL, general shipment tracking, MTR, trucking details, rail, and air tracking.
*   **Dashboards, Analytics, and Reports**: `DashboardScreen`, `AnalyticsScreen`, `ReportSchedulerScreen`, `NewReportScreen`, `EditReportScreen`, `PdfParserScreen`, `Dashboard7501Screen`, `AlcExceptionDashboard`, `AlcDestinationCostRecord`.
*   **Planboards**: `BookingPlanBoardScreen`, `SPRPlanBoardScreen`.
*   **Detention Management**: `LineWiseScreen`, `LineWiseFormScreen`, `CustomerWiseScreen`.
*   **Admin and Settings**: `SettingsScreen`, `BackOfficeAdminTerminal`.

The `App` component organizes these screens using `react-router-dom`'s `Routes`. A key pattern is the extensive use of `ProtectedRoute` alongside `UserRoleEnum` (which includes roles like `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, `ADMIN_V2`). This indicates a strong role-based access control (RBAC) system implemented throughout the application.

Routes are structured with authentication paths (`/`, `/login`, `/logout`, `/callback`, `/register_user`) at the root, generally handled by `AuthGuard` or specific Auth0 components. The main application content resides under the `/app` path, which is also protected by `ProtectedRoute` requiring various user roles.

Many routes follow a consistent pattern for listing/dashboard views and form views (e.g., `feature` and `feature/form`). Several routes are prefixed with "spr/", suggesting a dedicated module or functionality for "SPR" (Special Project Request, or similar). There are also instances of commented-out routes, indicating previous iterations or planned changes.

Overall, the changes in `App.js` reflect the continuous expansion and refinement of a large-scale enterprise application with diverse functionalities, robust access control, and a clear architectural separation of concerns through its extensive routing structure.

## 3:18:16 PM
The changes primarily focus on refining user authentication, search functionalities, and utility functions across the `t360-backend-v2` project.

**File-Specific Updates:**

*   **`src\services\globalSearch.ts` (1/8/2026, 12:20:50 PM & 12:21:18 PM):**
    *   This file handles global search functionality.
    *   The `getGlobalOptions` asynchronous function retrieves tracking data based on a keyword and user-specific conditions.
    *   The SQL query searches `mtr_tracking_data` for `mblno`, `blno`, or `contno` matching the keyword, grouped by `mblno`.
    *   A minor change at 12:21:18 PM added `console.log('req.user', req.user);` for debugging purposes, indicating a potential need to inspect the user object before building conditions.
    *   It uses `buildMtrUserCondition` to apply user-role-based filtering to the search query.

*   **`src\utils\common.ts` (1/8/2026, 12:26:48 PM):**
    *   This file provides a collection of utility functions.
    *   **`buildMtrUserCondition`:** This function was significantly updated. It now constructs SQL `WHERE` clauses based on `user.role` (CUSTOMER, FRONTOFFICE, AGENT, ADMIN_V2).
        *   For `CUSTOMER` role, it specifically handles "ZIGI USA, LLC" with additional conditions on `t49_empty_return_date` and `t49_eta`, otherwise it filters by `account_name`.
        *   `FRONTOFFICE` filters `account_name` by customer names associated with the user's `userid` in `po_accountmaster_customer_master`.
        *   `AGENT` filters `account_name` by customer codes linked to the agent's `companyname` in `PO_AccountMaster_Customer_Master` and `account_master_shipper_MAP`.
        *   `ADMIN_V2` filters by `account_name` matching the user's `companyname`.
    *   **`buildHBLUserCondition`:** Remains for building conditions based on `user.role` for HBL records.
    *   **`getAgentBookingCode`:** A new function was added to generate and manage unique agent booking codes, including database interaction for sequence numbers (`agent_bookingno` table).
    *   **New Utility Functions:** Several new utility functions were introduced:
        *   `sanitizeString`: Handles null, undefined, or "null" string values.
        *   `AppDateFormate`: Formats dates, handles ISO_8601, and filters out invalid date strings.
        *   `formatDate`: Formats dates for display in a long format (e.g., "January 1, 2026").
        *   `timeAgo`: Calculates and returns a human-readable time difference (e.g., "30 minutes ago").

*   **`src\common\util\jwtToken.ts` (1/8/2026, 1:12:29 PM):**
    *   This file manages JWT token creation and verification.
    *   It now explicitly throws an error if `process.env.JWT_SECRET` is not defined, improving error handling.
    *   The `createToken` function creates a JWT with a 10-second expiry.
    *   The `VerifyToken` function verifies a JWT.
    *   A commented-out `TokenPayload` interface suggests an earlier or alternative token structure consideration.

*   **`src\middleware\authMiddleware.ts` (1/8/2026, 1:26:07 PM):**
    *   This middleware authenticates incoming requests.
    *   **Dual Authentication Logic:** It supports two authentication types: `auth0` (external OAuth) and local JWT.
        *   If `req.headers.authtype === 'auth0'`, it verifies the token using `jwks-rsa` for Auth0's public keys, fetches user details from `mtr_user_master` based on the email from the decoded token, and populates `req.user`. It also dynamically adds `location` for `AGENT` and `ADMIN` roles.
        *   Otherwise (local JWT), it uses `VerifyToken` from `jwtToken.ts`, casts the decoded token to `UserType`, and uses an `async` IIFE to call `putLocation` before proceeding.
    *   **`putLocation` function:** A new asynchronous helper function was added to dynamically determine and set the `location` property for `AGENT` (from `agent_po_account_master`) and `ADMIN` (using `companyname`) roles on the user object. This logic was extracted and is used in both Auth0 and local JWT paths for consistency.
    *   Improved error handling with `HttpError` for unauthorized access and session expiration.
    *   Added `logger.error(JSON.stringify(err));` within the Auth0 verification callback for better debugging of Auth0 errors.

**Patterns and Recurring Elements:**

*   **Role-Based Logic:** A strong pattern is the extensive use of `user.role` to determine specific data access, query conditions, and user attribute assignments (e.g., `location`). This indicates a granular permission system.
*   **Database Interaction:** Frequent use of the `query` utility function for PostgreSQL database operations is evident across `globalSearch.ts`, `common.ts`, and `authMiddleware.ts`.
*   **Timestamping:** The consistent use of `moment` and `Date` objects for date and time handling in `common.ts` is notable.
*   **Error Handling and Logging:** `try...catch` blocks are consistently used, accompanied by `logger.error` for capturing and logging errors, and `HttpStatusCodes` for standardizing HTTP responses.
*   **Environment Variables:** Reliance on `process.env` for sensitive configurations like `JWT_SECRET`, `AUTH0_DOMAIN`, and `AUTH0_CLIENT_ID` is a common practice.
*   **User Object Augmentation:** The `req.user` object is dynamically enriched with a `location` property based on the user's role and company information, suggesting that location is a critical piece of user context in the application.
*   **Modularity:** The changes demonstrate good code organization with distinct files for services, utilities, and middleware, promoting reusability and maintainability.

## 3:18:29 PM
The changes log primarily focuses on the `t360-frontend` project, detailing updates to application routing and authentication handling, alongside minor environment variable adjustments.

**File-specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js` (Timestamp: 1/8/2026, 10:14:42 AM)**: This file, central to the application's routing, underwent significant expansion. It now imports and configures a wide array of new screens and components, particularly within the `/app` protected route. Notable additions include:
    *   **Dashboard & Tracking**: `DashboardScreen`, `ShipmentTrackingScreen`, `FCLScreen`, `LCLScreen`, `AddMtrForm`, `GetTruckingDetails`, `RailScreen`, `AirTrackingScreen`.
    *   **Booking & Orders**: `AgentBookingFormScreenExtend`, `BookingDashbaordScreenExtend`, `ISFEntryFormScreen`, `HblEntryFormScreen`, `HblListDetails`, `ISFDashboardScreen`, `PoOrderFormScreen`, `AgentPoFormScreen`, `AgentPoFormExtend`, `CngBookingScreen`, `CngBookingFormScreen`, `CngBookingScreenExtend`.
    *   **Invoicing & Financial**: `ServiceInvoiceFormScreen`, `CngInvoiceScreen`, `AlcScreen`, `AlcFormScreen`, `AlcGenerated`, `SprAlcScreen`, `SprInvoiceScreen`, `CIScreen`, `CIFormScreen`, `AlcExceptionDashboard`, `AlcDestinationCostRecord`.
    *   **Master Data/Code Management**: `CustomerScreen`, `CustomerFormScreen`, `PartyScreen`, `PartyFormScreen`, `AgentScreen`, `AgentFormScreen`, `ExpenseCodeScreen`, `DestinationScreen`, `VendorScreen`, `CityMaster`, `PortmasterScreen`.
    *   **Reports & Analytics**: `AnalyticsScreen`, `ContainerReportScreen`, `ReportSchedulerScreen`, `NewReportScreen`, `EditReportScreen`, `PdfParserScreen`.
    *   **User & Admin**: `UserManagementScreen`, `UserFormScreen`, `NewRegisteredUserScreen`, `SettingsScreen`, `BackOfficeAdminTerminal`.
    *   **Otm Bol & Packing List**: `OtmBolScreen`, `AddOtmBolScreen`, `EditOtmBolScreen`, `UploadOTMBOL`, `PackingListScreen`, `PLFormScreen`, `BOLFormScreen`, `AddBolConfirmation`.
    *   **Planboard & Detention**: `BookingPlanBoardScreen`, `SPRPlanBoardScreen`, `LineWiseScreen`, `LineWiseFormScreen`, `CustomerWiseScreen`.
    *   **General**: `RegistrationScreen`, `Auth0Login`, `Auth0LogoutHandler`.
    The routing structure also evolved, with a shift from `AgentBookingFormScreen` to `AgentBookingFormScreenExtend` and `BookingDashbaordScreen` to `BookingDashbaordScreenExtend`. Many routes are protected with `ProtectedRoute` and `AuthGuard`, enforcing `UserRoleEnum` for access. A new console log `console.log("ðŸš€ ~ file: App.js:2 ~ TEST on Flow");` was added at the top.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\HandleAuthCallback.js` (Timestamp: 1/8/2026, 10:29:38 AM)**: This file handles the post-authentication callback from Auth0.
    *   It now specifically checks if a user's role is `CUSTOMER` or `ADMIN_V2` and if `v2_flag` is true, redirecting them to a V2 UI base URL with their token.
    *   The redirection logic for successful logins has been refined to prioritize a stored `redirect_url` from `localStorage`, falling back to `/app` if none is found.
    *   The error handling and redirection to `/register_user` also include more specific `cause` states (`'not-registered'`, `'registered'`).
    *   Commented-out error handling logic suggests a past refactoring.
    *   A loading spinner and "Please wait..." message are displayed during authentication verification.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\Providers\AuthGuard.js` (Timestamp: 1/8/2026, 11:24:38 AM)**: This component, responsible for guarding routes, has been updated.
    *   The token expiration check now correctly compares `localUser.expiresIn` (which should be a timestamp) with `new Date().getTime()`.
    *   If a token is expired, it's removed from `localStorage` along with `user` and `selectedAgent`.
    *   The redirection logic after an expired token now attempts to redirect back to the original path (`redirect_url`) if it's not a login or callback path.
    *   If a valid token and user exist and are not expired, the user is always navigated to `/app`.

**Timestamps of Significant Changes:**

The changes occurred on **January 8, 2026**, within a short span:
*   **10:14:42 AM**: Major update to `App.js` routes and component imports.
*   **10:29:38 AM**: Refinement of authentication callback logic in `HandleAuthCallback.js`.
*   **11:24:38 AM**: Updates to the `AuthGuard.js` component, specifically for token expiration and redirection.

**Patterns and Recurring Elements:**

*   **Role-Based Access Control (RBAC)**: A strong pattern is the extensive use of `ProtectedRoute` with `allowedRoles` array, indicating a robust RBAC system across the application. User roles like `ADMIN`, `CUSTOMER`, `AGENT`, `CSF`, `FRONTOFFICE`, `BACKOFFICE`, `SPR_CUSTOMER`, and `ADMIN_V2` are frequently checked.
*   **Auth0 Integration**: The presence of `Auth0Login`, `Auth0LogoutHandler`, `HandleAuthCallback`, and `useAuth0` hook consistently points to Auth0 as the primary authentication provider.
*   **Modular Page Structure**: Many routes follow a `/<feature>/<subfeature>` or `/<feature>/<subfeature>/form` pattern, suggesting a well-organized and modular application structure with dedicated screens for lists and forms.
*   **"Extend" Components**: The introduction of `AgentBookingFormScreenExtend` and `BookingDashbaordScreenExtend` (replacing their non-extended counterparts) implies an iterative development approach where existing functionalities are being enhanced or replaced with newer, possibly more comprehensive versions. `AgentPoFormExtend` also follows this pattern.
*   **Environment-Specific Configuration**: The `.env` file indicates support for `UAT`, `PROD`, and `DEV` environments, managing base URLs and Auth0 configurations.
*   **Redirection Logic**: There's a recurring focus on smart redirection after authentication, either to a stored `redirect_url` or a default application dashboard, and handling redirects to registration for unregistered users.
*   **V2 UI Integration**: A specific logic block in `HandleAuthCallback.js` for `CUSTOMER` or `ADMIN_V2` roles to redirect to a `V2_UI_BASE_URL` suggests a planned or ongoing migration/split to a second version of the UI for certain user types.