# Activity Summary for 1/12/2026

## 2:09:48 PM
The changes log details modifications solely within the `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\modules\JwtToken.ts` file.

**File-Specific Updates (`JwtToken.ts`):**
This file is responsible for creating and verifying JSON Web Tokens (JWTs). It uses `jsonwebtoken` and retrieves the `JWT_SECRET` from environment variables, throwing an error if it's undefined. The `VerifyToken` function remained consistent across all logged changes. The significant updates were exclusively to the `createToken` function, specifically altering the `expiresIn` option for the generated JWTs.

**Timestamps of Significant Changes:**
All modifications occurred on **1/9/2026**, with a final state recorded on **1/12/2026**.
*   **1/9/2026, 12:52:28 PM:** Initial state with `expiresIn: '20s'`.
*   **1/9/2026, 12:56:06 PM - 1:03:55 PM:** A period of rapid adjustments where `expiresIn` was changed from `'20s'` to `20` (a number), then to `10` seconds, and finally reverted back to `'20s'`.
*   **1/9/2026, 1:40:27 PM:** The `expiresIn` value was significantly increased to `'7d'` (7 days).
*   **1/9/2026, 3:36:25 PM - 3:40:25 PM:** A brief revert to `'20s'` was made, quickly followed by another change back to `'7d'`.
*   **1/12/2026, 9:50:20 AM:** The file's state remained stable, retaining `expiresIn: '7d'`.

**Patterns and Recurring Elements:**
The most prominent pattern is the repeated modification and subsequent reversion of the `expiresIn` parameter within the `createToken` function. This suggests an active period of experimentation or decision-making regarding the JWT's validity duration. The values fluctuated between very short durations (10-20 seconds) and a much longer period of 7 days, indicating testing or a debate over appropriate token lifespan. The consistent elements across all changes were the imports, the method of retrieving the `JWT_SECRET`, and the error handling for an undefined secret. The `VerifyToken` function's implementation also remained constant.

## 2:10:30 PM
The provided log details a series of code changes focusing primarily on the frontend of a T360 application, specifically around analytics, global search, and common UI components.

### File-Specific Updates:

*   **`src\components\common\popover-pannel.tsx`**: This component saw several rapid iterations (1/9/2026, 3:19 PM and 5:02 PM, then 1/12/2026, 1:02 PM).
    *   Initially, basic styling like `padding: "10px"` was adjusted.
    *   A significant refactor moved the `styles` object inside the component function and changed `top` positioning to `"calc(100% + 4px)"`, set `zIndex` to `1000`, and added `minWidth`.
    *   Later, it was re-architected to use `createPortal` (1/12/2026, 1:02 PM), requiring an `anchorRef` prop for dynamic positioning relative to its trigger, and setting a higher `zIndex` of `1300` for better overlay management.
*   **`src\components\screen\analytics\DateRange.tsx`**: This file underwent frequent modifications (1/9/2026, 3:23 PM - 3:37 PM).
    *   Updates included adding specific `Moment` type declarations to MUI `DatePicker` components.
    *   Styling adjustments were made to the `DatePicker` components, such as setting `borderRadius: "10px"` for input fields and explicitly coloring the `openPickerButton` icon to black (`#000`).
    *   A critical improvement involved implementing "SAFE parsing" for `fromDate` and `toDate` using `moment(..., true).isValid()` to prevent UI error states from invalid dates (1/9/2026, 3:32:00 PM), and explicitly setting `error: false` on the `textField` slot.
    *   Imports of `Moment` were toggled between standard and `type` imports.
*   **`src\components\core\layout.tsx`**: Changes (1/9/2026, 3:38 PM - 3:42 PM) primarily focused on token expiration logic.
    *   An auto-logout mechanism was introduced, calculating `remainingTime` by subtracting the current time from the token's expiration timestamp (`exp - now`).
    *   Debug `console.log` statements were added to trace token expiration.
    *   Commented-out utility functions for token expiration (`getTokenExp`, `isTokenExpired`) were removed, indicating their relocation to `utils/utils.ts`.
*   **`src\App.tsx` and `src\main.tsx`**: These files show no functional changes in the provided logs, suggesting minor reformatting or whitespace changes at timestamps 1/9/2026, 3:42:02 PM and 1/9/2026, 3:42:13 PM respectively.
*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**: This toolbar for analytics dashboards saw changes (1/9/2026, 3:43 PM and 1/12/2026, 1:06 PM - 1:14 PM).
    *   It manages global date filters, including toggling a custom date range picker.
    *   The state variable `showCustomDateRange` was initially used, then `showGlobalDateRange` was introduced, then removed, and then reintroduced along with `globalAnchorRef` for the global date filter's `PopoverPanel` positioning. This indicates a refinement in how popovers for global filters are managed.
    *   PDF export functionality for dashboards using `jspdf` and `html2canvas-pro` is present, including dynamic logo integration.
*   **`src\components\screen\analytics\metricBox.tsx`**: This component for individual metric cards (1/9/2026, 3:44 PM) defines how various chart types (Bar, Pie, Line, StackedBar, Gauge) are rendered and integrates `MetricToolbar` and `MetricFooter`. No major functional changes observed in the log snippet for this file itself.
*   **`src\components\screen\analytics\Charts\BarChart.tsx`**: The `BarChart` component (1/9/2026, 3:44 PM) was introduced with ApexCharts, including logic to format data labels dynamically using `applyFormatting`.
*   **`src\utils\utils.ts`**: A `getTokenExp` utility function was added (1/9/2026, 3:45:52 PM) to safely extract the expiration timestamp from a JWT, used by the `Layout` component.
*   **`src\components\screen\analytics\MetricToolbar.tsx`**: This metric-specific toolbar component (1/9/2026, 5:01 PM - 5:12 PM and 1/12/2026, 1:03 PM) also received updates related to date filtering.
    *   It handles local `dateFilter`, `periodFilter`, and `viewByFilter` for individual metrics.
    *   The `zIndex` of the custom date range `Box` was adjusted multiple times.
    *   The layout/styling of the date range filter `Box` was significantly changed then reverted, indicating UI experimentation.
    *   Finally, an `anchorRef` was introduced for positioning its `PopoverPanel` using the portal pattern (1/12/2026, 1:03:24 PM).
*   **`src\components\screen\analytics\Charts\GaugeChart.tsx`**: The `GaugeChart` component (1/9/2026, 5:35 PM - 5:36 PM) was introduced, using ApexCharts to display a radial bar chart with conditional coloring and custom formatter for "Days". The display of `item?.reportName` as the chart title was toggled.
*   **`src\pages\dashboard\dashboard-page.tsx`**: The dashboard page (1/9/2026, 6:20 PM and 1/12/2026, 12:43 PM) had minor changes related to `CompanyName` parameter in API calls (`useFetchShipmentDataQuery` and `useFetchCartDataQuery`), switching between `undefined` and `null`.
*   **`src\components\screen\misc\GlobalSearch.tsx`**: This component (1/9/2026, 6:25 PM - 6:30 PM and 1/12/2026, 12:42 PM - 12:47 PM) was frequently updated.
    *   It supports global search with keyboard shortcuts (Ctrl/Cmd+K) and debounced input.
    *   A primary focus was on correctly passing the `CompanyName` parameter to the `ApiManager.getGlobalOptions` based on the user's role (`ADMIN_V2` vs. other roles) and the `selectedCustomer` state. This parameter underwent multiple revisions, leading to `localUser.role === "ADMIN_V2" ? {CompanyName: companyName} : {CompanyName: ""}` as the final logged state.
    *   Debugging `console.log` statements were added.
*   **`src\services\ApiManager.ts`**: The `getGlobalOptions` method (1/9/2026, 6:27 PM - 6:29 PM) was updated to align with parameter passing for `CompanyName` to `ApiMethods.get`. There were a few back-and-forth changes on whether `CompanyName` should be part of the URL query string or a `params` object in the API call.
*   **`src\services\Endpoints.ts`**: The `GET_GLOBAL_OPTIONS` endpoint definition (1/9/2026, 6:28 PM - 6:31 PM) was modified multiple times to accurately include the `CompanyName` in the URL query string, finally settling on `&CompanyName=${CompanyName.CompanyName}`.
*   **`src\services\ApiMethods.ts`**: This file (1/9/2026, 6:29 PM) defines the base URL (`import.meta.env.VITE_API_BASE_URL`) and `getAppHeaders` (including Authorization from `localStorage`). It provides generic HTTP methods, but no direct keys are stored within the provided log content.
*   **`src\components\screen\analytics\analyticsContainer.tsx`**: The core analytics container (1/12/2026, 10:46 AM - 12:21 PM) manages the drag-and-drop and resizing of metrics.
    *   It uses `react-dnd` for grid item reordering (`moveItem`) and resizing (`saveSize`).
    *   Backend mutations (`useSaveSequenceMutation`, `useSaveMetricSizeMutation`) are used to persist layout changes.
    *   Error handling with `toast.success` and `toast.error` for saving operations was refined, with `try...catch` blocks being added and removed around the `saveMetricSize` mutation.
    *   `fetchSingleReport` fetches data for individual metric cards, including `selectedCustomer` and `user.role` in its query parameters.
*   **`src\components\common\chip-tabs-view.tsx`**: This component (1/12/2026, 12:00 PM - 12:52 PM) for displaying scrollable chip tabs underwent numerous styling adjustments.
    *   It includes navigation arrows for scrolling and an optional "New" button.
    *   The main `div` and inner scrollable container `div` saw many changes to their width constraints (`w-full`, `max-w-[1150px]`, `min-w-full`, `min-w-[Xpx]`) and `gap` between chips, indicating fine-tuning of responsive layout and spacing.

### Patterns and Recurring Elements:

*   **Analytics Feature Development**: A substantial portion of the changes revolves around enhancing and stabilizing the analytics dashboard, including date range filtering, chart rendering, and metric layout management.
*   **UI/UX Refinements**: Frequent adjustments to component styling (e.g., `borderRadius`, `zIndex`, `gap`, `width` properties) suggest an ongoing effort to perfect the visual appearance and user experience, especially for date pickers and tab views.
*   **State Management with Redux**: The consistent use of `react-redux` (`useSelector`, `useDispatch`) across `Layout`, `AnalyticsToolbar`, `MetricToolbar`, `GlobalSearch`, and `AnalyticsContainer` indicates a robust Redux-based state management strategy for global and local application states.
*   **API Interaction and Error Handling**: Multiple components interact with API services, and there's a recurring pattern of using `useLazyFetchReportQuery`, `useSaveSequenceMutation`, `useSaveMetricSizeMutation` from Redux Toolkit Query, coupled with `toast` notifications for user feedback and `try...catch` blocks for error handling.
*   **Date and Time Handling**: `moment.js` is extensively used for date formatting, parsing, and calculations, especially in `DateRange.tsx` and `utils.ts`, demonstrating careful management of date logic.
*   **Debugging Practices**: The presence of numerous `console.log` statements throughout the code suggests an active development phase where debugging is a crucial part of the workflow.
*   **Component Architecture**: The application consistently uses a component-based architecture, breaking down complex features into smaller, reusable components like `PopoverPanel`, `DateRange`, `ChipsTabView`, `MetricToolbar`, etc.
*   **Dynamic Filtering/Parameters**: There's a recurring theme of passing dynamic parameters (like `selectedCustomer`, `user.role`, `dateFilter`) to backend API calls to ensure data is filtered appropriately based on user context and selections.
*   **Rapid Iteration**: Many files exhibit multiple changes within a short time frame, especially for UI elements and API integration logic, indicating an agile development process with quick iterative improvements.

## 2:11:24 PM
The provided code change log details a period of active development focusing on user authentication, token management, dynamic SQL query generation for reporting, and general utility enhancements.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\jwtToken.ts`**
    *   **1/9/2026, 11:03:22 AM - 4:43:19 PM:** This file saw significant churn. The `createToken` function repeatedly toggled between returning a simple `string` token and an `object` `{ token, exp }`. The token expiration (`expiresIn`) was also frequently adjusted, fluctuating between `10s`, `20s`, `50s`, and `7d`. Debugging `console.log` statements were added and later removed (1/9/2026, 3:47:26 PM). The final state in this log for `createToken` is to return `{ token, exp }` with an expiration of `"7d"`, without `console.log` statements.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   **1/9/2026, 11:07:11 AM - 3:48:31 PM:** The `login` function's interaction with `createToken` was modified multiple times. It initially expected `createToken` to return a `string` token, then was updated (1/9/2026, 11:14:58 AM) to destructure `token` and `exp` from `createToken`'s return value and include `exp` in the response, along with more robust error handling. This change was then reverted and re-applied, indicating a period of decision-making or testing regarding the token structure passed to the frontend. A `console.log` for login requests was temporarily added (1/9/2026, 11:32:52 AM) and removed (1/9/2026, 11:41:05 AM).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\middleware\authMiddleware.ts`**
    *   **1/9/2026, 11:26:04 AM:** The `authMiddleware` was updated to support both Auth0 and local JWT authentication. For local JWTs, it introduced an asynchronous `putLocation` function to enrich the `req.user` object with `location` data based on the user's role (Agent or Admin) and company.
    *   **1/9/2026, 3:47:49 PM:** Error handling in the middleware's `catch` block was refined, removing a specific `console.error` and simplifying the error propagation to the next middleware.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\globalSearch.ts`**
    *   **1/9/2026, 3:48:13 PM:** The `getGlobalOptions` function was introduced, enabling global searches across `mblno`, `blno`, and `contno` in `mtr_tracking_data`, with user-specific filtering via `buildMtrUserCondition`.
    *   **1/12/2026, 10:06:15 AM - 1:19:15 PM:** Significant changes were made to how `CompanyName` is handled. An optional `companyNameFilter` was added (1/12/2026, 10:06:15 AM). Later, the logic was refined to dynamically construct a `CompanyName` object or string to pass to `buildMtrUserCondition` based on whether `req.query.CompanyName` was provided, allowing for filtering by multiple company names. A brief bug (setting `role` to a boolean) was introduced and corrected (1/12/2026, 12:30:17 PM, 12:30:53 PM). Debugging `console.log` statements were also added to track the `user` and `CompanyName` objects.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\triggers.ts`**
    *   **1/12/2026, 9:51:16 AM:** This file was introduced, defining functions to trigger scheduled reports (SDT, Daily, Weekly, Monthly). It queries `v2_user_reports` for active schedules, and `schedulerFunc.triggerReport` dynamically builds SQL queries based on report configuration, filters data, sends email reports, saves history, and deactivates non-repetitive reports.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **1/12/2026, 10:08:06 AM:** This file was introduced, containing the `bookingQuery` function. It generates specific SQL query fragments for various booking reports, including logic for stacked bar charts, time-based grouping (month, week, quarter), and filtering by company.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **1/12/2026, 10:07:52 AM:** This file was introduced, defining `bookingQueryBuilder`. This asynchronous function constructs comprehensive SQL queries for booking analytics reports, dynamically selecting columns, setting date ranges, defining calculation types (e.g., average), and handling `mblwise` and `chartType` customizations. It leverages `analytics.ts` utilities for column selection and filter query generation. Many subsequent identical commits throughout the day suggest frequent saves without further code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\common.ts`**
    *   **1/9/2026, 3:49:42 PM:** This file was introduced, providing utility functions like `buildHBLUserCondition` and `buildMtrUserCondition` for building SQL `WHERE` clauses based on user roles and company names. It also includes `getAgentBookingCode` for generating unique booking IDs and various date formatting/comparison utilities.
    *   **1/12/2026, 12:25:14 PM - 12:38:24 PM:** Debugging `console.log`s were added. The `buildMtrUserCondition` function was specifically modified for the `ADMIN_V2` role to correctly interpret `user.CompanyName` as a list of company names for an SQL `IN` clause, aligning with changes in `globalSearch.ts`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **1/12/2026, 11:44:59 AM:** This file was introduced, containing various utility functions for analytics: `defaultDateRange`, `replaceValueInQuery` for dynamic SQL adjustments, `getUserObject` for user data customization, `getFilterQueryByDisplayValue` for generating SQL `GROUP BY` and `ORDER BY` clauses, `getExcelSelectedColumns` for dynamic Excel export column selection, `isValidDate` helper, `dateFilterOnExport` for cleaning/formatting dates in export data, and an `EXCEL_EXPORT_COLUMNS` array. Subsequent commits were identical.

### Patterns and Recurring Elements:

1.  **JWT Token Volatility:** There's a clear pattern of frequent changes to JWT token expiration times (`expiresIn`) and the return structure of the `createToken` function, suggesting ongoing refinement and testing of session management.
2.  **Dynamic SQL Query Construction:** A significant portion of the changes revolves around building dynamic SQL queries. Functions like `buildMtrUserCondition`, `bookingQueryBuilder`, and logic in `globalSearch.ts` demonstrate a concerted effort to create flexible and user-role-aware data retrieval mechanisms for various reports and searches. This includes handling multiple company names for filtering.
3.  **Enhanced Reporting Capabilities:** The introduction of `reports/triggers.ts`, `booking.query.ts`, and `analytics.ts` indicates a major expansion in the application's reporting and analytics features. This involves scheduled reports, customizable report columns, and sophisticated data aggregation for charts and exports.
4.  **Debugging Practices:** The presence and subsequent removal of `console.log` statements in `jwtToken.ts`, `UserService.ts`, `globalSearch.ts`, and `common.ts` suggest active debugging during development. `logger.info` is widely used to track execution flow and query details in various service functions.
5.  **Robust Error Handling:** Improvements to error handling, such as more descriptive `HttpError` messages and simplified `next(error)` calls in middleware, show a focus on application stability and user experience.
6.  **Date Utility Centralization:** Several utility functions for date manipulation, formatting, and validation (`AppDateFormate`, `formatDate`, `timeAgo`, `isValidDate`, `defaultDateRange`) were introduced, indicating the importance of consistent date handling across the application.

## 2:23:24 PM
This log primarily details iterative refinements to a user registration notification system and configuration settings.

**File-Specific Updates:**

**`c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\modules\login-req-notify\nofifyAdmin.js`**

*   **1/12/2026, 1:43:15 PM:** This timestamp represents the initial state for the logged changes in this file. The code handles fetching new user registrations from `mtr_user_registration` table, sending a summary email to all admins (`config.email.all`), updating an `emailcounter` for these users, and then sending a separate "Additional Information Required" email to eligible new users (those with `emailcounter <= 2`). The "Additional Information Required" email was initially hardcoded to be sent to a specific recipient defined in `config.email.userRegistrationApproval.to`.
*   **1/12/2026, 1:43:35 PM:** The recipient logic for the "Additional Information Required" email was updated. Instead of sending to a static address, it was changed to dynamically target the email addresses of the `eligibleUsers` themselves, allowing direct communication with the newly registered users.
*   **1/12/2026, 2:11:32 PM:** A `console.log` statement was added to display the `sendEmailTo` array for debugging purposes.
*   **1/12/2026, 2:13:35 PM:** A `sendUser` variable was introduced to format the full names of eligible users into a comma-separated string, and a `logger.info` statement was added to log this string, likely for better traceability.
*   **1/12/2026, 2:15:20 PM - 1/12/2026, 2:16:09 PM:** These timestamps show minor logging adjustments, specifically changing a `logger.info` to `console.log` for the `sendUser` variable, indicating continued debugging or monitoring.
*   **1/12/2026, 2:16:58 PM - 1/12/2026, 2:17:12 PM:** The `generateUserRegisterApprovalEmailContent` function was modified to accept a `sendUser` parameter, and the calling `notifyAdmin` function was updated to pass this parameter. A `console.log` was added within `generateUserRegisterApprovalEmailContent` to inspect the passed `sendUser` value. At this stage, the email content itself still statically addressed "Dear Rajeev,".
*   **1/12/2026, 2:17:41 PM:** The `generateUserRegisterApprovalEmailContent` function was finally updated to use the `sendUser` parameter dynamically in the email's greeting, changing "Dear Rajeev," to "Dear ${sendUser},". This completed the personalization of the email sent to new users.

**Patterns and Recurring Elements:**

*   **Configuration Adjustments:** Although specific configuration details are not summarized due to the presence of sensitive keys, a recurring pattern across `c:\Users\ridap\OneDrive\Documents\cng-batches\cng-batches\config\config.js` changes involves modifications to file paths (e.g., `googleTokenPath`), suggesting environment setup or path corrections.
*   **Debugging and Logging:** Multiple `console.log` and `logger.info` additions indicate an active debugging or development phase, particularly within the `nofifyAdmin.js` file, to monitor user processing and email dispatch logic.
*   **Email Notification Logic Refinement:** The primary focus of changes in `nofifyAdmin.js` is the enhancement of the new user registration email notification process, moving from static recipients to dynamic, personalized communication with the registered users.
*   **Minor Saves:** Several log entries show identical code content, indicating frequent save operations without functional changes, which is common during active development.

## 3:10:41 PM
The code changes log spans from January 9, 2026, to January 12, 2026, and primarily focuses on authentication, user services, global search functionality, and a new reporting/analytics system within the `t360-backend-v2` project.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\jwtToken.ts`**:
    *   **January 9, 2026, between 11:03 AM and 4:43 PM**: This file undergoes frequent changes related to JWT token creation. The `createToken` function is repeatedly modified, toggling between returning a simple `string` token and an object `{ token, exp }` containing both the token and its expiration. The `expiresIn` duration for tokens is also adjusted multiple times, ranging from '10s', '20s', '50s', to '7d'. `console.log` statements for debugging generated tokens are added and removed. The `VerifyToken` function, responsible for token validation, remains stable throughout these changes. The final state for `createToken` involves returning `{ token, exp }` with a '7d' expiration and removed `console.log`s.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**:
    *   **January 9, 2026, between 11:07 AM and 1:41 PM**: Changes in this file primarily affect the `login` function. It is repeatedly updated to align with the evolving `createToken` function in `jwtToken.ts`, specifically regarding whether it expects a plain string token or an object containing `token` and `exp`. Consequently, the structure of the `login` response JSON changes to include or exclude the `exp` (expiration) field alongside user data. Error handling in the `login` catch block is also refined, switching between `error.status` and `error.status || 500`. A `console.log` for login requests was temporarily added. Other functions like `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings` remain consistently implemented. A `logoutUser` function is present as a stub, indicating planned future development.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\middleware\authMiddleware.ts`**:
    *   **January 9, 2026, between 11:26 AM and 3:47 PM**: This file introduces a robust authentication middleware. It supports two authentication types: 'auth0' (using `jwksRsa` and `jwt.verify`) and custom JWT (using `VerifyToken` from `jwtToken.ts`). The middleware validates tokens, queries user details from `mtr_user_master`, and enriches the `req.user` object with role-specific location information. A significant change at `3:47:49 PM` removes a debug `console.log` for decoded tokens and modifies the general error handling in the `catch` block to pass the raw error to the next middleware instead of a generic "session expired" message.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\globalSearch.ts`**:
    *   **January 9, 2026, between 3:48 PM and 6:35 PM**: The `getGlobalOptions` function is introduced, enabling global search across `mblno`, `blno`, and `contno` in `mtr_tracking_data`, applying user-specific conditions via `buildMtrUserCondition`.
    *   **January 12, 2026, between 10:06 AM and 1:19 PM**: This function sees several iterative refinements focused on handling company-specific filtering. Initially, an optional `companyNameFilter` was introduced. This evolved into a more complex mechanism where `req.query.CompanyName` can override the default user's company in the `buildMtrUserCondition` call. Multiple updates refine the parsing of `req.query.CompanyName` into a SQL-friendly list (`companyList`) and ensure the `role` property is correctly propagated for conditional logic. Debugging `console.log` statements are added and later removed/refined.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\reports\triggers.ts`**:
    *   **January 12, 2026, 9:51 AM**: This file is introduced with comprehensive functionality for triggering scheduled reports (SDT, Daily, Weekly, Monthly). It checks for active schedules, compares scheduled times/days against the current time (considering timezones), dynamically constructs SQL queries based on report columns, fetches and filters report data, sends email reports, saves report history, and deactivates non-repetitive schedules. The code demonstrates a complete and stable implementation of a new reporting feature.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**:
    *   **January 12, 2026, between 10:07 AM and 11:50 AM**: This file introduces the `bookingQueryBuilder` function, which dynamically generates complex SQL queries for various booking-related reports. It supports different report types (e.g., "Booking Date to Actual Departure", "Booking Date to Actual Departure MBL Wise" and their "Stacked Bar" variations), applying filters based on company, date ranges, and display preferences. The implementation, once introduced, remains functionally stable across numerous timestamps, indicating minor saves or reformatting.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**:
    *   **January 12, 2026, between 10:08 AM and 10:52 AM**: This file defines utility functions (`getMonthValue`, `bookingQuery`) specifically for constructing SQL query snippets used in exporting booking report data. The `bookingQuery` function dynamically adds date difference calculations and intricate `WHERE` clause conditions based on the selected report and time aggregation filters (month, week, quarter). The logic appears stable after its initial introduction.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\common.ts`**:
    *   **January 9, 2026, 3:49 PM**: This file contains various utility functions for building SQL conditions (`buildHBLUserCondition`, `buildMtrUserCondition`), generating booking codes (`getAgentBookingCode`), string sanitization, and date/time formatting utilities (`AppDateFormate`, `formatDate`, `timeAgo`).
    *   **January 12, 2026, 12:29 PM**: A significant update occurs in `buildMtrUserCondition` for the `ADMIN_V2` role. The filtering condition changes from `LOWER(account_name) = '${user.companyname.toLowerCase()}'` to `LOWER(account_name) IN(${user?.CompanyName.toLowerCase()})`, allowing `ADMIN_V2` users to filter data across multiple companies.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**:
    *   **January 12, 2026, between 11:44 AM and 11:49 AM**: This file is introduced with a suite of utilities for analytical reporting. It provides functions for generating default date ranges, dynamically constructing SQL query components (grouping, ordering, selecting) based on display preferences (month, week, quarter), selecting columns for Excel exports (with specific logic for certain reports like "BL Release KPI"), and post-processing report data (filtering and formatting dates for export). This represents a new and comprehensive set of functionalities for the analytics module.

**Patterns and Recurring Elements:**

*   **Authentication and Authorization Focus**: A primary theme is the ongoing development and refinement of user authentication (JWT token lifecycle) and authorization mechanisms (role-based access controls influencing SQL query conditions).
*   **Dynamic SQL Generation**: There is a strong pattern across multiple files (`globalSearch.ts`, `reports\triggers.ts`, `booking.query.ts`, `export.query.ts`, `common.ts`, `analytics.ts`) to dynamically construct complex SQL queries. This allows for flexible data retrieval and reporting based on user roles, filters, and report types.
*   **Date and Time Utilities**: Extensive use of helper functions for formatting, validating, and comparing dates and times is observed, particularly in report scheduling and data export preparation.
*   **Debugging and Logging**: Frequent inclusion and removal of `console.log` statements for debugging, alongside consistent use of `logger.info` and `logger.error` for operational logging and error tracking, indicating an active development and testing environment.
*   **Iterative Refinement**: Many files show rapid, small changes (e.g., `jwtToken.ts`, `UserService.ts`, `booking.query.ts`), often involving commenting out previous implementations or slight adjustments to parameters, suggesting an iterative approach to feature development and bug fixing.
*   **New Reporting and Analytics Features**: A significant portion of the changes (in `reports\triggers.ts`, `booking.query.ts`, `export.query.ts`, `analytics.ts`) indicates the introduction and stabilization of a new, complex system for generating, scheduling, and exporting various analytical reports.