# Activity Summary for 1/20/2026

## 2:04:15 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` was logged at two separate timestamps: `1/19/2026, 6:44:58 PM` and `1/19/2026, 7:29:32 PM`.

**File-Specific Updates:**
Upon comparing the code snippets provided for both timestamps, no discernible differences are observed in the content of the `booking.query.ts` file. The file defines a `bookingQueryBuilder` function that dynamically constructs PostgreSQL queries based on various input parameters like `type`, `companyName`, `fromDate`, `toDate`, `displayBy`, `userId`, and `reportName`.

**Timestamps of Significant Changes:**
While two timestamps are recorded, the content provided for each is identical. This suggests that the logged events might represent minor saves or automatic backups without introducing functional code changes in the captured sections, or any actual changes occurred in portions of the file not included in the log snippets.

**Patterns and Recurring Elements:**
The `bookingQueryBuilder` function exhibits several recurring patterns:
*   **Query Customization:** It consistently updates a `customizer` object with settings like `dateRange`, `calType` (e.g., "avg"), `dateColumns` (e.g., "Live Actual Departed Date", "Booking Date"), and `calColumnConfig` which often includes a `day_diff` key.
*   **Company List Processing:** The `CompanyName` input is always split by "||", trimmed, lowercased, and formatted into a comma-separated string of single-quoted values for use in SQL `IN` clauses.
*   **Date Range Filtering:** All queries include date filtering based on `departure_date` within the `fromDate` and `toDate` range.
*   **Data Cleaning:** SQL queries frequently check for `NULL`, empty, or invalid date string values (e.g., `'0001-01-01 00:00:00 BC'`) to ensure valid date calculations.
*   **Day Difference Calculation:** A core calculation across different query types is `EXTRACT(DAY FROM t49_vessel_actualdeparted_date - bookingdate) AS day_diff`, measuring the time difference between booking and actual departure.
*   **Distinct Aggregation:** Subqueries often use `DISTINCT ON (m.voyage, m.contno, CASE WHEN ... END)` or similar logic to aggregate unique combinations of voyage, container, or MBL information.
*   **Query Types:** The function branches based on the `type` parameter, handling variations such as:
    *   `BookingDatetoActualDeparture`: Calculates average day difference per `fileno` and `contno`, returning values and percentages relative to the max value.
    *   `BookingDatetoActualDepartureMblWise`: Similar to the above, but aggregates per `fileno` and `mblno`.
    *   `BookingDatetoActualDepartureStackedBar`: Categorizes the `day_diff` into weekly buckets (Less than 1 week, 1-2 weeks, etc.) and presents them in a stacked bar chart format, grouping by a date truncation (`categories_y`) and `displayBy` filters.
    *   `BookingDatetoActualDepartureMblWiseStackedBar`: Identical to the stacked bar, but for MBL-wise aggregation, similar to its non-stacked MBL-wise counterpart.
*   **Analytics Utility Functions:** The code utilizes external utility functions `getColumnsByCategory` and `getFilterQueryByDisplayValue` to dynamically build parts of the SQL queries and column configurations.