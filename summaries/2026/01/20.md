# Activity Summary for 1/20/2026

## 2:04:15 PM
The file `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` was logged at two separate timestamps: `1/19/2026, 6:44:58 PM` and `1/19/2026, 7:29:32 PM`.

**File-Specific Updates:**
Upon comparing the code snippets provided for both timestamps, no discernible differences are observed in the content of the `booking.query.ts` file. The file defines a `bookingQueryBuilder` function that dynamically constructs PostgreSQL queries based on various input parameters like `type`, `companyName`, `fromDate`, `toDate`, `displayBy`, `userId`, and `reportName`.

**Timestamps of Significant Changes:**
While two timestamps are recorded, the content provided for each is identical. This suggests that the logged events might represent minor saves or automatic backups without introducing functional code changes in the captured sections, or any actual changes occurred in portions of the file not included in the log snippets.

**Patterns and Recurring Elements:**
The `bookingQueryBuilder` function exhibits several recurring patterns:
*   **Query Customization:** It consistently updates a `customizer` object with settings like `dateRange`, `calType` (e.g., "avg"), `dateColumns` (e.g., "Live Actual Departed Date", "Booking Date"), and `calColumnConfig` which often includes a `day_diff` key.
*   **Company List Processing:** The `CompanyName` input is always split by "||", trimmed, lowercased, and formatted into a comma-separated string of single-quoted values for use in SQL `IN` clauses.
*   **Date Range Filtering:** All queries include date filtering based on `departure_date` within the `fromDate` and `toDate` range.
*   **Data Cleaning:** SQL queries frequently check for `NULL`, empty, or invalid date string values (e.g., `'0001-01-01 00:00:00 BC'`) to ensure valid date calculations.
*   **Day Difference Calculation:** A core calculation across different query types is `EXTRACT(DAY FROM t49_vessel_actualdeparted_date - bookingdate) AS day_diff`, measuring the time difference between booking and actual departure.
*   **Distinct Aggregation:** Subqueries often use `DISTINCT ON (m.voyage, m.contno, CASE WHEN ... END)` or similar logic to aggregate unique combinations of voyage, container, or MBL information.
*   **Query Types:** The function branches based on the `type` parameter, handling variations such as:
    *   `BookingDatetoActualDeparture`: Calculates average day difference per `fileno` and `contno`, returning values and percentages relative to the max value.
    *   `BookingDatetoActualDepartureMblWise`: Similar to the above, but aggregates per `fileno` and `mblno`.
    *   `BookingDatetoActualDepartureStackedBar`: Categorizes the `day_diff` into weekly buckets (Less than 1 week, 1-2 weeks, etc.) and presents them in a stacked bar chart format, grouping by a date truncation (`categories_y`) and `displayBy` filters.
    *   `BookingDatetoActualDepartureMblWiseStackedBar`: Identical to the stacked bar, but for MBL-wise aggregation, similar to its non-stacked MBL-wise counterpart.
*   **Analytics Utility Functions:** The code utilizes external utility functions `getColumnsByCategory` and `getFilterQueryByDisplayValue` to dynamically build parts of the SQL queries and column configurations.

## 2:04:26 PM
The provided log details recent development on the T360-V2 frontend, primarily focusing on enhancements to the analytics dashboard functionality.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`** (Timestamp: 1/20/2026, 1:49:22 PM)
    This file, responsible for managing custom analytics views, received significant updates. It now handles the creation, editing, and deletion of custom dashboards, allowing users to define and save specific sets of metrics. Key changes include:
    *   **State Management**: Introduction of `useState` hooks to manage `selectedTab` (Container Wise/MBL Wise), `checkBoxManager` for tracking selected metrics (with a limit of 9), `viewName`, and `alertConfig` for confirmation prompts.
    *   **Redux Integration**: Utilizes `useSelector` to retrieve `selectedCustomer` and `useDispatch` to update the global analytics state, specifically `setRefetchAll` to trigger data reloads and `setDashboard` to select the newly created or updated view.
    *   **API Calls**: Integrates `useFetchDashboardOptionsQuery` to fetch available metrics and `useSaveDasboardMutation` for persistence (POST for new, PUT for edit, DELETE for removal).
    *   **User Experience**: Implements `RadioNav` for tab navigation, `InputBox` for dashboard naming, `PopupAlert` for warnings, and an `AuditViewDrawer` for audit history. Logic for initializing `viewName` and `checkBoxManager` based on the `action` (add/edit) was added.
    *   **Refinement**: A commented-out section for `handleSave` suggests iterative development or testing of the save logic.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`** (Timestamp: 1/20/2026, 1:50:39 PM)
    This toolbar component for the analytics screen received updates to support custom views and enhanced filtering. Key changes include:
    *   **Dashboard Management**: Implemented `ChipsTabView` to display and select custom dashboards, with a "New" button to open the `ViewContainer` for creation. An `IconButton` with `SettingsOutlined` allows managing the currently selected custom view.
    *   **Filtering**: Enhanced date filtering with `RadioNav` for "Local" vs. "Global" filters, and a `SelectBox` for predefined date ranges. A `PopoverPanel` with `DateRange` component now allows for custom date range selection, coupled with a `ClickAwayListener`.
    *   **PDF Export**: A `downloadDashboardPDF` function was added, using `jspdf` and `html2canvas-pro` to export the dashboard content as a PDF, including a loading indicator (`CircularProgress`) and a logo.
    *   **Widget Interaction**: Introduced `RadioNav` to switch between "move" and "resize" operations for dashboard widgets, providing better layout control.
    *   **Drawer Integration**: An `AppDrawer` is used to host the `ViewContainer` for custom view creation/management.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\analytics-slice.ts`** (Timestamp: 1/20/2026, 1:56:23 PM and 1/20/2026, 1:57:02 PM)
    This Redux slice manages the analytics state, and two rapid updates were logged within a minute.
    *   **State Refinement**: The primary change between the two timestamps was in the `initialState` where `selectedDashobard` was changed from `"_Default_"` to `"Default"`. This suggests a quick adjustment to standardize the naming or behavior of the default dashboard.
    *   **New State Properties**: The slice now manages `periodFilter` and `viewBy` arrays, each initialized with 9 elements, indicating support for per-metric period and view-by filters. `refetchAll` boolean state was added to facilitate data re-fetching.
    *   **New Reducers**:
        *   `setRefetchAll`: A reducer to toggle the `refetchAll` state, used to trigger updates across the application.
        *   `setCustomer`: Updates the `selectedCustomer` and resets `selectedDashobard` to "Default" upon customer change.
        *   `setSelectedColumns`: Manages selected columns within a metric's customizer settings.
    *   **Dashboard Logic Enhancement**: The `setDashboard` reducer now explicitly handles "select" and "insert" types. For "insert", it ensures the "Default" dashboard is correctly prioritized and selected when dealing with lists containing `_Default_`.

**Patterns and Recurring Elements:**

*   **Custom View Development**: A major theme is the introduction and refinement of custom analytics view management, spanning across `ViewContainer.tsx` (logic), `AnalyticsToolbar.tsx` (UI entry point), and `analytics-slice.ts` (state management).
*   **Redux-centric State Management**: The application heavily relies on Redux for managing complex states related to analytics, filters, dashboards, and user interactions.
*   **Date Filtering Consistency**: A unified approach to global and local date filtering, including custom ranges, is evident across the toolbar and the Redux slice.
*   **API-driven Data Interaction**: Components frequently interact with backend APIs via RTK Query hooks for data fetching and mutations, ensuring dynamic content.
*   **UI Component Reusability**: Common UI elements like `RadioNav`, `SelectBox`, `Button`, and `AppDrawer` are used consistently for a cohesive user experience.
*   **Rapid Iteration**: The two close timestamps for `analytics-slice.ts` indicate quick adjustments or bug fixes during development.