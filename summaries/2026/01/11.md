# Activity Summary for 1/11/2026

## 4:34:46 PM
The provided log details changes exclusively within the `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\modules\JwtToken.ts` file, which is responsible for creating and verifying JSON Web Tokens (JWTs).

**File-Specific Updates (`JwtToken.ts`):**
The core functionality of this file, including the import of `jsonwebtoken` and `TokenPayload` type, the retrieval of `JWT_SECRET` from environment variables, and the structure of `createToken` and `VerifyToken` functions, remained consistent throughout the logs. Both functions include a critical check to ensure `JWT_SECRET` is defined before proceeding. The `VerifyToken` function, in particular, shows no changes across any of the entries.

The sole area of modification was the `expiresIn` option within the `jwt.sign` method used by the `createToken` function.

**Timestamps of Significant Changes and `expiresIn` Evolution:**

*   **1/9/2026, 12:52:28 PM**: Initial state recorded with `expiresIn: '20s'`.
*   **1/9/2026, 12:56:06 PM**: Changed `expiresIn` to `20` (numeric value).
*   **1/9/2026, 12:56:22 PM**: Further reduced `expiresIn` to `10` (numeric value).
*   **1/9/2026, 1:03:55 PM**: Reverted `expiresIn` back to `'20s'` (string value).
*   **1/9/2026, 1:40:27 PM**: Significantly increased `expiresIn` to `'7d'` (7 days).
*   **1/9/2026, 3:36:25 PM**: Changed `expiresIn` back to `'20s'`.
*   **1/9/2026, 3:40:25 PM**: Changed `expiresIn` back to `'7d'`.

**Patterns and Recurring Elements:**

*   **Consistent JWT Module Structure**: The fundamental design of `JwtToken.ts` for handling token creation and verification, including error handling for an undefined `JWT_SECRET`, remained constant.
*   **`expiresIn` Fluctuation**: There's a clear pattern of frequently adjusting the token expiration time. This repeatedly oscillated between very short durations (e.g., `'20s'`, `20`, `10`) suitable for rapid testing or very short-lived tokens, and a much longer duration (`'7d'`) typically used for session tokens. This suggests active experimentation or refinement of token lifespan settings.
*   **No other functional changes**: Apart from the `expiresIn` parameter, no other part of the `createToken` or `VerifyToken` functions, nor any other line of code in the file, was modified.

## 4:35:13 PM
The code changes primarily revolve around user authentication, token management, and data access functionalities within the `t360-backend-v2` project.

**File-Specific Updates:**

*   **`src\common\util\jwtToken.ts`**: This file, responsible for JWT token creation and verification, saw frequent and iterative changes.
    *   **Timestamp Pattern (e.g., 1/9/2026, 11:03:22 AM to 1:40:42 PM):** The `createToken` function was repeatedly modified to change the token's expiration time (`expiresIn`). Values fluctuated between "20s", "50s", "10s", and a more extended "7d" (7 days), with the "7d" duration appearing to be the last set value.
    *   The structure of the `createToken` function's return value was also toggled. It moved between a simpler version returning just the token `string` and a more complex one returning an object `{ token, exp }` that includes the token and its expiration timestamp. The version returning `{ token, exp }` was the predominant active implementation by the later timestamps.
    *   **1/9/2026, 3:47:26 PM:** `console.log` statements within the `createToken` function were removed, indicating a cleanup of debugging output.

*   **`src\services\UserService.ts`**: This service handles user-related operations like login, preferences, and invitations.
    *   **Timestamp Pattern (e.g., 1/9/2026, 11:07:11 AM to 1:13:01 PM):** The `login` function was repeatedly adjusted to align with the changing return structure of `createToken` in `jwtToken.ts`. It toggled between receiving just the token string and de-structuring `{ token, exp }`, and accordingly, the login response included or excluded the `exp` field within the user data.
    *   **1/9/2026, 11:14:58 AM & 1:13:01 PM:** The `catch` block for `login` was updated to provide more robust error handling, specifically using `error.status || 500`.
    *   **1/9/2026, 11:32:52 AM:** A `console.log` was temporarily added at the start of the `login` function for debugging purposes, then removed by 11:41:05 AM.
    *   Other functions like `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings` remained largely stable, consistently using parameterized SQL queries and `logger` for information and error handling. The `logoutUser` function appears to be partially implemented across all logs.

*   **`src\middleware\authMiddleware.ts`**: This middleware is responsible for authenticating requests.
    *   **1/9/2026, 11:26:04 AM:** Introduced a dual authentication mechanism supporting both custom JWT (via `VerifyToken`) and Auth0 (using JWKS). It also includes logic to enrich the `req.user` object with `location` based on `UserRole`. Debugging `console.log` and `logger.error` statements were present within the Auth0 verification callback.
    *   **1/9/2026, 3:47:49 PM:** A `console.log` statement for `Decoded Token` within the Auth0 verification callback was removed, alongside a `console.error` in the main `catch` block, streamlining error reporting to use `next(error);`.

*   **`src\services\globalSearch.ts`**: This file provides a global search functionality.
    *   **1/9/2026, 3:48:13 PM:** The `getGlobalOptions` function was present, implementing a search across `mtr_tracking_data` based on user-specific conditions derived from `buildMtrUserCondition`. A `console.log('User in getGlobalOptions:', user);` was added and persisted in subsequent identical commits.
    *   **Timestamp Pattern (e.g., 1/9/2026, 6:31:48 PM to 6:35:49 PM):** Multiple log entries show no functional changes, indicating repeated saves of the same content.

*   **`src\utils\common.ts`**: This file serves as a utility collection.
    *   **1/9/2026, 3:49:42 PM:** Contains helper functions for building dynamic SQL `WHERE` clauses based on user roles (`buildHBLUserCondition`, `buildMtrUserCondition`), generating unique agent booking codes (`getAgentBookingCode`), sanitizing strings, and various date formatting utilities (`AppDateFormate`, `formatDate`, `timeAgo`). This file was stable with no observed changes within the log period.

**Patterns and Recurring Elements:**

*   **JWT Expiry Fluctuation and Consistency:** The `expiresIn` property for JWT tokens in `jwtToken.ts` was a recurring point of modification, suggesting fine-tuning or testing of session lengths.
*   **Debugging with `console.log`:** `console.log` statements were frequently added and subsequently removed in `jwtToken.ts`, `UserService.ts`, and `authMiddleware.ts`, indicating active debugging cycles.
*   **Robust Logging:** The use of `logger.info` and `logger.error` is consistent across all major service and middleware files, showing a strong emphasis on operational logging.
*   **Database Interaction:** All services (e.g., `UserService.ts`, `globalSearch.ts`) frequently interact with the database using a common `query` utility, with SQL queries often constructed dynamically or using parameterized inputs.
*   **Role-Based Access Logic:** User roles (ADMIN, CUSTOMER, AGENT) are central to constructing dynamic SQL conditions in `common.ts` and `globalSearch.ts`, and for applying specific logic in `authMiddleware.ts` to enrich user objects.
*   **Error Handling Consistency:** The use of `HttpError` and `HttpStatusCodes` for standardized error responses is prevalent across `UserService.ts` and `authMiddleware.ts`.