# Activity Summary for 1/19/2026

## 1:39:44 PM
Between January 18, 2026, and January 19, 2026, the codebase underwent significant changes primarily focused on analytics services and their associated query builders and utility functions.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\kgsService.ts`**
    *   **Early Changes (1/18, 12:31 PM - 12:33 PM):** Initial implementation of `getKGSReports` for calculating total KGS and percentages, grouped by various columns or country of origin/discharge. Minor fixes included removing a redundant `AND` in a `WHERE` clause and adding `COALESCE(..., 0)` to `SUM` functions to prevent `NULL` results for empty groups.
    *   **Mid-Day Refinements (1/18, 3:12 PM - 7:40 PM):**
        *   Expanded the `ignore` list for `getColumnsByCategory` to include a wide array of date, charge, and status-related fields (e.g., `ar_charge`, `inv_date`, `booking_status`, various rail and vessel dates, `tmc_category`). This indicates an effort to streamline selected columns and potentially reduce data exposure.
        *   Corrected a SQL alias in the `country_of_origin`/`country_of_discharge` query path, changing `TRIM(foo.kgs)` to `TRIM(kgs)`.
    *   **Major Refactor Attempts and Reversions (1/18, 8:12 PM - 1/19, 11:08 AM):**
        *   A significant refactor was attempted at **1/18, 8:12:30 PM** to introduce more flexible date range handling (allowing "all" for no date filter) and an improved SQL query structure using multiple Common Table Expressions (CTEs) (`filtered_data`, `aggregated_data`, `stats`) for clearer logic, especially for calculating total sum and percentages while preventing division by zero. The `totalAmount` was also extracted and sent to the frontend.
        *   This refactor was then partially or fully reverted in subsequent commits (**1/18, 8:14:31 PM**, **8:21:21 PM**, and **1/19, 11:08:35 AM**), returning to the original, less complex query structure and date handling (`if (!fromDate || !toDate)`).
        *   A consolidated re-implementation of the CTE-based refactor (similar to 8:12:30 PM) occurred at **1/18, 8:23:05 PM**, suggesting a back-and-forth iteration on this optimization. This version accurately passes `totalAmount` to the frontend.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\chasis.query.ts`**
    *   **Early Implementation (1/18, 1:13 PM):** Introduced `chassisQueryBuilder` to generate SQL for chassis-related analytics (average usage days, pickup vs. delivery dates).
    *   **Refinements (1/18, 2:32 PM - 3:10 PM):**
        *   Improved date difference calculations using `COALESCE` and explicit casting to `INT`.
        *   Enhanced WHERE clauses for container outgate dates to check both `t49_contno_out_gated` and `contno_out_gated`.
        *   Significantly expanded the `ignore` list for `getColumnsByCategory` in all chassis report types to omit numerous date, charge, and status-related fields, similar to `kgsService`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\analyticsExportService.ts`**
    *   **Initial Implementation (1/18, 2:43 PM):** `getExportData` was introduced to handle exporting data for both booking and non-booking reports. It dynamically builds SQL queries, processes data, applies date filters, and replaces specific column values (e.g., "LONG BEACH" to "LOS ANGELES"). It also includes logic for MBL-wise TEU filtering.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Initial Implementation (1/18, 2:43 PM):** This utility file was created or significantly updated to centralize analytics-related helpers. Key functions include `defaultDateRange`, `replaceValueInQuery` (for port name normalization), `getUserObject` (for user-specific company data), `getFilterQueryByDisplayValue` (for dynamic date grouping in SQL), `getExcelSelectedColumns` (for export column selection), `isValidDate`, `dateFilterOnExport` (for cleaning/formatting date values in results), and `EXCEL_EXPORT_COLUMNS` (a static list of export columns).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Initial Implementation (1/18, 2:50 PM):** Introduced `getMonthValue` and `bookingQuery`. The `bookingQuery` function is a dispatcher for generating complex SQL snippets for various booking reports, including stacked bar versions. It includes logic for dynamic date range filtering (`stackedExport` conditions) and date difference calculations. This file appears stable throughout the log, with no functional changes in subsequent entries.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\cbmService.ts`**
    *   **Initial Implementation (1/18, 3:11 PM):** `getCBMReports` was introduced to calculate total CBM and percentages. It expanded the `ignore` list for `getColumnsByCategory` with many date and charge-related fields, mirroring changes in other services. It refactored SQL queries to use CTEs for aggregation and percentage calculation, also updating `mblwiseCondition` aliases.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts`**
    *   **Initial Implementation (1/18, 3:15 PM):** Introduced `transitQueryBuilder` for transit time reports (scheduled vs. actual). It significantly expanded the `ignore` list for `getColumnsByCategory` (similar to other services) and implemented specific logic for `country_of_origin` and `port_pair` reports, fetching various transit time metrics (estimated, actual, estimated-actual).

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts`**
    *   **Initial Implementation (1/18, 3:21 PM):** `getTEUReports` was introduced to calculate TEU values and percentages. It also expanded the `ignore` list for `getColumnsByCategory` and incorporated logic for handling `country_of_origin`/`country_of_discharge` via `portmaster` joins. SQL queries were structured with CTEs for calculating `total_volume` from container types and `TEU` (dividing by 20), including handling `NULL`/empty column values by assigning 'OTHERS' or replacing 'LONG BEACH' with 'LOS ANGELES'.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Initial Implementation (1/18, 3:28 PM):** Introduced `bookingQueryBuilder` to construct queries for various booking reports, focusing on the difference between booking date and actual/estimated departure/arrival dates. Similar to other services, it extensively modified the `ignore` list for `getColumnsByCategory`. The queries use CTEs for calculating day differences and grouping data for stacked bar charts. This file appears stable throughout the log, with no functional changes in subsequent entries.

**Patterns and Recurring Elements:**

1.  **Date Range Standardization:** A `defaultDateRange` utility function is used across services. There was an evolving approach to handling "all" date ranges in `kgsService.ts`, indicating a focus on flexible date filtering.
2.  **SQL Query Refinement with CTEs:** A prominent pattern is the refactoring of complex SQL queries using Common Table Expressions (`WITH ... AS (...)`) across multiple services (`kgsService`, `chasis.query`, `cbmService`, `teuService`). This improves readability, maintainability, and efficiency of multi-step aggregations and calculations (e.g., total sums, percentages, date differences).
3.  **Robust Data Handling in SQL:** Frequent use of `COALESCE` and `NULLIF(TRIM(...), '')` in SQL queries to gracefully handle `NULL` values or empty strings, especially when casting to numeric types or performing arithmetic operations, preventing errors and ensuring meaningful `0` values where appropriate.
4.  **Column Management and Security (`getColumnsByCategory`):** Almost every analytics service or query builder (`kgsService`, `chasis.query`, `cbmService`, `teuService`, `transit.query`, `booking.query`) has an expanded `ignore` list within calls to `getColumnsByCategory`. This consistent update across files suggests a systemic effort to restrict the columns fetched for various analytics reports, likely driven by data privacy, security, or performance concerns. The ignored fields generally include sensitive financial (`ar_charge`, `inv_date`, `charge_code`), specific operational dates, and internal classification fields (`tmc_category`).
5.  **Port Name Normalization:** The `replaceValueInQuery` utility is consistently applied to normalize port names (e.g., "LONG BEACH" to "LOS ANGELES") within generated SQL, ensuring consistency in reporting.
6.  **Percentage Calculation Logic:** A common approach for calculating percentages is observed: `ROUND((value * 100 / max_value), 2)` or `ROUND((ABS(value) / max_value) * 100)::numeric, 2)`, often wrapped in `CASE WHEN max_val > 0 THEN ... ELSE 0 END` to prevent division by zero errors.
7.  **Company-Specific Data Filtering:** All reports consistently filter data using `LOWER(account_name) IN (${companyList})`, indicating a multi-tenant or multi-company analytics system where data is segregated by company.
8.  **MBL-wise vs. Container-wise Reports:** Many services include logic to toggle between Master Bill of Lading (MBL)-wise and container-wise aggregations based on the `mblwise` parameter.
9.  **Error Logging:** All service functions incorporate `try...catch` blocks with `logger.error` to capture and log errors, returning a `500 Internal Server Error` on failure, enhancing application stability and debugging.
10. **Centralized Analytics Utilities:** The creation and expansion of `src\utils\analytics.ts` and various `src\common\util\*.query.ts` files signify a move towards centralizing common logic for analytics reports, improving code reusability and consistency.

## 2:39:07 PM
The changes logged primarily concern a single file: `c:\Users\ridap\Documents\Office\cng-batches\cng-batches\customer_master\customerMaster.js`. This file contains a Node.js class `MigrateAccountNames` responsible for migrating customer data into the `PO_AccountMaster_Customer_Master` table using a `migrate` asynchronous method. All significant updates occurred on **1/18/2026**.

**File-Specific Updates (`customerMaster.js`):**

*   **1/18/2026, 12:43:07 PM**: The core SQL `INSERT ... ON CONFLICT` statement was introduced. Initially, it included a `NOT EXISTS` clause to prevent inserting records where the account name already exists (case-insensitive) and used `ON CONFLICT (acode) DO UPDATE SET cname = EXCLUDED.cname;` to update the customer name if a customer code already existed.
*   **1/18/2026, 12:52:18 PM**: The `NOT EXISTS` clause was removed from the `WHERE` condition. The `ON CONFLICT (acode) DO UPDATE` clause was refined with an additional `WHERE` condition: `WHERE PO_AccountMaster_Customer_Master.cname IS NULL OR PO_AccountMaster_Customer_Master.cname <> EXCLUDED.cname;`. This change ensures that the `cname` is only updated if it's currently `NULL` or if the new `cname` from `mtr_tracking_data` is different from the existing one.
*   **1/18/2026, 12:56:11 PM**: A substantial modification was made to the `SELECT` part of the query. `SELECT DISTINCT` was changed to `SELECT DISTINCT ON (TRIM(customer_code))`, and an `ORDER BY TRIM(customer_code), createddate DESC` clause was added. This indicates a strategy to handle cases where multiple entries might exist for the same `customer_code` in `mtr_tracking_data`. By using `DISTINCT ON` with `ORDER BY createddate DESC`, the system now ensures that for each unique `customer_code`, the `account_name` from the most recent `createddate` entry is chosen for migration or update.
*   **1/18/2026, 12:58:48 PM**: A minor, non-functional change was made to the `console.log` statement, adding a comma after `result.rowCount` in the success message. The core SQL logic remained identical to the previous version.

**Patterns and Recurring Elements:**

*   All changes were focused on improving the data migration logic for customer master data, specifically refining how `account_name` and `customer_code` from `mtr_tracking_data` are handled when inserting into `PO_AccountMaster_Customer_Master`.
*   The primary goal appears to be robustly handling conflicts and updates:
    *   Ensuring `customer_code` uniqueness via `ON CONFLICT (acode)`.
    *   Intelligently updating `cname` only when necessary (`IS NULL` or changed).
    *   Selecting the most relevant `cname` (based on `createddate`) when multiple records exist for the same `acode`.
*   The code consistently uses database transactions (`BEGIN`, `COMMIT`, `ROLLBACK`) for atomicity and error handling, logging messages for successful operations and errors.
*   Each version of the code maintains a commented-out alternative `ON CONFLICT (acode) DO NOTHING;` clause, suggesting ongoing consideration or previous iterations of the conflict resolution strategy.

## 2:39:15 PM
The following summarizes the key changes across the provided code log:

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\kgsService.ts`**
    *   **Timestamp (1/18/2026, 12:31:13 PM - 1/18/2026, 12:33:39 PM):**
        *   Initial implementation and minor adjustments to the `getKGSReports` function. The primary change was in the `country_of_origin` or `country_of_discharge` specific query where `COALESCE(SUM(NULLIF(TRIM(foo.kgs), '')::NUMERIC))` was changed to `COALESCE(SUM(NULLIF(TRIM(foo.kgs), '')::NUMERIC),0)` to explicitly handle null sums as 0. A similar change was applied to the `else` block's query.
    *   **Timestamp (1/18/2026, 3:12:38 PM):**
        *   Significant expansion of the `ignore` list within `getColumnsByCategory` calls for both the default case and the `country_of_origin`/`country_of_discharge` specific logic. Many new date and charge-related columns were added to be ignored (e.g., `ar_charge`, `inv_date`, `booking_status`, `inland_eta`, `trucker`, `lfd_return_empty`, `return_empty_date`, `demurrage_free_date`, `detention_free_date`, `charge_code`, `completed_date`, `rail_ata`, `rail_etd`, `t49_raildeparted_date`, `rail_departed_pod`, `rail_destination`, `live_date_of_rcf`, `live_date_of_dep`, `actual_departure_date`, `ata`, `vessel`, `vessel_actualdeparted_date`, `vessel_actualarrived_date`, `t49_vessel_actualdeparted_date`, `t49_vessel_actualarrived_date`, `tmc_category`).
    *   **Timestamp (1/18/2026, 7:35:46 PM - 1/19/2026, 11:08:35 AM):**
        *   Refinements to SQL queries. Specifically, in the `country_of_origin` or `country_of_discharge` condition, the subquery alias `mtd` inside `FROM ( Select *,pm.country_name AS country_of_origin from ( select ... ) as mtd JOIN portmaster pm ... ) As foo` was restructured. It appears to fix a potential scope issue by moving `mtd.kgs` and `mtd.${columnNameinTable}` selection directly to the inner `mtd` alias.
        *   Added `console.error` logs with specific messages for error debugging.
    *   **Timestamp (1/18/2026, 8:12:30 PM):**
        *   Introduced a new date handling mechanism: `isAllDates` boolean and a dynamic `dateCondition` string. This allows queries to run without date filters if `fromDate` or `toDate` is "all" or missing, otherwise applies the date range.
        *   The calculation of `percentage` was made more robust by adding `CASE WHEN max_val > 0 THEN ... ELSE 0 END` to prevent division by zero errors.
        *   The `customizer` object in the response was updated to explicitly fetch `selectedColumns` again, ensuring it uses the latest `userObj` data.
        *   The `totalAmount` is now extracted from `result.rows[0].total_sum` and sent in the response.
    *   **Timestamp (1/18/2026, 8:20:20 PM - 1/18/2026, 8:23:05 PM):**
        *   Further optimization and refactoring of the SQL queries. The nested subqueries were simplified using CTEs (`filtered_data`, `aggregated_data`, `stats`) to improve readability and potentially performance for calculating totals and percentages. The `max_value` CTE was replaced with `stats` CTE which calculates both `total_sum` and `max_val`. The response structure now explicitly includes `totalAmount`.
        *   The `must` array in `getColumnsByCategory` for the `customizer` object was dynamically updated to include `country_name` only when `columnName` is `country_of_origin` or `country_of_discharge`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\chasis.query.ts`**
    *   **Timestamp (1/18/2026, 1:13:14 PM - 1/18/2026, 2:32:50 PM):**
        *   In the `ChassisPUdateVsFinalDeliveryDate` query, the calculation of `day_diff` was modified from `SUM((delivery_customer_date - final_contno_out_gated))` to `SUM((day_diff))`. The `day_diff` itself was changed to `( DATE( COALESCE(t49_contno_out_gated, contno_out_gated)) - DATE(delivery_customer_date) ) AS day_diff`. This also introduced `COALESCE` to handle potentially null `t49_contno_out_gated`.
    *   **Timestamp (1/18/2026, 2:38:40 PM):**
        *   Correction in the `day_diff` calculation for `ChassisPUdateVsFinalDeliveryDate`, changing `( DATE(COALESCE(t49_contno_out_gated, contno_out_gated)) - DATE(delivery_customer_date) )` to `( DATE(delivery_customer_date) - DATE(COALESCE(t49_contno_out_gated, contno_out_gated)) )` to ensure positive differences. `COALESCE(SUM(day_diff), 0)` was also added for the `value`.
    *   **Timestamp (1/18/2026, 2:51:50 PM):**
        *   For the `ChassisPUdateVsFinalDeliveryDate` query, the `day_diff` calculation was further refined to cast the difference to `INT`: `( DATE(delivery_customer_date) - DATE( CASE WHEN t49_contno_out_gated IS NOT NULL THEN t49_contno_out_gated ELSE contno_out_gated END ) )::INT AS day_diff`.
    *   **Timestamp (1/18/2026, 2:54:11 PM):**
        *   The `WHERE` clause for `ChassisPUdateVsFinalDeliveryDate` was modified from `contno_out_gated is not null` to `(t49_contno_out_gated IS NOT NULL OR contno_out_gated IS NOT NULL)` to account for both `t49_contno_out_gated` and `contno_out_gated` being potentially valid pick-up dates.
    *   **Timestamp (1/18/2026, 3:05:02 PM):**
        *   In `ChassisPUdateVsFinalDeliveryDate`, the `day_diff` calculation's `CASE WHEN` statement for `final_contno_out_gated` was replaced by `COALESCE(t49_contno_out_gated, contno_out_gated)`. The actual difference calculation was also simplified to directly use `delivery_customer_date - final_contno_out_gated`.
    *   **Timestamp (1/18/2026, 3:08:46 PM - 1/18/2026, 3:10:44 PM):**
        *   Extended the `ignore` list in `getColumnsByCategory` for `ChassisPUdateVsFinalDeliveryDate` to exclude many more irrelevant columns for this specific report (e.g., `ar_charge`, `inv_date`, `booking_status`, various rail and vessel dates). This was done for both `ChassisPUdateVsFinalDeliveryDate` and `ChassisPUdateVsFinalDeliveryDateMblWise` types. The `day_diff` calculation was reverted to `SUM((delivery_customer_date - final_contno_out_gated))`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\analyticsExportService.ts`**
    *   **Timestamp (1/18/2026, 2:43:25 PM):**
        *   Added a `replaceColumnHandler` function to modify "LONG BEACH" to "LOS ANGELES" in `pod` and `place_of_delivery` columns of the exported data.
    *   **Timestamp (1/19/2026, 1:47:14 PM - 1/19/2026, 1:59:23 PM):**
        *   Introduced `normalizedReportName` to sanitize the report name by replacing multiple spaces with a single space and trimming it before passing it to `bookingQuery` and `saveColumns`. This ensures consistent report name matching.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Timestamp (1/18/2026, 2:43:37 PM):**
        *   The `replaceValueInQuery` function was modified to directly return the column name if it's not `pod` or `place_of_delivery`, instead of returning a `CASE WHEN` statement that effectively does nothing for other columns. This likely simplifies the generated SQL.
        *   The `getExcelSelectedColumns` function was removed. Its logic for constructing `selectedColumns` based on `reportName` and `isBooking` was likely integrated elsewhere or became obsolete.
        *   The `dateFilterOnExport` function was updated with a significantly expanded list of `dateKeys` to validate and format, ensuring a wider range of date columns are handled consistently.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Timestamp (1/18/2026, 2:50:09 PM - 1/19/2026, 2:18:55 PM):**
        *   Numerous small, repetitive updates across this file. The core change in most entries is the removal of the `DISTINCT ON` clause (`mblWiseQuery`) from the `bookingQuery` definitions when `stackedExport` is false. This suggests that the `DISTINCT ON` logic is handled externally (likely in `analyticsExportService.ts`) for non-stacked booking exports, and only conditionally applied within this file for stacked exports to ensure correct grouping.
        *   The `console.log(CompanyName, "companyname in booking query")` statement is present in almost all versions, indicating ongoing debugging.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\cbmService.ts`**
    *   **Timestamp (1/18/2026, 3:11:24 PM):**
        *   Expanded the `ignore` list within `getColumnsByCategory` to match the extended list seen in `kgsService.ts`, adding many date and charge-related columns.
        *   Adjusted `mblwiseCondition` to remove the `mtd.` alias when selecting `mblno` directly and when applying the `groupBy` clause, implying that `mblno` is directly accessible or unique in the context of the outer query.
        *   The SQL query structure was updated to use `aggregated_data` and `max_value` CTEs for `country_of_origin` / `country_of_discharge` reports, similar to the pattern observed in `kgsService.ts`.
        *   A more readable SQL query for the `else` block was introduced, using CTEs `t` and `max_cbm`, also simplifying the `replaceValueInQuery` usage and ensuring correct grouping by `entity`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts`**
    *   **Timestamp (1/18/2026, 3:15:23 PM):**
        *   Added a substantial number of columns to the `ignore` list in `getColumnsByCategory` for all transit report types, mirroring the updates in `kgsService.ts` and `cbmService.ts`.
        *   Implemented a more robust calculation for `ScheduledTransitVsActualTransit` and `ScheduledTransitVsActualTransitMblWise` by using `ROUND(AVG(...)::numeric,0)` to ensure average values are integers and `MAX(ABS(value))` for `max_total` to handle negative differences correctly. The percentage calculation also uses `ABS(t.value)`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp (1/18/2026, 3:28:00 PM - 1/19/2026, 2:21:13 PM):**
        *   Introduced `ignore` lists for `getColumnsByCategory` calls, specifically excluding `tmc_category`, `charge_code`, `ar_charge`, `inv_date` for booking-related queries (`BookingDatetoActualDeparture`, `BookingDatetoActualDepartureMblWise`, `BookingDatetoActualDepartureStackedBar`, `BookingDatetoActualDepartureMblWiseStackedBar`).
        *   No other significant structural changes or new functionalities were introduced across these numerous minor updates; they primarily involve the repeated application of the `ignore` list.

### General Patterns and Recurring Elements:

*   **Date Range Handling:** A consistent pattern of checking `!fromDate || !toDate` and defaulting to `defaultDateRange()` is present across multiple services (`kgsService.ts`, `cbmService.ts`, `analyticsExportService.ts`, `teuService.ts`).
*   **Company List Generation:** The method `CompanyName.split("||").map((v) => `'${v.trim().toLowerCase()}'`).join(",")` is used universally to construct an `IN` clause for filtering by company names.
*   **`getColumnsByCategory` with extensive `ignore` list:** Almost all files show a recurring, lengthy `ignore` array within calls to `getColumnsByCategory`. This suggests a centralized utility function for column selection in reports, where a common set of columns is typically excluded, and this list is frequently expanded.
*   **Dynamic SQL Generation:** SQL queries are dynamically constructed using template literals and conditional logic (e.g., `mblwiseCondition`, `columnName` checks).
*   **Error Handling:** `try...catch` blocks with `logger.error` and `res.status(500).json({ message: "Internal Server Error" })` are consistently used for robust error management.
*   **"Long Beach" to "Los Angeles" Replacement:** The `replaceValueInQuery` utility function and `replaceColumnHandler` are used to standardize port names from "LONG BEACH" to "LOS ANGELES" in various contexts.
*   **`DISTINCT ON` Clause:** The `mblwiseCondition.select` and `mblwiseCondition.condition` frequently involve `DISTINCT ON (mtd.mblno)` or `DISTINCT ON (mtd.voyage, mtd.contno, CASE WHEN mtd.t49_cont_type IS NOT NULL AND TRIM(mtd.t49_cont_type) <> '' AND TRIM(mtd.t49_cont_type) != '0' THEN mtd.t49_cont_type ELSE mtd.cont_type END )` for ensuring unique records based on container or master bill of lading.
*   **CTE Usage for Aggregation:** More recent changes (`kgsService.ts`, `cbmService.ts`) demonstrate a shift towards using Common Table Expressions (CTEs) like `t`, `filtered_data`, `aggregated_data`, and `stats` to structure complex SQL queries for better readability, maintainability, and possibly performance when calculating sums, averages, and percentages.
*   **Debugging Logs:** Frequent `console.log` and `logger.info` statements are present, indicating ongoing development and debugging efforts.
*   **Date comparisons with `'0001-01-01 00:00:00 BC'`:** This specific date string is consistently used in `WHERE` clauses to filter out invalid or default date entries in the database.
*   **Report Name Sanitization:** A new pattern emerged in `analyticsExportService.ts` to `decodeURIComponent` and `replace(/\s+\/-\s+/g, ' +/- ')` on report names, indicating an effort to standardize how report names are processed, especially for parameters passed to query functions.