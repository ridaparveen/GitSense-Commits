# Activity Summary for 1/21/2026

## 1:30:58 PM
In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`:
- **Timestamp: 1/19/2026, 6:44:58 PM and 1/19/2026, 7:29:32 PM**
- This file defines the `bookingQueryBuilder` function, which generates SQL queries for various booking-related analytics reports.
- It includes several interfaces (`CalColumn`, `CalColumnConfig`, `Customizer`, `QueryBuilderI`) to define the structure of configuration and query parameters.
- The function supports different `type` parameters for generating queries, including:
    - `"BookingDatetoActualDeparture"`: Calculates average day difference between booking date and actual departure.
    - `"BookingDatetoActualDepartureMblWise"`: Similar to the above, but grouped by MBL (Master Bill of Lading) number.
    - `"BookingDatetoActualDepartureStackedBar"`: Generates data for a stacked bar chart, categorizing day differences into 'Less than 1 week', '1 - 2 weeks', etc., grouped by `displayBy` (e.g., month, week).
    - `"BookingDatetoActualDepartureMblWiseStackedBar"`: Similar to the stacked bar chart, but MBL wise.
- **Key Logic**: All queries join `mtr_tracking_data` and `agent_booking_entry` tables on `mblno`. They filter by `account_name` (derived from `CompanyName`), `departure_date` range, and ensure non-null/non-default date values.
- **Pattern**: Repeated use of `customizer` object to configure report display properties (e.g., `dateRange`, `calType`, `dateColumns`, `booking`, `mblwise`, `chartType`).
- **Pattern**: Queries frequently calculate day differences between various date columns (e.g., `t49_vessel_actualdeparted_date - bookingdate`).
- **Pattern**: The code snippets for 6:44:58 PM and 7:29:32 PM appear identical, suggesting no functional change was committed between these two timestamps, perhaps a save operation without modification or an incomplete log.

In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\cbmService.ts`:
- **Timestamp: 1/20/2026, 5:28:09 PM and 1/20/2026, 5:28:35 PM**
- This file contains the `getCBMReports` asynchronous function for fetching CBM (Cubic Meter) related analytics reports.
- It retrieves `columnName`, `fromDate`, `toDate`, and `mblwise` from request queries. If dates are missing, it applies a `defaultDateRange`.
- It dynamically constructs SQL queries based on the `columnName` (e.g., `country_of_origin`, `country_of_discharge`, or other columns).
- It determines `mblwiseCondition` to group data by `mblno` or by `voyage`, `contno`, and `t49_cont_type`.
- **Key Logic**: When `columnName` is 'country_of_origin' or 'country_of_discharge', it joins `mtr_tracking_data` with `portmaster` to get `country_name` and sums `cbm` values, calculating percentages against the max value.
- For other `columnName` values, it queries `mtr_tracking_data` directly, aggregates `cbm` by the specified `columnName`, and calculates percentages.
- It uses `getColumnsByCategory` to set `customizer.selectedColumns`, ignoring many date/status/charge-related columns and `must`-including `cbm` and `departure_date`.
- **Pattern**: Both logs for this file appear identical, suggesting no functional change was committed between these timestamps. The `console.log(mainQuery,"test==========");` line was present in the 5:28:35 PM timestamp but not fully in the 5:28:09 PM snippet. This indicates a minor debug `console.log` addition.
- **Pattern**: Extensive list of columns to ignore when fetching selected columns, indicating a focused set of data for CBM reports.

In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`:
- **Timestamp: 1/21/2026, 11:16:16 AM, 1/21/2026, 11:22:42 AM, and 1/21/2026, 1:01:30 PM**
- This file defines the `bookingQuery` function which returns SQL query fragments based on `reportName` for export purposes.
- It includes a `getMonthValue` helper function to convert month names (e.g., 'Jan') or numeric months into integer values.
- **Key Logic**: The `query` object maps report names (e.g., "Booking Date to Actual Departure", "Booking Date to Actual Departure (Stacked Bar)") to specific SQL WHERE clause conditions and `EXTRACT(DAY FROM ...)` calculations.
- For "Stacked Bar" reports, it dynamically adds filtering conditions based on `displayBy` (month, week, quarter) and `stackedGroup` (e.g., 'Less than 1 week').
- All queries join `mtr_tracking_data` and `agent_booking_entry` and filter by `account_name` and non-null/non-default date values.
- **New Condition**: For "Booking Date to POD Arrival (Stacked Bar)", a new filter `AND m.t49_vessel_actualdeparted_date IS NOT NULL` was introduced across all three timestamps. This suggests this addition was made prior to the earliest logged timestamp for this file.
- **Pattern**: Consistent handling of `CompanyName` by splitting and lowercasing for SQL `IN` clause.
- **Pattern**: All three logs for this file appear identical, suggesting no functional change was committed between these timestamps, perhaps a series of saves without modification.

In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\User.ts`:
- **Timestamp: 1/21/2026, 1:02:38 PM**
- This file defines the `UserType` interface and `UserRole` enum.
- The `UserType` interface includes `CompanyName`, `usercode`, `firstname`, `lastname`, `role`, `userid`, `emailid`, `companyname`, and an optional `location`.
- The `UserRole` enum lists various roles: `ADMIN`, `AGENT`, `BACKOFFICE`, `CUSTOMER`, `FRONTOFFICE`, `SALES`, `ADMIN_V2`.
- It uses `jet-validators` for runtime type checking with `parseObject` for `UserType`.
- **Key Changes**: The `CompanyName` property was added to the `UserType` interface. This is a significant addition, suggesting that user objects now explicitly carry information about the company they belong to. `userid` and `emailid` were also added, and `companyname` became explicit.
- The previous comments related to `DEFAULT_USER_VALS` and `IModel` are commented out, suggesting a refactoring or simplification of user object creation/validation.

In `c:\Users\ridap\.dbclient\storage\1747201553765@@127.0.0.1@5432@Rida_Database@public\public.sql`:
- **Timestamp: 1/21/2026, 1:14:04 PM**
- This file contains a log of SQL queries executed, primarily for analytics and database introspection.
- **Key Operations**:
    - `SELECT * FROM dashboards;` and `SELECT * FROM metrics WHERE filter_by = 'Air_Wise';` for database schema exploration.
    - `INSERT INTO metrics ...` to add a new metric "Total Shipments Air Wise" with endpoint `/analytics/Tables/tableData?type=TotalShipmentAirWise`.
    - Various `SELECT` statements for `mtr_tracking_data` and `agent_booking_entry` tables to inspect data for specific companies ('prodoh, llc', 'Prodoh, LLC').
    - Queries for `metrics` table with `name = 'Total Shipments Mbl Wise'` and `batch_data`.
    - Several `WITH t AS (...)` CTE-based queries for calculating average day differences (e.g., `t49_vessel_actualarrived_date - t49_vessel_actualdeparted_date`, `eta_pod - departure_date`) and expressing them as percentages.
    - **Pattern**: Many analytical queries calculate "value" and "percentage" based on aggregated day differences, often applying `DISTINCT ON (m.voyage)` or similar to avoid duplicates within a voyage.
    - **Pattern**: Queries include `WHERE` clauses for `account_name` (e.g., 'twelve inc', 'project footwear', 'sp richards company') and date ranges (e.g., `departure_date >= '2026-01-01'::timestamp`).
    - **Pattern**: Handling for `NULL` and `'0001-01-01 00:00:00 BC'` values in date columns is consistent across many queries.
    - **Pattern**: Queries often filter for `foo.value IS NOT NULL AND foo.value >= -60` and include logic to handle division by zero or negative values in percentage calculation. This suggests robust handling of potential data anomalies.

In `c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`:
- **Timestamp: 1/21/2026, 1:16:07 PM**
- This file provides API endpoints for managing dashboard metrics, including `dashboardEndPointList`, `getMetricList`, `saveSequence`, and `saveSize`.
- `dashboardEndPointList`: Fetches a list of dashboard metrics (report name, URL, row/column span) for a specific user and `menuTitle`, sorted by user-defined sequence. It now explicitly casts `menuTitle` to `null` if undefined and validates `user.usercode`.
- `getMetricList`: Retrieves a categorized list of available metrics ("Container_Wise", "MBL_Wise", "Air_Wise") from the `metrics` table.
- **Key Logic**: `getMetricList` now supports `Air_Wise` metrics, adding a new categorization dimension alongside "Container_Wise" and "MBL_Wise".
- **New Feature**: `preload` functionality allows pre-checking metrics if they are part of an existing dashboard, explicitly casting `dashboard_name` to string.
- `saveSequence`: Saves the order of metrics for a given `menu_title` and `user_id`. It handles a special case for a "Default" dashboard if it doesn't exist.
- `saveSize`: Updates the `rowSpan` and `columnSpan` for a specific metric on a dashboard. It includes validation for required fields and handles `null` existing size data gracefully.
- **Pattern**: All functions interact with `dashboards` and `metrics` tables to manage user-specific dashboard configurations.
- **Pattern**: Consistent use of `logger.info` and `logger.error` for logging.
- **Pattern**: Robust error handling with `try-catch` blocks and 500 status responses for internal server errors.

**Overall Patterns and Key Themes**:

1.  **Analytics and Reporting Focus**: The changes heavily revolve around building and managing analytics reports related to shipping logistics, particularly "Booking Date to Actual Departure" and "CBM" metrics.
2.  **Dynamic SQL Query Generation**: A significant portion of the code is dedicated to dynamically constructing SQL queries based on user selections (e.g., report type, date range, company, group-by columns, MBL-wise vs. container-wise).
3.  **Date-Based Calculations**: A recurring theme is the calculation of day differences between various date fields (`bookingdate`, `departure_date`, `eta_pod`, `t49_vessel_actualdeparted_date`, `t49_vessel_actualarrived_date`).
4.  **Company-Specific Data**: All queries consistently filter data based on `account_name` derived from `CompanyName`, indicating a multi-tenant or client-specific data access model.
5.  **Dashboard Customization**: The `coreMetricService.ts` file shows strong patterns for user customization of dashboards, including ordering of metrics (`saveSequence`) and layout (grid spans via `saveSize`).
6.  **"Air_Wise" Analytics**: A new dimension for analytics, "Air_Wise", was introduced, suggesting an expansion of tracking capabilities beyond sea freight.
7.  **Data Validation and Robustness**: Checks for `NULL` values, `'0001-01-01 00:00:00 BC'` (a common sentinel value for invalid dates), and handling of division by zero or negative values in percentage calculations are present, indicating a focus on data quality and query reliability.
8.  **Minor Debugging/Save Operations**: Several consecutive timestamps for the same file showing identical or nearly identical content (e.g., `booking.query.ts` and `export.query.ts`) suggest frequent save operations or minor local changes that didn't alter the core logic, or incomplete log captures. The addition of `console.log(mainQuery,"test==========");` in `cbmService.ts` is a clear example of a temporary debug line.

## 1:31:03 PM
The recent code changes span across several core areas of the `t360-frontend-v2` project, primarily focusing on analytics features and internal state management.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`**
    *   **1/20/2026, 1:49:22 PM**: This component, responsible for managing custom analytics views, initially supported "Container Wise" and "MBL Wise" tabs for displaying metric options.
    *   **1/21/2026, 12:55:46 PM - 1:18:10 PM**: Throughout these timestamps, the component was updated to include support for an `"airWise"` view. This involved modifying the `selectedTab` state type to include `"airWise"` and updating the `initializeCheckedMetrics` function to iterate over `"airWise"` options in addition to "containerWise" and "mblWise". Conditional rendering logic was also expanded to display a `TreeViewContainer` for the `"airWise"` tab.
    *   **1/21/2026, 1:21:49 PM**: The UI integration was completed by adding `{ label: "AIR Wise", value: "airWise" }` to the `tabData` array, making the new "AIR Wise" tab visible and selectable.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **1/20/2026, 1:50:39 PM**: This component provides the toolbar for analytics dashboards, including date filters, dashboard selection, and PDF export functionality. It initially handled `"_Default_"` for dashboard names.
    *   **1/20/2026, 6:38:27 PM**: A change was introduced to standardize the display of the default dashboard from `"_Default_"` to `"Default"` in the `ChipsTabView` options mapping and the "Manage View" tooltip condition.
    *   **1/20/2026, 6:38:07 PM & 1/21/2026, 1:19:45 PM**: These entries show no functional changes, indicating minor saves or reformatting.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\analytics-slice.ts`**
    *   **1/20/2026, 1:56:23 PM**: The initial state of `selectedDashobard` was `"_Default_"`. The `setDashboard` reducer had logic to handle `"_Default_"` specifically for filtering and setting the selected dashboard.
    *   **1/20/2026, 1:57:02 PM**: The `initialState` for `selectedDashobard` was updated from `"_Default_"` to `"Default"`, beginning the standardization.
    *   **1/20/2026, 6:35:22 PM**: The `setDashboard` reducer's logic for the `insert` type was updated to set `state.selectedDashobard` to `"Default"` when `"_Default_"` was included in the value, further solidifying the "Default" string.
    *   **1/20/2026, 6:36:16 PM - 6:37:08 PM**: A brief revert occurred where `state.selectedDashobard` was set back to `"_Default_"` in the `setDashboard` reducer, followed by entries with no functional changes.
    *   **1/20/2026, 6:39:02 PM**: The `setDashboard` reducer was fully updated to consistently use `"Default"` instead of `"_Default_"`. This change affected both the condition for filtering/inserting the default dashboard and the value assigned to `selectedDashobard`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts`**
    *   **1/20/2026, 6:41:28 PM**: A new constant `AIR_SHIPMENT_STATUS` was added, defining various statuses and their associated colors for air cargo, such as "New", "In Progress", "Booked", "EnRoute", "Landed", "Delivered", and "Untracked".

### Patterns and Recurring Elements:

*   **Standardization of "Default" Dashboard Name**: There's a clear pattern across `AnalyticsToolbar.tsx` and `analytics-slice.ts` to transition the internal and display name of the default dashboard from `"_Default_"` to simply `"Default"`. This ensures consistency in both state management and user interface.
*   **Integration of "Air Wise" Analytics**: Multiple changes in `ViewContainer.tsx` and the addition of `AIR_SHIPMENT_STATUS` in `global.ts` highlight the ongoing development and integration of new "Air Wise" functionalities within the analytics module. This suggests an expansion of the application's capabilities to include air cargo tracking and analysis.
*   **Focused Development Sprints**: The timestamps indicate concentrated efforts on these features, particularly on 1/20/2026 and 1/21/2026, suggesting specific development tasks were addressed within these periods.
*   **Debugging Artifacts**: Frequent `console.log` statements (`console.log("===view,",viewTitle);`, `console.log(selectedTab,"selectedTab=====");`) suggest an active development phase where debugging aids are still present in the code.