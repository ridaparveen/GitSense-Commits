# Activity Summary for 1/3/2026

## 5:06:12 PM
The following summarizes the key changes from the provided code log:

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\App.js`
**Timestamps: 1/2/2026, 2:26:45 PM and 1/2/2026, 2:26:51 PM**
This file, acting as the main routing configuration for the frontend application, underwent extensive updates.
*   **New Route Imports and Definitions:** Numerous new screens and components were imported and added as routes, significantly expanding the application's functionality. Examples include:
    *   Booking-related screens: `AgentBookingFormScreenExtend`, `BookingDashbaordScreenExtend`, `ISFEntryFormScreen`, `HblEntryFormScreen`, `HblListDetails`.
    *   Tracking screens: `FCLScreen`, `LCLScreen`, `AddMtrForm`, `GetTruckingDetails`, `RailScreen`, `AirTrackingScreen`, `ShipmentTrackingScreen`.
    *   Report and Analytics: `AnalyticsScreen`, `ReportSchedulerScreen`, `NewReportScreen`, `EditReportScreen`, `PdfParserScreen`, `ContainerReportScreen`.
    *   Administration and Master Data: `BackOfficeAdminTerminal`, `CityMaster`, `PortmasterScreen`.
    *   Specific business logic screens: `CngInvoiceScreen`, `AlcScreen`, `SprAlcScreen`, `AlcGenerated`, `AlcExceptionDashboard`, `AlcDestinationCostRecord`, `SprInvoiceScreen`, `ISFDashboardScreen`.
    *   Authentication and User Management: `Auth0Login`, `Auth0LogoutHandler`, `RegistrationScreen`, `NewRegisteredUserScreen`, `SettingsScreen`.
    *   "Code" related screens: `CustomerScreen`, `CustomerFormScreen`, `PartyScreen`, `PartyFormScreen`, `AgentScreen`, `AgentFormScreen`.
*   **Role-Based Access Control (RBAC):** The `ProtectedRoute` component is heavily used, defining `allowedRoles` for almost every new and existing route, indicating a strong emphasis on granular access control based on `UserRoleEnum` values (e.g., ADMIN, CUSTOMER, AGENT, CSF, FRONTOFFICE, BACKOFFICE, SPR_CUSTOMER, ADMIN_V2).
*   **Route Structure:** A nested route structure under `/app` is prevalent, with many new sub-routes for features like `booking`, `isf_dashboard`, `analytics`, `admin_master`, `spr`, `settings`, `code`, `planboard`, `detention`, `commercial_invoice`, and `agent_po`.
*   **Auth0 Integration:** Routes for `/login`, `/logout`, and `/callback` confirm the use of Auth0 for authentication.
*   **Commented-Out Routes:** A root path `/` route pointing to `Auth0Login` is commented out, and a `booking/form` route pointing to `AgentBookingFormScreen` is also commented out in favor of `AgentBookingFormScreenExtend`.
*   **Console Log:** A `console.log("ðŸš€ ~ file: App.js:2 ~ TEST on Flow");` statement is present, likely for testing or debugging purposes.

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\pages\booking\AgentBookingConfirmation.jsx`
**Timestamp: 1/2/2026, 2:59:06 PM**
This file handles the agent booking confirmation process.
*   **Responsive UI:** Implements `useMediaQuery` from `@mui/material` to adjust the `pageSize` of grids based on screen size (XS, SM, MD, LG).
*   **Formik Integration:** Uses `useFormik` for form management and validation, with a `bookingConfirmationValidation` schema.
*   **State Management:** Utilizes `useState` for managing file selection, selected/deselected packing lists (`selectedPl`, `deselectedPl`), pagination, sort model, user actions, XML loader state, and alert configurations.
*   **Redux Toolkit Queries:** Integrates `useCreateBookingXmlMutation`, `useUploadBookingXmlMutation`, `useFetchBookingPlListQuery`, `useGetBookingConfirmQuery`, and `useUpdateDoMutation` from `@reduxjs/toolkit/query/react` for API interactions related to booking confirmation, XML generation, and uploads.
*   **File Uploads:** Handles file selection and appends `do_document` to `FormData` for submission.
*   **Conditional Logic:** Logic exists for handling `save_and_next` and `send-to-otm` actions, including toast notifications for success/failure and warnings.
*   **Error Handling:** Includes robust error handling with `toast.error` and a `PopupAlert` for warnings, specifically catching custom warning errors.
*   **Data Fetching:** Fetches `plData` (packing list data) and `confirmData` (booking confirmation data). The `plData` fetching logic includes keyword search, filtering by `pl_status: "SUBMIT"`, and passing selected/deselected PL serial IDs.
*   **UI Components:** Employs a variety of MUI components (`Box`, `Card`, `Grid`, `Stack`, `Typography`, `Chip`), custom buttons (`OutlinedButton`, `ThemeButton`), input fields (`InputBoxExtend`, `AppDatePickerExtend`), file dropzone (`SingleFileDropzone`, `UploadFile`), and modals (`ThemedModalExtend`).
*   **API Interactions:** Interacts with `ApiManager` for external API calls, notably for generating and uploading XML.

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerForm.jsx`
**Timestamps: 1/2/2026, 3:46:26 PM, 1/2/2026, 3:48:00 PM, 1/2/2026, 3:48:14 PM, 1/2/2026, 3:54:30 PM, 1/2/2026, 4:36:47 PM**
This component manages a form for adding or editing customer details.
*   **Formik Integration:** Uses `useFormik` for form state, validation (`CustomerValidationSchema`), and submission.
*   **State Management:** Manages state for autocomplete options (sales, Descartes customers, ISF parties, cities) and uploaded files.
*   **API Interaction:** Uses `useAddCustomerMutation` from Redux Toolkit Query to handle customer creation/update. It also uses `ApiManager` for fetching options for various autocomplete fields (sales, Descartes customers, ISF parties, cities).
*   **Dynamic Fields:** The form includes fields like "IES Client code," "Name," "Email," "Contact Person," "URL," "Phone," "Fax," "Address Lines," "City," "State," "Postal Code," "Country," "Status," "Sales Rep.", "Descartes Customer Mapping", and "ISF Party Mapping".
*   **City Autocomplete Logic:** `handleCitySelect` automatically populates state, zipcode, and country based on the selected city from the autocomplete options.
*   **File and Mapping Handling:** The `onSubmit` function serializes `files` and `customer_mapping` arrays into `FormData` for submission.
*   **Navigation and Notifications:** Uses `useNavigate` to redirect after successful submission and `react-hot-toast` for user feedback.
*   **Initial Values:** The `formik` `initialValues` are dynamically set, with `customer_mapping` initialized as an empty array if not provided. There's also a `console.log("initialValues123456", initialValues);` at `3:54:30 PM`, indicating debugging efforts.

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\components\screen\code\customer\CustomerMapping.jsx`
**Timestamps: 1/2/2026, 3:47:04 PM, 1/2/2026, 4:03:31 PM, 1/2/2026, 4:04:17 PM, 1/2/2026, 4:09:07 PM, 1/2/2026, 4:21:23 PM, 1/2/2026, 4:21:38 PM, 1/2/2026, 4:34:47 PM, 1/2/2026, 4:35:01 PM, 1/2/2026, 4:35:58 PM**
This component handles the mapping of customers within a form, typically for "customer_mapping" array in the parent `CustomerForm`.
*   **Dynamic List Management:** Allows adding and deleting rows for customer mappings.
*   **Autocomplete Search:** Uses `AppAutocomplete` for selecting customers, with search functionality provided by `ApiManager.getCustomerOptions`.
*   **State Management:** Manages `optionsCustomer` for autocomplete, `search` keyword, and `loading` state for API calls.
*   **Row Operations:** `addRow`, `deleteRow`, and `updateRow` functions modify the `customer_mapping` array within the parent `formik` state.
*   **API Interaction for Deletion:**
    *   **Initial Implementation (4:03:31 PM):** Introduced a call to `ApiManager.deleteCustomerOption(rowToDelete.customer)` when a row is deleted, but only if the `customer` value exists. This was problematic as it used `customer` (name) instead of `customerId` (ID).
    *   **Correction (4:04:17 PM):** The `ApiManager.deleteCustomerOptions` method was called, but the endpoint itself was still incorrect in `Endpoints.js`.
    *   **Reverted Deletion Logic (4:09:07 PM):** The explicit API call for deletion on row removal was temporarily reverted, suggesting a reconsideration of the backend interaction for deleting mapping rows.
    *   **Re-introduction with `customer_id` (4:21:23 PM, 4:21:38 PM):** The delete logic was re-introduced to delete from the backend *if* `row.customer_id` exists, implying that a `customer_id` property is now expected in the mapping objects.
    *   **Toast Notifications for Delete (4:34:47 PM):** Added `toast.success` for successful deletion and `toast.info` if no `customer_id` is found (meaning it's a new, unsaved row) or `toast.error` for API failures.
*   **Initialization Logic:** Ensures at least one empty mapping row exists when the component mounts if the `customer_mapping` array is empty.

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\Endpoints.js`
**Timestamps: 1/2/2026, 4:01:34 PM, 1/2/2026, 4:08:51 PM, 1/2/2026, 4:20:10 PM, 1/2/2026, 4:20:25 PM, 1/2/2026, 4:25:35 PM, 1/2/2026, 4:32:00 PM, 1/2/2026, 4:36:10 PM**
This file defines the API endpoints used throughout the application.
*   **`DELETE_CUSTOMER_OPTION` Evolution:** This endpoint definition underwent several critical changes related to deleting customer mappings.
    *   **Initial (4:01:34 PM):** `DELETE_CUSTOMER_OPTION: (accountName) => /deleteCustomerOption?account_name=${encodeURIComponent(accountName)}` - Used a query parameter with `accountName`.
    *   **Removal (4:08:51 PM):** This endpoint was completely removed, likely as a consequence of the `ApiManager.deleteCustomerOptions` method being incorrectly defined or misused initially.
    *   **Re-introduction (4:20:10 PM):** `DELETE_CUSTOMER_OPTION: (search = "") => /getCustomerOptions${search ? ?search=${encodeURIComponent(search)} : ""}` - This was an incorrect re-introduction, essentially using the `GET_CUSTOMER_OPTIONS` endpoint for deletion.
    *   **Path Parameter Correction (4:20:25 PM):** `DELETE_CUSTOMER_OPTION: (customerId) => /deleteCustomerOption/${customerId}` - Corrected to use a path parameter for `customerId`.
    *   **Further Path Correction (4:25:35 PM):** `DELETE_CUSTOMER_OPTION: (customerId) => /delete/${customerId}` - Simplified the path to just `/delete`.
    *   **Final Path Correction (4:32:00 PM, 4:36:10 PM):** `DELETE_CUSTOMER_OPTION: (customerId) => /getCustomerOptions/delete/${customerId}` - Settled on a more specific path including `getCustomerOptions`.
*   **No other significant endpoint changes** beyond the `DELETE_CUSTOMER_OPTION` evolution are noted.

### File: `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-frontend\src\services\ApiManager.js`
**Timestamps: 1/2/2026, 4:01:42 PM, 1/2/2026, 4:01:51 PM, 1/2/2026, 4:06:54 PM, 1/2/2026, 4:08:09 PM, 1/2/2026, 4:19:58 PM, 1/2/2026, 4:36:34 PM**
This file provides a centralized interface for making API calls.
*   **`deleteCustomerOptions` Method Evolution:**
    *   **Duplicate `getCustomerOptions` (4:01:42 PM):** The `deleteCustomerOptions` method was initially a duplicate of `getCustomerOptions`, calling the same `GET_CUSTOMER_OPTIONS` endpoint.
    *   **Renamed and Changed to DELETE Method (4:06:54 PM):** The method was renamed to `deleteCustomerOptions` (plural) and correctly changed to use `ApiMethods.delete(url)`, passing `accountName` to `ENDPOINTS.DELETE_CUSTOMER_OPTION`.
    *   **Removed (4:08:09 PM):** The `deleteCustomerOptions` method was entirely removed, likely due to the related endpoint also being removed at that timestamp in `Endpoints.js`.
    *   **Re-added as `deleteCustomerOption` (singular) and `customerId` (4:19:58 PM, 4:36:34 PM):** The method was re-added with the singular name `deleteCustomerOption`, taking `customerId` as a parameter, and correctly using `ApiMethods.delete` with the updated `ENDPOINTS.DELETE_CUSTOMER_OPTION`. This change aligned with the `CustomerMapping.jsx` component's new expectation of `customer_id`.

---

**General Patterns and Recurring Elements:**
*   **Date: January 2, 2026:** All changes occurred on the same date, indicating a focused development session.
*   **Redux Toolkit/RTK Query:** The application extensively uses Redux Toolkit for state management and RTK Query for data fetching, caching, and mutations (`useAddCustomerMutation`, `useCreateBookingXmlMutation`, etc.).
*   **Formik:** `formik` is a consistent choice for form handling and validation across different form components.
*   **Material-UI (MUI):** The UI components from `@mui/material` are widely used for building the frontend.
*   **`ApiManager` and `Endpoints`:** There's a clear separation of concerns with `Endpoints.js` defining API paths and `ApiManager.js` providing wrapper functions for API calls using `ApiMethods`.
*   **Role-Based Access Control:** `ProtectedRoute` and `UserRoleEnum` are frequently used in `App.js` to enforce access permissions.
*   **Autocomplete Fields:** Autocomplete components (e.g., `AppAutocomplete`) are common for selecting entities like customers, sales reps, cities, etc., often backed by `ApiManager` calls.
*   **Console Logs:** Frequent `console.log` statements suggest active debugging during development.
*   **Evolution of API Design:** The specific changes around `DELETE_CUSTOMER_OPTION` and `deleteCustomerOption` in `Endpoints.js` and `ApiManager.js`, combined with the `CustomerMapping.jsx` component, show an iterative process of refining API routes and their corresponding client-side methods to handle resource deletion, specifically moving from a query-based or incorrect endpoint to a path-parameter-based DELETE request using a `customerId`.

## 5:06:16 PM
This log details changes primarily focused on enhancing and expanding analytical query builders for a logistics tracking application (`T360-V2`). The updates occurred on **January 2, 2026**, between 4:59:40 PM and 5:47:08 PM. The core theme across all modified files is the generation of dynamic SQL queries to support various performance metrics and reports.

### File-Specific Updates:

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts` (Timestamp: 1/2/2026, 4:59:40 PM):**
    *   The `transitQueryBuilder` function was significantly expanded to handle multiple report types related to transit performance.
    *   **New report types:** `country_of_origin`, `ScheduledTransitVsActualTransit`, `ScheduledTransitVsActualTransitMblWise`, and a default `port_pair` analysis.
    *   **`country_of_origin` and `port_pair` reports:** Generate separate queries for `estimated`, `actual`, and `estimated_actual` transit times, storing results in `customizer.additionalData`. The `queryGenerator` function was introduced to modularize query construction for these types, involving joins with `portmaster` to resolve country names.
    *   **`ScheduledTransitVsActualTransit` and `ScheduledTransitVsActualTransitMblWise`:** Introduce complex PostgreSQL `WITH` queries to calculate the difference between actual (vessel arrived - vessel departed) and scheduled (inland ETA - departure date) transit durations. These queries aggregate by `fileno, contno` or `fileno, mblno` and calculate a percentage relative to the maximum difference.
    *   `customizer.calColumnConfig` is updated to define "actual", "estimated", and "estimated_actual" columns for various date differences.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts` (Timestamps: 1/2/2026, 5:00:42 PM and 5:00:53 PM):**
    *   No functional changes observed between these two timestamps, the code content is identical.
    *   The `getTEUReports` function dynamically constructs SQL queries to calculate TEU based on different grouping columns (`country_of_origin`, `country_of_discharge`, or other arbitrary columns).
    *   When grouping by country, it joins `mtr_tracking_data` with `portmaster`.
    *   For other columns, it includes logic to categorize `NULL` or empty column values as 'OTHERS' and explicitly maps 'LONG BEACH' to 'LOS ANGELES' for 'pod' or 'place_of_delivery'.
    *   TEU calculation involves extracting numeric parts from `t49_cont_type` or `cont_type` using `REGEXP_REPLACE`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\departure.query.ts` (Timestamp: 1/2/2026, 5:01:49 PM):**
    *   The `departureQueryBuilder` was enhanced to support several departure-related KPIs.
    *   **`BLReleaseKPI`:** Implements a stacked bar chart showing the difference between 'Vessel Actual Departure Date' and 'Batch Run Date', categorized into 'Equal/Less than 3 days' and 'More than 3 days'. It joins `mtr_tracking_data` with `sprhbl`.
    *   **`DelayedPOLDepartures` and `DelayedPOLDeparturesMblWise`:** Calculates the sum of day differences between 'Live Actual Departed Date' and 'Departure Date', grouped by `fileno, contno` or `fileno, mblno`, specifically looking for delays (`t49_vessel_actualdeparted_date > departure_date`).
    *   **`OriginalETAvsActualETA` and `OriginalETAvsActualETAMblWise`:** Computes the sum of day differences between 'Updated ETA Port Date' and 'ETA POD' to track ETA variance, grouped by `fileno, contno` or `fileno, mblno`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\general.query.ts` (Timestamp: 1/2/2026, 5:03:05 PM):**
    *   The `generalQueryBuilder` now supports `TotalShipments` and `TotalShipmentsMblWise` reports.
    *   These reports count distinct `fileno` (shipments) and distinct `voyage` (containers) or distinct `mblno` (Master Bill of Lading count).
    *   Post-query processing is implemented to calculate percentages for these counts based on the maximum value.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\container.query.ts` (Timestamp: 1/2/2026, 5:03:44 PM):**
    *   The `containerQueryBuilder` was updated to include several container movement related KPIs.
    *   **`ContainerDischargevsContainerAvailable`:** Calculates the difference between 'Container Available Date' (using `t49_cont_available_date` or `cont_available_date`) and 'Container Discharge Date'.
    *   **`ContainerDischargeVsFinalDeliveryDate`:** Calculates the difference between 'Delivery Customer Date' and 'Container Discharge Date', specifically for `FDC` or `FDN` type of moves.
    *   **`ContainerGateOutVsGateIn`:** Calculates the difference between 'Empty Return Date' and 'Container Outgate + 1' (using `t49_empty_return_date`/`empty_return_date` and `t49_contno_out_gated`/`contno_out_gated`).
    *   **`ContainerOrVesselDischargeVsGateOut`:** Calculates the difference between 'Container Outgate' and 'Container Discharge Date'.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` (Timestamps: 1/2/2026, 5:09:05 PM, 5:09:30 PM, 5:11:03 PM, 5:46:22 PM, 5:47:08 PM):**
    *   All entries for this file show identical content, indicating a series of saves without functional changes during this period.
    *   The `bookingQueryBuilder` supports various reports measuring the time from booking to actual departure.
    *   **`BookingDatetoActualDeparture` and `BookingDatetoActualDepartureMblWise`:** Calculate the average day difference between 'Live Actual Departed Date' and 'Booking Date', joining `mtr_tracking_data` with `agent_booking_entry`.
    *   **`BookingDatetoActualDepartureStackedBar` and `BookingDatetoActualDepartureMblWiseStackedBar`:** Provide a stacked bar chart view of the same metric, categorizing the day difference into 'Less than 1 week', '1 - 2 weeks', '2 - 3 weeks', '3 - 5 weeks', and 'Above 5 weeks'.

### Patterns and Recurring Elements:

*   **Consistent Date & Time Handling:**
    *   All queries filter data using a `departure_date` range: `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'`.
    *   Extensive checks for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` are uniformly applied to date columns within SQL queries to prevent invalid date calculations.
    *   Date difference calculations (`EXTRACT(DAY FROM date1 - date2)`) are prevalent across all query builders for performance metrics.
*   **Dynamic Column Selection & Customizer Object:**
    *   The `getColumnsByCategory` utility function is consistently used in conjunction with `ignore` and `must` lists to dynamically configure `customizer.selectedColumns` for frontend display.
    *   The `customizer` object is universally used to pass metadata for report configuration (e.g., `dateRange`, `calType`, `dateColumns`, `chartType`, `calColumnConfig`, `booking`, `mblwise`).
*   **Company-Specific Data Filtering:** All SQL queries include `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )`, indicating a robust mechanism for filtering data by one or more specified company names.
*   **Percentage Calculation Logic:** A common pattern for calculating percentages (`ROUND(((ABS(t.value) / max_value.max_total) * 100)::numeric, 2)`) is observed, often including error handling for division by zero (`max_value.max_total = 0`) and negative values (`t.value < 0`).
*   **Distinct Row Identification:** Many complex queries use `SELECT DISTINCT ON (m.voyage,m.contno, CASE WHEN m.t49_cont_type IS NOT NULL AND TRIM(m.t49_cont_type) <> '' AND TRIM(m.t49_cont_type) != '0' THEN m.t49_cont_type ELSE m.cont_type END )` to ensure unique records based on container-related identifiers before aggregation.
*   **Master Bill of Lading (MBL) Wise Reports:** Several report types have a `MblWise` variant, indicating the need to aggregate or group data by `mblno` instead of `contno` for certain analyses.
*   **Primary Data Source:** The `mtr_tracking_data` table serves as the central data source for nearly all analytical queries.
*   **Error Handling and Logging:** Basic validation for required `type` parameters and `logger.info` / `console.log` statements for debugging are present across the files.