# Activity Summary for 1/4/2026

## 2:59:57 PM
The provided log details a series of code changes, all occurring on January 2, 2026, primarily focusing on customer management, data fetching, and analytics queries within a T360 API backend.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\analytics\query\booking.query.ts` (Timestamp: 1/2/2026, 2:35:49 PM)**
    *   This file defines the `bookingQueryBuilder` function, responsible for generating complex SQL queries for analytics reports.
    *   It imports utilities for dynamic column selection and filter query generation.
    *   The function dynamically sets `customizer` properties (e.g., `selectedColumns`, `dateRange`, `calType`, `chartType`) based on the `type` of booking query requested.
    *   It supports various report types, including calculating average day differences between booking and actual departure dates (both container-wise and MBL-wise) and generating stacked bar charts to categorize these differences into time ranges (e.g., "Less than 1 week", "1 - 2 weeks").
    *   Queries use `mtr_tracking_data` and `agent_booking_entry` tables, applying filters for `CompanyName` and date ranges.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\getCustomerOptions.ts` (Multiple timestamps between 1/2/2026, 3:58:49 PM and 4:31:23 PM)**
    *   This controller manages customer options, primarily for fetching and deleting.
    *   **`getAllCustomerOptions`:** Fetches a distinct list of `account_name` from `mtr_tracking_data`, allowing for partial string searches and limiting results to 10. Earlier, commented-out code suggests more elaborate customer role-based and paginated fetching was considered or previously implemented.
    *   **`deleteCustomerOption`:** This function underwent several rapid iterations:
        *   Initially, it deleted records from `mtr_tracking_data` based on `account_name` provided in the request body.
        *   It then shifted to accepting a `customer_id` from `req.params`, first attempting to delete from `mtr_tracking_data` using a `customer_id` column, then an `id` column.
        *   The final change redirects the deletion to the `Account_Master_Customer_MAP` table, using the `id` column, indicating a focus on deleting specific customer mappings rather than general tracking data entries.
    *   Debugging `console.log` statements were temporarily added for `customer_id` and `req.params` during this iterative development.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\routes\getCustomerOptionsRoute.ts` (Multiple timestamps between 1/2/2026, 3:59:33 PM and 4:28:07 PM)**
    *   This file defines API routes for the `getCustomerOptions` controller.
    *   It exposes a `GET /` endpoint for `getAllCustomerOptions`.
    *   The `DELETE` route evolved from `DELETE /` to `DELETE /delete`, and finally to `DELETE /delete/:customer_id`. This evolution directly mirrors the changes in how `deleteCustomerOption` in its controller expects parameters.

*   **`c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\controllers\code.controller.ts` (Multiple timestamps between 1/2/2026, 4:12:38 PM and 4:14:13 PM)**
    *   This controller handles more comprehensive customer (Account Master) functionalities.
    *   **`getAllCustomer`:** Retrieves detailed customer information from `PO_AccountMaster_Customer_Master`, supporting pagination, sorting, and search filters. It also fetches associated shipper mappings (`account_master_shipper_MAP`), document uploads (`document_upload_details`), and customer mappings (`Account_Master_Customer_MAP`). A minor update added `customer_id` to the `customerMapData` output.
    *   **`createCustomer`:** A robust function for creating or modifying customer records.
        *   It supports file uploads and handles various customer attributes.
        *   Uses a database transaction.
        *   Determines if it's a 'NEW' or 'Modify' operation based on existing `acode`. For modifications, it deletes existing related records across multiple tables (`PO_AccountMaster_Customer_Master`, `agent_po_account_master_type`, `Account_Master_Shipper_MAP`, `account_master_pic`) before re-inserting.
        *   Generates new `acode` or `subcode` for new entries or specific customer types.
        *   Processes `ctypelist` to insert into `agent_po_account_master_type`.
        *   Parses `mapping` data (likely for shippers) to populate `Account_Master_Shipper_MAP`, resolving related codes from other master tables.
        *   The code for this function is truncated, indicating further logic beyond the provided snippet.

**Patterns and Recurring Elements:**

*   **Customer-Centric Development:** A strong focus on customer-related operations, including analytics, fetching options, detailed profile management, and deletion.
*   **Rapid Iteration on Deletion Logic:** The `deleteCustomerOption` function and its corresponding route changed multiple times within a short period, refining how customer deletion is performed and which data `id` is used (from `account_name` to `customer_id` to `id`, and from `mtr_tracking_data` to `Account_Master_Customer_MAP`).
*   **Database Interaction:** Extensive use of PostgreSQL-like SQL queries (`SELECT`, `INSERT`, `DELETE`, `TRIM`, `ILIKE`, `EXTRACT(DAY FROM...)`) with parameterized values ($1, $2) for security.
*   **Dynamic Query Generation:** The `bookingQueryBuilder` and `getAllCustomer` functions demonstrate building SQL queries dynamically based on input parameters.
*   **Utility Functions:** Reliance on imported helper functions like `getColumnsByCategory`, `getFilterQueryByDisplayValue`, `chkStr`, `getAccountCode`, `getAccountSubCode` for modularity and data handling.
*   **Logging and Debugging:** Frequent `console.log` and `logger.info` statements suggest an active debugging and monitoring process.
*   **Truncation:** Several code snippets are truncated, implying larger functions and more extensive changes were made than fully captured in the log.

## 3:00:09 PM
The changes primarily involve enhancements and additions to analytics query builders, focusing on transit, TEU, departure, general shipment, container, and booking-related reports. All modifications occurred on 1/2/2026.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\transit.query.ts` (Timestamp: 1/2/2026, 4:59:40 PM)**
    *   Introduced `transitQueryBuilder` for generating complex SQL queries related to transit times.
    *   Supports analytics for "country_of_origin" and "port_pair" comparisons of actual, estimated, and estimated vs. actual transit times.
    *   Added dedicated logic for "ScheduledTransitVsActualTransit" (container-wise) and "ScheduledTransitVsActualTransitMblWise" (MBL-wise) reports, calculating average day differences between live actual arrived/departed dates and inland ETA/departure dates.
    *   The queries include `DISTINCT ON` clauses to handle data uniqueness based on voyage, container number, and container type.
    *   Customizer configurations for chart types, calculation types, and selected columns are dynamically set.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\teuService.ts` (Timestamp: 1/2/2026, 5:00:42 PM and 1/2/2026, 5:00:53 PM)**
    *   The `getTEUReports` service was updated to provide TEU (Twenty-foot Equivalent Unit) analytics.
    *   Calculates TEU based on `country_of_origin`, `country_of_discharge`, or other generic `group_by_column`.
    *   Includes logic to extract numeric container types (`t49_cont_type` or `cont_type`) for `total_volume` calculation and then converts to TEU (dividing by 20).
    *   Standardizes port names (e.g., 'LONG BEACH' becomes 'LOS ANGELES') for specific columns.
    *   Default `fromDate` and `toDate` are set if not provided in the request.
    *   The two entries for this file are functionally identical, indicating a minor save or reformat without code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\departure.query.ts` (Timestamp: 1/2/2026, 5:01:49 PM)**
    *   Introduced `departureQueryBuilder` for departure-related KPIs.
    *   Supports "BLReleaseKPI" as a stacked bar chart, categorizing the difference between vessel actual departure and batch run date into "Equal/Less than 3 days" and "More than 3 days".
    *   Added "DelayedPOLDepartures" (container-wise) and "DelayedPOLDeparturesMblWise" (MBL-wise) reports, calculating the sum of day differences between live actual departed date and departure date.
    *   Implemented "OriginalETAvsActualETA" (container-wise) and "OriginalETAvsActualETAMblWise" (MBL-wise) reports, calculating the sum of day differences between updated ETA port date and original ETA POD.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\general.query.ts` (Timestamp: 1/2/2026, 5:03:05 PM)**
    *   Added `generalQueryBuilder` for basic shipment and MBL/container counts.
    *   Introduced "TotalShipments" which provides a count of distinct `fileno` (shipments) and distinct `voyage` (containers).
    *   Added "TotalShipmentsMblWise" which provides a count of distinct `fileno` (shipments) and distinct `mblno` (Master Bill of Lading).
    *   Calculates percentages for these counts relative to the maximum value observed.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\container.query.ts` (Timestamp: 1/2/2026, 5:03:44 PM)**
    *   Introduced `containerQueryBuilder` for container-specific analytics.
    *   Supports "ContainerDischargevsContainerAvailable" (difference between container available date and discharge date).
    *   Added "ContainerDischargeVsFinalDeliveryDate" (difference between delivery customer date and container discharge date, filtered by `type_of_move`).
    *   Implemented "ContainerGateOutVsGateIn" (difference between empty return date and container outgate date, adding 1 day).
    *   Added "ContainerOrVesselDischargeVsGateOut" (difference between container outgate and discharge date).
    *   Prioritizes `t49_` prefixed date columns where available, indicating "live" data.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts` (Timestamp: 1/2/2026, 5:09:05 PM, 5:09:30 PM, 5:11:03 PM, 5:46:22 PM, 5:47:08 PM)**
    *   The `bookingQueryBuilder` was updated to include various booking-to-departure time analyses.
    *   Features "BookingDatetoActualDeparture" (container-wise) and "BookingDatetoActualDepartureMblWise" (MBL-wise) reports, calculating the average day difference between actual vessel departure and booking date.
    *   Introduced stacked bar chart variants: "BookingDatetoActualDepartureStackedBar" and "BookingDatetoActualDepartureMblWiseStackedBar", which categorize the day difference into weekly intervals (e.g., "Less than 1 week", "1 - 2 weeks").
    *   All five entries for this file at different timestamps are identical, indicating no functional code changes between these saves.

**Patterns and Recurring Elements:**

*   **Dynamic Query Generation:** A consistent pattern of constructing SQL queries based on `type`, `columnName`, `viewBy`, and `displayBy` parameters, using helper functions like `getFilterQueryByDisplayValue` and `getFilterQueryByTransitView`.
*   **Customizer Object:** The `customizer` object is universally used to configure report metadata such as `dateRange`, `calType`, `chartType`, `dateColumns`, and `calColumnConfig` for the frontend to interpret the analytics data.
*   **Column Selection:** The `getColumnsByCategory` utility is frequently called to define which columns are relevant for a given report, often ignoring common metadata columns and explicitly requiring key analytical columns.
*   **Date Handling and Validation:** All queries include robust date validation, checking for `IS NOT NULL` and `!= '0001-01-01 00:00:00 BC'` to ensure accurate calculations and prevent errors from invalid default dates. Date range filtering `departure_date >= '${fromDate}'::timestamp AND departure_date < '${toDate}'::timestamp + INTERVAL '1 day'` is also standard.
*   **Company-Specific Filtering:** Data is consistently filtered by `account_name` using `LOWER(account_name) = ANY ( regexp_split_to_array(LOWER('${CompanyName}'), '\s*,\s*') )`, allowing multiple company names to be passed.
*   **`DISTINCT ON` for Uniqueness:** Many queries use `DISTINCT ON (voyage,contno, CASE WHEN t49_cont_type IS NOT NULL AND TRIM(t49_cont_type) <> '' AND TRIM(t49_cont_type) != '0' THEN t49_cont_type ELSE cont_type END )` to ensure unique records, particularly for container-level analysis.
*   **`t49_` Data Prioritization:** There's a recurring logic to use `t49_` prefixed columns (e.g., `t49_vessel_actualdeparted_date`) over their standard counterparts if they contain valid data, suggesting `t49_` fields represent more current or accurate tracking information.
*   **Percentage Calculation Logic:** Most analytical queries include a `WITH max_value AS (...)` common table expression to determine the maximum value and then calculate each entity's `percentage` relative to this maximum, handling division by zero and negative values.
*   **MBL-Wise and Container-Wise Variants:** Several reports offer both container-level (`fileno || ',' || contno` for grouping) and MBL-level (`fileno || ',' || mblno` for grouping) aggregation, reflecting different granularities of tracking.
*   **PostgreSQL Features:** Extensive use of PostgreSQL-specific functions like `EXTRACT(DAY FROM interval)`, `DATE_TRUNC`, `regexp_split_to_array`, `CAST`, `NULLIF`, and `REGEXP_REPLACE` for data manipulation and aggregation.

## 4:03:59 PM
**File: `src\controllers\analytics\query\booking.query.ts` (Timestamp: 1/2/2026, 2:35:49 PM)**
This file defines the `bookingQueryBuilder` function, responsible for generating complex SQL queries for analytics reports related to booking and actual departure dates. It imports utilities for column selection and filter query generation. The function customizes report parameters like date ranges, calculation types (average), and date columns based on the `type` of the report.
Key updates include:
*   Ignored columns like `country_name`, `networkdays`, `bl_release_date` for column selection, while ensuring `bookingdate`, `booking_status_action_date`, `est_cargo_ready_date`, and `departure_date` are always included.
*   Introduced new report types:
    *   `BookingDatetoActualDeparture`: Calculates the average day difference between booking and actual departure dates per `fileno` and `contno`, providing a value and a percentage relative to the maximum value.
    *   `BookingDatetoActualDepartureMblWise`: Similar to the above, but aggregates per `fileno` and `mblno`.
    *   `BookingDatetoActualDepartureStackedBar`: Categorizes day differences into predefined ranges ("Less than 1 week", "1 - 2 weeks", etc.) and aggregates counts by date intervals, suitable for stacked bar charts.
    *   `BookingDatetoActualDepartureMblWiseStackedBar`: An incomplete block, presumably for a similar stacked bar chart aggregation per MBL.
Each query includes filtering by `CompanyName` and a date range (`fromDate`, `toDate`).

**File: `src\controllers\getCustomerOptions.ts`**
This controller manages customer options and deletion functionality.
*   **Initial Update (1/2/2026, 3:58:49 PM):**
    *   The `getAllCustomerOptions` function was completely refactored. Previously it had extensive commented-out logic for handling different roles (`AGENT`, `CUSTOMER`) and pagination, fetching from `agent_po_account_master` or `mtr_tracking_data`. The new version is streamlined to fetch `DISTINCT TRIM(account_name)` from `mtr_tracking_data` with a search capability (`ILIKE`) and a limit of 10 results.
    *   A new `deleteCustomerOption` function was introduced, initially designed to delete records from `mtr_tracking_data` based on `account_name` received in `req.body`.
*   **Subsequent Updates (1/2/2026, 4:17:54 PM - 4:31:23 PM):**
    *   **4:17:54 PM:** The `deleteCustomerOption` function was modified to accept `customer_id` from `req.params` instead of `account_name` from `req.body`, and the SQL query changed to `DELETE FROM mtr_tracking_data WHERE customer_id = $1`.
    *   **4:22:36 PM:** The SQL query in `deleteCustomerOption` was refined to use `id` as the column for deletion: `DELETE FROM mtr_tracking_data WHERE id = $1`.
    *   **4:28:41 PM, 4:28:50 PM, 4:29:40 PM:** Minor debugging `console.log` statements were added to `deleteCustomerOption` to inspect `customer_id` and `req.params`. The core delete logic remained unchanged.
    *   **4:31:23 PM:** The target table for deletion in `deleteCustomerOption` was changed from `mtr_tracking_data` to `Account_Master_Customer_MAP`, making the SQL `DELETE FROM Account_Master_Customer_MAP WHERE id = $1`.

**File: `src\routes\getCustomerOptionsRoute.ts`**
This file defines the API routes for customer options.
*   **Initial Update (1/2/2026, 3:59:33 PM):**
    *   Defined a `GET /` route for `getAllCustomerOptions` and a `DELETE /` route for `deleteCustomerOption`.
*   **Subsequent Updates (1/2/2026, 3:59:43 PM - 4:28:07 PM):**
    *   **3:59:43 PM:** The `DELETE` route was changed from `/` to `/delete`.
    *   **4:18:20 PM & 4:28:07 PM:** The `DELETE` route was further refined to include a dynamic `customer_id` parameter: `/delete/:customer_id`. This change directly corresponds to the `deleteCustomerOption` controller's expectation of `customer_id` from `req.params`.

**File: `src\controllers\code.controller.ts`**
This controller handles comprehensive customer management, including fetching, creating, and modifying customer records.
*   **Initial Update (1/2/2026, 4:12:38 PM):**
    *   `getAllCustomer`: This function retrieves customer details from `PO_AccountMaster_Customer_Master` with support for pagination, sorting (`orderBy`), and dynamic column-based searching. It also fetches and integrates related data, specifically shipper mappings from `account_master_shipper_MAP`, document upload details from `document_upload_details`, and customer mappings from `Account_Master_Customer_MAP`.
    *   `createCustomer`: This function manages the creation or modification of customer records, supporting file uploads.
        *   It sanitizes the `cname` field.
        *   It operates within a database transaction.
        *   It checks for existing customers by `acode`; if found, it's treated as a modification, leading to deletion of existing associated records across multiple tables (customer master, type, shipper map, account master pic) before re-insertion. If new, it generates a unique `acode`.
        *   Inserts into `PO_AccountMaster_Customer_Master`.
        *   Handles `ctypelist` specifically for 'CUSTOMER' type, inserting into `agent_po_account_master_type`.
        *   Processes `mapping` data (likely shipper-related), resolving `polcode`, `shippercode`, and `agentcode` by querying respective master tables, and then inserting into `Account_Master_Shipper_MAP`. The provided log for this function ends abruptly.
*   **Subsequent Update (1/2/2026, 4:14:13 PM):**
    *   `getAllCustomer`: The `customerMapData` object, returned as part of the customer details, was enhanced to include the `id` from `Account_Master_Customer_MAP`, now exposed as `customer_id`. The `createCustomer` function's code content was identical to the previous log entry, indicating no functional change to it in this specific timestamp, or that the snippet was truncated in the same manner.

**Patterns and Recurring Elements:**
*   **Rapid Iteration on Customer Deletion:** The `deleteCustomerOption` function and its corresponding route changed multiple times in a short span, moving from `req.body` to `req.params` for ID, refining the ID column name, and finally changing the target table for deletion.
*   **Focus on Customer Data:** A consistent theme is the management and retrieval of customer-related information across various tables (`PO_AccountMaster_Customer_Master`, `mtr_tracking_data`, `Account_Master_Shipper_MAP`, `Account_Master_Customer_MAP`).
*   **Complex SQL Queries:** Several functions utilize intricate SQL queries involving joins, subqueries, aggregations, date/time manipulations, and conditional logic (`CASE WHEN`).
*   **Database Transaction Management:** The `createCustomer` function explicitly uses `BEGIN` for a database transaction, indicating multi-step operations requiring atomicity.
*   **Data Sanitization:** Use of `TRIM()` in SQL and `chkStr()` in controllers, along with string replacements for `cname`, suggests an emphasis on clean data handling.
*   **Timestamp Proximity:** All logged changes occurred on the same day, indicating active development on these specific features.
*   **Incomplete Log Entries:** Several code blocks provided in the log end abruptly, suggesting the log might be capturing snapshots rather than full diffs for longer functions.