# Activity Summary for 1/9/2026

## 10:13:21 AM
The code changes on `1/8/2026` reflect an active development session focused on user authentication, authorization, and utility functions within a `t360-backend-v2` project.

**File-Specific Updates:**

*   **`src\services\globalSearch.ts`**:
    *   **1/8/2026, 12:20:50 PM**: The `getGlobalOptions` function was introduced, enabling global search functionality based on `mblno`, `blno`, or `contno` within `mtr_tracking_data`. It applies user-specific filtering conditions via `buildMtrUserCondition` and aggregates `contno` and `fileno` by `mblno`.
    *   **1/8/2026, 12:21:18 PM**: A minor debugging line, `console.log('req.user', req.user);`, was added to the `getGlobalOptions` function.

*   **`src\utils\common.ts`**:
    *   **1/8/2026, 12:26:48 PM**: This file received a substantial update, introducing a suite of utility functions:
        *   `buildHBLUserCondition` and `buildMtrUserCondition`: Functions to generate SQL `WHERE` clauses based on `UserType` roles (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT, ADMIN_V2) for data filtering. `buildMtrUserCondition` includes specific logic for "ZIGI USA, LLC" and other roles, querying related tables for front office or agent accounts.
        *   `getAgentBookingCode`: An asynchronous function to generate unique agent booking codes, managing sequential numbering and database updates in the `agent_bookingno` table.
        *   `sanitizeString`: A utility for handling null/undefined/ "null" string values.
        *   `AppDateFormate`, `formatDate`: Functions for robust date formatting and display, including checks for invalid dates.
        *   `timeAgo`: A function to display time differences in a human-readable format (e.g., "X minutes ago").

*   **`src\common\util\jwtToken.ts`**:
    *   **1/8/2026, 1:12:29 PM**: Initial implementation of `createToken` and `VerifyToken` functions for JWT handling. Tokens were set to expire in '10s'.
    *   **1/8/2026, 3:53:24 PM**: Minor adjustment to `createToken`, using `process.env.JWT_SECRET!` for signing. Expiry remained '10s'.
    *   **1/8/2026, 4:53:18 PM**: The JWT expiry time in `createToken` was increased from '10s' to '20s'.
    *   **1/8/2026, 5:32:45 PM**: A significant change: `createToken`'s expiry was drastically extended from '20s' to '7d' (7 days), and `secret` was used directly for signing.
    *   **1/8/2026, 5:39:52 PM**: The `createToken` function reverted its expiry back to '20s' and changed the signing secret back to `process.env.JWT_SECRET!`, undoing the previous change.
    *   **1/8/2026, 7:47:00 PM**: `createToken` was refactored. The original version was commented out, and a new `createToken` was introduced that now returns an object containing both the `token` string and its `exp` (expiry timestamp). Expiry remained '20s'.
    *   **1/8/2026, 10:33:03 PM**: The `createToken` function's expiry was again reduced, from '20s' back to '10s', while maintaining the new object return structure.

*   **`src\middleware\authMiddleware.ts`**:
    *   **1/8/2026, 1:26:07 PM**: The `authMiddleware` was introduced, handling two distinct authentication flows:
        *   **Auth0 Integration**: Verifies tokens using `jwks-rsa` against an Auth0 domain, queries `mtr_user_master` by email, and populates `req.user`. It also includes logic to fetch and assign a `location` based on `AGENT` or `ADMIN` roles.
        *   **Local JWT Verification**: Uses `VerifyToken` from `jwtToken.ts` and a `putLocation` helper function to enrich the user object with location data.
    *   **1/8/2026, 5:09:33 PM**: The error handling in `authMiddleware`'s `catch` block was refined to return a specific `HttpError` message: "Your session has expired. Please log in again." for all caught authentication errors, providing a more consistent user experience.

*   **`src\services\UserService.ts`**:
    *   **1/8/2026, 7:50:32 PM**: A major update introduced several user-related services:
        *   `login`: Authenticates users against `mtr_user_master`, checks account status, and generates a JWT using the refactored `createToken` function, sending the token, `authtype`, and token expiry (`exp`) back to the client.
        *   `saveUserPreferences`: Manages user preferences in the `v2_user_details` table, using `ON CONFLICT DO UPDATE` for efficient data handling.
        *   `fetchUserPreferences`: Retrieves user preferences, joining `mtr_user_master` with `v2_user_details` and using `COALESCE` to provide default values.
        *   `saveInviteLog`: Logs user invitations in `v2_user_invite_log` and triggers an email invitation.
        *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company by combining queries from `mtr_user_master` and `v2_user_invite_log`.
        *   `userSettings`: Retrieves specific user settings like `date_format`.
        *   `logoutUser`: Began implementation for user logout (incomplete in the provided log).

**Patterns and Recurring Elements:**

*   **Authentication and Authorization**: There's a strong focus on setting up robust user authentication using JWTs, supporting both local and Auth0-based authentication, and implementing role-based authorization for data access and filtering.
*   **Database Interactions**: Extensive use of direct SQL queries (`SELECT`, `INSERT`, `UPDATE`, `ON CONFLICT DO UPDATE`) via a `query` utility for data persistence and retrieval across multiple services and middleware.
*   **Logging**: `logger.info` and `logger.error` calls are prevalent throughout the codebase, indicating a practice of detailed logging for operational insights and debugging.
*   **JWT Expiry Tuning**: The `jwtToken.ts` file shows a notable pattern of frequent changes to the JWT `expiresIn` value, suggesting active testing, debugging, or policy adjustments related to session duration.
*   **Utility Functions**: The `src\utils\common.ts` file consolidates various utility functions, promoting code reusability for common tasks like date formatting, string sanitization, and complex condition building.

## 3:09:58 PM
The provided log details a series of changes made exclusively to the file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\modules\JwtToken.ts`.

**File-Specific Updates:**
All modifications occurred within the `JwtToken.ts` file, which is responsible for creating and verifying JSON Web Tokens (JWTs) using the `jsonwebtoken` library. The file imports `jwt` and `TokenPayload` and relies on `process.env.JWT_SECRET` for the token's secret key, with a consistent error handling mechanism for undefined secrets. The `VerifyToken` function remained unchanged throughout the log.

**Timestamps of Significant Changes:**
The significant changes revolve around the `expiresIn` option in the `createToken` function:
*   **1/9/2026, 12:52:28 PM:** The `expiresIn` was initially set to `'20s'` (20 seconds).
*   **1/9/2026, 12:56:06 PM:** This was modified to `20` (likely also 20 seconds, but using a number instead of a string format).
*   **1/9/2026, 12:56:22 PM:** The expiration was further reduced to `10` (10 seconds).
*   **1/9/2026, 1:03:55 PM:** The `expiresIn` setting was reverted to its initial string format and value: `'20s'`.
*   **1/9/2026, 1:40:27 PM:** The most significant change occurred here, where the token expiration was substantially increased from `'20s'` to `'7d'` (7 days).

**Patterns or Recurring Elements:**
*   **Consistent Structure:** The overall structure of `createToken` and `VerifyToken` functions, including the import statements, the `process.env.JWT_SECRET` check, and the use of `jwt.sign` and `jwt.verify`, remained constant.
*   **Focus on Expiration:** The recurring pattern is the iterative adjustment of the `expiresIn` property within the `createToken` function, indicating active testing or refinement of the JWT's lifespan. The changes show a progression from very short expiration times (20s, 10s) to a much longer duration (7 days), suggesting an evolution in the intended session or token validity period.
*   **Error Handling:** The explicit `if (!secret) { throw new Error('JWT_SECRET is not defined'); }` check is consistently present in both functions across all log entries, emphasizing robust error handling for missing environment variables.

## 3:10:38 PM
The provided log details code changes across three files, primarily focusing on user authentication and management features.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\jwtToken.ts`**
    *   This file, responsible for JWT token creation and verification, underwent numerous modifications, particularly for the `createToken` function.
    *   **Timestamp 1/9/2026, 11:03:22 AM**: The `createToken` function was changed to return an object `{ token, exp }` instead of just the token string, and the `expiresIn` was set to "50s". Debugging `console.log` statements for the generated token and decoded payload were added.
    *   **Timestamp 1/9/2026, 11:06:57 AM**: This change reverted `createToken` to its simpler form, returning only the token string with `expiresIn: '20s'`, and commented out the more complex version.
    *   **Timestamp 1/9/2026, 11:17:44 AM**: For the version returning `{ token, exp }` (which was active at this time), the `expiresIn` was shortened from "50s" to "10s".
    *   **Timestamp 1/9/2026, 11:41:28 AM**: The `createToken` was again reverted to the simpler string-returning version with `expiresIn: '20s'`.
    *   **Timestamp 1/9/2026, 12:01:35 PM**: The `expiresIn` for the simpler `createToken` was changed to '10s'.
    *   **Timestamp 1/9/2026, 1:12:43 PM**: Briefly, both the simple string-returning `createToken` and the object-returning `createToken` (with `expiresIn: "50s"`) were uncommented, creating a potential redeclaration issue.
    *   **Timestamp 1/9/2026, 1:12:50 PM**: The simpler `createToken` was commented out, resolving the redeclaration, and leaving the object-returning version (with `expiresIn: "50s"`) active.
    *   **Timestamp 1/9/2026, 1:15:04 PM**: The `expiresIn` for the active object-returning `createToken` was set back to "20s".
    *   **Timestamp 1/9/2026, 1:40:42 PM**: The `expiresIn` for the active `createToken` was significantly increased from "20s" to "7d".
    *   The `VerifyToken` function remained consistent throughout these changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   This file primarily handles user-related business logic and database interactions.
    *   **Timestamp 1/9/2026, 11:07:11 AM**: Major new functionalities were introduced: `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. These functions involve `INSERT`, `UPDATE`, and `SELECT` operations on `v2_user_details`, `v2_user_invite_log`, and `mtr_user_master` tables, indicating a comprehensive user profile and invitation system. The `login` function at this point expected `createToken` to return a string.
    *   **Timestamp 1/9/2026, 11:14:58 AM**: The `login` function was updated to destructure `{ token, exp }` from `createToken`, mirroring the change in `jwtToken.ts`. The login response now included `exp` within the user object. Error handling was also made more robust by explicitly catching `any` and providing a default status of 500.
    *   **Timestamp 1/9/2026, 11:32:52 AM**: A `console.log` statement was added to the `login` function for debugging purposes.
    *   **Timestamp 1/9/2026, 11:41:05 AM**: The `login` function was reverted to its earlier state, expecting `createToken` to return a string and omitting `exp` from the response. The error handling was also reverted.
    *   **Timestamp 1/9/2026, 1:13:01 PM**: The `login` function was again updated to expect the `{ token, exp }` return from `createToken` and include `exp` in the response, along with the more robust error handling. The `console.log` from 11:32:52 AM was removed.
    *   Subsequent changes (1:41:36 PM, 1:41:58 PM) were minor, mostly reconfirming the state where `login` destructures `token` and `exp`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\middleware\authMiddleware.ts`**
    *   **Timestamp 1/9/2026, 11:26:04 AM**: A new `authMiddleware` was introduced. This middleware supports two authentication types: Auth0-based and internal JWT.
        *   For Auth0, it dynamically fetches public keys using `jwks-rsa`, verifies the token, and queries `mtr_user_master` to retrieve user details.
        *   For internal JWT, it uses the local `VerifyToken` function.
        *   In both cases, it enriches the `req.user` object with `location` information based on the user's `role` (AGENT or ADMIN), querying `agent_po_account_master` for agents.
        *   Comprehensive error handling and logging (`logger.error`, `console.error`) are integrated.

**Patterns and Recurring Elements:**

*   **JWT Token Management Fluctuations**: There's a clear pattern of continuous refinement and occasional reversion in the `jwtToken.ts` file regarding the `createToken` function's return type and token expiration duration. This suggests ongoing development and testing of the token generation strategy.
*   **Tight Coupling between JWT and User Service**: The `login` function in `UserService.ts` directly reflects the active implementation of `createToken` in `jwtToken.ts`, indicating a strong dependency and requiring synchronized changes.
*   **New User-Centric Features**: A significant block of features for user preferences, invitations, and user listings were added to `UserService.ts`, indicating an expansion of user management capabilities.
*   **Robust Authentication System**: The `authMiddleware.ts` demonstrates a move towards a more sophisticated authentication architecture, supporting external identity providers (Auth0) alongside internal token mechanisms, and integrating role-based logic for user data enrichment.
*   **Extensive Logging and Error Handling**: The widespread use of `logger.info`, `logger.error`, and `console.log` throughout the new and modified code indicates a focus on observability, debugging, and maintaining clear error pathways using `HttpError`.
*   **Direct Database Interactions**: Many of the new features rely heavily on direct SQL queries (`INSERT`, `UPDATE`, `SELECT`) to manage user data, preferences, and invite logs in the PostgreSQL database.

## 3:10:42 PM
The code changes primarily revolve around authentication, auto-logout mechanisms, and UI component enhancements, with frequent debugging console logs. The timestamps consistently fall on January 9, 2026, indicating active development on that day.

### File-Specific Updates:

*   **`src\components\providers\auth-guard.tsx`**
    *   **Timestamp: 1/9/2026, 11:08:12 AM - 11:08:17 AM**: Initial implementation of an `AuthGuard` component to check for user authentication and token expiry. It reads `user` and `token` from `localStorage` and redirects to `/` or `/app` based on validation.
    *   **Timestamp: 1/9/2026, 11:10:16 AM**: Modified token expiry logic to primarily use `localUser?.expiresIn` (milliseconds) and compares it with `Date.now()` (milliseconds), simplifying the expiry check.

*   **`src\services\ApiService.ts`**
    *   **Timestamp: 1/9/2026, 11:10:54 AM**: Introduced a `window.fetch` interceptor to handle `401 Unauthorized` responses. Upon a 401, it logs the event, clears `localStorage`, and redirects to either a V1 base URL (for "auth0" type) or `/login`.
    *   **Timestamp: 1/9/2026, 11:17:07 AM**: A minor cosmetic change, removing an emoji from a console log message.

*   **`src\components\core\layout.tsx`**
    *   **Timestamp: 1/9/2026, 11:12:26 AM - 11:25:01 AM**: Initial `Layout` component that manages user session and selected customer state using Redux and `localStorage`. It includes a basic `isTokenExpired` check which clears local storage and redirects on expiry. Debugging console logs for token expiry were added.
    *   **Timestamp: 1/9/2026, 11:38:41 AM**: Refactored token expiry logic by introducing an internal `getTokenExp` function to decode JWT tokens and extract expiry. The `isTokenExpired` check now uses this function and redirects to `/login` upon expiry.
    *   **Timestamp: 1/9/2026, 11:47:29 AM**: Externalized `isTokenExpired` to `utils/utils.ts` and updated the `useEffect` to use it, clearing all `localStorage` items upon expiry.
    *   **Timestamp: 1/9/2026, 11:53:13 AM - 1:42:43 PM**: Implemented a comprehensive auto-logout timer using `useEffect` and `setTimeout` based on the token's expiry time fetched via `getTokenExp` from `utils/utils.ts`. A dedicated `logout` function was added to manage session cleanup. This section shows repeated cycles of debugging by temporarily hardcoding `remainingTime` to `10` seconds, then reverting it to `exp - now`, and adding numerous console logs to track expiry and remaining time.

*   **`src\utils\utils.ts`**
    *   **Timestamp: 1/9/2026, 11:46:41 AM**: This file was introduced, containing several utility functions: `appDateFormat`, `parseRawString`, `useDateFormate`, `dateFilterHandle`, `showLessText`. Crucially, it defines `getTokenPayload` (to decode JWT tokens) and `isTokenExpired` (to check token validity).
    *   **Timestamp: 1/9/2026, 11:51:21 AM - 11:52:04 AM**: Minor refactoring and some duplication/commenting of `getTokenPayload` and `getTokenExp` definitions, suggesting a process of consolidating/clarifying token utility functions.
    *   **Timestamp: 1/9/2026, 1:02:49 PM**: Cleaned up the utility functions, ensuring single definitions for `getTokenPayload` and `isTokenExpired`. Added console logs for `iat`, `exp`, and `diff` within `getTokenExp`.
    *   **Timestamp: 1/9/2026, 1:05:31 PM**: Temporarily changed `getTokenExp` to return the *duration* (`exp - iat`) rather than the absolute expiry timestamp (`exp`).
    *   **Timestamp: 1/9/2026, 1:10:25 PM**: Reverted `getTokenExp` to correctly return the absolute expiry timestamp (`payload?.exp`).

*   **`src\App.tsx`**
    *   **Timestamp: 1/9/2026, 11:17:25 AM**: Integrated a `useTokenExpiryWatcher` hook for auto-logout.
    *   **Timestamp: 1/9/2026, 11:19:52 AM**: The `useTokenExpiryWatcher` import and call were commented out, indicating a shift in where the auto-logout logic is managed (likely to `layout.tsx`).

*   **`src\main.tsx`**
    *   **Timestamp: 1/9/2026, 11:17:35 AM**: Imported `ApiService.ts`.
    *   **Timestamp: 1/9/2026, 11:19:46 AM**: The import of `ApiService.ts` was commented out.

*   **`src\components\common\dynamicEditable.tsx`**
    *   **Timestamp: 1/9/2026, 2:33:07 PM**: Introduced an `editable` prop to make the `DynamicEditableTable` conditionally editable, affecting input fields, add row, and delete row functionalities.

*   **`src\components\screen\planboard\PlanboardCardView.tsx`**
    *   **Timestamp: 1/9/2026, 2:33:59 PM - 2:34:06 PM**: Minor text correction in the "No Data Available" message.

*   **`src\components\screen\analytics\Charts\BarChart.tsx`, `PieChart.tsx`, `LineChart.tsx`, `StackedBarChart.tsx`**
    *   **Timestamp: 1/9/2026, 2:35:40 PM - 2:45:46 PM**: These chart components initially included their own `Tooltip` for `reportName`. Across multiple commits, this title rendering logic was commented out, suggesting a refactoring to centralize chart title display in a parent component (like `MetricBox`). Debugging console logs were also added and modified in `BarChart.tsx`.

*   **`src\components\screen\analytics\metricBox.tsx`**
    *   **Timestamp: 1/9/2026, 2:40:42 PM - 2:44:20 PM**: Introduced a `chart-wrapper` div to centralize the display of the chart `Tooltip` and the chart component or `NoDataAvailable` message. Added debugging console logs.

*   **`src\components\common\chip-tabs-view.tsx`**
    *   **Timestamp: 1/9/2026, 2:49:03 PM - 2:57:51 PM**: This component underwent several iterative changes to its layout and styling, specifically concerning the positioning and functionality of scroll buttons (`ChevronLeft`, `ChevronRight`) and the overall structure of the scrollable tab area. There were changes to `onChange` prop typing and temporary removal/re-introduction of the "New" button.

*   **`src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **Timestamp: 1/9/2026, 3:00:55 PM - 3:09:08 PM**: Implemented features for dashboard management, including global date filtering (with a custom date range option), PDF export functionality, and dynamic chart view operations (move/resize). It uses `ChipsTabView` for dashboard selection and an `AppDrawer` for custom view creation/management. There was a temporary commenting out and re-enabling of the `PopoverPanel` for the `DateRange` component.

### Patterns and Recurring Elements:

1.  **Authentication and Auto-Logout Logic**: A dominant pattern is the continuous evolution and refinement of authentication (token expiry) and auto-logout features, moving implementation details between `AuthGuard`, `App.tsx`, `Layout.tsx`, and `utils.ts`. This indicates a core security/session management feature under active development.
2.  **Debugging via `console.log`**: Numerous `console.log` statements with distinct prefixes (e.g., `====`, `===layout`, `===bar chart`, `==data==jjj`) appear across files, particularly in `layout.tsx`, `auth-guard.tsx`, and chart components, indicating active debugging during development.
3.  **UI Component Refinement**: Several UI components, notably `chip-tabs-view.tsx` and the analytics chart components, show iterative styling and structural adjustments, often centralizing common elements (like chart titles) or improving responsiveness/usability (like scrollable tabs).
4.  **Date Handling**: Dedicated utility functions in `utils.ts` and integration in components like `AnalyticsToolbar` highlight a focus on flexible date filtering and formatting.