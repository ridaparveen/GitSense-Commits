# Activity Summary for 1/9/2026

## 10:13:21 AM
The code changes on `1/8/2026` reflect an active development session focused on user authentication, authorization, and utility functions within a `t360-backend-v2` project.

**File-Specific Updates:**

*   **`src\services\globalSearch.ts`**:
    *   **1/8/2026, 12:20:50 PM**: The `getGlobalOptions` function was introduced, enabling global search functionality based on `mblno`, `blno`, or `contno` within `mtr_tracking_data`. It applies user-specific filtering conditions via `buildMtrUserCondition` and aggregates `contno` and `fileno` by `mblno`.
    *   **1/8/2026, 12:21:18 PM**: A minor debugging line, `console.log('req.user', req.user);`, was added to the `getGlobalOptions` function.

*   **`src\utils\common.ts`**:
    *   **1/8/2026, 12:26:48 PM**: This file received a substantial update, introducing a suite of utility functions:
        *   `buildHBLUserCondition` and `buildMtrUserCondition`: Functions to generate SQL `WHERE` clauses based on `UserType` roles (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT, ADMIN_V2) for data filtering. `buildMtrUserCondition` includes specific logic for "ZIGI USA, LLC" and other roles, querying related tables for front office or agent accounts.
        *   `getAgentBookingCode`: An asynchronous function to generate unique agent booking codes, managing sequential numbering and database updates in the `agent_bookingno` table.
        *   `sanitizeString`: A utility for handling null/undefined/ "null" string values.
        *   `AppDateFormate`, `formatDate`: Functions for robust date formatting and display, including checks for invalid dates.
        *   `timeAgo`: A function to display time differences in a human-readable format (e.g., "X minutes ago").

*   **`src\common\util\jwtToken.ts`**:
    *   **1/8/2026, 1:12:29 PM**: Initial implementation of `createToken` and `VerifyToken` functions for JWT handling. Tokens were set to expire in '10s'.
    *   **1/8/2026, 3:53:24 PM**: Minor adjustment to `createToken`, using `process.env.JWT_SECRET!` for signing. Expiry remained '10s'.
    *   **1/8/2026, 4:53:18 PM**: The JWT expiry time in `createToken` was increased from '10s' to '20s'.
    *   **1/8/2026, 5:32:45 PM**: A significant change: `createToken`'s expiry was drastically extended from '20s' to '7d' (7 days), and `secret` was used directly for signing.
    *   **1/8/2026, 5:39:52 PM**: The `createToken` function reverted its expiry back to '20s' and changed the signing secret back to `process.env.JWT_SECRET!`, undoing the previous change.
    *   **1/8/2026, 7:47:00 PM**: `createToken` was refactored. The original version was commented out, and a new `createToken` was introduced that now returns an object containing both the `token` string and its `exp` (expiry timestamp). Expiry remained '20s'.
    *   **1/8/2026, 10:33:03 PM**: The `createToken` function's expiry was again reduced, from '20s' back to '10s', while maintaining the new object return structure.

*   **`src\middleware\authMiddleware.ts`**:
    *   **1/8/2026, 1:26:07 PM**: The `authMiddleware` was introduced, handling two distinct authentication flows:
        *   **Auth0 Integration**: Verifies tokens using `jwks-rsa` against an Auth0 domain, queries `mtr_user_master` by email, and populates `req.user`. It also includes logic to fetch and assign a `location` based on `AGENT` or `ADMIN` roles.
        *   **Local JWT Verification**: Uses `VerifyToken` from `jwtToken.ts` and a `putLocation` helper function to enrich the user object with location data.
    *   **1/8/2026, 5:09:33 PM**: The error handling in `authMiddleware`'s `catch` block was refined to return a specific `HttpError` message: "Your session has expired. Please log in again." for all caught authentication errors, providing a more consistent user experience.

*   **`src\services\UserService.ts`**:
    *   **1/8/2026, 7:50:32 PM**: A major update introduced several user-related services:
        *   `login`: Authenticates users against `mtr_user_master`, checks account status, and generates a JWT using the refactored `createToken` function, sending the token, `authtype`, and token expiry (`exp`) back to the client.
        *   `saveUserPreferences`: Manages user preferences in the `v2_user_details` table, using `ON CONFLICT DO UPDATE` for efficient data handling.
        *   `fetchUserPreferences`: Retrieves user preferences, joining `mtr_user_master` with `v2_user_details` and using `COALESCE` to provide default values.
        *   `saveInviteLog`: Logs user invitations in `v2_user_invite_log` and triggers an email invitation.
        *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company by combining queries from `mtr_user_master` and `v2_user_invite_log`.
        *   `userSettings`: Retrieves specific user settings like `date_format`.
        *   `logoutUser`: Began implementation for user logout (incomplete in the provided log).

**Patterns and Recurring Elements:**

*   **Authentication and Authorization**: There's a strong focus on setting up robust user authentication using JWTs, supporting both local and Auth0-based authentication, and implementing role-based authorization for data access and filtering.
*   **Database Interactions**: Extensive use of direct SQL queries (`SELECT`, `INSERT`, `UPDATE`, `ON CONFLICT DO UPDATE`) via a `query` utility for data persistence and retrieval across multiple services and middleware.
*   **Logging**: `logger.info` and `logger.error` calls are prevalent throughout the codebase, indicating a practice of detailed logging for operational insights and debugging.
*   **JWT Expiry Tuning**: The `jwtToken.ts` file shows a notable pattern of frequent changes to the JWT `expiresIn` value, suggesting active testing, debugging, or policy adjustments related to session duration.
*   **Utility Functions**: The `src\utils\common.ts` file consolidates various utility functions, promoting code reusability for common tasks like date formatting, string sanitization, and complex condition building.

## 3:09:58 PM
The provided log details a series of changes made exclusively to the file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\modules\JwtToken.ts`.

**File-Specific Updates:**
All modifications occurred within the `JwtToken.ts` file, which is responsible for creating and verifying JSON Web Tokens (JWTs) using the `jsonwebtoken` library. The file imports `jwt` and `TokenPayload` and relies on `process.env.JWT_SECRET` for the token's secret key, with a consistent error handling mechanism for undefined secrets. The `VerifyToken` function remained unchanged throughout the log.

**Timestamps of Significant Changes:**
The significant changes revolve around the `expiresIn` option in the `createToken` function:
*   **1/9/2026, 12:52:28 PM:** The `expiresIn` was initially set to `'20s'` (20 seconds).
*   **1/9/2026, 12:56:06 PM:** This was modified to `20` (likely also 20 seconds, but using a number instead of a string format).
*   **1/9/2026, 12:56:22 PM:** The expiration was further reduced to `10` (10 seconds).
*   **1/9/2026, 1:03:55 PM:** The `expiresIn` setting was reverted to its initial string format and value: `'20s'`.
*   **1/9/2026, 1:40:27 PM:** The most significant change occurred here, where the token expiration was substantially increased from `'20s'` to `'7d'` (7 days).

**Patterns or Recurring Elements:**
*   **Consistent Structure:** The overall structure of `createToken` and `VerifyToken` functions, including the import statements, the `process.env.JWT_SECRET` check, and the use of `jwt.sign` and `jwt.verify`, remained constant.
*   **Focus on Expiration:** The recurring pattern is the iterative adjustment of the `expiresIn` property within the `createToken` function, indicating active testing or refinement of the JWT's lifespan. The changes show a progression from very short expiration times (20s, 10s) to a much longer duration (7 days), suggesting an evolution in the intended session or token validity period.
*   **Error Handling:** The explicit `if (!secret) { throw new Error('JWT_SECRET is not defined'); }` check is consistently present in both functions across all log entries, emphasizing robust error handling for missing environment variables.