# Activity Summary for 1/9/2026

## 10:13:21 AM
The code changes on `1/8/2026` reflect an active development session focused on user authentication, authorization, and utility functions within a `t360-backend-v2` project.

**File-Specific Updates:**

*   **`src\services\globalSearch.ts`**:
    *   **1/8/2026, 12:20:50 PM**: The `getGlobalOptions` function was introduced, enabling global search functionality based on `mblno`, `blno`, or `contno` within `mtr_tracking_data`. It applies user-specific filtering conditions via `buildMtrUserCondition` and aggregates `contno` and `fileno` by `mblno`.
    *   **1/8/2026, 12:21:18 PM**: A minor debugging line, `console.log('req.user', req.user);`, was added to the `getGlobalOptions` function.

*   **`src\utils\common.ts`**:
    *   **1/8/2026, 12:26:48 PM**: This file received a substantial update, introducing a suite of utility functions:
        *   `buildHBLUserCondition` and `buildMtrUserCondition`: Functions to generate SQL `WHERE` clauses based on `UserType` roles (e.g., ADMIN, CUSTOMER, FRONTOFFICE, AGENT, ADMIN_V2) for data filtering. `buildMtrUserCondition` includes specific logic for "ZIGI USA, LLC" and other roles, querying related tables for front office or agent accounts.
        *   `getAgentBookingCode`: An asynchronous function to generate unique agent booking codes, managing sequential numbering and database updates in the `agent_bookingno` table.
        *   `sanitizeString`: A utility for handling null/undefined/ "null" string values.
        *   `AppDateFormate`, `formatDate`: Functions for robust date formatting and display, including checks for invalid dates.
        *   `timeAgo`: A function to display time differences in a human-readable format (e.g., "X minutes ago").

*   **`src\common\util\jwtToken.ts`**:
    *   **1/8/2026, 1:12:29 PM**: Initial implementation of `createToken` and `VerifyToken` functions for JWT handling. Tokens were set to expire in '10s'.
    *   **1/8/2026, 3:53:24 PM**: Minor adjustment to `createToken`, using `process.env.JWT_SECRET!` for signing. Expiry remained '10s'.
    *   **1/8/2026, 4:53:18 PM**: The JWT expiry time in `createToken` was increased from '10s' to '20s'.
    *   **1/8/2026, 5:32:45 PM**: A significant change: `createToken`'s expiry was drastically extended from '20s' to '7d' (7 days), and `secret` was used directly for signing.
    *   **1/8/2026, 5:39:52 PM**: The `createToken` function reverted its expiry back to '20s' and changed the signing secret back to `process.env.JWT_SECRET!`, undoing the previous change.
    *   **1/8/2026, 7:47:00 PM**: `createToken` was refactored. The original version was commented out, and a new `createToken` was introduced that now returns an object containing both the `token` string and its `exp` (expiry timestamp). Expiry remained '20s'.
    *   **1/8/2026, 10:33:03 PM**: The `createToken` function's expiry was again reduced, from '20s' back to '10s', while maintaining the new object return structure.

*   **`src\middleware\authMiddleware.ts`**:
    *   **1/8/2026, 1:26:07 PM**: The `authMiddleware` was introduced, handling two distinct authentication flows:
        *   **Auth0 Integration**: Verifies tokens using `jwks-rsa` against an Auth0 domain, queries `mtr_user_master` by email, and populates `req.user`. It also includes logic to fetch and assign a `location` based on `AGENT` or `ADMIN` roles.
        *   **Local JWT Verification**: Uses `VerifyToken` from `jwtToken.ts` and a `putLocation` helper function to enrich the user object with location data.
    *   **1/8/2026, 5:09:33 PM**: The error handling in `authMiddleware`'s `catch` block was refined to return a specific `HttpError` message: "Your session has expired. Please log in again." for all caught authentication errors, providing a more consistent user experience.

*   **`src\services\UserService.ts`**:
    *   **1/8/2026, 7:50:32 PM**: A major update introduced several user-related services:
        *   `login`: Authenticates users against `mtr_user_master`, checks account status, and generates a JWT using the refactored `createToken` function, sending the token, `authtype`, and token expiry (`exp`) back to the client.
        *   `saveUserPreferences`: Manages user preferences in the `v2_user_details` table, using `ON CONFLICT DO UPDATE` for efficient data handling.
        *   `fetchUserPreferences`: Retrieves user preferences, joining `mtr_user_master` with `v2_user_details` and using `COALESCE` to provide default values.
        *   `saveInviteLog`: Logs user invitations in `v2_user_invite_log` and triggers an email invitation.
        *   `fetchAllCompanyUser`: Fetches both active registered users and pending invited users for a specific company by combining queries from `mtr_user_master` and `v2_user_invite_log`.
        *   `userSettings`: Retrieves specific user settings like `date_format`.
        *   `logoutUser`: Began implementation for user logout (incomplete in the provided log).

**Patterns and Recurring Elements:**

*   **Authentication and Authorization**: There's a strong focus on setting up robust user authentication using JWTs, supporting both local and Auth0-based authentication, and implementing role-based authorization for data access and filtering.
*   **Database Interactions**: Extensive use of direct SQL queries (`SELECT`, `INSERT`, `UPDATE`, `ON CONFLICT DO UPDATE`) via a `query` utility for data persistence and retrieval across multiple services and middleware.
*   **Logging**: `logger.info` and `logger.error` calls are prevalent throughout the codebase, indicating a practice of detailed logging for operational insights and debugging.
*   **JWT Expiry Tuning**: The `jwtToken.ts` file shows a notable pattern of frequent changes to the JWT `expiresIn` value, suggesting active testing, debugging, or policy adjustments related to session duration.
*   **Utility Functions**: The `src\utils\common.ts` file consolidates various utility functions, promoting code reusability for common tasks like date formatting, string sanitization, and complex condition building.

## 3:09:58 PM
The provided log details a series of changes made exclusively to the file `c:\Users\ridap\OneDrive\Documents\T360_Api\t360-backend\src\modules\JwtToken.ts`.

**File-Specific Updates:**
All modifications occurred within the `JwtToken.ts` file, which is responsible for creating and verifying JSON Web Tokens (JWTs) using the `jsonwebtoken` library. The file imports `jwt` and `TokenPayload` and relies on `process.env.JWT_SECRET` for the token's secret key, with a consistent error handling mechanism for undefined secrets. The `VerifyToken` function remained unchanged throughout the log.

**Timestamps of Significant Changes:**
The significant changes revolve around the `expiresIn` option in the `createToken` function:
*   **1/9/2026, 12:52:28 PM:** The `expiresIn` was initially set to `'20s'` (20 seconds).
*   **1/9/2026, 12:56:06 PM:** This was modified to `20` (likely also 20 seconds, but using a number instead of a string format).
*   **1/9/2026, 12:56:22 PM:** The expiration was further reduced to `10` (10 seconds).
*   **1/9/2026, 1:03:55 PM:** The `expiresIn` setting was reverted to its initial string format and value: `'20s'`.
*   **1/9/2026, 1:40:27 PM:** The most significant change occurred here, where the token expiration was substantially increased from `'20s'` to `'7d'` (7 days).

**Patterns or Recurring Elements:**
*   **Consistent Structure:** The overall structure of `createToken` and `VerifyToken` functions, including the import statements, the `process.env.JWT_SECRET` check, and the use of `jwt.sign` and `jwt.verify`, remained constant.
*   **Focus on Expiration:** The recurring pattern is the iterative adjustment of the `expiresIn` property within the `createToken` function, indicating active testing or refinement of the JWT's lifespan. The changes show a progression from very short expiration times (20s, 10s) to a much longer duration (7 days), suggesting an evolution in the intended session or token validity period.
*   **Error Handling:** The explicit `if (!secret) { throw new Error('JWT_SECRET is not defined'); }` check is consistently present in both functions across all log entries, emphasizing robust error handling for missing environment variables.

## 3:10:38 PM
The provided log details code changes across three files, primarily focusing on user authentication and management features.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\jwtToken.ts`**
    *   This file, responsible for JWT token creation and verification, underwent numerous modifications, particularly for the `createToken` function.
    *   **Timestamp 1/9/2026, 11:03:22 AM**: The `createToken` function was changed to return an object `{ token, exp }` instead of just the token string, and the `expiresIn` was set to "50s". Debugging `console.log` statements for the generated token and decoded payload were added.
    *   **Timestamp 1/9/2026, 11:06:57 AM**: This change reverted `createToken` to its simpler form, returning only the token string with `expiresIn: '20s'`, and commented out the more complex version.
    *   **Timestamp 1/9/2026, 11:17:44 AM**: For the version returning `{ token, exp }` (which was active at this time), the `expiresIn` was shortened from "50s" to "10s".
    *   **Timestamp 1/9/2026, 11:41:28 AM**: The `createToken` was again reverted to the simpler string-returning version with `expiresIn: '20s'`.
    *   **Timestamp 1/9/2026, 12:01:35 PM**: The `expiresIn` for the simpler `createToken` was changed to '10s'.
    *   **Timestamp 1/9/2026, 1:12:43 PM**: Briefly, both the simple string-returning `createToken` and the object-returning `createToken` (with `expiresIn: "50s"`) were uncommented, creating a potential redeclaration issue.
    *   **Timestamp 1/9/2026, 1:12:50 PM**: The simpler `createToken` was commented out, resolving the redeclaration, and leaving the object-returning version (with `expiresIn: "50s"`) active.
    *   **Timestamp 1/9/2026, 1:15:04 PM**: The `expiresIn` for the active object-returning `createToken` was set back to "20s".
    *   **Timestamp 1/9/2026, 1:40:42 PM**: The `expiresIn` for the active `createToken` was significantly increased from "20s" to "7d".
    *   The `VerifyToken` function remained consistent throughout these changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\UserService.ts`**
    *   This file primarily handles user-related business logic and database interactions.
    *   **Timestamp 1/9/2026, 11:07:11 AM**: Major new functionalities were introduced: `saveUserPreferences`, `fetchUserPreferences`, `saveInviteLog`, `fetchAllCompanyUser`, and `userSettings`. These functions involve `INSERT`, `UPDATE`, and `SELECT` operations on `v2_user_details`, `v2_user_invite_log`, and `mtr_user_master` tables, indicating a comprehensive user profile and invitation system. The `login` function at this point expected `createToken` to return a string.
    *   **Timestamp 1/9/2026, 11:14:58 AM**: The `login` function was updated to destructure `{ token, exp }` from `createToken`, mirroring the change in `jwtToken.ts`. The login response now included `exp` within the user object. Error handling was also made more robust by explicitly catching `any` and providing a default status of 500.
    *   **Timestamp 1/9/2026, 11:32:52 AM**: A `console.log` statement was added to the `login` function for debugging purposes.
    *   **Timestamp 1/9/2026, 11:41:05 AM**: The `login` function was reverted to its earlier state, expecting `createToken` to return a string and omitting `exp` from the response. The error handling was also reverted.
    *   **Timestamp 1/9/2026, 1:13:01 PM**: The `login` function was again updated to expect the `{ token, exp }` return from `createToken` and include `exp` in the response, along with the more robust error handling. The `console.log` from 11:32:52 AM was removed.
    *   Subsequent changes (1:41:36 PM, 1:41:58 PM) were minor, mostly reconfirming the state where `login` destructures `token` and `exp`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\middleware\authMiddleware.ts`**
    *   **Timestamp 1/9/2026, 11:26:04 AM**: A new `authMiddleware` was introduced. This middleware supports two authentication types: Auth0-based and internal JWT.
        *   For Auth0, it dynamically fetches public keys using `jwks-rsa`, verifies the token, and queries `mtr_user_master` to retrieve user details.
        *   For internal JWT, it uses the local `VerifyToken` function.
        *   In both cases, it enriches the `req.user` object with `location` information based on the user's `role` (AGENT or ADMIN), querying `agent_po_account_master` for agents.
        *   Comprehensive error handling and logging (`logger.error`, `console.error`) are integrated.

**Patterns and Recurring Elements:**

*   **JWT Token Management Fluctuations**: There's a clear pattern of continuous refinement and occasional reversion in the `jwtToken.ts` file regarding the `createToken` function's return type and token expiration duration. This suggests ongoing development and testing of the token generation strategy.
*   **Tight Coupling between JWT and User Service**: The `login` function in `UserService.ts` directly reflects the active implementation of `createToken` in `jwtToken.ts`, indicating a strong dependency and requiring synchronized changes.
*   **New User-Centric Features**: A significant block of features for user preferences, invitations, and user listings were added to `UserService.ts`, indicating an expansion of user management capabilities.
*   **Robust Authentication System**: The `authMiddleware.ts` demonstrates a move towards a more sophisticated authentication architecture, supporting external identity providers (Auth0) alongside internal token mechanisms, and integrating role-based logic for user data enrichment.
*   **Extensive Logging and Error Handling**: The widespread use of `logger.info`, `logger.error`, and `console.log` throughout the new and modified code indicates a focus on observability, debugging, and maintaining clear error pathways using `HttpError`.
*   **Direct Database Interactions**: Many of the new features rely heavily on direct SQL queries (`INSERT`, `UPDATE`, `SELECT`) to manage user data, preferences, and invite logs in the PostgreSQL database.