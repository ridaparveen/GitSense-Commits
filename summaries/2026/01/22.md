# Activity Summary for 1/22/2026

## 11:40:36 AM
Over the period from January 19, 2026, to January 21, 2026, development activity focused on enhancing analytics and reporting capabilities within the T360-V2 backend. Key updates involved refining SQL query generation for various reports, introducing new Air-related analytics, and improving the framework for managing and displaying these reports.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp: 1/19/2026, 6:44:58 PM**
        This file defines `bookingQueryBuilder`, a core function for constructing SQL queries related to booking and departure analytics. It supports various report types such as "Booking Date to Actual Departure" (including MBL-wise and Stacked Bar variants), dynamically setting `customizer` properties (e.g., `dateRange`, `calType`, `dateColumns`, `chartType`). Queries consistently join `mtr_tracking_data` and `agent_booking_entry`, applying filters for company name and date ranges, and calculating day differences.
    *   *Multiple subsequent timestamps (1/19/2026, 7:29:32 PM; 1/21/2026, 4:37:17 PM; 1/21/2026, 4:42:49 PM; 1/21/2026, 4:45:12 PM; 1/21/2026, 4:46:26 PM; 1/21/2026, 4:48:08 PM; 1/21/2026, 7:44:20 PM; 1/21/2026, 7:46:44 PM)* show no semantic code changes, suggesting frequent saves or minor, non-committal modifications. The core functionality remained stable during this period.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\cbmService.ts`**
    *   **Timestamp: 1/20/2026, 5:28:09 PM**
        The `getCBMReports` function was updated to generate SQL queries for CBM (Cubic Meter) reports. It dynamically builds queries based on `group_by_column` (e.g., `country_of_origin`, `country_of_discharge`) and includes logic to join with `portmaster` for country-based aggregation. It also handles general CBM aggregation, including replacing specific port names and applying company and date filters. The function uses `getColumnsByCategory` to define which columns are relevant for the report, ignoring a comprehensive list of irrelevant fields and ensuring `cbm` and `departure_date` are included.
    *   **Timestamp: 1/20/2026, 5:28:35 PM**
        A minor debugging `console.log` statement was added to print the generated SQL `mainQuery`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Timestamp: 1/21/2026, 11:16:16 AM**
        This file handles the generation of SQL queries for exporting data based on various report names. It includes a `getMonthValue` helper for date parsing and the `bookingQuery` function which constructs specific SQL statements for "Booking Date to Actual Departure", "Booking Date to Estimated Departure", and "Booking Date to POD Arrival", along with their MBL-wise and Stacked Bar variations. The queries feature conditional logic for filtering by month, week, or quarter when `stackedExport` is enabled, and group results by day differences for stacked bar charts. Notably, the "Booking Date to POD Arrival (Stacked Bar)" query added a filter `m.t49_vessel_actualdeparted_date IS NOT NULL`.
    *   *Multiple subsequent timestamps (1/21/2026, 11:22:42 AM; 1/21/2026, 1:01:30 PM; 1/21/2026, 3:26:28 PM; 1/21/2026, 4:40:17 PM; 1/21/2026, 4:40:50 PM; 1/21/2026, 6:16:15 PM; 1/21/2026, 6:17:07 PM; 1/21/2026, 7:37:23 PM; 1/21/2026, 7:40:24 PM)* indicate no semantic code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\User.ts`**
    *   **Timestamp: 1/21/2026, 1:02:38 PM**
        The `UserType` interface was expanded to include `CompanyName` (type `any`) and an optional `location` field. The `UserRole` enum was updated to include `ADMIN_V2`. Validation and object creation utilities (`parseUser`, `__new__`, `test`) were retained.

*   **`c:\Users\ridap\.dbclient\storage\1747201553765@@127.0.0.1@5432@Rida_Database@public\public.sql`**
    *   **Timestamp: 1/21/2026, 1:14:04 PM**
        This SQL log shows various `SELECT` statements for fetching data from `dashboards`, `metrics`, and `mtr_tracking_data` tables. A significant entry is an `INSERT` statement for a new metric: `('Total Shipments Air Wise','/analytics/Tables/tableData?type=TotalShipmentAirWise','Air Metrics','Air_Wise')`. This indicates the introduction of a new "Air Wise" analytics category. The log also contains complex `WITH` clause queries calculating average transit times and performance metrics for specific companies, grouped by country of origin and voyage.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**
    *   **Timestamp: 1/21/2026, 1:16:07 PM**
        The analytics service was updated to support new reporting categories. The `getMetricList` function was enhanced to categorize metrics into `airWiseGroups` in addition to existing `containerWiseGroups` and `mblWiseGroups`, using the `filter_by` attribute. Functions for managing dashboard endpoints (`dashboardEndPointList`), saving report sequences (`saveSequence`), and saving metric widget sizes (`saveSize`) were also present and likely maintained/used in this version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamp: 1/21/2026, 1:33:09 PM**
        New API endpoints were defined under the `/analytics` base path, including `/dashboardEndPoints`, `/metricsList`, `/excelExport`, `/save-sequence`, `/save_size`, `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`. A new base path for `/co2emission` with a `/get` endpoint was also added, indicating expansion of analytics features.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\air.query.ts`**
    *   **Timestamp: 1/21/2026, 1:33:53 PM**
        Initial commit of `airQueryBuilder`, which strangely included chassis-related query logic for "Averagechassisuseddays" and "ChassisPUdateVsFinalDeliveryDate" reports, despite the file name suggesting air-specific queries.
    *   **Timestamp: 1/21/2026, 2:15:39 PM**
        Added core logic for `type === "TotalShipmentAirWise"`, which queries `mtr_air_data` to count distinct `awb_number`s. This change correctly started to implement air freight specific analytics. The existing chassis-related reports were still present.
    *   **Timestamp: 1/21/2026, 2:16:49 PM**
        Refined `TotalShipmentAirWise` logic by explicitly setting `customizer.booking` and `customizer.mblwise` to `false`. Expanded the `ignore` list for `getColumnsByCategory` with numerous tracking-related columns.
    *   *Intermediate timestamps (1/21/2026, 2:16:57 PM to 1/21/2026, 2:55:57 PM)* show debugging-related `console.log` additions, temporary commenting out of data aggregation, and adjustments to `reportName` decoding.
    *   **Timestamp: 1/21/2026, 2:57:41 PM**
        **Major refactoring**: All chassis-related query logic was removed, making `airQueryBuilder` solely focused on "TotalShipmentAirWise". The data aggregation (`analysticsData.rows.push`) was re-enabled, and the function was updated to return `analysticsData` directly, aligning its behavior with `generalQueryBuilder`. Robust handling for division by zero in percentage calculation was introduced. The `ignore` list for `getColumnsByCategory` was significantly expanded to exclude most common tracking data columns.
    *   **Timestamp: 1/21/2026, 3:18:27 PM & 1/21/2026, 3:20:38 PM**
        Further expanded the `ignore` list in `getColumnsByCategory` to include almost all date-related and shipment detail columns, ensuring a very focused selection for air reports.
    *   **Timestamp: 1/21/2026, 3:48:13 PM & 1/21/2026, 3:55:06 PM**
        An anomaly appeared with a duplicated `if (type === "TotalShipmentAirWise")` block, where the second block contained a CBM calculation query (likely intended for a different report type, but incorrectly triggered by the same `type`). This suggests an incomplete or mismanaged addition of another air report functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\tableService.ts`**
    *   **Timestamp: 1/21/2026, 1:35:42 PM**
        This file's `getTableDataReports` function acts as a central dispatcher for analytics reports. It calls various `*QueryBuilder` functions (chassis, booking, container, departure, general) based on the `type` parameter from the request. It fetches user and company information using `getUserObject`.
    *   **Timestamp: 1/21/2026, 1:38:12 PM**
        `airQueryBuilder` was imported, and a new `else if` block was added. Initially, this block incorrectly routed `TotalShipmentsMblWise` to `airQueryBuilder`, creating a conflict.
    *   **Timestamp: 1/21/2026, 2:07:22 PM**
        The `else if` condition was corrected to `type === "TotalShipmentAirWise"`, properly routing air shipment requests to the `airQueryBuilder`.
    *   **Timestamp: 1/21/2026, 3:09:20 PM**
        No further semantic changes were observed in this file.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Timestamp: 1/21/2026, 3:21:18 PM**
        This utility file provides several helper functions for analytics. `defaultDateRange` gives a default date range. `replaceValueInQuery` handles specific column value replacements. `getUserObject` retrieves user context. `getFilterQueryByDisplayValue` generates dynamic SQL clauses for grouping and ordering by month, week, or quarter. `getExcelSelectedColumns` defines which columns to select for Excel exports, with special handling for certain report types (e.g., "Cargo-Ready Date to ETD", "BL Release KPI"). `dateFilterOnExport` normalizes and filters date fields, setting invalid dates to `null` and formatting valid ones to 'MM/DD/YYYY'. A comprehensive `EXCEL_EXPORT_COLUMNS` array lists all available fields for export.
    *   **Timestamp: 1/21/2026, 3:23:52 PM**
        No semantic code changes were observed.

**Patterns and Recurring Elements:**

1.  **Modular Query Builders:** The system uses distinct `*QueryBuilder` functions (e.g., `bookingQueryBuilder`, `chassisQueryBuilder`, `airQueryBuilder`) to encapsulate SQL generation logic for different analytics categories.
2.  **Dynamic Customization:** A `customizer` object is consistently passed and modified to configure report display, including `dateRange`, `calType`, `dateColumns`, `booking` (flag for booking reports), `mblwise` (flag for MBL-wise reports), and `chartType`.
3.  **`getColumnsByCategory` Usage:** The `getColumnsByCategory` utility is widely used to dynamically fetch a curated list of columns for each report, often employing extensive `ignore` lists to filter out irrelevant fields and `must` lists for essential ones.
4.  **Company and Date Range Filtering:** Nearly all SQL queries include common `WHERE` clauses to filter data by a list of company names (`LOWER(account_name) IN (${companyList})`) and a date range for `departure_date`.
5.  **SQL `DISTINCT ON` and Aggregation:** Many queries use `DISTINCT ON` clauses (often on combinations of `voyage`, `contno`, `t49_cont_type`) and aggregate functions (`SUM`, `AVG`, `COUNT`) to produce summarized metrics, frequently calculating day differences between dates.
6.  **Percentage Calculation:** A common final step in many queries involves calculating a percentage value for each entity relative to a `max_total` or `max_value`, ensuring proper handling of zero denominators.
7.  **Date Handling and Formatting:** The `analytics.ts` utility demonstrates a clear pattern for validating and formatting date fields, specifically addressing database-specific "empty" date values like '0001-01-01 00:00:00 BC' and formatting valid dates for consistent presentation.
8.  **Debugging Practices:** The presence and subsequent removal/modification of numerous `console.log` statements in `air.query.ts` indicate an active debugging process during the integration of new analytics features.

## 1:40:25 PM
The changes observed across the provided logs indicate active development within the analytics module of the `t360-frontend-v2` project, focusing on custom view management, dashboard display, and state consistency.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\custom-view\ViewContainer.tsx`**
    *   **1/20/2026, 1:49:22 PM:** The component initially supported "Container Wise" and "MBL Wise" views, handling state and data initialization for these two categories.
    *   **1/21/2026, 12:55:46 PM - 1/21/2026, 1:21:49 PM:** A new "AIR Wise" view type was progressively integrated.
        *   The `selectedTab` state was updated to include `"airWise"` in its possible types.
        *   UI rendering logic was refactored from a ternary operator to multiple conditional `&&` statements to explicitly allow for rendering `TreeViewContainer` based on `selectedTab` for "containerWise", "mblWise", and "airWise" data.
        *   The `initializeCheckedMetrics` function was updated to iterate over `["containerWise", "mblWise", "airWise"]`, ensuring metrics for the new "AIR Wise" category are initialized.
        *   Finally, the `tabData` array, which defines the options for the `RadioNav` component, was updated to include `{ label: "AIR Wise", value: "airWise" }`, making the new view type selectable in the UI.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\components\screen\analytics\AnalyticsToolbar.tsx`**
    *   **1/20/2026, 1:50:39 PM:** The toolbar displayed a "Manage View" button based on `selectedDashobard` not being "Default" or `"_Default_"`. The `ChipsTabView` component mapped `"_Default_"` to "Default" for display.
    *   **1/20/2026, 6:38:07 PM - 1/20/2026, 6:38:27 PM:** The condition for showing the "Manage View" button was adjusted to consistently check `toolState?.selectedDashobard !== "Default"` (effectively `selectedDashobard !== "Default" && selectedDashobard !== "Default"`), removing the `"_Default_"` identifier. Similarly, the `ChipsTabView` mapping was simplified to `item === "Default" ? "Default" : item`. These changes reflect a standardization of the "Default" dashboard naming convention.
    *   **1/21/2026, 1:19:45 PM:** A `console.log` statement for `showDrawer` was added.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\store\fretures\analytics-slice.ts`**
    *   **1/20/2026, 1:56:23 PM:** The initial state for `selectedDashobard` was `"_Default_"`, and the `setDashboard` reducer included logic to handle `"_Default_"` values.
    *   **1/20/2026, 1:57:02 PM - 1/20/2026, 6:37:08 PM:** The `initialState.selectedDashobard` was changed to `"Default"`. Subsequent updates in the `setDashboard` reducer aligned the logic to use `"Default"` instead of `"_Default_"` when setting the `selectedDashobard` or populating the `dashboards` array.
    *   **1/20/2026, 6:39:02 PM:** The `setDashboard` reducer was fully updated to consistently use `"Default"` instead of `"_Default_"` in its conditional checks and state modifications, completing the standardization of the default dashboard identifier.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\data\options\global.ts`**
    *   **1/20/2026, 6:41:28 PM:** This file primarily defines various application-wide options and constants, such as `SHIPMENT_STATUS`, `AIR_SHIPMENT_STATUS`, `REPORTS_STATUS`, `TEAM_MENBER_ROLE`, `DATE_FILTER_OPTIONS`, etc. There is only one entry for this file, indicating it was defined or updated at this point.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-frontend-v2\src\config\analytics.ts`**
    *   **1/21/2026, 2:31:38 PM - 1/22/2026, 12:21:27 PM:** This file defines configurations specific to analytics, including `DEFAULT_ANALYTICS_ENDPOINTS`, `EXCEL_EXPORT_COLUMNS` for data export, and `ANALYTICS_REPORT_HEADER` which specifies headers for various reports. No functional changes were observed between the two timestamps for this file, suggesting minor saves or non-functional updates.

**Timestamps of Significant Changes:**

*   **1/20/2026 (afternoon):** Initial codebase for analytics components (`ViewContainer.tsx`, `AnalyticsToolbar.tsx`, `analytics-slice.ts`) shows a working state with "Container Wise" and "MBL Wise" views, and `"_Default_"` as the default dashboard identifier.
*   **1/20/2026 (evening):** A rapid series of updates across `analytics-slice.ts` and `AnalyticsToolbar.tsx` (between 1:57:02 PM and 6:39:02 PM) to standardize the "Default" dashboard naming convention, migrating from `"_Default_"` to `"Default"`.
*   **1/21/2026 (morning to early afternoon):** A phased introduction of the "AIR Wise" view type in `ViewContainer.tsx` (between 12:55:46 PM and 1:21:49 PM), including state updates, UI adjustments, and data initialization logic.

**Patterns or Recurring Elements:**

*   **Default Dashboard Standardization:** There's a clear pattern of standardizing the naming convention for the "Default" dashboard from `"_Default_"` to `"Default"` across the Redux slice and UI components (`analytics-slice.ts`, `AnalyticsToolbar.tsx`). This ensures consistency in identifying the default view.
*   **Modular Feature Development:** The introduction of the "AIR Wise" view in `ViewContainer.tsx` demonstrates a modular approach, where changes are introduced step-by-step: first updating the underlying data structures/types, then the rendering logic, and finally the user-facing selection options.
*   **Analytics Feature Focus:** All changes are concentrated within files related to the analytics dashboard, suggesting ongoing enhancements and new feature additions to the analytics capabilities of the application.
*   **Redux for State Management:** The `analytics-slice.ts` file highlights the use of Redux Toolkit for managing the complex state of the analytics dashboard, including filters, selected dashboards, and metrics.
*   **Configuration-driven UI:** The `global.ts` and `analytics.ts` files serve as central configuration points, defining static options and report structures that drive parts of the analytics UI and data processing.