# Activity Summary for 1/22/2026

## 11:40:36 AM
Over the period from January 19, 2026, to January 21, 2026, development activity focused on enhancing analytics and reporting capabilities within the T360-V2 backend. Key updates involved refining SQL query generation for various reports, introducing new Air-related analytics, and improving the framework for managing and displaying these reports.

**File-Specific Updates:**

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\booking.query.ts`**
    *   **Timestamp: 1/19/2026, 6:44:58 PM**
        This file defines `bookingQueryBuilder`, a core function for constructing SQL queries related to booking and departure analytics. It supports various report types such as "Booking Date to Actual Departure" (including MBL-wise and Stacked Bar variants), dynamically setting `customizer` properties (e.g., `dateRange`, `calType`, `dateColumns`, `chartType`). Queries consistently join `mtr_tracking_data` and `agent_booking_entry`, applying filters for company name and date ranges, and calculating day differences.
    *   *Multiple subsequent timestamps (1/19/2026, 7:29:32 PM; 1/21/2026, 4:37:17 PM; 1/21/2026, 4:42:49 PM; 1/21/2026, 4:45:12 PM; 1/21/2026, 4:46:26 PM; 1/21/2026, 4:48:08 PM; 1/21/2026, 7:44:20 PM; 1/21/2026, 7:46:44 PM)* show no semantic code changes, suggesting frequent saves or minor, non-committal modifications. The core functionality remained stable during this period.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\cbmService.ts`**
    *   **Timestamp: 1/20/2026, 5:28:09 PM**
        The `getCBMReports` function was updated to generate SQL queries for CBM (Cubic Meter) reports. It dynamically builds queries based on `group_by_column` (e.g., `country_of_origin`, `country_of_discharge`) and includes logic to join with `portmaster` for country-based aggregation. It also handles general CBM aggregation, including replacing specific port names and applying company and date filters. The function uses `getColumnsByCategory` to define which columns are relevant for the report, ignoring a comprehensive list of irrelevant fields and ensuring `cbm` and `departure_date` are included.
    *   **Timestamp: 1/20/2026, 5:28:35 PM**
        A minor debugging `console.log` statement was added to print the generated SQL `mainQuery`.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\export.query.ts`**
    *   **Timestamp: 1/21/2026, 11:16:16 AM**
        This file handles the generation of SQL queries for exporting data based on various report names. It includes a `getMonthValue` helper for date parsing and the `bookingQuery` function which constructs specific SQL statements for "Booking Date to Actual Departure", "Booking Date to Estimated Departure", and "Booking Date to POD Arrival", along with their MBL-wise and Stacked Bar variations. The queries feature conditional logic for filtering by month, week, or quarter when `stackedExport` is enabled, and group results by day differences for stacked bar charts. Notably, the "Booking Date to POD Arrival (Stacked Bar)" query added a filter `m.t49_vessel_actualdeparted_date IS NOT NULL`.
    *   *Multiple subsequent timestamps (1/21/2026, 11:22:42 AM; 1/21/2026, 1:01:30 PM; 1/21/2026, 3:26:28 PM; 1/21/2026, 4:40:17 PM; 1/21/2026, 4:40:50 PM; 1/21/2026, 6:16:15 PM; 1/21/2026, 6:17:07 PM; 1/21/2026, 7:37:23 PM; 1/21/2026, 7:40:24 PM)* indicate no semantic code changes.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\models\User.ts`**
    *   **Timestamp: 1/21/2026, 1:02:38 PM**
        The `UserType` interface was expanded to include `CompanyName` (type `any`) and an optional `location` field. The `UserRole` enum was updated to include `ADMIN_V2`. Validation and object creation utilities (`parseUser`, `__new__`, `test`) were retained.

*   **`c:\Users\ridap\.dbclient\storage\1747201553765@@127.0.0.1@5432@Rida_Database@public\public.sql`**
    *   **Timestamp: 1/21/2026, 1:14:04 PM**
        This SQL log shows various `SELECT` statements for fetching data from `dashboards`, `metrics`, and `mtr_tracking_data` tables. A significant entry is an `INSERT` statement for a new metric: `('Total Shipments Air Wise','/analytics/Tables/tableData?type=TotalShipmentAirWise','Air Metrics','Air_Wise')`. This indicates the introduction of a new "Air Wise" analytics category. The log also contains complex `WITH` clause queries calculating average transit times and performance metrics for specific companies, grouped by country of origin and voyage.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\coreMetricService.ts`**
    *   **Timestamp: 1/21/2026, 1:16:07 PM**
        The analytics service was updated to support new reporting categories. The `getMetricList` function was enhanced to categorize metrics into `airWiseGroups` in addition to existing `containerWiseGroups` and `mblWiseGroups`, using the `filter_by` attribute. Functions for managing dashboard endpoints (`dashboardEndPointList`), saving report sequences (`saveSequence`), and saving metric widget sizes (`saveSize`) were also present and likely maintained/used in this version.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\constants\Paths.ts`**
    *   **Timestamp: 1/21/2026, 1:33:09 PM**
        New API endpoints were defined under the `/analytics` base path, including `/dashboardEndPoints`, `/metricsList`, `/excelExport`, `/save-sequence`, `/save_size`, `/cbm`, `/kgs`, `/teu`, `/containers`, `/transit`, and `/Tables/tableData`. A new base path for `/co2emission` with a `/get` endpoint was also added, indicating expansion of analytics features.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\common\util\air.query.ts`**
    *   **Timestamp: 1/21/2026, 1:33:53 PM**
        Initial commit of `airQueryBuilder`, which strangely included chassis-related query logic for "Averagechassisuseddays" and "ChassisPUdateVsFinalDeliveryDate" reports, despite the file name suggesting air-specific queries.
    *   **Timestamp: 1/21/2026, 2:15:39 PM**
        Added core logic for `type === "TotalShipmentAirWise"`, which queries `mtr_air_data` to count distinct `awb_number`s. This change correctly started to implement air freight specific analytics. The existing chassis-related reports were still present.
    *   **Timestamp: 1/21/2026, 2:16:49 PM**
        Refined `TotalShipmentAirWise` logic by explicitly setting `customizer.booking` and `customizer.mblwise` to `false`. Expanded the `ignore` list for `getColumnsByCategory` with numerous tracking-related columns.
    *   *Intermediate timestamps (1/21/2026, 2:16:57 PM to 1/21/2026, 2:55:57 PM)* show debugging-related `console.log` additions, temporary commenting out of data aggregation, and adjustments to `reportName` decoding.
    *   **Timestamp: 1/21/2026, 2:57:41 PM**
        **Major refactoring**: All chassis-related query logic was removed, making `airQueryBuilder` solely focused on "TotalShipmentAirWise". The data aggregation (`analysticsData.rows.push`) was re-enabled, and the function was updated to return `analysticsData` directly, aligning its behavior with `generalQueryBuilder`. Robust handling for division by zero in percentage calculation was introduced. The `ignore` list for `getColumnsByCategory` was significantly expanded to exclude most common tracking data columns.
    *   **Timestamp: 1/21/2026, 3:18:27 PM & 1/21/2026, 3:20:38 PM**
        Further expanded the `ignore` list in `getColumnsByCategory` to include almost all date-related and shipment detail columns, ensuring a very focused selection for air reports.
    *   **Timestamp: 1/21/2026, 3:48:13 PM & 1/21/2026, 3:55:06 PM**
        An anomaly appeared with a duplicated `if (type === "TotalShipmentAirWise")` block, where the second block contained a CBM calculation query (likely intended for a different report type, but incorrectly triggered by the same `type`). This suggests an incomplete or mismanaged addition of another air report functionality.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\services\analytics\tableService.ts`**
    *   **Timestamp: 1/21/2026, 1:35:42 PM**
        This file's `getTableDataReports` function acts as a central dispatcher for analytics reports. It calls various `*QueryBuilder` functions (chassis, booking, container, departure, general) based on the `type` parameter from the request. It fetches user and company information using `getUserObject`.
    *   **Timestamp: 1/21/2026, 1:38:12 PM**
        `airQueryBuilder` was imported, and a new `else if` block was added. Initially, this block incorrectly routed `TotalShipmentsMblWise` to `airQueryBuilder`, creating a conflict.
    *   **Timestamp: 1/21/2026, 2:07:22 PM**
        The `else if` condition was corrected to `type === "TotalShipmentAirWise"`, properly routing air shipment requests to the `airQueryBuilder`.
    *   **Timestamp: 1/21/2026, 3:09:20 PM**
        No further semantic changes were observed in this file.

*   **`c:\Users\ridap\OneDrive\Documents\T360-V2\t360-backend-v2\src\utils\analytics.ts`**
    *   **Timestamp: 1/21/2026, 3:21:18 PM**
        This utility file provides several helper functions for analytics. `defaultDateRange` gives a default date range. `replaceValueInQuery` handles specific column value replacements. `getUserObject` retrieves user context. `getFilterQueryByDisplayValue` generates dynamic SQL clauses for grouping and ordering by month, week, or quarter. `getExcelSelectedColumns` defines which columns to select for Excel exports, with special handling for certain report types (e.g., "Cargo-Ready Date to ETD", "BL Release KPI"). `dateFilterOnExport` normalizes and filters date fields, setting invalid dates to `null` and formatting valid ones to 'MM/DD/YYYY'. A comprehensive `EXCEL_EXPORT_COLUMNS` array lists all available fields for export.
    *   **Timestamp: 1/21/2026, 3:23:52 PM**
        No semantic code changes were observed.

**Patterns and Recurring Elements:**

1.  **Modular Query Builders:** The system uses distinct `*QueryBuilder` functions (e.g., `bookingQueryBuilder`, `chassisQueryBuilder`, `airQueryBuilder`) to encapsulate SQL generation logic for different analytics categories.
2.  **Dynamic Customization:** A `customizer` object is consistently passed and modified to configure report display, including `dateRange`, `calType`, `dateColumns`, `booking` (flag for booking reports), `mblwise` (flag for MBL-wise reports), and `chartType`.
3.  **`getColumnsByCategory` Usage:** The `getColumnsByCategory` utility is widely used to dynamically fetch a curated list of columns for each report, often employing extensive `ignore` lists to filter out irrelevant fields and `must` lists for essential ones.
4.  **Company and Date Range Filtering:** Nearly all SQL queries include common `WHERE` clauses to filter data by a list of company names (`LOWER(account_name) IN (${companyList})`) and a date range for `departure_date`.
5.  **SQL `DISTINCT ON` and Aggregation:** Many queries use `DISTINCT ON` clauses (often on combinations of `voyage`, `contno`, `t49_cont_type`) and aggregate functions (`SUM`, `AVG`, `COUNT`) to produce summarized metrics, frequently calculating day differences between dates.
6.  **Percentage Calculation:** A common final step in many queries involves calculating a percentage value for each entity relative to a `max_total` or `max_value`, ensuring proper handling of zero denominators.
7.  **Date Handling and Formatting:** The `analytics.ts` utility demonstrates a clear pattern for validating and formatting date fields, specifically addressing database-specific "empty" date values like '0001-01-01 00:00:00 BC' and formatting valid dates for consistent presentation.
8.  **Debugging Practices:** The presence and subsequent removal/modification of numerous `console.log` statements in `air.query.ts` indicate an active debugging process during the integration of new analytics features.